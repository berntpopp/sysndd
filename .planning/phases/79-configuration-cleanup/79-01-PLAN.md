---
phase: 79-configuration-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - .env.example
  - api/data/omim_links/omim_links.txt
  - db/data/ndd_databases_links/ndd_databases_links.txt
  - db/migrations/007_comparisons_config.sql
  - app/src/components/analyses/AnalysesCurationComparisonsTable.vue
autonomous: true

must_haves:
  truths:
    - "Docker Compose passes OMIM_DOWNLOAD_KEY to the API container"
    - ".env.example documents OMIM_DOWNLOAD_KEY with registration URL and usage guidance"
    - "No hardcoded OMIM API key (9GJLEFvqSmWaImCijeRdVA) exists anywhere in the codebase outside .planning/"
    - "omim_links.txt file no longer exists in the repository"
  artifacts:
    - path: "docker-compose.yml"
      provides: "OMIM_DOWNLOAD_KEY env var passed to API container"
      contains: "OMIM_DOWNLOAD_KEY"
    - path: ".env.example"
      provides: "OMIM_DOWNLOAD_KEY documentation and placeholder"
      contains: "OMIM_DOWNLOAD_KEY"
  key_links:
    - from: "docker-compose.yml"
      to: ".env"
      via: "environment variable interpolation"
      pattern: "OMIM_DOWNLOAD_KEY.*\\$\\{OMIM_DOWNLOAD_KEY\\}"
    - from: ".env.example"
      to: "api/functions/omim-functions.R"
      via: "OMIM_DOWNLOAD_KEY env var name consistency"
      pattern: "OMIM_DOWNLOAD_KEY"
---

<objective>
Add OMIM_DOWNLOAD_KEY to Docker Compose environment, document in .env.example, and remove all hardcoded OMIM API keys from the codebase.

Purpose: Complete CFG-01 and CFG-03 requirements -- externalize OMIM credentials to environment variables and eliminate all hardcoded secrets from version-controlled files.
Output: Updated docker-compose.yml, .env.example, and cleaned config/data files with no hardcoded OMIM keys.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/79-configuration-cleanup/79-CONTEXT.md
@.planning/phases/79-configuration-cleanup/79-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OMIM_DOWNLOAD_KEY to Docker Compose and .env.example</name>
  <files>docker-compose.yml, .env.example</files>
  <action>
1. In `docker-compose.yml`, add `OMIM_DOWNLOAD_KEY: ${OMIM_DOWNLOAD_KEY}` to the `api` service's `environment` section (after line 164, after CACHE_VERSION). No default value -- this is a required secret for OMIM features. Add a comment: `# OMIM download key for genemap2.txt (required for ontology/comparisons)`.

2. In `.env.example`, add a new section BEFORE the "Optional Settings" section (before line 67). Use the established section pattern:

```
# -----------------------------------------------------------------------------
# OMIM Configuration
# -----------------------------------------------------------------------------
# OMIM download key for authenticated access to genemap2.txt
# Required for: OMIM ontology updates, disease comparisons
# Get your key at: https://www.omim.org/downloads/
# After registration, use the key from your download URLs

OMIM_DOWNLOAD_KEY=your_omim_download_key_here
```

Match the existing formatting style (section header with dashes, purpose comment, registration URL, placeholder value).
  </action>
  <verify>
Verify docker-compose.yml has OMIM_DOWNLOAD_KEY in API environment section:
`grep "OMIM_DOWNLOAD_KEY" docker-compose.yml`

Verify .env.example has OMIM_DOWNLOAD_KEY with registration URL:
`grep -A5 "OMIM_DOWNLOAD_KEY" .env.example`

Verify the env var name is consistent (exact match "OMIM_DOWNLOAD_KEY") between docker-compose.yml, .env.example, and the existing R code:
`grep -r "OMIM_DOWNLOAD_KEY" docker-compose.yml .env.example api/functions/omim-functions.R | grep -v "^#"`
  </verify>
  <done>docker-compose.yml passes OMIM_DOWNLOAD_KEY to API container. .env.example documents OMIM_DOWNLOAD_KEY with OMIM registration URL and clear usage guidance. Env var name is consistent across all three locations.</done>
</task>

<task type="auto">
  <name>Task 2: Remove hardcoded OMIM API key from all non-planning files</name>
  <files>api/data/omim_links/omim_links.txt, db/data/ndd_databases_links/ndd_databases_links.txt, db/migrations/007_comparisons_config.sql, app/src/components/analyses/AnalysesCurationComparisonsTable.vue</files>
  <action>
1. **Delete the file** `api/data/omim_links/omim_links.txt` entirely. This file contains hardcoded OMIM download URLs with the API key `9GJLEFvqSmWaImCijeRdVA`. The download_genemap2() function already constructs URLs dynamically using get_omim_download_key(). The download_mim2gene() function uses the public URL directly. No code references this file at runtime -- it was only used by the legacy `db/` R scripts.

2. **Edit `db/data/ndd_databases_links/ndd_databases_links.txt`**: Remove the `omim_genemap2` row entirely (line 10). This row contains the hardcoded API key. The comparisons system now uses shared infrastructure that constructs URLs dynamically. Keep all other rows unchanged.

3. **Edit `db/migrations/007_comparisons_config.sql`**: On line 48, replace the hardcoded URL `https://data.omim.org/downloads/9GJLEFvqSmWaImCijeRdVA/genemap2.txt` with a placeholder comment. Change:
```sql
('omim_genemap2', 'https://data.omim.org/downloads/9GJLEFvqSmWaImCijeRdVA/genemap2.txt', 'txt');
```
to:
```sql
('omim_genemap2', 'DEPRECATED:uses-env-var-OMIM_DOWNLOAD_KEY', 'txt');
```
This preserves the migration's idempotent behavior (the INSERT only runs when the table doesn't exist), while ensuring the hardcoded key no longer appears. The row is functionally unused since Phase 78 migration 014 removes it.

4. **Edit `app/src/components/analyses/AnalysesCurationComparisonsTable.vue`**: On line 45, replace the hardcoded URL with a generic reference. Change:
```
(https://data.omim.org/downloads/9GJLEFvqSmWaImCijeRdVA/genemap2.txt),
```
to:
```
(genemap2.txt from OMIM, requires download key),
```
This removes the API key from the frontend source while preserving the descriptive context.

5. **Verify no hardcoded key remains** outside `.planning/` by running: `grep -r "9GJLEFvqSmWaImCijeRdVA" --include="*.R" --include="*.sql" --include="*.txt" --include="*.vue" --include="*.ts" --include="*.yml" --include="*.yaml" --include="*.json" --include="*.md" . | grep -v ".planning/"`
  </action>
  <verify>
Verify omim_links.txt is deleted:
`test ! -f api/data/omim_links/omim_links.txt && echo "DELETED"`

Verify no hardcoded key in source files (excluding .planning/):
`grep -r "9GJLEFvqSmWaImCijeRdVA" . --include="*.R" --include="*.sql" --include="*.txt" --include="*.vue" --include="*.ts" --include="*.yml" | grep -v ".planning/" | wc -l` should be 0

Verify migration still parses (no SQL syntax errors):
`cat db/migrations/007_comparisons_config.sql` and visually confirm valid SQL

Verify Vue component still has descriptive text:
`grep "genemap2" app/src/components/analyses/AnalysesCurationComparisonsTable.vue`
  </verify>
  <done>omim_links.txt deleted. Hardcoded OMIM API key (9GJLEFvqSmWaImCijeRdVA) removed from ndd_databases_links.txt, 007_comparisons_config.sql, and AnalysesCurationComparisonsTable.vue. Zero instances of the hardcoded key remain in source files outside .planning/.</done>
</task>

</tasks>

<verification>
1. `grep "OMIM_DOWNLOAD_KEY" docker-compose.yml .env.example api/functions/omim-functions.R` -- env var name consistent across all three files
2. `grep -r "9GJLEFvqSmWaImCijeRdVA" . --include="*.R" --include="*.sql" --include="*.txt" --include="*.vue" --include="*.ts" --include="*.yml" | grep -v ".planning/"` -- zero results
3. `test ! -f api/data/omim_links/omim_links.txt` -- file deleted
4. `make pre-commit` -- linting passes (no syntax errors introduced)
</verification>

<success_criteria>
- CFG-01 satisfied: docker-compose.yml and .env.example updated with OMIM_DOWNLOAD_KEY
- CFG-03 partially satisfied: hardcoded key removed from migration, data file, and Vue component; omim_links.txt deleted
- No hardcoded OMIM API key in any source file outside .planning/
- All linting passes
</success_criteria>

<output>
After completion, create `.planning/phases/79-configuration-cleanup/79-01-SUMMARY.md`
</output>
