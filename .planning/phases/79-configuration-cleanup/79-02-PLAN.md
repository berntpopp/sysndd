---
phase: 79-configuration-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - api/functions/omim-functions.R
  - api/tests/testthat/test-unit-omim-functions.R
autonomous: true

must_haves:
  truths:
    - "fetch_jax_disease_name() and fetch_all_disease_names() no longer exist in the codebase"
    - "build_omim_ontology_set() (legacy JAX-based builder) no longer exists in the codebase"
    - "download_mim2gene() uses check_file_age_days() with 1-day TTL (not check_file_age with months)"
    - "All remaining omim-functions tests pass"
    - "No dead code references to removed functions remain"
  artifacts:
    - path: "api/functions/omim-functions.R"
      provides: "OMIM functions without JAX API code, unified caching"
      exports: ["download_mim2gene", "get_omim_download_key", "download_genemap2", "download_hpoa", "parse_genemap2", "parse_mim2gene", "validate_omim_data", "get_deprecated_mim_numbers", "check_entities_for_deprecation", "build_omim_from_genemap2"]
    - path: "api/tests/testthat/test-unit-omim-functions.R"
      provides: "Tests for remaining functions plus mim2gene caching test"
  key_links:
    - from: "api/functions/omim-functions.R"
      to: "api/functions/file-functions.R"
      via: "check_file_age_days() call in download_mim2gene()"
      pattern: "check_file_age_days.*mim2gene"
    - from: "api/tests/testthat/test-unit-omim-functions.R"
      to: "api/functions/omim-functions.R"
      via: "source() and function calls"
      pattern: "source.*omim-functions"
---

<objective>
Remove deprecated JAX API functions and legacy build_omim_ontology_set(), unify mim2gene.txt caching with the Phase 76 check_file_age_days() infrastructure, and clean up corresponding tests.

Purpose: Complete CFG-02 requirement (remove JAX functions) and unify all OMIM file caching to 1-day TTL with check_file_age_days(). Eliminates dead code that is no longer called by any system.
Output: Cleaned omim-functions.R without JAX code, unified caching for mim2gene.txt, updated test file.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/79-configuration-cleanup/79-CONTEXT.md
@.planning/phases/79-configuration-cleanup/79-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove JAX API functions and legacy builder from omim-functions.R</name>
  <files>api/functions/omim-functions.R</files>
  <action>
Remove three functions entirely from `api/functions/omim-functions.R`:

1. **Remove `fetch_jax_disease_name()`** (currently lines 489-557). This function makes HTTP requests to `https://ontology.jax.org/api/network/annotation/OMIM:{mim}` and is replaced by genemap2 parsing from Phase 76-77. Remove the entire function including its roxygen2 documentation block.

2. **Remove `fetch_all_disease_names()`** (currently lines 560-617). This function iterates over MIM numbers calling fetch_jax_disease_name() with rate limiting. It is replaced by genemap2 parsing. Remove the entire function including its roxygen2 documentation block.

3. **Remove `build_omim_ontology_set()`** (currently lines 830-935). This function combines mim2gene data with JAX API disease names. It is replaced by `build_omim_from_genemap2()` which gets disease names from genemap2 parsing directly. Remove the entire function including its roxygen2 documentation block. Note the @param reference to `fetch_all_disease_names()` on line 836 confirms this is JAX-dependent dead code.

4. **Update the file header comment** (lines 1-7). Change from:
```r
# functions/omim-functions.R
# OMIM data processing functions using mim2gene.txt and JAX API
#
# Replaces the genemap2.txt-based approach with:
# - mim2gene.txt from OMIM for entry types and gene associations
# - JAX Ontology API for disease names
# - Support for deprecation workflow (moved/removed entries)
```
to:
```r
# functions/omim-functions.R
# OMIM data processing functions using genemap2.txt and mim2gene.txt
#
# Provides:
# - genemap2.txt download, caching (1-day TTL), and parsing for disease names + inheritance
# - mim2gene.txt download and caching for deprecation tracking (moved/removed entries)
# - Environment variable management (OMIM_DOWNLOAD_KEY)
# - Data validation and database insertion support
```

5. **Remove `require(purrr)`** from the imports section (line 11). The purrr package was used by `fetch_jax_disease_name()` via `pluck()`. After removing JAX functions, purrr is no longer needed by this file. Keep all other require() statements.

6. **Update the comment on line 15**. Change:
```r
# Source file-functions for check_file_age and get_newest_file
```
to:
```r
# Source file-functions for check_file_age_days and get_newest_file
```
since after the mim2gene refactor (Task 2 in plan 79-02), only check_file_age_days will be used.

After these changes, verify no references to removed functions remain:
`grep -n "fetch_jax\|fetch_all_disease\|build_omim_ontology_set" api/functions/omim-functions.R`
should return zero results.
  </action>
  <verify>
Verify removed functions are gone:
`grep -c "fetch_jax_disease_name\|fetch_all_disease_names\|build_omim_ontology_set" api/functions/omim-functions.R` should be 0

Verify kept functions still exist:
`grep -c "download_mim2gene\|download_genemap2\|download_hpoa\|parse_genemap2\|parse_mim2gene\|validate_omim_data\|get_deprecated_mim_numbers\|check_entities_for_deprecation\|build_omim_from_genemap2\|get_omim_download_key" api/functions/omim-functions.R` should be >= 10

Verify purrr is removed:
`grep "require(purrr)" api/functions/omim-functions.R` should return nothing

Verify file sources without error:
`cd api && Rscript -e "source('functions/file-functions.R'); source('functions/omim-functions.R'); cat('OK\n')"` (if R is available locally)
  </verify>
  <done>fetch_jax_disease_name(), fetch_all_disease_names(), and build_omim_ontology_set() removed from omim-functions.R. File header updated to reflect genemap2-based architecture. require(purrr) removed. All 10 kept functions remain intact. File sources without error.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor download_mim2gene to unified caching, update tests</name>
  <files>api/functions/omim-functions.R, api/tests/testthat/test-unit-omim-functions.R</files>
  <action>
**Part A: Refactor download_mim2gene() in omim-functions.R**

Modify `download_mim2gene()` to use `check_file_age_days()` instead of `check_file_age()`. This unifies all OMIM file caching to 1-day TTL precision, matching download_genemap2() and download_hpoa().

Change the function signature from:
```r
download_mim2gene <- function(output_path = "data/", force = FALSE, max_age_months = 1) {
```
to:
```r
download_mim2gene <- function(output_path = "data/", force = FALSE, max_age_days = 1) {
```

Change the cache check from:
```r
if (!force && check_file_age("mim2gene", output_path, max_age_months)) {
```
to:
```r
if (!force && check_file_age_days("mim2gene", output_path, max_age_days)) {
```

Add a cache hit message (matching download_genemap2 pattern):
```r
if (!is.null(existing_file)) {
  message(sprintf("[OMIM] Using cached mim2gene.txt: %s", existing_file))
  return(existing_file)
}
```

Add a download success message (matching download_genemap2 pattern):
```r
message(sprintf("[OMIM] Downloaded mim2gene.txt to %s", output_file))
```

Update the roxygen2 documentation:
- Change `@param max_age_months Integer, maximum age in months` to `@param max_age_days Integer, maximum age in days before re-downloading (default: 1)`
- Add caching behavior details matching download_genemap2's documentation style:
  ```
  #' Caching behavior:
  #' - Uses check_file_age_days() for 1-day TTL checking
  #' - Returns cached file if it exists and is less than max_age_days old
  #' - Downloads fresh file if cache is expired or force=TRUE
  ```
- Update the description to mention "1-day TTL" instead of month-based checking

**Part B: Update test-unit-omim-functions.R**

1. **Remove all `build_omim_ontology_set()` tests** (lines 270-451, 5 test_that blocks):
   - "build_omim_ontology_set creates correct columns" (line 273)
   - "build_omim_ontology_set handles versioning for duplicates" (line 324)
   - "build_omim_ontology_set excludes deprecated entries" (line 373)
   - "build_omim_ontology_set handles missing disease names" (line 410)
   Remove the section header comment `# build_omim_ontology_set() tests` as well.

2. **Update the file header comment** (lines 4-5). Change:
   ```r
   # Tests focus on data transformation logic that doesn't require network calls.
   # JAX API is NOT tested with live calls - only pure function logic.
   ```
   to:
   ```r
   # Tests focus on data transformation logic that doesn't require network calls.
   # Tests cover: mim2gene parsing, genemap2 parsing, validation, deprecation, caching.
   ```

3. **Add a new test section** for download_mim2gene() unified caching after the existing `check_file_age_days()` tests section (after the current line ~859). Add a section header and two tests:

```r
# =============================================================================
# download_mim2gene() caching logic tests
# =============================================================================

test_that("download_mim2gene returns cached file when fresh", {
  tryCatch({
    source(file.path(api_dir, "functions", "file-functions.R"))
    source(file.path(api_dir, "functions", "omim-functions.R"))

    withr::with_tempdir({
      temp_path <- tempdir()
      current_date <- format(Sys.Date(), "%Y-%m-%d")
      cached_file <- file.path(temp_path, paste0("mim2gene.", current_date, ".txt"))
      writeLines("cached mim2gene content", cached_file)

      result <- download_mim2gene(output_path = temp_path)
      expect_equal(result, cached_file)
      expect_true(file.exists(result))
    })
  }, error = function(e) {
    skip(paste("omim-functions.R requires additional dependencies:", e$message))
  })
})

test_that("download_mim2gene uses check_file_age_days (not check_file_age)", {
  tryCatch({
    source(file.path(api_dir, "functions", "omim-functions.R"))

    # Verify the function signature uses max_age_days parameter
    fn_args <- names(formals(download_mim2gene))
    expect_true("max_age_days" %in% fn_args)
    expect_false("max_age_months" %in% fn_args)
  }, error = function(e) {
    skip(paste("omim-functions.R requires additional dependencies:", e$message))
  })
})
```

These tests verify:
- Caching works via check_file_age_days (returns cached file without network call)
- Function signature uses max_age_days (not max_age_months)
  </action>
  <verify>
Verify build_omim_ontology_set tests are removed:
`grep -c "build_omim_ontology_set" api/tests/testthat/test-unit-omim-functions.R` should be 0

Verify download_mim2gene caching tests exist:
`grep -c "download_mim2gene" api/tests/testthat/test-unit-omim-functions.R` should be >= 2

Verify download_mim2gene uses check_file_age_days:
`grep "check_file_age_days" api/functions/omim-functions.R` should match download_mim2gene, download_genemap2, and download_hpoa (3 functions)

Verify no reference to check_file_age (month-based) in omim-functions.R:
`grep "check_file_age(" api/functions/omim-functions.R | grep -v "check_file_age_days"` should return nothing

Run the test file:
`cd api && Rscript -e "testthat::test_file('tests/testthat/test-unit-omim-functions.R')"` to verify all tests pass

Run lint check:
`make pre-commit` passes
  </verify>
  <done>download_mim2gene() refactored to use check_file_age_days() with 1-day TTL. build_omim_ontology_set() tests removed. New mim2gene caching tests added and passing. All remaining omim-functions tests pass. No references to check_file_age (month-based) remain in omim-functions.R. Lint passes.</done>
</task>

</tasks>

<verification>
1. `grep -r "fetch_jax_disease_name\|fetch_all_disease_names\|build_omim_ontology_set" api/` -- zero results in R source files
2. `grep "check_file_age(" api/functions/omim-functions.R | grep -v "check_file_age_days"` -- zero results (no month-based caching)
3. `grep "check_file_age_days" api/functions/omim-functions.R` -- matches for download_mim2gene, download_genemap2, download_hpoa (3 functions unified)
4. `cd api && Rscript -e "testthat::test_file('tests/testthat/test-unit-omim-functions.R')"` -- all tests pass
5. `make pre-commit` -- linting passes
</verification>

<success_criteria>
- CFG-02 satisfied: fetch_jax_disease_name, fetch_all_disease_names, and build_omim_ontology_set removed
- No dead JAX API code remains in the codebase
- All OMIM file caching unified to check_file_age_days() with 1-day TTL
- All tests pass, no lint issues
- download_mim2gene() matches the caching pattern of download_genemap2() and download_hpoa()
</success_criteria>

<output>
After completion, create `.planning/phases/79-configuration-cleanup/79-02-SUMMARY.md`
</output>
