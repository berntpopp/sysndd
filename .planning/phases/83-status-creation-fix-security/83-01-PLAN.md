---
phase: 83-status-creation-fix-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/views/curate/ModifyEntity.vue
  - app/package.json
  - app/package-lock.json
autonomous: true

must_haves:
  truths:
    - "Status change from 'not applicable' to 'Definitive' on any entity succeeds (HTTP 200)"
    - "POST body to /api/status/create contains entity_id field"
    - "Approve-both checkbox appears on ApproveReview page when entity has status_change === 1"
    - "axios updated to >=1.13.5 with no npm audit vulnerabilities for axios"
    - "npm run type-check and npm run lint pass without new errors"
  artifacts:
    - path: "app/src/views/curate/ModifyEntity.vue"
      provides: "Fixed status form reset ordering"
      contains: "resetStatusForm"
    - path: "app/package.json"
      provides: "Updated axios dependency"
      contains: "axios"
  key_links:
    - from: "app/src/views/curate/ModifyEntity.vue:showStatusModify()"
      to: "useStatusForm.ts:loadStatusByEntity()"
      via: "reset THEN load ordering"
      pattern: "resetStatusForm.*loadStatusByEntity"
    - from: "app/src/views/curate/ModifyEntity.vue:onModifyStatusModalShow()"
      to: "modal @show event"
      via: "no-op or removed reset (data already loaded)"
      pattern: "onModifyStatusModalShow"
---

<objective>
Fix the HTTP 500 error on status change that blocks curation workflow, verify the "approve both" feature restores, and patch the axios DoS vulnerability.

Purpose: Unblock Christiane's daily curation work by fixing the status creation regression and close the security vulnerability.
Output: Working status change flow + patched axios dependency.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/src/views/curate/ModifyEntity.vue
@app/src/views/curate/composables/useStatusForm.ts
@app/src/views/curate/ApproveReview.vue
@app/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix status form reset ordering in ModifyEntity.vue</name>
  <files>app/src/views/curate/ModifyEntity.vue</files>
  <action>
    The bug: `showStatusModify()` (line ~1215) loads entity data via `loadStatusByEntity()` which sets `formData.entity_id`. Then it calls `this.$refs.modifyStatusModal.show()` which fires the `@show` event. The `@show` handler `onModifyStatusModalShow()` (line ~1450) calls `resetStatusForm()` which deletes `formData.entity_id` and `formData.status_id`. The user then submits with no entity_id, causing HTTP 500.

    Fix — two changes in `ModifyEntity.vue`:

    1. In `showStatusModify()` (around line 1215): Add `this.resetStatusForm()` as the FIRST line of the method, BEFORE `await this.getEntity()`. This ensures the form starts clean before loading fresh data.

    2. In `onModifyStatusModalShow()` (around line 1450): Remove the call to `this.resetStatusForm()`. The reset now happens at the start of `showStatusModify()` before data is loaded, so the `@show` handler no longer needs to (and must not) reset. Keep the method but make it empty or add a comment explaining the reset moved to `showStatusModify()`.

    Why NOT just reorder within showStatusModify: The `@show` event fires asynchronously when the modal renders. Even if we reset before load in showStatusModify, the @show handler would STILL fire and destroy the data. The @show handler must not reset.

    Why NOT remove onModifyStatusModalShow entirely: The `@show="onModifyStatusModalShow"` binding exists in the template. Keep the method as a no-op to avoid a template reference error. Add a comment: `// Reset moved to showStatusModify() — intentionally empty to preserve loaded data`.
  </action>
  <verify>
    1. `cd /home/bernt-popp/development/sysndd/app && npm run type-check` passes
    2. `cd /home/bernt-popp/development/sysndd/app && npm run lint` passes
    3. Grep confirms reset comes before load: `grep -n "resetStatusForm\|loadStatusByEntity\|getEntity" app/src/views/curate/ModifyEntity.vue` shows resetStatusForm line number < loadStatusByEntity line number within showStatusModify
    4. Grep confirms onModifyStatusModalShow no longer calls resetStatusForm: `grep -A5 "onModifyStatusModalShow" app/src/views/curate/ModifyEntity.vue` shows no resetStatusForm call
  </verify>
  <done>
    - `showStatusModify()` calls `resetStatusForm()` before `getEntity()` and `loadStatusByEntity()`
    - `onModifyStatusModalShow()` does NOT call `resetStatusForm()`
    - `entity_id` will be preserved in formData when user submits the status change form
    - type-check and lint pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Update axios to fix CVE-2026-25639</name>
  <files>app/package.json, app/package-lock.json</files>
  <action>
    Update axios from 1.13.4 to >=1.13.5 to fix CVE-2026-25639 (DoS via prototype pollution in mergeConfig).

    Run: `cd /home/bernt-popp/development/sysndd/app && npm update axios`

    This is a patch bump (1.13.4 -> 1.13.5). The package.json specifies `"axios": "^1.13.4"` which allows 1.13.5. The lock file will update.

    After update, verify no breaking changes by running type-check and lint.
  </action>
  <verify>
    1. `cd /home/bernt-popp/development/sysndd/app && node -e "const p = require('./node_modules/axios/package.json'); console.log(p.version)"` shows >= 1.13.5
    2. `cd /home/bernt-popp/development/sysndd/app && npm audit --json 2>/dev/null | grep -i axios` shows no axios vulnerabilities (or npm audit returns clean)
    3. `cd /home/bernt-popp/development/sysndd/app && npm run type-check` passes
    4. `cd /home/bernt-popp/development/sysndd/app && npm run lint` passes
  </verify>
  <done>
    - axios version >= 1.13.5 in package-lock.json
    - npm audit shows no axios-related vulnerabilities
    - type-check and lint pass with no new errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify "approve both" checkbox restores after status fix</name>
  <files></files>
  <action>
    This task verifies R2 — no code changes expected.

    The "Also approve new status" checkbox in ApproveReview.vue (line ~521) renders when `entity.status_change === 1`. The `status_change` flag is set to 1 when a status record is created for an entity pending review. Since Bug 1 (Task 1) prevented status creation, `status_change` was always 0.

    Verification approach (code-level, since no running instance):

    1. Read `ApproveReview.vue` and confirm the `v-if="entity.status_change"` conditional still exists at line ~521
    2. Read `ApproveReview.vue` around line ~1727 and confirm the status approval logic (`if (this.status_approved === true && this.entity.status_change === 1)`) still exists
    3. Confirm that the status creation endpoint path in `useStatusForm.ts` `submitForm()` will include `entity_id` in the request body (trace from formData through to the axios POST)
    4. Document the verification chain: fix Task 1 -> entity_id in POST -> status created -> status_change=1 in DB -> checkbox visible

    If ANY of these checks fail, identify what additional fix is needed and document it.
  </action>
  <verify>
    1. `grep -n "status_change" app/src/views/curate/ApproveReview.vue` shows the conditional rendering and approval logic intact
    2. `grep -n "entity_id\|status_json\|submitForm" app/src/views/curate/composables/useStatusForm.ts` confirms entity_id is included in submission
    3. No additional code changes needed for R2 beyond the R1 fix
  </verify>
  <done>
    - Confirmed: ApproveReview.vue shows "approve both" checkbox when status_change === 1
    - Confirmed: status creation POST body will include entity_id after Task 1 fix
    - Confirmed: R2 is a symptom of R1 and requires no additional code changes
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd /home/bernt-popp/development/sysndd/app && npm run type-check` — zero errors
2. `cd /home/bernt-popp/development/sysndd/app && npm run lint` — zero new errors
3. `cd /home/bernt-popp/development/sysndd/app && npm audit` — no axios vulnerabilities
4. Code review: `showStatusModify()` resets form THEN loads data; `onModifyStatusModalShow()` does not reset
5. Trace: formData.entity_id survives from loadStatusByEntity through modal show to submitStatusChange
</verification>

<success_criteria>
- HTTP 500 on status change is fixed (entity_id preserved in form data through modal lifecycle)
- "Approve both" feature confirmed to work once status creation succeeds (no code change needed)
- axios >= 1.13.5 installed, CVE-2026-25639 patched
- All linting and type checks pass
- No regressions in existing curation workflows
</success_criteria>

<output>
After completion, create `.planning/phases/83-status-creation-fix-security/83-01-SUMMARY.md`
</output>
