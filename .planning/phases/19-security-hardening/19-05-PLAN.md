---
phase: 19-security-hardening
plan: 05
type: execute
wave: 4
depends_on: ["19-04"]
files_modified:
  - api/renv.lock
  - api/tests/testthat/test-unit-security.R
autonomous: false

must_haves:
  truths:
    - "sodium and httpproblems packages are in renv.lock"
    - "API starts successfully with all security changes"
    - "Authentication works for both plaintext and hashed passwords"
    - "Error responses are RFC 9457 format"
    - "Logs do not contain passwords"
  artifacts:
    - path: "api/tests/testthat/test-unit-security.R"
      provides: "Unit tests for password hashing functions"
      min_lines: 50
  key_links:
    - from: "api/tests/testthat/test-unit-security.R"
      to: "api/core/security.R"
      via: "test coverage"
      pattern: "test_that.*hash_password|test_that.*verify_password"
---

<objective>
Add new package dependencies to renv, create security function tests, and verify the complete security hardening integration.

Purpose: Ensure all security changes work correctly together - package dependencies are captured, tests verify password hashing behavior, and the API starts successfully.

Output: Updated renv.lock, unit tests for security functions, verified API startup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-security-hardening/19-RESEARCH.md
@.planning/phases/19-security-hardening/19-01-SUMMARY.md
@.planning/phases/19-security-hardening/19-02-SUMMARY.md
@.planning/phases/19-security-hardening/19-03-SUMMARY.md
@.planning/phases/19-security-hardening/19-04-SUMMARY.md

# Test infrastructure
@api/tests/testthat/setup.R
@api/tests/testthat/helper-db.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sodium and httpproblems to renv and capture snapshot</name>
  <files>api/renv.lock</files>
  <action>
In the api/ directory, install the new packages and snapshot:

```r
# In R console from api/ directory
renv::install("sodium")
renv::install("httpproblems")
renv::snapshot()
```

Or via command line:
```bash
cd api
Rscript -e 'renv::install("sodium"); renv::install("httpproblems"); renv::snapshot()'
```

Verify renv.lock is updated with both packages.

Note: sodium requires libsodium system library. The Docker image should already have it from rocker/r-ver, but verify in Phase 18 Dockerfile if issues arise.
  </action>
  <verify>
grep 'sodium' api/renv.lock returns package entry
grep 'httpproblems' api/renv.lock returns package entry
renv::status() shows no issues
  </verify>
  <done>
renv.lock contains sodium and httpproblems package dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for core/security.R functions</name>
  <files>api/tests/testthat/test-unit-security.R</files>
  <action>
Create api/tests/testthat/test-unit-security.R with unit tests for password functions:

```r
# api/tests/testthat/test-unit-security.R
# Unit tests for core/security.R password utilities

source("../../core/security.R", local = TRUE)

describe("is_hashed", {
  it("returns TRUE for Argon2id hashes", {
    # Real Argon2id hash format
    hash <- "$argon2id$v=19$m=65536,t=3,p=2$somesalt$somehash"
    expect_true(is_hashed(hash))
  })

  it("returns TRUE for Argon2i hashes", {
    hash <- "$argon2i$v=19$m=65536,t=3,p=2$somesalt$somehash"
    expect_true(is_hashed(hash))
  })

  it("returns FALSE for plaintext passwords", {
    expect_false(is_hashed("myplaintextpassword"))
    expect_false(is_hashed("P@ssw0rd123"))
    expect_false(is_hashed(""))
  })

  it("returns FALSE for other hash formats", {
    # bcrypt format
    expect_false(is_hashed("$2a$10$somebcrypthash"))
    # MD5 format
    expect_false(is_hashed("5d41402abc4b2a76b9719d911017c592"))
  })
})

describe("hash_password", {
  it("returns Argon2id hash string", {
    hash <- hash_password("testpassword")
    expect_true(is.character(hash))
    expect_true(startsWith(hash, "$argon2"))
  })

  it("produces different hashes for same password (random salt)", {
    hash1 <- hash_password("samepassword")
    hash2 <- hash_password("samepassword")
    expect_false(hash1 == hash2)
  })
})

describe("verify_password", {
  it("verifies hashed password correctly", {
    password <- "MySecureP@ss123"
    hash <- hash_password(password)

    expect_true(verify_password(hash, password))
    expect_false(verify_password(hash, "wrongpassword"))
  })

  it("verifies plaintext password correctly (legacy support)", {
    plaintext_stored <- "plaintextpassword"

    expect_true(verify_password(plaintext_stored, "plaintextpassword"))
    expect_false(verify_password(plaintext_stored, "wrongpassword"))
  })

  it("returns FALSE for malformed hash", {
    malformed <- "$argon2id$invalid$hash"
    expect_false(verify_password(malformed, "anypassword"))
  })
})

describe("needs_upgrade", {
  it("returns TRUE for plaintext passwords", {
    expect_true(needs_upgrade("plaintextpassword"))
    expect_true(needs_upgrade("anotherplaintext"))
  })

  it("returns FALSE for Argon2id hashes", {
    hash <- hash_password("password")
    expect_false(needs_upgrade(hash))
  })
})

# Note: upgrade_password requires database connection - integration test only
```
  </action>
  <verify>
File exists at api/tests/testthat/test-unit-security.R
Contains test blocks for is_hashed, hash_password, verify_password, needs_upgrade
Tests can be run: Rscript -e "testthat::test_file('api/tests/testthat/test-unit-security.R')"
  </verify>
  <done>
Unit tests for password hashing functions exist and pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 19 security hardening: SQL injection fixes, password hashing with Argon2id, RFC 9457 error handling, and log sanitization.</what-built>
  <how-to-verify>
1. Start the API locally:
   ```bash
   cd api && Rscript start_sysndd_api.R
   ```

2. Test authentication with existing user (should work - plaintext comparison still supported):
   ```bash
   curl -X GET "http://localhost:8080/api/auth/authenticate?user_name=testuser&password=testpass"
   ```

3. Test error format (should return RFC 9457 JSON):
   ```bash
   curl -X GET "http://localhost:8080/api/auth/authenticate?user_name=x&password=y"
   ```
   Expected response format:
   ```json
   {
     "type": "...",
     "title": "Unauthorized",
     "status": 401,
     "detail": "User or password wrong."
   }
   ```

4. Check logs for password sanitization:
   ```bash
   # After making a login request, check logs
   cat api/logs/*.log | grep -i password
   # Should show [REDACTED] not actual passwords
   ```

5. Run unit tests:
   ```bash
   cd api && Rscript -e "testthat::test_file('tests/testthat/test-unit-security.R')"
   ```

6. Verify new password is hashed (create test user or check DB after login with plaintext user):
   - After successful login, the password column should be updated to $argon2id$... format
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe issues found.</resume-signal>
</task>

</tasks>

<verification>
After all tasks:
1. renv.lock contains sodium and httpproblems
2. Unit tests pass: `Rscript -e "testthat::test_file('api/tests/testthat/test-unit-security.R')"`
3. API starts without errors
4. Authentication works for existing users
5. Error responses are RFC 9457 format
6. Logs show [REDACTED] for sensitive data
</verification>

<success_criteria>
- sodium and httpproblems in renv.lock
- Unit tests for password functions pass
- API starts successfully with all security changes
- Authentication works (plaintext passwords supported, get upgraded)
- Errors return RFC 9457 JSON format
- Logs do not contain passwords, tokens, or authorization headers
- Human verification of complete integration
</success_criteria>

<output>
After completion, create `.planning/phases/19-security-hardening/19-05-SUMMARY.md`
</output>
