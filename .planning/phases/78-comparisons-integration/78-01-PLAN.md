---
phase: 78-comparisons-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/functions/comparisons-functions.R
  - db/migrations/014_remove_genemap2_config.sql
autonomous: true

must_haves:
  truths:
    - "Comparisons OMIM parsing delegates raw genemap2 extraction to shared parse_genemap2()"
    - "Comparisons OMIM download uses shared download_genemap2() with 1-day TTL cache"
    - "Only one genemap2.txt download occurs per day regardless of which system triggers it"
    - "omim_genemap2 entry no longer exists in comparisons_config table"
    - "update_source_last_updated() is skipped for omim_genemap2 since config row is removed"
    - "Comparisons OMIM version field is date-based (YYYY-MM-DD) not filename-based"
  artifacts:
    - path: "api/functions/comparisons-functions.R"
      provides: "Reduced parse_omim_genemap2() calling shared infrastructure, modified comparisons_update_async()"
      contains: "parse_genemap2(genemap2_path)"
    - path: "db/migrations/014_remove_genemap2_config.sql"
      provides: "Migration to remove omim_genemap2 from comparisons_config"
      contains: "DELETE FROM comparisons_config WHERE source_name"
  key_links:
    - from: "api/functions/comparisons-functions.R"
      to: "api/functions/omim-functions.R"
      via: "parse_genemap2() and download_genemap2() function calls"
      pattern: "parse_genemap2\\(|download_genemap2\\("
    - from: "api/functions/comparisons-functions.R"
      to: "api/functions/comparisons-sources.R"
      via: "update_source_last_updated() skip for omim_genemap2"
      pattern: "omim_genemap2.*next|skip.*omim_genemap2"
---

<objective>
Unify comparisons OMIM processing to use Phase 76's shared genemap2 infrastructure, eliminating duplicate download/parsing code and enabling single-download-per-day cache sharing between ontology and comparisons systems.

Purpose: Fulfill COMP-01 (shared cache) and COMP-02 (shared parsing) requirements, eliminating ~100 lines of duplicate genemap2 parsing and inheritance normalization code from comparisons-functions.R.

Output: Modified comparisons-functions.R with reduced parse_omim_genemap2() and updated comparisons_update_async(), plus database migration to remove genemap2 config entry.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/78-comparisons-integration/78-CONTEXT.md
@.planning/phases/78-comparisons-integration/78-RESEARCH.md

Key source files:
@api/functions/comparisons-functions.R
@api/functions/comparisons-sources.R
@api/functions/omim-functions.R
@db/migrations/007_comparisons_config.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reduce parse_omim_genemap2() and modify comparisons_update_async()</name>
  <files>api/functions/comparisons-functions.R</files>
  <action>
  Make three targeted changes to api/functions/comparisons-functions.R:

  **Change 1: Reduce parse_omim_genemap2() (lines 390-495)**

  Replace the entire function body with a thin wrapper that:
  1. Calls `parse_genemap2(genemap2_path)` from omim-functions.R for raw data extraction (this handles position-based column mapping X1-X14, phenotypes parsing, and 14-term inheritance normalization to HPO vocabulary)
  2. Keeps the NDD filtering logic (phenotype.hpoa-based HPO term filtering) since this is comparisons-specific
  3. Formats output to match the exact comparisons schema: gene_symbol, disease_ontology_id, disease_ontology_name, inheritance, list, version, category

  Specifically, the reduced function should:
  - Call `parse_genemap2(genemap2_path)` for Step 1
  - Keep the ndd_phenotypes vector: c("HP:0012759", "HP:0001249", "HP:0001256", "HP:0002187", "HP:0002342", "HP:0006889", "HP:0010864")
  - Keep the phenotype.hpoa reading (readr::read_tsv with skip = 4)
  - Keep the NDD OMIM filtering (str_detect database_id "OMIM", filter hpo_id in ndd_phenotypes)
  - Keep the left_join with genemap_data by database_id = disease_ontology_id
  - Change version from `basename(genemap2_path) %>% str_remove("\\.txt$")` to `format(Sys.Date(), "%Y-%m-%d")`
  - Rename columns: Approved_Symbol -> gene_symbol, database_id -> disease_ontology_id, hpo_mode_of_inheritance_term_name -> inheritance
  - Set list = "omim_ndd", category = "Definitive"

  Remove all inline genemap2 parsing code (the read_tsv with col_names=FALSE, the dplyr::select X1-X14 column mapping, the separate/separate_rows phenotype parsing, and the 14-term case_when inheritance normalization). These are now handled by shared parse_genemap2().

  **Change 2: Modify the parsing switch block in comparisons_update_async() (around lines 859-877)**

  The "omim_genemap2" case in the switch currently:
  - Uses `file_path` from downloaded_files (config-based download)
  - Calls parse_omim_genemap2(file_path, hpoa_path)

  Change it to:
  - Call `download_genemap2(output_path = "data/", force = FALSE)` to get the shared cached genemap2 path
  - Keep the phenotype_hpoa check from downloaded_files
  - Call parse_omim_genemap2(genemap2_path, hpoa_path) with the cached path

  IMPORTANT: Since omim_genemap2 is being removed from comparisons_config, it will no longer appear in the `sources` tibble from get_active_sources(). Therefore the switch block won't encounter "omim_genemap2" during the main loop. Instead, add OMIM processing AFTER the main source loop completes, as a separate step:

  After the existing `for (i in seq_len(nrow(sources)))` parse loop (around line 890), add a dedicated OMIM block:
  ```r
  # Parse OMIM via shared infrastructure (not in comparisons_config anymore)
  message(sprintf("[%s] [job:%s] Parsing omim_genemap2 via shared infrastructure...", Sys.time(), job_id))
  omim_parsed <- tryCatch({
    genemap2_path <- download_genemap2(output_path = "data/", force = FALSE)
    hpoa_path <- downloaded_files[["phenotype_hpoa"]]
    if (is.null(hpoa_path)) {
      stop("phenotype_hpoa file required for omim_genemap2 parsing")
    }
    parsed <- parse_omim_genemap2(genemap2_path, hpoa_path)
    standardize_comparison_data(parsed, "omim_genemap2", import_date)
  }, error = function(e) {
    update_comparisons_metadata(conn, "failed", nrow(sources), 0,
                                sprintf("Failed to parse omim_genemap2: %s", e$message))
    stop(sprintf("Failed to parse omim_genemap2: %s", e$message))
  })
  all_parsed_data[["omim_genemap2"]] <- omim_parsed
  message(sprintf("[%s] [job:%s] Parsed %d rows from omim_genemap2", Sys.time(), job_id, nrow(omim_parsed)))
  ```

  Also remove the "omim_genemap2" case from the switch statement entirely (it will never match now since omim_genemap2 is removed from config).

  **Change 3: Skip update_source_last_updated() for omim_genemap2 (around lines 963-966)**

  In the source timestamp update loop, add a skip for omim_genemap2:
  ```r
  for (source_name in names(all_parsed_data)) {
    if (source_name == "omim_genemap2") {
      next
    }
    update_source_last_updated(conn, source_name)
  }
  ```

  WHY these specific changes:
  - parse_genemap2() already does all raw parsing + inheritance normalization (single source of truth from Phase 76)
  - download_genemap2() provides 1-day TTL caching in data/ directory (shared with ontology system)
  - omim_genemap2 is removed from comparisons_config so it won't appear in get_active_sources() results
  - update_source_last_updated() would fail on a missing config row
  </action>
  <verify>
  1. `grep -c "parse_genemap2(genemap2_path)" api/functions/comparisons-functions.R` returns at least 1 (shared parser is called)
  2. `grep -c "download_genemap2" api/functions/comparisons-functions.R` returns at least 1 (shared download is called)
  3. The old inline genemap2 parsing code is gone: `grep -c "Chromosome = X1" api/functions/comparisons-functions.R` returns 0
  4. The old inline inheritance case_when is gone from parse_omim_genemap2: verify the function body no longer contains "Autosomal dominant.*Autosomal dominant inheritance" pattern inside that function
  5. Version field uses date format: `grep "format(Sys.Date()" api/functions/comparisons-functions.R` matches in parse_omim_genemap2
  6. Skip logic exists: `grep "omim_genemap2.*next" api/functions/comparisons-functions.R` returns a match
  7. R syntax check: `cd api && Rscript -e "parse(file='functions/comparisons-functions.R')"` succeeds without errors
  </verify>
  <done>
  parse_omim_genemap2() is a thin wrapper calling shared parse_genemap2() for raw extraction, keeping only NDD filtering and schema formatting. comparisons_update_async() calls download_genemap2() for shared cache and processes OMIM separately from config-based sources. update_source_last_updated() skips omim_genemap2. No duplicate parsing or inheritance normalization code remains.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create database migration to remove genemap2 from comparisons_config</name>
  <files>db/migrations/014_remove_genemap2_config.sql</files>
  <action>
  Create db/migrations/014_remove_genemap2_config.sql following the existing migration pattern (see 007_comparisons_config.sql for style reference).

  The migration should:
  1. Use DELIMITER // and a stored procedure pattern for idempotency (consistent with other migrations)
  2. Check if the omim_genemap2 row exists before deleting (idempotent)
  3. Delete ONLY the omim_genemap2 entry from comparisons_config
  4. Do NOT touch phenotype_hpoa (it stays -- comparisons-only, downloads from HPO)
  5. Include clear comments explaining why: "genemap2 download moves to shared infrastructure (Phase 76 download_genemap2())"

  Migration SQL structure:
  ```sql
  DELIMITER //
  CREATE PROCEDURE IF NOT EXISTS migrate_014_remove_genemap2_config()
  BEGIN
      -- Remove omim_genemap2 from comparisons_config
      -- Phase 78: genemap2 download/parse moves to shared infrastructure
      -- (Phase 76 download_genemap2() with 1-day TTL caching)
      -- phenotype_hpoa stays (comparisons-only, not shared)
      DELETE FROM comparisons_config WHERE source_name = 'omim_genemap2';
  END //
  CALL migrate_014_remove_genemap2_config() //
  DROP PROCEDURE IF EXISTS migrate_014_remove_genemap2_config //
  ```

  Also update db/migrations/README.md if it has a migration list (add entry for 014).
  </action>
  <verify>
  1. File exists: `ls db/migrations/014_remove_genemap2_config.sql`
  2. Contains correct DELETE: `grep "DELETE FROM comparisons_config WHERE source_name = 'omim_genemap2'" db/migrations/014_remove_genemap2_config.sql`
  3. Does NOT touch phenotype_hpoa: `grep -c "phenotype_hpoa" db/migrations/014_remove_genemap2_config.sql` returns 0 (comments only, no DELETE of phenotype_hpoa)
  4. Uses stored procedure pattern: `grep "CREATE PROCEDURE" db/migrations/014_remove_genemap2_config.sql`
  </verify>
  <done>
  Migration file 014_remove_genemap2_config.sql exists, removes only the omim_genemap2 row from comparisons_config, is idempotent, and follows existing migration conventions. phenotype_hpoa is preserved.
  </done>
</task>

</tasks>

<verification>
1. R syntax check passes: `cd api && Rscript -e "parse(file='functions/comparisons-functions.R')"`
2. No duplicate genemap2 parsing code: `grep -c "Chromosome = X1" api/functions/comparisons-functions.R` is 0
3. Shared infrastructure called: `grep "parse_genemap2\|download_genemap2" api/functions/comparisons-functions.R` shows both calls
4. Schema columns preserved: parse_omim_genemap2() still returns gene_symbol, disease_ontology_id, disease_ontology_name, inheritance, list, version, category
5. Migration file exists and is syntactically correct
6. Lint check: `cd api && Rscript -e "lintr::lint('functions/comparisons-functions.R')"` produces 0 errors
</verification>

<success_criteria>
- parse_omim_genemap2() body is ~30-40 lines (down from ~105 lines), calling shared parse_genemap2()
- comparisons_update_async() calls download_genemap2() for cached genemap2 path
- omim_genemap2 removed from switch block (processed separately after main loop)
- update_source_last_updated() skips omim_genemap2
- Version field is date-based: format(Sys.Date(), "%Y-%m-%d")
- Migration 014 removes omim_genemap2 from comparisons_config
- R syntax check passes, lintr passes
</success_criteria>

<output>
After completion, create `.planning/phases/78-comparisons-integration/78-01-SUMMARY.md`
</output>
