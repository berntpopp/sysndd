---
phase: 78-comparisons-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/functions/omim-functions.R
  - api/functions/comparisons-functions.R
  - db/migrations/014_remove_genemap2_config.sql
autonomous: true

must_haves:
  truths:
    - "Comparisons OMIM parsing delegates raw genemap2 extraction to shared parse_genemap2()"
    - "Comparisons OMIM download uses shared download_genemap2() with 1-day TTL cache"
    - "Only one genemap2.txt download occurs per day regardless of which system triggers it"
    - "omim_genemap2 entry no longer exists in comparisons_config table"
    - "update_source_last_updated() is skipped for omim_genemap2 since config row is removed"
    - "Comparisons OMIM version field is date-based (YYYY-MM-DD) not filename-based"
    - "phenotype.hpoa is cached with 1-day TTL in data/ directory"
    - "adapt_genemap2_for_comparisons() receives pre-parsed tibble, not a file path"
  artifacts:
    - path: "api/functions/omim-functions.R"
      provides: "download_hpoa() function with 1-day TTL caching in data/"
      contains: "download_hpoa"
    - path: "api/functions/comparisons-functions.R"
      provides: "New adapt_genemap2_for_comparisons() replacing old parse_omim_genemap2(), modified comparisons_update_async()"
      contains: "adapt_genemap2_for_comparisons"
    - path: "db/migrations/014_remove_genemap2_config.sql"
      provides: "Migration to remove omim_genemap2 from comparisons_config"
      contains: "DELETE FROM comparisons_config WHERE source_name"
  key_links:
    - from: "api/functions/comparisons-functions.R"
      to: "api/functions/omim-functions.R"
      via: "parse_genemap2(), download_genemap2(), and download_hpoa() function calls"
      pattern: "parse_genemap2\\(|download_genemap2\\(|download_hpoa\\("
    - from: "api/functions/comparisons-functions.R"
      to: "api/functions/comparisons-sources.R"
      via: "update_source_last_updated() skip for omim_genemap2"
      pattern: "omim_genemap2.*next|skip.*omim_genemap2"
---

<objective>
Unify comparisons OMIM processing to use Phase 76's shared genemap2 infrastructure, add persistent phenotype.hpoa caching, and eliminate duplicate download/parsing code. This enables single-download-per-day cache sharing between ontology and comparisons systems.

Purpose: Fulfill COMP-01 (shared cache) and COMP-02 (shared parsing) requirements, eliminating ~100 lines of duplicate genemap2 parsing and inheritance normalization code from comparisons-functions.R. Also adds persistent phenotype.hpoa caching to avoid redundant 5-15 MB downloads on retry/re-run.

Output: New download_hpoa() in omim-functions.R, modified comparisons-functions.R with new adapt_genemap2_for_comparisons() adapter function (replacing old parse_omim_genemap2()) and updated comparisons_update_async(), plus database migration to remove genemap2 config entry.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/78-comparisons-integration/78-CONTEXT.md
@.planning/phases/78-comparisons-integration/78-RESEARCH.md

Key source files:
@api/functions/comparisons-functions.R
@api/functions/comparisons-sources.R
@api/functions/omim-functions.R
@api/functions/file-functions.R
@db/migrations/007_comparisons_config.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add download_hpoa() with persistent caching to omim-functions.R</name>
  <files>api/functions/omim-functions.R</files>
  <action>
  Add a new `download_hpoa()` function to api/functions/omim-functions.R, following the exact same pattern as `download_genemap2()` (lines 144-186).

  The function should:
  1. Accept parameters: `url` (character, the phenotype.hpoa download URL), `output_path` (character, default "data/"), `force` (logical, default FALSE), `max_age_days` (integer, default 1)
  2. Use `check_file_age_days("phenotype_hpoa", output_path, max_age_days)` to check for existing cached file (same pattern as download_genemap2)
  3. Use `get_newest_file("phenotype_hpoa", output_path)` to find cached file
  4. If cached file exists and is fresh, return its path with a message
  5. If not cached or expired, download from the provided `url` parameter
  6. Save as `phenotype_hpoa.YYYY-MM-DD.txt` in output_path (date-stamped like genemap2)
  7. Ensure output directory exists with `dir_create(output_path)`
  8. Use httr2 request() with same retry logic as download_genemap2(): max_tries=3, max_seconds=60, backoff=~2^.x, timeout=30
  9. Return the path to the downloaded/cached file

  The `url` parameter is required (not optional) because the phenotype.hpoa URL comes from comparisons_config table -- the function does NOT read from config directly. This is a pure download+cache utility.

  Place the function after download_genemap2() (after line 186) and before parse_genemap2().

  Add proper roxygen documentation following the existing style in the file.

  WHY: CONTEXT.md requires phenotype.hpoa persistent caching in data/ directory with 1-day TTL, same pattern as genemap2. The URL parameter approach keeps the function as a pure utility (Claude's discretion per CONTEXT.md line 46).
  </action>
  <verify>
  1. `grep -c "download_hpoa" api/functions/omim-functions.R` returns at least 1
  2. `grep "check_file_age_days.*phenotype_hpoa" api/functions/omim-functions.R` matches (uses caching)
  3. `grep "phenotype_hpoa.*YYYY\\|phenotype_hpoa.*Sys.Date" api/functions/omim-functions.R` matches (date-stamped filename)
  4. R syntax check: `cd api && Rscript -e "parse(file='functions/omim-functions.R')"` succeeds
  </verify>
  <done>
  download_hpoa() exists in omim-functions.R with: URL parameter input, 1-day TTL caching via check_file_age_days(), date-stamped filenames in data/ directory, httr2 retry logic matching download_genemap2() pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace parse_omim_genemap2() with adapt_genemap2_for_comparisons() and modify comparisons_update_async()</name>
  <files>api/functions/comparisons-functions.R</files>
  <action>
  Make three targeted changes to api/functions/comparisons-functions.R:

  **Change 1: Delete parse_omim_genemap2() and create adapt_genemap2_for_comparisons() (lines 390-495)**

  Delete the entire `parse_omim_genemap2()` function. Create a new `adapt_genemap2_for_comparisons()` function in its place. The new function is an ADAPTER -- it does NOT parse genemap2 itself (that is done by the shared `parse_genemap2()` upstream). Instead it receives already-parsed genemap2 data.

  Function signature:
  ```r
  adapt_genemap2_for_comparisons <- function(genemap2_data, phenotype_hpoa_path)
  ```

  Parameters:
  - `genemap2_data`: A tibble -- the output of `parse_genemap2()`. Contains columns: Approved_Symbol, disease_ontology_name, disease_ontology_id, Mapping_key, hpo_mode_of_inheritance_term_name
  - `phenotype_hpoa_path`: Path to the phenotype.hpoa file (already downloaded/cached)

  The adapter function should:
  1. Define NDD_HPO_TERMS as a named constant vector with a comment:
     ```r
     # NDD-related HPO phenotype terms used to filter OMIM entries for SysNDD comparisons
     # Root term: HP:0012759 (Neurodevelopmental abnormality)
     # Review if HPO restructures the neurodevelopmental branch
     NDD_HPO_TERMS <- c(
       "HP:0012759", "HP:0001249", "HP:0001256", "HP:0002187",
       "HP:0002342", "HP:0006889", "HP:0010864"
     )
     ```
  2. Read phenotype.hpoa with `readr::read_tsv(phenotype_hpoa_path, skip = 4, show_col_types = FALSE)`
  3. Filter phenotype_hpoa for OMIM entries with NDD phenotypes (str_detect database_id "OMIM", filter hpo_id in NDD_HPO_TERMS, select database_id, unique)
  4. left_join NDD-filtered OMIM IDs with genemap2_data by c("database_id" = "disease_ontology_id")
  5. Filter out entries with NA Approved_Symbol
  6. Add columns: list = "omim_ndd", version = format(Sys.Date(), "%Y-%m-%d"), category = "Definitive"
  7. Select and rename to comparisons schema: gene_symbol = Approved_Symbol, disease_ontology_id = database_id, disease_ontology_name, inheritance = hpo_mode_of_inheritance_term_name, list, version, category
  8. Return result

  Remove ALL inline genemap2 parsing code. The function does NOT call parse_genemap2() -- it receives its output. No duplicate parsing or inheritance normalization code should remain.

  **Change 2: Modify comparisons_update_async() OMIM processing (around lines 859-877)**

  Since omim_genemap2 is being removed from comparisons_config, it won't appear in the `sources` tibble from get_active_sources(). The switch block's "omim_genemap2" case will never match.

  Remove the "omim_genemap2" case from the switch statement entirely.

  After the existing `for (i in seq_len(nrow(sources)))` parse loop (around line 890), add a dedicated OMIM block that:

  1. Calls `download_genemap2(output_path = "data/", force = FALSE)` for the shared cached genemap2 path
  2. Calls `parse_genemap2(genemap2_path)` to get the parsed tibble
  3. Gets the phenotype.hpoa path -- this now uses `download_hpoa()`:
     - Read the phenotype_hpoa URL from `downloaded_files[["phenotype_hpoa"]]` -- BUT WAIT, since phenotype_hpoa is STILL in comparisons_config, it was downloaded by the main download loop into temp_dir. However, we now want to use the CACHED version. Two approaches:
       a. Keep using downloaded_files[["phenotype_hpoa"]] from the temp download (simpler, no change to download loop)
       b. Replace the temp download with download_hpoa() call

     Use approach (b): Before the main download loop, retrieve the phenotype_hpoa URL from the sources tibble, then call `download_hpoa(url, output_path = "data/", force = FALSE)` to get the cached path. Store it in `downloaded_files[["phenotype_hpoa"]]`. When the main download loop encounters phenotype_hpoa, skip it (it's already cached).

     ACTUALLY, simpler approach: In the main download loop, when source_name is "phenotype_hpoa", call `download_hpoa(source$source_url, output_path = "data/", force = FALSE)` instead of `download_source_data()`. This replaces the temp download with the cached download. The rest of the flow stays the same.

     Implementation: Add a special case in the download loop:
     ```r
     for (i in seq_len(nrow(sources))) {
       source <- sources[i, ]
       source_name <- source$source_name

       if (source_name == "phenotype_hpoa") {
         # Use persistent caching instead of temp download
         file_path <- download_hpoa(
           url = source$source_url,
           output_path = "data/",
           force = FALSE
         )
       } else {
         file_path <- download_source_data(source, temp_dir)
       }

       if (is.null(file_path)) {
         stop(sprintf("Failed to download source: %s", source_name))
       }

       downloaded_files[[source_name]] <- file_path
     }
     ```

  4. After the main parse loop, add the OMIM block:
     ```r
     # Parse OMIM via shared infrastructure (not in comparisons_config anymore)
     message(sprintf("[%s] [job:%s] Parsing omim_genemap2 via shared infrastructure...", Sys.time(), job_id))
     omim_parsed <- tryCatch({
       genemap2_path <- download_genemap2(output_path = "data/", force = FALSE)
       genemap2_data <- parse_genemap2(genemap2_path)
       hpoa_path <- downloaded_files[["phenotype_hpoa"]]
       if (is.null(hpoa_path)) {
         stop("phenotype_hpoa file required for omim_genemap2 parsing")
       }
       parsed <- adapt_genemap2_for_comparisons(genemap2_data, hpoa_path)
       standardize_comparison_data(parsed, "omim_genemap2", import_date)
     }, error = function(e) {
       update_comparisons_metadata(conn, "failed", nrow(sources), 0,
                                    sprintf("Failed to parse omim_genemap2: %s", e$message))
       stop(sprintf("Failed to parse omim_genemap2: %s", e$message))
     })
     all_parsed_data[["omim_genemap2"]] <- omim_parsed
     message(sprintf("[%s] [job:%s] Parsed %d rows from omim_genemap2", Sys.time(), job_id, nrow(omim_parsed)))
     ```

  **Change 3: Skip update_source_last_updated() for omim_genemap2 (around lines 963-966)**

  In the source timestamp update loop, add a skip for omim_genemap2:
  ```r
  for (source_name in names(all_parsed_data)) {
    if (source_name == "omim_genemap2") {
      next
    }
    update_source_last_updated(conn, source_name)
  }
  ```

  WHY these specific changes:
  - adapt_genemap2_for_comparisons() is an ADAPTER, not a parser -- name reflects semantic change (CONTEXT.md line 29)
  - It receives pre-parsed data, not a file path -- because shared parse_genemap2() is called separately in comparisons_update_async()
  - download_hpoa() provides persistent caching for phenotype.hpoa (CONTEXT.md lines 36-39)
  - parse_genemap2() already does all raw parsing + inheritance normalization (single source of truth from Phase 76)
  - download_genemap2() provides 1-day TTL caching in data/ directory (shared with ontology system)
  - omim_genemap2 is removed from comparisons_config so it won't appear in get_active_sources() results
  - update_source_last_updated() would fail on a missing config row
  </action>
  <verify>
  1. `grep -c "adapt_genemap2_for_comparisons" api/functions/comparisons-functions.R` returns at least 2 (definition + call)
  2. `grep -c "parse_omim_genemap2" api/functions/comparisons-functions.R` returns 0 (old function deleted)
  3. `grep -c "parse_genemap2(genemap2_path)" api/functions/comparisons-functions.R` returns at least 1 (shared parser is called)
  4. `grep -c "download_genemap2" api/functions/comparisons-functions.R` returns at least 1 (shared download is called)
  5. `grep -c "download_hpoa" api/functions/comparisons-functions.R` returns at least 1 (cached hpoa download)
  6. No raw genemap2 file parsing remains: `grep -c "read_tsv.*genemap2\|read_tsv.*X1" api/functions/comparisons-functions.R` returns 0 (adapter receives pre-parsed tibble, does not read genemap2 files)
  7. No inheritance normalization case_when in adapter: `grep -c "case_when.*inheritance\|case_when.*Autosomal" api/functions/comparisons-functions.R` returns 0 (inheritance is already normalized by shared parse_genemap2())
  8. Version field uses date format: `grep "format(Sys.Date()" api/functions/comparisons-functions.R` matches in adapt_genemap2_for_comparisons
  9. Skip logic exists: `grep "omim_genemap2.*next" api/functions/comparisons-functions.R` returns a match
  10. R syntax check: `cd api && Rscript -e "parse(file='functions/comparisons-functions.R')"` succeeds without errors
  </verify>
  <done>
  parse_omim_genemap2() is DELETED and replaced by adapt_genemap2_for_comparisons() -- an adapter that receives pre-parsed genemap2 tibble (from parse_genemap2()), applies NDD filtering via phenotype.hpoa, and formats to comparisons schema. comparisons_update_async() calls download_genemap2() + parse_genemap2() for shared cache, download_hpoa() for cached phenotype.hpoa, and processes OMIM separately from config-based sources. update_source_last_updated() skips omim_genemap2. No duplicate parsing or inheritance normalization code remains.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create database migration to remove genemap2 from comparisons_config</name>
  <files>db/migrations/014_remove_genemap2_config.sql</files>
  <action>
  Create db/migrations/014_remove_genemap2_config.sql following the existing migration pattern (see 007_comparisons_config.sql for style reference).

  The migration should:
  1. Use DELIMITER // and a stored procedure pattern for idempotency (consistent with other migrations)
  2. Check if the omim_genemap2 row exists before deleting (idempotent)
  3. Delete ONLY the omim_genemap2 entry from comparisons_config
  4. Do NOT touch phenotype_hpoa (it stays -- comparisons-only, downloads from HPO)
  5. Include clear comments explaining why: "genemap2 download moves to shared infrastructure (Phase 76 download_genemap2())"

  Migration SQL structure:
  ```sql
  DELIMITER //
  CREATE PROCEDURE IF NOT EXISTS migrate_014_remove_genemap2_config()
  BEGIN
      -- Remove omim_genemap2 from comparisons_config
      -- Phase 78: genemap2 download/parse moves to shared infrastructure
      -- (Phase 76 download_genemap2() with 1-day TTL caching)
      -- phenotype_hpoa stays (comparisons-only, not shared)
      DELETE FROM comparisons_config WHERE source_name = 'omim_genemap2';
  END //
  CALL migrate_014_remove_genemap2_config() //
  DROP PROCEDURE IF EXISTS migrate_014_remove_genemap2_config //
  ```

  Also update db/migrations/README.md if it has a migration list (add entry for 014).
  </action>
  <verify>
  1. File exists: `ls db/migrations/014_remove_genemap2_config.sql`
  2. Contains correct DELETE: `grep "DELETE FROM comparisons_config WHERE source_name = 'omim_genemap2'" db/migrations/014_remove_genemap2_config.sql`
  3. Does NOT delete phenotype_hpoa: `grep -c "DELETE.*phenotype_hpoa" db/migrations/014_remove_genemap2_config.sql` returns 0
  4. Positive check that phenotype_hpoa is preserved: After running migration, verify with: `SELECT COUNT(*) FROM comparisons_config WHERE source_name = 'phenotype_hpoa';` should return 1. Add this as a verification SELECT at the end of the migration script (inside the procedure or after the CALL).
  5. Uses stored procedure pattern: `grep "CREATE PROCEDURE" db/migrations/014_remove_genemap2_config.sql`
  6. Contains phenotype_hpoa preservation verification: `grep "phenotype_hpoa" db/migrations/014_remove_genemap2_config.sql` returns a match (verification SELECT or comment confirming preservation)
  </verify>
  <done>
  Migration file 014_remove_genemap2_config.sql exists, removes only the omim_genemap2 row from comparisons_config, is idempotent, follows existing migration conventions, and includes positive verification that phenotype_hpoa is preserved.
  </done>
</task>

</tasks>

<verification>
1. R syntax check passes for omim-functions.R: `cd api && Rscript -e "parse(file='functions/omim-functions.R')"`
2. R syntax check passes for comparisons-functions.R: `cd api && Rscript -e "parse(file='functions/comparisons-functions.R')"`
3. No raw genemap2 file parsing in comparisons: `grep -c "read_tsv.*genemap2\|read_tsv.*X1" api/functions/comparisons-functions.R` is 0
4. Old function name gone: `grep -c "parse_omim_genemap2" api/functions/comparisons-functions.R` is 0
5. New adapter exists: `grep -c "adapt_genemap2_for_comparisons" api/functions/comparisons-functions.R` is at least 2
6. Shared infrastructure called: `grep "parse_genemap2\|download_genemap2\|download_hpoa" api/functions/comparisons-functions.R` shows all three calls
7. download_hpoa exists: `grep -c "download_hpoa" api/functions/omim-functions.R` is at least 1
8. Schema columns preserved: adapt_genemap2_for_comparisons() still returns gene_symbol, disease_ontology_id, disease_ontology_name, inheritance, list, version, category
9. Migration file exists and is syntactically correct
10. No inheritance normalization in adapter: `grep -c "case_when.*inheritance\|case_when.*Autosomal" api/functions/comparisons-functions.R` is 0
11. Lint check: `cd api && Rscript -e "lintr::lint('functions/comparisons-functions.R')"` produces 0 errors
12. Lint check: `cd api && Rscript -e "lintr::lint('functions/omim-functions.R')"` produces 0 errors
</verification>

<success_criteria>
- download_hpoa() exists in omim-functions.R with 1-day TTL caching in data/ directory
- parse_omim_genemap2() is DELETED from comparisons-functions.R
- adapt_genemap2_for_comparisons() exists as a new adapter function taking pre-parsed tibble + hpoa_path
- adapt_genemap2_for_comparisons() body is ~30-40 lines (NDD filtering + schema formatting only)
- comparisons_update_async() calls download_genemap2() + parse_genemap2() + download_hpoa() for cached infrastructure
- omim_genemap2 removed from switch block (processed separately after main loop)
- update_source_last_updated() skips omim_genemap2
- phenotype_hpoa download in main loop uses download_hpoa() for persistent caching
- Version field is date-based: format(Sys.Date(), "%Y-%m-%d")
- Migration 014 removes omim_genemap2 from comparisons_config with positive phenotype_hpoa preservation check
- R syntax checks pass, lintr passes
</success_criteria>

<output>
After completion, create `.planning/phases/78-comparisons-integration/78-01-SUMMARY.md`
</output>
