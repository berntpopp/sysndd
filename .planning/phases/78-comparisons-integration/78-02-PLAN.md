---
phase: 78-comparisons-integration
plan: 02
type: execute
wave: 2
depends_on: ["78-01"]
files_modified:
  - api/tests/testthat/test-unit-comparisons-functions.R
autonomous: true

must_haves:
  truths:
    - "Unit tests verify parse_omim_genemap2() output schema matches comparisons requirements"
    - "Tests use synthetic fixture data (no real OMIM data, no network calls)"
    - "Tests confirm NDD filtering only includes phenotype.hpoa-matched OMIM entries"
    - "Tests confirm version field is date-based (YYYY-MM-DD format)"
    - "Tests confirm inheritance column values are HPO-normalized (from shared parse_genemap2)"
  artifacts:
    - path: "api/tests/testthat/test-unit-comparisons-functions.R"
      provides: "Unit tests for reduced parse_omim_genemap2()"
      contains: "parse_omim_genemap2"
  key_links:
    - from: "api/tests/testthat/test-unit-comparisons-functions.R"
      to: "api/functions/comparisons-functions.R"
      via: "source() and function calls in tests"
      pattern: "parse_omim_genemap2"
    - from: "api/tests/testthat/test-unit-comparisons-functions.R"
      to: "api/functions/omim-functions.R"
      via: "parse_genemap2() called indirectly via parse_omim_genemap2()"
      pattern: "parse_genemap2"
---

<objective>
Add unit tests for the reduced parse_omim_genemap2() function to verify it correctly uses shared infrastructure and produces the expected comparisons schema output.

Purpose: Validate that Phase 78 code changes maintain schema compatibility and NDD filtering correctness. Uses synthetic fixture data to test without network or OMIM licensing concerns.

Output: Extended test-unit-comparisons-functions.R with new test section for parse_omim_genemap2().
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/78-comparisons-integration/78-CONTEXT.md
@.planning/phases/78-comparisons-integration/78-01-SUMMARY.md

Key source files:
@api/functions/comparisons-functions.R
@api/functions/omim-functions.R
@api/tests/testthat/test-unit-comparisons-functions.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create synthetic genemap2 and phenotype.hpoa fixture files</name>
  <files>api/tests/testthat/fixtures/genemap2_test.txt, api/tests/testthat/fixtures/phenotype_hpoa_test.txt</files>
  <action>
  Create two synthetic fixture files for testing parse_omim_genemap2() without real OMIM data.

  **Fixture 1: api/tests/testthat/fixtures/genemap2_test.txt**

  Create a minimal genemap2.txt-format file with:
  - Comment header lines starting with # (mimicking real genemap2 format)
  - Tab-delimited, 14 columns (X1-X14), no header row
  - At least 5 entries covering these test cases:
    a. NDD gene with known disease (will match phenotype.hpoa NDD filter) - e.g., MECP2, MIM 312750
    b. NDD gene with multiple inheritance modes - e.g., SCN1A, MIM 607208 with "Autosomal dominant"
    c. Non-NDD gene (will NOT match phenotype.hpoa filter) - e.g., BRCA1, MIM 114480
    d. Entry with no Approved_Symbol (should be filtered out)
    e. Entry with no disease MIM number in Phenotypes (should be filtered out)

  Column layout (tab-separated, 14 columns):
  1. Chromosome
  2. Genomic_Position_Start
  3. Genomic_Position_End
  4. Cyto_Location
  5. Computed_Cyto_Location
  6. MIM_Number (gene MIM)
  7. Gene_Symbols
  8. Gene_Name
  9. Approved_Symbol
  10. Entrez_Gene_ID
  11. Ensembl_Gene_ID
  12. Comments
  13. Phenotypes (the complex column with disease name, MIM, mapping key, inheritance)
  14. Mouse_Gene_Symbol_ID

  Example Phenotypes column format: "Rett syndrome, 312750 (3), Autosomal dominant"

  Use synthetic but structurally valid data. Gene names and MIM numbers should be realistic but the mapping to NDD phenotypes is what matters for filtering.

  **Fixture 2: api/tests/testthat/fixtures/phenotype_hpoa_test.txt**

  Create a minimal phenotype.hpoa-format file with:
  - 4 header lines (the first 4 lines are comments/headers that get skipped)
  - Tab-delimited with columns: database_id, disease_name, qualifier, hpo_id, reference, evidence, onset, frequency, sex, modifier, aspect, biocuration
  - At least 3 entries:
    a. OMIM:312750 with HP:0001249 (NDD phenotype - Intellectual disability) - will match NDD filter
    b. OMIM:607208 with HP:0012759 (NDD phenotype - Neurodevelopmental abnormality) - will match NDD filter
    c. OMIM:114480 with HP:0003002 (non-NDD phenotype) - will NOT match NDD filter

  The NDD HPO terms that comparisons filters on:
  "HP:0012759", "HP:0001249", "HP:0001256", "HP:0002187", "HP:0002342", "HP:0006889", "HP:0010864"

  Use synthetic data that is structurally valid for the read_tsv parsing.
  </action>
  <verify>
  1. Both fixture files exist: `ls api/tests/testthat/fixtures/genemap2_test.txt api/tests/testthat/fixtures/phenotype_hpoa_test.txt`
  2. genemap2 fixture has correct column count: `head -1 api/tests/testthat/fixtures/genemap2_test.txt | awk -F'\t' '{print NF}'` (should skip comments, first data line should have 14 columns)
  3. phenotype.hpoa fixture has header lines: `head -5 api/tests/testthat/fixtures/phenotype_hpoa_test.txt`
  </verify>
  <done>
  Two synthetic fixture files exist with structurally valid data covering NDD-matching entries, non-NDD entries, and edge cases (missing symbol, missing MIM). No real OMIM data used.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add parse_omim_genemap2() unit tests</name>
  <files>api/tests/testthat/test-unit-comparisons-functions.R</files>
  <action>
  Add a new test section to api/tests/testthat/test-unit-comparisons-functions.R AFTER the existing "Edge Cases and Error Handling" section (after line 398).

  Also add sourcing of omim-functions.R near the top (after line 27 where comparisons-functions.R is sourced), since parse_omim_genemap2() now calls parse_genemap2() from omim-functions.R:
  ```r
  source(file.path(api_dir, "functions/omim-functions.R"))
  ```

  Note: omim-functions.R requires file-functions.R. Check if it needs to be sourced too. Look at what omim-functions.R sources/requires. Since parse_genemap2() only uses readr, dplyr, tidyr, stringr (no file-functions.R), it should work. But download_genemap2() needs file-functions.R. Since tests only call parse_omim_genemap2() (which calls parse_genemap2(), not download_genemap2()), file-functions.R should not be needed.

  Also add: `library(readr)` if not already loaded (needed for fixture reading).

  New test section:
  ```r
  # ============================================================================
  # parse_omim_genemap2() Tests (Phase 78 - Shared Infrastructure)
  # ============================================================================

  test_that("parse_omim_genemap2 returns correct schema columns", {
    # Load fixtures
    genemap2_path <- file.path(api_dir, "tests/testthat/fixtures/genemap2_test.txt")
    hpoa_path <- file.path(api_dir, "tests/testthat/fixtures/phenotype_hpoa_test.txt")
    skip_if_not(file.exists(genemap2_path), "genemap2 fixture not found")
    skip_if_not(file.exists(hpoa_path), "phenotype.hpoa fixture not found")

    result <- parse_omim_genemap2(genemap2_path, hpoa_path)

    # Must have exact comparisons schema columns
    expected_cols <- c("gene_symbol", "disease_ontology_id", "disease_ontology_name",
                       "inheritance", "list", "version", "category")
    expect_true(all(expected_cols %in% colnames(result)))
    expect_equal(length(colnames(result)), length(expected_cols))
  })

  test_that("parse_omim_genemap2 filters only NDD-related entries", {
    genemap2_path <- file.path(api_dir, "tests/testthat/fixtures/genemap2_test.txt")
    hpoa_path <- file.path(api_dir, "tests/testthat/fixtures/phenotype_hpoa_test.txt")
    skip_if_not(file.exists(genemap2_path), "genemap2 fixture not found")
    skip_if_not(file.exists(hpoa_path), "phenotype.hpoa fixture not found")

    result <- parse_omim_genemap2(genemap2_path, hpoa_path)

    # Should include NDD genes (those matching HPO NDD phenotypes)
    # Should NOT include non-NDD genes (e.g., BRCA1 with non-NDD HPO)
    expect_true(nrow(result) > 0)

    # All entries should have list = "omim_ndd"
    expect_true(all(result$list == "omim_ndd"))

    # All entries should have category = "Definitive"
    expect_true(all(result$category == "Definitive"))
  })

  test_that("parse_omim_genemap2 uses date-based version field", {
    genemap2_path <- file.path(api_dir, "tests/testthat/fixtures/genemap2_test.txt")
    hpoa_path <- file.path(api_dir, "tests/testthat/fixtures/phenotype_hpoa_test.txt")
    skip_if_not(file.exists(genemap2_path), "genemap2 fixture not found")
    skip_if_not(file.exists(hpoa_path), "phenotype.hpoa fixture not found")

    result <- parse_omim_genemap2(genemap2_path, hpoa_path)

    skip_if(nrow(result) == 0, "No NDD entries matched in fixtures")

    # Version should be YYYY-MM-DD format (today's date)
    expect_true(all(grepl("^[0-9]{4}-[0-9]{2}-[0-9]{2}$", result$version)))

    # Version should NOT contain "genemap2" prefix
    expect_false(any(grepl("genemap2", result$version)))
  })

  test_that("parse_omim_genemap2 has normalized inheritance values", {
    genemap2_path <- file.path(api_dir, "tests/testthat/fixtures/genemap2_test.txt")
    hpoa_path <- file.path(api_dir, "tests/testthat/fixtures/phenotype_hpoa_test.txt")
    skip_if_not(file.exists(genemap2_path), "genemap2 fixture not found")
    skip_if_not(file.exists(hpoa_path), "phenotype.hpoa fixture not found")

    result <- parse_omim_genemap2(genemap2_path, hpoa_path)

    skip_if(nrow(result) == 0, "No NDD entries matched in fixtures")

    # Non-NA inheritance values should be HPO-normalized (full form, not short)
    non_na_inheritance <- result$inheritance[!is.na(result$inheritance)]
    if (length(non_na_inheritance) > 0) {
      # Should NOT have short forms like "Autosomal dominant" (without "inheritance")
      expect_false(any(non_na_inheritance == "Autosomal dominant"))
      expect_false(any(non_na_inheritance == "Autosomal recessive"))
      expect_false(any(non_na_inheritance == "X-linked dominant"))
    }
  })

  test_that("parse_omim_genemap2 disease_ontology_id has OMIM prefix", {
    genemap2_path <- file.path(api_dir, "tests/testthat/fixtures/genemap2_test.txt")
    hpoa_path <- file.path(api_dir, "tests/testthat/fixtures/phenotype_hpoa_test.txt")
    skip_if_not(file.exists(genemap2_path), "genemap2 fixture not found")
    skip_if_not(file.exists(hpoa_path), "phenotype.hpoa fixture not found")

    result <- parse_omim_genemap2(genemap2_path, hpoa_path)

    skip_if(nrow(result) == 0, "No NDD entries matched in fixtures")

    # All disease_ontology_id values should start with "OMIM:"
    expect_true(all(grepl("^OMIM:", result$disease_ontology_id)))
  })

  test_that("parse_omim_genemap2 excludes entries without gene symbol", {
    genemap2_path <- file.path(api_dir, "tests/testthat/fixtures/genemap2_test.txt")
    hpoa_path <- file.path(api_dir, "tests/testthat/fixtures/phenotype_hpoa_test.txt")
    skip_if_not(file.exists(genemap2_path), "genemap2 fixture not found")
    skip_if_not(file.exists(hpoa_path), "phenotype.hpoa fixture not found")

    result <- parse_omim_genemap2(genemap2_path, hpoa_path)

    # No NA gene_symbol values should be present
    expect_false(any(is.na(result$gene_symbol)))
  })
  ```

  Adjust fixture paths and test expectations based on the actual fixture data created in Task 1. The fixtures should be designed so that:
  - At least 2 entries match the NDD filter (MECP2 + SCN1A)
  - At least 1 entry does NOT match (BRCA1)
  - At least 1 entry has NA Approved_Symbol (filtered out)
  </action>
  <verify>
  Run the tests:
  ```bash
  cd api && Rscript -e "testthat::test_file('tests/testthat/test-unit-comparisons-functions.R')"
  ```
  All new parse_omim_genemap2 tests pass. Existing tests still pass.
  </verify>
  <done>
  6 new unit tests for parse_omim_genemap2() pass, verifying: correct schema columns, NDD-only filtering, date-based version, HPO-normalized inheritance, OMIM-prefixed disease IDs, and no-NA gene symbols. All tests use synthetic fixture data with no network calls.
  </done>
</task>

</tasks>

<verification>
1. All tests pass: `cd api && Rscript -e "testthat::test_file('tests/testthat/test-unit-comparisons-functions.R')"`
2. Fixture files exist in api/tests/testthat/fixtures/
3. No tests require network or database access
4. Existing tests in the file still pass (no regression)
</verification>

<success_criteria>
- 6 new tests for parse_omim_genemap2() all pass
- Tests cover: schema columns, NDD filtering, date version, inheritance normalization, OMIM prefix, gene symbol not-null
- Synthetic fixture files created (genemap2_test.txt, phenotype_hpoa_test.txt)
- Existing comparisons tests unaffected
- No network or database dependencies in new tests
</success_criteria>

<output>
After completion, create `.planning/phases/78-comparisons-integration/78-02-SUMMARY.md`
</output>
