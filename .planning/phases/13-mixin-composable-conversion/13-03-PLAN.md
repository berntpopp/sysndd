---
phase: 13-mixin-composable-conversion
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - app/src/composables/useUrlParsing.js
  - app/src/composables/index.js
autonomous: true

must_haves:
  truths:
    - "useUrlParsing provides filterObjToStr, filterStrToObj, sortStringToVariables functions"
    - "sortStringToVariables returns Bootstrap-Vue-Next array format sortBy"
    - "Filter conversion produces URL-safe parameter strings"
  artifacts:
    - path: "app/src/composables/useUrlParsing.js"
      provides: "URL parameter parsing and conversion utilities"
      exports: ["useUrlParsing"]
    - path: "app/src/composables/index.js"
      provides: "Updated barrel export including useUrlParsing"
      contains: "export { default as useUrlParsing }"
  key_links:
    - from: "app/src/composables/useUrlParsing.js"
      to: "vue-router"
      via: "optional route/router access"
      pattern: "useRoute|useRouter"
---

<objective>
Create useUrlParsing composable with URL filter and sort utilities.

Purpose: Convert urlParsingMixin which provides filter-to-string conversion and sort string parsing. This composable is used by table components to manage URL query parameters for filtering and sorting.

Output: useUrlParsing composable with all URL parsing utilities
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-mixin-composable-conversion/13-CONTEXT.md
@.planning/phases/13-mixin-composable-conversion/13-RESEARCH.md

# Source mixin to convert
@app/src/assets/js/mixins/urlParsingMixin.js

# Prior plan summary
@.planning/phases/13-mixin-composable-conversion/13-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useUrlParsing composable</name>
  <files>app/src/composables/useUrlParsing.js, app/src/composables/index.js</files>
  <action>
Convert urlParsingMixin to useUrlParsing composable:

1. Create useUrlParsing.js with all three methods from the mixin:
   - filterObjToStr(filter_object) - Convert filter object to URL string
   - filterStrToObj(filter_string, standard_object, split_content, join_char_allow) - Parse URL string to filter object
   - sortStringToVariables(sort_string) - Parse sort string (+col/-col) to Bootstrap-Vue-Next format

2. Optionally provide access to route/router for components that need reactive URL updates

```javascript
import { useRoute, useRouter } from 'vue-router';

/**
 * Composable for URL parameter parsing and conversion.
 * Provides utilities for converting between filter objects and URL strings,
 * and for parsing sort strings.
 * @returns {Object} URL parsing methods and optional router access
 */
export default function useUrlParsing() {
  const route = useRoute();
  const router = useRouter();

  /**
   * Converts a filter object into a URL parameter string.
   * @param {Object} filter_object - Filter object with {field: {content, operator, join_char}}
   * @returns {string} URL-safe filter string
   */
  const filterObjToStr = (filter_object) => {
    const isObject = (obj) => obj === Object(obj);

    const filter_string_not_empty = Object.keys(filter_object)
      .filter((key) => isObject(filter_object[key]))
      .filter((key) => filter_object[key].content !== null)
      .filter((key) => filter_object[key].content !== 'null')
      .filter((key) => filter_object[key].content !== '')
      .filter((key) => filter_object[key].content.length !== 0)
      .reduce((obj, key) => Object.assign(obj, {
        [key]: filter_object[key],
      }), {});

    const filter_string_join = Object.keys(filter_string_not_empty)
      .map((key) => `${filter_string_not_empty[key].operator}(${key},${[].concat(filter_string_not_empty[key].content).join(filter_string_not_empty[key].join_char)})`);

    return filter_string_join.join(',');
  };

  /**
   * Converts a URL filter string into a filter object.
   * @param {string} filter_string - URL filter string to parse
   * @param {Object} standard_object - Default filter object structure
   * @param {string[]} split_content - Delimiters for splitting (default: [',(?! )'])
   * @param {string[]} join_char_allow - Allowed join characters (default: [','])
   * @returns {Object} Parsed filter object
   */
  const filterStrToObj = (filter_string, standard_object, split_content = [',(?! )'], join_char_allow = [',']) => {
    if (filter_string !== null && filter_string !== 'null' && filter_string !== '') {
      const filter_array = filter_string.split('),');

      const arrayLengthOverOne = (input_array, input_operator) => {
        const inputArr = input_array.filter(Boolean);
        if (inputArr.length > 0 && (input_operator === 'any' || input_operator === 'all')) {
          return inputArr;
        }
        if (inputArr.length === 0) {
          return null;
        }
        return inputArr.join('');
      };

      const assignJoinChar = (input_string, input_operator, allowed_join_char) => {
        if (input_operator === 'any' || input_operator === 'all') {
          return ',';
        }
        return null;
      };

      const filter_object = filter_array.reduce((obj, str) => {
        const [firstPart, secondPart, ...restPart] = str.replace(')', '').split(/\(|,(?! )/g);
        const objCopy = obj;
        if (firstPart && secondPart && restPart) {
          objCopy[secondPart.replace(/\s+/g, '')] = {
            content: arrayLengthOverOne(restPart, firstPart.trim()),
            operator: firstPart.trim(),
            join_char: assignJoinChar(restPart, firstPart.trim(), join_char_allow),
          };
        }
        return objCopy;
      }, {});

      return { ...standard_object, ...filter_object };
    }
    return standard_object;
  };

  /**
   * Converts a sort string to Bootstrap-Vue-Next array format.
   * @param {string} sort_string - Sort string (e.g., '+entity_id' or '-symbol')
   * @returns {Object} Object with sortBy array: { sortBy: [{ key, order }] }
   */
  const sortStringToVariables = (sort_string) => {
    const sortStr = sort_string.trim();
    const isDesc = sortStr.substr(0, 1) === '-';
    const columnKey = sortStr.replace('+', '').replace('-', '');

    return {
      sortBy: [{ key: columnKey, order: isDesc ? 'desc' : 'asc' }],
    };
  };

  return {
    filterObjToStr,
    filterStrToObj,
    sortStringToVariables,
    route,
    router,
  };
}
```

3. Update index.js to export useUrlParsing
  </action>
  <verify>
- useUrlParsing.js exists with all three methods
- index.js exports useUrlParsing
- Methods match mixin signatures exactly
  </verify>
  <done>useUrlParsing composable created with filter and sort URL utilities</done>
</task>

<task type="auto">
  <name>Task 2: Add unit verification for URL parsing logic</name>
  <files>app/src/composables/useUrlParsing.js</files>
  <action>
Add inline verification comments and ensure the logic matches the mixin exactly:

Test cases to mentally verify:
1. filterObjToStr with empty filter -> returns ''
2. filterObjToStr with single filter -> returns 'eq(field,value)'
3. filterObjToStr with multiple filters -> returns 'eq(field1,value1),any(field2,val1,val2)'
4. sortStringToVariables('+entity_id') -> { sortBy: [{ key: 'entity_id', order: 'asc' }] }
5. sortStringToVariables('-symbol') -> { sortBy: [{ key: 'symbol', order: 'desc' }] }

Verify by reviewing the code paths match the original mixin implementation character-for-character for the core logic.
  </action>
  <verify>
All methods produce identical output to original mixin for:
- Empty inputs
- Single value inputs
- Multi-value inputs (arrays)
- Sort ascending/descending
  </verify>
  <done>URL parsing logic verified to match original mixin behavior</done>
</task>

</tasks>

<verification>
1. useUrlParsing.js exists and is exported from index.js

2. Build succeeds: `cd app && npm run build`

3. Logic verification (can be done in dev tools):
```javascript
import { useUrlParsing } from '@/composables';
const { filterObjToStr, sortStringToVariables } = useUrlParsing();

// Test filterObjToStr
const filter = {
  symbol: { content: 'MECP2', operator: 'eq', join_char: null }
};
console.log(filterObjToStr(filter)); // Should output: eq(symbol,MECP2)

// Test sortStringToVariables
console.log(sortStringToVariables('-entity_id'));
// Should output: { sortBy: [{ key: 'entity_id', order: 'desc' }] }
```
</verification>

<success_criteria>
- useUrlParsing composable created with all URL parsing methods
- Function signatures match original mixin exactly
- sortStringToVariables returns Bootstrap-Vue-Next array format
- Composable exported from index.js
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/13-mixin-composable-conversion/13-03-SUMMARY.md`
</output>
