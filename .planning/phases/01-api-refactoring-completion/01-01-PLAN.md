---
phase: 01-api-refactoring-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/scripts/verify-endpoints.R
  - api/scripts/endpoint-inventory.R
autonomous: false

must_haves:
  truths:
    - "All 21 endpoint files are mounted and responding"
    - "Public endpoints return 200 without authentication"
    - "OpenAPI spec validates without errors"
    - "Endpoint inventory matches mount points in start_sysndd_api.R"
  artifacts:
    - path: "api/scripts/verify-endpoints.R"
      provides: "Endpoint verification script"
      min_lines: 80
    - path: "api/scripts/endpoint-inventory.R"
      provides: "Route extraction and inventory generation"
      min_lines: 40
  key_links:
    - from: "api/scripts/verify-endpoints.R"
      to: "http://localhost:7778/api/*"
      via: "httr2 requests"
      pattern: "httr2::request"
    - from: "api/scripts/endpoint-inventory.R"
      to: "api/start_sysndd_api.R"
      via: "plumber spec extraction"
      pattern: "plumber::plumb"
---

<objective>
Create verification scripts and confirm all 94 refactored API endpoints respond correctly.

Purpose: REF-01 requires verifying that the refactored endpoint structure works before removing legacy code. This plan creates reusable verification tooling and validates the API.

Output: Two verification scripts (endpoint inventory generator, endpoint verifier) and a human-verified confirmation that the API works.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-api-refactoring-completion/01-RESEARCH.md

# Key API files
@api/start_sysndd_api.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create endpoint inventory script</name>
  <files>api/scripts/endpoint-inventory.R</files>
  <action>
Create a script that extracts all routes from the API and generates a verification checklist.

The script should:
1. Load the plumber API from start_sysndd_api.R (without running it)
2. Extract the OpenAPI spec using `api$getApiSpec()`
3. Parse all paths and their HTTP methods
4. Generate a CSV checklist at `api/results/endpoint-checklist.csv` with columns:
   - path (the endpoint path)
   - methods (comma-separated HTTP methods)
   - auth_required (TRUE/FALSE based on method - GET without body = FALSE)
   - verified (FALSE by default)
   - notes (empty by default)
5. Print a summary showing total endpoint count by mount point

Use these patterns from research:
- `library(plumber)` for API loading
- `api$getApiSpec()` to get OpenAPI spec
- `names(spec$paths)` to extract paths
- Write CSV to api/results/ directory (create if needed)

Important: The script must run from the api/ directory. Add `setwd()` guard at top.
  </action>
  <verify>
Run from api/ directory: `Rscript scripts/endpoint-inventory.R`
- Script completes without errors
- api/results/endpoint-checklist.csv is created
- CSV contains rows for all 94 endpoints (approximately)
- Print output shows 21 mount points
  </verify>
  <done>endpoint-inventory.R generates CSV with all API routes; CSV file exists in api/results/</done>
</task>

<task type="auto">
  <name>Task 2: Create endpoint verification script</name>
  <files>api/scripts/verify-endpoints.R</files>
  <action>
Create a script that verifies all public GET endpoints respond with expected status codes.

The script should:
1. Accept command-line args: --host (default localhost), --port (default 7778)
2. Define a list of public GET endpoints (no auth required) derived from the 21 mount points:
   - /api/entity/ (200)
   - /api/gene/ (200)
   - /api/status/ (200)
   - /api/status/_list (200)
   - /api/ontology/ (200)
   - /api/phenotype/options (200)
   - /api/statistics/category_count (200)
   - /api/search/test (200) - if exists
   - /api/panels/ (200)
   - /api/comparisons/ (200)
   - /api/list/ (200)
   - /api/analysis/ (200)
   - /api/hash/ (200)
   - /api/variant/ (200)
   - /api/publication/ (200)
   - /api/review/ (200)
   - /api/re_review/ (200)
   - /api/logs/ (200)
   - /api/admin/ (401 expected - requires auth)
   - /api/user/ (401 expected - requires auth)
   - /api/auth/ (skip - POST only)
   - /api/external/ (200 or skip if external dependency)

3. Use httr2 for HTTP requests with proper error handling:
   ```r
   verify_endpoint <- function(path, expected_status = 200) {
     tryCatch({
       resp <- httr2::request(paste0(base_url, path)) |>
         httr2::req_error(is_error = function(resp) FALSE) |>
         httr2::req_perform()
       status <- httr2::resp_status(resp)
       # Compare and report
     }, error = function(e) {
       # Handle connection errors
     })
   }
   ```

4. Print results in format: [OK]/[FAIL]/[ERROR] path - status
5. Print summary: X/Y passed

CRITICAL: Include trailing slashes for root endpoints (trailingSlash = TRUE in API config).

Use httr2 (not httr) - it's the modern replacement.
  </action>
  <verify>
Script syntax check: `Rscript -e "source('api/scripts/verify-endpoints.R', local=TRUE)"`
- No syntax errors
- Script defines verify_endpoint function
- Script defines endpoint list
  </verify>
  <done>verify-endpoints.R created with httr2-based verification logic; script parses without errors</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Created two verification scripts:
1. endpoint-inventory.R - Extracts routes from OpenAPI spec
2. verify-endpoints.R - Tests endpoints against running API
  </what-built>
  <how-to-verify>
**Prerequisites:** API must be running locally with database connected.

1. Start the API (if not already running):
   ```bash
   cd /mnt/c/development/sysndd/api
   Rscript start_sysndd_api.R
   ```
   Wait for "Running API at http://0.0.0.0:7778" message.

2. In a new terminal, run inventory script:
   ```bash
   cd /mnt/c/development/sysndd/api
   Rscript scripts/endpoint-inventory.R
   ```
   Verify: CSV created, endpoint count ~94

3. Run verification script:
   ```bash
   Rscript scripts/verify-endpoints.R
   ```
   Verify: Most public endpoints return [OK]

4. Check that mount points match start_sysndd_api.R (21 mounts).

**Expected results:**
- endpoint-checklist.csv has ~94 rows
- Verification shows majority of endpoints responding
- Any failures are documented for investigation
  </how-to-verify>
  <resume-signal>Type "verified" if endpoints respond correctly, or describe any failures that need investigation</resume-signal>
</task>

</tasks>

<verification>
- [ ] endpoint-inventory.R runs and generates CSV
- [ ] verify-endpoints.R runs against local API
- [ ] Public endpoints return 200
- [ ] Protected endpoints return 401 (expected)
- [ ] No unexpected 404 or 500 errors
</verification>

<success_criteria>
- Verification scripts exist and are executable
- API endpoint verification passes (public endpoints return expected status codes)
- Human confirms endpoints are working via manual verification
- CSV inventory documents all 94 endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/01-api-refactoring-completion/01-01-SUMMARY.md`
</output>
