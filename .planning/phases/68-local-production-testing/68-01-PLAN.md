---
phase: 68-local-production-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Makefile
autonomous: true

must_haves:
  truths:
    - "4 API replicas run simultaneously with healthy status"
    - "Container logs show parallel startup (timestamps within 5 seconds)"
    - "All 4 containers can write to shared /app/data directory"
    - "Fresh database triggers migration from exactly one container"
  artifacts:
    - path: "Makefile"
      provides: "test-scaling target for multi-container validation"
      contains: "test-scaling:"
  key_links:
    - from: "make test-scaling"
      to: "docker compose --scale api=4"
      via: "Makefile target orchestration"
      pattern: "--scale api=4"
---

<objective>
Create and execute a comprehensive multi-container scaling test to validate Phase 66 (infrastructure) and Phase 67 (migration coordination) changes.

Purpose: Verify that horizontal scaling works correctly before production deployment - 4 API containers should start in parallel, write to shared data directory, and coordinate migrations properly.

Output: Makefile `test-scaling` target and verified passing test results.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/66-infrastructure-fixes/66-01-SUMMARY.md
@.planning/phases/67-migration-coordination/67-01-SUMMARY.md
@.planning/phases/68-local-production-testing/68-RESEARCH.md
@Makefile
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test-scaling Makefile target</name>
  <files>Makefile</files>
  <action>
Add a new `test-scaling` target to the Makefile that orchestrates the complete multi-container validation sequence. The target should:

1. Clean up previous test state with `docker compose -f docker-compose.yml down -v --remove-orphans`
2. Start MySQL with fresh database and wait for health check
3. Start 4 API replicas with `docker compose -f docker-compose.yml up -d --scale api=4 api`
4. Wait for containers to stabilize (use polling with timeout, not fixed sleep)
5. Verify all 4 containers are healthy via `docker compose ps`
6. Check logs for parallel startup (timestamps within 5 seconds) - grep for "Fast path" or "Database pool created"
7. Verify migration coordination: exactly 1 "Acquired migration lock" OR all 4 "Fast path" messages
8. Test data directory writes from each container using `docker compose exec --index=$i api`
9. Clean up test containers
10. Report pass/fail summary

Follow existing Makefile patterns:
- Use `check-docker` prerequisite
- Use `[quality]` category for help display
- Use color codes (CYAN, GREEN, RED) for output
- Use `COMPOSE_PROD := docker compose -f docker-compose.yml` variable

Key log patterns to verify (from Phase 67 implementation):
- "Fast path: schema up to date, no lock needed" - indicates parallel startup working
- "Acquired migration lock" - only 1 container should log this on fresh DB
- "Database pool created" - all containers should log this

Handle both scenarios:
- Fresh database: 1 lock acquisition + 3 fast path (or similar pattern)
- Existing database: 4 fast path messages (all skip lock)

The test should FAIL with clear error message if:
- Fewer than 4 containers become healthy
- Log timestamps show 30+ second gaps (sequential lock waiting)
- Any container fails to write to data directory
  </action>
  <verify>
Run `make help` and confirm `test-scaling` appears under Quality section.
Inspect target syntax with `grep -A 50 "^test-scaling:" Makefile`.
  </verify>
  <done>
Makefile contains complete test-scaling target with all validation steps, following project conventions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Execute scaling test and fix any issues</name>
  <files>Makefile</files>
  <action>
Run `make test-scaling` and validate all 4 requirements pass:

**TEST-01: 4 replicas run**
- `docker compose ps api` shows 4 containers with "healthy" status
- If fails: Check container logs for startup errors

**TEST-02: Parallel startup**
- Log timestamps for "Database pool created" or "Fast path" are within 5 seconds
- If fails: Migration coordination may have issues - check for "timed out" messages

**TEST-03: Data directory writes**
- Each container successfully writes test file to /app/data
- If fails: UID mismatch issue - verify Dockerfile ARG UID is set correctly

**TEST-04: Migration coordination**
- Either: 1 "Acquired migration lock" (fresh DB) OR 4 "Fast path" (existing DB)
- Never: Multiple "Acquired migration lock" messages

If any test fails:
1. Capture the error output
2. Identify the root cause (likely in Phase 66/67 implementation)
3. Fix the issue in the appropriate file
4. Re-run `make test-scaling` until all pass

Expected successful output:
```
========================================
       SCALING TEST PASSED
========================================
```
  </action>
  <verify>
`make test-scaling` completes with "SCALING TEST PASSED" message.
All 4 verification steps pass without manual intervention.
  </verify>
  <done>
test-scaling target runs successfully, validating TEST-01 through TEST-04 requirements.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Automated verification:**
   - `make help | grep test-scaling` shows the target
   - `make test-scaling` passes without errors

2. **Requirement coverage:**
   - TEST-01: Verified by container health check (4 healthy)
   - TEST-02: Verified by log timestamp analysis
   - TEST-03: Verified by write test in each container
   - TEST-04: Verified by migration lock count analysis
</verification>

<success_criteria>
- [ ] Makefile contains `test-scaling` target following project conventions
- [ ] `make test-scaling` passes with "SCALING TEST PASSED" message
- [ ] All 4 TEST requirements validated by automated checks
- [ ] No manual intervention required for test to pass
</success_criteria>

<output>
After completion, create `.planning/phases/68-local-production-testing/68-01-SUMMARY.md`
</output>
