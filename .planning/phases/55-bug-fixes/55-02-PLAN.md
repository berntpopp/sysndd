---
phase: 55-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - api/endpoints/user_endpoints.R
  - api/endpoints/entity_endpoints.R
  - api/endpoints/statistics_endpoints.R
  - api/functions/publication-repository.R
  - api/endpoints/review_endpoints.R
  - api/services/approval-service.R
  - app/src/views/ReReviewFormView.vue
autonomous: true

must_haves:
  truths:
    - "Viewer-status users can view their profile page without auto-logout"
    - "Adding a new PMID during re-review preserves existing PMIDs"
    - "Entities-over-time chart displays accurate counts matching database"
    - "Disease renaming triggers approval workflow"
    - "Re-reviewer identity preserved when reviews are modified"
  artifacts:
    - path: "api/endpoints/user_endpoints.R"
      provides: "User contributions endpoint accessible to Viewer role"
      contains: "contributions"
    - path: "api/functions/publication-repository.R"
      provides: "PMID preservation logic during re-review"
      contains: "publication_connect_to_review|publication_replace_for_review"
    - path: "api/endpoints/statistics_endpoints.R"
      provides: "Correct entities-over-time query"
      contains: "entities_over_time"
  key_links:
    - from: "app/src/views/UserView.vue"
      to: "api/endpoints/user_endpoints.R"
      via: "GET /user/{id}/contributions"
      pattern: "contributions"
    - from: "app/src/views/ReReviewFormView.vue"
      to: "api/functions/publication-repository.R"
      via: "publication update API"
      pattern: "publication"
---

<objective>
Fix five curation workflow bugs: viewer profile auto-logout (BUG-04), PMID preservation (BUG-05), entities-over-time chart (BUG-06), disease renaming approval (BUG-07), and re-reviewer identity (BUG-08).

Purpose: These bugs affect curation workflow usability and data integrity. Viewer users cannot access their profile, PMIDs are accidentally deleted, chart shows wrong counts, disease renames bypass approval, and re-reviewer identity is lost.

Output: All five bugs fixed with proper authorization, data preservation, and workflow enforcement.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-bug-fixes/55-CONTEXT.md
@.planning/phases/55-bug-fixes/55-RESEARCH.md

# Key source files
@api/endpoints/user_endpoints.R
@api/endpoints/entity_endpoints.R
@api/endpoints/statistics_endpoints.R
@api/functions/publication-repository.R
@api/services/approval-service.R
@api/functions/review-repository.R
@app/src/views/UserView.vue
@app/src/views/ReReviewFormView.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix viewer profile auto-logout and PMID preservation</name>
  <files>
    api/endpoints/user_endpoints.R
    api/functions/publication-repository.R
    app/src/views/ReReviewFormView.vue
  </files>
  <action>
Fix BUG-04 (viewer profile auto-logout) and BUG-05 (PMID preservation during re-review):

**BUG-04: Viewer Profile Auto-logout**

1. **Identify the issue** in `api/endpoints/user_endpoints.R`:
   - The `/user/{user_id}/contributions` endpoint (line ~160) requires "Reviewer" role
   - Viewer users calling this endpoint get 403, triggering frontend logout

2. **Fix authorization**:
   - Change `require_role(req, res, "Reviewer")` to `require_role(req, res, "Viewer")`
   - Or better: Allow users to view their OWN contributions regardless of role
   - Add check: `if (user_id != req$user_id) require_role(req, res, "Reviewer")`

3. **Test the fix**:
   - Login as Viewer user
   - Navigate to profile page
   - Verify no auto-logout occurs and contribution stats load

**BUG-05: PMID Preservation During Re-Review**

1. **Understand the issue** in `api/functions/publication-repository.R`:
   - `publication_replace_for_review()` DELETES all existing publications before INSERT
   - If frontend sends only NEW PMID, existing PMIDs are lost

2. **Investigate frontend behavior** in re-review form:
   - Check if `ReReviewFormView.vue` (or related component) sends ALL PMIDs or only new ones
   - Look for the API call that updates publications during re-review

3. **Fix options (choose most appropriate)**:
   - Option A: Frontend fix - Ensure form collects existing + new PMIDs before submission
   - Option B: Backend fix - Add `publication_add_to_review()` function that INSERT without DELETE
   - Option C: Hybrid - Backend checks if this is "add" vs "replace" based on request flag

4. **Recommended fix (Option A + validation)**:
   - In frontend re-review form, load existing PMIDs into state on mount
   - When adding new PMID, append to existing list
   - Submit full list to API
   - Add backend validation: log warning if PMID count decreases

5. **Test PMID preservation**:
   - Open entity with 2 PMIDs in re-review form
   - Add a third PMID
   - Submit and verify all 3 PMIDs are preserved
  </action>
  <verify>
    - Viewer user can access profile page without logout (test with fresh Viewer account)
    - GET `/api/user/{viewer_id}/contributions` returns 200 for Viewer accessing own profile
    - Re-review with existing PMIDs: add new PMID, submit, verify all PMIDs preserved
    - `make test-api` passes
  </verify>
  <done>
    - Viewer-status users can view their profile page without auto-logout
    - Adding new PMID during re-review preserves all existing PMIDs
    - No accidental PMID deletion occurs
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix entities-over-time chart and add diagnostic logging</name>
  <files>
    api/endpoints/statistics_endpoints.R
  </files>
  <action>
Fix BUG-06 (entities-over-time chart shows incorrect counts):

1. **Analyze current query** in `api/endpoints/statistics_endpoints.R` `/entities_over_time` endpoint (lines 74-196):
   - Query uses `ndd_entity_view` with filters
   - Groups by category/inheritance and summarizes by time
   - Computes cumulative count with `cumsum()`

2. **Identify potential issues**:
   - **Missing DISTINCT**: If query joins tables that create duplicates, counts are inflated
   - **Filter mismatch**: Default filter may exclude some entities unexpectedly
   - **Date boundary issues**: `summarize_by_time` ceiling vs floor could shift counts
   - **Stale view data**: `ndd_entity_view` may have stale data if it's a materialized view

3. **Debug by comparing counts**:
   - Add temporary logging to compare API count vs direct database count
   - Run: `SELECT COUNT(DISTINCT entity_id) FROM ndd_entity WHERE is_active = 1 AND ndd_phenotype = 1`
   - Compare with API response `max_cumulative_count`

4. **Fix identified issues**:
   - Add `DISTINCT` to entity selection if duplicates found
   - Verify filter expressions match expected behavior
   - Check `summarize_by_time()` parameters (.type = "ceiling" may need to be "floor")
   - If view is stale, query from base tables instead

5. **Add validation logging**:
   - Log total entity count before and after filtering
   - Log final cumulative count
   - This helps identify where discrepancy occurs

6. **Verify with real data**:
   - Compare chart counts with manual database query
   - Check multiple time periods for consistency

Note: `summarize_by_time()` is from the `timetk` package - verify its aggregation behavior.
  </action>
  <verify>
    - API `/api/statistics/entities_over_time` returns counts matching direct database query
    - Chart visualization shows correct cumulative counts
    - Log output shows entity count at each aggregation step
    - `make test-api` passes
  </verify>
  <done>
    - Entities-over-time chart displays accurate counts matching database
    - Debug logging helps identify any future discrepancies
    - Chart updates correctly when new entities are added
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix disease renaming approval and re-reviewer identity</name>
  <files>
    api/endpoints/entity_endpoints.R
    api/services/approval-service.R
    api/functions/review-repository.R
    api/endpoints/review_endpoints.R
  </files>
  <action>
Fix BUG-07 (disease renaming bypasses approval) and BUG-08 (re-reviewer identity lost):

**BUG-07: Disease Renaming Approval Workflow**

1. **Analyze current behavior** in `api/endpoints/entity_endpoints.R` POST `/rename`:
   - Current flow: Create new entity -> deactivate old -> copy review/status -> done
   - Problem: New entity is immediately active without approval

2. **Implement approval workflow**:
   - Follow existing re-review approval pattern from `services/approval-service.R`
   - When renaming disease:
     a. Create new entity with `is_active = 0` (pending approval)
     b. Create review with `review_approved = 0`
     c. Create status with `status_approved = 0`
     d. DO NOT deactivate old entity yet (wait for approval)
   - On approval:
     a. Set new entity `is_active = 1`
     b. Deactivate old entity with `replaced_by = new_entity_id`

3. **Add to approval table**:
   - Insert record in appropriate approval tracking table
   - Use existing patterns from status/review approval

4. **Update endpoint response**:
   - Return `pending_approval = TRUE` to inform frontend
   - Frontend should show "Pending approval" status

**BUG-08: Re-reviewer Identity Preservation**

1. **Identify the issue** in `api/functions/review-repository.R`:
   - `review_update()` function may overwrite `review_user_id`
   - Check what fields are being updated and if original user is preserved

2. **Check database schema**:
   - `ndd_entity_review` table: Does it have separate `review_user_id` (original) and `approving_user_id` (approver)?
   - If only one field, need to add `created_by_user_id` or similar

3. **Fix update logic**:
   - In `review_update()`, ensure it does NOT update `review_user_id`
   - Only update content fields (synopsis, etc.) and tracking fields (modified_at if exists)
   - Keep original `review_user_id` intact

4. **Add modification tracking (nice-to-have)**:
   - If database supports it, add `modified_by_user_id` and `modified_at` columns
   - Or create separate audit table for review modifications
   - Only implement if straightforward - per CONTEXT.md guidance

5. **Test re-reviewer identity**:
   - User A creates review
   - User B modifies review
   - Verify `review_user_id` still shows User A
   - Verify `approving_user_id` shows User B (if they approved)
  </action>
  <verify>
    - Disease rename creates entity with `is_active = 0` until approved
    - Old entity remains active until approval of new entity
    - Re-reviewer (original `review_user_id`) is preserved when review is modified
    - `approving_user_id` correctly tracks who approved
    - `make test-api` passes
  </verify>
  <done>
    - Disease renaming requires approval before taking effect (follows re-review pattern)
    - Re-reviewer identity is preserved when reviews are modified
    - Approval workflow uses existing patterns (no special notification system)
  </done>
</task>

</tasks>

<verification>
Overall phase checks for Plan 55-02:

1. **BUG-04 verified:**
   - Viewer user can access profile without logout
   - Contribution stats load correctly for Viewer role

2. **BUG-05 verified:**
   - Adding PMID during re-review preserves existing PMIDs
   - No accidental PMID deletion

3. **BUG-06 verified:**
   - Entities-over-time chart counts match database
   - Chart displays correctly for all time periods

4. **BUG-07 verified:**
   - Disease renaming goes through approval workflow
   - Old entity remains active until approval

5. **BUG-08 verified:**
   - Original re-reviewer identity preserved
   - Approving user tracked separately

6. **No regressions:**
   - `make test-api` passes
   - Existing curation workflows work correctly
</verification>

<success_criteria>
1. Viewer-status users can view their profile page without auto-logout (BUG-04)
2. Adding a new PMID during re-review preserves existing PMIDs - no accidental deletion (BUG-05)
3. Entities-over-time chart displays accurate counts matching database query (BUG-06)
4. Disease renaming triggers approval workflow - new entity pending until approved (BUG-07)
5. Re-reviewer identity preserved when reviews are modified (BUG-08)
6. All fixes follow existing codebase patterns
7. No regression in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/55-bug-fixes/55-02-SUMMARY.md`
</output>
