---
phase: 55-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/services/entity-service.R
  - api/endpoints/entity_endpoints.R
  - api/functions/legacy-wrappers.R
  - app/src/views/EntityFormView.vue
autonomous: true

must_haves:
  truths:
    - "EIF2AK2 entity (sysndd:4375) publication 33236446 update completes without error"
    - "Newly created entities (GAP43) appear in entity list immediately"
    - "MEF2C entity (sysndd:4512) updates save all fields correctly"
  artifacts:
    - path: "api/services/entity-service.R"
      provides: "Entity update/create logic with proper transaction handling"
      contains: "db_with_transaction"
    - path: "api/endpoints/entity_endpoints.R"
      provides: "Entity endpoint with diagnostic logging"
      contains: "logger::log_"
  key_links:
    - from: "api/endpoints/entity_endpoints.R"
      to: "api/services/entity-service.R"
      via: "entity_create function call"
      pattern: "entity_create\\(|post_db_entity\\("
    - from: "api/services/entity-service.R"
      to: "database"
      via: "db_execute_statement transaction"
      pattern: "db_with_transaction|db_execute_statement"
---

<objective>
Fix three entity update/creation bugs affecting EIF2AK2, GAP43, and MEF2C entities.

Purpose: These bugs prevent curators from updating entity publications and creating new entities, blocking curation workflow. EIF2AK2 (#122) and MEF2C (#114) fail on update; GAP43 (#115) is created but not visible in entity list.

Output: All three entity operations work correctly with proper transaction handling and reactive UI updates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-bug-fixes/55-CONTEXT.md
@.planning/phases/55-bug-fixes/55-RESEARCH.md

# Key source files to investigate
@api/services/entity-service.R
@api/endpoints/entity_endpoints.R
@api/functions/entity-repository.R
@api/functions/legacy-wrappers.R
@api/functions/db-helpers.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Debug and fix entity update failures (EIF2AK2, MEF2C)</name>
  <files>
    api/services/entity-service.R
    api/endpoints/entity_endpoints.R
    api/functions/legacy-wrappers.R
  </files>
  <action>
Investigate and fix EIF2AK2 (sysndd:4375) and MEF2C (sysndd:4512) entity update failures:

1. **Add diagnostic logging** to trace the update flow:
   - In `entity_endpoints.R` POST `/create` and `/rename` endpoints
   - Log input data, database responses, and any errors
   - Use `logger::log_info()` and `logger::log_error()` following existing patterns

2. **Investigate transaction handling** in entity update flow:
   - Check if `put_post_db_review()`, `put_post_db_pub_con()`, and related functions properly handle errors
   - Look for partial transaction commits that leave entity in inconsistent state
   - Ensure all operations in `/create` and update endpoints use `db_with_transaction()` for atomicity

3. **Check constraint violations**:
   - Look for foreign key or unique constraint violations
   - Check if publication_id values are valid before connecting
   - Verify entity quadruple uniqueness check works correctly

4. **Fix identified issues**:
   - Wrap multi-table operations in single transaction if not already
   - Add proper error handling with rollback on failure
   - Ensure error messages propagate to frontend

5. **Test with specific entity IDs**:
   - Query database directly for entity_id 4375 (EIF2AK2) and 4512 (MEF2C)
   - Verify is_active = 1 and review/status records exist
   - Test update operation via API and confirm success

Note: Use existing patterns from `db-helpers.R` - `db_with_transaction()`, `db_execute_statement()`, `db_execute_query()`.
  </action>
  <verify>
    - `curl -X GET "http://localhost:3000/api/entity/4375" -H "Authorization: Bearer $TOKEN"` returns entity data
    - Entity update via frontend completes without error (check browser network tab)
    - API logs show successful transaction completion (no rollback messages)
    - `make test-api` passes (no regression in existing tests)
  </verify>
  <done>
    - EIF2AK2 entity (sysndd:4375) publication update completes successfully
    - MEF2C entity (sysndd:4512) updates save all fields correctly
    - Diagnostic logging added for future debugging
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix GAP43 entity visibility bug</name>
  <files>
    api/services/entity-service.R
    api/endpoints/entity_endpoints.R
    api/functions/entity-repository.R
  </files>
  <action>
Investigate and fix GAP43 (#115) entity creation bug where entity is created but not visible in list:

1. **Debug the creation flow**:
   - Add logging to trace entity_create -> review_create -> status_create sequence
   - Check if all three tables receive records in correct order
   - Verify transaction completes fully (not partial commit)

2. **Check ndd_entity_view vs ndd_entity**:
   - Query database: `SELECT * FROM ndd_entity WHERE symbol = 'GAP43'`
   - Query view: `SELECT * FROM ndd_entity_view WHERE symbol = 'GAP43'`
   - Identify if entity exists in table but not in view (join issue)

3. **Verify is_active flag**:
   - Check if newly created entities have `is_active = 1`
   - Look for any code that might set `is_active = 0` during creation
   - Ensure entity is not accidentally deactivated

4. **Verify review and status records**:
   - Check if `ndd_entity_review` record exists with `is_primary = 1`
   - Check if `ndd_entity_status` record exists with `is_active = 1`
   - Missing records could cause entity to be filtered out of view

5. **Fix transaction atomicity**:
   - In `entity_endpoints.R` POST `/create`, ensure entity + review + status creation is atomic
   - If any step fails, all steps should rollback
   - Current code has multiple separate response checks - consolidate into single transaction

6. **Add reactive UI update**:
   - After successful entity creation, ensure response includes `entity_id`
   - Frontend should use this to add entity to list without full page refresh
   - Check `EntityFormView.vue` for proper emit/refresh pattern

GAP43 HGNC ID is likely 4140 - use this for testing.
  </action>
  <verify>
    - `SELECT * FROM ndd_entity_view WHERE symbol = 'GAP43'` returns the entity (or create a test entity)
    - Creating a new entity via frontend shows it immediately in entity list (no page refresh needed)
    - Database has matching records in ndd_entity, ndd_entity_review (is_primary=1), ndd_entity_status (is_active=1)
    - `make test-api` passes
  </verify>
  <done>
    - GAP43 (or any newly created entity) is visible in entity list immediately after creation
    - Entity creation uses atomic transaction (all-or-nothing)
    - Frontend receives entity_id and updates list reactively
  </done>
</task>

</tasks>

<verification>
Overall phase checks for Plan 55-01:

1. **EIF2AK2 fix verified:**
   - Entity sysndd:4375 can be loaded and updated without error
   - Publication 33236446 can be added/modified

2. **MEF2C fix verified:**
   - Entity sysndd:4512 saves all field changes correctly
   - No partial updates or silent failures

3. **GAP43 fix verified:**
   - New entities appear immediately in entity list
   - No orphaned records in database

4. **No regressions:**
   - `make test-api` passes
   - Existing entity CRUD operations work correctly
</verification>

<success_criteria>
1. EIF2AK2 entity (sysndd:4375) publication 33236446 update completes without error
2. Newly created entities (e.g., GAP43) appear in entity list immediately after creation
3. MEF2C entity (sysndd:4512) updates save all fields correctly
4. All entity operations use atomic transactions
5. Diagnostic logging added for future debugging
6. No regression in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/55-bug-fixes/55-01-SUMMARY.md`
</output>
