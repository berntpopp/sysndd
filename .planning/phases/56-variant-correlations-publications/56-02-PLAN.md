---
phase: 56-variant-correlations-publications
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/components/analyses/PublicationsNDDTable.vue
  - app/src/components/analyses/PublicationsNDDTimePlot.vue
  - app/src/components/analyses/PublicationsNDDStats.vue
autonomous: true

must_haves:
  truths:
    - "User can expand publication rows to see detailed metadata (title, abstract, authors)"
    - "Publications table shows cached data instantly when returning to view"
    - "User can select time aggregation (year/month/quarter) in TimePlot"
    - "User can toggle between count-per-period and cumulative view in TimePlot"
    - "Stats view displays metrics cards with publication counts and growth rate"
  artifacts:
    - path: "app/src/components/analyses/PublicationsNDDTable.vue"
      provides: "Enhanced table with row details and module-level caching"
      contains: "moduleLastApiParams"
    - path: "app/src/components/analyses/PublicationsNDDTimePlot.vue"
      provides: "Interactive time plot with aggregation options"
      contains: "timeAggregation"
    - path: "app/src/components/analyses/PublicationsNDDStats.vue"
      provides: "Stats view with metrics cards"
      contains: "metricsCards"
  key_links:
    - from: "PublicationsNDDTable.vue"
      to: "/api/publication"
      via: "axios fetch with caching"
      pattern: "moduleLastApiParams"
    - from: "PublicationsNDDTable.vue"
      to: "GenericTable"
      via: "fieldDetails prop"
      pattern: ":field-details=\"fields_details\""
    - from: "PublicationsNDDTimePlot.vue"
      to: "/api/statistics/publication_stats"
      via: "axios fetch"
      pattern: "publication_stats"
---

<objective>
Enhance Publications views to match Entities table patterns and improve visualization interactivity.

Purpose: The Publications table lacks features available in the Entities table (expandable row details, module-level caching, proper initialization guards). The TimePlot and Stats views need improved interactivity and visual presentation per user requirements.

Output: Publications table with expandable details, TimePlot with aggregation options and cumulative view, Stats view with metrics cards.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-variant-correlations-publications/56-CONTEXT.md
@.planning/phases/56-variant-correlations-publications/56-RESEARCH.md
@app/src/components/tables/TablesEntities.vue
@app/src/components/analyses/PublicationsNDDTable.vue
@app/src/components/analyses/PublicationsNDDTimePlot.vue
@app/src/components/analyses/PublicationsNDDStats.vue
@app/src/components/small/GenericTable.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add module-level caching infrastructure to PublicationsNDDTable</name>
  <files>app/src/components/analyses/PublicationsNDDTable.vue</files>
  <action>
Add module-level caching variables and debounced loading to prevent duplicate API calls. Reference TablesEntities.vue for the exact pattern.

1. **Add module-level caching variables** (before export default):
```javascript
// Module-level variables to track API calls across component remounts
let moduleLastApiParams = null;
let moduleApiCallInProgress = false;
let moduleLastApiCallTime = 0;
let moduleLastApiResponse = null;
```

2. **Add loadDataDebounceTimer** in data():
```javascript
data() {
  return {
    loadDataDebounceTimer: null,
    // ... existing fields
  };
}
```

3. **Add debounced loadData method** wrapping loadTableData:
```javascript
loadData() {
  if (this.loadDataDebounceTimer) {
    clearTimeout(this.loadDataDebounceTimer);
  }
  this.loadDataDebounceTimer = setTimeout(() => {
    this.loadDataDebounceTimer = null;
    this.loadTableData();
  }, 50);
},
```

4. **Add module-level caching** to loadTableData:
```javascript
async loadTableData() {
  const urlParam = `sort=${this.sort}&filter=${this.filter_string}&page_after=${this.currentItemID}&page_size=${this.perPage}`;
  const now = Date.now();

  // Prevent duplicate API calls using module-level tracking
  if (moduleLastApiParams === urlParam && now - moduleLastApiCallTime < 500) {
    if (moduleLastApiResponse) {
      this.applyApiResponse(moduleLastApiResponse);
      this.isBusy = false;
    }
    return;
  }

  if (moduleApiCallInProgress && moduleLastApiParams === urlParam) {
    return;
  }

  moduleLastApiParams = urlParam;
  moduleLastApiCallTime = now;
  moduleApiCallInProgress = true;
  this.isBusy = true;

  // ... existing fetch code, then at end:
  moduleApiCallInProgress = false;
  moduleLastApiResponse = response.data;
  this.applyApiResponse(response.data);
  this.isBusy = false;
},
```

5. **Extract applyApiResponse method** from loadTableData for reuse with cached data:
```javascript
applyApiResponse(responseData) {
  // Move the response processing logic here
  // This handles items assignment, pagination, totalRows, etc.
},
```

6. **Update filtered() calls** to use loadData() instead of loadTableData() directly.
  </action>
  <verify>
1. Run `cd app && npm run lint` - no linting errors
2. Run `cd app && npm run type-check` - no TypeScript errors
3. Manual: Open Network tab in DevTools, navigate to Publications table
4. Manual: Apply a filter, navigate away from Publications, then navigate back - verify only one new API call appears (cached params prevent duplicate)
5. Manual: Refresh page while on Publications table - verify single API call, no duplicates
  </verify>
  <done>
Module-level caching infrastructure prevents duplicate API calls on component remount and rapid filter changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add initialization guards and lifecycle to PublicationsNDDTable</name>
  <files>app/src/components/analyses/PublicationsNDDTable.vue</files>
  <action>
Add initialization guards to prevent watchers from firing during component setup. Reference TablesEntities.vue for the exact pattern.

1. **Add isInitializing flag** in data():
```javascript
data() {
  return {
    isInitializing: true,
    // ... existing fields
  };
}
```

2. **Guard watchers** with isInitializing flag:
```javascript
watch: {
  filter: {
    handler() {
      if (this.isInitializing) return;
      this.filtered();
    },
    deep: true,
  },
  sortBy: {
    handler(newVal) {
      if (this.isInitializing) return;
      // ... existing sort handling
    },
    deep: true,
  },
},
```

3. **Update mounted()** to use $nextTick pattern for proper initialization:
```javascript
mounted() {
  // Initialize sorting from input
  const sortObject = this.sortStringToVariables(this.sortInput);
  this.sortBy = sortObject.sortBy;
  this.sort = this.sortInput;

  this.$nextTick(() => {
    if (this.filterInput && this.filterInput !== 'null') {
      this.filter = this.filterStrToObj(this.filterInput, this.filter);
      this.filter_string = this.filterInput;
    }
    this.loadTableData();
    this.$nextTick(() => {
      this.isInitializing = false;
    });
  });

  setTimeout(() => {
    this.loading = false;
  }, 500);
},
```
  </action>
  <verify>
1. Run `cd app && npm run lint` - no linting errors
2. Run `cd app && npm run type-check` - no TypeScript errors
3. Manual: Navigate to Publications table with filter params in URL - verify filter applied correctly without extra API calls
4. Manual: Check console for any "watcher fired during initialization" warnings - should be none
  </verify>
  <done>
Initialization guards prevent watchers from triggering during mount, eliminating race conditions and duplicate calls during setup.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add expandable row details and PMID links to PublicationsNDDTable</name>
  <files>app/src/components/analyses/PublicationsNDDTable.vue</files>
  <action>
Add expandable row details and external PubMed links. Verify GenericTable supports row expansion via field-details prop.

1. **Verify GenericTable support**: Check that GenericTable.vue accepts :field-details prop and renders expansion UI. The component should have a "details" slot or built-in expansion handling.

2. **Add fields_details array** in data() for expandable row details:
```javascript
fields_details: [
  { key: 'Abstract', label: 'Abstract', class: 'text-start' },
  { key: 'Lastname', label: 'Authors (Last names)', class: 'text-start' },
  { key: 'Firstname', label: 'Authors (First names)', class: 'text-start' },
  { key: 'Keywords', label: 'Keywords', class: 'text-start' },
],
```

3. **Add details column** to fields array:
```javascript
{
  key: 'details',
  label: 'Details',
},
```

4. **Pass field-details to GenericTable** in template:
```vue
<GenericTable
  ...existing props...
  :field-details="fields_details"
>
```

5. **Add PMID link** in template - update publication_id slot to link to PubMed:
```vue
<template #cell-publication_id="{ row }">
  <div>
    <a
      :href="`https://pubmed.ncbi.nlm.nih.gov/${row.publication_id}`"
      target="_blank"
      rel="noopener noreferrer"
    >
      <BBadge variant="primary" style="cursor: pointer">
        {{ row.publication_id }}
      </BBadge>
    </a>
  </div>
</template>
```
  </action>
  <verify>
1. Run `cd app && npm run lint` - no linting errors
2. Run `cd app && npm run type-check` - no TypeScript errors
3. Manual: Navigate to Publications table, click "Show" button on a row - detail view expands showing Abstract, Authors, Keywords
4. Manual: Click "Hide" button - detail view collapses
5. Manual: Click PMID badge - opens PubMed in new tab with correct publication
  </verify>
  <done>
Publications table has expandable row details with metadata (Abstract, Authors, Keywords) and PMID badges link to external PubMed pages.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add interactivity features to PublicationsNDDTimePlot</name>
  <files>app/src/components/analyses/PublicationsNDDTimePlot.vue</files>
  <action>
Enhance TimePlot with aggregation options and cumulative view toggle.

1. **Verify D3 time utilities are available**: Check existing D3 imports at top of file. If not already imported, ensure full D3 import:
```javascript
import * as d3 from 'd3';
// d3.rollups, d3.timeYear, d3.timeMonth are in d3-array and d3-time (included in full d3 package)
```

2. **Add new data properties**:
```javascript
data() {
  return {
    // ... existing properties
    timeAggregation: 'year', // 'year', 'month', 'quarter'
    timeAggregationOptions: [
      { value: 'year', text: 'Year' },
      { value: 'month', text: 'Month' },
      { value: 'quarter', text: 'Quarter' },
    ],
    showCumulative: false,
  };
}
```

3. **Add controls row** in template (after existing plotMode selector):
```vue
<BCol class="my-1" sm="4">
  <BInputGroup prepend="Aggregate" size="sm" class="mb-1">
    <BFormSelect
      v-model="timeAggregation"
      :options="timeAggregationOptions"
      :disabled="plotMode === 'type_counts'"
      @change="generateGraph"
    />
  </BInputGroup>
</BCol>

<BCol class="my-1" sm="4">
  <BFormCheckbox
    v-model="showCumulative"
    :disabled="plotMode === 'type_counts'"
    switch
    @change="generateGraph"
  >
    Cumulative View
  </BFormCheckbox>
</BCol>
```

4. **Add aggregation helper method**:
```javascript
aggregateData(dataArr, dateKey) {
  // Parse dates
  const parseDate = d3.timeParse('%Y-%m-%d');
  const data = dataArr.map((d) => ({
    dateVal: parseDate(d[dateKey]),
    count: d.count,
  }));

  // Aggregate based on timeAggregation setting
  let aggregated;
  if (this.timeAggregation === 'year') {
    aggregated = d3.rollups(
      data,
      (v) => d3.sum(v, (d) => d.count),
      (d) => d3.timeYear(d.dateVal)
    );
  } else if (this.timeAggregation === 'month') {
    aggregated = d3.rollups(
      data,
      (v) => d3.sum(v, (d) => d.count),
      (d) => d3.timeMonth(d.dateVal)
    );
  } else if (this.timeAggregation === 'quarter') {
    // Quarter = floor to nearest 3 months
    aggregated = d3.rollups(
      data,
      (v) => d3.sum(v, (d) => d.count),
      (d) => {
        const month = d.dateVal.getMonth();
        const quarterMonth = Math.floor(month / 3) * 3;
        return new Date(d.dateVal.getFullYear(), quarterMonth, 1);
      }
    );
  }

  // Sort by date and convert back to array format
  const sorted = aggregated
    .map(([dateVal, count]) => ({ dateVal, count }))
    .sort((a, b) => a.dateVal - b.dateVal);

  // Apply cumulative if enabled
  if (this.showCumulative) {
    let cumulative = 0;
    return sorted.map((d) => {
      cumulative += d.count;
      return { ...d, count: cumulative };
    });
  }

  return sorted;
},
```

5. **Update generateLinePlot** to use aggregation:
```javascript
generateLinePlot(dataArr, dateKey) {
  // Remove old SVG and tooltips
  d3.select('#pubs_dataviz').select('svg').remove();
  d3.select('#pubs_dataviz').selectAll('.tooltip').remove();

  // ... existing setup code ...

  // Use aggregated data
  const data = this.aggregateData(dataArr, dateKey);

  // ... rest of existing chart code using data array
}
```

6. **Add tooltip cleanup** at start of generateBarPlot as well:
```javascript
generateBarPlot(countArr) {
  d3.select('#pubs_dataviz').select('svg').remove();
  d3.select('#pubs_dataviz').selectAll('.tooltip').remove();
  // ... rest of code
}
```

7. **Improve tooltip styling** (update existing tooltip code):
```javascript
const tooltip = d3.select('#pubs_dataviz')
  .append('div')
  .attr('class', 'tooltip')
  .style('opacity', 0)
  .style('background-color', 'white')
  .style('border', 'solid 1px #ccc')
  .style('border-radius', '5px')
  .style('padding', '8px')
  .style('position', 'absolute')
  .style('pointer-events', 'none')
  .style('font-size', '0.85rem')
  .style('box-shadow', '0 2px 4px rgba(0,0,0,0.1)');
```

8. **Update tooltip content** to show aggregation level:
```javascript
const formatDate = this.timeAggregation === 'year'
  ? d3.timeFormat('%Y')
  : this.timeAggregation === 'quarter'
    ? (d) => `Q${Math.floor(d.getMonth() / 3) + 1} ${d.getFullYear()}`
    : d3.timeFormat('%b %Y');

// In mousemove handler:
tooltip.html(
  `<strong>${formatDate(d.dateVal)}</strong><br/>` +
  `${this.showCumulative ? 'Total' : 'Count'}: <strong>${d.count}</strong>`
);
```
  </action>
  <verify>
1. Run `cd app && npm run lint` - no linting errors
2. Run `cd app && npm run type-check` - no TypeScript errors
3. Verify D3 time utilities are properly imported (check import statement at top of file)
4. Manual: Navigate to Publications TimePlot, select "Year" aggregation - chart updates to show yearly totals
5. Manual: Toggle "Cumulative View" on - chart shows running total line
6. Manual: Select "Quarter" aggregation - chart shows quarterly data points
7. Manual: Select "Publication Type (Bar)" mode - aggregation controls are disabled
8. Manual: Toggle aggregation options rapidly - verify only one tooltip visible at a time (no duplicates)
  </verify>
  <done>
TimePlot has time aggregation selector (year/month/quarter) and cumulative view toggle. Controls are disabled when viewing bar chart mode. Tooltips show appropriate labels based on view mode. D3 time utilities properly imported.
  </done>
</task>

<task type="auto">
  <name>Task 5: Add metrics cards to PublicationsNDDStats</name>
  <files>app/src/components/analyses/PublicationsNDDStats.vue</files>
  <action>
Add summary metrics cards above the existing bar charts.

1. **Add computed properties** for metrics:
```javascript
computed: {
  metricsCards() {
    if (!this.statsData) return [];

    const pubDates = this.statsData.publication_date_aggregated || [];
    const currentYear = new Date().getFullYear();

    // Publications this year
    const thisYearPubs = pubDates
      .filter((d) => d.Publication_date && d.Publication_date.startsWith(String(currentYear)))
      .reduce((sum, d) => sum + d.count, 0);

    // Previous year for growth calculation
    const prevYearPubs = pubDates
      .filter((d) => d.Publication_date && d.Publication_date.startsWith(String(currentYear - 1)))
      .reduce((sum, d) => sum + d.count, 0);

    // Growth rate
    const growthRate = prevYearPubs > 0
      ? ((thisYearPubs - prevYearPubs) / prevYearPubs * 100).toFixed(1)
      : 'N/A';

    // Total publications
    const totalPubs = pubDates.reduce((sum, d) => sum + d.count, 0);

    // Newest publication date
    const newestDate = pubDates.length > 0
      ? pubDates
          .map((d) => d.Publication_date)
          .filter(Boolean)
          .sort()
          .reverse()[0] || 'N/A'
      : 'N/A';

    return [
      {
        title: 'Total Publications',
        value: totalPubs.toLocaleString(),
        icon: 'bi-journal-text',
        variant: 'primary',
      },
      {
        title: `Publications ${currentYear} (YTD)`,
        value: thisYearPubs.toLocaleString(),
        icon: 'bi-calendar-event',
        variant: 'success',
      },
      {
        title: 'YoY Growth',
        value: growthRate === 'N/A' ? growthRate : `${growthRate}%`,
        icon: growthRate !== 'N/A' && parseFloat(growthRate) >= 0 ? 'bi-graph-up-arrow' : 'bi-graph-down-arrow',
        variant: growthRate !== 'N/A' && parseFloat(growthRate) >= 0 ? 'success' : 'warning',
      },
      {
        title: 'Newest Publication',
        value: newestDate,
        icon: 'bi-clock-history',
        variant: 'info',
      },
    ];
  },
},
```

2. **Add metrics cards row** in template (before existing controls row):
```vue
<!-- Metrics Cards Row -->
<BRow v-if="!loadingCount && statsData" class="mb-3 px-2">
  <BCol v-for="(card, index) in metricsCards" :key="index" sm="6" md="3" class="mb-2">
    <BCard :border-variant="card.variant" class="h-100 text-center">
      <div class="d-flex flex-column align-items-center">
        <i :class="['bi', card.icon, 'fs-3', `text-${card.variant}`]" />
        <h6 class="mt-2 mb-1 text-muted">{{ card.title }}</h6>
        <h4 class="mb-0">{{ card.value }}</h4>
      </div>
    </BCard>
  </BCol>
</BRow>
```

3. **Improve chart visual consistency** - update bar fill color to match app theme:
```javascript
// In generateBarPlot, use consistent color scheme:
.attr('fill', (d, i) => d3.schemeTableau10[i % 10])
```

4. **Add loading state for metrics** - show skeleton while loading:
```vue
<!-- Loading skeleton for metrics -->
<BRow v-if="loadingCount" class="mb-3 px-2">
  <BCol v-for="n in 4" :key="n" sm="6" md="3" class="mb-2">
    <BCard class="h-100 text-center">
      <BSpinner small label="Loading..." />
    </BCard>
  </BCol>
</BRow>
```

5. **Add scoped styles** for metrics cards:
```css
/* Metrics card styling */
.metrics-card {
  transition: transform 0.2s ease;
}
.metrics-card:hover {
  transform: translateY(-2px);
}
```
  </action>
  <verify>
1. Run `cd app && npm run lint` - no linting errors
2. Run `cd app && npm run type-check` - no TypeScript errors
3. Manual: Navigate to Publications Stats view - 4 metrics cards visible above chart
4. Manual: Verify "Total Publications" shows correct count
5. Manual: Verify "Publications [current year] (YTD)" shows publications from current year with YTD label
6. Manual: Verify "YoY Growth" shows percentage change
7. Manual: While loading, skeleton cards appear instead of empty space
  </verify>
  <done>
Stats view displays metrics cards showing Total Publications, Publications this year (with YTD label for clarity), Year-over-Year growth rate, and Newest publication date. Cards use Bootstrap icons and color-coded variants.
  </done>
</task>

</tasks>

<verification>
## Automated Checks
```bash
cd app && npm run lint && npm run type-check
```

## Manual Verification

### Publications Table (PUB-01, PUB-02)
1. Navigate to Publications > SysNDD Curated tab
2. Verify "Show" button appears in Details column
3. Click "Show" - row expands showing Abstract, Authors, Keywords
4. Click "Hide" - row collapses
5. Refresh page - check Network tab for single API call (no duplicates)
6. Apply filter, navigate away, navigate back - verify cached data shows instantly with single API call
7. Click PMID badge - PubMed opens in new tab
8. Verify pagination still works
9. Verify column sorting still works
10. Verify search/filter still works

### TimePlot (PUB-03)
1. Navigate to Publications > Time Plot tab
2. Verify "Aggregate" dropdown visible (Year/Month/Quarter)
3. Verify "Cumulative View" toggle visible
4. Select "Year" - chart shows yearly aggregation
5. Select "Month" - chart shows monthly data points
6. Select "Quarter" - chart shows quarterly data points
7. Enable "Cumulative View" - line shows running total
8. Select "Publication Type (Bar)" - aggregation controls become disabled
9. Verify tooltips display correct information
10. Toggle aggregation rapidly - verify only one tooltip visible

### Stats View (PUB-04)
1. Navigate to Publications > Stats tab
2. Verify 4 metrics cards visible above chart
3. Verify "Total Publications" shows expected count
4. Verify "Publications [year] (YTD)" shows current year publications with YTD label
5. Verify "YoY Growth" shows percentage (positive or negative)
6. Verify "Newest Publication" shows a date
7. Verify existing bar charts still function correctly

## Regression Check
- All existing Publications features continue to work
- No console errors during navigation between tabs
- Export and copy link features unchanged
</verification>

<success_criteria>
1. PUB-01: Publications table has expandable row details, module-level caching, proper initialization guards
2. PUB-02: Row details show publication metadata (Abstract, Authors, Keywords); PMID links to PubMed
3. PUB-03: TimePlot has time aggregation selector and cumulative view toggle
4. PUB-04: Stats view displays metrics cards with publication counts and growth rate (YTD label on current year)
5. No new linting or TypeScript errors
6. All existing functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/56-variant-correlations-publications/56-02-SUMMARY.md`
</output>
