# Phase 56.1 Context: Admin Publication Bulk Management

**Phase:** 56.1 (inserted after Phase 56)
**Goal:** Administrators can refresh publication metadata from PubMed in bulk via ManageAnnotations

---

## Background

From investigation (docs/PUBLICATION_DATA_FLOW_INVESTIGATION.md - 2026-01-31):

### Current State
- Publications are added **only through manual curation** (no bulk management)
- **No admin endpoint exists** for refreshing publication metadata from PubMed
- System relies on legacy batch imports + runtime curation additions
- 4,547 publications in database, newest dated 2025-07-14

### How Publications Are Currently Added

**File:** `api/functions/publication-functions.R`

```r
new_publication(pmid, pool) â†’
  1. check_pmid(pmid) - validates PMID exists in PubMed
  2. info_from_pmid(pmid) - fetches metadata from PubMed API
  3. table_articles_from_xml() - parses XML response
  4. INSERT into publication table with update_date = NOW()
```

### Database Schema

**Table:** `publication`
| Column | Type | Description |
|--------|------|-------------|
| `publication_id` | VARCHAR(15) | Primary key, e.g., "PMID:12345678" |
| `publication_type` | VARCHAR(50) | "additional_references" or "gene_review" |
| `other_publication_id` | VARCHAR(250) | DOI or BookshelfID |
| `Title` | VARCHAR(1000) | Publication title |
| `Abstract` | TEXT | Publication abstract |
| `Publication_date` | TIMESTAMP | Actual publication date from PubMed |
| `update_date` | TIMESTAMP | When record was added/updated in SysNDD |
| `Journal` | VARCHAR(100) | Journal name |
| `Keywords` | TEXT | Semicolon-separated keywords |
| `Lastname`, `Firstname` | VARCHAR(50) | First author only |

---

## Key Files

| Component | File Path | Notes |
|-----------|-----------|-------|
| Publication Functions | `api/functions/publication-functions.R` | Has `info_from_pmid()`, `table_articles_from_xml()` |
| Admin Endpoints | `api/endpoints/admin_endpoints.R` | Where new endpoint should be added |
| ManageAnnotations | `app/src/views/admin/ManageAnnotations.vue` | Where UI should be added |
| Review Service | `api/services/review-service.R` | Has `svc_review_add_publications()` |

---

## API Design

### Proposed Endpoint

```
POST /api/admin/publications/refresh
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "pmids": ["PMID:12345678", "PMID:87654321"]
}
```

**Response:**
```json
{
  "total": 2,
  "success": 1,
  "failed": 1,
  "results": [
    { "pmid": "PMID:12345678", "status": "updated", "title": "..." },
    { "pmid": "PMID:87654321", "status": "error", "error": "PMID not found in PubMed" }
  ]
}
```

### Alternative: Bulk Refresh by Date

```
POST /api/admin/publications/refresh-outdated
{
  "older_than_days": 365
}
```

Refreshes all publications where `update_date` is older than N days.

---

## Rate Limiting

From [NCBI E-utilities best practices](https://www.ncbi.nlm.nih.gov/books/NBK25497/):

- Without API key: 3 requests/second
- With NCBI_API_KEY: 10 requests/second
- Recommendation: Add 350ms delay between requests (safe for no API key)

---

## UI Design (ManageAnnotations)

### New Tab: "Publications"

1. **Stats Row:**
   - Total publications count
   - Oldest update_date (most stale)
   - Count needing refresh (update_date > 1 year)

2. **Table:**
   - Columns: PMID, Title, Journal, Publication Date, Last Updated, Actions
   - Sortable by Last Updated (ascending = most stale first)
   - Filterable by date range
   - Checkbox selection for bulk operations

3. **Actions:**
   - "Refresh Selected" button - refreshes selected PMIDs
   - "Refresh Outdated" button - refreshes all with update_date > 1 year
   - Progress indicator during refresh

---

## Requirements

| ID | Requirement | Priority |
|----|-------------|----------|
| PUB-ADMIN-01 | Admin API endpoint to refresh publication metadata from PubMed | Must |
| PUB-ADMIN-02 | ManageAnnotations UI for bulk publication management | Must |
| PUB-ADMIN-03 | Progress feedback during bulk refresh operations | Must |

---

## Success Criteria

1. POST /api/admin/publications/refresh endpoint accepts list of PMIDs and refreshes metadata
2. ManageAnnotations has Publications tab showing all publications with selection
3. Admin can select publications and trigger bulk metadata refresh from PubMed
4. Progress indicator shows refresh status (X of Y completed)
5. Refresh errors are logged and displayed without blocking other publications

---

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| PubMed rate limiting | Add 350ms delay between requests; batch in chunks of 100 |
| Large refresh times | Show progress; allow cancellation; process async |
| Network failures | Retry logic (3 attempts); partial success handling |
| Stale data in production | Add "last refreshed" indicator to publication views |

---

## References

- [NCBI E-utilities Documentation](https://www.ncbi.nlm.nih.gov/books/NBK25497/)
- [PubMed API Getting Started](https://library.cumc.columbia.edu/kb/getting-started-pubmed-api)
- [NCBI API Rate Limits](https://www.ncbi.nlm.nih.gov/home/develop/api/)
- Existing pattern: `api/functions/publication-functions.R`
