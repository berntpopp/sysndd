---
phase: 56.1-admin-publication-bulk-management
plan: 02
type: execute
wave: 2
depends_on: ["56.1-01"]
files_modified:
  - app/src/views/admin/ManageAnnotations.vue
autonomous: false

must_haves:
  truths:
    - "Admin sees Publication Metadata Refresh section in ManageAnnotations"
    - "Section shows total publication count and oldest update date"
    - "Refresh All Publications button triggers API call"
    - "Progress bar shows real-time progress during refresh"
    - "Toast notification appears on completion or error"
  artifacts:
    - path: "app/src/views/admin/ManageAnnotations.vue"
      provides: "Publication refresh UI section"
      contains: "publicationStats"
  key_links:
    - from: "ManageAnnotations.vue"
      to: "/api/publications/stats"
      via: "axios.get for stats"
      pattern: "publications/stats"
    - from: "ManageAnnotations.vue"
      to: "/api/admin/publications/refresh"
      via: "axios.post for refresh"
      pattern: "admin/publications/refresh"
    - from: "ManageAnnotations.vue"
      to: "useAsyncJob"
      via: "composable import"
      pattern: "useAsyncJob"
---

<objective>
Add Publication Metadata Refresh UI to ManageAnnotations admin view.

Purpose: Provide administrators with a visual interface to refresh publication metadata from PubMed in bulk, with real-time progress feedback.

Output: New "Publication Metadata Refresh" section in ManageAnnotations.vue with stats display, refresh button, and progress tracking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase context
@.planning/phases/56.1-admin-publication-bulk-management/56.1-CONTEXT.md
@.planning/phases/56.1-admin-publication-bulk-management/56.1-RESEARCH.md
@.planning/phases/56.1-admin-publication-bulk-management/56.1-01-SUMMARY.md

# Implementation patterns (CRITICAL - follow exactly)
@app/src/views/admin/ManageAnnotations.vue (lines 231-387: Deprecated OMIM section pattern)
@app/src/composables/useAsyncJob.ts (complete composable)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Publication Metadata Refresh section</name>
  <files>app/src/views/admin/ManageAnnotations.vue</files>
  <action>
Add a new section to ManageAnnotations.vue following the "Deprecated OMIM Entities" pattern (lines 231-387).

**1. Add to script setup:**

```typescript
// Import useAsyncJob if not already imported
import { useAsyncJob } from '@/composables/useAsyncJob';

// Create job instance for publication refresh
const publicationRefreshJob = useAsyncJob(
  (jobId: string) => `${import.meta.env.VITE_API_URL}/api/jobs/${jobId}/status`
);

// Publication stats state
const publicationStats = ref({
  total: null as number | null,
  oldest_update: null as string | null,
  outdated_count: null as number | null,
});
const loadingPublicationStats = ref(false);
```

**2. Add fetch function:**

```typescript
async function fetchPublicationStats() {
  loadingPublicationStats.value = true;
  try {
    const response = await axios.get(
      `${import.meta.env.VITE_API_URL}/api/publications/stats`,
      {
        headers: {
          Authorization: `Bearer ${localStorage.getItem('token')}`,
        },
      }
    );
    publicationStats.value = {
      total: unwrapValue(response.data.total),
      oldest_update: unwrapValue(response.data.oldest_update),
      outdated_count: unwrapValue(response.data.outdated_count),
    };
  } catch (error) {
    console.warn('Failed to fetch publication stats:', error);
  } finally {
    loadingPublicationStats.value = false;
  }
}
```

Note: unwrapValue is already defined in ManageAnnotations.vue (check - if not, add it):
```typescript
function unwrapValue<T>(val: T | T[]): T {
  return Array.isArray(val) && val.length === 1 ? val[0] : (val as T);
}
```

**3. Add refresh function:**

```typescript
async function refreshAllPublications() {
  publicationRefreshJob.reset();

  try {
    // Get all publication PMIDs via simple query
    const pubResponse = await axios.get(
      `${import.meta.env.VITE_API_URL}/api/publications`,
      {
        headers: {
          Authorization: `Bearer ${localStorage.getItem('token')}`,
        },
      }
    );

    // Extract PMIDs - check if API returns array or object with data property
    const publications = Array.isArray(pubResponse.data)
      ? pubResponse.data
      : pubResponse.data?.data || [];

    const pmids = publications.map((p: { publication_id: string }) =>
      unwrapValue(p.publication_id)
    );

    if (pmids.length === 0) {
      makeToast('No publications to refresh', 'Info', 'info');
      return;
    }

    // Start refresh job
    const jobResponse = await axios.post(
      `${import.meta.env.VITE_API_URL}/api/admin/publications/refresh`,
      { pmids },
      {
        headers: {
          Authorization: `Bearer ${localStorage.getItem('token')}`,
        },
      }
    );

    if (jobResponse.data.error) {
      makeToast(
        jobResponse.data.message || 'Failed to start refresh',
        'Error',
        'danger'
      );
      return;
    }

    // Handle already running job
    if (jobResponse.data.status === 'already_running') {
      makeToast('A refresh job is already running', 'Info', 'info');
      publicationRefreshJob.startJob(jobResponse.data.job_id);
      return;
    }

    // Start tracking the new job
    publicationRefreshJob.startJob(jobResponse.data.job_id);
  } catch (error) {
    makeToast('Failed to start publication refresh', 'Error', 'danger');
    console.error('Publication refresh error:', error);
  }
}
```

**4. Add watch for job completion:**

```typescript
watch(
  () => publicationRefreshJob.status.value,
  (newStatus) => {
    if (newStatus === 'completed') {
      makeToast('Publications refreshed successfully', 'Success', 'success');
      fetchPublicationStats();  // Refresh stats
      fetchJobHistory();        // Update job history
    } else if (newStatus === 'failed') {
      const errorMsg = publicationRefreshJob.error.value || 'Publication refresh failed';
      makeToast(errorMsg, 'Error', 'danger');
      fetchJobHistory();
    }
  }
);
```

**5. Call fetchPublicationStats in onMounted:**

```typescript
onMounted(() => {
  // ... existing calls ...
  fetchPublicationStats();
});
```

**6. Add template section** (place BEFORE Deprecated OMIM Entities section):

```vue
<!-- Publication Metadata Refresh Section -->
<BRow class="justify-content-md-center py-2">
  <BCol col md="12">
    <BCard
      header-tag="header"
      body-class="p-2"
      header-class="p-1"
      border-variant="dark"
      class="mb-3 text-start"
    >
      <template #header>
        <h5 class="mb-0 text-start font-weight-bold d-flex align-items-center">
          Publication Metadata Refresh
          <span
            v-if="publicationStats.total !== null"
            class="badge bg-info ms-2 fw-normal"
          >
            {{ publicationStats.total?.toLocaleString() }} publications
          </span>
          <span
            v-if="publicationStats.oldest_update"
            class="badge bg-warning text-dark ms-2 fw-normal"
          >
            Oldest: {{ formatDate(publicationStats.oldest_update) }}
          </span>
          <span
            v-if="publicationStats.outdated_count && publicationStats.outdated_count > 0"
            class="badge bg-danger ms-2 fw-normal"
          >
            {{ publicationStats.outdated_count.toLocaleString() }} outdated
          </span>
        </h5>
      </template>

      <div class="mb-3">
        <p class="text-muted small mb-2">
          Refresh publication metadata from PubMed. Publications are updated in place
          (no deletions). Rate limited to ~3 requests/second to comply with NCBI limits.
        </p>
      </div>

      <!-- Action buttons -->
      <div class="d-flex gap-2 mb-3">
        <BButton
          variant="outline-secondary"
          size="sm"
          :disabled="loadingPublicationStats"
          @click="fetchPublicationStats"
        >
          <BSpinner v-if="loadingPublicationStats" small type="grow" class="me-1" />
          {{ loadingPublicationStats ? 'Loading...' : 'Refresh Stats' }}
        </BButton>
        <BButton
          variant="primary"
          :disabled="publicationRefreshJob.isLoading.value || publicationStats.total === null"
          @click="refreshAllPublications"
        >
          <BSpinner v-if="publicationRefreshJob.isLoading.value" small type="grow" class="me-2" />
          {{ publicationRefreshJob.isLoading.value ? 'Refreshing...' : 'Refresh All Publications' }}
        </BButton>
      </div>

      <!-- Progress display -->
      <div
        v-if="publicationRefreshJob.isLoading.value || publicationRefreshJob.status.value !== 'idle'"
        class="mt-3"
      >
        <div class="d-flex align-items-center mb-2">
          <span
            class="badge me-2"
            :class="publicationRefreshJob.statusBadgeClass.value"
          >
            {{ publicationRefreshJob.status.value }}
          </span>
          <span class="text-muted">{{ publicationRefreshJob.step.value }}</span>
        </div>

        <BProgress
          v-if="publicationRefreshJob.isLoading.value"
          :value="publicationRefreshJob.hasRealProgress.value ? publicationRefreshJob.progressPercent.value : 100"
          :max="100"
          :animated="true"
          :striped="!publicationRefreshJob.hasRealProgress.value"
          :variant="publicationRefreshJob.progressVariant.value"
          height="1.5rem"
        >
          <template #default>
            <span v-if="publicationRefreshJob.hasRealProgress.value">
              {{ publicationRefreshJob.progressPercent.value }}% -
              {{ publicationRefreshJob.step.value }}
            </span>
            <span v-else>
              {{ publicationRefreshJob.step.value }}
              ({{ publicationRefreshJob.elapsedTimeDisplay.value }})
            </span>
          </template>
        </BProgress>

        <div
          v-if="publicationRefreshJob.progress.value.current && publicationRefreshJob.progress.value.total"
          class="small text-muted mt-1"
        >
          {{ publicationRefreshJob.progress.value.current.toLocaleString() }} /
          {{ publicationRefreshJob.progress.value.total.toLocaleString() }}
          ({{ publicationRefreshJob.elapsedTimeDisplay.value }})
        </div>

        <!-- Show result summary on completion -->
        <BAlert
          v-if="publicationRefreshJob.status.value === 'completed'"
          variant="success"
          show
          class="mt-2 mb-0"
        >
          Refresh complete. Check job history for details.
        </BAlert>

        <BAlert
          v-if="publicationRefreshJob.status.value === 'failed'"
          variant="danger"
          show
          class="mt-2 mb-0"
        >
          {{ publicationRefreshJob.error.value || 'Refresh failed. Check job history for details.' }}
        </BAlert>
      </div>
    </BCard>
  </BCol>
</BRow>
```

**7. Add formatDate helper if not present:**

Check if formatDate exists in the component. If not, add:
```typescript
function formatDate(dateString: string | null): string {
  if (!dateString) return 'Unknown';
  return new Date(dateString).toLocaleDateString();
}
```
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/sysndd/app
npm run lint
npm run type-check
```
  </verify>
  <done>ManageAnnotations.vue has Publication Metadata Refresh section with stats and refresh button</done>
</task>

<task type="auto">
  <name>Task 2: Add publications list endpoint for PMID retrieval</name>
  <files>api/endpoints/publication_endpoints.R</files>
  <action>
The refresh function needs to get all PMIDs. Check if GET /publications endpoint exists.

If NOT exists, add to publication_endpoints.R:

```r
#* List all publications
#*
#* Returns list of all publications with optional field selection.
#*
#* # `Details`
#* Supports `fields` query parameter to limit returned columns.
#* Default returns all fields.
#*
#* # `Return`
#* JSON array of publication objects.
#*
#* @tag publication
#* @serializer json list(na="string")
#*
#* @param fields Comma-separated list of fields to return (optional)
#*
#* @response 200 OK. Returns publications.
#*
#* @get /
function(req, res, fields = NULL) {
  query <- pool %>%
    tbl("publication")

  # If specific fields requested, select only those
  if (!is.null(fields)) {
    field_list <- unlist(strsplit(fields, ","))
    field_list <- trimws(field_list)
    # Ensure publication_id is always included
    if (!"publication_id" %in% field_list) {
      field_list <- c("publication_id", field_list)
    }
    query <- query %>% select(any_of(field_list))
  }

  publications <- query %>%
    arrange(publication_id) %>%
    collect()

  publications
}
```

This endpoint allows the frontend to request just publication_id for efficiency:
`GET /api/publications?fields=publication_id`
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/sysndd/api
curl -s "http://localhost:3535/api/publications?fields=publication_id" | jq '.[0:3]'
# Should return: [{"publication_id": "PMID:..."}, ...]
```
  </verify>
  <done>GET /publications endpoint returns all publications with optional field filtering</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Publication Metadata Refresh section in ManageAnnotations admin view</what-built>
  <how-to-verify>
1. Start the development environment:
   ```bash
   cd /home/bernt-popp/development/sysndd && make dev
   ```

2. Log in as administrator at http://localhost:5173

3. Navigate to Admin Panel > Manage Annotations

4. Verify the "Publication Metadata Refresh" section appears:
   - Shows total publication count badge (e.g., "4,547 publications")
   - Shows oldest update date badge
   - Shows outdated count badge if any publications >1 year old
   - Has "Refresh Stats" button
   - Has "Refresh All Publications" button

5. Click "Refresh Stats" - stats badges should update

6. Click "Refresh All Publications":
   - Button should show loading spinner
   - Progress bar should appear
   - Progress should update in real-time (e.g., "Fetching PMID:12345 (1/4547)")
   - Status badge should show "running"

7. Wait for completion (or cancel early):
   - Success toast appears
   - Stats refresh automatically
   - Job appears in Job History table below

8. Check Job History table shows the publication_refresh job with status
  </how-to-verify>
  <resume-signal>Type "approved" if UI works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Frontend linting passes:
```bash
cd /home/bernt-popp/development/sysndd/app && npm run lint
```

2. TypeScript compilation passes:
```bash
cd /home/bernt-popp/development/sysndd/app && npm run type-check
```

3. Manual verification of UI functionality (checkpoint task)
</verification>

<success_criteria>
- [ ] ManageAnnotations.vue has Publication Metadata Refresh section
- [ ] Stats display shows total, oldest_update, outdated_count
- [ ] Refresh All Publications button triggers async job
- [ ] Progress bar shows real-time progress during refresh
- [ ] Job completion triggers toast and stats refresh
- [ ] Job History table shows publication_refresh jobs
- [ ] GET /publications endpoint supports field filtering
- [ ] Frontend lint and type-check pass
</success_criteria>

<output>
After completion, create `.planning/phases/56.1-admin-publication-bulk-management/56.1-02-SUMMARY.md`
</output>
