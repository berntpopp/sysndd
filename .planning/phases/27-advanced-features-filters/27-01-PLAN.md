---
phase: 27-advanced-features-filters
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/composables/useFilterSync.ts
  - app/src/composables/useWildcardSearch.ts
  - app/src/composables/useNetworkHighlight.ts
  - app/src/composables/index.ts
autonomous: true

must_haves:
  truths:
    - "useFilterSync syncs filter state with URL via VueUse useUrlSearchParams"
    - "useWildcardSearch converts PKD* patterns to regex for gene matching"
    - "useNetworkHighlight coordinates bidirectional hover between table and network"
    - "All composables exported from composables/index.ts"
  artifacts:
    - path: "app/src/composables/useFilterSync.ts"
      provides: "URL-synced filter state composable"
      exports: ["useFilterSync", "FilterState"]
      min_lines: 80
    - path: "app/src/composables/useWildcardSearch.ts"
      provides: "Wildcard pattern matching composable"
      exports: ["useWildcardSearch"]
      min_lines: 40
    - path: "app/src/composables/useNetworkHighlight.ts"
      provides: "Bidirectional highlighting composable"
      exports: ["useNetworkHighlight", "HighlightState"]
      min_lines: 60
  key_links:
    - from: "app/src/composables/useFilterSync.ts"
      to: "@vueuse/core"
      via: "useUrlSearchParams import"
      pattern: "useUrlSearchParams"
    - from: "app/src/composables/useWildcardSearch.ts"
      to: "RegExp"
      via: "pattern to regex conversion"
      pattern: "new RegExp"
---

<objective>
Create core composables for URL-synced filter state, wildcard search, and bidirectional highlighting

Purpose: Establish foundational composables that enable shared filter state across analysis views, biologist-friendly wildcard gene search (PKD*, BRCA?), and coordinated hover highlighting between network and table components

Output: Three composables (useFilterSync, useWildcardSearch, useNetworkHighlight) following established SysNDD patterns
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-advanced-features-filters/27-CONTEXT.md
@.planning/phases/27-advanced-features-filters/27-RESEARCH.md
@app/src/composables/useUrlParsing.ts
@app/src/composables/useTableData.ts
@app/src/composables/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useFilterSync composable</name>
  <files>app/src/composables/useFilterSync.ts</files>
  <action>
Create useFilterSync.ts composable that wraps VueUse's useUrlSearchParams for reactive URL-synced filter state.

Implementation (follow pattern from RESEARCH.md):
1. Import ref, computed, watch from vue
2. Import useUrlSearchParams from @vueuse/core
3. Define FilterState interface:
   - tab: 'clusters' | 'networks' | 'correlation'
   - search: string (wildcard gene search pattern)
   - fdr: number | null (FDR threshold)
   - category: string | null (GO, KEGG, MONDO)
   - cluster: number | null (selected cluster ID)

4. Export useFilterSync function that:
   - Calls useUrlSearchParams('history', { removeNullishValues: true, removeFalsyValues: false, write: true })
   - Creates computed filterState derived from URL params with type coercion
   - Provides setter functions: setTab, setSearch, setFdr, setCategory, setCluster
   - Provides clearAllFilters() that clears all except tab
   - Provides activeFilterCount computed (count of non-null filters)
   - Returns { filterState, activeFilterCount, setTab, setSearch, setFdr, setCategory, setCluster, clearAllFilters, rawParams }

5. Use module-level singleton pattern for shared state across components:
```typescript
// Module-level instance for singleton pattern
let filterSyncInstance: ReturnType<typeof createFilterSync> | null = null;

function createFilterSync() {
  // ... implementation ...
}

export function useFilterSync() {
  if (!filterSyncInstance) {
    filterSyncInstance = createFilterSync();
  }
  return filterSyncInstance;
}
```

Key considerations:
- removeNullishValues: true ensures empty filters don't clutter URL
- Tab defaults to 'clusters' if not in URL
- Parse FDR as float, cluster as integer
- Clear function preserves current tab
  </action>
  <verify>
TypeScript compiles: `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit src/composables/useFilterSync.ts`
  </verify>
  <done>useFilterSync composable syncs filter state with URL and provides reactive accessors</done>
</task>

<task type="auto">
  <name>Task 2: Create useWildcardSearch composable</name>
  <files>app/src/composables/useWildcardSearch.ts</files>
  <action>
Create useWildcardSearch.ts composable for converting biologist-friendly wildcard patterns to regex.

Implementation (follow pattern from RESEARCH.md):
1. Import ref, computed from vue
2. Accept optional initial pattern parameter

3. Export useWildcardSearch function that:
   - Maintains pattern ref (the user's input string)
   - Computes regex from pattern:
     - Escape special regex chars except * and ?
     - Replace * with .* (match any characters)
     - Replace ? with . (match single character)
     - Wrap in ^...$ for full match
     - Case-insensitive flag
   - Returns null regex if pattern is empty

4. Provide utility functions:
   - matches(geneSymbol: string): boolean - test single symbol
   - filterGenes(genes: Array<{ symbol: string }>): filtered array
   - cytoscapeFilter: computed function for Cytoscape.js node filtering
   - matchCount: computed number of matches (for use with TermSearch component)

5. Handle edge cases:
   - Empty pattern returns true for matches() (match all)
   - Invalid regex catches error and returns null

Example conversions:
- "PKD*" -> /^PKD.*$/i (matches PKD1, PKD2, PKDCC, etc.)
- "BRCA?" -> /^BRCA.$/i (matches BRCA1, BRCA2)
- "TP53" -> /^TP53$/i (exact match)

Code structure:
```typescript
export function useWildcardSearch(initialPattern = '') {
  const pattern = ref(initialPattern);

  const regex = computed(() => {
    if (!pattern.value) return null;

    try {
      const escaped = pattern.value
        .replace(/[.+^${}()|[\]\\]/g, '\\$&')
        .replace(/\*/g, '.*')
        .replace(/\?/g, '.');

      return new RegExp(`^${escaped}$`, 'i');
    } catch {
      return null;
    }
  });

  // ... rest of implementation
}
```
  </action>
  <verify>
TypeScript compiles: `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit src/composables/useWildcardSearch.ts`
  </verify>
  <done>useWildcardSearch composable converts wildcard patterns to regex for gene matching</done>
</task>

<task type="auto">
  <name>Task 3: Create useNetworkHighlight composable and update exports</name>
  <files>app/src/composables/useNetworkHighlight.ts, app/src/composables/index.ts</files>
  <action>
Part A: Create useNetworkHighlight.ts for bidirectional hover coordination.

Implementation (follow pattern from RESEARCH.md):
1. Import ref, watch, Ref from vue
2. Import Core, NodeSingular types from cytoscape

3. Define HighlightState interface:
   - hoveredNodeId: string | null (from network hover)
   - hoveredRowId: string | null (from table hover)
   - hoverSource: 'table' | 'network' | null (tracks who initiated)

4. Export useNetworkHighlight function that accepts:
   - cy: Ref<Core | null> (Cytoscape instance reference)

5. Implementation:
   - Maintain highlightState ref
   - setupNetworkListeners(): Attach cy.on('mouseover/mouseout', 'node') events
   - highlightNodeFromTable(nodeId: string | null): Programmatically highlight node
   - isRowHighlighted(rowId: string): Check if row should show highlight style
   - Clear function to reset all highlights

6. Critical: Prevent feedback loops (from RESEARCH.md pitfall):
   - Track hoverSource to know who initiated
   - Network events only update if source !== 'table'
   - Table events only update if source !== 'network'
   - Reset source on mouseout

7. CSS classes to apply:
   - 'hover-highlight' on hovered node
   - 'neighbor-highlight' on connected nodes
   - 'table-hover-highlight' when table initiates

Code structure for feedback loop prevention:
```typescript
const setupNetworkListeners = () => {
  if (!cy.value) return;

  cy.value.on('mouseover', 'node', (event) => {
    if (highlightState.value.hoverSource === 'table') return;
    highlightState.value.hoverSource = 'network';
    // ... apply highlights
  });

  cy.value.on('mouseout', 'node', () => {
    highlightState.value.hoverSource = null;
    // ... clear highlights
  });
};
```

Part B: Update app/src/composables/index.ts to export new composables:

Add exports:
```typescript
// Filter and search utilities
export { useFilterSync } from './useFilterSync';
export type { FilterState } from './useFilterSync';

// Wildcard search
export { useWildcardSearch } from './useWildcardSearch';

// Network highlighting
export { useNetworkHighlight } from './useNetworkHighlight';
export type { HighlightState } from './useNetworkHighlight';
```
  </action>
  <verify>
TypeScript compiles:
```bash
cd /home/bernt-popp/development/sysndd/app
npx tsc --noEmit src/composables/useNetworkHighlight.ts
npx tsc --noEmit src/composables/index.ts
```
  </verify>
  <done>useNetworkHighlight composable coordinates bidirectional highlighting, all composables exported</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run type-check` passes
2. VueUse installed: `npm list @vueuse/core` shows version
3. Singleton pattern: useFilterSync returns same instance across calls
4. Wildcard regex: "PKD*" matches "PKD1", "PKD2" but not "APKD"
5. Exports: Import test confirms all three composables accessible
</verification>

<success_criteria>
- useFilterSync provides reactive filter state synced with URL query parameters
- useWildcardSearch converts biologist patterns (PKD*, BRCA?) to working regex
- useNetworkHighlight coordinates hover without feedback loops via source tracking
- All composables follow existing SysNDD patterns (see useTableData.ts, useColorAndSymbols.ts)
- TypeScript compiles without errors
- Exports added to composables/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/27-advanced-features-filters/27-01-SUMMARY.md`
</output>
