---
phase: 27-advanced-features-filters
plan: 05
type: execute
wave: 3
depends_on: ["27-03"]
files_modified:
  - app/src/components/analyses/ColorLegend.vue
  - app/src/components/analyses/AnalysesPhenotypeCorrelogram.vue
  - app/src/components/analyses/AnalyseGeneClusters.vue
  - app/src/components/analyses/AnalysesPhenotypeClusters.vue
autonomous: true

must_haves:
  truths:
    - "Correlation heatmap has color legend showing -1 to +1 scale"
    - "Enhanced tooltips show correlation interpretation (strong positive, weak negative, etc.)"
    - "Download buttons (PNG/SVG) work on all visualizations"
    - "Loading states show progress indication"
    - "Error states include retry buttons"
  artifacts:
    - path: "app/src/components/analyses/ColorLegend.vue"
      provides: "Reusable color legend component"
      min_lines: 40
    - path: "app/src/components/analyses/AnalysesPhenotypeCorrelogram.vue"
      provides: "Correlogram with legend and enhanced tooltips"
      contains: "ColorLegend"
  key_links:
    - from: "app/src/components/analyses/AnalysesPhenotypeCorrelogram.vue"
      to: "app/src/components/analyses/ColorLegend.vue"
      via: "component import and usage"
      pattern: "ColorLegend"
---

<objective>
Add UI polish: color legends, enhanced tooltips, download buttons, loading/error states

Purpose: Complete UIUX-01 through UIUX-05 by adding professional UI polish to analysis visualizations including correlation legend, contextual tooltips, export functionality, and proper loading/error handling

Output: ColorLegend component and enhanced analysis views with complete UI polish
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-advanced-features-filters/27-CONTEXT.md
@.planning/phases/27-advanced-features-filters/27-RESEARCH.md
@.planning/phases/27-advanced-features-filters/27-03-SUMMARY.md
@app/src/components/analyses/AnalysesPhenotypeCorrelogram.vue
@app/src/components/analyses/AnalyseGeneClusters.vue
@app/src/components/small/DownloadImageButtons.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ColorLegend component</name>
  <files>app/src/components/analyses/ColorLegend.vue</files>
  <action>
Create reusable ColorLegend.vue component for visualization legends (UIUX-01).

Implementation:
1. Use script setup with TypeScript
2. Props:
   - min: number (default: -1)
   - max: number (default: 1)
   - colors: Array<string> (default: ['#000080', '#fff', '#B22222'] for blue-white-red)
   - labels: Array<{ value: number; text: string }> (optional custom labels)
   - title: string (optional, e.g., "Correlation Coefficient")
   - orientation: 'horizontal' | 'vertical' (default: 'horizontal')

3. Template:
   - Title (if provided)
   - Gradient bar using CSS linear-gradient
   - Labels at min, mid (0), max positions

4. Style:
   - Flexible sizing
   - Clean typography
   - Works in both orientations

Code structure:
```vue
<template>
  <div :class="['color-legend', `color-legend--${orientation}`]">
    <div v-if="title" class="color-legend__title">{{ title }}</div>
    <div class="color-legend__bar" :style="gradientStyle" />
    <div class="color-legend__labels">
      <span
        v-for="label in displayLabels"
        :key="label.value"
        class="color-legend__label"
        :style="labelStyle(label.value)"
      >
        {{ label.text }}
      </span>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed, CSSProperties } from 'vue';

interface LabelItem {
  value: number;
  text: string;
}

interface Props {
  min?: number;
  max?: number;
  colors?: string[];
  labels?: LabelItem[];
  title?: string;
  orientation?: 'horizontal' | 'vertical';
}

const props = withDefaults(defineProps<Props>(), {
  min: -1,
  max: 1,
  colors: () => ['#000080', '#fff', '#B22222'],
  labels: undefined,
  title: '',
  orientation: 'horizontal',
});

const gradientStyle = computed<CSSProperties>(() => {
  const direction = props.orientation === 'horizontal' ? 'to right' : 'to top';
  const gradient = `linear-gradient(${direction}, ${props.colors.join(', ')})`;
  return { background: gradient };
});

const displayLabels = computed<LabelItem[]>(() => {
  if (props.labels) return props.labels;
  // Default: min, mid, max
  const mid = (props.min + props.max) / 2;
  return [
    { value: props.min, text: String(props.min) },
    { value: mid, text: String(mid) },
    { value: props.max, text: String(props.max) },
  ];
});

const labelStyle = (value: number) => {
  const percent = ((value - props.min) / (props.max - props.min)) * 100;
  if (props.orientation === 'horizontal') {
    return { left: `${percent}%` };
  }
  return { bottom: `${percent}%` };
};
</script>

<style scoped>
.color-legend {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 0.75rem;
}

.color-legend--horizontal {
  width: 200px;
}

.color-legend--vertical {
  height: 200px;
  flex-direction: row;
}

.color-legend__title {
  font-weight: 600;
  margin-bottom: 2px;
}

.color-legend__bar {
  height: 12px;
  border-radius: 2px;
  border: 1px solid #ddd;
}

.color-legend--vertical .color-legend__bar {
  width: 12px;
  height: 100%;
}

.color-legend__labels {
  position: relative;
  display: flex;
  justify-content: space-between;
}

.color-legend__label {
  color: #666;
}
</style>
```
  </action>
  <verify>
File exists and TypeScript compiles:
```bash
ls -la /home/bernt-popp/development/sysndd/app/src/components/analyses/ColorLegend.vue
cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit
```
  </verify>
  <done>ColorLegend.vue provides reusable gradient legend for visualizations</done>
</task>

<task type="auto">
  <name>Task 2: Enhance correlation heatmap with legend and tooltips</name>
  <files>app/src/components/analyses/AnalysesPhenotypeCorrelogram.vue</files>
  <action>
Add ColorLegend and enhanced tooltips to correlation heatmap (UIUX-01, UIUX-02).

Part A: Add ColorLegend component
```vue
<template>
  <!-- After the matrix_dataviz div -->
  <div class="d-flex justify-content-center mt-2">
    <ColorLegend
      :min="-1"
      :max="1"
      :colors="['#000080', '#fff', '#B22222']"
      title="Correlation Coefficient (R)"
      :labels="[
        { value: -1, text: '-1 (negative)' },
        { value: 0, text: '0' },
        { value: 1, text: '+1 (positive)' }
      ]"
    />
  </div>
</template>

<script>
import ColorLegend from '@/components/analyses/ColorLegend.vue';

export default {
  components: {
    // ... existing
    ColorLegend,
  },
  // ...
}
</script>
```

Part B: Enhance tooltip with correlation interpretation
Update mousemove handler in generateMatrixGraph:
```javascript
const mousemove = function mousemove(event, d) {
  const interpretation = getCorrelationInterpretation(d.value);
  tooltip
    .html(`
      <strong>R: ${d.value.toFixed(3)}</strong><br>
      <em>${interpretation}</em><br>
      <small>${d.x} &amp; ${d.y}</small>
    `)
    .style('left', `${event.layerX + 20}px`)
    .style('top', `${event.layerY + 20}px`);
};
```

Add interpretation function:
```javascript
function getCorrelationInterpretation(r) {
  const absR = Math.abs(r);
  const direction = r >= 0 ? 'positive' : 'negative';

  if (absR >= 0.7) return `Strong ${direction} correlation`;
  if (absR >= 0.4) return `Moderate ${direction} correlation`;
  if (absR >= 0.2) return `Weak ${direction} correlation`;
  return 'No significant correlation';
}
```
  </action>
  <verify>
TypeScript compiles:
```bash
cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit
```
  </verify>
  <done>Correlation heatmap has color legend and enhanced tooltips (UIUX-01, UIUX-02)</done>
</task>

<task type="auto">
  <name>Task 3: Add loading states and error handling with retry</name>
  <files>app/src/components/analyses/AnalyseGeneClusters.vue, app/src/components/analyses/AnalysesPhenotypeClusters.vue, app/src/components/analyses/AnalysesPhenotypeCorrelogram.vue</files>
  <action>
Add consistent loading and error states with retry buttons (UIUX-04, UIUX-05).

AnalyseGeneClusters.vue already has good loading state with progress. Verify/enhance error handling.

For all three components, ensure:

1. Error state with retry:
```vue
<template>
  <!-- Add error state section -->
  <div v-if="error" class="error-state text-center p-4">
    <i class="bi bi-exclamation-triangle-fill text-danger fs-1 mb-3 d-block" />
    <p class="text-muted mb-3">{{ error }}</p>
    <BButton variant="primary" @click="retryLoad">
      <i class="bi bi-arrow-clockwise me-1" />
      Retry
    </BButton>
  </div>
</template>

<script>
data() {
  return {
    // ... existing
    error: null,
  };
},
methods: {
  async loadData() {
    this.error = null;
    this.loading = true;
    try {
      // ... existing load logic
    } catch (e) {
      this.error = e.message || 'Failed to load data. Please try again.';
      this.makeToast(e, 'Error', 'danger');
    } finally {
      this.loading = false;
    }
  },
  retryLoad() {
    this.loadData(); // or appropriate method name
  },
}
</script>

<style scoped>
.error-state {
  min-height: 200px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
</style>
```

2. Loading state enhancements (if not already present):
- Show spinner with descriptive text
- For long operations, show progress bar if available
- Disable controls during loading

For AnalysesPhenotypeClusters.vue:
- Add error ref
- Wrap loadClusterData in try/catch
- Add error display template
- Add retry button

For AnalysesPhenotypeCorrelogram.vue:
- Add error ref
- Wrap loadMatrixData in try/catch
- Add error display template
- Add retry button

Download buttons (UIUX-03) already exist via DownloadImageButtons component. Verify they work for all visualizations:
- AnalyseGeneClusters: gene_cluster_dataviz-svg
- AnalysesPhenotypeClusters: cluster_dataviz-svg
- AnalysesPhenotypeCorrelogram: matrix-svg
  </action>
  <verify>
TypeScript compiles:
```bash
cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit
```
  </verify>
  <done>All analysis views have loading states and error handling with retry (UIUX-04, UIUX-05)</done>
</task>

</tasks>

<verification>
1. Color legend shows under correlation heatmap (-1 blue to +1 red)
2. Tooltip shows correlation value + interpretation (Strong positive, Weak negative, etc.)
3. Error state displays when API fails (simulate with network throttle)
4. Retry button reloads data successfully
5. Download buttons work (PNG/SVG) for all visualizations
6. Loading states show appropriate feedback
</verification>

<success_criteria>
- UIUX-01: Color legend for correlation heatmap (-1 to +1 scale)
- UIUX-02: Enhanced tooltips with correlation interpretation
- UIUX-03: Download buttons (PNG/SVG) work (already exist, verify)
- UIUX-04: Loading states with progress indication
- UIUX-05: Error states with retry buttons
- ColorLegend reusable for future visualizations
- Consistent UX across all three analysis views
</success_criteria>

<output>
After completion, create `.planning/phases/27-advanced-features-filters/27-05-SUMMARY.md`
</output>
