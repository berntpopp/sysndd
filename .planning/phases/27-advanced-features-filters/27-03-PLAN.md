---
phase: 27-advanced-features-filters
plan: 03
type: execute
wave: 2
depends_on: ["27-01", "27-02"]
files_modified:
  - app/src/components/navigation/AnalysisTabs.vue
  - app/src/views/AnalysisView.vue
  - app/src/router/index.ts
  - app/src/components/analyses/AnalysesPhenotypeClusters.vue
  - app/src/components/analyses/AnalyseGeneClusters.vue
autonomous: true

must_haves:
  truths:
    - "Navigation tabs switch between Phenotype Clusters, Gene Networks, and Correlation views"
    - "Tab state persists in URL (?tab=clusters|networks|correlation)"
    - "Filter state shared across all analysis views"
    - "NAVL-07 bug fixed: no more filter=undefined in entity links"
  artifacts:
    - path: "app/src/components/navigation/AnalysisTabs.vue"
      provides: "Shared navigation component with filter badge"
      min_lines: 50
    - path: "app/src/views/AnalysisView.vue"
      provides: "Parent view orchestrating analysis tabs and shared state"
      min_lines: 80
  key_links:
    - from: "app/src/components/navigation/AnalysisTabs.vue"
      to: "app/src/composables/useFilterSync.ts"
      via: "composable import for shared state"
      pattern: "useFilterSync"
    - from: "app/src/views/AnalysisView.vue"
      to: "app/src/components/analyses/"
      via: "dynamic component rendering"
      pattern: "component.*:is"
---

<objective>
Create navigation tabs, analysis view orchestration, and fix entity link bug

Purpose: Implement NAVL-01 through NAVL-04 (navigation tabs, URL state, bookmarkable views) and NAVL-07 (filter=undefined bug fix), establishing the tabbed analysis interface with shared filter state

Output: AnalysisTabs navigation component, AnalysisView parent, router update, and bug fix
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-advanced-features-filters/27-CONTEXT.md
@.planning/phases/27-advanced-features-filters/27-RESEARCH.md
@.planning/phases/27-advanced-features-filters/27-01-SUMMARY.md
@.planning/phases/27-advanced-features-filters/27-02-SUMMARY.md
@app/src/router/index.ts
@app/src/components/analyses/AnalysesPhenotypeClusters.vue
@app/src/components/analyses/AnalyseGeneClusters.vue
@app/src/components/analyses/AnalysesPhenotypeCorrelogram.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AnalysisTabs navigation component</name>
  <files>app/src/components/navigation/AnalysisTabs.vue</files>
  <action>
Create navigation/ directory and AnalysisTabs.vue component for analysis view navigation.

First create directory:
```bash
mkdir -p /home/bernt-popp/development/sysndd/app/src/components/navigation
```

Implementation (follow RESEARCH.md Pattern 5):
1. Use script setup with TypeScript
2. Import useFilterSync from composables
3. Use BNav (NOT BTabs) for URL-changing navigation per accessibility guidelines

4. Template structure:
   - BNav with tabs class
   - Three BNavItem components for views
   - Filter status badge showing activeFilterCount
   - Clear button when filters active

5. Tab configuration:
```typescript
const tabs = [
  { id: 'clusters', label: 'Phenotype Clusters', icon: 'bi bi-diagram-3' },
  { id: 'networks', label: 'Gene Networks', icon: 'bi bi-share' },
  { id: 'correlation', label: 'Correlation', icon: 'bi bi-grid-3x3' },
];
```

6. Logic:
   - Get filterState, activeFilterCount, setTab, clearAllFilters from useFilterSync()
   - Compute activeTab from filterState.value.tab
   - setActiveTab calls setTab on click

Code structure:
```vue
<template>
  <BNav tabs class="mb-3">
    <BNavItem
      v-for="tab in tabs"
      :key="tab.id"
      :active="activeTab === tab.id"
      @click="setActiveTab(tab.id)"
    >
      <i :class="tab.icon" class="me-1" />
      {{ tab.label }}
    </BNavItem>

    <BNavItem disabled class="ms-auto" v-if="activeFilterCount > 0">
      <BBadge variant="primary" pill>
        {{ activeFilterCount }} filters active
      </BBadge>
      <BButton
        size="sm"
        variant="link"
        class="p-0 ms-2"
        @click.stop="clearAllFilters"
      >
        Clear
      </BButton>
    </BNavItem>
  </BNav>
</template>
```
  </action>
  <verify>
Directory and file exist:
```bash
ls -la /home/bernt-popp/development/sysndd/app/src/components/navigation/AnalysisTabs.vue
```
TypeScript compiles: `cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit`
  </verify>
  <done>AnalysisTabs.vue provides horizontal navigation with filter badge</done>
</task>

<task type="auto">
  <name>Task 2: Create AnalysisView parent and update router</name>
  <files>app/src/views/AnalysisView.vue, app/src/router/index.ts</files>
  <action>
Part A: Create AnalysisView.vue as parent orchestrator for analysis tabs.

Implementation:
1. Use script setup with TypeScript
2. Import useFilterSync for shared state
3. Import analysis components and AnalysisTabs
4. Use dynamic component (:is) to render active view based on filterState.tab

Template structure:
```vue
<template>
  <div class="analysis-view">
    <AnalysisTabs />

    <component
      :is="currentComponent"
      :filter-state="filterState"
      @cluster-selected="handleClusterSelected"
    />
  </div>
</template>

<script setup lang="ts">
import { computed, defineAsyncComponent } from 'vue';
import { useFilterSync } from '@/composables';
import AnalysisTabs from '@/components/navigation/AnalysisTabs.vue';

// Lazy load analysis components
const AnalysesPhenotypeClusters = defineAsyncComponent(
  () => import('@/components/analyses/AnalysesPhenotypeClusters.vue')
);
const AnalyseGeneClusters = defineAsyncComponent(
  () => import('@/components/analyses/AnalyseGeneClusters.vue')
);
const AnalysesPhenotypeCorrelogram = defineAsyncComponent(
  () => import('@/components/analyses/AnalysesPhenotypeCorrelogram.vue')
);

const { filterState, setCluster } = useFilterSync();

const componentMap = {
  clusters: AnalysesPhenotypeClusters,
  networks: AnalyseGeneClusters,
  correlation: AnalysesPhenotypeCorrelogram,
};

const currentComponent = computed(() =>
  componentMap[filterState.value.tab] || AnalysesPhenotypeClusters
);

const handleClusterSelected = (clusterId: number) => {
  setCluster(clusterId);
};
</script>

<style scoped>
.analysis-view {
  padding: 1rem;
}
</style>
```

Part B: Update app/src/router/index.ts to add /analysis route.

Add new route:
```typescript
{
  path: '/analysis',
  name: 'Analysis',
  component: () => import('@/views/AnalysisView.vue'),
  meta: {
    title: 'Analysis',
    requiresAuth: false,
  },
},
```

Also update existing individual routes (/Analyses/PhenotypeClusters, /Analyses/GeneClusters, /Analyses/Correlogram) to redirect to /analysis with appropriate tab parameter if they currently exist.
  </action>
  <verify>
Files exist and TypeScript compiles:
```bash
ls -la /home/bernt-popp/development/sysndd/app/src/views/AnalysisView.vue
cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit
```
  </verify>
  <done>AnalysisView.vue orchestrates tab navigation, router updated with /analysis route</done>
</task>

<task type="auto">
  <name>Task 3: Fix NAVL-07 filter=undefined bug and add filter integration</name>
  <files>app/src/components/analyses/AnalysesPhenotypeClusters.vue, app/src/components/analyses/AnalyseGeneClusters.vue</files>
  <action>
Part A: Fix NAVL-07 in AnalysesPhenotypeClusters.vue (line 91).

Current buggy code:
```vue
<BLink :href="'/Entities/?filter=' + selectedCluster.hash_filter">
```

Fixed code:
```vue
<BLink
  :href="selectedCluster.hash_filter
    ? `/Entities/?filter=${selectedCluster.hash_filter}`
    : '/Entities/'"
>
```

Or use computed for cleaner template:
```typescript
const entitiesLink = computed(() => {
  const base = '/Entities/';
  if (selectedCluster.value?.hash_filter) {
    return `${base}?filter=${selectedCluster.value.hash_filter}`;
  }
  return base;
});
```

Part B: Fix same bug in AnalyseGeneClusters.vue (line 145).

Current:
```vue
<BLink :href="'/Entities/?filter=' + selectedCluster.hash_filter">
```

Apply same fix pattern.

Part C: Add optional filterState prop to both components for future integration.

In both components, add props section (or update if converting to script setup):
```typescript
props: {
  filterState: {
    type: Object,
    default: null,
  },
},
```

This allows AnalysisView to pass shared filter state down. Full integration with useFilterSync for bidirectional sync will happen in 27-04.
  </action>
  <verify>
Bug fixed - search for "filter=undefined" pattern:
```bash
grep -r "filter=' + " /home/bernt-popp/development/sysndd/app/src/components/analyses/ || echo "Bug fixed"
```
TypeScript compiles: `cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit`
  </verify>
  <done>NAVL-07 fixed: entity links no longer include filter=undefined</done>
</task>

</tasks>

<verification>
1. AnalysisTabs renders three tab links
2. Clicking tab updates URL: /analysis?tab=networks
3. Filter badge shows count and Clear button works
4. AnalysisView switches components based on tab
5. /analysis route accessible
6. Entity links no longer include filter=undefined
7. Refreshing page with tab URL restores correct view
</verification>

<success_criteria>
- NAVL-01: Horizontal tabs connect all analysis pages
- NAVL-03: Tab state in URL (?tab=clusters|networks|correlation)
- NAVL-04: Bookmarkable views - sharing /analysis?tab=networks&search=PKD* works
- NAVL-07: Entity links conditional - no more filter=undefined
- BNav used (not BTabs) for proper URL navigation per accessibility
- Lazy loading for analysis components
- Filter badge shows active filter count with clear button
</success_criteria>

<output>
After completion, create `.planning/phases/27-advanced-features-filters/27-03-SUMMARY.md`
</output>
