---
phase: 27-advanced-features-filters
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/components/analyses/AnalyseGeneClusters.vue
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Data tables provide dropdown categorical filters for category column"
    - "Data tables provide numeric range filters (FDR < 0.05) for FDR column"
    - "Filter components are wired and functional in AnalyseGeneClusters"
  artifacts:
    - path: "app/src/components/analyses/AnalyseGeneClusters.vue"
      provides: "Integrated CategoryFilter and ScoreSlider components"
      issue_to_fix: "Uses basic text inputs instead of specialized filter components"
    - path: "app/src/components/filters/CategoryFilter.vue"
      provides: "Dropdown filter component (already exists, 44 lines)"
    - path: "app/src/components/filters/ScoreSlider.vue"
      provides: "FDR threshold filter component (already exists, 100 lines)"
  key_links:
    - from: "AnalyseGeneClusters.vue"
      to: "CategoryFilter.vue"
      via: "import and v-model binding"
      pattern: "CategoryFilter.*v-model"
    - from: "AnalyseGeneClusters.vue"
      to: "ScoreSlider.vue"
      via: "import and v-model binding"
      pattern: "ScoreSlider.*v-model"
---

<objective>
Integrate CategoryFilter and ScoreSlider into AnalyseGeneClusters table

Purpose: The filter components were created in plan 27-02 but are orphaned - not imported or used. This closes FILT-06 and FILT-07 requirements by wiring them into the analysis table.
Output: Working category dropdown and FDR threshold filters in gene cluster analysis
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-advanced-features-filters/27-02-SUMMARY.md

# Component sources
@app/src/components/filters/CategoryFilter.vue
@app/src/components/filters/ScoreSlider.vue
@app/src/components/analyses/AnalyseGeneClusters.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Import filter components</name>
  <files>app/src/components/analyses/AnalyseGeneClusters.vue</files>
  <action>
    Add imports for CategoryFilter and ScoreSlider components.

    In the script section, add to imports (around line 310):
    ```javascript
    // Import filter components
    import TermSearch from '@/components/filters/TermSearch.vue';
    import CategoryFilter from '@/components/filters/CategoryFilter.vue';
    import ScoreSlider from '@/components/filters/ScoreSlider.vue';
    ```

    Register in components object (around line 324):
    ```javascript
    components: {
      GenericTable,
      TablePaginationControls,
      TermSearch,
      CategoryFilter,
      ScoreSlider,
      NetworkVisualization,
      Splitpanes,
      Pane,
    },
    ```
  </action>
  <verify>No import errors: `cd /home/bernt-popp/development/sysndd/app && npm run build 2>&1 | grep -i error`</verify>
  <done>CategoryFilter and ScoreSlider imported and registered</done>
</task>

<task type="auto">
  <name>Task 2: Add filter state for category and FDR</name>
  <files>app/src/components/analyses/AnalyseGeneClusters.vue</files>
  <action>
    Add reactive state for the new filter controls.

    In data() section, add new filter state (after existing filter object around line 391):
    ```javascript
    // Specialized filter values (separate from text filter object)
    categoryFilter: null, // Selected category (GO, KEGG, MONDO, or null for all)
    fdrThreshold: null,   // FDR threshold (0.01, 0.05, 0.1, or custom value)
    ```

    Add computed property for category options (derived from valueCategories):
    ```javascript
    computed: {
      // ... existing computed properties ...

      /**
       * Category options for CategoryFilter dropdown
       * Derived from valueCategories loaded from API
       */
      categoryOptions() {
        if (!this.valueCategories || this.valueCategories.length === 0) {
          return [
            { value: 'GO', text: 'GO (Gene Ontology)' },
            { value: 'KEGG', text: 'KEGG (Pathways)' },
            { value: 'MONDO', text: 'MONDO (Disease)' },
          ];
        }
        return this.valueCategories.map(cat => ({
          value: cat.value,
          text: cat.text,
        }));
      },
    }
    ```
  </action>
  <verify>Component renders without errors</verify>
  <done>Filter state and options configured</done>
</task>

<task type="auto">
  <name>Task 3: Replace text filters with specialized components in template</name>
  <files>app/src/components/analyses/AnalyseGeneClusters.vue</files>
  <action>
    Update the filter-controls slot in the template to use CategoryFilter and ScoreSlider.

    Replace the generic BFormInput filters in the filter-controls slot (around line 154-167) with conditional specialized components:

    ```html
    <!-- Optional column-level filters -->
    <template v-slot:filter-controls>
      <td
        v-for="field in fieldsComputed"
        :key="field.key"
      >
        <!-- Cluster number: keep text filter -->
        <BFormInput
          v-if="field.key === 'cluster_num'"
          v-model="filter[field.key].content"
          :placeholder="'Filter ' + field.label"
          debounce="500"
          @input="onFilterChange"
        />

        <!-- Category: use CategoryFilter dropdown -->
        <CategoryFilter
          v-else-if="field.key === 'category'"
          v-model="categoryFilter"
          :options="categoryOptions"
          placeholder="All categories"
          @update:modelValue="onFilterChange"
        />

        <!-- FDR: use ScoreSlider with presets -->
        <ScoreSlider
          v-else-if="field.key === 'fdr'"
          v-model="fdrThreshold"
          @update:modelValue="onFilterChange"
        />

        <!-- Other columns: text filter (symbol, STRING_id, description, etc.) -->
        <BFormInput
          v-else-if="field.key !== 'details' && field.key !== 'number_of_genes'"
          v-model="filter[field.key].content"
          :placeholder="'Filter ' + field.label"
          debounce="500"
          @input="onFilterChange"
        />
      </td>
    </template>
    ```
  </action>
  <verify>Template compiles without errors</verify>
  <done>Specialized filter components in template</done>
</task>

<task type="auto">
  <name>Task 4: Update applyFilters to use new filter values</name>
  <files>app/src/components/analyses/AnalyseGeneClusters.vue</files>
  <action>
    Modify the applyFilters method to incorporate categoryFilter and fdrThreshold.

    Update applyFilters (around line 857-895) to include:

    ```javascript
    applyFilters(items) {
      const anyVal = (this.filter.any.content || '').toLowerCase();

      // Sync wildcard pattern from filterState
      const searchPattern = this.filterState?.search || '';
      if (searchPattern !== this.wildcardSearch.pattern.value) {
        this.wildcardSearch.pattern.value = searchPattern;
      }

      return items.filter((row) => {
        // 0) Wildcard gene search filter (for identifiers table)
        if (searchPattern && this.tableType === 'identifiers' && row.symbol) {
          if (!this.wildcardSearch.matches(row.symbol)) {
            return false;
          }
        }

        // 1) Category dropdown filter (for term_enrichment table)
        if (this.categoryFilter && this.tableType === 'term_enrichment') {
          if (row.category !== this.categoryFilter) {
            return false;
          }
        }

        // 2) FDR threshold filter (for term_enrichment table)
        if (this.fdrThreshold !== null && this.tableType === 'term_enrichment') {
          const fdrValue = parseFloat(row.fdr);
          if (isNaN(fdrValue) || fdrValue >= this.fdrThreshold) {
            return false;
          }
        }

        // 3) "any" filter
        if (anyVal) {
          const rowString = Object.values(row).join(' ').toLowerCase();
          if (!rowString.includes(anyVal)) {
            return false;
          }
        }

        // 4) column-specific text filters
        const filterKeys = Object.keys(this.filter).filter((k) => k !== 'any');
        let keep = true;
        filterKeys.forEach((fieldKey) => {
          const colVal = (this.filter[fieldKey].content || '').toLowerCase();
          if (colVal) {
            const rowVal = String(row[fieldKey] || '').toLowerCase();
            if (!rowVal.includes(colVal)) {
              keep = false;
            }
          }
        });
        return keep;
      });
    },
    ```

    Also add watchers for the new filter values to trigger re-filtering:

    ```javascript
    watch: {
      // ... existing watchers ...

      categoryFilter() {
        this.updateFilteredTotalRows();
        this.currentPage = 1;
      },
      fdrThreshold() {
        this.updateFilteredTotalRows();
        this.currentPage = 1;
      },
    },
    ```
  </action>
  <verify>Build succeeds: `cd /home/bernt-popp/development/sysndd/app && npm run build 2>&1 | head -20`</verify>
  <done>Filter logic incorporates category dropdown and FDR threshold</done>
</task>

</tasks>

<verification>
- CategoryFilter dropdown appears for category column in term_enrichment table
- ScoreSlider with presets (0.01, 0.05, 0.1) appears for FDR column
- Selecting "GO" filters to only GO terms
- Selecting "< 0.05" filters to FDR values below 0.05
- Filters can be combined (e.g., GO terms with FDR < 0.01)
- Clearing filters resets the table
</verification>

<success_criteria>
- FILT-06 (CategoryFilter) fully satisfied - dropdown works for category column
- FILT-07 (ScoreSlider) fully satisfied - FDR threshold filtering works
- Both filters integrate seamlessly with existing text filters
</success_criteria>

<output>
After completion, create `.planning/phases/27-advanced-features-filters/27-07-SUMMARY.md`
</output>
