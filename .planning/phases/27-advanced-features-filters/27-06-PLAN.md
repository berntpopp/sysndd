---
phase: 27-advanced-features-filters
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/components/tables/TablesEntities.vue
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can share Entities page links with filters and get same results"
    - "URL parameters (sort, filter, page_after, page_size) apply correctly on page load"
    - "copyLinkToClipboard produces working shareable URLs"
  artifacts:
    - path: "app/src/components/tables/TablesEntities.vue"
      provides: "URL parameter-driven filtering on load"
      issue_to_fix: "filterInput prop not correctly initializing filter object"
  key_links:
    - from: "views/tables/Entities.vue props"
      to: "TablesEntities.vue filter initialization"
      via: "filterInput prop -> filterStrToObj -> filter object"
      pattern: "filterStrToObj.*filterInput"
---

<objective>
Fix broken URL parameter API on Entities page (URGENT)

Purpose: URL parameter shareable links are broken on /Entities - users cannot share filtered views. This is a regression that breaks shareability compared to working Genes/Phenotypes tables.
Output: Working URL parameter handling that matches Genes/Phenotypes table behavior
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key reference files - compare working vs broken
@app/src/views/tables/Entities.vue
@app/src/components/tables/TablesEntities.vue
@app/src/views/tables/Genes.vue
@app/src/components/tables/TablesGenes.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Diagnose URL parameter handling issue</name>
  <files>app/src/components/tables/TablesEntities.vue</files>
  <action>
    Compare TablesEntities.vue with TablesGenes.vue to identify the URL parameter handling difference.

    Key areas to investigate:
    1. How filterInput prop is processed in mounted()
    2. Whether filterStrToObj is being called to parse the URL filter string
    3. Whether filter_string is being set before loadData()

    In TablesEntities.vue mounted() (lines 450-464), the code sets filter_string directly:
    ```javascript
    if (this.filterInput && this.filterInput !== 'null' && this.filterInput !== '') {
      this.filter_string = this.filterInput;
      this.loadData();
    }
    ```

    This BYPASSES the filter object initialization. The filter object stays empty, so:
    - Column filters don't show the applied values
    - The removeFiltersButtonVariant stays 'outline-secondary'
    - copyLinkToClipboard may generate incomplete URLs

    Document the specific issue found.
  </action>
  <verify>Issue identified (read-only investigation - no code changes in this task)</verify>
  <done>Root cause of URL parameter bug identified</done>
</task>

<task type="auto">
  <name>Task 2: Fix filter object initialization from URL</name>
  <files>app/src/components/tables/TablesEntities.vue</files>
  <action>
    Update the mounted() hook to properly initialize the filter object from filterInput.

    Current broken code (lines 450-459):
    ```javascript
    this.$nextTick(() => {
      if (this.filterInput && this.filterInput !== 'null' && this.filterInput !== '') {
        this.filter_string = this.filterInput;
        this.loadData();
      } else {
        this.loadData();
      }
    });
    ```

    Fix by using filterStrToObj to parse the URL filter string into the filter object:
    ```javascript
    this.$nextTick(() => {
      if (this.filterInput && this.filterInput !== 'null' && this.filterInput !== '') {
        // Parse URL filter string into filter object for proper UI state
        const parsedFilter = this.filterStrToObj(this.filterInput);
        // Merge parsed values into existing filter object (preserves structure)
        Object.keys(parsedFilter).forEach((key) => {
          if (this.filter[key]) {
            this.filter[key].content = parsedFilter[key].content;
          }
        });
        // Also set filter_string for API call
        this.filter_string = this.filterInput;
      }
      this.loadData();
    });
    ```

    This ensures:
    - Filter object has correct values for UI (column inputs show filters)
    - filter_string is set for API call
    - removeFilters button shows correct variant
    - copyLinkToClipboard generates complete URLs
  </action>
  <verify>Code compiles without errors: `cd /home/bernt-popp/development/sysndd/app && npm run build 2>&1 | head -20`</verify>
  <done>Filter object properly initialized from URL parameters</done>
</task>

<task type="auto">
  <name>Task 3: Test URL parameter functionality</name>
  <files>app/src/components/tables/TablesEntities.vue</files>
  <action>
    Create a manual test plan and verify the fix works:

    1. Open browser to http://localhost:5173/Entities
    2. Apply a filter (e.g., type "BRCA" in symbol column)
    3. Click "Copy Link" button
    4. Open a new tab and paste the URL
    5. Verify:
       - Table shows filtered results
       - Column filter input shows "BRCA"
       - "Remove Filters" button is active (not outline variant)

    Test URLs to verify work correctly:
    - /Entities?sort=+entity_id&filter=contains(symbol,BRCA)
    - /Entities?sort=-entity_id&filter=any(category,Definitive,Moderate)&page_size=20

    If tests pass, the fix is complete.

    Note: This is a manual verification task. The developer should test in browser.
  </action>
  <verify>Manual browser test confirms URL parameter handling works</verify>
  <done>URL shareable links work correctly on Entities page</done>
</task>

</tasks>

<verification>
- URL /Entities?filter=contains(symbol,BRCA) shows filtered results
- Column filter inputs display the applied filter values
- Remove Filters button has correct active styling when filters applied
- Copy Link button generates working shareable URLs
</verification>

<success_criteria>
- Entities page URL parameters work identically to Genes/Phenotypes pages
- Filter state persists correctly from URL on page load
- Shareable links are fully functional
</success_criteria>

<output>
After completion, create `.planning/phases/27-advanced-features-filters/27-06-SUMMARY.md`
</output>
