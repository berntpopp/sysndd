---
phase: 27-advanced-features-filters
plan: 09
type: execute
wave: 2
depends_on: ["10"]
files_modified:
  - api/endpoints/analysis_endpoints.R
  - app/src/components/analyses/AnalysesPhenotypeCorrelogram.vue
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Clicking a cell in correlation heatmap navigates to cluster view"
    - "Backend correlation API returns cluster_id for each phenotype pair"
    - "D3 click handler calls setCluster and setTab to navigate"
  artifacts:
    - path: "api/endpoints/analysis_endpoints.R"
      provides: "correlation endpoint with cluster_id in response"
      issue_to_fix: "cluster_id not included in correlation data"
    - path: "app/src/components/analyses/AnalysesPhenotypeCorrelogram.vue"
      provides: "D3 click navigation to cluster view"
      issue_to_fix: "setTab/setCluster imported but not called"
  key_links:
    - from: "AnalysesPhenotypeCorrelogram.vue D3 click"
      to: "useFilterSync setCluster/setTab"
      via: "click handler calling composable methods"
      pattern: "setCluster.*setTab"
---

<objective>
Add cluster navigation from correlation heatmap cells

Purpose: Enable clicking a cell in the correlation heatmap to navigate to the corresponding phenotype cluster view. This requires both backend API enhancement (add cluster_id to correlation response) and frontend wiring (D3 click handler).
Output: Working click-to-navigate from correlation matrix to cluster analysis
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-advanced-features-filters/27-01-SUMMARY.md

# Backend endpoint
@api/endpoints/analysis_endpoints.R

# Frontend component
@app/src/components/analyses/AnalysesPhenotypeCorrelogram.vue
@app/src/composables/useFilterSync.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze correlation endpoint and cluster relationship</name>
  <files>api/endpoints/analysis_endpoints.R</files>
  <action>
    Examine the phenotype correlation endpoint to understand the data structure and how to add cluster_id.

    Find the /api/phenotype/correlation endpoint in analysis_endpoints.R.

    The correlation data likely comes from a matrix of phenotype pairs with correlation coefficients.
    Each phenotype (x, y) pair needs to map to a cluster_id.

    Options for adding cluster_id:
    1. If phenotypes are already clustered, join cluster assignment to correlation data
    2. If clustering is separate, need to cross-reference phenotype -> cluster mapping
    3. May need to call phenotype_clustering endpoint logic to get cluster assignments

    Document the approach needed. The cluster mapping might come from:
    - phenotype_clustering endpoint's cluster assignments
    - A separate cluster assignment table/function
    - Computing on-the-fly from phenotype data

    NOTE: This is an investigation task. Document findings before implementing.
  </action>
  <verify>Approach documented for adding cluster_id to correlation response</verify>
  <done>Backend enhancement approach identified</done>
</task>

<task type="auto">
  <name>Task 2: Add cluster_id to correlation API response</name>
  <files>api/endpoints/analysis_endpoints.R</files>
  <action>
    Modify the /api/phenotype/correlation endpoint to include cluster_id for each correlation cell.

    The implementation depends on Task 1 findings. Expected approaches:

    Option A - If cluster assignments exist in database:
    ```r
    # In the correlation endpoint handler
    # After computing correlation matrix, join cluster info
    correlation_data <- correlation_data %>%
      left_join(cluster_assignments, by = c("x_id" = "phenotype_id")) %>%
      rename(x_cluster_id = cluster_id) %>%
      left_join(cluster_assignments, by = c("y_id" = "phenotype_id")) %>%
      rename(y_cluster_id = cluster_id)
    ```

    Option B - If need to compute clusters:
    ```r
    # Get cluster assignments from phenotype_clustering logic
    cluster_data <- get_phenotype_cluster_assignments()
    # Then join as above
    ```

    Option C - Simplify by using primary cluster (most common cluster for phenotype):
    ```r
    # Each phenotype maps to one primary cluster
    # Add cluster_id column to correlation response
    correlation_data$cluster_id <- get_primary_cluster(correlation_data$x_id)
    ```

    The key is that the frontend receives `cluster_id` in each correlation cell's data.

    IMPORTANT: If this requires significant backend refactoring or the cluster data isn't readily available, document this as a limitation and create a workaround (e.g., link to phenotype filter instead of cluster).
  </action>
  <verify>API returns cluster_id: `curl -s localhost:8000/api/phenotype/correlation | jq '.[0]' | grep -i cluster`</verify>
  <done>Backend correlation endpoint includes cluster_id</done>
</task>

<task type="auto">
  <name>Task 3: Wire D3 click handler to setCluster navigation</name>
  <files>app/src/components/analyses/AnalysesPhenotypeCorrelogram.vue</files>
  <action>
    Update the D3 click handler to call setCluster and setTab for navigation.

    Current state (around line 135):
    ```javascript
    const { setTab, setCluster } = useFilterSync();
    return { makeToast, setTab, setCluster };
    ```
    These are imported but not used.

    Current click behavior (around line 283):
    ```javascript
    .attr('xlink:href', (d) => `/Phenotypes/?sort=entity_id&filter=...`)
    ```
    This links to Phenotypes table, not cluster view.

    Replace with click handler that navigates to cluster view:

    1. Remove the `<a xlink:href>` wrapping the rects

    2. Add click event handler:
    ```javascript
    // In generateMatrixGraph method, after creating rects (around line 285-293)
    svg
      .selectAll()
      .data(data, (d) => `${d.x}:${d.y}`)
      .enter()
      .append('rect')  // Direct rect, no <a> wrapper
      .attr('x', (d) => x(d.x))
      .attr('y', (d) => y(d.y))
      .attr('width', x.bandwidth())
      .attr('height', y.bandwidth())
      .style('fill', (d) => myColor(d.value))
      .style('cursor', 'pointer')
      .on('mouseover', mouseover)
      .on('mousemove', mousemove)
      .on('mouseleave', mouseleave)
      .on('click', (event, d) => {
        // Navigate to cluster view if cluster_id available
        if (d.cluster_id) {
          this.setCluster(d.cluster_id);
          this.setTab('clusters');
          // Navigate to Analysis view
          this.$router.push('/Analysis?tab=clusters&cluster=' + d.cluster_id);
        } else {
          // Fallback: Navigate to phenotypes filtered table
          this.$router.push(`/Phenotypes/?sort=entity_id&filter=all(modifier_phenotype_id,${d.x_id},${d.y_id})&page_after=0&page_size=10`);
        }
      });
    ```

    3. Import router:
    ```javascript
    import { useRouter } from 'vue-router';

    // In setup():
    const router = useRouter();
    return { makeToast, setTab, setCluster, router };
    ```

    4. Update click handler to use this.router or this.$router in methods.

    NOTE: If backend cluster_id addition is blocked/deferred, implement graceful fallback to current phenotype link behavior with a comment noting future enhancement.
  </action>
  <verify>Click on correlation cell triggers navigation (or shows fallback behavior)</verify>
  <done>D3 click handler wired to cluster navigation</done>
</task>

</tasks>

<verification>
- If cluster_id available: Clicking correlation cell navigates to /Analysis?tab=clusters&cluster=N
- If cluster_id not available: Clicking correlation cell navigates to /Phenotypes with filter (fallback)
- Hover tooltips still work correctly
- No JavaScript errors on click
</verification>

<success_criteria>
- NAVL-02 (Heatmap click navigation) addressed
- Backend includes cluster_id in correlation data OR clear documentation of limitation
- Frontend handles both with-cluster and without-cluster scenarios gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/27-advanced-features-filters/27-09-SUMMARY.md`
</output>
