---
phase: 27-advanced-features-filters
plan: 08
type: execute
wave: 2
depends_on: []
files_modified:
  - app/src/components/analyses/AnalysesPhenotypeClusters.vue
  - app/src/composables/usePhenotypeCytoscape.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "PhenotypeClusters displays clusters as Cytoscape network with edges"
    - "Network shows relationships between clusters (not just isolated bubbles)"
    - "User can click cluster nodes to select and view cluster details"
    - "Network visualization is consistent with AnalyseGeneClusters style"
  artifacts:
    - path: "app/src/components/analyses/AnalysesPhenotypeClusters.vue"
      provides: "Cytoscape-based cluster visualization replacing D3 bubbles"
    - path: "app/src/composables/usePhenotypeCytoscape.ts"
      provides: "Simplified Cytoscape composable for phenotype clusters"
  key_links:
    - from: "AnalysesPhenotypeClusters.vue"
      to: "usePhenotypeCytoscape.ts"
      via: "composable import and initialization"
      pattern: "usePhenotypeCytoscape"
---

<objective>
Refactor PhenotypeClusters to use Cytoscape.js network visualization

Purpose: Replace the D3.js bubble chart in PhenotypeClusters with a Cytoscape.js network that shows relationships between phenotype clusters with edges. This provides visual consistency with the new AnalyseGeneClusters network.
Output: Interactive Cytoscape network for phenotype cluster visualization
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/26-network-visualization/26-02-SUMMARY.md

# Reference implementations
@app/src/composables/useCytoscape.ts
@app/src/components/analyses/AnalysesPhenotypeClusters.vue
@app/src/components/analyses/NetworkVisualization.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create simplified phenotype Cytoscape composable</name>
  <files>app/src/composables/usePhenotypeCytoscape.ts</files>
  <action>
    Create a simplified Cytoscape composable for phenotype clusters. This is a lighter version of useCytoscape.ts, without the compound node/cluster complexity.

    The phenotype cluster data has a simpler structure:
    - Each cluster has: cluster (id), cluster_size, quali_inp_var, quali_sup_var, quanti_sup_var
    - We need to show clusters as nodes with size proportional to cluster_size
    - Edges can represent correlation/similarity between clusters (if available in data) or just visual proximity

    Create `/home/bernt-popp/development/sysndd/app/src/composables/usePhenotypeCytoscape.ts`:

    ```typescript
    // composables/usePhenotypeCytoscape.ts
    /**
     * Simplified Cytoscape composable for phenotype cluster visualization
     * Shows clusters as nodes with optional edges for relationships
     */

    import { ref, onBeforeUnmount, type Ref } from 'vue';
    import cytoscape from 'cytoscape';
    import type { Core, ElementDefinition } from 'cytoscape';
    import fcose from 'cytoscape-fcose';
    import svg from 'cytoscape-svg';

    // Register extensions once
    const cytoscapeFn = cytoscape as any;
    cytoscapeFn.use(fcose);
    cytoscapeFn.use(svg);

    export interface PhenotypeCluster {
      cluster: string | number;
      cluster_size: number;
      hash_filter?: string;
    }

    export interface PhenotypeCytoscapeOptions {
      container: Ref<HTMLElement | null>;
      onClusterClick?: (clusterId: string | number) => void;
    }

    const CLUSTER_COLORS = [
      '#e41a1c', '#377eb8', '#4daf4a', '#984ea3',
      '#ff7f00', '#ffff33', '#a65628', '#f781bf',
    ];

    function getClusterColor(index: number): string {
      return CLUSTER_COLORS[index % CLUSTER_COLORS.length];
    }

    export function usePhenotypeCytoscape(options: PhenotypeCytoscapeOptions) {
      let cy: Core | null = null;
      const isInitialized = ref(false);
      const isLoading = ref(false);

      function initializeCytoscape() {
        if (!options.container.value) return;

        cy = cytoscape({
          container: options.container.value,
          style: [
            {
              selector: 'node',
              style: {
                width: 'data(size)',
                height: 'data(size)',
                'background-color': 'data(color)',
                'border-width': 2,
                'border-color': '#696969',
                label: 'data(label)',
                'font-size': '14px',
                'text-valign': 'center',
                'text-halign': 'center',
                color: '#fff',
                'text-outline-width': 2,
                'text-outline-color': 'data(color)',
              },
            },
            {
              selector: 'node:selected',
              style: {
                'border-width': 4,
                'border-color': '#000',
              },
            },
            {
              selector: 'edge',
              style: {
                'curve-style': 'bezier',
                width: 2,
                'line-color': '#ccc',
                opacity: 0.5,
              },
            },
          ],
          layout: { name: 'preset' }, // We'll position manually or use fcose
          minZoom: 0.3,
          maxZoom: 3,
          wheelSensitivity: 0.3,
        });

        // Click handler
        cy.on('tap', 'node', (evt) => {
          const node = evt.target;
          const clusterId = node.data('clusterId');
          if (options.onClusterClick) {
            options.onClusterClick(clusterId);
          }
        });

        isInitialized.value = true;
      }

      function updateElements(clusters: PhenotypeCluster[]) {
        if (!cy) return;
        isLoading.value = true;

        // Calculate size scale
        const sizes = clusters.map(c => c.cluster_size);
        const maxSize = Math.max(...sizes);
        const minSize = Math.min(...sizes);
        const sizeScale = (size: number) => {
          const normalized = (size - minSize) / (maxSize - minSize || 1);
          return 30 + normalized * 50; // 30-80px range
        };

        // Create node elements
        const elements: ElementDefinition[] = clusters.map((cluster, index) => ({
          data: {
            id: `cluster-${cluster.cluster}`,
            clusterId: cluster.cluster,
            label: `C${cluster.cluster}\n(${cluster.cluster_size})`,
            size: sizeScale(cluster.cluster_size),
            color: getClusterColor(index),
            clusterSize: cluster.cluster_size,
          },
        }));

        // Add edges between adjacent clusters (simple proximity-based)
        // This creates a visual structure showing cluster relationships
        for (let i = 0; i < clusters.length - 1; i++) {
          elements.push({
            data: {
              id: `edge-${i}-${i + 1}`,
              source: `cluster-${clusters[i].cluster}`,
              target: `cluster-${clusters[i + 1].cluster}`,
            },
          });
        }

        cy.elements().remove();
        cy.add(elements);

        // Run layout
        cy.layout({
          name: 'fcose',
          animate: true,
          animationDuration: 500,
          randomize: true,
          nodeRepulsion: () => 8000,
          idealEdgeLength: () => 100,
          edgeElasticity: () => 0.1,
          gravity: 0.5,
        } as any).run();

        isLoading.value = false;
      }

      function fitToScreen() {
        cy?.fit(undefined, 30);
      }

      function exportPNG(): string {
        return cy?.png({ full: true, scale: 2 }) || '';
      }

      function exportSVG(): string {
        return (cy as any)?.svg({ full: true }) || '';
      }

      onBeforeUnmount(() => {
        cy?.destroy();
        cy = null;
      });

      return {
        cy: () => cy,
        isInitialized,
        isLoading,
        initializeCytoscape,
        updateElements,
        fitToScreen,
        exportPNG,
        exportSVG,
      };
    }
    ```

    Also add export to composables/index.ts:
    ```typescript
    export { usePhenotypeCytoscape } from './usePhenotypeCytoscape';
    ```
  </action>
  <verify>TypeScript compiles: `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit 2>&1 | head -20`</verify>
  <done>usePhenotypeCytoscape composable created</done>
</task>

<task type="auto">
  <name>Task 2: Replace D3 with Cytoscape in AnalysesPhenotypeClusters</name>
  <files>app/src/components/analyses/AnalysesPhenotypeClusters.vue</files>
  <action>
    Refactor AnalysesPhenotypeClusters.vue to use Cytoscape instead of D3.

    Key changes:

    1. Replace D3 import with Cytoscape composable:
    ```javascript
    // Remove: import * as d3 from 'd3';
    // Add:
    import { usePhenotypeCytoscape } from '@/composables';
    import { ref, onMounted, watch } from 'vue';
    ```

    2. Update template - replace D3 container with Cytoscape container:
    ```html
    <!-- Replace the div#cluster_dataviz content -->
    <div
      ref="cytoscapeContainer"
      class="cytoscape-container"
      :style="{ height: '380px', width: '100%' }"
    />
    ```

    3. Update script setup to use composable:
    ```javascript
    setup() {
      const { makeToast } = useToast();
      const cytoscapeContainer = ref<HTMLElement | null>(null);

      return {
        makeToast,
        cytoscapeContainer,
      };
    },
    ```

    4. Initialize Cytoscape in mounted:
    ```javascript
    mounted() {
      this.loadClusterData();
    },
    ```

    5. Replace generateClusterGraph with Cytoscape update:
    ```javascript
    methods: {
      // ... existing methods ...

      initializeCytoscape() {
        if (!this.cytoscapeContainer) return;

        this.cyInstance = usePhenotypeCytoscape({
          container: { value: this.cytoscapeContainer },
          onClusterClick: (clusterId) => {
            this.activeCluster = clusterId;
          },
        });

        this.cyInstance.initializeCytoscape();
      },

      updateClusterGraph() {
        if (!this.cyInstance) {
          this.initializeCytoscape();
        }
        this.cyInstance.updateElements(this.itemsCluster);
      },
    }
    ```

    6. Replace D3 graph generation call with Cytoscape update:
    ```javascript
    // In loadClusterData success handler, replace:
    // this.generateClusterGraph();
    // with:
    this.$nextTick(() => {
      this.updateClusterGraph();
    });
    ```

    7. Remove the entire generateClusterGraph method (D3 code).

    8. Update styles:
    ```css
    .cytoscape-container {
      width: 100%;
      height: 380px;
      background: #fafafa;
      border-radius: 4px;
    }
    ```
  </action>
  <verify>Build succeeds: `cd /home/bernt-popp/development/sysndd/app && npm run build 2>&1 | head -30`</verify>
  <done>AnalysesPhenotypeClusters uses Cytoscape network</done>
</task>

<task type="auto">
  <name>Task 3: Add export buttons and polish</name>
  <files>app/src/components/analyses/AnalysesPhenotypeClusters.vue</files>
  <action>
    Add PNG/SVG export functionality using the composable methods.

    1. Update DownloadImageButtons to work with Cytoscape:
    The existing DownloadImageButtons component expects an SVG element ID.
    Either create custom export buttons or adapt the component.

    Add a simple export button group in the template header:
    ```html
    <div class="btn-group btn-group-sm">
      <BButton
        variant="outline-secondary"
        size="sm"
        @click="exportPNG"
        title="Export as PNG"
      >
        <i class="bi bi-image" />
      </BButton>
      <BButton
        variant="outline-secondary"
        size="sm"
        @click="exportSVG"
        title="Export as SVG"
      >
        <i class="bi bi-filetype-svg" />
      </BButton>
    </div>
    ```

    2. Add export methods:
    ```javascript
    methods: {
      // ... existing methods ...

      exportPNG() {
        if (!this.cyInstance) return;
        const png = this.cyInstance.exportPNG();
        const link = document.createElement('a');
        link.href = png;
        link.download = 'phenotype_clusters.png';
        link.click();
      },

      exportSVG() {
        if (!this.cyInstance) return;
        const svgContent = this.cyInstance.exportSVG();
        const blob = new Blob([svgContent], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'phenotype_clusters.svg';
        link.click();
        URL.revokeObjectURL(url);
      },
    }
    ```

    3. Style the selected cluster node differently (visual feedback):
    The composable already handles :selected style, but we need to programmatically select:
    ```javascript
    watch: {
      activeCluster() {
        this.setActiveCluster();
        // Highlight selected cluster in Cytoscape
        if (this.cyInstance?.cy()) {
          const cy = this.cyInstance.cy();
          cy.nodes().unselect();
          cy.$(`#cluster-${this.activeCluster}`).select();
        }
      },
    },
    ```
  </action>
  <verify>Component renders Cytoscape network and export buttons work</verify>
  <done>PhenotypeClusters has polished Cytoscape visualization with exports</done>
</task>

</tasks>

<verification>
- PhenotypeClusters shows interactive Cytoscape network (not D3 bubbles)
- Clusters are sized by cluster_size
- Edges connect clusters showing relationships
- Clicking a cluster selects it and updates the table
- PNG/SVG export buttons work
- Visual style consistent with AnalyseGeneClusters network
</verification>

<success_criteria>
- D3.js bubble chart fully replaced with Cytoscape.js network
- Network shows edges between clusters
- Click interaction works for cluster selection
- Export functionality maintained
</success_criteria>

<output>
After completion, create `.planning/phases/27-advanced-features-filters/27-08-SUMMARY.md`
</output>
