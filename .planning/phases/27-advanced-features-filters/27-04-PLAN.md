---
phase: 27-advanced-features-filters
plan: 04
type: execute
wave: 3
depends_on: ["27-01", "27-02", "27-03"]
files_modified:
  - app/src/components/analyses/AnalyseGeneClusters.vue
  - app/src/components/analyses/AnalysesPhenotypeClusters.vue
  - app/src/components/analyses/AnalysesPhenotypeCorrelogram.vue
  - app/src/components/analyses/NetworkVisualization.vue
autonomous: false

must_haves:
  truths:
    - "Wildcard gene search highlights matching nodes in network"
    - "Clicking cluster in correlation heatmap filters network to cluster members"
    - "Bidirectional hover highlighting works between table and network"
    - "Filter state persists in URL for bookmarkable views"
  artifacts:
    - path: "app/src/components/analyses/AnalyseGeneClusters.vue"
      provides: "Network with search highlighting and filter integration"
      contains: "useFilterSync"
    - path: "app/src/components/analyses/AnalysesPhenotypeCorrelogram.vue"
      provides: "Heatmap with click-to-filter navigation"
      contains: "setCluster"
  key_links:
    - from: "app/src/components/analyses/AnalyseGeneClusters.vue"
      to: "app/src/composables/useWildcardSearch.ts"
      via: "composable for search matching"
      pattern: "useWildcardSearch"
    - from: "app/src/components/analyses/AnalysesPhenotypeCorrelogram.vue"
      to: "app/src/composables/useFilterSync.ts"
      via: "setCluster on heatmap click"
      pattern: "setCluster"

user_setup: []
---

<objective>
Integrate search highlighting, bidirectional sync, and heatmap click navigation

Purpose: Complete FILT-04, FILT-05, NAVL-02, NAVL-05, NAVL-06 by wiring up wildcard search to network highlighting, enabling correlation heatmap click navigation, and implementing bidirectional hover between table and network

Output: Fully integrated analysis experience with search highlighting and cross-component navigation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-advanced-features-filters/27-CONTEXT.md
@.planning/phases/27-advanced-features-filters/27-RESEARCH.md
@.planning/phases/27-advanced-features-filters/27-01-SUMMARY.md
@.planning/phases/27-advanced-features-filters/27-02-SUMMARY.md
@.planning/phases/27-advanced-features-filters/27-03-SUMMARY.md
@app/src/components/analyses/AnalyseGeneClusters.vue
@app/src/components/analyses/NetworkVisualization.vue
@app/src/components/analyses/AnalysesPhenotypeCorrelogram.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add search highlighting to network visualization</name>
  <files>app/src/components/analyses/NetworkVisualization.vue, app/src/components/analyses/AnalyseGeneClusters.vue</files>
  <action>
Add wildcard search integration to NetworkVisualization.vue (created in Phase 26).

Implementation in NetworkVisualization.vue:
1. Import useFilterSync and useWildcardSearch from composables
2. Watch filterState.search and apply highlighting

Add to script setup:
```typescript
import { useFilterSync, useWildcardSearch } from '@/composables';

const { filterState } = useFilterSync();
const { pattern, regex, matches } = useWildcardSearch();

// Sync search pattern from URL state
watch(() => filterState.value.search, (newPattern) => {
  pattern.value = newPattern;
  updateNetworkHighlighting();
}, { immediate: true });

const updateNetworkHighlighting = () => {
  const cyInstance = cy();
  if (!cyInstance) return;

  const hasPattern = regex.value !== null;

  cyInstance.nodes().forEach(node => {
    const symbol = node.data('symbol');
    const isMatch = matches(symbol);

    node.removeClass('search-match search-no-match');

    if (hasPattern) {
      if (isMatch) {
        node.addClass('search-match');
      } else {
        node.addClass('search-no-match');
      }
    }
  });
};
```

Add Cytoscape styles for search highlighting (in useCytoscape or inline):
```typescript
const searchStyles = [
  {
    selector: 'node.search-match',
    style: {
      'border-color': '#ffc107',
      'border-width': 4,
      'z-index': 999,
    },
  },
  {
    selector: 'node.search-no-match',
    style: {
      'opacity': 0.3,
    },
  },
];
```

Add TermSearch to AnalyseGeneClusters.vue header:
```vue
<template #header>
  <!-- ... existing header ... -->
  <BCol sm="4">
    <TermSearch
      v-model="searchPattern"
      :match-count="matchingNodeCount"
      :is-searching="isSearching"
    />
  </BCol>
</template>
```

Wire up search pattern to filterState:
```typescript
import { useFilterSync } from '@/composables';

const { filterState, setSearch } = useFilterSync();
const searchPattern = computed({
  get: () => filterState.value.search,
  set: (val) => setSearch(val),
});
```
  </action>
  <verify>
TypeScript compiles:
```bash
cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit
```
  </verify>
  <done>Wildcard search highlights matching nodes (FILT-04, FILT-05)</done>
</task>

<task type="auto">
  <name>Task 2: Add correlation heatmap click navigation</name>
  <files>app/src/components/analyses/AnalysesPhenotypeCorrelogram.vue</files>
  <action>
Add click handler to correlation heatmap cells for cluster navigation (NAVL-02).

Implementation:
1. Import useFilterSync from composables
2. Update generateMatrixGraph to add click handler that:
   - Calls setTab('networks') to switch to network view
   - Calls setCluster(clusterId) to filter to cluster
   - Note: Current heatmap shows phenotype correlations, not clusters
   - May need to adapt based on actual data structure

If heatmap data includes cluster info, update click handler:
```typescript
// In script section, add:
import { useFilterSync } from '@/composables';

setup() {
  const { makeToast } = useToast();
  const { setTab, setCluster } = useFilterSync();

  return { makeToast, setTab, setCluster };
},
```

In generateMatrixGraph, update or add click handler on rects:
```javascript
.on('click', (event, d) => {
  // If data has cluster association, navigate to it
  if (d.cluster_id) {
    this.setCluster(d.cluster_id);
    this.setTab('networks');
  }
  // Alternatively, could navigate with phenotype IDs as currently done
})
```

Note: The current implementation links to /Phenotypes/ filtered page. Per NAVL-02, we want click to filter network + table to cluster members. This may require:
- Adding cluster_id to correlation data on backend, OR
- Interpreting cell click differently (navigate to phenotype detail?)

If cluster data not available in correlation response, add comment noting future backend enhancement needed, and preserve existing link behavior.
  </action>
  <verify>
TypeScript compiles:
```bash
cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit
```
  </verify>
  <done>Correlation heatmap click navigation integrated (NAVL-02)</done>
</task>

<task type="auto">
  <name>Task 3: Add bidirectional hover highlighting</name>
  <files>app/src/components/analyses/AnalyseGeneClusters.vue, app/src/components/analyses/NetworkVisualization.vue</files>
  <action>
Implement bidirectional hover highlighting between table and network (NAVL-05).

In NetworkVisualization.vue:
1. Import useNetworkHighlight from composables
2. Setup highlight listeners on Cytoscape instance
3. Expose hoveredNodeId for parent component

```typescript
import { useNetworkHighlight } from '@/composables';

// In setup/onMounted
const {
  highlightState,
  setupNetworkListeners,
  highlightNodeFromTable,
  isRowHighlighted
} = useNetworkHighlight(computed(() => cy()));

onMounted(() => {
  // ... existing init ...
  setupNetworkListeners();
});

// Expose for parent
defineExpose({
  highlightNodeFromTable,
  isRowHighlighted,
});

// Emit when node is hovered (for table to react)
const emit = defineEmits<{
  'node-hover': [nodeId: string | null];
}>();

watch(() => highlightState.value.hoveredNodeId, (nodeId) => {
  emit('node-hover', nodeId);
});
```

In AnalyseGeneClusters.vue:
1. Add ref to NetworkVisualization component
2. Track hoveredRowId state
3. On table row hover, call networkRef.highlightNodeFromTable(hgncId)
4. On network node-hover event, highlight table row

```vue
<template>
  <NetworkVisualization
    ref="networkRef"
    :cluster-type="selectType"
    @node-hover="handleNodeHover"
  />

  <!-- In table section -->
  <GenericTable ...>
    <template #cell-symbol="{ row }">
      <div
        :class="{ 'row-highlighted': isRowHighlighted(row.hgnc_id) }"
        @mouseenter="handleRowHover(row.hgnc_id)"
        @mouseleave="handleRowHover(null)"
      >
        <!-- existing content -->
      </div>
    </template>
  </GenericTable>
</template>

<script>
// Add to data or setup
const networkRef = ref(null);
const hoveredRowId = ref(null);

const handleRowHover = (hgncId) => {
  hoveredRowId.value = hgncId;
  networkRef.value?.highlightNodeFromTable(hgncId);
};

const handleNodeHover = (nodeId) => {
  hoveredRowId.value = nodeId;
};

const isRowHighlighted = (rowId) => {
  return hoveredRowId.value === rowId;
};
</script>

<style scoped>
.row-highlighted {
  background-color: rgba(var(--bs-warning-rgb), 0.2);
}
</style>
```
  </action>
  <verify>
TypeScript compiles:
```bash
cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit
```
  </verify>
  <done>Bidirectional hover highlighting works (NAVL-05)</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify advanced features integration</name>
  <what-built>
Complete advanced features integration:
- Wildcard gene search (PKD*, BRCA?) highlights matching nodes
- Non-matching nodes fade to 30% opacity
- Filter state persists in URL
- Heatmap click navigation (if cluster data available)
- Bidirectional hover: table row hover highlights network node and vice versa
- TermSearch shows no-match feedback
  </what-built>
  <how-to-verify>
1. Navigate to http://localhost:5173/analysis?tab=networks

2. Test wildcard search:
   - Type "PKD*" in search box
   - Verify: Nodes starting with PKD highlighted (yellow border)
   - Verify: Other nodes faded (30% opacity)
   - Clear search, verify all nodes restored

3. Test search patterns:
   - "BRCA?" matches BRCA1, BRCA2 (single char wildcard)
   - "TP53" exact match only
   - "XYZ*" shows "No genes match 'XYZ*'" message

4. Test URL persistence:
   - Set search to "PKD*"
   - Copy URL (should include ?tab=networks&search=PKD*)
   - Open in new tab
   - Verify: Same search applied, same highlighting

5. Test bidirectional hover:
   - Hover over gene in table -> Node glows in network
   - Hover over node in network -> Row highlights in table
   - Move away -> Highlights clear

6. Test filter badge:
   - Apply search -> Badge shows "1 filter active"
   - Click Clear -> Badge disappears, search cleared

7. Test correlation heatmap (if applicable):
   - Click cell in correlation heatmap
   - Verify navigation behavior

8. Test tab navigation:
   - Click each tab (Phenotype Clusters, Gene Networks, Correlation)
   - URL updates with ?tab=value
   - Correct component renders
  </how-to-verify>
  <resume-signal>Type "approved" if all advanced features work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Search "PKD*" highlights PKD1, PKD2, etc. in network
2. Non-matching nodes at 30% opacity
3. URL shows search parameter after typing
4. Refresh preserves search state
5. Table row hover -> network node highlight
6. Network node hover -> table row highlight
7. No feedback loops (hover doesn't flicker)
8. Filter badge shows count and Clear works
</verification>

<success_criteria>
- FILT-04: Wildcard gene search supports patterns (PKD*, BRCA?)
- FILT-05: Search highlights matching nodes in network
- NAVL-02: Click in correlation heatmap navigates to cluster (if data supports)
- NAVL-05: Bidirectional network-to-table sync on hover
- NAVL-06: useFilterSync composable coordinates shared state
- URL state persistence verified by copy/paste URL test
- No hover feedback loops (source tracking works)
</success_criteria>

<output>
After completion, create `.planning/phases/27-advanced-features-filters/27-04-SUMMARY.md`
</output>
