---
phase: 18-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/renv.lock
  - api/renv/settings.json
  - api/.Rprofile
autonomous: false

must_haves:
  truths:
    - "renv.lock contains R version 4.4.x metadata"
    - "All packages listed in start_sysndd_api.R are captured in renv.lock"
    - "Matrix package version is 1.6.3 or higher"
    - "Bioconductor packages (STRINGdb, biomaRt) are in renv.lock"
    - "renv::restore() can run without errors on R 4.4.x"
  artifacts:
    - path: "api/renv.lock"
      provides: "Complete package lockfile for R 4.4.x"
      contains: '"Version": "4.4'
    - path: "api/renv/settings.json"
      provides: "renv configuration"
  key_links:
    - from: "api/renv.lock"
      to: "api/start_sysndd_api.R"
      via: "All library() calls have corresponding entries"
      pattern: "library\\("
---

<objective>
Create a fresh renv.lock file on R 4.4.x that captures all API dependencies.

Purpose: The current renv.lock is for R 4.1.2 with Matrix 1.4-0, which is incompatible with modern lme4. A fresh lockfile on R 4.4.x eliminates the need for Dockerfile workarounds and ensures ABI compatibility.

Output: A complete renv.lock that allows `renv::restore()` to install all packages without manual intervention.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-foundation/18-RESEARCH.md
@api/start_sysndd_api.R
@api/renv.lock (first 50 lines for current structure)
@api/renv/settings.json
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Install R 4.4.x Locally</name>
  <action>
    This task requires the user to have R 4.4.x installed locally. The fresh renv.lock must be created on the target R version to avoid ABI compatibility issues.

    **Check current R version:**
    ```bash
    R --version | head -1
    ```

    **If R 4.4.x is not installed:**
    - Ubuntu/Debian: Follow https://cran.r-project.org/bin/linux/ubuntu/
    - macOS: Download from https://cran.r-project.org/bin/macosx/
    - Windows: Download from https://cran.r-project.org/bin/windows/base/

    **Required version:** R 4.4.0 or higher (4.4.3 recommended)
  </action>
  <resume-signal>Confirm R 4.4.x is installed by typing "R 4.4 ready" or provide your R version</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Create Fresh renv.lock on R 4.4.x</name>
  <files>
    api/renv.lock
    api/renv/settings.json
    api/.Rprofile
  </files>
  <action>
    Create a fresh renv.lock file that captures all dependencies for R 4.4.x.

    **Step 1: Backup current renv.lock**
    ```bash
    cp api/renv.lock api/renv.lock.backup-4.1.2
    ```

    **Step 2: Initialize fresh renv**
    ```bash
    cd api
    R --vanilla -e '
      # Remove old renv library to start fresh
      unlink("renv/library", recursive = TRUE)

      # Initialize renv with bare project
      renv::init(bare = TRUE)
    '
    ```

    **Step 3: Install all packages from start_sysndd_api.R**
    The packages to install (extracted from start_sysndd_api.R lines 21-64):

    **Core packages:**
    - dotenv, plumber, logger, tictoc, fs, jsonlite, DBI, RMariaDB, config, pool

    **Additional packages:**
    - biomaRt, tidyverse, stringr, jose, RCurl, stringdist, xlsx, easyPubMed
    - xml2, rvest, lubridate, memoise, coop, reshape2, blastula, keyring
    - future, knitr, rlang, timetk, STRINGdb, factoextra, FactoMineR
    - vctrs, httr, ellipsis, ontologyIndex

    **Testing packages:**
    - testthat, dittodb, withr, httr2, mirai, httptest2

    ```bash
    cd api
    R --vanilla -e '
      # Set P3M for binary packages
      options(repos = c(CRAN = "https://packagemanager.posit.co/cran/__linux__/jammy/latest"))

      # Install core packages
      renv::install(c(
        "dotenv", "plumber", "logger", "tictoc", "fs", "jsonlite",
        "DBI", "RMariaDB", "config", "pool"
      ))

      # Install additional packages
      renv::install(c(
        "tidyverse", "stringr", "jose", "RCurl", "stringdist", "xlsx",
        "easyPubMed", "xml2", "rvest", "lubridate", "memoise", "coop",
        "reshape2", "blastula", "keyring", "future", "knitr", "rlang",
        "timetk", "factoextra", "FactoMineR", "vctrs", "httr", "ellipsis",
        "ontologyIndex", "igraph", "remotes", "cachem"
      ))

      # Install Bioconductor packages
      renv::install("BiocManager")
      BiocManager::install(c("STRINGdb", "biomaRt"), update = FALSE, ask = FALSE)

      # Install testing packages
      renv::install(c("testthat", "dittodb", "withr", "httr2", "mirai", "httptest2", "covr"))

      # Snapshot
      renv::snapshot()
    '
    ```

    **Step 4: Verify Matrix version >= 1.6.3**
    ```bash
    cd api
    grep -A 5 '"Matrix":' renv.lock | grep Version
    ```
    Expected: Version should be 1.7-0 or higher (bundled with R 4.4.x).

    **Step 5: Verify R version in lockfile**
    ```bash
    cd api
    head -10 renv.lock | grep Version
    ```
    Expected: R Version should be 4.4.x.

    **Important notes:**
    - Use `renv::install()` not `install.packages()` to maintain renv tracking
    - P3M URL uses jammy (Ubuntu 22.04) for R 4.4.x compatibility
    - BiocManager handles Bioconductor version detection automatically
  </action>
  <verify>
    ```bash
    cd api
    # Check R version in lockfile
    grep '"Version": "4.4' renv.lock && echo "R 4.4.x confirmed"

    # Check Matrix version
    grep -A 2 '"Matrix":' renv.lock | grep -E 'Version.*1\.[6-9]' && echo "Matrix >= 1.6 confirmed"

    # Count packages (should be 150+)
    grep -c '"Package":' renv.lock

    # Verify key packages present
    for pkg in plumber RMariaDB FactoMineR STRINGdb biomaRt testthat; do
      grep -q "\"$pkg\":" renv.lock && echo "$pkg found" || echo "MISSING: $pkg"
    done
    ```
  </verify>
  <done>
    - renv.lock contains R version 4.4.x
    - Matrix version >= 1.6.3 in lockfile
    - All 30+ packages from start_sysndd_api.R present
    - Bioconductor packages (STRINGdb, biomaRt) included
    - Testing packages (testthat, mirai) included
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify renv.lock Completeness</name>
  <files>
    api/renv.lock
  </files>
  <action>
    Cross-reference renv.lock against start_sysndd_api.R to ensure all library() calls are captured.

    **Extract all library() calls from start_sysndd_api.R:**
    ```bash
    grep -oP 'library\(\K[^)]+' api/start_sysndd_api.R | sort -u
    ```

    **Check each package exists in renv.lock:**
    For each package found, verify it exists in renv.lock.

    **Known packages that must be present (from start_sysndd_api.R):**
    1. dotenv
    2. plumber
    3. logger
    4. tictoc
    5. fs
    6. jsonlite
    7. DBI
    8. RMariaDB
    9. config
    10. pool
    11. biomaRt
    12. tidyverse
    13. stringr
    14. jose
    15. RCurl
    16. stringdist
    17. xlsx
    18. easyPubMed
    19. xml2
    20. rvest
    21. lubridate
    22. memoise
    23. coop
    24. reshape2
    25. blastula
    26. keyring
    27. future
    28. knitr
    29. rlang
    30. timetk
    31. STRINGdb
    32. factoextra
    33. FactoMineR
    34. vctrs
    35. httr
    36. ellipsis
    37. ontologyIndex

    If any package is missing from renv.lock, add it via `renv::install("package_name")` and re-snapshot.
  </action>
  <verify>
    ```bash
    cd /home/bernt-popp/development/sysndd

    # Extract library() calls and check against renv.lock
    missing=""
    for pkg in $(grep -oP 'library\(\K[^)]+' api/start_sysndd_api.R | sort -u); do
      if ! grep -q "\"$pkg\":" api/renv.lock; then
        missing="$missing $pkg"
      fi
    done

    if [ -z "$missing" ]; then
      echo "All packages present in renv.lock"
    else
      echo "Missing packages:$missing"
      exit 1
    fi
    ```
  </verify>
  <done>
    - Every library() call in start_sysndd_api.R has corresponding entry in renv.lock
    - No manual package installation will be needed in Dockerfile
  </done>
</task>

</tasks>

<verification>
- [ ] R version in renv.lock is 4.4.x (not 4.1.2)
- [ ] Matrix version >= 1.6.3 (eliminates ABI compatibility issues)
- [ ] All 37 packages from start_sysndd_api.R are in renv.lock
- [ ] Bioconductor packages (STRINGdb, biomaRt) are captured
- [ ] Testing packages (testthat, mirai, dittodb) are captured
- [ ] renv.lock.backup-4.1.2 exists for rollback if needed
</verification>

<success_criteria>
1. `grep '"Version": "4.4' api/renv.lock` returns a match
2. `grep -c '"Package":' api/renv.lock` returns 150+ packages
3. All library() calls from start_sysndd_api.R have lockfile entries
4. Matrix version is 1.6.3 or higher (verified via grep)
</success_criteria>

<output>
After completion, create `.planning/phases/18-foundation/18-01-SUMMARY.md`
</output>
