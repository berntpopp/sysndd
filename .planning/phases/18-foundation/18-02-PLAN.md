---
phase: 18-foundation
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - api/Dockerfile
autonomous: false

must_haves:
  truths:
    - "Dockerfile uses rocker/r-ver:4.4.3 base image"
    - "P3M URL references jammy (Ubuntu 22.04), not focal"
    - "No 2022-01-03 P3M snapshot workaround exists"
    - "No manual install.packages() calls for FactoMineR/lme4"
    - "renv::restore() is the only package installation mechanism"
    - "Docker build completes without errors"
  artifacts:
    - path: "api/Dockerfile"
      provides: "Multi-stage Docker build for R 4.4.3 API"
      contains: "rocker/r-ver:4.4.3"
  key_links:
    - from: "api/Dockerfile"
      to: "api/renv.lock"
      via: "COPY renv.lock and renv::restore()"
      pattern: "renv::restore"
---

<objective>
Update Dockerfile to R 4.4.3 and remove all package installation workarounds.

Purpose: With a complete renv.lock from Plan 01, the Dockerfile can be simplified to only use renv::restore() for package installation. This eliminates the 2022-01-03 P3M snapshot workaround and manual package installs.

Output: A clean Dockerfile that builds successfully with R 4.4.3 and all packages from renv.lock.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-foundation/18-RESEARCH.md
@.planning/phases/18-foundation/18-01-SUMMARY.md
@api/Dockerfile
@api/renv.lock (first 20 lines for R version verification)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Dockerfile Base Image and P3M URLs</name>
  <files>api/Dockerfile</files>
  <action>
    Update the Dockerfile to use R 4.4.3 and jammy P3M URLs.

    **Changes to make in api/Dockerfile:**

    1. **Line 21 (base image):**
       ```dockerfile
       # BEFORE
       FROM rocker/r-ver:4.1.2 AS base

       # AFTER
       FROM rocker/r-ver:4.4.3 AS base
       ```

    2. **Line 25 (P3M URL):**
       ```dockerfile
       # BEFORE
       ENV RENV_CONFIG_REPOS_OVERRIDE="https://packagemanager.posit.co/cran/__linux__/focal/latest"

       # AFTER
       ENV RENV_CONFIG_REPOS_OVERRIDE="https://packagemanager.posit.co/cran/__linux__/jammy/latest"
       ```

    3. **Update header comment (line 6):**
       ```dockerfile
       # Build time target: 3-5 minutes (simplified with complete renv.lock)
       ```

    4. **Update image metadata label (line 185-186):**
       ```dockerfile
       LABEL maintainer="SysNDD Team" \
             version="3.0" \
             description="SysNDD R Plumber API (R 4.4.3, Multi-Stage Optimized)"
       ```
  </action>
  <verify>
    ```bash
    grep -E "rocker/r-ver:4\.4" api/Dockerfile && echo "Base image updated"
    grep -E "jammy" api/Dockerfile && echo "P3M URL updated"
    ! grep -E "focal" api/Dockerfile && echo "No focal references remain"
    ```
  </verify>
  <done>
    - Base image is rocker/r-ver:4.4.3
    - P3M URL uses jammy (Ubuntu 22.04)
    - No focal (Ubuntu 20.04) references remain
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove Package Installation Workarounds</name>
  <files>api/Dockerfile</files>
  <action>
    Remove all manual package installation sections that are now handled by renv.lock.

    **Remove lines 125-146 (three RUN blocks with workarounds):**

    These sections should be DELETED:
    ```dockerfile
    # Install critical packages missing from renv.lock
    # Note: These packages should be added to renv.lock in a future update
    # Key issue: renv.lock has Matrix 1.4-0, lme4 >= 1.1-28 requires Matrix >= 1.5.0 (needs R >= 4.2)
    # Solution: Use 2022-01-03 P3M snapshot for FactoMineR dependencies (compatible with R 4.1.2)
    #           Use latest P3M for other packages (plumber, RMariaDB, etc.)
    RUN --mount=type=cache,target=/renv_cache,sharing=locked \
        --mount=type=cache,target=/root/.ccache,sharing=locked \
        R -e 'options(repos = c(CRAN = "https://packagemanager.posit.co/cran/__linux__/focal/latest")); \
        install.packages(c("plumber", "RMariaDB", "igraph", "xlsx", "tidyverse", "remotes", "BiocManager", "dotenv"), lib = "/usr/local/lib/R/site-library", Ncpus = parallel::detectCores())'

    # Install FactoMineR/factoextra with R 4.1.2-compatible versions from 2022-01-03 snapshot
    # This gives us lme4 1.1-27.1, pbkrtest 0.5-0.1, car 3.0-12, which all work with Matrix 1.4-0
    RUN --mount=type=cache,target=/renv_cache,sharing=locked \
        --mount=type=cache,target=/root/.ccache,sharing=locked \
        R -e 'options(repos = c(CRAN = "https://packagemanager.posit.co/cran/__linux__/focal/2022-01-03")); \
        install.packages(c("nloptr", "lme4", "pbkrtest", "car", "FactoMineR", "factoextra"), lib = "/usr/local/lib/R/site-library", Ncpus = parallel::detectCores())'

    # Install Bioconductor packages (use latest versions)
    RUN --mount=type=cache,target=/renv_cache,sharing=locked \
        --mount=type=cache,target=/root/.ccache,sharing=locked \
        R -e 'options(repos = c(CRAN = "https://packagemanager.posit.co/cran/__linux__/focal/latest")); \
        BiocManager::install(c("STRINGdb", "biomaRt"), update=FALSE, ask=FALSE)'
    ```

    **Update the renv::restore() call (around line 121-123):**
    ```dockerfile
    # BEFORE
    RUN --mount=type=cache,target=/renv_cache,sharing=locked \
        --mount=type=cache,target=/root/.ccache,sharing=locked \
        R -e 'renv::restore(library = "/usr/local/lib/R/site-library")'

    # AFTER (use renv project library, not site-library)
    RUN --mount=type=cache,target=/renv_cache,sharing=locked \
        --mount=type=cache,target=/root/.ccache,sharing=locked \
        R --vanilla -s -e 'renv::restore()'
    ```

    **The final packages stage should look like:**
    ```dockerfile
    # =============================================================================
    # Stage 2: Packages - Install all R packages (build-time only)
    # =============================================================================
    FROM base AS packages

    WORKDIR /app

    # Copy renv infrastructure first (for layer caching)
    # If renv.lock hasn't changed, Docker will use cached layers
    COPY renv.lock renv.lock
    COPY renv/activate.R renv/activate.R
    COPY renv/settings.json renv/settings.json
    COPY .Rprofile .Rprofile

    # Restore all packages from lockfile - no manual installs needed
    # Complete renv.lock on R 4.4.x captures all dependencies including Bioconductor
    RUN --mount=type=cache,target=/renv_cache,sharing=locked \
        --mount=type=cache,target=/root/.ccache,sharing=locked \
        R --vanilla -s -e 'renv::restore()'

    # Strip debug symbols from compiled libraries to reduce image size
    RUN find /app/renv/library -name "*.so" \
        -exec strip --strip-debug {} \; 2>/dev/null || true
    ```

    **Update production stage to copy renv library:**
    ```dockerfile
    # Copy R libraries from packages stage
    COPY --from=packages /app/renv /app/renv
    COPY --from=packages /app/.Rprofile /app/.Rprofile
    ```

    Remove this line since we're using renv library now:
    ```dockerfile
    # REMOVE THIS LINE
    COPY --from=packages /usr/local/lib/R/site-library /usr/local/lib/R/site-library
    ```
  </action>
  <verify>
    ```bash
    # No focal references
    ! grep -q "focal" api/Dockerfile && echo "No focal references"

    # No 2022-01-03 snapshot
    ! grep -q "2022-01-03" api/Dockerfile && echo "No snapshot workaround"

    # No manual install.packages for FactoMineR/lme4
    ! grep -q 'install.packages.*FactoMineR' api/Dockerfile && echo "No manual FactoMineR install"

    # Single renv::restore() call
    grep -c "renv::restore" api/Dockerfile | grep -q "1" && echo "Single renv::restore call"
    ```
  </verify>
  <done>
    - No P3M snapshot workarounds (2022-01-03 removed)
    - No manual install.packages() calls
    - Single renv::restore() handles all package installation
    - Dockerfile is significantly simplified
  </done>
</task>

<task type="auto">
  <name>Task 3: Build and Test Docker Image</name>
  <files>api/Dockerfile</files>
  <action>
    Build the Docker image and verify it starts correctly.

    **Step 1: Build the API image**
    ```bash
    cd /home/bernt-popp/development/sysndd
    DOCKER_BUILDKIT=1 docker build -t sysndd-api:4.4.3-test -f api/Dockerfile api/
    ```

    **Expected behavior:**
    - Build should complete in 5-10 minutes (first build downloads packages)
    - renv::restore() should complete without errors
    - No ABI compatibility warnings about Matrix/lme4

    **Step 2: Verify R version in container**
    ```bash
    docker run --rm sysndd-api:4.4.3-test R --version | head -1
    ```
    Expected: R version 4.4.3

    **Step 3: Verify Matrix package version**
    ```bash
    docker run --rm sysndd-api:4.4.3-test R -e 'packageVersion("Matrix")'
    ```
    Expected: 1.7-0 or higher

    **Step 4: Verify FactoMineR/lme4 load without errors**
    ```bash
    docker run --rm sysndd-api:4.4.3-test R -e '
      library(Matrix)
      library(lme4)
      library(FactoMineR)
      cat("All packages loaded successfully\n")
    '
    ```

    **If build fails:**
    - Check for missing system dependencies (apt packages)
    - Check renv::restore() output for package errors
    - Verify renv.lock is complete (from Plan 01)
  </action>
  <verify>
    ```bash
    # Verify image exists
    docker images sysndd-api:4.4.3-test --format "{{.Repository}}:{{.Tag}}" | grep -q "4.4.3-test"

    # Verify R version
    docker run --rm sysndd-api:4.4.3-test R --version 2>/dev/null | head -1 | grep -q "4.4"

    # Verify packages load
    docker run --rm sysndd-api:4.4.3-test R -e 'library(FactoMineR); library(lme4); cat("OK\n")' 2>&1 | grep -q "OK"
    ```
  </verify>
  <done>
    - Docker build completes successfully
    - R version 4.4.3 in container
    - Matrix, lme4, FactoMineR load without ABI errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify API Functionality</name>
  <what-built>
    Updated Docker image with R 4.4.3, complete renv.lock, and simplified Dockerfile without workarounds.
  </what-built>
  <how-to-verify>
    1. **Start the full stack:**
       ```bash
       cd /home/bernt-popp/development/sysndd
       docker compose up -d
       ```

    2. **Check API health endpoint:**
       ```bash
       curl -s http://localhost:7777/health/ | jq .
       ```
       Expected: `{"status": "healthy", ...}`

    3. **Run existing API tests:**
       ```bash
       make test-api
       ```
       Expected: All 610 tests pass

    4. **Test a clustering endpoint (uses FactoMineR/lme4):**
       - If the API exposes a phenotype clustering endpoint, test it returns valid results
       - Check logs for any Matrix/lme4 warnings:
       ```bash
       docker logs sysndd-api 2>&1 | grep -i "matrix\|lme4\|abi"
       ```

    5. **Stop the stack:**
       ```bash
       docker compose down
       ```
  </how-to-verify>
  <resume-signal>Type "verified" if all tests pass, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
- [ ] Dockerfile uses rocker/r-ver:4.4.3 base image
- [ ] P3M URL is jammy/latest (not focal)
- [ ] No 2022-01-03 P3M snapshot workaround
- [ ] No manual install.packages() calls for packages in renv.lock
- [ ] Docker build completes successfully
- [ ] R 4.4.3 confirmed in container
- [ ] Matrix version 1.7+ in container
- [ ] FactoMineR and lme4 load without ABI errors
- [ ] API health endpoint responds
- [ ] All existing tests pass (610 tests)
</verification>

<success_criteria>
1. `docker build` completes without errors
2. `docker run sysndd-api:4.4.3-test R --version` shows R 4.4.3
3. `docker run sysndd-api:4.4.3-test R -e 'library(FactoMineR)'` succeeds without warnings
4. All 610 existing API tests pass
5. API health endpoint returns healthy status
</success_criteria>

<output>
After completion, create `.planning/phases/18-foundation/18-02-SUMMARY.md`
</output>
