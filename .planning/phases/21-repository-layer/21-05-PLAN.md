---
phase: 21-repository-layer
plan: 05
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - api/functions/user-repository.R
  - api/functions/hash-repository.R
  - api/start_sysndd_api.R
autonomous: true

must_haves:
  truths:
    - "User operations use parameterized queries"
    - "Hash operations use parameterized queries"
    - "User password operations never log passwords"
    - "Hash creation validates column names against whitelist"
  artifacts:
    - path: "api/functions/user-repository.R"
      provides: "User domain database operations"
      exports: ["user_find_by_id", "user_find_by_email", "user_find_by_ids", "user_create", "user_update", "user_update_password"]
      min_lines: 100
    - path: "api/functions/hash-repository.R"
      provides: "Hash domain database operations"
      exports: ["hash_find_by_value", "hash_create", "hash_exists"]
      min_lines: 50
  key_links:
    - from: "api/functions/user-repository.R"
      to: "api/functions/db-helpers.R"
      via: "db_execute_query, db_execute_statement"
      pattern: "db_execute"
    - from: "api/functions/hash-repository.R"
      to: "api/functions/db-helpers.R"
      via: "db_execute_query, db_execute_statement"
      pattern: "db_execute"
---

<objective>
Create user and hash repositories - completing the 8 domain repositories.

Purpose: User repository handles authentication and user management operations. Hash repository manages table hashes for API caching. Both complete the repository layer foundation.

Output: `api/functions/user-repository.R` and `api/functions/hash-repository.R` with domain operations using db-helpers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-repository-layer/21-RESEARCH.md
@.planning/phases/21-repository-layer/21-01-SUMMARY.md
@api/functions/database-functions.R
@api/endpoints/user_endpoints.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user-repository.R</name>
  <files>api/functions/user-repository.R</files>
  <action>
Create `api/functions/user-repository.R` with functions that will replace user operations scattered across user_endpoints.R:

**Reference existing code:** See user_endpoints.R for patterns (multiple dbConnect calls around lines 169, 218, 261, 287, 468, 532, 631, 691, 783, 832).

1. **user_find_by_id(user_id)** - Find single user
   - SQL: `SELECT user_id, user_name, user_email, user_role FROM users_view WHERE user_id = ?`
   - Note: Uses users_view (not users table) to avoid exposing password
   - Returns tibble (1 row or 0 rows)

2. **user_find_by_email(email)** - Find user by email
   - SQL: `SELECT user_id, user_name, user_email, user_role FROM users_view WHERE user_email = ?`
   - Returns tibble (1 row or 0 rows)

3. **user_find_by_ids(user_ids)** - Find multiple users
   - Generate placeholders for IN clause
   - Handle empty input: return empty tibble with correct columns
   - Returns tibble

4. **user_find_for_auth(email)** - Find user with password hash for authentication
   - SQL: `SELECT user_id, user_name, user_email, user_role, user_password_hash FROM users WHERE user_email = ?`
   - Note: This includes password hash - only for auth
   - IMPORTANT: Never log the result of this query (contains password hash)
   - Returns tibble (1 row or 0 rows)

5. **user_create(user_data)** - Create new user
   - Validate required fields: user_name, user_email, user_password_hash, user_role
   - SQL: `INSERT INTO users (user_name, user_email, user_password_hash, user_role) VALUES (?, ?, ?, ?)`
   - Get last insert ID
   - Returns integer user_id

6. **user_update(user_id, updates)** - Update user (non-password fields)
   - Remove user_password_hash from updates if present (use user_update_password instead)
   - Build SET clause dynamically
   - Returns affected row count

7. **user_update_password(user_id, password_hash)** - Update user password
   - Dedicated function for password updates
   - SQL: `UPDATE users SET user_password_hash = ? WHERE user_id = ?`
   - NEVER log the password_hash parameter
   - Returns affected row count

8. **user_exists(email)** - Check if email exists
   - SQL: `SELECT 1 FROM users WHERE user_email = ? LIMIT 1`
   - Returns logical TRUE/FALSE

9. **user_deactivate(user_id)** - Deactivate user (soft delete)
   - SQL: `UPDATE users SET is_active = 0 WHERE user_id = ?`
   - Returns affected row count
  </action>
  <verify>
- File exists at api/functions/user-repository.R
- All functions use db-helpers
- No password logging anywhere (search for "password" in log statements)
- user_find_for_auth clearly documented as auth-only
  </verify>
  <done>
- user-repository.R created with 9 functions
- Password handling segregated
- No password logging
  </done>
</task>

<task type="auto">
  <name>Task 2: Create hash-repository.R</name>
  <files>api/functions/hash-repository.R</files>
  <action>
Create `api/functions/hash-repository.R` with functions that replace hash operations in database-functions.R:

**Reference existing code:** See `post_db_hash()` (line 897-994) in database-functions.R.

1. **hash_find_by_value(hash_value)** - Find hash record by hash value
   - SQL: `SELECT hash_id, hash_256, json_text, target_endpoint FROM table_hash WHERE hash_256 = ?`
   - Returns tibble (1 row or 0 rows)

2. **hash_exists(hash_value)** - Check if hash exists
   - SQL: `SELECT 1 FROM table_hash WHERE hash_256 = ? LIMIT 1`
   - Returns logical TRUE/FALSE

3. **hash_create(hash_value, json_text, endpoint)** - Create new hash record
   - Validate hash_value is not empty
   - SQL: `INSERT INTO table_hash (hash_256, json_text, target_endpoint) VALUES (?, ?, ?)`
   - Returns integer hash_id (or hash_value for consistency with existing API)

4. **hash_validate_columns(column_names, allowed_columns)** - Validate column names
   - Check all column_names are in allowed_columns list
   - On invalid: `rlang::abort()` with class `hash_column_validation_error` and `invalid_columns` attribute
   - Returns TRUE if valid

Note: The actual hash generation (SHA-256) happens in endpoint layer, not in repository.
Repository only handles database persistence.
  </action>
  <verify>
- File exists at api/functions/hash-repository.R
- All functions use db-helpers
- No dbConnect() calls
- Column validation function exists
  </verify>
  <done>
- hash-repository.R created with 4 functions
- Column validation for security
- Clean separation of hashing logic from persistence
  </done>
</task>

<task type="auto">
  <name>Task 3: Source repositories in start_sysndd_api.R</name>
  <files>api/start_sysndd_api.R</files>
  <action>
Add source lines for user-repository.R and hash-repository.R in start_sysndd_api.R.

Insert AFTER the ontology-repository.R source line (added in plan 21-04):
```r
source("functions/user-repository.R", local = TRUE)
source("functions/hash-repository.R", local = TRUE)
```

This completes all 8 repository files being sourced.
  </action>
  <verify>
- `grep -n "user-repository.R" api/start_sysndd_api.R` shows source line
- `grep -n "hash-repository.R" api/start_sysndd_api.R` shows source line
- Count of repository source lines = 8 (entity, review, status, publication, phenotype, ontology, user, hash)
  </verify>
  <done>
- All 8 repository files sourced in start_sysndd_api.R
- Complete repository layer infrastructure loaded
  </done>
</task>

</tasks>

<verification>
- [ ] api/functions/user-repository.R exists with ~100+ lines
- [ ] api/functions/hash-repository.R exists with ~50+ lines
- [ ] Both use db-helpers functions
- [ ] No dbConnect() in either file
- [ ] Both sourced in start_sysndd_api.R
- [ ] All 8 repository source lines present in start_sysndd_api.R
</verification>

<success_criteria>
- User repository provides: find_by_id, find_by_email, find_by_ids, find_for_auth, create, update, update_password, exists, deactivate
- Hash repository provides: find_by_value, exists, create, validate_columns
- Password handling isolated and never logged
- All 8 domain repositories complete and loaded
</success_criteria>

<output>
After completion, create `.planning/phases/21-repository-layer/21-05-SUMMARY.md`
</output>
