---
phase: 21-repository-layer
plan: 04
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - api/functions/phenotype-repository.R
  - api/functions/ontology-repository.R
  - api/start_sysndd_api.R
autonomous: true

must_haves:
  truths:
    - "Phenotype connection operations use parameterized queries"
    - "Ontology connection operations use parameterized queries"
    - "Phenotype IDs validated against phenotype_list table"
    - "Variation ontology IDs validated against variation_ontology_list table"
  artifacts:
    - path: "api/functions/phenotype-repository.R"
      provides: "Phenotype domain database operations"
      exports: ["phenotype_validate_ids", "phenotype_connect_to_review", "phenotype_replace_for_review", "phenotype_find_by_review"]
      min_lines: 70
    - path: "api/functions/ontology-repository.R"
      provides: "Ontology domain database operations"
      exports: ["variation_ontology_validate_ids", "variation_ontology_connect_to_review", "variation_ontology_replace_for_review"]
      min_lines: 70
  key_links:
    - from: "api/functions/phenotype-repository.R"
      to: "api/functions/db-helpers.R"
      via: "db_execute_query, db_execute_statement"
      pattern: "db_execute"
    - from: "api/functions/ontology-repository.R"
      to: "api/functions/db-helpers.R"
      via: "db_execute_query, db_execute_statement"
      pattern: "db_execute"
---

<objective>
Create phenotype and ontology repositories.

Purpose: Phenotype (HPO terms) and variation ontology (VARIO terms) are connected to reviews. Both require validation against allowed term lists before insertion. These are parallel domains that can be developed together.

Output: `api/functions/phenotype-repository.R` and `api/functions/ontology-repository.R` with connection operations using db-helpers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-repository-layer/21-RESEARCH.md
@.planning/phases/21-repository-layer/21-01-SUMMARY.md
@api/functions/database-functions.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create phenotype-repository.R</name>
  <files>api/functions/phenotype-repository.R</files>
  <action>
Create `api/functions/phenotype-repository.R` with functions that replace phenotype operations in database-functions.R:

**Reference existing code:** See `put_post_db_phen_con()` (line 491-597) in database-functions.R.

1. **phenotype_validate_ids(phenotype_ids)** - Validate phenotype IDs against allowed list
   - Use pool with dplyr: `pool %>% tbl("phenotype_list") %>% select(phenotype_id) %>% collect()`
   - Check all provided IDs exist in the allowed list
   - On invalid: `rlang::abort()` with class `phenotype_validation_error` and `invalid_ids` attribute
   - Returns TRUE if valid

2. **phenotype_find_by_review(review_id)** - Find phenotypes connected to review
   - SQL: `SELECT review_id, phenotype_id, entity_id, modifier_id FROM ndd_review_phenotype_connect WHERE review_id = ?`
   - Returns tibble

3. **phenotype_connect_to_review(review_id, entity_id, phenotypes)** - Connect phenotypes to review
   - `phenotypes` is tibble with phenotype_id, modifier_id columns
   - Validate IDs first via phenotype_validate_ids()
   - Validate entity_id matches the review's entity_id (get from ndd_entity_review table)
   - For each phenotype: `INSERT INTO ndd_review_phenotype_connect (review_id, entity_id, phenotype_id, modifier_id) VALUES (?, ?, ?, ?)`
   - Returns affected row count

4. **phenotype_replace_for_review(review_id, entity_id, phenotypes)** - Replace all phenotypes for review
   - Validate entity_id match first
   - Use db_with_transaction
   - First: `DELETE FROM ndd_review_phenotype_connect WHERE review_id = ?`
   - Then: Insert new phenotypes
   - Returns affected row count

5. **phenotype_get_allowed_list()** - Get all allowed phenotype IDs
   - Use pool with dplyr: `pool %>% tbl("phenotype_list") %>% select(phenotype_id) %>% collect()`
   - Returns tibble for caching/reuse
  </action>
  <verify>
- File exists at api/functions/phenotype-repository.R
- All functions use db-helpers
- Validation uses pool with dplyr
- phenotype_replace_for_review uses transaction
  </verify>
  <done>
- phenotype-repository.R created with 5 functions
- Validation before insert
- Replace operation uses transaction
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ontology-repository.R</name>
  <files>api/functions/ontology-repository.R</files>
  <action>
Create `api/functions/ontology-repository.R` with functions that replace variation ontology operations in database-functions.R:

**Reference existing code:** See `put_post_db_var_ont_con()` (line 618-725) in database-functions.R.

1. **variation_ontology_validate_ids(vario_ids)** - Validate variation ontology IDs
   - Use pool with dplyr: `pool %>% tbl("variation_ontology_list") %>% select(vario_id) %>% collect()`
   - Check all provided IDs exist in the allowed list
   - On invalid: `rlang::abort()` with class `variation_ontology_validation_error` and `invalid_ids` attribute
   - Returns TRUE if valid

2. **variation_ontology_find_by_review(review_id)** - Find variation ontology terms connected to review
   - SQL: `SELECT review_id, vario_id, modifier_id, entity_id FROM ndd_review_variation_ontology_connect WHERE review_id = ?`
   - Returns tibble

3. **variation_ontology_connect_to_review(review_id, entity_id, variation_ontology)** - Connect terms to review
   - `variation_ontology` is tibble with vario_id, modifier_id columns
   - Validate IDs first via variation_ontology_validate_ids()
   - Validate entity_id matches the review's entity_id
   - For each term: `INSERT INTO ndd_review_variation_ontology_connect (review_id, vario_id, modifier_id, entity_id) VALUES (?, ?, ?, ?)`
   - Returns affected row count

4. **variation_ontology_replace_for_review(review_id, entity_id, variation_ontology)** - Replace all terms for review
   - Validate entity_id match first
   - Use db_with_transaction
   - First: `DELETE FROM ndd_review_variation_ontology_connect WHERE review_id = ?`
   - Then: Insert new terms
   - Returns affected row count

5. **variation_ontology_get_allowed_list()** - Get all allowed vario_ids
   - Use pool with dplyr
   - Returns tibble for caching/reuse
  </action>
  <verify>
- File exists at api/functions/ontology-repository.R
- All functions use db-helpers
- Validation uses pool with dplyr
- variation_ontology_replace_for_review uses transaction
  </verify>
  <done>
- ontology-repository.R created with 5 functions
- Validation before insert
- Replace operation uses transaction
  </done>
</task>

<task type="auto">
  <name>Task 3: Source repositories in start_sysndd_api.R</name>
  <files>api/start_sysndd_api.R</files>
  <action>
Add source lines for phenotype-repository.R and ontology-repository.R in start_sysndd_api.R.

Insert AFTER the publication-repository.R source line (added in plan 21-03):
```r
source("functions/phenotype-repository.R", local = TRUE)
source("functions/ontology-repository.R", local = TRUE)
```
  </action>
  <verify>
- `grep -n "phenotype-repository.R" api/start_sysndd_api.R` shows source line
- `grep -n "ontology-repository.R" api/start_sysndd_api.R` shows source line
  </verify>
  <done>
- Both repository files sourced in start_sysndd_api.R
  </done>
</task>

</tasks>

<verification>
- [ ] api/functions/phenotype-repository.R exists with ~70+ lines
- [ ] api/functions/ontology-repository.R exists with ~70+ lines
- [ ] Both use db-helpers functions
- [ ] No dbConnect() in either file
- [ ] Both sourced in start_sysndd_api.R
</verification>

<success_criteria>
- Phenotype repository provides: validate_ids, find_by_review, connect_to_review, replace_for_review, get_allowed_list
- Ontology repository provides: validate_ids, find_by_review, connect_to_review, replace_for_review, get_allowed_list
- All validation happens before database operations
- Replace operations use transactions
</success_criteria>

<output>
After completion, create `.planning/phases/21-repository-layer/21-04-SUMMARY.md`
</output>
