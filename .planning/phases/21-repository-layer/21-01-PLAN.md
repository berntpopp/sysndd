---
phase: 21-repository-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/functions/db-helpers.R
autonomous: true

must_haves:
  truths:
    - "All queries executed through db_execute_query or db_execute_statement"
    - "All transactions use db_with_transaction for atomic operations"
    - "Queries are logged at DEBUG level with sanitized parameters"
    - "Connection cleanup happens via on.exit() even on errors"
  artifacts:
    - path: "api/functions/db-helpers.R"
      provides: "Database query and transaction helpers"
      exports: ["db_execute_query", "db_execute_statement", "db_with_transaction"]
      min_lines: 100
  key_links:
    - from: "api/functions/db-helpers.R"
      to: "pool (global)"
      via: "Uses global pool object for connections"
      pattern: "pool"
    - from: "api/functions/db-helpers.R"
      to: "DBI::dbBind"
      via: "Parameterized query execution"
      pattern: "dbBind"
---

<objective>
Create the foundational database helper functions that all repositories will use.

Purpose: Establish a consistent, secure interface for database operations that eliminates SQL injection vulnerabilities and ensures proper connection cleanup. All subsequent repository functions will build on these helpers.

Output: `api/functions/db-helpers.R` with three core functions: `db_execute_query()` for SELECT operations, `db_execute_statement()` for INSERT/UPDATE/DELETE, and `db_with_transaction()` for multi-statement atomic operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-repository-layer/21-RESEARCH.md
@api/start_sysndd_api.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create db-helpers.R with query execution functions</name>
  <files>api/functions/db-helpers.R</files>
  <action>
Create `api/functions/db-helpers.R` with three core functions:

1. **db_execute_query(sql, params = list())** - For SELECT queries
   - Uses global `pool` object (already exists in start_sysndd_api.R line 136)
   - Accepts SQL with `?` placeholders (RMariaDB only supports positional, NOT `:name`)
   - Params must be unnamed list in placeholder order: `list(5, "value")`
   - Uses `DBI::dbSendQuery()` + `DBI::dbBind()` + `DBI::dbFetch()`
   - Registers cleanup via `on.exit(DBI::dbClearResult(result), add = TRUE)`
   - Returns tibble (never NULL - empty result = 0-row tibble with correct columns)
   - Logs query at DEBUG level using `logger::log_debug()` with sanitized params
   - On error: logs error and throws structured error via `rlang::abort()`

2. **db_execute_statement(sql, params = list())** - For INSERT/UPDATE/DELETE
   - Same pattern as db_execute_query but uses `DBI::dbSendStatement()`
   - Returns integer count of affected rows via `DBI::dbGetRowsAffected()`
   - Logs statement and affected row count at DEBUG level

3. **db_with_transaction(code)** - For multi-statement atomic operations
   - Checks out connection from pool: `conn <- pool::poolCheckout(pool)`
   - Registers return on exit: `on.exit(pool::poolReturn(conn), add = TRUE)`
   - Wraps code in `DBI::dbWithTransaction(conn, { force(code) })`
   - Automatic rollback on any error (dbWithTransaction handles this)
   - Logs transaction lifecycle (start/commit/rollback) at DEBUG level
   - On error: logs warning and throws structured error

Key implementation details:
- All functions use the global `pool` object (do NOT create new connections)
- Parameter sanitization for logging: redact strings > 50 chars, show "REDACTED"
- Error classes: `db_query_error`, `db_statement_error`, `db_transaction_error`
- Use `rlang::abort()` with `class`, `sql`, and `original_error` fields
  </action>
  <verify>
- File exists at api/functions/db-helpers.R
- Contains db_execute_query, db_execute_statement, db_with_transaction functions
- All three functions use `pool` global
- All use `on.exit()` for cleanup
- All use `logger::log_debug()` for logging
- All use `rlang::abort()` for errors with structured class
  </verify>
  <done>
- db-helpers.R created with all three functions
- Functions use parameterized queries via dbBind
- Proper cleanup via on.exit
- Structured error handling via rlang::abort
  </done>
</task>

<task type="auto">
  <name>Task 2: Source db-helpers.R in start_sysndd_api.R</name>
  <files>api/start_sysndd_api.R</files>
  <action>
Add source line for db-helpers.R in the "Load Additional Scripts" section of start_sysndd_api.R.

Insert AFTER line 106 (`source("functions/database-functions.R", local = TRUE)`):
```r
source("functions/db-helpers.R", local = TRUE)
```

This ensures db-helpers.R is loaded after database-functions.R (which will eventually be deprecated) but before other functions that will use the new helpers.
  </action>
  <verify>
- `grep -n "db-helpers.R" api/start_sysndd_api.R` shows the source line
- Line appears after database-functions.R source
  </verify>
  <done>
- db-helpers.R sourced in start_sysndd_api.R
- Loaded in correct order (after pool creation, before endpoint loading)
  </done>
</task>

<task type="auto">
  <name>Task 3: Create unit tests for db-helpers</name>
  <files>api/tests/testthat/test-db-helpers.R</files>
  <action>
Create test file `api/tests/testthat/test-db-helpers.R` with tests:

1. **Test db_execute_query returns tibble:**
   - Mock pool and DBI functions using testthat mocking
   - Verify returns tibble class
   - Verify empty result returns 0-row tibble (not NULL)

2. **Test db_execute_statement returns row count:**
   - Mock returns integer
   - Verify returns affected row count

3. **Test db_with_transaction rolls back on error:**
   - Create transaction that throws error mid-way
   - Verify transaction rolled back (no partial commits)

4. **Test parameter sanitization in logging:**
   - Use `testthat::local_mocked_bindings()` to capture log calls
   - Verify long strings are redacted in logs

Note: These are unit tests with mocked database. Integration tests will be added later in Phase 24.

Use existing test patterns from `api/tests/testthat/` for consistency.
  </action>
  <verify>
- File exists at api/tests/testthat/test-db-helpers.R
- `cd api && Rscript -e "testthat::test_file('tests/testthat/test-db-helpers.R')"` shows tests (may skip if pool not available, but file structure valid)
  </verify>
  <done>
- Unit tests created for db-helpers functions
- Tests cover: query returns tibble, statement returns count, transaction rollback, log sanitization
  </done>
</task>

</tasks>

<verification>
- [ ] api/functions/db-helpers.R exists with ~100+ lines
- [ ] Contains db_execute_query, db_execute_statement, db_with_transaction
- [ ] start_sysndd_api.R sources db-helpers.R
- [ ] Test file exists at api/tests/testthat/test-db-helpers.R
- [ ] No syntax errors: `Rscript -e "source('api/functions/db-helpers.R')"`
</verification>

<success_criteria>
- db-helpers.R provides foundation for all repository functions
- All three helpers use parameterized queries (no SQL injection)
- Proper resource cleanup via on.exit
- DEBUG logging for production debugging
- Structured errors for proper error handling
</success_criteria>

<output>
After completion, create `.planning/phases/21-repository-layer/21-01-SUMMARY.md`
</output>
