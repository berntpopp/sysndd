---
phase: 21-repository-layer
plan: 03
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - api/functions/status-repository.R
  - api/functions/publication-repository.R
  - api/start_sysndd_api.R
autonomous: true

must_haves:
  truths:
    - "Status CRUD operations use parameterized queries"
    - "Publication connection operations use parameterized queries"
    - "Status approval uses repository function with transaction"
    - "Publication validation happens before database insert"
  artifacts:
    - path: "api/functions/status-repository.R"
      provides: "Status domain database operations"
      exports: ["status_find_by_id", "status_create", "status_update", "status_approve", "status_find_by_entity"]
      min_lines: 100
    - path: "api/functions/publication-repository.R"
      provides: "Publication domain database operations"
      exports: ["publication_find_by_id", "publication_validate_ids", "publication_connect_to_review", "publication_find_with_context"]
      min_lines: 80
  key_links:
    - from: "api/functions/status-repository.R"
      to: "api/functions/db-helpers.R"
      via: "db_execute_query, db_execute_statement, db_with_transaction"
      pattern: "db_execute|db_with_transaction"
    - from: "api/functions/publication-repository.R"
      to: "api/functions/db-helpers.R"
      via: "db_execute_query, db_execute_statement"
      pattern: "db_execute"
---

<objective>
Create status and publication repositories.

Purpose: Status tracks entity categorization and approval state. Publication connects reviews to literature references. Both require validation against allowed values before database operations.

Output: `api/functions/status-repository.R` and `api/functions/publication-repository.R` with CRUD operations using db-helpers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-repository-layer/21-RESEARCH.md
@.planning/phases/21-repository-layer/21-01-SUMMARY.md
@api/functions/database-functions.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create status-repository.R</name>
  <files>api/functions/status-repository.R</files>
  <action>
Create `api/functions/status-repository.R` with functions that replace status operations in database-functions.R:

**Reference existing code:** See `put_post_db_status()` (line 744-873) and `put_db_status_approve()` (line 1132-1233) in database-functions.R.

1. **status_find_by_id(status_id)** - Find single status
   - SQL: `SELECT status_id, entity_id, category_id, problematic, status_approved, approving_user_id, is_active FROM ndd_entity_status WHERE status_id = ?`
   - Returns tibble

2. **status_find_by_entity(entity_id)** - Find all statuses for entity
   - SQL: `SELECT ... FROM ndd_entity_status WHERE entity_id = ? ORDER BY status_id DESC`
   - Returns tibble

3. **status_create(status_data)** - Create new status
   - Validate: category_id required, entity_id required
   - Remove status_id if accidentally provided (for POST requests)
   - SQL: `INSERT INTO ndd_entity_status (entity_id, category_id, problematic) VALUES (?, ?, ?)`
   - Get last insert ID
   - Returns integer status_id

4. **status_update(status_id, updates)** - Update status
   - Remove entity_id and status_id from updates (prevent changing associations)
   - Build SET clause dynamically
   - Returns affected row count

5. **status_approve(status_ids, approving_user_id, approved = TRUE)** - Approve/reject statuses
   - Handles single ID or vector of IDs
   - First get entity_ids for the statuses being approved
   - If approved:
     - Reset is_active = 0 for all statuses of same entities
     - Set is_active = 1, status_approved = 1, approving_user_id for these statuses
   - If not approved:
     - Set status_approved = 0, approving_user_id
   - Use db_with_transaction for atomic operation
   - Returns affected status_ids

6. **status_update_re_review_status(entity_id, status_id)** - Update re_review_entity_connect
   - SQL: `UPDATE re_review_entity_connect SET re_review_status_saved = 1, status_id = ? WHERE entity_id = ?`
   - Used when creating status in re-review context
   - Returns affected row count
  </action>
  <verify>
- File exists at api/functions/status-repository.R
- All functions use db-helpers
- No dbConnect() calls
- status_approve uses transaction
  </verify>
  <done>
- status-repository.R created with 6 functions
- Approval uses transaction for atomicity
- Updates prevent entity_id changes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create publication-repository.R</name>
  <files>api/functions/publication-repository.R</files>
  <action>
Create `api/functions/publication-repository.R` with functions that replace publication operations in database-functions.R:

**Reference existing code:** See `put_post_db_pub_con()` (line 366-469) in database-functions.R.

1. **publication_find_by_id(publication_id)** - Find single publication
   - SQL: `SELECT publication_id, pmid, title, publication_year FROM publication WHERE publication_id = ?`
   - Returns tibble

2. **publication_find_by_ids(publication_ids)** - Find multiple publications
   - Generate placeholders for IN clause
   - Handle empty input: return empty tibble with correct columns
   - Returns tibble

3. **publication_validate_ids(publication_ids)** - Validate publication IDs against allowed list
   - Use pool with dplyr: `pool %>% tbl("publication") %>% select(publication_id) %>% collect()`
   - Check all provided IDs exist
   - On invalid: `rlang::abort()` with class `publication_validation_error` and `invalid_ids` attribute
   - Returns TRUE if valid

4. **publication_connect_to_review(review_id, entity_id, publications)** - Connect publications to review
   - `publications` is tibble with publication_id, publication_type columns
   - Validate IDs first
   - Validate entity_id matches the review's entity_id (prevent changing associations)
   - SQL: `INSERT INTO ndd_review_publication_join (review_id, entity_id, publication_id, publication_type) VALUES (?, ?, ?, ?)`
   - Returns affected row count

5. **publication_replace_for_review(review_id, entity_id, publications)** - Replace all publications for review
   - Use db_with_transaction
   - First: `DELETE FROM ndd_review_publication_join WHERE review_id = ?`
   - Then: Insert new publications
   - Returns affected row count

6. **publication_find_with_context(publication_ids)** - Find publications with review/entity context
   - Join publication with ndd_review_publication_join and ndd_entity_review
   - Returns tibble with context data
  </action>
  <verify>
- File exists at api/functions/publication-repository.R
- All functions use db-helpers
- Validation uses pool with dplyr (not raw SQL)
- publication_replace_for_review uses transaction
  </verify>
  <done>
- publication-repository.R created with 6 functions
- Validation before insert
- Replace operation uses transaction
  </done>
</task>

<task type="auto">
  <name>Task 3: Source repositories in start_sysndd_api.R</name>
  <files>api/start_sysndd_api.R</files>
  <action>
Add source lines for status-repository.R and publication-repository.R in start_sysndd_api.R.

Insert AFTER the review-repository.R source line (added in plan 21-02):
```r
source("functions/status-repository.R", local = TRUE)
source("functions/publication-repository.R", local = TRUE)
```
  </action>
  <verify>
- `grep -n "status-repository.R" api/start_sysndd_api.R` shows source line
- `grep -n "publication-repository.R" api/start_sysndd_api.R` shows source line
  </verify>
  <done>
- Both repository files sourced in start_sysndd_api.R
  </done>
</task>

</tasks>

<verification>
- [ ] api/functions/status-repository.R exists with ~100+ lines
- [ ] api/functions/publication-repository.R exists with ~80+ lines
- [ ] Both use db-helpers functions
- [ ] No dbConnect() in either file
- [ ] Both sourced in start_sysndd_api.R
</verification>

<success_criteria>
- Status repository provides: find_by_id, find_by_entity, create, update, approve, update_re_review_status
- Publication repository provides: find_by_id, find_by_ids, validate_ids, connect_to_review, replace_for_review, find_with_context
- All validation happens before database operations
- Replace operations use transactions
</success_criteria>

<output>
After completion, create `.planning/phases/21-repository-layer/21-03-SUMMARY.md`
</output>
