---
phase: 21-repository-layer
plan: 08
type: execute
wave: 4
depends_on: ["21-06"]
files_modified:
  - api/endpoints/ontology_endpoints.R
  - api/endpoints/authentication_endpoints.R
  - api/endpoints/admin_endpoints.R
  - api/functions/publication-functions.R
  - api/functions/pubtator-functions.R
  - api/functions/logging-functions.R
autonomous: true

must_haves:
  truths:
    - "Zero dbConnect calls remain in any endpoint or function file"
    - "All scattered dbConnect calls eliminated"
    - "Connection pool used consistently across entire API"
    - "All endpoint and function files use db-helpers or repository functions consistently"
  artifacts:
    - path: "api/endpoints/ontology_endpoints.R"
      provides: "Refactored ontology endpoints"
      min_lines: 100
    - path: "api/endpoints/authentication_endpoints.R"
      provides: "Refactored authentication endpoints"
      min_lines: 150
    - path: "api/endpoints/admin_endpoints.R"
      provides: "Refactored admin endpoints"
      min_lines: 150
  key_links:
    - from: "api/endpoints/authentication_endpoints.R"
      to: "api/functions/user-repository.R"
      via: "user_find_for_auth"
      pattern: "user_find_for_auth"
    - from: "api/endpoints/admin_endpoints.R"
      to: "api/functions/db-helpers.R"
      via: "db_execute_query, db_execute_statement"
      pattern: "db_execute"
---

<objective>
Refactor remaining endpoint and function files to eliminate all dbConnect() calls.

Purpose: Complete the repository layer migration by refactoring the remaining files with scattered dbConnect() calls: ontology_endpoints.R (1), authentication_endpoints.R (1), admin_endpoints.R (2), publication-functions.R (1), pubtator-functions.R (1), logging-functions.R (1).

Output: Zero dbConnect() calls in the entire codebase (except for pool creation in start_sysndd_api.R).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-repository-layer/21-05-SUMMARY.md
@.planning/phases/21-repository-layer/21-06-SUMMARY.md
@api/endpoints/ontology_endpoints.R
@api/endpoints/authentication_endpoints.R
@api/endpoints/admin_endpoints.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor endpoint files</name>
  <files>api/endpoints/ontology_endpoints.R, api/endpoints/authentication_endpoints.R, api/endpoints/admin_endpoints.R</files>
  <action>
Refactor the remaining endpoint files:

**ontology_endpoints.R (line ~152):**
- This is likely an ontology update operation
- Replace dbConnect/dbExecute/dbDisconnect with db_execute_statement()
- Or use ontology-repository functions if applicable
- Ensure SQL uses `?` placeholders

**authentication_endpoints.R (line ~80):**
- This is user authentication/token refresh
- Replace with: `user_find_for_auth(email)` for password verification
- Keep JWT generation logic (not database-related)
- IMPORTANT: Never log password or password hash

**admin_endpoints.R (line ~140 and ~210):**
- These are admin operations (likely user management or data cleanup)
- Replace with appropriate repository functions or db_execute_statement()
- Ensure SQL uses parameterized queries
- Keep admin authorization checks
  </action>
  <verify>
- `grep -c "dbConnect" api/endpoints/ontology_endpoints.R` returns 0
- `grep -c "dbConnect" api/endpoints/authentication_endpoints.R` returns 0
- `grep -c "dbConnect" api/endpoints/admin_endpoints.R` returns 0
  </verify>
  <done>
- ontology_endpoints.R: dbConnect eliminated
- authentication_endpoints.R: dbConnect eliminated, uses user_find_for_auth
- admin_endpoints.R: both dbConnect calls eliminated
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor function files</name>
  <files>api/functions/publication-functions.R, api/functions/pubtator-functions.R, api/functions/logging-functions.R</files>
  <action>
Refactor the remaining function files:

**publication-functions.R (line ~82):**
- This is likely publication creation or lookup
- Replace with db_execute_query() or db_execute_statement()
- Or create publication-repository functions if needed
- Ensure SQL uses parameterized queries

**pubtator-functions.R (line ~96):**
- This is PubTator data insertion
- Replace with db_execute_statement() with parameterized SQL
- May need bulk insert pattern for multiple rows
- Keep PubTator API integration logic

**logging-functions.R (line ~153):**
- This is log table operations
- Replace with db_execute_query() or db_execute_statement()
- Ensure log data doesn't create SQL injection
  </action>
  <verify>
- `grep -c "dbConnect" api/functions/publication-functions.R` returns 0
- `grep -c "dbConnect" api/functions/pubtator-functions.R` returns 0
- `grep -c "dbConnect" api/functions/logging-functions.R` returns 0
  </verify>
  <done>
- publication-functions.R: dbConnect eliminated
- pubtator-functions.R: dbConnect eliminated
- logging-functions.R: dbConnect eliminated
  </done>
</task>

</tasks>

<verification>
- [ ] Zero dbConnect in endpoints/ (excluding tests)
- [ ] Zero dbConnect in functions/ (excluding database-functions.R comments if any)
- [ ] Only dbPool in start_sysndd_api.R for initial pool creation
- [ ] API starts without errors
- [ ] `grep -r "dbConnect" api/ --include="*.R" | grep -v "start_sysndd_api\|tests/" | wc -l` returns 0
- [ ] Comprehensive final check: `grep -rn "dbConnect" api/ --include="*.R" | grep -v "start_sysndd_api.R" | grep -v "tests/"` shows no matches
</verification>

<success_criteria>
- All 7 scattered dbConnect calls eliminated
- Zero dbConnect() calls in production code (only pool creation)
- All database operations use repository layer or db-helpers
- SQL injection vulnerabilities fixed
- API functional with repository layer
</success_criteria>

<output>
After completion, create `.planning/phases/21-repository-layer/21-08-SUMMARY.md`
</output>
