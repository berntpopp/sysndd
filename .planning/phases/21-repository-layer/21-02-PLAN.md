---
phase: 21-repository-layer
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - api/functions/entity-repository.R
  - api/functions/review-repository.R
  - api/start_sysndd_api.R
autonomous: true

must_haves:
  truths:
    - "Entity CRUD operations use parameterized queries"
    - "Review CRUD operations use parameterized queries"
    - "Entity deactivation uses repository function"
    - "Review creation/update uses repository function"
  artifacts:
    - path: "api/functions/entity-repository.R"
      provides: "Entity domain database operations"
      exports: ["entity_find_by_id", "entity_create", "entity_deactivate", "entity_find_with_reviews"]
      min_lines: 80
    - path: "api/functions/review-repository.R"
      provides: "Review domain database operations"
      exports: ["review_find_by_id", "review_create", "review_update", "review_approve", "review_find_by_entity"]
      min_lines: 120
  key_links:
    - from: "api/functions/entity-repository.R"
      to: "api/functions/db-helpers.R"
      via: "db_execute_query, db_execute_statement"
      pattern: "db_execute"
    - from: "api/functions/review-repository.R"
      to: "api/functions/db-helpers.R"
      via: "db_execute_query, db_execute_statement, db_with_transaction"
      pattern: "db_execute|db_with_transaction"
---

<objective>
Create entity and review repositories - the two most interconnected domains.

Purpose: Entity and review are the core of the SysNDD data model. Most operations involve creating/updating entities and their associated reviews. These repositories will handle the most common database operations.

Output: `api/functions/entity-repository.R` and `api/functions/review-repository.R` with CRUD operations using the db-helpers foundation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-repository-layer/21-RESEARCH.md
@.planning/phases/21-repository-layer/21-01-SUMMARY.md
@api/functions/database-functions.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create entity-repository.R</name>
  <files>api/functions/entity-repository.R</files>
  <action>
Create `api/functions/entity-repository.R` with functions that replace entity operations in database-functions.R:

**Reference existing code:** See `post_db_entity()` (line 23-99) and `put_db_entity_deactivation()` (line 129-169) in database-functions.R.

1. **entity_find_by_id(entity_id)** - Find single entity
   - SQL: `SELECT entity_id, hgnc_id, hpo_mode_of_inheritance_term, disease_ontology_id_version, ndd_phenotype, is_active, replaced_by, entry_date, entry_user_id FROM ndd_entity WHERE entity_id = ?`
   - Returns tibble (1 row or 0 rows)

2. **entity_create(entity_data)** - Create new entity
   - Validate required fields: hgnc_id, hpo_mode_of_inheritance_term, disease_ontology_id_version, ndd_phenotype, entry_user_id
   - On missing fields: `rlang::abort()` with class `entity_validation_error` and `missing_fields` attribute
   - SQL: `INSERT INTO ndd_entity (hgnc_id, hpo_mode_of_inheritance_term, disease_ontology_id_version, ndd_phenotype, entry_user_id) VALUES (?, ?, ?, ?, ?)`
   - Get last insert ID: `SELECT LAST_INSERT_ID() as entity_id`
   - Returns integer entity_id

3. **entity_deactivate(entity_id, replacement_id = NULL)** - Deactivate entity
   - SQL: `UPDATE ndd_entity SET is_active = 0, replaced_by = ? WHERE entity_id = ?`
   - Params: list(replacement_id, entity_id) - NULL allowed for replacement_id
   - Returns affected row count

4. **entity_find_with_reviews(entity_ids)** - Find entities with review data (eager loading)
   - Generate `?` placeholders for IN clause: `paste(rep("?", length(entity_ids)), collapse = ", ")`
   - Use `glue::glue()` for dynamic SQL (safe - only for placeholders, not values)
   - SQL joins ndd_entity with ndd_entity_review
   - Returns tibble with joined data

5. **entity_exists(entity_id)** - Check if entity exists
   - SQL: `SELECT 1 FROM ndd_entity WHERE entity_id = ? LIMIT 1`
   - Returns logical TRUE/FALSE
  </action>
  <verify>
- File exists at api/functions/entity-repository.R
- All functions use db_execute_query or db_execute_statement
- No dbConnect() calls in the file
- No paste0() with user input for SQL
  </verify>
  <done>
- entity-repository.R created with 5 functions
- All use parameterized queries via db-helpers
- Validation throws structured errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create review-repository.R</name>
  <files>api/functions/review-repository.R</files>
  <action>
Create `api/functions/review-repository.R` with functions that replace review operations in database-functions.R:

**Reference existing code:** See `put_post_db_review()` (line 196-340) and `put_db_review_approve()` (line 1011-1110) in database-functions.R.

1. **review_find_by_id(review_id)** - Find single review
   - SQL: `SELECT review_id, entity_id, synopsis, is_primary, review_approved, approving_user_id FROM ndd_entity_review WHERE review_id = ?`
   - Returns tibble

2. **review_find_by_entity(entity_id)** - Find all reviews for entity
   - SQL: `SELECT ... FROM ndd_entity_review WHERE entity_id = ? ORDER BY review_id DESC`
   - Returns tibble (0 or more rows)

3. **review_create(review_data)** - Create new review
   - Validate: synopsis (can be NA), entity_id required
   - Escape single quotes in synopsis: `str_replace_all(synopsis, "'", "''")`
   - SQL: `INSERT INTO ndd_entity_review (entity_id, synopsis) VALUES (?, ?)`
   - Get last insert ID
   - Returns integer review_id

4. **review_update(review_id, updates)** - Update review
   - Build SET clause dynamically for provided fields
   - Reset approval: set review_approved = 0, approving_user_id = NULL
   - Use db_with_transaction for atomic update
   - Returns affected row count

5. **review_approve(review_ids, approving_user_id, approved = TRUE)** - Approve/reject reviews
   - Handles single ID or vector of IDs
   - If approved:
     - Reset is_primary = 0 for all reviews of same entities
     - Set is_primary = 1, review_approved = 1, approving_user_id for these reviews
   - If not approved:
     - Set review_approved = 0, approving_user_id
   - Use db_with_transaction for atomic operation
   - Returns affected review_ids

6. **review_update_re_review_status(entity_id, review_id)** - Update re_review_entity_connect
   - SQL: `UPDATE re_review_entity_connect SET re_review_review_saved = 1, review_id = ? WHERE entity_id = ?`
   - Used when creating review in re-review context
   - Returns affected row count
  </action>
  <verify>
- File exists at api/functions/review-repository.R
- All functions use db_execute_query, db_execute_statement, or db_with_transaction
- No dbConnect() calls in the file
- review_approve uses transaction for multi-statement atomicity
  </verify>
  <done>
- review-repository.R created with 6 functions
- Complex operations (approve, update) use transactions
- Synopsis escaping handled
  </done>
</task>

<task type="auto">
  <name>Task 3: Source repositories in start_sysndd_api.R</name>
  <files>api/start_sysndd_api.R</files>
  <action>
Add source lines for entity-repository.R and review-repository.R in start_sysndd_api.R.

Insert AFTER the db-helpers.R source line (added in plan 21-01):
```r
source("functions/entity-repository.R", local = TRUE)
source("functions/review-repository.R", local = TRUE)
```

Order matters: db-helpers first, then repositories that depend on it.
  </action>
  <verify>
- `grep -n "entity-repository.R" api/start_sysndd_api.R` shows source line
- `grep -n "review-repository.R" api/start_sysndd_api.R` shows source line
- Both appear after db-helpers.R line
  </verify>
  <done>
- Both repository files sourced in start_sysndd_api.R
- Load order: db-helpers -> entity-repository -> review-repository
  </done>
</task>

</tasks>

<verification>
- [ ] api/functions/entity-repository.R exists with ~80+ lines
- [ ] api/functions/review-repository.R exists with ~120+ lines
- [ ] Both use db-helpers functions (grep for db_execute)
- [ ] No dbConnect() in either file
- [ ] Both sourced in start_sysndd_api.R
- [ ] No syntax errors: `Rscript -e "source('api/functions/entity-repository.R')"`
</verification>

<success_criteria>
- Entity repository provides: find_by_id, create, deactivate, find_with_reviews, exists
- Review repository provides: find_by_id, find_by_entity, create, update, approve, update_re_review_status
- All operations use parameterized queries
- Complex operations use transactions
- Validation errors are structured (rlang::abort with class)
</success_criteria>

<output>
After completion, create `.planning/phases/21-repository-layer/21-02-SUMMARY.md`
</output>
