---
phase: 21-repository-layer
plan: 07
type: execute
wave: 4
depends_on: ["21-06"]
files_modified:
  - api/endpoints/user_endpoints.R
  - api/endpoints/re_review_endpoints.R
autonomous: true

must_haves:
  truths:
    - "user_endpoints.R uses repository functions instead of direct dbConnect"
    - "re_review_endpoints.R uses repository functions instead of direct dbConnect"
    - "10 dbConnect calls in user_endpoints.R eliminated"
    - "5 dbConnect calls in re_review_endpoints.R eliminated"
  artifacts:
    - path: "api/endpoints/user_endpoints.R"
      provides: "User endpoints using repository layer"
      min_lines: 500
    - path: "api/endpoints/re_review_endpoints.R"
      provides: "Re-review endpoints using repository layer"
      min_lines: 400
  key_links:
    - from: "api/endpoints/user_endpoints.R"
      to: "api/functions/user-repository.R"
      via: "user_find_*, user_create, user_update"
      pattern: "user_"
    - from: "api/endpoints/re_review_endpoints.R"
      to: "api/functions/db-helpers.R"
      via: "db_execute_query, db_execute_statement"
      pattern: "db_execute"
---

<objective>
Refactor user_endpoints.R and re_review_endpoints.R to use the repository layer.

Purpose: These two endpoint files contain 15 direct dbConnect() calls that need to be replaced with repository function calls. This is the largest remaining source of connection management issues.

Output: Refactored endpoint files with zero direct database connections.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-repository-layer/21-05-SUMMARY.md
@.planning/phases/21-repository-layer/21-06-SUMMARY.md
@api/endpoints/user_endpoints.R
@api/endpoints/re_review_endpoints.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor user_endpoints.R</name>
  <files>api/endpoints/user_endpoints.R</files>
  <action>
Refactor all 10 dbConnect() calls in user_endpoints.R to use user-repository.R:

**Identify each dbConnect location and replace:**

1. **Line ~169** - User lookup for authentication:
   - Replace with: `user_find_for_auth(email)`

2. **Line ~218** - User lookup by email:
   - Replace with: `user_find_by_email(email)`

3. **Line ~261** - User creation:
   - Replace with: `user_create(user_data)`

4. **Line ~287** - User update:
   - Replace with: `user_update(user_id, updates)` or `user_update_password(user_id, hash)`

5. **Line ~468** - User lookup:
   - Replace with appropriate: `user_find_by_id(user_id)` or `user_find_by_email(email)`

6. **Line ~532** - Another user operation:
   - Replace with appropriate repository function

7. **Line ~631** - User update/password change:
   - Replace with: `user_update_password(user_id, new_hash)`

8. **Line ~691** - User lookup/verification:
   - Replace with: `user_find_by_id()` or `user_exists()`

9. **Line ~783** - User deactivation or update:
   - Replace with: `user_deactivate(user_id)` or `user_update()`

10. **Line ~832** - Final user operation:
    - Replace with appropriate repository function

**For each replacement:**
- Remove `sysndd_db <- dbConnect(...)` block
- Remove `dbDisconnect(sysndd_db)` block
- Replace `dbGetQuery()` / `dbExecute()` with repository call
- Keep error handling and response format
  </action>
  <verify>
- `grep -c "dbConnect" api/endpoints/user_endpoints.R` returns 0
- All user operations use user_* repository functions
- Password operations use user_find_for_auth or user_update_password (never log passwords)
  </verify>
  <done>
- 10 dbConnect calls eliminated from user_endpoints.R
- All operations use user-repository.R
- Password handling secure (no logging)
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor re_review_endpoints.R</name>
  <files>api/endpoints/re_review_endpoints.R</files>
  <action>
Refactor all 5 dbConnect() calls in re_review_endpoints.R:

**re_review_entity_connect is a specialized join table without its own repository.**
All operations on this table should use db-helpers directly: `db_execute_query()` for SELECT operations, `db_execute_statement()` for INSERT/UPDATE/DELETE operations.

**Identify each dbConnect location and replace:**

1. **Line ~39** - Re-review entity connection insert:
   - Replace with: `db_execute_statement(sql, params)` where sql is parameterized INSERT
   - Example: `db_execute_statement("INSERT INTO re_review_entity_connect (re_review_id, entity_id, status) VALUES (?, ?, ?)", list(re_review_id, entity_id, status))`

2. **Line ~89** - Re-review entity connection update:
   - Replace with: `db_execute_statement(sql, params)` with parameterized UPDATE
   - Watch for `paste0()` SQL injection patterns - convert to `?` placeholders
   - Example: `db_execute_statement("UPDATE re_review_entity_connect SET status = ? WHERE re_review_id = ? AND entity_id = ?", list(status, re_review_id, entity_id))`

3. **Line ~150** - Re-review entity lookup/update:
   - For SELECT: `db_execute_query(sql, params)`
   - For UPDATE: `db_execute_statement(sql, params)`

4. **Line ~524** - Re-review completion update:
   - Replace with: `db_execute_statement(sql, params)` with parameterized SQL

5. **Line ~587** - Final re-review operation:
   - Use `db_execute_query()` or `db_execute_statement()` based on operation type

**For ALL operations:**
- Use db-helpers directly (no repository needed for join table)
- Ensure all SQL uses `?` placeholders for parameters
- Remove all paste0() SQL construction with user input
- Parameters passed as list in second argument
  </action>
  <verify>
- `grep -c "dbConnect" api/endpoints/re_review_endpoints.R` returns 0
- All SQL uses parameterized queries (no paste0 with user input)
- Operations use db_execute_query or db_execute_statement from db-helpers.R
  </verify>
  <done>
- 5 dbConnect calls eliminated from re_review_endpoints.R
- All SQL parameterized with `?` placeholders
- Uses db_execute_query/db_execute_statement for all re_review_entity_connect operations
  </done>
</task>

</tasks>

<verification>
- [ ] `grep -c "dbConnect" api/endpoints/user_endpoints.R` returns 0
- [ ] `grep -c "dbConnect" api/endpoints/re_review_endpoints.R` returns 0
- [ ] No paste0() for SQL with user input in either file
- [ ] API starts successfully
</verification>

<success_criteria>
- Zero dbConnect() calls in user_endpoints.R
- Zero dbConnect() calls in re_review_endpoints.R
- All SQL uses parameterized queries
- Password operations secure (no logging)
- Existing endpoint behavior unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/21-repository-layer/21-07-SUMMARY.md`
</output>
