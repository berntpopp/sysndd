---
phase: 21-repository-layer
plan: 06
type: execute
wave: 3
depends_on: ["21-02", "21-03", "21-04", "21-05"]
files_modified:
  - api/functions/database-functions.R
autonomous: true

must_haves:
  truths:
    - "database-functions.R uses repository functions instead of direct dbConnect"
    - "All 16 dbConnect calls in database-functions.R eliminated"
    - "Existing API behavior unchanged (same inputs/outputs)"
    - "SQL injection vulnerabilities in database-functions.R fixed"
  artifacts:
    - path: "api/functions/database-functions.R"
      provides: "Refactored database functions using repositories"
      min_lines: 200
  key_links:
    - from: "api/functions/database-functions.R"
      to: "api/functions/entity-repository.R"
      via: "entity_create, entity_deactivate"
      pattern: "entity_"
    - from: "api/functions/database-functions.R"
      to: "api/functions/review-repository.R"
      via: "review_create, review_update, review_approve"
      pattern: "review_"
    - from: "api/functions/database-functions.R"
      to: "api/functions/status-repository.R"
      via: "status_create, status_update, status_approve"
      pattern: "status_"
---

<objective>
Refactor database-functions.R to use the new repository layer.

Purpose: database-functions.R contains the legacy database operations (1234 lines) with 16 direct dbConnect() calls and SQL injection vulnerabilities via paste0(). This plan refactors all functions to use the new repository layer, eliminating connection management and SQL injection.

Output: Refactored `api/functions/database-functions.R` that delegates all database operations to repository functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-repository-layer/21-02-SUMMARY.md
@.planning/phases/21-repository-layer/21-03-SUMMARY.md
@.planning/phases/21-repository-layer/21-04-SUMMARY.md
@.planning/phases/21-repository-layer/21-05-SUMMARY.md
@api/functions/database-functions.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor entity functions in database-functions.R</name>
  <files>api/functions/database-functions.R</files>
  <action>
Refactor the entity-related functions in database-functions.R to use entity-repository.R:

**post_db_entity() (lines 23-99):**
- Replace dbConnect/dbAppendTable/dbDisconnect with:
  ```r
  entity_id <- entity_create(list(
    hgnc_id = entity_received$hgnc_id,
    hpo_mode_of_inheritance_term = entity_received$hpo_mode_of_inheritance_term,
    disease_ontology_id_version = entity_received$disease_ontology_id_version,
    ndd_phenotype = entity_received$ndd_phenotype,
    entry_user_id = entity_received$entry_user_id
  ))
  ```
- Keep the same return format (status, message, entry)
- Keep validation of required columns

**put_db_entity_deactivation() (lines 102-169):**
- Replace dbConnect/dbExecute/dbDisconnect with:
  ```r
  entity_deactivate(entity_id, replacement)
  ```
- Remove the SQL injection via paste0()
- Keep the same return format
  </action>
  <verify>
- No dbConnect in post_db_entity
- No dbConnect in put_db_entity_deactivation
- Both functions call repository functions
- Return format unchanged
  </verify>
  <done>
- post_db_entity uses entity_create
- put_db_entity_deactivation uses entity_deactivate
- No direct database connections
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor review functions in database-functions.R</name>
  <files>api/functions/database-functions.R</files>
  <action>
Refactor review-related functions to use review-repository.R:

**put_post_db_review() (lines 172-340):**
- For POST: Replace dbConnect/dbAppendTable/dbGetQuery with:
  ```r
  review_id <- review_create(list(
    entity_id = review_received$entity_id,
    synopsis = review_received$synopsis
  ))
  if (re_review) {
    review_update_re_review_status(review_data$entity_id, review_id)
  }
  ```
- For PUT: Replace manual update query construction with:
  ```r
  review_update(review_received$review_id, review_received %>% select(-entity_id, -review_id))
  ```
- Keep synopsis quote escaping
- Keep the same return format

**put_db_review_approve() (lines 997-1110):**
- Replace all dbConnect/dbExecute/dbDisconnect with:
  ```r
  review_approve(review_id_requested, submit_user_id, review_ok)
  ```
- Keep the "all" handling (get non-approved review_ids first)
- Keep the same return format
  </action>
  <verify>
- No dbConnect in put_post_db_review
- No dbConnect in put_db_review_approve
- Both use repository functions
- Return format unchanged
  </verify>
  <done>
- put_post_db_review uses review_create, review_update
- put_db_review_approve uses review_approve
- No direct database connections
  </done>
</task>

<task type="auto">
  <name>Task 3: Refactor remaining functions in database-functions.R</name>
  <files>api/functions/database-functions.R</files>
  <action>
Refactor all remaining functions:

**put_post_db_pub_con() (lines 343-469):**
- For POST: `publication_connect_to_review(review_id, entity_id, publication_data)`
- For PUT: `publication_replace_for_review(review_id, entity_id, publication_data)`
- Keep publication_allowed validation using `publication_validate_ids()`

**put_post_db_phen_con() (lines 473-597):**
- For POST: `phenotype_connect_to_review(review_id, entity_id, phenotypes_data)`
- For PUT: `phenotype_replace_for_review(review_id, entity_id, phenotypes_data)`
- Keep phenotypes_allowed validation using `phenotype_validate_ids()`

**put_post_db_var_ont_con() (lines 600-725):**
- For POST: `variation_ontology_connect_to_review(review_id, entity_id, variation_ontology_data)`
- For PUT: `variation_ontology_replace_for_review(review_id, entity_id, variation_ontology_data)`
- Keep validation using `variation_ontology_validate_ids()`

**put_post_db_status() (lines 728-873):**
- For POST: `status_create(status_data)` + `status_update_re_review_status()` if re_review
- For PUT: `status_update(status_id, updates)`
- Keep validation of category_id/problematic

**put_db_status_approve() (lines 1114-1233):**
- Replace with: `status_approve(status_id_requested, submit_user_id, status_ok)`
- Keep "all" handling

**post_db_hash() (lines 876-994):**
- Use: `hash_validate_columns()`, `hash_exists()`, `hash_create()`
- Keep JSON sorting and hash generation in this function (not in repository)
  </action>
  <verify>
- `grep -c "dbConnect" api/functions/database-functions.R` returns 0
- All functions call repository functions
- No paste0() with user input for SQL
  </verify>
  <done>
- All 8 functions refactored to use repositories
- Zero dbConnect calls remain
- SQL injection vulnerabilities eliminated
  </done>
</task>

</tasks>

<verification>
- [ ] `grep -c "dbConnect" api/functions/database-functions.R` returns 0
- [ ] No paste0() used for SQL construction with user input
- [ ] All functions use repository calls
- [ ] Return formats unchanged (same status codes, messages)
- [ ] API still starts: `cd api && Rscript -e "source('start_sysndd_api.R')"`
</verification>

<success_criteria>
- Zero dbConnect() calls in database-functions.R
- All operations delegated to repositories
- SQL injection vulnerabilities fixed
- Existing function signatures unchanged (backward compatible)
- API startup successful
</success_criteria>

<output>
After completion, create `.planning/phases/21-repository-layer/21-06-SUMMARY.md`
</output>
