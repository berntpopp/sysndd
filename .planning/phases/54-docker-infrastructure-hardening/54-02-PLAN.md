---
phase: 54-docker-infrastructure-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - docker-compose.dev.yml
autonomous: true

must_haves:
  truths:
    - "All services have no-new-privileges security option"
    - "All services have CPU resource limits configured"
    - "All services have Docker log rotation configured"
    - "MySQL healthchecks use application user (not root)"
    - "API handles SIGTERM gracefully with pool closure"
  artifacts:
    - path: "docker-compose.yml"
      provides: "Production Docker Compose with security hardening"
      contains: "no-new-privileges:true"
    - path: "docker-compose.dev.yml"
      provides: "Development Docker Compose with matching config"
      contains: "no-new-privileges:true"
  key_links:
    - from: "docker-compose.yml"
      to: "all services"
      via: "security_opt, logging, deploy.resources.limits.cpus"
      pattern: "security_opt.*no-new-privileges"
    - from: "api/start_sysndd_api.R"
      to: "pool::poolClose"
      via: "cleanupHook exit handler"
      pattern: "pool::poolClose"
---

<objective>
Add security hardening and resource controls to Docker Compose services: no-new-privileges, CPU limits, log rotation, and improved healthchecks.

Purpose: Address HIGH priority security issues (no-new-privileges, CPU limits, log rotation) and MEDIUM priority improvements (MySQL healthcheck) from the Docker infrastructure review.

Output: Updated docker-compose.yml and docker-compose.dev.yml with security options, resource limits, and log rotation on all services.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-docker-infrastructure-hardening/54-RESEARCH.md
@docker-compose.yml
@docker-compose.dev.yml
@api/start_sysndd_api.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add security_opt, CPU limits, and log rotation to docker-compose.yml</name>
  <files>docker-compose.yml</files>
  <action>
Update `docker-compose.yml` with security hardening for each service:

**1. mysql service (around line 46-73):**
Add after `restart: unless-stopped`:
```yaml
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

Update healthcheck to use application user instead of root (line 65):
```yaml
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "${MYSQL_USER}", "-p${MYSQL_PASSWORD}"]
```

Add CPU limit in deploy.resources.limits (after memory: 1024M):
```yaml
          cpus: '1.0'
```

**2. mysql-cron-backup service (around line 75-98):**
Add after `restart: unless-stopped`:
```yaml
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

Add CPU limit in deploy.resources.limits (after memory: 256M):
```yaml
          cpus: '0.5'
```

**3. api service (around line 100-160):**
Add after `restart: unless-stopped`:
```yaml
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
```

Note: API gets larger log limits (50m x 5) due to request logging volume.

Add CPU limit in deploy.resources.limits (after memory: 4608M):
```yaml
          cpus: '2.0'
```

**4. app service (around line 162-184):**
Add after `restart: unless-stopped`:
```yaml
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

Add CPU limit in deploy.resources.limits (after memory: 256M):
```yaml
          cpus: '0.5'
```

**Note:** traefik already has `security_opt: no-new-privileges:true` (line 6-7). Only add logging and CPU limit to traefik:

After line 44 (`memory: 256M`), add:
```yaml
          cpus: '0.25'
```

Add logging config to traefik after `security_opt`:
```yaml
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```
  </action>
  <verify>
1. `grep -c "no-new-privileges:true" docker-compose.yml` returns 5 (all services)
2. `grep -c "max-size:" docker-compose.yml` returns 5 (all services have log rotation)
3. `grep "cpus:" docker-compose.yml | wc -l` returns 5 (all services have CPU limits)
4. `grep -A1 "mysqladmin.*ping" docker-compose.yml | grep -c "MYSQL_USER"` returns 1 (uses app user)
  </verify>
  <done>
- All 5 services have security_opt: no-new-privileges:true
- All 5 services have logging with max-size and max-file
- All 5 services have deploy.resources.limits.cpus
- MySQL healthcheck uses application user instead of root
  </done>
</task>

<task type="auto">
  <name>Task 2: Update docker-compose.dev.yml with matching security config</name>
  <files>docker-compose.dev.yml</files>
  <action>
Update `docker-compose.dev.yml` to match production security patterns for consistency:

**1. mysql-dev service (around line 21-43):**
Add after `restart: unless-stopped`:
```yaml
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

Update healthcheck to use application user (line 39):
```yaml
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "${MYSQL_USER:-bernt}", "-p${MYSQL_PASSWORD:-changeme}"]
```

**2. mysql-test service (around line 45-67):**
Add after `restart: unless-stopped`:
```yaml
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

Update healthcheck to use application user (line 63):
```yaml
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "${MYSQL_USER:-bernt}", "-p${MYSQL_PASSWORD:-changeme}"]
```

**3. mailpit service (around line 69-85):**
Add after `restart: unless-stopped`:
```yaml
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```
  </action>
  <verify>
1. `grep -c "no-new-privileges:true" docker-compose.dev.yml` returns 3 (all dev services)
2. `grep -c "max-size:" docker-compose.dev.yml` returns 3 (all dev services have log rotation)
3. `grep -A1 "mysqladmin.*ping" docker-compose.dev.yml | grep -c "MYSQL_USER"` returns 2 (both MySQL use app user)
  </verify>
  <done>
- All 3 dev services have security_opt: no-new-privileges:true
- All 3 dev services have logging with max-size and max-file
- Both MySQL healthchecks use application user instead of root
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify API graceful shutdown and test stack</name>
  <files>none (verification only)</files>
  <action>
Verify the existing cleanupHook in `api/start_sysndd_api.R` handles SIGTERM properly, then test the hardened stack:

**1. Verify existing graceful shutdown handler:**
The API already has a cleanupHook (lines 436-444 in start_sysndd_api.R):
```r
cleanupHook <- function(pr) {
  pr %>%
    pr_hook("exit", function() {
      pool::poolClose(pool)
      message("Disconnected from DB")
      daemons(0)  # Shutdown mirai daemon pool
      message("Shutdown mirai daemon pool")
    })
}
```

This already handles graceful shutdown - no code changes needed for DOCKER-08.

**2. Test the stack with hardened configuration:**
```bash
# Validate docker-compose syntax
docker compose config > /dev/null && echo "docker-compose.yml syntax OK"
docker compose -f docker-compose.dev.yml config > /dev/null && echo "docker-compose.dev.yml syntax OK"

# Start production stack
docker compose up -d

# Wait for services to be healthy
sleep 30

# Verify all services have no-new-privileges
docker inspect sysndd_mysql --format '{{.HostConfig.SecurityOpt}}' | grep -q "no-new-privileges" && echo "mysql: no-new-privileges OK"
docker inspect sysndd_api --format '{{.HostConfig.SecurityOpt}}' | grep -q "no-new-privileges" && echo "api: no-new-privileges OK"
docker inspect sysndd_app --format '{{.HostConfig.SecurityOpt}}' | grep -q "no-new-privileges" && echo "app: no-new-privileges OK"
docker inspect sysndd_traefik --format '{{.HostConfig.SecurityOpt}}' | grep -q "no-new-privileges" && echo "traefik: no-new-privileges OK"

# Verify log rotation is configured
docker inspect sysndd_api --format '{{.HostConfig.LogConfig.Config}}' | grep -q "max-size" && echo "api: log rotation OK"

# Verify CPU limits
docker inspect sysndd_api --format '{{.HostConfig.NanoCpus}}' | grep -q "2000000000" && echo "api: CPU limit 2.0 OK"

# Test graceful shutdown (API should close pool cleanly)
docker compose stop api
docker compose logs api 2>&1 | tail -20 | grep -q "Disconnected from DB" && echo "API graceful shutdown OK"

# Clean up
docker compose down
```

**3. Test dev stack:**
```bash
docker compose -f docker-compose.dev.yml up -d
sleep 15

# Verify MySQL uses app user in healthcheck
docker inspect sysndd_mysql_dev --format '{{.Config.Healthcheck.Test}}' | grep -q "MYSQL_USER" && echo "mysql-dev: app user healthcheck OK"

docker compose -f docker-compose.dev.yml down
```
  </action>
  <verify>
1. `docker compose config > /dev/null` exits with code 0 (valid syntax)
2. `docker inspect sysndd_api --format '{{.HostConfig.SecurityOpt}}'` contains "no-new-privileges"
3. `docker inspect sysndd_api --format '{{.HostConfig.LogConfig.Config}}'` shows max-size
4. `docker compose logs api | grep "Disconnected from DB"` confirms graceful shutdown
5. All services start and pass healthchecks
  </verify>
  <done>
- Docker Compose files have valid syntax
- All services have no-new-privileges security option applied
- All services have log rotation configured
- All services have CPU limits configured
- API graceful shutdown confirmed (pool close + daemon shutdown)
- MySQL healthchecks use application user
  </done>
</task>

</tasks>

<verification>
All DOCKER-04, DOCKER-05, DOCKER-06, DOCKER-08 requirements verified:

1. **DOCKER-04 (no-new-privileges):**
   ```bash
   for svc in sysndd_mysql sysndd_api sysndd_app sysndd_traefik; do
     docker inspect $svc --format '{{.HostConfig.SecurityOpt}}' | grep "no-new-privileges"
   done
   ```

2. **DOCKER-05 (CPU limits):**
   ```bash
   grep "cpus:" docker-compose.yml | wc -l  # Should be 5
   ```

3. **DOCKER-06 (Log rotation):**
   ```bash
   grep -c "max-size:" docker-compose.yml  # Should be 5
   grep -c "max-file:" docker-compose.yml  # Should be 5
   ```

4. **DOCKER-08 (Graceful shutdown):**
   - Existing cleanupHook in start_sysndd_api.R closes pool and shuts down daemons
   - `docker compose stop api && docker compose logs api | grep "Disconnected from DB"`
</verification>

<success_criteria>
1. All services have `security_opt: no-new-privileges:true`
2. All services have `deploy.resources.limits.cpus` configured
3. All services have `logging` with max-size and max-file
4. MySQL healthchecks use application user `${MYSQL_USER}` (not root)
5. API handles SIGTERM gracefully (closes pool, shuts down daemons)
6. Both docker-compose.yml and docker-compose.dev.yml pass syntax validation
7. All services start and pass healthchecks
</success_criteria>

<output>
After completion, create `.planning/phases/54-docker-infrastructure-hardening/54-02-SUMMARY.md`
</output>
