---
phase: 54-docker-infrastructure-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Dockerfile
  - app/docker/nginx/nginx.conf
  - app/docker/nginx/local.conf
autonomous: true

must_haves:
  truths:
    - "Nginx image uses pinned version v1.27.4 (not latest)"
    - "Static assets (js, css, fonts) return 1-year cache headers"
    - "Nginx access logs are enabled with buffered writes"
    - "Brotli compression is enabled for supported content types"
    - "tcp_nopush is enabled for sendfile efficiency"
  artifacts:
    - path: "app/Dockerfile"
      provides: "Pinned nginx-brotli image reference"
      contains: "fholzer/nginx-brotli:v1.27.4"
    - path: "app/docker/nginx/nginx.conf"
      provides: "Access logging, brotli, tcp_nopush configuration"
      contains: "access_log /var/log/nginx/access.log"
    - path: "app/docker/nginx/local.conf"
      provides: "Static asset caching location blocks"
      contains: "Cache-Control.*immutable"
  key_links:
    - from: "app/Dockerfile"
      to: "fholzer/nginx-brotli"
      via: "FROM directive"
      pattern: "FROM fholzer/nginx-brotli:v1\\.27\\.4"
    - from: "app/docker/nginx/local.conf"
      to: "app/docker/nginx/nginx.conf"
      via: "include directive"
      pattern: "include /etc/nginx/conf.d/\\*.conf"
---

<objective>
Harden nginx configuration with pinned image version, static asset caching, access logging, and brotli compression.

Purpose: Address CRITICAL issues (nginx version pinning, static asset caching) and HIGH priority nginx configuration improvements (access logging) from the Docker infrastructure review.

Output: Updated Dockerfile with pinned nginx image, nginx.conf with logging/brotli/tcp_nopush, local.conf with static asset caching locations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-docker-infrastructure-hardening/54-RESEARCH.md
@app/Dockerfile
@app/docker/nginx/nginx.conf
@app/docker/nginx/local.conf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pin nginx image and configure access logging with brotli</name>
  <files>app/Dockerfile, app/docker/nginx/nginx.conf</files>
  <action>
**app/Dockerfile changes:**
1. Change line 33 from `FROM fholzer/nginx-brotli:latest AS production` to `FROM fholzer/nginx-brotli:v1.27.4 AS production`
2. Add comment above explaining why pinned: `# Pin to specific version for reproducible builds and supply chain security`

**app/docker/nginx/nginx.conf changes:**
1. Change line 20 from `access_log off;` to:
   ```nginx
   access_log /var/log/nginx/access.log main buffer=32k flush=5s;
   ```

2. Change line 23 from `#tcp_nopush     on;` to:
   ```nginx
   tcp_nopush on;
   ```

3. After line 53 (after gzip_types block ends with semicolon), add brotli configuration:
   ```nginx
   # Brotli compression (15-20% better than gzip)
   # Module is pre-compiled in fholzer/nginx-brotli image
   brotli on;
   brotli_comp_level 6;
   brotli_types text/plain text/css text/xml text/javascript
                application/x-javascript application/javascript
                application/json application/xml application/xml+rss
                image/svg+xml font/eot font/otf font/ttf;
   ```

4. Remove the global Cache-Control headers from lines 83-85:
   - DELETE: `add_header "Expires" "-1";`
   - DELETE: `add_header "Cache-Control" "max-age=0, no-cache, no-store, must-revalidate";`
   - DELETE: `add_header "Pragma" "no-cache";`

   These are moved to location blocks in local.conf for proper per-content-type caching.
  </action>
  <verify>
1. `grep -n "v1.27.4" app/Dockerfile` shows line with pinned version
2. `grep -n "access_log.*buffer" app/docker/nginx/nginx.conf` shows buffered logging
3. `grep -n "brotli on" app/docker/nginx/nginx.conf` shows brotli enabled
4. `grep -n "tcp_nopush on" app/docker/nginx/nginx.conf` shows tcp_nopush enabled
5. `grep -c "max-age=0, no-cache" app/docker/nginx/nginx.conf` returns 0 (global cache headers removed)
  </verify>
  <done>
- Dockerfile uses pinned nginx image v1.27.4
- Access logging enabled with 32k buffer and 5s flush
- tcp_nopush enabled for sendfile efficiency
- Brotli compression configured with level 6
- Global no-cache headers removed (will be per-location)
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure static asset caching with proper Cache-Control headers</name>
  <files>app/docker/nginx/local.conf</files>
  <action>
Replace the entire `app/docker/nginx/local.conf` content with properly ordered location blocks:

```nginx
server {
    listen 8080;
    listen [::]:8080;
    server_name localhost;

    # Vite-generated hashed assets in /assets/ - 1 year cache with immutable
    # These files have content hashes in filenames (e.g., index-a1b2c3.js)
    # so they never change and can be cached indefinitely
    location ~* ^/assets/.*\.(js|css|woff2?|ttf|eot|svg)$ {
        root /usr/share/nginx/html;
        expires 1y;
        add_header Cache-Control "public, immutable, max-age=31536000" always;
        access_log off;
    }

    # Images - 30 day cache (may be updated without hash change)
    location ~* \.(jpg|jpeg|png|gif|ico|webp|avif)$ {
        root /usr/share/nginx/html;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000" always;
    }

    # HTML and root - no cache so app updates are picked up immediately
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
```

Key changes from original:
1. Added `/assets/` location block with 1-year immutable cache for Vite hashed assets
2. Added image location block with 30-day cache
3. Added explicit no-cache headers to root location (moved from global nginx.conf)
4. Location blocks ordered: most specific regex first, then general regex, then prefix match
  </action>
  <verify>
1. `grep -n "immutable" app/docker/nginx/local.conf` shows 1-year cache for assets
2. `grep -n "max-age=2592000" app/docker/nginx/local.conf` shows 30-day cache for images
3. `grep -n "no-cache, no-store" app/docker/nginx/local.conf` shows no-cache for root
4. File has three main location blocks (assets, images, root)
  </verify>
  <done>
- Vite hashed assets (/assets/*.js, *.css, fonts) get 1-year immutable cache
- Images get 30-day cache
- HTML/root gets no-cache for immediate app updates
- Security headers still applied from nginx.conf http block
  </done>
</task>

<task type="auto">
  <name>Task 3: Build and verify nginx configuration</name>
  <files>none (verification only)</files>
  <action>
Build the app container and verify nginx starts correctly with new configuration:

1. Build the app image:
   ```bash
   docker compose build app
   ```

2. Test nginx configuration syntax inside built image:
   ```bash
   docker run --rm sysndd-app nginx -t
   ```
   Expected output should include: `nginx: the configuration file /etc/nginx/nginx.conf syntax is ok`

3. Start the stack and verify caching headers:
   ```bash
   docker compose up -d app traefik
   sleep 10

   # Check that assets get immutable cache headers
   curl -sI http://localhost/assets/ 2>/dev/null | grep -i cache-control || echo "No /assets/ endpoint (expected - need actual asset path)"

   # Check that root gets no-cache headers
   curl -sI http://localhost/ | grep -i cache-control
   ```

4. Check access log is being written:
   ```bash
   # Make a few requests then check log exists
   curl -s http://localhost/ > /dev/null
   curl -s http://localhost/ > /dev/null
   docker exec sysndd_app cat /var/log/nginx/access.log | head -5
   ```

5. Check brotli is responding:
   ```bash
   # Request with Accept-Encoding: br to get brotli response
   curl -sI -H "Accept-Encoding: br, gzip" http://localhost/ | grep -i content-encoding
   ```
   Should show `content-encoding: br` for HTML content.

6. Clean up:
   ```bash
   docker compose down
   ```
  </action>
  <verify>
1. `docker compose build app` completes without error
2. `nginx -t` reports configuration syntax OK
3. Root path returns `Cache-Control: no-cache, no-store, must-revalidate`
4. Access log file exists and contains entries
5. Brotli-capable request returns `content-encoding: br`
  </verify>
  <done>
- App container builds successfully with pinned nginx image
- nginx configuration passes syntax validation
- Static asset caching headers work as expected
- Access logging writes to /var/log/nginx/access.log
- Brotli compression responds to br-capable clients
  </done>
</task>

</tasks>

<verification>
All DOCKER-01, DOCKER-02, DOCKER-03, DOCKER-07 requirements verified:

1. **DOCKER-01 (Pinned nginx):** `grep "v1.27.4" app/Dockerfile` returns match
2. **DOCKER-02 (Static caching):** `curl -sI http://localhost/assets/[any-js-file]` shows `Cache-Control: public, immutable, max-age=31536000`
3. **DOCKER-03 (Access logging):** `docker exec sysndd_app ls -la /var/log/nginx/access.log` shows log file exists
4. **DOCKER-07 (Brotli):** `curl -sI -H "Accept-Encoding: br" http://localhost/` shows `content-encoding: br`

Additional verifications:
- tcp_nopush enabled: `grep "tcp_nopush on" app/docker/nginx/nginx.conf`
- Global no-cache removed: `grep -c "Expires.*-1" app/docker/nginx/nginx.conf` returns 0
</verification>

<success_criteria>
1. App Dockerfile uses `fholzer/nginx-brotli:v1.27.4` (not `latest`)
2. Static assets in /assets/ return `Cache-Control: public, immutable, max-age=31536000`
3. Images return `Cache-Control: public, max-age=2592000`
4. Root/HTML returns `Cache-Control: no-cache, no-store, must-revalidate`
5. Access logs written to /var/log/nginx/access.log with buffering
6. Brotli compression returns .br encoded responses for supported content
7. tcp_nopush enabled for sendfile optimization
8. nginx -t passes configuration validation
</success_criteria>

<output>
After completion, create `.planning/phases/54-docker-infrastructure-hardening/54-01-SUMMARY.md`
</output>
