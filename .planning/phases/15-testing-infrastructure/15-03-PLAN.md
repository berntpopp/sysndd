---
phase: 15-testing-infrastructure
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - app/package.json
  - app/src/test-utils/mocks/server.ts
  - app/src/test-utils/mocks/handlers.ts
  - app/vitest.setup.ts
autonomous: true

must_haves:
  truths:
    - "MSW server intercepts API requests in tests"
    - "Handlers can be customized per test"
    - "Server resets between tests"
  artifacts:
    - path: "app/src/test-utils/mocks/server.ts"
      provides: "MSW server setup for Vitest"
      contains: "setupServer"
    - path: "app/src/test-utils/mocks/handlers.ts"
      provides: "Default API mock handlers"
      contains: "http"
  key_links:
    - from: "app/vitest.setup.ts"
      to: "app/src/test-utils/mocks/server.ts"
      via: "import and lifecycle hooks"
      pattern: "server\\.listen"
---

<objective>
Install and configure MSW (Mock Service Worker) for API mocking in tests.

Purpose: Enable realistic API mocking at the network level instead of vi.mock patterns.
Output: MSW installed and configured with example handlers for the SysNDD API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-testing-infrastructure/15-CONTEXT.md
@.planning/phases/15-testing-infrastructure/15-RESEARCH.md
@app/package.json
@app/vitest.setup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install MSW</name>
  <files>app/package.json</files>
  <action>
Install MSW (Mock Service Worker):

```bash
cd app && npm install --save-dev msw
```

MSW v2.x provides:
- Network-level request interception
- Realistic API mocking (not just function mocks)
- Request/response inspection
- Works with any HTTP client (axios, fetch, etc.)

MSW is preferred over vi.mock for API mocking per RESEARCH.md recommendations.
  </action>
  <verify>
Run `npm list msw` to confirm installation.
  </verify>
  <done>MSW installed in devDependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create MSW Handlers</name>
  <files>app/src/test-utils/mocks/handlers.ts</files>
  <action>
Create `app/src/test-utils/mocks/handlers.ts` with example handlers for SysNDD API:

```typescript
// test-utils/mocks/handlers.ts
/**
 * MSW request handlers for API mocking in tests.
 *
 * These handlers intercept HTTP requests and return mock responses.
 * Add handlers for API endpoints your tests need.
 *
 * @example
 * // In a test file, override a handler:
 * import { http, HttpResponse } from 'msw';
 * import { server } from '@/test-utils/mocks/server';
 *
 * it('handles error response', async () => {
 *   server.use(
 *     http.get('/api/genes/:id', () => {
 *       return HttpResponse.json({ error: 'Not found' }, { status: 404 });
 *     })
 *   );
 *   // ... test error handling
 * });
 */

import { http, HttpResponse } from 'msw';

/**
 * Default handlers for common API endpoints
 */
export const handlers = [
  // Auth endpoint - used by Navbar component
  http.get('/api/auth/signin', () => {
    return HttpResponse.json({
      user_name: ['test_user'],
      user_role: ['Viewer'],
    });
  }),

  // Gene endpoint example
  http.get('/api/genes/:symbol', ({ params }) => {
    const { symbol } = params;
    return HttpResponse.json({
      symbol,
      hgnc_id: 12345,
      name: `Test Gene ${symbol}`,
      entities: [],
    });
  }),

  // Entity endpoint example
  http.get('/api/entity/:id', ({ params }) => {
    const { id } = params;
    return HttpResponse.json({
      entity_id: id,
      symbol: 'TEST1',
      disease_ontology_id: 'OMIM:123456',
      category_id: 1,
    });
  }),

  // Search endpoint example
  http.get('/api/search', ({ request }) => {
    const url = new URL(request.url);
    const query = url.searchParams.get('query') || '';
    return HttpResponse.json({
      results: [
        { type: 'gene', symbol: 'TEST1', match: query },
        { type: 'disease', name: 'Test Disease', match: query },
      ],
      total: 2,
    });
  }),

  // Internet Archive endpoint (used by HelperBadge)
  http.get('/api/external/internet_archive', () => {
    return HttpResponse.json({
      job_id: 'test-job-123',
      status: 'pending',
    });
  }),

  // Generic error handler for unhandled requests during development
  // Remove or modify this in production tests
  http.get('/api/*', ({ request }) => {
    console.warn(`Unhandled API request: ${request.url}`);
    return HttpResponse.json(
      { error: 'Not mocked', url: request.url },
      { status: 500 }
    );
  }),
];

export default handlers;
```

Key design decisions:
- Handlers for endpoints used by components we'll test (Navbar, HelperBadge)
- Generic fallback handler warns about unmocked endpoints
- Each handler returns realistic response shapes
- Handlers can be overridden per-test using server.use()
  </action>
  <verify>
Run `npx tsc --noEmit -p tsconfig.json` - no TypeScript errors.
  </verify>
  <done>MSW handlers created for common API endpoints</done>
</task>

<task type="auto">
  <name>Task 3: Create MSW Server Setup</name>
  <files>app/src/test-utils/mocks/server.ts</files>
  <action>
Create `app/src/test-utils/mocks/server.ts`:

```typescript
// test-utils/mocks/server.ts
/**
 * MSW server setup for Node.js (Vitest) environment.
 *
 * This server intercepts HTTP requests during tests and returns mock responses
 * defined in handlers.ts.
 *
 * Lifecycle:
 * - beforeAll: server.listen() - start intercepting
 * - afterEach: server.resetHandlers() - restore default handlers
 * - afterAll: server.close() - stop intercepting
 *
 * These lifecycle hooks are configured in vitest.setup.ts
 */

import { setupServer } from 'msw/node';
import { handlers } from './handlers';

/**
 * MSW server instance for test environment
 * Use this to add per-test handler overrides
 */
export const server = setupServer(...handlers);

export default server;
```

This creates the MSW server with the default handlers.
  </action>
  <verify>
Run `npx tsc --noEmit -p tsconfig.json` - no TypeScript errors.
  </verify>
  <done>MSW server setup file created</done>
</task>

<task type="auto">
  <name>Task 4: Integrate MSW with Vitest Setup</name>
  <files>app/vitest.setup.ts</files>
  <action>
Update `app/vitest.setup.ts` to include MSW lifecycle hooks:

Add the following imports and lifecycle hooks (after existing content):

```typescript
// MSW Server Setup
import { server } from './src/test-utils/mocks/server';
import { beforeAll, afterEach, afterAll } from 'vitest';

// Start MSW server before all tests
beforeAll(() => {
  server.listen({ onUnhandledRequest: 'warn' });
});

// Reset handlers after each test (restore defaults)
afterEach(() => {
  server.resetHandlers();
});

// Close server after all tests
afterAll(() => {
  server.close();
});
```

The complete vitest.setup.ts should now have:
1. Browser API mocks (matchMedia, localStorage)
2. Per-test cleanup (clearAllMocks, restoreAllMocks)
3. MSW server lifecycle (listen, resetHandlers, close)

IMPORTANT: The onUnhandledRequest: 'warn' option logs warnings for unhandled requests
instead of failing the test, making it easier to identify missing handlers.
  </action>
  <verify>
Run `npm run test:unit` - should complete without MSW errors (no tests yet, but setup valid).
  </verify>
  <done>MSW integrated into vitest.setup.ts with lifecycle hooks</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. MSW installed: `npm list msw`
2. No TypeScript errors: `cd app && npx tsc --noEmit`
3. test-utils/mocks directory exists with server.ts and handlers.ts
4. vitest.setup.ts imports and starts MSW server
5. `npm run test:unit` runs without errors
</verification>

<success_criteria>
- MSW v2.x installed
- test-utils/mocks/handlers.ts created with SysNDD API mock handlers
- test-utils/mocks/server.ts created with setupServer
- vitest.setup.ts updated with MSW lifecycle hooks
- Server resets handlers between tests
</success_criteria>

<output>
After completion, create `.planning/phases/15-testing-infrastructure/15-03-SUMMARY.md`
</output>
