---
phase: 15-testing-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/package.json
  - app/vitest.config.ts
  - app/vitest.setup.ts
  - app/tsconfig.json
autonomous: true

must_haves:
  truths:
    - "Vitest test runner executes successfully"
    - "Coverage reporting generates output"
    - "Test setup file runs before tests"
  artifacts:
    - path: "app/vitest.config.ts"
      provides: "Vitest configuration with jsdom, coverage, globals"
      contains: "defineConfig"
    - path: "app/vitest.setup.ts"
      provides: "Global test setup with vitest-axe matchers"
      contains: "expect.extend"
    - path: "app/package.json"
      provides: "Test scripts (test:unit, test:coverage)"
      contains: "vitest"
  key_links:
    - from: "app/vitest.config.ts"
      to: "app/vitest.setup.ts"
      via: "setupFiles configuration"
      pattern: "setupFiles.*vitest.setup"
---

<objective>
Install and configure Vitest as the test framework for the Vue 3 + TypeScript frontend.

Purpose: Establish the foundational testing infrastructure that all other test plans depend on.
Output: Working Vitest installation with jsdom environment, coverage reporting, and test scripts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-testing-infrastructure/15-CONTEXT.md
@.planning/phases/15-testing-infrastructure/15-RESEARCH.md
@app/package.json
@app/vite.config.ts
@app/tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Vitest and Dependencies</name>
  <files>app/package.json</files>
  <action>
Install Vitest core and supporting packages:

```bash
cd app && npm install --save-dev vitest @vitest/coverage-v8 @vitest/ui jsdom
```

Packages to install:
- vitest: Test framework (4.0.17+)
- @vitest/coverage-v8: Coverage reporting using V8 provider (faster than istanbul)
- @vitest/ui: Visual test runner UI (optional but useful for development)
- jsdom: DOM environment (REQUIRED for vitest-axe compatibility - do NOT use happy-dom)

CRITICAL: Must use jsdom, not happy-dom. vitest-axe has compatibility issues with happy-dom due to Node.prototype.isConnected bug.
  </action>
  <verify>
Run `npm list vitest @vitest/coverage-v8 jsdom` to confirm packages installed.
Run `npx vitest --version` to confirm Vitest CLI works.
  </verify>
  <done>All Vitest packages installed in devDependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create Vitest Configuration</name>
  <files>app/vitest.config.ts</files>
  <action>
Create `app/vitest.config.ts` with the following configuration:

```typescript
import { fileURLToPath, URL } from 'node:url';
import { defineConfig, mergeConfig } from 'vitest/config';
import viteConfig from './vite.config';

export default mergeConfig(
  viteConfig,
  defineConfig({
    test: {
      globals: true,
      environment: 'jsdom',
      setupFiles: ['./vitest.setup.ts'],
      include: ['src/**/*.spec.ts'],
      exclude: [
        '**/node_modules/**',
        '**/dist/**',
      ],
      coverage: {
        provider: 'v8',
        reporter: ['text', 'json', 'html'],
        reportsDirectory: './coverage',
        include: ['src/**/*.{ts,vue}'],
        exclude: [
          '**/*.config.*',
          '**/main.ts',
          '**/router/**',
          '**/*.d.ts',
          '**/node_modules/**',
          '**/test-utils/**',
          '**/types/**',
        ],
        thresholds: {
          lines: 40,
          functions: 40,
          branches: 40,
          statements: 40,
        },
      },
    },
  })
);
```

Key configuration decisions:
- Merges with existing vite.config.ts to reuse plugins and aliases
- globals: true - enables describe/it/expect without imports
- environment: jsdom - MUST be jsdom for vitest-axe compatibility
- setupFiles - runs before each test file
- include: *.spec.ts - co-located test files
- coverage thresholds at 40% (warn only, per CONTEXT.md)
  </action>
  <verify>
Run `npx vitest run --config vitest.config.ts` - should complete (no tests yet, but config valid).
Run `cat app/vitest.config.ts | grep jsdom` - should show jsdom environment.
  </verify>
  <done>vitest.config.ts exists with jsdom environment and coverage configuration</done>
</task>

<task type="auto">
  <name>Task 3: Create Test Setup File and Update TypeScript Config</name>
  <files>app/vitest.setup.ts, app/tsconfig.json</files>
  <action>
Create `app/vitest.setup.ts` as the global test setup file:

```typescript
// vitest.setup.ts
// Global test setup - runs before each test file

import { expect, vi } from 'vitest';

// Extend expect with vitest-axe matchers (will be added in Plan 15-04)
// import { toHaveNoViolations } from 'vitest-axe';
// expect.extend(toHaveNoViolations);

// Mock window.matchMedia (required for Bootstrap components)
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: vi.fn().mockImplementation((query: string) => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: vi.fn(),
    removeListener: vi.fn(),
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn(),
  })),
});

// Mock localStorage
const localStorageMock = (() => {
  let store: Record<string, string> = {};
  return {
    getItem: vi.fn((key: string) => store[key] || null),
    setItem: vi.fn((key: string, value: string) => {
      store[key] = value;
    }),
    removeItem: vi.fn((key: string) => {
      delete store[key];
    }),
    clear: vi.fn(() => {
      store = {};
    }),
  };
})();
Object.defineProperty(window, 'localStorage', { value: localStorageMock });

// Reset mocks between tests
import { beforeEach, afterEach } from 'vitest';

beforeEach(() => {
  localStorageMock.clear();
  vi.clearAllMocks();
});

afterEach(() => {
  vi.restoreAllMocks();
});
```

Update `app/tsconfig.json` to include test files and Vitest types:

Add to the "include" array: "vitest.config.ts", "vitest.setup.ts"
Add to compilerOptions.types array: "vitest/globals"

Updated tsconfig.json should have:
```json
{
  "extends": "@vue/tsconfig/tsconfig.dom.json",
  "include": ["src/**/*", "src/**/*.vue", "vite.config.ts", "vitest.config.ts", "vitest.setup.ts"],
  "compilerOptions": {
    "strict": false,
    "noImplicitAny": false,
    "allowJs": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    },
    "types": ["node", "vite/client", "vitest/globals"]
  }
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` in app directory - should have no TypeScript errors.
Run `npx vitest run` - should complete with "No test files found" (expected, tests added later).
  </verify>
  <done>vitest.setup.ts exists with browser API mocks, tsconfig.json includes Vitest types</done>
</task>

<task type="auto">
  <name>Task 4: Add Test Scripts to package.json</name>
  <files>app/package.json</files>
  <action>
Add test scripts to app/package.json in the "scripts" section:

```json
{
  "scripts": {
    "test:unit": "vitest run",
    "test:watch": "vitest watch",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest run --coverage"
  }
}
```

Script purposes:
- test:unit: Run all tests once (CI mode)
- test:watch: Run tests in watch mode (development)
- test:ui: Open Vitest UI for visual test management
- test:coverage: Run tests with coverage report

Add these scripts alongside existing scripts (serve, build, lint, etc.).
  </action>
  <verify>
Run `npm run test:unit` - should complete with "No test files found" (expected).
Run `npm run test:coverage` - should generate coverage directory with empty report.
  </verify>
  <done>Test scripts added to package.json and functional</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd app && npm run test:unit` completes without errors
2. `cd app && npm run test:coverage` generates coverage/ directory
3. No TypeScript errors: `cd app && npx tsc --noEmit`
4. vitest.config.ts references vitest.setup.ts in setupFiles
</verification>

<success_criteria>
- Vitest 4.0+ installed with @vitest/coverage-v8 and jsdom
- vitest.config.ts configured with jsdom environment
- vitest.setup.ts created with browser API mocks
- tsconfig.json updated with Vitest types
- Test scripts added to package.json (test:unit, test:watch, test:ui, test:coverage)
- All scripts execute without errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-testing-infrastructure/15-01-SUMMARY.md`
</output>
