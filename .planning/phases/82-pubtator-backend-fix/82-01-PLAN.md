---
phase: 82-pubtator-backend-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/functions/pubtator-functions.R
  - api/tests/testthat/test-unit-pubtator-functions.R
autonomous: true

must_haves:
  truths:
    - "Incremental PubTator update fetches annotations only for PMIDs that lack them, not all PMIDs in the query"
    - "Retrying an annotation insert for the same PMID does not produce duplicate key errors"
    - "NCBI API calls are rate-limited at 350ms between requests (approximately 2.86 req/s)"
    - "R unit tests verify the LEFT JOIN filtering logic and INSERT IGNORE idempotency"
  artifacts:
    - path: "api/functions/pubtator-functions.R"
      provides: "Fixed incremental query, idempotent inserts, corrected rate limit"
      contains: "LEFT JOIN pubtator_annotation_cache"
    - path: "api/tests/testthat/test-unit-pubtator-functions.R"
      provides: "Unit tests for pubtator function fixes"
      min_lines: 60
  key_links:
    - from: "api/functions/pubtator-functions.R"
      to: "pubtator_annotation_cache table"
      via: "LEFT JOIN in PMID query"
      pattern: "LEFT JOIN pubtator_annotation_cache.*IS NULL"
    - from: "api/functions/pubtator-functions.R"
      to: "pubtator_annotation_cache table"
      via: "INSERT IGNORE for idempotent writes"
      pattern: "INSERT IGNORE INTO pubtator_annotation_cache"
    - from: "api/functions/pubtator-functions.R"
      to: "NCBI PubTator3 API"
      via: "rate limit delay constant"
      pattern: "PUBTATOR_RATE_LIMIT_DELAY <- 0\\.35"
---

<objective>
Fix three bugs in PubTator annotation fetching: (1) incremental updates re-fetch ALL PMIDs instead of only unannotated ones, (2) duplicate key errors on annotation insert retries, (3) rate limit delay is 2.5s instead of 350ms.

Purpose: Reduce redundant NCBI API calls by ~90% for incremental updates, eliminate duplicate key insert errors, and speed up annotation fetching 7x while staying within NCBI rate limits.

Output: Fixed `pubtator-functions.R` with LEFT JOIN filtering, INSERT IGNORE deduplication, and 350ms rate limit; plus unit tests verifying all three fixes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/82-pubtator-backend-fix/82-RESEARCH.md

@api/functions/pubtator-functions.R
@api/functions/db-helpers.R
@api/tests/testthat/helper-paths.R
@api/tests/testthat/helper-db-mock.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix pubtator-functions.R -- LEFT JOIN, INSERT IGNORE, rate limit</name>
  <files>api/functions/pubtator-functions.R</files>
  <action>
Make three targeted fixes in `api/functions/pubtator-functions.R`. Both the sync (`pubtator_db_update`) and async (`pubtator_db_update_async`) functions need identical fixes.

**Fix 1: Rate limit constant (line 23)**

Change:
```r
PUBTATOR_RATE_LIMIT_DELAY <- 2.5 # seconds between requests (24 req/min max)
```
To:
```r
PUBTATOR_RATE_LIMIT_DELAY <- 0.35 # seconds between requests (~2.86 req/s, under NCBI 3 req/s limit)
```

**Fix 2: LEFT JOIN query for incremental PMID filtering**

In `pubtator_db_update()` (around lines 291-294), change the PMID query from:
```r
pmid_rows <- db_execute_query(
  "SELECT pmid FROM pubtator_search_cache
 WHERE query_id=? AND pmid IS NOT NULL GROUP BY pmid",
  list(query_id)
)
```
To:
```r
pmid_rows <- db_execute_query(
  "SELECT DISTINCT s.pmid
   FROM pubtator_search_cache s
   LEFT JOIN pubtator_annotation_cache a ON s.pmid = a.pmid
   WHERE s.query_id = ? AND s.pmid IS NOT NULL
     AND a.annotation_id IS NULL",
  list(query_id)
)
```

Apply the same LEFT JOIN fix in `pubtator_db_update_async()` (around lines 575-578). The async version passes `conn = conn`, so:
```r
pmid_rows <- db_execute_query(
  "SELECT DISTINCT s.pmid
   FROM pubtator_search_cache s
   LEFT JOIN pubtator_annotation_cache a ON s.pmid = a.pmid
   WHERE s.query_id = ? AND s.pmid IS NOT NULL
     AND a.annotation_id IS NULL",
  list(query_id), conn = conn
)
```

Update the log message after the LEFT JOIN query to clarify it now shows unannotated PMIDs:
- Sync: `log_info("Found {length(pmid_vector)} unannotated PMIDs => fetching annotations...")`
- Async: `log_info("Fetching annotations for {length(pmid_vector)} unannotated PMIDs")`

**Fix 3: INSERT IGNORE for annotation cache inserts**

In `pubtator_db_update()` (around lines 334-341), change `INSERT INTO` to `INSERT IGNORE INTO`:
```r
db_execute_statement(
  "INSERT IGNORE INTO pubtator_annotation_cache
  (search_id, pmid, id, text, identifier, type, ncbi_homologene, valid,
   normalized, `database`, normalized_id, biotype, name, accession)
 VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",
  unname(as.list(df_ann[r, ]))
)
```

Apply the same INSERT IGNORE fix in `pubtator_db_update_async()` (around lines 602-626):
```r
db_execute_statement(
  "INSERT IGNORE INTO pubtator_annotation_cache
   (search_id, pmid, id, text, identifier, type, ncbi_homologene, valid,
    normalized, `database`, normalized_id, biotype, name, accession)
   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",
  list(...),
  conn = conn
)
```

**Important:** Only change the annotation cache INSERT statements. Do NOT change the search cache INSERTs (those use `query_id + pmid` which are genuinely new rows during page fetching). Do NOT change the `INSERT INTO pubtator_query_cache` statement either.

**Important:** Keep all other code unchanged. The structure, indentation, and all other logic remain exactly as-is.
  </action>
  <verify>
Run `grep -n "INSERT IGNORE" api/functions/pubtator-functions.R` -- should show exactly 2 matches (one in sync function, one in async function), both for `pubtator_annotation_cache`.

Run `grep -n "LEFT JOIN pubtator_annotation_cache" api/functions/pubtator-functions.R` -- should show exactly 2 matches (one in sync, one in async).

Run `grep -n "PUBTATOR_RATE_LIMIT_DELAY" api/functions/pubtator-functions.R` -- the first match should show `0.35`.

Run `grep -c "INSERT INTO pubtator_annotation_cache" api/functions/pubtator-functions.R` -- should return 0 (all annotation inserts now use INSERT IGNORE).

Run `grep -c "INSERT INTO pubtator_search_cache" api/functions/pubtator-functions.R` -- should still show original count (search cache inserts unchanged).

Run `cd /home/bernt-popp/development/sysndd && make lint-api` to verify no lintr regressions.
  </verify>
  <done>
1. PMID query in both sync and async functions uses LEFT JOIN with `WHERE a.annotation_id IS NULL` to filter only unannotated PMIDs
2. Annotation cache INSERTs in both functions use `INSERT IGNORE` (2 total occurrences)
3. `PUBTATOR_RATE_LIMIT_DELAY` is `0.35` with updated comment
4. Search cache INSERTs and query cache INSERTs are unchanged
5. R lintr passes with no new warnings
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for pubtator function fixes</name>
  <files>api/tests/testthat/test-unit-pubtator-functions.R</files>
  <action>
Create `api/tests/testthat/test-unit-pubtator-functions.R` with unit tests covering all three fixes. Use `local_mocked_bindings()` (from testthat/withr) to mock `db_execute_query` and `db_execute_statement` since the functions under test use these helpers.

Follow the project test pattern: source the file under test, mock DB helpers, verify SQL strings.

**Test structure:**

```r
# test-unit-pubtator-functions.R
# Unit tests for PubTator function fixes (Phase 82)
#
# Tests verify:
# - LEFT JOIN filtering returns only unannotated PMIDs
# - INSERT IGNORE used for annotation cache writes
# - Rate limit delay is 0.35s (350ms)
```

**Test 1: Rate limit constant value**
```r
test_that("PUBTATOR_RATE_LIMIT_DELAY is 0.35 seconds", {
  expect_equal(PUBTATOR_RATE_LIMIT_DELAY, 0.35)
})
```

**Test 2: Rate limit constant is under NCBI limit**
```r
test_that("Rate limit delay yields under 3 requests per second", {
  requests_per_second <- 1 / PUBTATOR_RATE_LIMIT_DELAY
  expect_lt(requests_per_second, 3.0)
})
```

**Test 3: Verify LEFT JOIN query appears in sync function source**
Read the source file and verify the SQL pattern is present. Use `readLines()` on the source file path to check that the LEFT JOIN pattern exists.
```r
test_that("pubtator_db_update contains LEFT JOIN for unannotated PMIDs", {
  src <- readLines(file.path(get_api_dir(), "functions", "pubtator-functions.R"))
  src_text <- paste(src, collapse = "\n")
  # Check LEFT JOIN pattern exists
  expect_true(grepl("LEFT JOIN pubtator_annotation_cache", src_text, fixed = TRUE))
  # Check IS NULL filter exists
  expect_true(grepl("annotation_id IS NULL", src_text, fixed = TRUE))
})
```

**Test 4: Verify INSERT IGNORE in annotation cache inserts**
```r
test_that("Annotation cache inserts use INSERT IGNORE", {
  src <- readLines(file.path(get_api_dir(), "functions", "pubtator-functions.R"))
  src_text <- paste(src, collapse = "\n")
  # No plain INSERT INTO pubtator_annotation_cache should exist
  plain_inserts <- grepl("INSERT INTO pubtator_annotation_cache", src_text, fixed = TRUE)
  ignore_inserts <- grepl("INSERT IGNORE INTO pubtator_annotation_cache", src_text, fixed = TRUE)
  expect_false(plain_inserts && !ignore_inserts)
  expect_true(ignore_inserts)
})
```

**Test 5: Verify no INSERT IGNORE on search_cache (only annotation_cache)**
```r
test_that("Search cache inserts do NOT use INSERT IGNORE", {
  src <- readLines(file.path(get_api_dir(), "functions", "pubtator-functions.R"))
  src_text <- paste(src, collapse = "\n")
  expect_false(grepl("INSERT IGNORE INTO pubtator_search_cache", src_text, fixed = TRUE))
})
```

**Test 6: Behavioral test -- mock db_execute_query to verify LEFT JOIN SQL is passed**
Mock `db_execute_query` to capture the SQL string that gets called during the annotation fetch phase. Create a minimal test that sources the function, then calls a helper that extracts the annotation PMID query. Since `pubtator_db_update` is complex (calls external APIs), isolate the SQL verification:

```r
test_that("PMID query SQL includes LEFT JOIN and IS NULL filter", {
  # Extract the SQL from the source code between the PMID query markers
  src <- readLines(file.path(get_api_dir(), "functions", "pubtator-functions.R"))

  # Find lines containing the PMID query for annotation fetch
  # Look for the distinctive LEFT JOIN pattern
  left_join_lines <- grep("LEFT JOIN pubtator_annotation_cache a ON s\\.pmid = a\\.pmid", src)
  expect_gte(length(left_join_lines), 2,
    label = "LEFT JOIN should appear in both sync and async functions"
  )

  # For each LEFT JOIN occurrence, verify IS NULL follows within 3 lines
  for (line_num in left_join_lines) {
    context_lines <- src[line_num:min(line_num + 3, length(src))]
    context_text <- paste(context_lines, collapse = " ")
    expect_true(
      grepl("annotation_id IS NULL", context_text),
      label = paste("IS NULL filter should follow LEFT JOIN near line", line_num)
    )
  }
})
```

**Test 7: Count of INSERT IGNORE occurrences**
```r
test_that("INSERT IGNORE appears exactly twice (sync + async)", {
  src <- readLines(file.path(get_api_dir(), "functions", "pubtator-functions.R"))
  ignore_lines <- grep("INSERT IGNORE INTO pubtator_annotation_cache", src)
  expect_equal(length(ignore_lines), 2)
})
```

**Test 8: pubtator_rate_limited_call uses PUBTATOR_RATE_LIMIT_DELAY**
```r
test_that("pubtator_rate_limited_call sleeps for PUBTATOR_RATE_LIMIT_DELAY", {
  sleep_calls <- c()
  local_mocked_bindings(
    Sys.sleep = function(time) { sleep_calls <<- c(sleep_calls, time) },
    .package = "base"
  )
  # Call with a simple function that succeeds immediately
  result <- pubtator_rate_limited_call(function() "ok")
  expect_equal(result, "ok")
  # Should have slept once for the rate limit delay
  expect_true(any(abs(sleep_calls - 0.35) < 0.001))
})
```

Use `source_api_file()` from `helper-paths.R` to load the pubtator functions. Load required packages at top: `library(testthat)`, `library(dplyr)`, `library(tidyverse)`.

Source the file under test using the project pattern:
```r
source_api_file("functions/pubtator-functions.R", local = FALSE)
```

Note: Some tests verify source code patterns (static analysis) rather than runtime behavior, because the full `pubtator_db_update()` function requires database + API connections. The static tests confirm the SQL patterns are correct. The behavioral test for `pubtator_rate_limited_call` validates the rate limit is actually used.
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd && Rscript -e "testthat::test_file('api/tests/testthat/test-unit-pubtator-functions.R')"` -- all tests should pass.

Run `cd /home/bernt-popp/development/sysndd && make lint-api` -- no lintr regressions.
  </verify>
  <done>
1. `test-unit-pubtator-functions.R` exists with 8+ tests covering all three fix areas
2. Tests verify PUBTATOR_RATE_LIMIT_DELAY equals 0.35
3. Tests verify LEFT JOIN pattern appears exactly twice (sync + async) with IS NULL filter
4. Tests verify INSERT IGNORE appears exactly twice for annotation_cache only
5. Tests verify search_cache inserts are NOT changed to INSERT IGNORE
6. Tests verify pubtator_rate_limited_call uses the 350ms delay
7. All tests pass when run via testthat
  </done>
</task>

</tasks>

<verification>
1. `grep -c "LEFT JOIN pubtator_annotation_cache" api/functions/pubtator-functions.R` returns `2`
2. `grep -c "INSERT IGNORE INTO pubtator_annotation_cache" api/functions/pubtator-functions.R` returns `2`
3. `grep -c "INSERT INTO pubtator_annotation_cache" api/functions/pubtator-functions.R` returns `0` (all replaced by INSERT IGNORE)
4. `grep "PUBTATOR_RATE_LIMIT_DELAY <-" api/functions/pubtator-functions.R` shows `0.35`
5. `make lint-api` passes
6. `Rscript -e "testthat::test_file('api/tests/testthat/test-unit-pubtator-functions.R')"` -- all pass
7. Search cache INSERT statements remain as plain `INSERT INTO` (not changed)
</verification>

<success_criteria>
- Incremental PMID query uses LEFT JOIN to exclude already-annotated PMIDs (API-01)
- Annotation cache INSERTs use INSERT IGNORE for idempotent writes (API-02)
- Rate limit delay is 0.35 seconds / 350ms (API-03)
- Both sync and async function versions have all three fixes applied identically
- Unit tests verify all fixes and pass
- No lintr regressions
</success_criteria>

<output>
After completion, create `.planning/phases/82-pubtator-backend-fix/82-01-SUMMARY.md`
</output>
