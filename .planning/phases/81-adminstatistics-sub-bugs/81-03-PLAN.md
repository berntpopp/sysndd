# Phase 81 Plan 03: Entity Trend Chart Filter Controls

**Goal:** Add NDD/Non-NDD/All toggle, Combined/By Category display mode, and per-category checkbox filters to the Entity Submissions Over Time chart in AdminStatistics

**Depends on:** 81-02 (AbortController, safeArray, trendData architecture)

---

## Context

The Entity Submissions Over Time chart shows only NDD entities as a single merged cumulative line. The API already supports flexible filtering via the `filter` parameter and returns per-category grouped data, but the frontend hardcodes NDD-only and always merges groups into one line. Users want controls to toggle NDD vs non-NDD vs all entities, show per-category breakdown lines, and filter to specific categories.

## Approach

**Frontend-only changes** -- the API endpoint `/api/statistics/entities_over_time` already supports all needed filtering via the `filter` query parameter.

## Tasks

### Task 1: Add `extractPerGroupSeries()` to `timeSeriesUtils.ts`

New exported function that returns per-group cumulative arrays with forward-fill (same date union logic as `mergeGroupedCumulativeSeries`, but returns separate arrays per group). Add 4 unit tests.

### Task 2: Enhance `EntityTrendChart.vue` with multi-line category support

- Add `categoryData`, `displayMode`, `yMax` props
- Add category color map (Definitive=#4caf50, Moderate=#2196f3, Limited=#ff9800, Refuted=#f44336)
- Branch `chartData` computed: combined mode (existing single-line) vs by_category mode (one line per group)
- Make `chartOptions` a computed that uses `suggestedMax: props.yMax` for fixed y-axis
- Update tooltip label to include dataset name

### Task 3: Add filter controls and state to `AdminStatistics.vue`

- Import `BFormCheckboxGroup` and `extractPerGroupSeries`
- Add reactive state: `nddFilter` (ndd/non_ndd/all), `categoryDisplay` (combined/by_category), `selectedCategories` (string[])
- Add `trendCategoryData` ref for per-category chart data
- Add `trendYMax` ref as running maximum for fixed y-axis
- Add `buildTrendFilter()` helper that constructs API filter string; returns `undefined` when matching API default (avoids URL encoding issues)
- Add `trendDescription` computed for dynamic description text
- Add watchers: `nddFilter` resets yMax and refetches; `selectedCategories` refetches only; `granularity` refetches
- Remove redundant `@change="fetchTrendData"` from granularity radio (watcher handles it)
- Update `fetchTrendData()`: conditionally include filter param, compute both combined and per-category data, track running yMax
- Add template controls: NDD radio group, Combined/By Category radio group, category checkbox group
- Pass `categoryData`, `displayMode`, `showMovingAverage`, `yMax` to chart component

## Pitfalls

1. **URL encoding of filter commas/parentheses** -- Axios may encode `contains(ndd_phenotype_word,Yes)` in ways the API's `generate_filter_expressions()` doesn't expect. Solution: omit `filter` param entirely when it matches the API default.
2. **`equals(1,1)` is invalid** -- `1` is not a column name. Use empty string `''` for "no filter" (API handles this correctly).
3. **Double-fetch on granularity change** -- `@change` handler + `watch()` both fire. Remove `@change`.
4. **Y-axis rescaling on category toggle** -- `trendYMax` must be a running maximum, only reset when NDD filter changes (different dataset).
5. **Service worker caching** -- Stale service workers can serve old webpack builds; verify with Playwright that v0.8.0 code is served.

## Verification

1. `npx vue-tsc --noEmit` -- no TypeScript errors
2. `npx eslint` on modified files -- no ESLint errors
3. `npx vitest run src/utils/__tests__/timeSeriesUtils.spec.ts` -- 14 tests pass (8 existing + 4 new + 2 edge cases)
4. Playwright manual test:
   - Toggle NDD/Non-NDD/All -- chart refetches, KPI updates, no errors
   - Toggle Combined/By Category -- chart switches between single and multi-line
   - Uncheck categories -- chart refetches with filtered data, y-axis stays fixed
   - Switch granularity while in by-category mode -- chart re-renders correctly
   - No console errors throughout
