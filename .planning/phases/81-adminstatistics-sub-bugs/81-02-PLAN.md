---
phase: 81-adminstatistics-sub-bugs
plan: 02
type: execute
wave: 2
depends_on: ["81-01"]
files_modified:
  - app/src/utils/dateUtils.ts
  - app/src/utils/apiUtils.ts
  - app/src/views/admin/AdminStatistics.vue
  - app/src/utils/__tests__/dateUtils.spec.ts
  - app/src/utils/__tests__/apiUtils.spec.ts
autonomous: true

must_haves:
  truths:
    - "totalEntities KPI is derived inside fetchTrendData() with no cross-function race condition in Promise.all()"
    - "Date range 'Jan 10 to Jan 20' computes as 11 days (inclusive), and previous period comparison uses equal-length periods"
    - "Switching granularity immediately clears stale chart data, cancels in-flight requests via AbortController, and shows a loading spinner until fresh data arrives"
    - "API responses that return error shapes or null data do not crash the admin view; negative bar values are clamped to zero"
  artifacts:
    - path: "app/src/utils/dateUtils.ts"
      provides: "inclusiveDayCount() and previousPeriod() date utilities"
      exports: ["inclusiveDayCount", "previousPeriod"]
    - path: "app/src/utils/apiUtils.ts"
      provides: "safeArray() and clampPositive() defensive utilities"
      exports: ["safeArray", "clampPositive"]
    - path: "app/src/utils/__tests__/dateUtils.spec.ts"
      provides: "Unit tests for date utilities"
      contains: "inclusiveDayCount"
    - path: "app/src/utils/__tests__/apiUtils.spec.ts"
      provides: "Unit tests for API utilities"
      contains: "safeArray"
  key_links:
    - from: "app/src/views/admin/AdminStatistics.vue"
      to: "app/src/utils/dateUtils.ts"
      via: "import { inclusiveDayCount, previousPeriod }"
      pattern: "inclusiveDayCount|previousPeriod"
    - from: "app/src/views/admin/AdminStatistics.vue"
      to: "app/src/utils/apiUtils.ts"
      via: "import { safeArray }"
      pattern: "safeArray"
    - from: "app/src/views/admin/AdminStatistics.vue"
      to: "AbortController"
      via: "trendAbortController created per request, abort on granularity change, nulled after success"
      pattern: "AbortController|trendAbortController"
    - from: "app/src/views/admin/AdminStatistics.vue"
      to: "fetchTrendData"
      via: "totalEntities computed inside fetchTrendData, not in fetchKPIStats"
      pattern: "kpiStats\\.value\\.totalEntities.*=.*trendData"
---

<objective>
Fix KPI race condition, date calculation off-by-one, add AbortController for granularity changes, and add defensive data utilities.

Purpose: The AdminStatistics view has four interrelated bugs: (1) totalEntities KPI reads from trendData before fetchTrendData() finishes because both run in Promise.all(); (2) date range calculations are off by one day (exclusive instead of inclusive); (3) switching granularity does not cancel in-flight requests, leading to stale data rendering; (4) API error responses can crash .map() calls on undefined data. These all affect KPI accuracy and UI stability.

Output: Two new utility files (`dateUtils.ts`, `apiUtils.ts`) with unit tests, a refactored AdminStatistics.vue with AbortController, fixed race condition, and defensive data handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/81-adminstatistics-sub-bugs/81-RESEARCH.md
@.planning/phases/81-adminstatistics-sub-bugs/81-01-SUMMARY.md

@app/src/views/admin/AdminStatistics.vue
@app/src/utils/clusterColors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dateUtils.ts and apiUtils.ts with unit tests</name>
  <files>
    app/src/utils/dateUtils.ts
    app/src/utils/apiUtils.ts
    app/src/utils/__tests__/dateUtils.spec.ts
    app/src/utils/__tests__/apiUtils.spec.ts
  </files>
  <action>
    1. Create `app/src/utils/dateUtils.ts` with two exported functions:

    ```typescript
    const MS_PER_DAY = 1000 * 60 * 60 * 24;

    /**
     * Count days inclusively between two dates.
     * "Jan 10 to Jan 20" = 11 days (both endpoints included).
     */
    export function inclusiveDayCount(start: Date | string, end: Date | string): number {
      const s = typeof start === 'string' ? new Date(start) : start;
      const e = typeof end === 'string' ? new Date(end) : end;
      return Math.round(Math.abs(e.getTime() - s.getTime()) / MS_PER_DAY) + 1;
    }

    /**
     * Compute the previous period of equal length for comparison.
     * Given [start, end] with N inclusive days, returns [prevStart, prevEnd]
     * where prevEnd = start - 1 day, prevStart = prevEnd - (N - 1) days.
     */
    export function previousPeriod(
      start: Date | string,
      end: Date | string
    ): { start: string; end: string } {
      const s = typeof start === 'string' ? new Date(start) : start;
      const e = typeof end === 'string' ? new Date(end) : end;
      const dayCount = inclusiveDayCount(s, e);

      const prevEnd = new Date(s);
      prevEnd.setDate(prevEnd.getDate() - 1);

      const prevStart = new Date(prevEnd);
      prevStart.setDate(prevStart.getDate() - (dayCount - 1));

      return {
        start: prevStart.toISOString().split('T')[0],
        end: prevEnd.toISOString().split('T')[0],
      };
    }
    ```

    2. Create `app/src/utils/apiUtils.ts` with two exported functions:

    ```typescript
    /**
     * Safely coerce API response data to an array.
     * Returns [] for null, undefined, non-array values.
     */
    export function safeArray<T>(data: unknown): T[] {
      return Array.isArray(data) ? data : [];
    }

    /**
     * Clamp a number to be non-negative. Returns 0 for NaN/null/undefined.
     */
    export function clampPositive(n: number | null | undefined): number {
      return Math.max(0, n ?? 0);
    }
    ```

    3. Create `app/src/utils/__tests__/dateUtils.spec.ts` with tests:
    - "inclusiveDayCount: Jan 10 to Jan 20 is 11 days" -- `expect(inclusiveDayCount('2026-01-10', '2026-01-20')).toBe(11)`
    - "inclusiveDayCount: same day is 1 day" -- `expect(inclusiveDayCount('2026-01-15', '2026-01-15')).toBe(1)`
    - "inclusiveDayCount: accepts Date objects" -- `expect(inclusiveDayCount(new Date('2026-01-01'), new Date('2026-01-31'))).toBe(31)`
    - "previousPeriod: 11-day period produces equal-length previous" -- call `previousPeriod('2026-01-10', '2026-01-20')`, verify `inclusiveDayCount(result.start, result.end) === 11` and `result.end === '2026-01-09'`
    - "previousPeriod: previous period ends the day before current starts" -- verify `result.end` is one day before `start`

    4. Create `app/src/utils/__tests__/apiUtils.spec.ts` with tests:
    - "safeArray: returns array unchanged" -- `expect(safeArray([1, 2])).toEqual([1, 2])`
    - "safeArray: returns [] for null" -- `expect(safeArray(null)).toEqual([])`
    - "safeArray: returns [] for undefined" -- `expect(safeArray(undefined)).toEqual([])`
    - "safeArray: returns [] for object" -- `expect(safeArray({ error: 'fail' })).toEqual([])`
    - "clampPositive: returns positive values unchanged" -- `expect(clampPositive(5)).toBe(5)`
    - "clampPositive: clamps negative to zero" -- `expect(clampPositive(-3)).toBe(0)`
    - "clampPositive: returns 0 for null" -- `expect(clampPositive(null)).toBe(0)`
    - "clampPositive: returns 0 for undefined" -- `expect(clampPositive(undefined)).toBe(0)`
  </action>
  <verify>
    Run `cd /home/bernt-popp/development/sysndd/app && npx vitest run src/utils/__tests__/dateUtils.spec.ts src/utils/__tests__/apiUtils.spec.ts` -- all tests pass.
    Run `cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit` -- no TypeScript errors.
    Run `cd /home/bernt-popp/development/sysndd/app && npx eslint src/utils/dateUtils.ts src/utils/apiUtils.ts` -- no ESLint errors.
  </verify>
  <done>
    - inclusiveDayCount('2026-01-10', '2026-01-20') returns 11
    - previousPeriod returns equal-length period ending the day before current start
    - safeArray returns [] for null/undefined/non-array
    - clampPositive clamps negatives to 0 and handles null/undefined
    - All unit tests pass
    - All files pass type-check and ESLint
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix AdminStatistics race condition, date calculation, AbortController, and defensive data handling</name>
  <files>
    app/src/views/admin/AdminStatistics.vue
  </files>
  <action>
    1. In `app/src/views/admin/AdminStatistics.vue`, add imports at the top of the script section (after line 229):
    ```typescript
    import { inclusiveDayCount, previousPeriod } from '@/utils/dateUtils';
    import { safeArray } from '@/utils/apiUtils';
    ```
    Also add `watch` and `onUnmounted` to the Vue import (line 212):
    ```typescript
    import { ref, computed, onMounted, onUnmounted, watch, inject } from 'vue';
    ```

    2. Fix the `periodLengthDays` computed (around line 344-349) to use `inclusiveDayCount`:
    ```typescript
    const periodLengthDays = computed(() =>
      inclusiveDayCount(startDate.value, endDate.value)
    );
    ```

    3. Add AbortController state after the reactive declarations (after line 322):
    ```typescript
    // AbortController for cancelling in-flight trend requests
    let trendAbortController: AbortController | null = null;
    ```

    4. Modify `fetchTrendData()` (around lines 396-441) to:
    a. Abort previous request and create new controller at function start:
    ```typescript
    async function fetchTrendData(): Promise<void> {
      if (!axios) return;

      // Cancel previous in-flight request
      trendAbortController?.abort();
      trendAbortController = new AbortController();

      // Clear stale data immediately
      trendData.value = [];
      loading.value.trend = true;
    ```

    b. Pass `signal` to the axios request:
    ```typescript
      const response = await axios.get(`${apiUrl}/api/statistics/entities_over_time`, {
        params: {
          aggregate: 'entity_id',
          group: 'category',
          summarize: granularity.value,
        },
        headers: getAuthHeaders(),
        signal: trendAbortController.signal,
      });
    ```

    c. After computing cumulative trendData, derive totalEntities INSIDE fetchTrendData (move from fetchKPIStats). Then null out the controller to release the reference:
    ```typescript
      // Derive totalEntities from final cumulative value (avoids race condition)
      if (trendData.value.length > 0) {
        kpiStats.value.totalEntities = trendData.value[trendData.value.length - 1].count;
      }

      // Release controller reference after successful completion
      trendAbortController = null;
    ```

    d. Catch block must suppress AbortError:
    ```typescript
    } catch (error) {
      if ((error as Error).name !== 'AbortError') {
        console.error('Failed to fetch trend data:', error);
        makeToast('Failed to fetch trend data', 'Error', 'danger');
        trendData.value = [];
      }
    } finally {
      loading.value.trend = false;
    }
    ```

    5. In `fetchKPIStats()` (around lines 586-617), REMOVE the lines that read totalEntities from trendData (lines 603-606):
    ```typescript
    // DELETE these lines:
    // if (trendData.value.length > 0) {
    //   kpiStats.value.totalEntities = trendData.value[trendData.value.length - 1].count;
    // }
    ```
    This eliminates the race condition because totalEntities is now set inside fetchTrendData().

    6. Fix `calculateTrendDelta()` (around lines 549-584) to use the new utility functions:
    ```typescript
    async function calculateTrendDelta(): Promise<number | undefined> {
      const dayCount = inclusiveDayCount(startDate.value, endDate.value);
      const prev = previousPeriod(startDate.value, endDate.value);

      const [currentStats, prevStats] = await Promise.all([
        fetchUpdatesStats(startDate.value, endDate.value),
        fetchUpdatesStats(prev.start, prev.end),
      ]);

      if (!currentStats || !prevStats) return undefined;

      if (prevStats.total_new_entities === 0) {
        return currentStats.total_new_entities > 0 ? 100 : 0;
      }
      return Math.round(
        ((currentStats.total_new_entities - prevStats.total_new_entities) /
          prevStats.total_new_entities) *
          100
      );
    }
    ```
    Note: the `dayCount` variable is available if needed for context display but the key fix is using `previousPeriod()` which internally uses `inclusiveDayCount` for the correct length.

    7. Add a watcher for granularity changes (after the granularityOptions block, around line 330):
    ```typescript
    // Re-fetch trend data when granularity changes
    watch(granularity, () => {
      fetchTrendData();
    });
    ```

    8. Add cleanup on unmount (before onMounted, around line 678):
    ```typescript
    onUnmounted(() => {
      trendAbortController?.abort();
      trendAbortController = null;
    });
    ```

    9. Apply `safeArray` to defensive data handling in `fetchLeaderboard()` (line 465):
    Replace `const data = response.data.data || [];` with:
    ```typescript
    const data = safeArray<{ display_name: string; entity_count: number }>(response.data?.data);
    ```

    10. Apply `safeArray` to `fetchReReviewLeaderboard()` (line 509):
    Replace `const data = response.data.data || [];` with:
    ```typescript
    const data = safeArray<{ display_name: string; total_assigned: number; submitted_count: number; approved_count: number }>(response.data?.data);
    ```

    11. In `fetchTrendData()`, apply `safeArray` to the allData extraction:
    Replace `const allData = response.data.data || [];` with:
    ```typescript
    const allData = safeArray<{ group: string; values: Array<{ entry_date: string; count: number }> }>(response.data?.data);
    ```

    12. VERIFY ONLY -- no changes needed if Plan 81-01 completed correctly: Confirm `ReReviewBarChart.vue` has three datasets with `Math.max(0, ...)` wrapping on Pending Review and Not Yet Submitted segments. If Plan 81-01 Task 2 applied these correctly, no action is needed here.
  </action>
  <verify>
    Run `cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit` -- no TypeScript errors.
    Run `cd /home/bernt-popp/development/sysndd/app && npx eslint src/views/admin/AdminStatistics.vue` -- no ESLint errors.
    Verify `grep -c "AbortController" app/src/views/admin/AdminStatistics.vue` returns at least 2 (declaration + usage).
    Verify `grep -c "trendAbortController = null" app/src/views/admin/AdminStatistics.vue` returns at least 2 (after success + onUnmounted).
    Verify `grep -c "inclusiveDayCount" app/src/views/admin/AdminStatistics.vue` returns at least 1.
    Verify `grep -c "safeArray" app/src/views/admin/AdminStatistics.vue` returns at least 3.
    Verify `grep -c "onUnmounted" app/src/views/admin/AdminStatistics.vue` returns at least 1.
    Verify `grep -c "watch(granularity" app/src/views/admin/AdminStatistics.vue` returns 1.
    Verify the totalEntities assignment is INSIDE fetchTrendData, NOT inside fetchKPIStats:
      `grep -A2 "totalEntities" app/src/views/admin/AdminStatistics.vue` should show the assignment in fetchTrendData context.
  </verify>
  <done>
    - totalEntities KPI is computed inside fetchTrendData() -- no cross-function race condition
    - periodLengthDays uses inclusiveDayCount (Jan 10 to Jan 20 = 11 days)
    - calculateTrendDelta uses previousPeriod() for equal-length comparison periods
    - Granularity watcher triggers fetchTrendData() on change
    - AbortController cancels previous request on re-fetch, creates new controller each time
    - trendAbortController is nulled after successful completion to release the reference
    - onUnmounted() cleans up AbortController (abort + null)
    - AbortError is suppressed (not shown as toast)
    - safeArray() used for all API response data extractions
    - All files pass TypeScript type-check and ESLint
  </done>
</task>

</tasks>

<verification>
1. All utility tests pass: `cd /home/bernt-popp/development/sysndd/app && npx vitest run src/utils/__tests__/`
2. Frontend type-check: `cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit`
3. Frontend ESLint: `cd /home/bernt-popp/development/sysndd/app && npx eslint src/views/admin/ src/utils/`
4. Verify no race condition: totalEntities assigned inside fetchTrendData, not fetchKPIStats
5. Verify AbortController lifecycle: new controller per request, abort on re-fetch, null after success, cleanup on unmount
6. Verify defensive handling: safeArray used for all API response arrays
7. Verify inclusive date math: periodLengthDays and calculateTrendDelta use inclusiveDayCount/previousPeriod
</verification>

<success_criteria>
- inclusiveDayCount and previousPeriod exist with passing unit tests
- safeArray and clampPositive exist with passing unit tests
- totalEntities race condition eliminated (computed inside fetchTrendData)
- Date range calculations are inclusive (11 days for Jan 10-20)
- AbortController cancels stale trend requests on granularity change, nulled after success
- Granularity watcher triggers immediate data refresh
- All API data extractions use safeArray for crash protection
- All files pass TypeScript type-check and ESLint
</success_criteria>

<output>
After completion, create `.planning/phases/81-adminstatistics-sub-bugs/81-02-SUMMARY.md`
</output>
