---
phase: 81-adminstatistics-sub-bugs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/functions/re-review-sync.R
  - api/functions/review-repository.R
  - api/functions/status-repository.R
  - api/endpoints/re_review_endpoints.R
  - api/start_sysndd_api.R
  - api/endpoints/statistics_endpoints.R
  - app/src/views/admin/components/charts/ReReviewBarChart.vue
  - app/src/views/admin/AdminStatistics.vue
  - api/tests/testthat/test-integration-rereview-sync.R
autonomous: true

must_haves:
  truths:
    - "When a review is approved via /ApproveReview, re_review_entity_connect.re_review_approved is set atomically inside the same transaction"
    - "When a status is approved via /ApproveStatus, re_review_entity_connect.re_review_approved is set atomically inside the same transaction"
    - "Re-review leaderboard chart shows three segments per reviewer: Approved (green), Pending Review (amber), Not Yet Submitted (gray)"
    - "Re-review approve endpoint delegates to repository functions instead of inline SQL"
    - "Leaderboard query includes all assigned re-reviews (not just submitted) and uses .groups = 'drop'"
  artifacts:
    - path: "api/functions/re-review-sync.R"
      provides: "sync_rereview_approval() shared utility"
      contains: "sync_rereview_approval"
    - path: "api/tests/testthat/test-integration-rereview-sync.R"
      provides: "Integration test for re-review approval sync"
      contains: "sync_rereview_approval"
    - path: "app/src/views/admin/components/charts/ReReviewBarChart.vue"
      provides: "Three-segment stacked bar chart"
      contains: "Not Yet Submitted"
  key_links:
    - from: "api/functions/review-repository.R"
      to: "api/functions/re-review-sync.R"
      via: "sync_rereview_approval() call inside db_with_transaction"
      pattern: "sync_rereview_approval.*review_ids"
    - from: "api/functions/status-repository.R"
      to: "api/functions/re-review-sync.R"
      via: "sync_rereview_approval() call inside db_with_transaction"
      pattern: "sync_rereview_approval.*status_ids"
    - from: "api/endpoints/re_review_endpoints.R"
      to: "api/functions/review-repository.R"
      via: "delegation to review_approve() and status_approve()"
      pattern: "review_approve|status_approve"
    - from: "api/endpoints/statistics_endpoints.R"
      to: "re_review_entity_connect"
      via: "leaderboard query returning total_assigned, submitted_count, approved_count"
      pattern: "total_assigned"
---

<objective>
Fix re-review approval sync and leaderboard chart to show accurate three-segment data.

Purpose: When curators approve reviews/statuses through the standard ApproveReview/ApproveStatus pathways, the re_review_entity_connect.re_review_approved flag is never set -- only the dedicated re-review approve endpoint sets it. This means the leaderboard undercounts approvals. Additionally, the leaderboard chart only shows two segments (Approved, Pending) and filters to submitted-only records, missing the "Not Yet Submitted" segment.

Output: A shared `sync_rereview_approval()` utility called transactionally from both repository functions, a refactored re-review approve endpoint that delegates to repositories, an updated leaderboard query returning three counts, and a three-segment chart component.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/81-adminstatistics-sub-bugs/81-RESEARCH.md

@api/functions/review-repository.R
@api/functions/status-repository.R
@api/functions/db-helpers.R
@api/endpoints/re_review_endpoints.R
@api/endpoints/statistics_endpoints.R
@api/start_sysndd_api.R
@app/src/views/admin/components/charts/ReReviewBarChart.vue
@app/src/views/admin/AdminStatistics.vue
@api/tests/testthat/helper-db.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sync utility, integrate into repository transactions, and refactor re-review endpoint</name>
  <files>
    api/functions/re-review-sync.R
    api/functions/review-repository.R
    api/functions/status-repository.R
    api/endpoints/re_review_endpoints.R
    api/start_sysndd_api.R
    api/tests/testthat/test-integration-rereview-sync.R
  </files>
  <action>
    1. Create `api/functions/re-review-sync.R` with a single exported function:

    ```r
    sync_rereview_approval <- function(review_ids = NULL, status_ids = NULL, approving_user_id, conn = pool)
    ```

    This function:
    - Returns `invisible(NULL)` if both review_ids and status_ids are NULL
    - Builds a WHERE clause matching `review_id IN (...)` OR `status_id IN (...)` depending on which are provided
    - Executes: `UPDATE re_review_entity_connect SET re_review_approved = 1, approving_user_id = ? WHERE (...conditions...) AND re_review_submitted = 1 AND re_review_approved = 0`
    - Uses `db_execute_statement(sql, params, conn = conn)` to participate in the caller's transaction
    - Parameters must be positional (list, not named) -- `db_execute_statement` handles `unname()` internally

    2. In `api/functions/review-repository.R`, inside `review_approve()` function at line 327 (after the if/else approval block, before `return(review_ids)`), add:
    ```r
    # Sync re-review approval flag atomically within this transaction
    sync_rereview_approval(
      review_ids = review_ids,
      approving_user_id = approving_user_id,
      conn = conn
    )
    ```
    Note: The `conn` variable is already available inside `db_with_transaction()` blocks.

    3. In `api/functions/status-repository.R`, inside `status_approve()` function at line 309 (after the if/else approval block, before the closing `})` of `db_with_transaction`), add:
    ```r
    # Sync re-review approval flag atomically within this transaction
    sync_rereview_approval(
      status_ids = status_ids,
      approving_user_id = approving_user_id,
      conn = conn
    )
    ```
    Important: `status_approve()` has `return(status_ids)` OUTSIDE the transaction block (at line 312). The sync call goes inside `db_with_transaction()` at line 309, before the closing `})`.

    4. In `api/start_sysndd_api.R`, add a new source line after `status-repository.R` (after line 116):
    ```r
    source("functions/re-review-sync.R", local = TRUE)
    ```

    5. Refactor `api/endpoints/re_review_endpoints.R` approve endpoint (lines 93-173). Replace the 80 lines of inline SQL with delegation to repository functions:
    ```r
    function(req, res, re_review_id, status_ok = FALSE, review_ok = FALSE) {
      require_role(req, res, "Curator")

      status_ok <- as.logical(status_ok)
      review_ok <- as.logical(review_ok)
      re_review_id <- as.integer(re_review_id)

      re_review_entity_connect_data <- pool %>%
        tbl("re_review_entity_connect") %>%
        filter(re_review_entity_id == re_review_id) %>%
        collect()

      if (nrow(re_review_entity_connect_data) == 0) {
        res$status <- 404L
        return(list(error = "Re-review record not found"))
      }

      # Delegate to repository functions (which now auto-sync re_review_approved)
      status_approve(
        re_review_entity_connect_data$status_id,
        req$user_id,
        approved = status_ok
      )
      review_approve(
        re_review_entity_connect_data$review_id,
        req$user_id,
        approved = review_ok
      )

      list(message = "Re-review approved successfully")
    }
    ```
    Keep the endpoint decorator comments (lines 75-92) unchanged. Only replace the function body.

    6. Create `api/tests/testthat/test-integration-rereview-sync.R`:
    - Source required files: `source_api_file("functions/db-helpers.R", local = FALSE)`, `source_api_file("functions/re-review-sync.R", local = FALSE)`
    - Test "sync_rereview_approval updates matching rows": Use `with_test_db_transaction()`, insert a test re_review_entity_connect row with `re_review_submitted = 1, re_review_approved = 0`, call `sync_rereview_approval(review_ids = <test_id>, approving_user_id = 1, conn = getOption(".test_db_con"))`, verify the row now has `re_review_approved = 1`
    - Test "sync_rereview_approval skips unsubmitted rows": Insert row with `re_review_submitted = 0`, call sync, verify `re_review_approved` is still 0
    - Test "sync_rereview_approval with NULL ids returns silently": Call `sync_rereview_approval(approving_user_id = 1)`, expect no error
    - Use `skip_if_no_test_db()` at the start of each test
  </action>
  <verify>
    Run `cd /home/bernt-popp/development/sysndd && Rscript -e "lintr::lint('api/functions/re-review-sync.R')"` -- no lint errors.
    Run `cd /home/bernt-popp/development/sysndd && Rscript -e "lintr::lint('api/endpoints/re_review_endpoints.R')"` -- no lint errors.
    Verify `grep -c "sync_rereview_approval" api/functions/review-repository.R` returns 1.
    Verify `grep -c "sync_rereview_approval" api/functions/status-repository.R` returns 1.
    Verify `grep -c "db_execute_statement" api/endpoints/re_review_endpoints.R` returns 0 (no inline SQL remaining).
    Verify `grep "re-review-sync.R" api/start_sysndd_api.R` shows the source line.
  </verify>
  <done>
    - sync_rereview_approval() exists and is sourced in start_sysndd_api.R
    - review_approve() calls sync inside its transaction block
    - status_approve() calls sync inside its transaction block
    - re_review endpoint delegates to repository functions with zero inline SQL
    - Integration test file exists with 3 test cases
    - All modified R files pass lintr
  </done>
</task>

<task type="auto">
  <name>Task 2: Update leaderboard query and three-segment chart</name>
  <files>
    api/endpoints/statistics_endpoints.R
    app/src/views/admin/components/charts/ReReviewBarChart.vue
    app/src/views/admin/AdminStatistics.vue
  </files>
  <action>
    1. In `api/endpoints/statistics_endpoints.R`, modify the rereview_leaderboard endpoint (around lines 662-716):

    a. Remove the `filter(re_review_submitted == 1)` on line 665 so ALL re-review records are included (not just submitted ones).

    b. Update the summarise block (lines 703-707) to compute three counts and add `.groups = "drop"`:
    ```r
    leaderboard <- re_review_with_users %>%
      group_by(user_id) %>%
      summarise(
        total_assigned = n(),
        submitted_count = sum(re_review_submitted == 1, na.rm = TRUE),
        approved_count = sum(re_review_approved == 1, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      arrange(desc(submitted_count)) %>%
      head(as.integer(top)) %>%
      left_join(user_data, by = "user_id") %>%
      mutate(display_name = ifelse(
        !is.na(first_name) & !is.na(family_name),
        paste(first_name, family_name),
        user_name
      )) %>%
      select(user_id, user_name, display_name, total_assigned, submitted_count, approved_count)
    ```

    c. In the same endpoint, update the hardcoded denominator 3650 (lines 310-312). Replace:
    ```r
    percent_finished <- (total_rr / 3650) * 100
    ```
    with:
    ```r
    total_in_pipeline <- pool %>%
      tbl("re_review_entity_connect") %>%
      summarise(n = n()) %>%
      collect() %>%
      pull(n)
    percent_finished <- if (total_in_pipeline > 0) (total_rr / total_in_pipeline) * 100 else 0
    ```

    2. Update `app/src/views/admin/components/charts/ReReviewBarChart.vue`:

    a. Add a third color to the COLORS object:
    ```typescript
    const COLORS = {
      approved: '#009E73',    // Okabe-Ito bluish green (approved)
      submitted: '#6699CC',   // Muted blue (submitted but not approved)
      notSubmitted: '#BBBBBB', // Gray (not yet submitted)
    };
    ```

    b. Update the Reviewer interface to include `total_assigned`:
    ```typescript
    interface Reviewer {
      user_name: string;
      total_assigned: number;
      submitted_count: number;
      approved_count: number;
    }
    ```

    c. Update chartData computed to use three segments with clamping:
    ```typescript
    const chartData = computed(() => ({
      labels: props.reviewers.map((r) => r.user_name),
      datasets: [
        {
          label: 'Approved',
          data: props.reviewers.map((r) => r.approved_count),
          backgroundColor: COLORS.approved,
          borderColor: COLORS.approved,
          borderWidth: 1,
        },
        {
          label: 'Pending Review',
          data: props.reviewers.map((r) => Math.max(0, r.submitted_count - r.approved_count)),
          backgroundColor: COLORS.submitted,
          borderColor: COLORS.submitted,
          borderWidth: 1,
        },
        {
          label: 'Not Yet Submitted',
          data: props.reviewers.map((r) => Math.max(0, r.total_assigned - r.submitted_count)),
          backgroundColor: COLORS.notSubmitted,
          borderColor: COLORS.notSubmitted,
          borderWidth: 1,
        },
      ],
    }));
    ```

    3. Update `app/src/views/admin/AdminStatistics.vue` in the `fetchReReviewLeaderboard()` function (around lines 487-523):

    a. Update the `ReReviewLeaderboardData` interface (around line 242) to include `total_assigned`:
    ```typescript
    interface ReReviewLeaderboardData {
      user_name: string;
      total_assigned: number;
      submitted_count: number;
      approved_count: number;
    }
    ```

    b. Update the mapping in `fetchReReviewLeaderboard()` (around line 510) to pass `total_assigned`:
    ```typescript
    reReviewLeaderboardData.value = data.map(
      (item: { display_name: string; total_assigned: number; submitted_count: number; approved_count: number }) => ({
        user_name: item.display_name || 'Unknown',
        total_assigned: item.total_assigned ?? 0,
        submitted_count: item.submitted_count ?? 0,
        approved_count: item.approved_count ?? 0,
      })
    );
    ```
  </action>
  <verify>
    Run `cd /home/bernt-popp/development/sysndd && Rscript -e "lintr::lint('api/endpoints/statistics_endpoints.R')"` -- no lint errors.
    Run `cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit` -- no TypeScript errors.
    Run `cd /home/bernt-popp/development/sysndd/app && npx eslint src/views/admin/components/charts/ReReviewBarChart.vue src/views/admin/AdminStatistics.vue` -- no ESLint errors.
    Verify `grep -c "3650" api/endpoints/statistics_endpoints.R` returns 0 (hardcoded denominator removed).
    Verify `grep -c ".groups" api/endpoints/statistics_endpoints.R` returns at least 1 (`.groups = "drop"` added).
    Verify `grep -c "Not Yet Submitted" app/src/views/admin/components/charts/ReReviewBarChart.vue` returns 1.
    Verify `grep -c "total_assigned" app/src/views/admin/components/charts/ReReviewBarChart.vue` returns at least 1.
  </verify>
  <done>
    - Leaderboard query returns total_assigned, submitted_count, approved_count for all assigned re-reviews
    - .groups = "drop" added to summarise() call
    - Hardcoded 3650 replaced with dynamic COUNT query
    - ReReviewBarChart renders three segments: Approved (green), Pending Review (blue), Not Yet Submitted (gray)
    - Negative bar values clamped to zero via Math.max(0, ...)
    - ReReviewLeaderboardData interface includes total_assigned
    - All R files pass lintr, all TS/Vue files pass type-check and ESLint
  </done>
</task>

</tasks>

<verification>
1. All R files lint clean: `cd /home/bernt-popp/development/sysndd && Rscript -e "lapply(c('api/functions/re-review-sync.R', 'api/functions/review-repository.R', 'api/functions/status-repository.R', 'api/endpoints/re_review_endpoints.R', 'api/endpoints/statistics_endpoints.R'), lintr::lint)"`
2. Frontend type-check: `cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit`
3. Frontend ESLint: `cd /home/bernt-popp/development/sysndd/app && npx eslint src/views/admin/`
4. Grep verifications: no "3650" in statistics_endpoints.R, "sync_rereview_approval" in both repository files, zero "db_execute_statement" in re_review_endpoints.R approve function, "Not Yet Submitted" in ReReviewBarChart.vue
</verification>

<success_criteria>
- sync_rereview_approval() is called transactionally from both review_approve() and status_approve()
- Re-review approve endpoint has zero inline SQL (delegates to repositories)
- Leaderboard API returns total_assigned, submitted_count, approved_count
- Dynamic denominator replaces hardcoded 3650
- Chart shows three segments with clamped non-negative values
- Integration test covers sync logic
- All lint/type checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/81-adminstatistics-sub-bugs/81-01-SUMMARY.md`
</output>
