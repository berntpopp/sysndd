---
phase: 37-form-modernization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/views/curate/composables/useStatusForm.ts
  - app/src/views/review/Review.vue
  - app/src/views/curate/ModifyEntity.vue
autonomous: true

must_haves:
  truths:
    - "Status form validation works (category_id required)"
    - "Status form submission creates/updates status via API"
    - "useStatusForm provides form state, validation methods, and submit handler"
    - "Status modals in Review.vue and ModifyEntity.vue use useStatusForm"
  artifacts:
    - path: "app/src/views/curate/composables/useStatusForm.ts"
      provides: "Status form lifecycle composable"
      exports: ["useStatusForm"]
      min_lines: 100
  key_links:
    - from: "app/src/views/review/Review.vue"
      to: "useStatusForm"
      via: "composable import"
      pattern: "useStatusForm"
    - from: "app/src/views/curate/ModifyEntity.vue"
      to: "useStatusForm"
      via: "composable import"
      pattern: "useStatusForm"
---

<objective>
Extract reusable status form composable from Review.vue and ModifyEntity.vue

Purpose: Reduce code duplication between status modification modals, ensure consistent validation and submission logic.

Output:
- useStatusForm.ts composable with form state, validation, submission logic
- Review.vue status modal refactored to use composable
- ModifyEntity.vue status modal refactored to use composable
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-form-modernization/37-CONTEXT.md
@.planning/phases/37-form-modernization/37-RESEARCH.md

# Existing patterns to follow
@app/src/composables/useEntityForm.ts
@app/src/views/review/Review.vue
@app/src/views/curate/ModifyEntity.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useStatusForm composable</name>
  <files>app/src/views/curate/composables/useStatusForm.ts</files>
  <action>
Create useStatusForm composable following the useEntityForm pattern:

1. Define StatusFormData interface:
```typescript
interface StatusFormData {
  category_id: number | null;
  comment: string;
  problematic: boolean;
  // Metadata (set after loading, not editable)
  status_id?: number;
  entity_id?: number;
  status_user_name?: string;
  status_user_role?: string;
  status_date?: string;
  re_review_status_saved?: number;
}
```

2. Implement useStatusForm():
- `formData`: reactive StatusFormData state with defaults
- `loading`: ref for loading state
- `touched`: reactive record for touched fields
- `loadStatusData(statusId: number, reReviewSaved?: number)`: Load status from API
- `loadStatusByEntity(entityId: number)`: Load status by entity ID (for ModifyEntity)
- `validateField(fieldName)`: Validate individual field (category_id required)
- `getFieldError(fieldName)`: Get error if touched and invalid
- `getFieldState(fieldName)`: Bootstrap validation state
- `touchField(fieldName)`: Mark as touched
- `resetForm()`: Reset formData and touched state
- `submitForm(isUpdate: boolean, reReview: boolean)`: Submit to API

3. API integration:
- GET `/api/status/{status_id}` for loadStatusData
- GET `/api/entity/{entity_id}/status` for loadStatusByEntity
- POST `/api/status/create` for new status
- PUT `/api/status/update` for update (with ?re_review=true if applicable)

4. Use Status class from submission classes:
```typescript
import Status from '@/assets/js/classes/submission/submissionStatus';
```

5. Transform form data to Status object on submit:
```typescript
const statusObj = new Status(
  formData.category_id,
  formData.comment,
  formData.problematic
);
statusObj.status_id = formData.status_id;
statusObj.entity_id = formData.entity_id;
```

6. Handle create vs update based on isUpdate parameter

7. Export default function and types
  </action>
  <verify>
- File exists at app/src/views/curate/composables/useStatusForm.ts
- TypeScript compiles without errors: `cd app && npx tsc --noEmit`
- Exports useStatusForm function and StatusFormData type
  </verify>
  <done>
useStatusForm composable exists with form state management, validation, API loading, and submission logic
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor Review.vue status modal to use composable</name>
  <files>app/src/views/review/Review.vue</files>
  <action>
Refactor Review.vue status modal to use useStatusForm:

1. Import useStatusForm:
```javascript
import useStatusForm from '@/views/curate/composables/useStatusForm';
```

2. In setup(), initialize:
```javascript
const statusForm = useStatusForm();
const {
  formData: statusFormData,
  loading: statusFormLoading,
  loadStatusData,
  submitForm: submitStatusForm,
  resetForm: resetStatusForm
} = statusForm;
```

3. Update infoStatus method:
```javascript
async infoStatus(item, index, button) {
  this.statusModal.title = `sysndd:${item.entity_id}`;
  await this.getEntity(item.entity_id);
  await statusForm.loadStatusData(item.status_id, item.re_review_status_saved);
  // Show modal...
}
```

4. Update status modal template to use composable data:
- Change `v-model="status_info.category_id"` to `v-model="statusFormData.category_id"`
- Change `v-model="status_info.problematic"` to `v-model="statusFormData.problematic"`
- Change `v-model="status_info.comment"` to `v-model="statusFormData.comment"`
- Change `:busy="loading_status_modal"` to `:busy="statusFormLoading"`

5. Update submitStatusChange:
```javascript
async submitStatusChange() {
  try {
    const isUpdate = statusFormData.re_review_status_saved === 1;
    await statusForm.submitForm(isUpdate, true); // reReview = true
    this.makeToast('Status submitted successfully', 'Success', 'success');
    statusForm.resetForm();
    this.loadReReviewData();
  } catch (e) {
    this.makeToast(e, 'Error', 'danger');
  }
}
```

6. Keep status_options loading (already correct)

7. Remove old status_info data property usage where replaced
  </action>
  <verify>
- Review.vue compiles without errors
- Status modal still displays form fields
- Status submission works via composable
- `cd app && npm run lint -- --fix` passes
  </verify>
  <done>
Review.vue status modal uses useStatusForm composable, reducing duplication
  </done>
</task>

<task type="auto">
  <name>Task 3: Refactor ModifyEntity.vue status modal to use composable</name>
  <files>app/src/views/curate/ModifyEntity.vue</files>
  <action>
Refactor ModifyEntity.vue status modal to use useStatusForm:

1. Import useStatusForm:
```javascript
import useStatusForm from '@/views/curate/composables/useStatusForm';
```

2. In setup(), initialize:
```javascript
const statusForm = useStatusForm();
const {
  formData: statusFormData,
  loading: statusFormLoading,
  loadStatusByEntity,
  submitForm: submitStatusForm,
  resetForm: resetStatusForm
} = statusForm;

return {
  makeToast,
  ...colorAndSymbols,
  statusFormData,
  statusFormLoading,
  loadStatusByEntity,
  submitStatusForm,
  resetStatusForm,
};
```

3. Update showStatusModify method:
```javascript
async showStatusModify() {
  await this.getEntity();
  if (!this.entity_info?.entity_id) return;

  await statusForm.loadStatusByEntity(this.modify_entity_input);

  if (this.status_options === null) {
    await this.loadStatusList();
  }
  if (!this.status_options || this.status_options.length === 0) {
    this.makeToast('Failed to load status options', 'Error', 'danger');
    return;
  }

  this.$refs.modifyStatusModal.show();
}
```

4. Update status modal template:
- Change `v-model="status_info.category_id"` to `v-model="statusFormData.category_id"`
- Change `v-model="status_info.problematic"` to `v-model="statusFormData.problematic"`
- Change `v-model="status_info.comment"` to `v-model="statusFormData.comment"`
- Change `:busy="loading_status_modal"` to `:busy="statusFormLoading"`

5. Update submitStatusChange:
```javascript
async submitStatusChange() {
  this.submitting = 'status';
  try {
    await this.submitStatusForm(false, false); // isUpdate=false (always create), reReview=false
    this.makeToast('Status submitted successfully', 'Success', 'success');
    this.resetStatusForm();
    this.resetForm(); // Also reset entity selection
  } catch (e) {
    this.makeToast(e, 'Error', 'danger');
  } finally {
    this.submitting = null;
  }
}
```

6. Remove old getStatus method and loading_status_modal data property

7. Keep status_info in resetForm() call for backward compat if needed, or update resetForm to use composable
  </action>
  <verify>
- ModifyEntity.vue compiles without errors
- Status modal still displays form fields
- Status submission works via composable
- `cd app && npm run lint -- --fix` passes
  </verify>
  <done>
ModifyEntity.vue status modal uses useStatusForm composable, consistent with Review.vue
  </done>
</task>

</tasks>

<verification>
Overall phase verification:
1. TypeScript compiles: `cd app && npx tsc --noEmit`
2. Lint passes: `cd app && npm run lint`
3. App builds: `cd app && npm run build`
4. Status modal works in Review.vue
5. Status modal works in ModifyEntity.vue
</verification>

<success_criteria>
- useStatusForm.ts composable exists and exports form lifecycle methods
- Review.vue status modal refactored to use composable
- ModifyEntity.vue status modal refactored to use composable
- No duplicate status form logic between components
- TypeScript and lint pass without errors
</success_criteria>

<output>
After completion, create `.planning/phases/37-form-modernization/37-02-SUMMARY.md`
</output>
