---
phase: 37-form-modernization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/views/curate/composables/useReviewForm.ts
  - app/src/views/curate/components/ReviewFormFields.vue
  - app/src/views/review/Review.vue
autonomous: true

must_haves:
  truths:
    - "Review form validation works (synopsis required, PMID format validated)"
    - "Review form submission creates/updates review via API"
    - "ReviewFormFields renders synopsis, phenotypes, variations, publications, genereviews, comment"
    - "useReviewForm provides form state, validation methods, and submit handler"
  artifacts:
    - path: "app/src/views/curate/composables/useReviewForm.ts"
      provides: "Review form lifecycle composable"
      exports: ["useReviewForm"]
      min_lines: 150
    - path: "app/src/views/curate/components/ReviewFormFields.vue"
      provides: "Reusable review form fields component"
      min_lines: 100
  key_links:
    - from: "app/src/views/curate/components/ReviewFormFields.vue"
      to: "useReviewForm"
      via: "composable usage"
      pattern: "useReviewForm"
    - from: "app/src/views/review/Review.vue"
      to: "ReviewFormFields.vue"
      via: "component import"
      pattern: "ReviewFormFields"
---

<objective>
Extract reusable review form composable and component from Review.vue

Purpose: Reduce code duplication between Review.vue and ModifyEntity.vue review modal, enable consistent form behavior and validation across curation interfaces.

Output:
- useReviewForm.ts composable with form state, validation, submission logic
- ReviewFormFields.vue component for rendering review form fields
- Review.vue refactored to use extracted composable and component
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-form-modernization/37-CONTEXT.md
@.planning/phases/37-form-modernization/37-RESEARCH.md

# Existing patterns to follow
@app/src/composables/useEntityForm.ts
@app/src/composables/useFormDraft.ts
@app/src/views/review/Review.vue
@app/src/views/curate/ModifyEntity.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useReviewForm composable</name>
  <files>app/src/views/curate/composables/useReviewForm.ts</files>
  <action>
Create useReviewForm composable following the useEntityForm pattern:

1. Create directory if needed: `app/src/views/curate/composables/`

2. Define ReviewFormData interface:
```typescript
interface ReviewFormData {
  synopsis: string;
  phenotypes: string[];      // Format: "modifier_id-phenotype_id"
  variationOntology: string[]; // Format: "modifier_id-vario_id"
  publications: string[];    // PMID format
  genereviews: string[];     // PMID format
  comment: string;
}
```

3. Implement useReviewForm(entityId: string | number):
- `formData`: reactive ReviewFormData state
- `touched`: reactive record of touched fields
- `loading`: ref for loading state
- `loadReviewData(reviewId: number)`: Load review, phenotypes, variations, publications from API
- `validateField(fieldName)`: Validate individual field (synopsis required, PMID format)
- `getFieldError(fieldName)`: Get error message if touched and invalid
- `getFieldState(fieldName)`: Get Bootstrap validation state (true/false/null)
- `touchField(fieldName)`: Mark field as touched
- `resetForm()`: Reset formData and touched state
- `getFormSnapshot()`: Return serializable form data
- `restoreFromSnapshot(data)`: Restore form from snapshot
- `submitForm(isUpdate: boolean, reReview: boolean)`: Submit to API (create or update)

4. Use existing submission classes:
- Import Review, Phenotype, Variation, Literature from submission classes
- Transform form data to API format on submit
- Handle create vs update logic (POST vs PUT)

5. Export default function and types
  </action>
  <verify>
- File exists at app/src/views/curate/composables/useReviewForm.ts
- TypeScript compiles without errors: `cd app && npx tsc --noEmit`
- Exports useReviewForm function and ReviewFormData type
  </verify>
  <done>
useReviewForm composable exists with form state management, validation, API loading, and submission logic following useEntityForm patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ReviewFormFields component</name>
  <files>app/src/views/curate/components/ReviewFormFields.vue</files>
  <action>
Create ReviewFormFields component that renders all review form fields:

1. Create directory if needed: `app/src/views/curate/components/`

2. Define props:
- `modelValue`: ReviewFormData (v-model for form data)
- `phenotypesOptions`: TreeNode[] (for TreeMultiSelect)
- `variationOptions`: TreeNode[] (for TreeMultiSelect)
- `loading`: boolean (shows overlay when loading)
- `readonly`: boolean (optional, disables inputs)

3. Define emits:
- `update:modelValue`: For v-model binding

4. Template structure (matching Review.vue modal content):
```vue
<BOverlay :show="loading" rounded="sm">
  <BForm @submit.stop.prevent>
    <!-- Synopsis textarea with help popover -->
    <label for="review-textarea-synopsis">Synopsis</label>
    <BBadge id="popover-badge-help-synopsis" pill href="#" variant="info">
      <i class="bi bi-question-circle-fill" />
    </BBadge>
    <BPopover target="popover-badge-help-synopsis" variant="info" triggers="focus">
      <!-- Synopsis instructions -->
    </BPopover>
    <BFormTextarea id="review-textarea-synopsis" v-model="formData.synopsis" rows="3" size="sm" />

    <!-- Phenotypes TreeMultiSelect with help popover -->
    <label for="review-phenotype-select">Phenotypes</label>
    <!-- Help popover -->
    <TreeMultiSelect v-if="phenotypesOptions?.length" id="review-phenotype-select"
      v-model="formData.phenotypes" :options="phenotypesOptions" />

    <!-- Variation TreeMultiSelect with help popover -->
    <label for="review-variation-select">Variation ontology</label>
    <!-- Help popover -->
    <TreeMultiSelect v-if="variationOptions?.length" id="review-variation-select"
      v-model="formData.variationOntology" :options="variationOptions" />

    <!-- Publications BFormTags with PMID validation -->
    <label for="review-publications-select">Publications</label>
    <!-- Help popover -->
    <BFormTags v-model="formData.publications" :tag-validator="tagValidatorPMID" ... />

    <!-- Genereviews BFormTags -->
    <label for="review-genereviews-select">Genereviews</label>
    <!-- Help popover -->
    <BFormTags v-model="formData.genereviews" :tag-validator="tagValidatorPMID" ... />

    <!-- Comment textarea -->
    <label for="review-textarea-comment">Comment</label>
    <BFormTextarea id="review-textarea-comment" v-model="formData.comment" rows="2" size="sm" />
  </BForm>
</BOverlay>
```

5. Use computed for formData that syncs with modelValue:
```typescript
const formData = computed({
  get: () => props.modelValue,
  set: (val) => emit('update:modelValue', val)
});
```

6. Include tagValidatorPMID function from useEntityForm (or import validatePMID)

7. Import required components: TreeMultiSelect, BFormTags, BFormTextarea, BPopover, etc.
  </action>
  <verify>
- File exists at app/src/views/curate/components/ReviewFormFields.vue
- Component exports correctly
- No TypeScript errors: `cd app && npx tsc --noEmit`
  </verify>
  <done>
ReviewFormFields.vue component exists with all review form fields (synopsis, phenotypes, variations, publications, genereviews, comment) matching Review.vue layout
  </done>
</task>

<task type="auto">
  <name>Task 3: Refactor Review.vue to use extracted composable and component</name>
  <files>app/src/views/review/Review.vue</files>
  <action>
Refactor Review.vue review modal to use useReviewForm and ReviewFormFields:

1. Import new composable and component:
```javascript
import useReviewForm from '@/views/curate/composables/useReviewForm';
import ReviewFormFields from '@/views/curate/components/ReviewFormFields.vue';
```

2. In setup(), initialize the composable:
```javascript
const reviewForm = useReviewForm();
const { formData: reviewFormData, loading: reviewFormLoading, loadReviewData, submitForm, resetForm } = reviewForm;
```

3. Update infoReview method to use composable:
```javascript
async infoReview(item, index, button) {
  this.reviewModal.title = `sysndd:${item.entity_id}`;
  await this.getEntity(item.entity_id);
  await reviewForm.loadReviewData(item.review_id, item.re_review_review_saved);
  // Show modal...
}
```

4. Replace review modal form content with ReviewFormFields:
```vue
<ReviewFormFields
  v-model="reviewFormData"
  :phenotypes-options="phenotypes_options"
  :variation-options="variation_ontology_options"
  :loading="reviewFormLoading"
/>
```

5. Update submitReviewChange to use composable:
```javascript
async submitReviewChange() {
  try {
    await reviewForm.submitForm(this.review_info.re_review_review_saved === 1, true);
    this.makeToast('Review submitted successfully', 'Success', 'success');
    reviewForm.resetForm();
    this.loadReReviewData();
  } catch (e) {
    this.makeToast(e, 'Error', 'danger');
  }
}
```

6. Remove duplicated code:
- Remove inline form fields from review modal template
- Remove duplicated validation logic
- Keep entity_info, status_info, and other non-review state

7. Keep backward compatibility:
- Preserve existing data flow for status modal, submit modal, approve modal
- Only refactor the review modal portion
  </action>
  <verify>
- Review.vue compiles without errors
- Review modal still displays form fields
- Manual test: Open review modal, verify all fields render correctly
- `cd app && npm run lint -- --fix` passes
  </verify>
  <done>
Review.vue review modal uses useReviewForm composable and ReviewFormFields component, reducing duplication and enabling reuse in ModifyEntity.vue
  </done>
</task>

</tasks>

<verification>
Overall phase verification:
1. TypeScript compiles: `cd app && npx tsc --noEmit`
2. Lint passes: `cd app && npm run lint`
3. App builds: `cd app && npm run build`
4. Review modal displays all form fields correctly
5. Form submission works (creates/updates review)
</verification>

<success_criteria>
- useReviewForm.ts composable exists and exports form lifecycle methods
- ReviewFormFields.vue component exists and renders all review fields
- Review.vue refactored to use extracted composable and component
- No duplicate form logic between Review.vue and composable
- TypeScript and lint pass without errors
</success_criteria>

<output>
After completion, create `.planning/phases/37-form-modernization/37-01-SUMMARY.md`
</output>
