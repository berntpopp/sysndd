---
phase: 44-gene-structure-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/types/ensembl.ts
  - app/src/types/index.ts
  - app/src/composables/useD3GeneStructure.ts
  - app/src/composables/index.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript interfaces define Ensembl gene structure response including chromosome, strand, exons, and CDS boundaries"
    - "Exon type classification function distinguishes coding exons from 5-prime and 3-prime UTR regions using CDS coordinates"
    - "useD3GeneStructure composable initializes SVG, renders gene structure, and cleans up on unmount"
    - "D3 instance stored in non-reactive let variable to prevent Vue layout thrashing"
    - "Genomic coordinate formatter displays abbreviated Mb/kb/bp units"
    - "Composable exposes render function that accepts transcript data and draws exons, introns, axis, and scale bar"
  artifacts:
    - path: "app/src/types/ensembl.ts"
      provides: "TypeScript interfaces for Ensembl gene structure visualization data"
      exports: ["EnsemblExon", "EnsemblTranscript", "EnsemblGeneStructure", "ClassifiedExon", "classifyExons", "formatGenomicCoordinate"]
    - path: "app/src/composables/useD3GeneStructure.ts"
      provides: "D3 lifecycle composable for gene structure rendering following useCytoscape pattern"
      exports: ["useD3GeneStructure"]
  key_links:
    - from: "app/src/types/index.ts"
      to: "app/src/types/ensembl.ts"
      via: "barrel re-export"
      pattern: "export.*ensembl"
    - from: "app/src/composables/index.ts"
      to: "app/src/composables/useD3GeneStructure.ts"
      via: "barrel re-export"
      pattern: "useD3GeneStructure"
    - from: "app/src/composables/useD3GeneStructure.ts"
      to: "app/src/types/ensembl.ts"
      via: "import type"
      pattern: "import.*from.*types/ensembl"
---

<objective>
Create TypeScript type definitions for Ensembl gene structure data and the useD3GeneStructure composable that manages D3.js SVG lifecycle for rendering exons, introns, UTRs, strand direction, and coordinate axis.

Purpose: Foundation layer that the visualization components (Plan 02) will consume. Types define the data contract between the Ensembl backend proxy (Phase 40) and frontend rendering. The composable follows the established useCytoscape/useD3Lollipop pattern for safe D3/Vue integration. Includes exon-type classification logic (coding vs UTR) by comparing exon boundaries to CDS start/end coordinates.

Output: `app/src/types/ensembl.ts` (interfaces + helpers), `app/src/composables/useD3GeneStructure.ts` (composable), updated barrel exports.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-gene-structure-visualization/44-CONTEXT.md
@.planning/phases/44-gene-structure-visualization/44-RESEARCH.md

Key references:
@app/src/composables/useCytoscape.ts (CRITICAL pattern -- non-reactive instance, onBeforeUnmount cleanup)
@app/src/types/gene.ts (existing type definition pattern)
@app/src/types/index.ts (barrel export pattern)
@app/src/composables/index.ts (barrel export pattern)
@api/functions/external-proxy-ensembl.R (backend Ensembl response shape: gene_id, chromosome, start, end, strand, canonical_transcript with exons)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypeScript interfaces and helper functions for Ensembl gene structure</name>
  <files>app/src/types/ensembl.ts, app/src/types/index.ts</files>
  <action>
Create `app/src/types/ensembl.ts` with interfaces and helpers that bridge the Ensembl backend proxy response to visualization rendering:

1. **EnsemblExon** interface (maps from backend `external-proxy-ensembl.R` response exon objects):
   - id: string (Ensembl exon ID, e.g., "ENSE00001234567")
   - start: number (genomic start coordinate, GRCh38)
   - end: number (genomic end coordinate, GRCh38)

2. **EnsemblTranscript** interface (maps from canonical_transcript in backend response):
   - transcript_id: string (e.g., "ENST00000302278")
   - start: number (transcript genomic start)
   - end: number (transcript genomic end)
   - biotype: string (e.g., "protein_coding")
   - exons: EnsemblExon[]

3. **EnsemblGeneStructure** interface (complete backend response shape):
   - source: string (always "ensembl")
   - gene_symbol: string
   - gene_id: string (e.g., "ENSG00000012048")
   - chromosome: string (e.g., "17")
   - start: number (gene genomic start)
   - end: number (gene genomic end)
   - strand: number (1 for forward, -1 for reverse)
   - canonical_transcript: EnsemblTranscript

4. **ClassifiedExon** interface (processed exon with type classification for rendering):
   - id: string
   - start: number
   - end: number
   - type: 'coding' | '5_utr' | '3_utr'
   - exonNumber: number (1-based, in genomic order left-to-right regardless of strand)

5. **Intron** interface (calculated gap between consecutive exons):
   - start: number
   - end: number

6. **GeneStructureRenderData** interface (fully processed data ready for D3 rendering):
   - geneSymbol: string
   - transcriptId: string
   - chromosome: string
   - geneStart: number
   - geneEnd: number
   - strand: '+' | '-' (converted from 1/-1)
   - exons: ClassifiedExon[]
   - introns: Intron[]
   - exonCount: number
   - geneLength: number (end - start)

7. **classifyExons** function (exported):
   ```typescript
   export function classifyExons(
     exons: EnsemblExon[],
     transcript: EnsemblTranscript,
     strand: number
   ): ClassifiedExon[]
   ```
   Classification logic:
   - Sort exons by start coordinate (ascending, genomic order)
   - The Ensembl API response does NOT include explicit CDS boundaries in the expand=1 lookup response used by the backend proxy. To determine UTR vs coding regions, the function needs CDS start/end coordinates.
   - **Approach for CDS detection:** The backend `external-proxy-ensembl.R` currently returns exons with `{id, start, end}` only, without Translation/CDS data. We need to handle two cases:
     a. **If CDS coordinates are available** (future enhancement or if provided via additional API call): Compare each exon's coordinates against CDS start/end. Exons entirely before CDS start are 5' UTR (on + strand) or 3' UTR (on - strand). Exons entirely after CDS end are 3' UTR (on + strand) or 5' UTR (on - strand). Exons overlapping CDS boundaries are split conceptually -- for simplicity, classify as coding if any overlap exists.
     b. **If CDS coordinates are NOT available** (current state): For protein_coding transcripts, assume all exons are coding (type = 'coding'). This is an acceptable simplification since UTR distinction is a visual enhancement, not a requirement blocker. Log a note that UTR classification will improve when CDS data is available.
   - **Actually, implement CDS detection via Translation data:** Modify the approach to accept optional `cdsStart` and `cdsEnd` parameters. The `GeneStructureCard.vue` component (Plan 02) will fetch the Translation data from a separate Ensembl endpoint (`/lookup/id/{transcript_id}?expand=1`) to get CDS coordinates, OR the backend proxy can be enhanced to include Translation data. For now, make the function work with optional CDS params:
   ```typescript
   export function classifyExons(
     exons: EnsemblExon[],
     strand: number,
     cdsStart?: number,
     cdsEnd?: number
   ): ClassifiedExon[]
   ```
   - If cdsStart/cdsEnd are provided: classify exons relative to CDS boundaries considering strand direction
   - If not provided: all exons classified as 'coding' (safe fallback)
   - Number exons 1-based in genomic order (left-to-right ascending coordinates regardless of strand)

8. **calculateIntrons** function (exported):
   ```typescript
   export function calculateIntrons(exons: ClassifiedExon[]): Intron[]
   ```
   - Assumes exons are sorted by start coordinate
   - For each consecutive pair of exons, create an intron from exon[i].end to exon[i+1].start
   - Skip if gap <= 0 (overlapping exons, which shouldn't normally happen)

9. **formatGenomicCoordinate** function (exported):
   ```typescript
   export function formatGenomicCoordinate(value: number): string
   ```
   Custom formatter for genomic coordinates:
   - >= 1,000,000: format as "X.XX Mb" (e.g., 12350000 -> "12.35 Mb")
   - >= 1,000: format as "X.X kb" (e.g., 45600 -> "45.6 kb")
   - < 1,000: format as "X bp" (e.g., 456 -> "456 bp")

10. **processEnsemblResponse** function (exported):
    ```typescript
    export function processEnsemblResponse(
      data: EnsemblGeneStructure,
      cdsStart?: number,
      cdsEnd?: number
    ): GeneStructureRenderData
    ```
    Orchestrates the full processing pipeline:
    - Classify exons (with optional CDS boundaries)
    - Calculate introns
    - Convert strand from 1/-1 to '+'/'-'
    - Compute gene length and exon count
    - Return GeneStructureRenderData ready for D3 rendering

Update `app/src/types/index.ts` to add `export * from './ensembl';` after the existing exports.
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` and confirm no TypeScript errors. Verify barrel export: `grep "ensembl" app/src/types/index.ts`.
  </verify>
  <done>
TypeScript interfaces exist in `app/src/types/ensembl.ts` with EnsemblGeneStructure, ClassifiedExon, GeneStructureRenderData types plus classifyExons, calculateIntrons, formatGenomicCoordinate, and processEnsemblResponse helper functions. All exported via barrel. Type-check passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useD3GeneStructure composable for D3 lifecycle management</name>
  <files>app/src/composables/useD3GeneStructure.ts, app/src/composables/index.ts</files>
  <action>
Create `app/src/composables/useD3GeneStructure.ts` following the useCytoscape.ts / useD3Lollipop.ts pattern:

1. **Interface GeneStructureOptions:**
   - container: Ref&lt;HTMLElement | null&gt; (container element ref)
   - scrollContainer: Ref&lt;HTMLElement | null&gt; (parent scroll container for horizontal overflow)

2. **CRITICAL: Non-reactive D3 state** (same as useCytoscape `let cy` pattern):
   ```typescript
   let svg: d3.Selection<SVGSVGElement, unknown, null, undefined> | null = null;
   let tooltipDiv: d3.Selection<HTMLDivElement, unknown, null, undefined> | null = null;
   ```
   Do NOT use ref() for D3 selections -- causes Vue layout thrashing.

3. **Constants:**
   - CODING_HEIGHT = 20 (px, tall coding exon rectangles)
   - UTR_HEIGHT = 10 (px, shorter UTR rectangles -- UCSC convention)
   - CODING_COLOR = '#2563eb' (Tailwind blue-600)
   - UTR_COLOR = '#93c5fd' (Tailwind blue-300)
   - INTRON_COLOR = '#9ca3af' (Tailwind gray-400)
   - EXON_STROKE = '#1e40af' (Tailwind blue-800)
   - MARGIN = { top: 20, right: 30, bottom: 35, left: 30 }
   - STRIP_HEIGHT = 60 (total SVG height in px)
   - MIN_SVG_WIDTH = 600 (minimum width for small genes)
   - PIXELS_PER_BP = 0.05 (default scale: 1kb = 50px)

4. **Reactive state** (for UI binding):
   - isInitialized: ref(false)

5. **renderGeneStructure(data: GeneStructureRenderData):**
   Main rendering function. Steps:

   a. Guard: return early if container ref is null.

   b. **Calculate SVG width:**
      - Calculate from gene length: `data.geneLength * PIXELS_PER_BP`
      - Enforce minimum: `Math.max(calculated, MIN_SVG_WIDTH)`
      - The scroll container div handles overflow -- SVG gets absolute pixel width, NOT viewBox scaling
      - Set the container div width to the calculated SVG width so scroll container can scroll

   c. **Clear previous render:** Remove existing SVG and tooltip from container.

   d. **Create SVG:**
      - Append SVG element to container with calculated width and STRIP_HEIGHT
      - Add `role="img"` and `aria-label` for accessibility: "Gene structure diagram for {geneSymbol} showing {exonCount} exons on chromosome {chromosome}"
      - Create main group with margin transform

   e. **Create scales:**
      - xScale: d3.scaleLinear() mapping [data.geneStart, data.geneEnd] to [0, plotWidth]
      - yBase: center of plot area (plotHeight / 2)

   f. **Create strand arrow marker (SVG defs):**
      - Define SVG `<marker>` element with id "strand-arrow"
      - For '+' strand: right-pointing arrowhead (path "M 0 0 L 6 3 L 0 6")
      - For '-' strand: left-pointing arrowhead (path "M 6 0 L 0 3 L 6 6")
      - Fill color: INTRON_COLOR
      - markerWidth/Height: 6, refX/Y positioned for line endpoints

   g. **Render intron lines (back layer):**
      - For each intron: draw a `<line>` from xScale(intron.start) to xScale(intron.end) at yBase
      - Stroke: INTRON_COLOR, stroke-width: 1
      - Add `marker-mid` or multiple small arrowhead markers along long introns:
        - For introns wider than 30px in rendered space: place arrowhead markers at regular intervals along the intron line (every 20-30px) to show strand direction
        - Implementation: Instead of a single line with marker-end, break long introns into segments with a polyline or add small arrow paths at intervals
        - Simpler approach: Use `marker-end="url(#strand-arrow)"` on each intron line -- this places one arrow at the end of each intron connector, sufficient for strand indication

   h. **Render exon rectangles (front layer):**
      - For each ClassifiedExon: draw a `<rect>` element
      - x: xScale(exon.start)
      - width: xScale(exon.end) - xScale(exon.start), minimum 2px (so tiny exons are visible)
      - height: CODING_HEIGHT for 'coding', UTR_HEIGHT for '5_utr'/'3_utr'
      - y: yBase - height/2 (centered vertically on the baseline)
      - fill: CODING_COLOR for coding, UTR_COLOR for UTR
      - stroke: EXON_STROKE, stroke-width: 0.5
      - cursor: pointer
      - Attach mouseover/mouseout event handlers for tooltip

   i. **Render coordinate axis (bottom):**
      - Create d3.axisBottom(xScale) with ~5 ticks
      - Custom tickFormat using formatGenomicCoordinate from ensembl.ts
      - First tick label should include chromosome name: e.g., "chr17: 12.35 Mb"
      - Or: add a separate chromosome label at the left side of the axis
      - Style: font-size 9px, fill gray-500

   j. **Render strand label:**
      - Small text near top-left of the strip: "+ strand" or "- strand"
      - font-size 9px, fill gray-500

   k. **Render transcript ID and summary subtitle:**
      - Above or below the strip: Ensembl transcript ID (e.g., "ENST00000302278")
      - Summary: "{N} exons . {X.X kb}" using formatGenomicCoordinate for gene length
      - font-size 9px, fill gray-500

   l. **Render scale bar:**
      - Below the axis, calculate appropriate scale bar length:
        - Gene > 100kb: 10 kb bar
        - Gene > 10kb: 1 kb bar
        - Gene <= 10kb: 100 bp bar
      - Draw horizontal line with end caps and label (e.g., "10 kb")
      - Position at bottom-left of the SVG

   m. **Create tooltip:**
      - Append a div to the container (NOT the SVG -- divs can't be inside SVG)
      - Position: absolute, initially hidden (opacity 0)
      - Style: white background, border, border-radius, padding, box-shadow, pointer-events none, z-index 1000
      - On exon mouseover: show tooltip with:
        - "Exon {number}" (bold)
        - Type label ("Coding exon", "5' UTR", "3' UTR")
        - Size: formatGenomicCoordinate(exon.end - exon.start)
        - Coordinates: "start - end" with locale number formatting
      - Edge detection: check if tooltip would overflow viewport right/bottom, reposition if needed (reuse Phase 43 edge-aware tooltip pattern)
      - On mouseout: hide tooltip

   Set isInitialized to true after successful render.

6. **cleanup():**
   - Remove SVG: `d3.select(container.value).select('svg').remove()`
   - Remove tooltip div
   - Null all references (svg, tooltipDiv)
   - Set isInitialized to false

7. **Lifecycle hooks:**
   - onBeforeUnmount: call cleanup() -- CRITICAL for memory leak prevention

8. **Return object:**
   ```typescript
   return {
     isInitialized: readonly(isInitialized),
     renderGeneStructure,
     cleanup,
   };
   ```

CRITICAL PATTERNS (from RESEARCH.md and STATE.md):
- Do NOT store D3 selections in ref() -- use let variables (pitfall from useCytoscape)
- D3 owns SVG element exclusively -- Vue does not touch it (pitfall #4 from STATE.md)
- Always implement tooltip edge detection
- Use absolute SVG width with CSS overflow-x: auto wrapper -- NOT viewBox scaling (anti-pattern from RESEARCH.md)
- Coordinate axis always increases left-to-right regardless of strand

Import d3 as: `import * as d3 from 'd3';`
Import types from ensembl.ts.

Update `app/src/composables/index.ts` to add barrel export:
```typescript
// D3 gene structure composable
export { useD3GeneStructure } from './useD3GeneStructure';
```
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` and confirm no TypeScript errors. Verify barrel export: `grep "useD3GeneStructure" app/src/composables/index.ts`. Verify non-reactive pattern: `grep "let svg" app/src/composables/useD3GeneStructure.ts`. Verify cleanup: `grep "onBeforeUnmount" app/src/composables/useD3GeneStructure.ts`.
  </verify>
  <done>
useD3GeneStructure composable exists with D3 lifecycle management (render/cleanup), exon/intron/UTR rendering with height distinction, strand arrow markers, coordinate axis with Mb/kb/bp formatting, scale bar, transcript ID label, exon tooltip with edge detection, and proper onBeforeUnmount cleanup. Non-reactive D3 state stored in let variables. Horizontal scrolling supported via absolute SVG width. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors
2. `grep -r "EnsemblGeneStructure" app/src/types/ensembl.ts` -- interface exists
3. `grep -r "ClassifiedExon" app/src/types/ensembl.ts` -- interface exists
4. `grep -r "classifyExons" app/src/types/ensembl.ts` -- function exported
5. `grep -r "formatGenomicCoordinate" app/src/types/ensembl.ts` -- function exported
6. `grep -r "processEnsemblResponse" app/src/types/ensembl.ts` -- function exported
7. `grep -r "useD3GeneStructure" app/src/composables/index.ts` -- barrel export exists
8. `grep "ensembl" app/src/types/index.ts` -- barrel re-export exists
9. `grep "let svg" app/src/composables/useD3GeneStructure.ts` -- non-reactive pattern
10. `grep "onBeforeUnmount" app/src/composables/useD3GeneStructure.ts` -- cleanup registered
</verification>

<success_criteria>
- TypeScript interfaces define complete Ensembl gene structure data contract (gene, transcript, exons)
- classifyExons handles both coding and UTR exon types (with optional CDS coordinates)
- formatGenomicCoordinate converts coordinates to abbreviated Mb/kb/bp format
- processEnsemblResponse transforms raw API data to render-ready format
- useD3GeneStructure composable manages D3 lifecycle with non-reactive instance storage
- Exon rectangles rendered with height distinction (tall=coding, short=UTR, UCSC convention)
- Intron lines with strand direction arrowheads
- Coordinate axis with abbreviated genomic format
- Scale bar with adaptive length
- Tooltip with exon details and edge detection
- Memory leak prevention via onBeforeUnmount cleanup
- All files type-check without errors
- Barrel exports updated
</success_criteria>

<output>
After completion, create `.planning/phases/44-gene-structure-visualization/44-01-SUMMARY.md`
</output>
