---
phase: 44-gene-structure-visualization
plan: 02
type: execute
wave: 2
depends_on: ["44-01"]
files_modified:
  - app/src/components/gene/GeneStructurePlot.vue
  - app/src/components/gene/GeneStructureCard.vue
autonomous: true

must_haves:
  truths:
    - "GeneStructurePlot renders exons as blue rectangles with UTRs visually shorter than coding exons"
    - "Intron connector lines display strand-direction arrowheads between exons"
    - "Chromosome coordinate axis shows abbreviated positions in Mb/kb format"
    - "Hovering an exon shows tooltip with exon number, type, size, and coordinates"
    - "Large genes scroll horizontally within a contained strip layout"
    - "Strand label and transcript ID are displayed near the gene structure strip"
    - "GeneStructureCard handles loading, error, and empty states with graceful fallback"
    - "Card fetches Ensembl data directly via its own API call to the per-source endpoint"
  artifacts:
    - path: "app/src/components/gene/GeneStructurePlot.vue"
      provides: "D3 gene structure visualization component with scroll container"
      min_lines: 50
    - path: "app/src/components/gene/GeneStructureCard.vue"
      provides: "Card wrapper with loading/error/empty states and Ensembl data fetching"
      min_lines: 60
  key_links:
    - from: "app/src/components/gene/GeneStructurePlot.vue"
      to: "app/src/composables/useD3GeneStructure.ts"
      via: "import composable"
      pattern: "useD3GeneStructure"
    - from: "app/src/components/gene/GeneStructurePlot.vue"
      to: "app/src/types/ensembl.ts"
      via: "import types"
      pattern: "import.*GeneStructureRenderData"
    - from: "app/src/components/gene/GeneStructureCard.vue"
      to: "app/src/components/gene/GeneStructurePlot.vue"
      via: "child component"
      pattern: "GeneStructurePlot"
    - from: "app/src/components/gene/GeneStructureCard.vue"
      to: "app/src/types/ensembl.ts"
      via: "import processing functions"
      pattern: "processEnsemblResponse"
    - from: "app/src/components/gene/GeneStructureCard.vue"
      to: "/api/external/ensembl/structure/"
      via: "axios GET request"
      pattern: "ensembl/structure"
---

<objective>
Create the GeneStructurePlot.vue visualization component and GeneStructureCard.vue wrapper that fetches Ensembl data, handles loading/error states, and renders the compact gene structure strip.

Purpose: These two components implement GENSTRUCT-01 through GENSTRUCT-04. The card handles data fetching and state management while the plot component renders the D3 visualization. The card fetches directly from the per-source Ensembl endpoint (`/api/external/ensembl/structure/<symbol>`) rather than depending on a shared composable that does not yet exist (Phase 42's useGeneExternalData).

Output: `app/src/components/gene/GeneStructurePlot.vue` (D3 rendering), `app/src/components/gene/GeneStructureCard.vue` (card wrapper with data fetching).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-gene-structure-visualization/44-CONTEXT.md
@.planning/phases/44-gene-structure-visualization/44-RESEARCH.md
@.planning/phases/44-gene-structure-visualization/44-01-SUMMARY.md

Key references:
@app/src/composables/useD3GeneStructure.ts (composable from Plan 01)
@app/src/types/ensembl.ts (types and helpers from Plan 01)
@app/src/components/gene/IdentifierCard.vue (card styling pattern -- BCard with shadow-sm, border-0)
@app/src/components/gene/ClinicalResourcesCard.vue (card pattern reference)
@api/functions/external-proxy-ensembl.R (backend response shape confirmation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GeneStructurePlot Vue component</name>
  <files>app/src/components/gene/GeneStructurePlot.vue</files>
  <action>
Create `app/src/components/gene/GeneStructurePlot.vue` as a Vue 3 SFC with `<script setup lang="ts">`:

**Props:**
- data: GeneStructureRenderData (required) -- processed gene structure data ready for D3 rendering

**Template structure:**
```html
<div class="gene-structure-plot">
  <!-- Horizontal scroll container for wide SVGs (large genes) -->
  <div ref="scrollContainer" class="gene-structure-scroll-container">
    <!-- D3 owns this element exclusively -->
    <div ref="plotContainer" class="gene-structure-plot-inner"></div>
  </div>
</div>
```

**Script setup logic:**

1. **Refs:**
   - plotContainer: ref<HTMLElement | null>(null) -- template ref for D3 SVG container
   - scrollContainer: ref<HTMLElement | null>(null) -- template ref for scroll wrapper

2. **useD3GeneStructure composable:**
   ```typescript
   const { isInitialized, renderGeneStructure, cleanup } = useD3GeneStructure({
     container: plotContainer,
     scrollContainer: scrollContainer,
   });
   ```

3. **watchEffect for reactive rendering:**
   ```typescript
   watchEffect(() => {
     if (plotContainer.value && props.data) {
       renderGeneStructure(props.data);
     }
   });
   ```
   This re-renders when data changes (e.g., navigation between genes).

4. **Watch for data prop changes with deep option:**
   Also watch props.data and call renderGeneStructure when it changes. This ensures proper re-render on gene-to-gene navigation.

**Scoped styles:**
```css
.gene-structure-scroll-container {
  width: 100%;
  overflow-x: auto;
  overflow-y: hidden;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  background: #f8f9fa;
}

.gene-structure-scroll-container::-webkit-scrollbar {
  height: 6px;
}

.gene-structure-scroll-container::-webkit-scrollbar-track {
  background: #f1f1f1;
}

.gene-structure-scroll-container::-webkit-scrollbar-thumb {
  background: #adb5bd;
  border-radius: 3px;
}

.gene-structure-scroll-container::-webkit-scrollbar-thumb:hover {
  background: #6c757d;
}

.gene-structure-plot-inner {
  min-width: 100%;
  position: relative;
}
```

**Important implementation notes:**
- D3 owns the SVG element inside plotContainer exclusively (D3 vs Vue DOM ownership)
- The scroll container provides CSS overflow-x: auto so large genes can scroll
- The inner container width is set dynamically by the composable based on gene length
- Do NOT use viewBox scaling -- absolute pixel width with scroll (per RESEARCH.md anti-pattern)
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors. Verify component imports useD3GeneStructure and GeneStructureRenderData correctly.
  </verify>
  <done>
GeneStructurePlot.vue renders the D3 gene structure visualization within a horizontal scroll container. Uses useD3GeneStructure composable for D3 lifecycle management. Reactive to data prop changes for gene-to-gene navigation. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GeneStructureCard wrapper component with Ensembl data fetching</name>
  <files>app/src/components/gene/GeneStructureCard.vue</files>
  <action>
Create `app/src/components/gene/GeneStructureCard.vue` as a Vue 3 SFC with `<script setup lang="ts">`:

**Props:**
- geneSymbol: string (required) -- gene symbol to fetch Ensembl data for

**Template structure:**
```html
<BCard
  class="shadow-sm border-0 mb-3"
  body-class="p-2"
  header-class="py-2 px-3"
>
  <template #header>
    <div class="d-flex justify-content-between align-items-center">
      <h6 class="mb-0 fw-bold">
        <i class="bi bi-bar-chart-steps" /> Gene Structure
      </h6>
      <span v-if="renderData" class="text-muted small">
        {{ renderData.exonCount }} exon{{ renderData.exonCount !== 1 ? 's' : '' }}
        &bull;
        {{ formattedGeneLength }}
      </span>
    </div>
  </template>

  <!-- State 1: Loading -->
  <div v-if="loading" class="d-flex justify-content-center py-3">
    <BSpinner small label="Loading gene structure..." />
  </div>

  <!-- State 2: Error -->
  <div v-else-if="error" class="text-center py-3">
    <p class="text-muted mb-2 small">
      <i class="bi bi-exclamation-triangle" /> {{ error }}
    </p>
    <BButton variant="outline-primary" size="sm" @click="fetchEnsemblData">
      <i class="bi bi-arrow-clockwise" /> Retry
    </BButton>
  </div>

  <!-- State 3: Data available -->
  <div v-else-if="renderData">
    <GeneStructurePlot :data="renderData" />
  </div>

  <!-- State 4: No data (gene not found in Ensembl or no canonical transcript) -->
  <div v-else class="text-center py-3 text-muted small">
    <i class="bi bi-bar-chart-steps" /> No gene structure data available
  </div>
</BCard>
```

**Script setup logic:**

1. **Imports:**
   ```typescript
   import { ref, computed, watch, onMounted } from 'vue';
   import { BCard, BSpinner, BButton } from 'bootstrap-vue-next';
   import axios from 'axios';
   import GeneStructurePlot from './GeneStructurePlot.vue';
   import {
     processEnsemblResponse,
     formatGenomicCoordinate,
   } from '@/types/ensembl';
   import type { EnsemblGeneStructure, GeneStructureRenderData } from '@/types/ensembl';
   ```

2. **Reactive state:**
   ```typescript
   const loading = ref(false);
   const error = ref<string | null>(null);
   const ensemblData = ref<EnsemblGeneStructure | null>(null);
   ```

3. **Computed: renderData** -- process raw API response into render-ready data:
   ```typescript
   const renderData = computed<GeneStructureRenderData | null>(() => {
     if (!ensemblData.value) return null;
     return processEnsemblResponse(ensemblData.value);
   });
   ```

4. **Computed: formattedGeneLength:**
   ```typescript
   const formattedGeneLength = computed(() => {
     if (!renderData.value) return '';
     return formatGenomicCoordinate(renderData.value.geneLength);
   });
   ```

5. **fetchEnsemblData function:**
   ```typescript
   async function fetchEnsemblData() {
     if (!props.geneSymbol) return;
     loading.value = true;
     error.value = null;
     ensemblData.value = null;

     try {
       const apiBase = import.meta.env.VITE_API_URL;
       const response = await axios.get(
         `${apiBase}/api/external/ensembl/structure/${props.geneSymbol}`
       );

       // Check for API-level not-found or error
       if (response.data?.found === false) {
         // Gene not found in Ensembl -- show empty state (not error)
         ensemblData.value = null;
       } else if (response.data?.error) {
         error.value = response.data.message || 'Failed to load gene structure';
       } else {
         ensemblData.value = response.data as EnsemblGeneStructure;
       }
     } catch (e: unknown) {
       if (axios.isAxiosError(e) && e.response?.status === 404) {
         // 404 = gene not found, show empty state
         ensemblData.value = null;
       } else if (axios.isAxiosError(e) && e.response?.status === 503) {
         error.value = 'Ensembl API temporarily unavailable';
       } else {
         error.value = 'Failed to load gene structure data';
       }
     }

     loading.value = false;
   }
   ```

   **Why fetch per-source endpoint directly (not combined endpoint):**
   - The `useGeneExternalData` composable from Phase 42 does not exist yet
   - The per-source endpoint `/api/external/ensembl/structure/<symbol>` is simpler and avoids fetching unnecessary data from other sources
   - When Phase 42 executes and creates the shared composable, this card can optionally be refactored to accept Ensembl data as a prop (same pattern as ProteinDomainLollipopCard)
   - For now, self-contained fetching makes this component independent and testable

6. **Lifecycle and watchers:**
   ```typescript
   onMounted(() => {
     fetchEnsemblData();
   });

   // Re-fetch when gene symbol changes (gene-to-gene navigation)
   watch(() => props.geneSymbol, (newSymbol) => {
     if (newSymbol) {
       fetchEnsemblData();
     }
   });
   ```

**Important: Error response handling.**
The Ensembl backend endpoint returns:
- 200 with gene structure data on success
- 404 with RFC 9457 error body when gene not found
- 503 when Ensembl API is unavailable
- 400 for invalid gene symbol

Handle each status appropriately -- 404 is a "no data" state (not an error to the user), 503 is a retryable error.
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors. Verify component handles all 4 states (loading, error, data, empty). Verify it fetches from the Ensembl per-source endpoint: `grep "ensembl/structure" app/src/components/gene/GeneStructureCard.vue`.
  </verify>
  <done>
GeneStructureCard.vue fetches Ensembl gene structure data from `/api/external/ensembl/structure/<symbol>`, processes it via processEnsemblResponse, handles loading/error/empty/data states with appropriate UI, displays summary (exon count + gene length) in card header, and renders GeneStructurePlot when data is available. Re-fetches on gene-to-gene navigation. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors
2. Component file exists at `app/src/components/gene/GeneStructurePlot.vue`
3. Component file exists at `app/src/components/gene/GeneStructureCard.vue`
4. GeneStructurePlot imports useD3GeneStructure composable
5. GeneStructurePlot has horizontal scroll container CSS
6. GeneStructureCard imports processEnsemblResponse and formatGenomicCoordinate
7. GeneStructureCard has 4 UI states (loading, error, data, empty)
8. GeneStructureCard fetches from `/api/external/ensembl/structure/` endpoint
9. GeneStructureCard re-fetches on geneSymbol prop change
10. `grep "GeneStructurePlot" app/src/components/gene/GeneStructureCard.vue` -- child component used
</verification>

<success_criteria>
- GENSTRUCT-01: Gene structure plot displays exons and introns from Ensembl canonical transcript
- GENSTRUCT-02: Exons rendered as rectangles (tall coding, short UTR), introns as lines with arrowheads
- GENSTRUCT-03: Strand direction indicated by arrowheads on intron lines and explicit strand label
- GENSTRUCT-04: Chromosome coordinates displayed on axis with abbreviated Mb/kb format
- Card handles loading, error, empty, and data states gracefully
- Large genes scroll horizontally within contained strip
- Tooltip shows exon details on hover
- Component fetches data independently from Ensembl endpoint
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/44-gene-structure-visualization/44-02-SUMMARY.md`
</output>
