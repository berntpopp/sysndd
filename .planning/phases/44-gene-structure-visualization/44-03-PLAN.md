---
phase: 44-gene-structure-visualization
plan: 03
type: execute
wave: 3
depends_on: ["44-02"]
files_modified:
  - app/src/views/pages/GeneView.vue
autonomous: false

must_haves:
  truths:
    - "Gene structure card appears on the gene page below the gene info card"
    - "Gene structure card loads independently and does not block gene info or entity table rendering"
    - "Gene structure card shows exon rectangles with intron connector lines for a real gene"
    - "Gene structure card shows loading spinner while Ensembl data fetches"
    - "Navigating between genes re-fetches and re-renders the gene structure"
  artifacts:
    - path: "app/src/views/pages/GeneView.vue"
      provides: "Updated gene page with gene structure card integrated"
  key_links:
    - from: "app/src/views/pages/GeneView.vue"
      to: "app/src/components/gene/GeneStructureCard.vue"
      via: "child component in template"
      pattern: "GeneStructureCard"
---

<objective>
Integrate the GeneStructureCard into GeneView.vue and perform visual verification of the complete gene structure visualization.

Purpose: Connects the gene structure visualization to the gene page. The card is placed between the gene info card and the entities table, loading its own data independently. A visual checkpoint confirms all GENSTRUCT requirements are satisfied visually.

Output: Updated `app/src/views/pages/GeneView.vue` with GeneStructureCard integrated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-gene-structure-visualization/44-CONTEXT.md
@.planning/phases/44-gene-structure-visualization/44-RESEARCH.md
@.planning/phases/44-gene-structure-visualization/44-01-SUMMARY.md
@.planning/phases/44-gene-structure-visualization/44-02-SUMMARY.md

Key references:
@app/src/views/pages/GeneView.vue (current gene page -- needs integration)
@app/src/components/gene/GeneStructureCard.vue (card component from Plan 02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate GeneStructureCard into GeneView.vue</name>
  <files>app/src/views/pages/GeneView.vue</files>
  <action>
Update `app/src/views/pages/GeneView.vue` to add the gene structure card:

1. **Add import:**
   ```typescript
   import GeneStructureCard from '@/components/gene/GeneStructureCard.vue';
   ```
   Add this alongside the existing component imports (GeneBadge, IdentifierCard, ClinicalResourcesCard, TablesEntities).

2. **Add GeneStructureCard to template:**
   Place it between the gene info BCard and the TablesEntities component. The card fetches its own data (no prop passing needed beyond geneSymbol), so it is self-contained.

   In the existing template structure, after the closing `</div>` of the gene info card container and before `<TablesEntities>`, add:

   ```html
   <!-- Gene Structure Visualization (GENSTRUCT-01 through GENSTRUCT-04) -->
   <div class="container-fluid">
     <BContainer fluid>
       <BRow class="justify-content-md-center pt-2">
         <BCol col md="12">
           <GeneStructureCard
             v-if="geneSymbol"
             :gene-symbol="geneSymbol"
           />
         </BCol>
       </BRow>
     </BContainer>
   </div>
   ```

   **Layout placement rationale:**
   - Below gene info card (hero + identifiers + clinical resources)
   - Above entities table
   - Full width (md="12") since gene structure is a horizontal strip
   - Wrapped in same container-fluid/BContainer/BRow pattern as the gene info card for consistent spacing
   - Only renders when geneSymbol is available (v-if="geneSymbol")
   - The card handles its own loading/error states -- no additional logic needed in GeneView

3. **No additional data fetching needed in GeneView:**
   The GeneStructureCard component manages its own data lifecycle:
   - Fetches from `/api/external/ensembl/structure/<symbol>` on mount
   - Re-fetches when geneSymbol prop changes (gene-to-gene navigation)
   - Handles loading, error, and empty states internally

   This keeps GeneView.vue clean and focused. When Phase 42 adds the shared `useGeneExternalData` composable, the gene structure card can optionally be refactored to accept Ensembl data as a prop from the shared fetch.

4. **Verify existing functionality preserved:**
   - Gene info card (GeneBadge, ClinicalResourcesCard, IdentifierCard) still renders first
   - TablesEntities still renders below
   - Loading spinner still shows while gene data loads
   - Route watcher for gene-to-gene navigation still works (the card watches its own prop)
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors. Run `cd /home/bernt-popp/development/sysndd/app && npx vite build --mode development 2>&1 | tail -5` -- build succeeds. Verify integration: `grep "GeneStructureCard" app/src/views/pages/GeneView.vue`.
  </verify>
  <done>
GeneView.vue imports and renders GeneStructureCard below the gene info card and above TablesEntities. Card renders only when geneSymbol is available. No additional data fetching logic added to GeneView -- the card is self-contained. Build compiles successfully. Existing gene page functionality preserved.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete gene structure visualization (Phase 44): TypeScript types and helpers for Ensembl data, D3.js rendering composable for exon/intron/UTR visualization, GeneStructurePlot component with horizontal scroll, GeneStructureCard with self-contained data fetching, integrated into GeneView.vue.</what-built>
  <how-to-verify>
1. Start the dev server: `cd /home/bernt-popp/development/sysndd && docker compose up -d` (or however the local dev environment runs)
2. Navigate to a known gene page, e.g., http://localhost:3000/gene/BRCA1 or the equivalent local URL
3. Verify the gene structure card appears below the gene info card:

**GENSTRUCT-01: Exons and introns from canonical transcript**
   - [ ] Blue rectangles (exons) are visible in the gene structure strip
   - [ ] Lines connecting exons (introns) are visible
   - [ ] Multiple exons are shown (BRCA1 should have ~23 exons)

**GENSTRUCT-02: Exons as rectangles, introns as lines, UTR distinction**
   - [ ] Coding exons appear as taller blue rectangles
   - [ ] If UTR regions are classified: UTR exons appear shorter and lighter blue
   - [ ] If UTR regions are not classified (fallback): all exons appear uniform (acceptable for initial release)
   - [ ] Introns appear as gray lines connecting exons

**GENSTRUCT-03: Strand orientation indicated**
   - [ ] Small arrowheads visible on intron lines showing strand direction
   - [ ] Strand label visible (e.g., "- strand" for BRCA1 which is on minus strand)

**GENSTRUCT-04: Chromosome coordinates on axis**
   - [ ] X-axis shows genomic positions in abbreviated format (e.g., "43.04 Mb")
   - [ ] Chromosome name visible (e.g., "chr17")

**Additional checks:**
   - [ ] Card header shows "Gene Structure" with exon count and gene length summary
   - [ ] Hovering an exon shows tooltip with exon number, type, size, coordinates
   - [ ] For a large gene, horizontal scrollbar appears and scroll works
   - [ ] Navigate to a second gene (e.g., /gene/TP53) -- structure updates correctly
   - [ ] Navigate to a non-existent gene or gene without Ensembl data -- empty state shows "No gene structure data available"
   - [ ] Gene info card and entities table still render correctly (no regression)

5. If any issues found, describe them for correction.
  </how-to-verify>
  <resume-signal>Type "approved" to confirm all GENSTRUCT requirements pass visual verification, or describe any issues that need fixing.</resume-signal>
</task>

</tasks>

<verification>
1. `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors
2. `cd /home/bernt-popp/development/sysndd/app && npx vite build --mode development 2>&1 | tail -5` -- build succeeds
3. `grep "GeneStructureCard" app/src/views/pages/GeneView.vue` -- component integrated
4. Gene structure card visible on gene page
5. All 4 GENSTRUCT requirements visually verified
6. Gene page existing functionality preserved (no regression)
</verification>

<success_criteria>
- GeneStructureCard appears on gene page for genes with Ensembl data
- Exons render as blue rectangles with intron connector lines (GENSTRUCT-01)
- UTR regions visually distinguished from coding exons where possible (GENSTRUCT-02)
- Strand direction indicated by arrowheads and label (GENSTRUCT-03)
- Chromosome coordinates shown on axis in abbreviated format (GENSTRUCT-04)
- Gene-to-gene navigation updates the visualization
- No regression in existing gene page functionality
- Build compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/44-gene-structure-visualization/44-03-SUMMARY.md`
</output>
