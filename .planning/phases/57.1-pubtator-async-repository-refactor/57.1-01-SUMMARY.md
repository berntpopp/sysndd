---
phase: 57.1-pubtator-async-repository-refactor
plan: 01
subsystem: api
tags: [sql-injection, security, parameterized-queries, dbi, pubtator, async]

# Dependency graph
requires:
  - phase: 57
    provides: PubTator async job infrastructure
provides:
  - Secure SQL operations in pubtator_db_update_async() via parameterized queries
  - No SQL injection vulnerability in async PubTator operations
  - Consistent db-helpers usage pattern for direct connections
affects: [59, 60]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "db_execute_query/db_execute_statement with conn parameter for direct connections"
    - "Manual transaction handling (dbBegin/dbCommit/dbRollback) with parameterized queries"

key-files:
  created: []
  modified:
    - api/functions/pubtator-functions.R
    - api/functions/helper-functions.R  # ifelse() fix for filter expressions
    - api/tests/testthat/test-unit-helper-functions.R  # tests for ifelse() fix
    - app/src/components/analyses/PubtatorNDDTable.vue  # server-side sorting fix
    - app/src/components/analyses/PubtatorNDDStats.vue  # UI improvements

key-decisions:
  - "Preserve manual transaction handling - db_with_transaction uses pool, not direct connections"
  - "Use NA values directly in parameter lists - DBI handles NA to NULL conversion automatically"

patterns-established:
  - "Direct connection parameterized queries: db_execute_query(sql, params, conn = conn)"
  - "Direct connection parameterized statements: db_execute_statement(sql, params, conn = conn)"

# Metrics
duration: 3min
completed: 2026-01-31
---

# Phase 57.1 Plan 01: PubTator Async Repository Refactor Summary

**Eliminated SQL injection vulnerability in pubtator_db_update_async() by replacing all sprintf-based SQL construction with parameterized queries using db_execute_query() and db_execute_statement()**

## Performance

- **Duration:** 3 min
- **Started:** 2026-01-31T22:31:51Z
- **Completed:** 2026-01-31T22:34:48Z
- **Tasks:** 3/3
- **Files modified:** 1

## Accomplishments

- Converted all SELECT queries to use `db_execute_query()` with ? placeholders and `conn = conn` parameter
- Converted all INSERT/UPDATE/DELETE statements to use `db_execute_statement()` with ? placeholders
- Removed all manual SQL escaping (gsub for single quotes) - DBI handles NA/NULL automatically
- Gene symbol computation JOIN query now uses parameterized approach
- Preserved manual transaction handling (dbBegin/dbCommit/dbRollback) for mirai daemon context

## Task Commits

All tasks completed in a single atomic commit (tasks are interdependent - partial refactoring would leave code in inconsistent state):

1. **Task 1: Refactor query operations** - `691c3404` (refactor)
2. **Task 2: Refactor statement operations** - `691c3404` (refactor)
3. **Task 3: Gene symbol computation and verification** - `691c3404` (refactor)

## Files Created/Modified

- `api/functions/pubtator-functions.R` - pubtator_db_update_async() now uses parameterized queries for all SQL operations

## Decisions Made

| Decision | Rationale | Impact |
|----------|-----------|--------|
| Single commit for all tasks | Tasks are interdependent - partial refactoring would break the function | Atomic change ensures code is always in working state |
| Preserve manual transaction handling | db_with_transaction uses pool, mirai daemons need direct connections | dbBegin/dbCommit/dbRollback still used, only query execution changed |
| Use NA directly in params | DBI's dbBind() handles NA to NULL conversion automatically | Simpler code, no manual ifelse(is.na(...), "NULL", ...) needed |

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- **R not installed in execution environment:** Unable to run `make lint-api` and `make test-api` directly
  - **Resolution:** Verified code structure and syntax manually; 120-char line limit verified; no sprintf SQL construction remains in async function
  - **Note:** Tests should be run before merging via CI pipeline or local Docker environment

## User Setup Required

None - no external service configuration required.

## Post-Phase Fixes (2026-02-01)

Additional fixes applied after phase completion to address bugs discovered during testing:

### 1. PubtatorNDDTable Server-Side Sorting Fix

**Commit:** `1ee93e99 fix(57.1): implement server-side sorting correctly for PubtatorNDDTable`

- Fixed sorting not changing columns when clicking headers (only toggled direction)
- Root cause: `handleSortUpdate(ctx)` stored `ctx.sortBy` (string) but component expected array format
- Fix: Convert string to array format in handleSortUpdate, use deep watch for array-based sortBy
- Followed pattern from TablesEntities.vue (DRY principle)

### 2. PubtatorNDDStats UI Improvements

**Commits:** Part of ongoing PubTator improvements

- Conditionally show/hide Min Count input based on category (only visible in "gene" mode)
- Empty state handling: shows user-friendly message when filters return no data
- Dynamic column widths and "Top N" â†’ "Max Bins" label change for publication category

### 3. Filter Expressions Vectorization Fix

**Commit:** `2ecf3d4a fix(api): use ifelse() instead of if() in filter expressions`

- Fixed 500 errors on VariantCorrelations and VariantCounts pages
- Root cause: `if()` in R is not vectorized, but `filter_value` in `case_when` context is a vector
- Fix: Replaced all 18 occurrences of `if(grepl(...))` with `ifelse(grepl(...), ..., ...)` in `generate_filter_expressions()`
- Affected file: `api/functions/helper-functions.R`

### 4. Tests for Filter Expressions Fix

**Commit:** `ebcc1660 test(api): add tests for numeric comparison filter expressions`

- Added 5 new unit tests for numeric comparison operators:
  - `greaterThan` with numeric values
  - `lessThan` with numeric values
  - `greaterThanOrEquals` with numeric values
  - `lessThanOrEquals` with numeric values
  - Combined numeric filters in `and()` expressions
- Verifies the ifelse() fix works correctly in vectorized contexts

## Next Phase Readiness

- pubtator_db_update_async() is now secure against SQL injection
- Async job submission endpoint (/api/jobs/pubtator_update/submit) maintains same interface
- PubtatorNDD components (Table, Stats) are stable with proper server-side operations
- Ready for Phase 59 (LLM Batch & Caching) which may use similar patterns

---
*Phase: 57.1-pubtator-async-repository-refactor*
*Completed: 2026-01-31*
*Post-phase fixes: 2026-02-01*
