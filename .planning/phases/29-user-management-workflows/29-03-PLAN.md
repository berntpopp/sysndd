---
phase: 29-user-management-workflows
plan: 03
type: execute
wave: 2
depends_on: ["29-01", "29-02"]
files_modified:
  - app/src/views/admin/ManageUser.vue
autonomous: true

must_haves:
  truths:
    - "Admin can select individual users via checkbox in each table row"
    - "Admin can select all users on current page via header checkbox"
    - "Selection badge shows 'X selected' in table header when items selected"
    - "Selection persists when navigating between pages"
    - "Bulk action buttons appear when selection count > 0"
    - "Clear selection button deselects all users"
  artifacts:
    - path: "app/src/views/admin/ManageUser.vue"
      provides: "User table with selection UI and bulk action bar"
      contains: "useBulkSelection"
  key_links:
    - from: "app/src/views/admin/ManageUser.vue"
      to: "app/src/composables/useBulkSelection.ts"
      via: "composable import and usage"
      pattern: "useBulkSelection"
---

<objective>
Add bulk selection UI to ManageUser.vue table

Purpose: Enable admins to select multiple users across pages for bulk operations. This plan focuses on selection mechanics and UI; actual bulk actions are in plan 04.

Output: ManageUser.vue with selection checkboxes, selection badge, select-all, and bulk action button bar
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-user-management-workflows/29-CONTEXT.md
@.planning/phases/29-user-management-workflows/29-RESEARCH.md
@.planning/phases/28-table-foundation/28-02-SUMMARY.md

@app/src/views/admin/ManageUser.vue
@app/src/composables/useBulkSelection.ts
@app/src/composables/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate useBulkSelection composable</name>
  <files>app/src/views/admin/ManageUser.vue</files>
  <action>
In the `<script>` section, add useBulkSelection to setup():

1. Import at top of script (with other imports):
```javascript
import { useBulkSelection } from '@/composables';
```

2. In setup() function, initialize the composable:
```javascript
// Bulk selection state (20 user limit per context decisions)
const bulkSelection = useBulkSelection(20);
```

3. Add to setup() return statement:
```javascript
return {
  // ... existing returns ...
  ...bulkSelection, // Spreads: selectedIds, selectionCount, isSelected, toggleSelection, clearSelection, getSelectedArray, selectMultiple
};
```

4. Add computed for "all on current page selected" check in methods or computed section:
```javascript
// Check if all users on current page are selected
allOnPageSelected() {
  if (this.users.length === 0) return false;
  return this.users.every(user => this.isSelected(user.user_id));
}
```

5. Add method to toggle select-all for current page:
```javascript
toggleSelectAllOnPage() {
  if (this.allOnPageSelected) {
    // Deselect all on current page
    this.users.forEach(user => {
      if (this.isSelected(user.user_id)) {
        this.toggleSelection(user.user_id);
      }
    });
  } else {
    // Select all on current page (respects 20 limit)
    const pageUserIds = this.users.map(u => u.user_id);
    const added = this.selectMultiple(pageUserIds);
    if (added < pageUserIds.length && this.selectionCount >= 20) {
      this.makeToast(
        `Selection limited to 20 users. ${added} users added.`,
        'Selection Limit',
        'warning'
      );
    }
  }
}
```

6. Add method to handle individual row checkbox:
```javascript
handleRowSelect(userId) {
  const success = this.toggleSelection(userId);
  if (!success) {
    this.makeToast(
      'Maximum 20 users can be selected at once',
      'Selection Limit Reached',
      'warning'
    );
  }
}
```
  </action>
  <verify>File saves without syntax errors. Check script section has useBulkSelection import.</verify>
  <done>useBulkSelection composable integrated with selection methods</done>
</task>

<task type="auto">
  <name>Task 2: Add selection checkboxes to table</name>
  <files>app/src/views/admin/ManageUser.vue</files>
  <action>
1. Add selection column to fields array in data():

Find the `fields` array and add selection column as FIRST item:
```javascript
fields: [
  {
    key: 'select',
    label: '',
    class: 'text-center',
    thStyle: { width: '40px' },
    sortable: false,
  },
  // ... rest of existing fields ...
]
```

2. Add header checkbox template in GenericTable:

Inside the `<GenericTable>` component, add a template for the select header:
```vue
<template #head-select>
  <BFormCheckbox
    :model-value="allOnPageSelected"
    :indeterminate="selectionCount > 0 && !allOnPageSelected"
    @update:model-value="toggleSelectAllOnPage"
  />
</template>
```

3. Add cell checkbox template for each row:

Add after existing cell templates:
```vue
<template #cell-select="{ row }">
  <BFormCheckbox
    :model-value="isSelected(row.user_id)"
    @update:model-value="handleRowSelect(row.user_id)"
  />
</template>
```

4. Ensure BFormCheckbox is imported (should be from bootstrap-vue-next, already available).
  </action>
  <verify>Template compiles. Checkboxes should appear in first column.</verify>
  <done>Selection checkboxes in header and each row</done>
</task>

<task type="auto">
  <name>Task 3: Add selection badge and bulk action bar</name>
  <files>app/src/views/admin/ManageUser.vue</files>
  <action>
1. Update the card header to show selection badge:

Find the header template (around line 14-44) and modify to show selection count:
```vue
<template #header>
  <BRow>
    <BCol>
      <h5 class="mb-1 text-start">
        <strong>Manage Users</strong>
        <BBadge variant="secondary" class="ms-2">{{ totalRows }} users</BBadge>
        <BBadge
          v-if="selectionCount > 0"
          variant="primary"
          class="ms-2"
        >
          {{ selectionCount }} selected
        </BBadge>
      </h5>
    </BCol>
    <BCol class="text-end">
      <!-- Bulk action buttons (only visible when selection > 0) -->
      <template v-if="selectionCount > 0">
        <BButton
          v-b-tooltip.hover
          size="sm"
          variant="success"
          class="me-1"
          title="Approve selected users"
          @click="handleBulkApprove"
        >
          <i class="bi bi-check-circle" /> Approve
        </BButton>
        <BButton
          v-b-tooltip.hover
          size="sm"
          variant="primary"
          class="me-1"
          title="Assign role to selected users"
          @click="showBulkRoleModal"
        >
          <i class="bi bi-person-badge" /> Role
        </BButton>
        <BButton
          v-b-tooltip.hover
          size="sm"
          variant="danger"
          class="me-1"
          title="Delete selected users"
          @click="handleBulkDelete"
        >
          <i class="bi bi-trash" /> Delete
        </BButton>
        <BButton
          v-b-tooltip.hover
          size="sm"
          variant="link"
          title="Clear selection"
          @click="clearSelection"
        >
          <i class="bi bi-x-lg" />
        </BButton>
      </template>
      <!-- Existing buttons (export, filter) -->
      <BButton
        v-b-tooltip.hover
        size="sm"
        class="me-1"
        :variant="isExporting ? 'secondary' : 'outline-primary'"
        :disabled="isExporting"
        title="Export to Excel"
        @click="handleExport"
      >
        <BSpinner v-if="isExporting" small />
        <i v-else class="bi bi-file-earmark-excel" />
      </BButton>
      <BButton
        v-b-tooltip.hover
        size="sm"
        :variant="removeFiltersButtonVariant"
        :title="removeFiltersButtonTitle"
        @click="removeFilters"
      >
        <i class="bi bi-funnel" />
      </BButton>
    </BCol>
  </BRow>
</template>
```

2. Add placeholder methods for bulk actions (actual implementation in plan 04):
```javascript
handleBulkApprove() {
  // Will be implemented in plan 04
  console.log('Bulk approve:', this.getSelectedArray());
},
showBulkRoleModal() {
  // Will be implemented in plan 04
  console.log('Bulk role assign:', this.getSelectedArray());
},
handleBulkDelete() {
  // Will be implemented in plan 04
  console.log('Bulk delete:', this.getSelectedArray());
},
```

3. Add computed for button variants:
```javascript
removeFiltersButtonVariant() {
  return this.hasActiveFilters ? 'outline-danger' : 'outline-secondary';
},
removeFiltersButtonTitle() {
  return this.hasActiveFilters ? 'Clear all filters' : 'No active filters';
},
```
  </action>
  <verify>Template renders. Selection badge appears when items selected. Bulk action buttons show/hide correctly.</verify>
  <done>Selection badge in header, bulk action buttons visible when selection > 0</done>
</task>

</tasks>

<verification>
- [ ] useBulkSelection imported and initialized in setup()
- [ ] Selection column appears first in table
- [ ] Header checkbox toggles all on current page
- [ ] Row checkboxes toggle individual selection
- [ ] "X selected" badge shows in header when items selected
- [ ] Bulk action buttons (Approve, Role, Delete) appear when selection > 0
- [ ] Clear selection button (X) deselects all
- [ ] Selection persists when changing pages (try navigating away and back)
- [ ] Selecting 21st user shows warning toast
- [ ] `npm run lint` passes
</verification>

<success_criteria>
- Selection checkboxes in all table rows
- Header "select all on page" checkbox with indeterminate state
- Selection badge shows count dynamically
- Bulk action buttons appear/disappear based on selection
- Selection survives pagination (stored in component state via composable)
- 20 user limit enforced with warning
</success_criteria>

<output>
After completion, create `.planning/phases/29-user-management-workflows/29-03-SUMMARY.md`
</output>
