---
phase: 29-user-management-workflows
plan: 04
type: execute
wave: 2
depends_on: ["29-03"]
files_modified:
  - app/src/views/admin/ManageUser.vue
autonomous: false

must_haves:
  truths:
    - "Bulk approve shows Bootstrap modal listing all selected usernames"
    - "Bulk delete shows type-to-confirm modal listing all usernames"
    - "Bulk delete is blocked if selection contains admin users"
    - "Bulk role assignment shows Bootstrap modal with dropdown selector (not text input)"
    - "Role modal lists all selected usernames before role dropdown"
    - "After bulk action, selection is cleared and table refreshes"
    - "Filter presets can be saved with custom name"
    - "Filter presets appear as buttons above table"
    - "Clicking preset button loads saved filter"
  artifacts:
    - path: "app/src/views/admin/ManageUser.vue"
      provides: "Complete bulk action and filter preset functionality"
      contains: "bulk_approve"
  key_links:
    - from: "app/src/views/admin/ManageUser.vue"
      to: "/api/user/bulk_approve"
      via: "axios.post"
      pattern: "bulk_approve"
    - from: "app/src/views/admin/ManageUser.vue"
      to: "app/src/composables/useFilterPresets.ts"
      via: "composable import"
      pattern: "useFilterPresets"
---

<objective>
Implement bulk actions (approve, delete, role) and filter presets in ManageUser.vue

Purpose: Complete the user management workflow with Bootstrap modal confirmations showing usernames, dropdown role selection, and filter preset persistence.

Output: Fully functional bulk operations with proper confirmation UX (usernames listed, dropdown for role) and filter preset save/load
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-user-management-workflows/29-CONTEXT.md
@.planning/phases/29-user-management-workflows/29-RESEARCH.md

@app/src/views/admin/ManageUser.vue
@app/src/composables/useFilterPresets.ts
@app/src/composables/useBulkSelection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement bulk approve and bulk role assignment with Bootstrap modals</name>
  <files>app/src/views/admin/ManageUser.vue</files>
  <action>
1. Import useFilterPresets in setup():
```javascript
import { useBulkSelection, useFilterPresets } from '@/composables';
```

2. Initialize filter presets composable in setup():
```javascript
const filterPresets = useFilterPresets('sysndd-manage-user-presets');
```

3. Add to setup() return:
```javascript
return {
  // ... existing ...
  filterPresets,
};
```

4. Add reactive state for bulk role modal (in data or setup):
```javascript
// For bulk role modal
const showBulkRoleModalVisible = ref(false);
const bulkRoleSelection = ref('');
const bulkRoleUsernames = ref([]);
```

5. Add template for Bulk Approve modal (before closing template tag):
```vue
<!-- Bulk Approve Confirmation Modal -->
<BModal
  v-model="showBulkApproveModal"
  title="Approve Users"
  ok-variant="success"
  ok-title="Approve"
  cancel-title="Cancel"
  @ok="confirmBulkApprove"
>
  <p>You are about to approve {{ getSelectedArray().length }} users:</p>
  <div class="border rounded p-2 mb-3 bg-light" style="max-height: 200px; overflow-y: auto;">
    <div v-for="username in bulkApproveUsernames" :key="username" class="small">
      {{ username }}
    </div>
  </div>
  <p class="text-muted small">This action will grant these users access to the system.</p>
</BModal>
```

6. Add template for Bulk Role Assignment modal (after approve modal):
```vue
<!-- Bulk Role Assignment Modal -->
<BModal
  v-model="showBulkRoleModalVisible"
  title="Assign Role"
  ok-variant="primary"
  ok-title="Assign Role"
  cancel-title="Cancel"
  :ok-disabled="!bulkRoleSelection"
  @ok="confirmBulkRoleAssignment"
>
  <p>Assign role to {{ getSelectedArray().length }} users:</p>
  <div class="border rounded p-2 mb-3 bg-light" style="max-height: 150px; overflow-y: auto;">
    <div v-for="username in bulkRoleUsernames" :key="username" class="small">
      {{ username }}
    </div>
  </div>
  <BFormGroup label="Select Role:" label-for="bulk-role-select">
    <BFormSelect
      id="bulk-role-select"
      v-model="bulkRoleSelection"
      :options="[
        { value: '', text: 'Select a role...', disabled: true },
        { value: 'Curator', text: 'Curator' },
        { value: 'Reviewer', text: 'Reviewer' },
        { value: 'Administrator', text: 'Administrator' }
      ]"
    />
  </BFormGroup>
</BModal>
```

7. Implement handleBulkApprove method (replace placeholder):
```javascript
handleBulkApprove() {
  const userIds = this.getSelectedArray();
  if (userIds.length === 0) {
    this.makeToast('No users selected', 'Bulk Approve', 'warning');
    return;
  }

  // Get usernames for display (USR-06: show all selected items)
  const selectedUsers = this.users.filter(u => userIds.includes(u.user_id));
  this.bulkApproveUsernames = selectedUsers.map(u => u.user_name);

  // Show Bootstrap modal
  this.showBulkApproveModal = true;
},

async confirmBulkApprove() {
  const userIds = this.getSelectedArray();

  const apiUrl = `${import.meta.env.VITE_API_URL}/api/user/bulk_approve`;
  try {
    const response = await this.axios.post(apiUrl, {
      user_ids: userIds,
    }, {
      headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
    });

    if (response.status === 200) {
      this.makeToast(
        `Successfully approved ${response.data.processed || userIds.length} users`,
        'Bulk Approve Complete',
        'success',
        true,
        5000
      );
      this.clearSelection();
      this.loadData();
    }
  } catch (error) {
    const errorMsg = error.response?.data?.message || error.response?.data?.error || 'Unknown error';
    this.makeToast(errorMsg, 'Bulk Approve Failed', 'danger');
  }
}
```

8. Implement showBulkRoleModal method (replace placeholder - USR-08: dropdown instead of prompt):
```javascript
showBulkRoleModal() {
  const userIds = this.getSelectedArray();
  if (userIds.length === 0) {
    this.makeToast('No users selected', 'Assign Role', 'warning');
    return;
  }

  // Get usernames for display (USR-06: show all selected items)
  const selectedUsers = this.users.filter(u => userIds.includes(u.user_id));
  this.bulkRoleUsernames = selectedUsers.map(u => u.user_name);
  this.bulkRoleSelection = ''; // Reset selection

  // Show Bootstrap modal with dropdown (NOT prompt)
  this.showBulkRoleModalVisible = true;
},

async confirmBulkRoleAssignment() {
  const userIds = this.getSelectedArray();
  const selectedRole = this.bulkRoleSelection;

  if (!selectedRole) {
    this.makeToast('Please select a role', 'Invalid Role', 'warning');
    return;
  }

  const apiUrl = `${import.meta.env.VITE_API_URL}/api/user/bulk_assign_role`;
  try {
    const response = await this.axios.post(apiUrl, {
      user_ids: userIds,
      role: selectedRole,
    }, {
      headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
    });

    if (response.status === 200) {
      this.makeToast(
        `Successfully assigned ${selectedRole} role to ${response.data.processed || userIds.length} users`,
        'Bulk Role Assignment Complete',
        'success',
        true,
        5000
      );
      this.clearSelection();
      this.loadData();
    }
  } catch (error) {
    const errorMsg = error.response?.data?.message || error.response?.data?.error || 'Unknown error';
    this.makeToast(errorMsg, 'Bulk Role Assignment Failed', 'danger');
  }
}
```

9. Add data properties for modals:
```javascript
// In data() or setup
showBulkApproveModal: false,
bulkApproveUsernames: [],
showBulkRoleModalVisible: false,
bulkRoleSelection: '',
bulkRoleUsernames: [],
```

Key requirements addressed:
- USR-06: Both modals show list of usernames, not just count
- USR-08: Role selection uses BFormSelect dropdown, not prompt()
- Uses Bootstrap modals for consistent UX (not native confirm/prompt)
  </action>
  <verify>
- Bulk Approve modal shows usernames list
- Bulk Role modal shows usernames list AND dropdown selector
- No prompt() or confirm() calls for approve/role
  </verify>
  <done>Bulk approve and role assignment use Bootstrap modals with username lists and dropdown</done>
</task>

<task type="auto">
  <name>Task 2: Implement bulk delete with type-to-confirm</name>
  <files>app/src/views/admin/ManageUser.vue</files>
  <action>
Add template for Bulk Delete modal (uses type-to-confirm pattern):
```vue
<!-- Bulk Delete Confirmation Modal -->
<BModal
  v-model="showBulkDeleteModal"
  title="Delete Users"
  ok-variant="danger"
  ok-title="Delete"
  cancel-title="Cancel"
  :ok-disabled="deleteConfirmText !== 'DELETE'"
  @ok="confirmBulkDelete"
>
  <p class="text-danger fw-bold">This action cannot be undone.</p>
  <p>You are about to delete {{ bulkDeleteUsernames.length }} users:</p>
  <div class="border rounded p-2 mb-3 bg-light" style="max-height: 200px; overflow-y: auto;">
    <div v-for="username in bulkDeleteUsernames" :key="username" class="small">
      {{ username }}
    </div>
  </div>
  <BFormGroup label="Type DELETE to confirm:" label-for="delete-confirm-input">
    <BFormInput
      id="delete-confirm-input"
      v-model="deleteConfirmText"
      placeholder="DELETE"
      autocomplete="off"
    />
  </BFormGroup>
</BModal>
```

Implement handleBulkDelete with type-to-confirm pattern (replace placeholder):

```javascript
handleBulkDelete() {
  const userIds = this.getSelectedArray();
  if (userIds.length === 0) {
    this.makeToast('No users selected', 'Bulk Delete', 'warning');
    return;
  }

  // Get selected user details for display and admin check
  const selectedUsers = this.users.filter(u => userIds.includes(u.user_id));

  // Frontend validation: Block if admins selected
  const adminUsers = selectedUsers.filter(u => u.user_role === 'Administrator');
  if (adminUsers.length > 0) {
    this.makeToast(
      `Cannot delete: selection contains ${adminUsers.length} admin user(s)`,
      'Delete Blocked',
      'danger'
    );
    return;
  }

  // Store usernames for modal display (USR-06: show all selected items)
  this.bulkDeleteUsernames = selectedUsers.map(u => u.user_name);
  this.deleteConfirmText = ''; // Reset confirm input

  // Show Bootstrap modal
  this.showBulkDeleteModal = true;
},

async confirmBulkDelete() {
  const userIds = this.getSelectedArray();

  const apiUrl = `${import.meta.env.VITE_API_URL}/api/user/bulk_delete`;
  try {
    const response = await this.axios.post(apiUrl, {
      user_ids: userIds,
    }, {
      headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
    });

    if (response.status === 200) {
      this.makeToast(
        `Successfully deleted ${response.data.processed || userIds.length} users`,
        'Bulk Delete Complete',
        'success',
        true,
        5000
      );
      this.clearSelection();
      this.loadData();
    }
  } catch (error) {
    const errorMsg = error.response?.data?.message || error.response?.data?.error || 'Unknown error';
    this.makeToast(errorMsg, 'Bulk Delete Failed', 'danger');
  }
}
```

Add data properties:
```javascript
showBulkDeleteModal: false,
bulkDeleteUsernames: [],
deleteConfirmText: '',
```

Key points:
- Frontend validates no admins in selection before showing confirm
- Shows usernames in Bootstrap modal (consistent with other bulk actions)
- Requires typing exactly "DELETE" to enable confirm button
- Uses BFormInput instead of native prompt()
- Clears selection and refreshes table after success
  </action>
  <verify>Method blocks admin deletion. Bootstrap modal requires exact "DELETE" in input field.</verify>
  <done>Bulk delete with admin protection and type-to-confirm using Bootstrap modal</done>
</task>

<task type="auto">
  <name>Task 3: Add filter presets UI</name>
  <files>app/src/views/admin/ManageUser.vue</files>
  <action>
1. Add filter preset row in template, BEFORE the search/filter row (after card header, around line 47):

```vue
<!-- Filter presets row -->
<BRow v-if="filterPresets.presets.value.length > 0 || hasActiveFilters" class="px-2 pt-2">
  <BCol>
    <div class="d-flex gap-2 align-items-center flex-wrap">
      <span class="text-muted small">Quick filters:</span>
      <BButton
        v-for="preset in filterPresets.presets.value"
        :key="preset.name"
        size="sm"
        variant="outline-secondary"
        class="py-0"
        @click="loadFilterPreset(preset.name)"
      >
        {{ preset.name }}
        <i
          class="bi bi-x-lg ms-1"
          @click.stop="deleteFilterPreset(preset.name)"
        />
      </BButton>
      <BButton
        v-if="hasActiveFilters"
        v-b-tooltip.hover
        size="sm"
        variant="outline-primary"
        class="py-0"
        title="Save current filter as preset"
        @click="showSavePresetPrompt"
      >
        <i class="bi bi-plus-lg" /> Save Preset
      </BButton>
    </div>
  </BCol>
</BRow>
```

2. Add methods for filter presets:

```javascript
loadFilterPreset(name) {
  const presetFilter = this.filterPresets.loadPreset(name);
  if (presetFilter) {
    // Merge preset into current filter structure
    Object.keys(presetFilter).forEach(key => {
      if (this.filter[key]) {
        this.filter[key] = presetFilter[key];
      }
    });
    this.filtered();
    this.makeToast(`Loaded preset: ${name}`, 'Filter Preset', 'info', true, 2000);
  }
},

deleteFilterPreset(name) {
  if (confirm(`Delete preset "${name}"?`)) {
    this.filterPresets.deletePreset(name);
    this.makeToast(`Deleted preset: ${name}`, 'Filter Preset', 'info', true, 2000);
  }
},

showSavePresetPrompt() {
  const name = prompt('Enter a name for this filter preset:');
  if (name && name.trim()) {
    // Save current filter state
    this.filterPresets.savePreset(name.trim(), JSON.parse(JSON.stringify(this.filter)));
    this.makeToast(`Saved preset: ${name.trim()}`, 'Filter Preset', 'success', true, 3000);
  }
},
```

3. Add default quick filter presets on mount (in mounted(), after loadData):
```javascript
// Initialize default presets if none exist
if (this.filterPresets.presets.value.length === 0) {
  // Add common presets
  this.filterPresets.savePreset('Pending', {
    any: { content: null, join_char: null, operator: 'contains' },
    user_role: { content: null, join_char: ',', operator: 'any' },
    approved: { content: '0', join_char: null, operator: 'equals' },
  });
  this.filterPresets.savePreset('Curators', {
    any: { content: null, join_char: null, operator: 'contains' },
    user_role: { content: 'Curator', join_char: ',', operator: 'any' },
    approved: { content: null, join_char: null, operator: 'equals' },
  });
}
```

Note: Filter preset save/delete can still use native confirm/prompt since these are simple non-bulk actions and less critical than bulk user operations.
  </action>
  <verify>Filter preset buttons render. Save/load/delete work. Presets persist across page refresh.</verify>
  <done>Filter presets save/load/delete with UI</done>
</task>

</tasks>

<verification>
- [ ] Bulk Approve: Shows Bootstrap modal with list of usernames, calls API, refreshes table, clears selection
- [ ] Bulk Delete: Blocks if admin selected, shows Bootstrap modal with usernames, requires "DELETE" typed in input
- [ ] Bulk Role: Shows Bootstrap modal with usernames AND BFormSelect dropdown (NOT prompt), calls API
- [ ] All bulk actions show success/error toast
- [ ] Filter presets appear as buttons above search bar
- [ ] "Save Preset" button appears when filters active
- [ ] Clicking preset loads saved filter
- [ ] X button on preset deletes it
- [ ] Presets persist after page refresh (localStorage)
- [ ] `npm run lint` passes
</verification>

<success_criteria>
- Bulk approve shows Bootstrap modal with username list (not just count)
- Bulk delete requires type-to-confirm "DELETE" in Bootstrap modal
- Bulk delete blocked if admins in selection
- Bulk role assignment uses BFormSelect dropdown in Bootstrap modal (not prompt)
- All confirmation dialogs show list of affected usernames
- Filter presets save to localStorage
- Preset buttons load filters on click
- Default "Pending" and "Curators" presets created on first load
</success_criteria>

<checkpoint type="human-verify" gate="blocking">
  <what-built>Complete user management workflows: bulk selection, bulk actions (approve/delete/role), filter presets</what-built>
  <how-to-verify>
1. Start dev server: `cd app && npm run dev`
2. Navigate to Admin > Manage Users
3. Test selection:
   - Click checkbox on 3 users
   - Verify "3 selected" badge appears
   - Navigate to page 2 and back - selection should persist
   - Try selecting 21 users - should show warning
4. Test bulk approve:
   - Select 2 pending users
   - Click Approve button
   - Bootstrap modal appears showing list of usernames (not just "2 users")
   - After confirm, table refreshes, selection clears
5. Test bulk role assignment:
   - Select 2 users
   - Click "Assign Role" button
   - Bootstrap modal appears with:
     - List of usernames at top
     - Dropdown selector (BFormSelect) for role - NOT a text prompt
   - Select "Curator" from dropdown
   - Click "Assign Role"
   - Toast confirms success
6. Test bulk delete:
   - Select 2 non-admin users
   - Click Delete button
   - Bootstrap modal shows usernames in scrollable list
   - Type "DELETE" in input field
   - Delete button becomes enabled
   - Users are deleted, table refreshes
7. Test admin protection:
   - Select an Administrator user
   - Click Delete button
   - Should show error toast "Cannot delete: selection contains admin users" (modal never opens)
8. Test filter presets:
   - Apply a filter (e.g., Role = Curator)
   - Click "Save Preset", enter name "My Curators"
   - Clear filters
   - Click "My Curators" button - filter should restore
   - Refresh page - preset should still exist
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/29-user-management-workflows/29-04-SUMMARY.md`
</output>
