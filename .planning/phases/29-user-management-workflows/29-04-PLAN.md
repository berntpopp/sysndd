---
phase: 29-user-management-workflows
plan: 04
type: execute
wave: 2
depends_on: ["29-03"]
files_modified:
  - app/src/views/admin/ManageUser.vue
autonomous: false

must_haves:
  truths:
    - "Bulk approve shows confirmation dialog with user count"
    - "Bulk delete shows type-to-confirm dialog listing all usernames"
    - "Bulk delete is blocked if selection contains admin users"
    - "Bulk role assignment shows dropdown with Curator/Reviewer/Admin options"
    - "After bulk action, selection is cleared and table refreshes"
    - "Filter presets can be saved with custom name"
    - "Filter presets appear as buttons above table"
    - "Clicking preset button loads saved filter"
  artifacts:
    - path: "app/src/views/admin/ManageUser.vue"
      provides: "Complete bulk action and filter preset functionality"
      contains: "bulk_approve"
  key_links:
    - from: "app/src/views/admin/ManageUser.vue"
      to: "/api/user/bulk_approve"
      via: "axios.post"
      pattern: "bulk_approve"
    - from: "app/src/views/admin/ManageUser.vue"
      to: "app/src/composables/useFilterPresets.ts"
      via: "composable import"
      pattern: "useFilterPresets"
---

<objective>
Implement bulk actions (approve, delete, role) and filter presets in ManageUser.vue

Purpose: Complete the user management workflow with confirmation dialogs, API calls, and filter preset persistence.

Output: Fully functional bulk operations with appropriate confirmation UX and filter preset save/load
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-user-management-workflows/29-CONTEXT.md
@.planning/phases/29-user-management-workflows/29-RESEARCH.md

@app/src/views/admin/ManageUser.vue
@app/src/composables/useFilterPresets.ts
@app/src/composables/useBulkSelection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement bulk approve and bulk role assignment</name>
  <files>app/src/views/admin/ManageUser.vue</files>
  <action>
1. Import useFilterPresets in setup():
```javascript
import { useBulkSelection, useFilterPresets } from '@/composables';
```

2. Initialize filter presets composable in setup():
```javascript
const filterPresets = useFilterPresets('sysndd-manage-user-presets');
```

3. Add to setup() return:
```javascript
return {
  // ... existing ...
  filterPresets,
};
```

4. Implement handleBulkApprove method (replace placeholder):
```javascript
async handleBulkApprove() {
  const userIds = this.getSelectedArray();
  if (userIds.length === 0) {
    this.makeToast('No users selected', 'Bulk Approve', 'warning');
    return;
  }

  // Simple confirmation for non-destructive action
  if (!confirm(`Approve ${userIds.length} selected users?`)) {
    return;
  }

  const apiUrl = `${import.meta.env.VITE_API_URL}/api/user/bulk_approve`;
  try {
    const response = await this.axios.post(apiUrl, {
      user_ids: userIds,
    }, {
      headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
    });

    if (response.status === 200) {
      this.makeToast(
        `Successfully approved ${response.data.processed || userIds.length} users`,
        'Bulk Approve Complete',
        'success',
        true,
        5000
      );
      this.clearSelection();
      this.loadData();
    }
  } catch (error) {
    const errorMsg = error.response?.data?.message || error.response?.data?.error || 'Unknown error';
    this.makeToast(errorMsg, 'Bulk Approve Failed', 'danger');
  }
}
```

5. Implement showBulkRoleModal method (replace placeholder):
```javascript
async showBulkRoleModal() {
  const userIds = this.getSelectedArray();
  if (userIds.length === 0) {
    this.makeToast('No users selected', 'Assign Role', 'warning');
    return;
  }

  // Use prompt for role selection (simple approach, can enhance with modal later)
  const roleOptions = ['Curator', 'Reviewer', 'Administrator'];
  const selectedRole = prompt(
    `Assign role to ${userIds.length} users.\n\nEnter role (${roleOptions.join(', ')}):`
  );

  if (!selectedRole || !roleOptions.includes(selectedRole)) {
    if (selectedRole !== null) {
      this.makeToast('Invalid role. Please enter Curator, Reviewer, or Administrator.', 'Invalid Role', 'warning');
    }
    return;
  }

  const apiUrl = `${import.meta.env.VITE_API_URL}/api/user/bulk_assign_role`;
  try {
    const response = await this.axios.post(apiUrl, {
      user_ids: userIds,
      role: selectedRole,
    }, {
      headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
    });

    if (response.status === 200) {
      this.makeToast(
        `Successfully assigned ${selectedRole} role to ${response.data.processed || userIds.length} users`,
        'Bulk Role Assignment Complete',
        'success',
        true,
        5000
      );
      this.clearSelection();
      this.loadData();
    }
  } catch (error) {
    const errorMsg = error.response?.data?.message || error.response?.data?.error || 'Unknown error';
    this.makeToast(errorMsg, 'Bulk Role Assignment Failed', 'danger');
  }
}
```
  </action>
  <verify>Methods exist. API calls have correct endpoints.</verify>
  <done>Bulk approve and role assignment implemented with API calls</done>
</task>

<task type="auto">
  <name>Task 2: Implement bulk delete with type-to-confirm</name>
  <files>app/src/views/admin/ManageUser.vue</files>
  <action>
Implement handleBulkDelete with type-to-confirm pattern (replace placeholder):

```javascript
async handleBulkDelete() {
  const userIds = this.getSelectedArray();
  if (userIds.length === 0) {
    this.makeToast('No users selected', 'Bulk Delete', 'warning');
    return;
  }

  // Get selected user details for display and admin check
  const selectedUsers = this.users.filter(u => userIds.includes(u.user_id));

  // Frontend validation: Block if admins selected
  const adminUsers = selectedUsers.filter(u => u.user_role === 'Administrator');
  if (adminUsers.length > 0) {
    this.makeToast(
      `Cannot delete: selection contains ${adminUsers.length} admin user(s)`,
      'Delete Blocked',
      'danger'
    );
    return;
  }

  // Build confirmation message with usernames
  const usernames = selectedUsers.map(u => u.user_name);
  const usernameList = usernames.length <= 5
    ? usernames.join(', ')
    : `${usernames.slice(0, 5).join(', ')} and ${usernames.length - 5} more`;

  // Type-to-confirm prompt
  const confirmText = prompt(
    `DELETE ${userIds.length} USERS\n\n` +
    `Users: ${usernameList}\n\n` +
    `This action cannot be undone.\n\n` +
    `Type DELETE to confirm:`
  );

  if (confirmText !== 'DELETE') {
    if (confirmText !== null) {
      this.makeToast('Deletion cancelled. You must type DELETE exactly.', 'Cancelled', 'info');
    }
    return;
  }

  const apiUrl = `${import.meta.env.VITE_API_URL}/api/user/bulk_delete`;
  try {
    const response = await this.axios.post(apiUrl, {
      user_ids: userIds,
    }, {
      headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
    });

    if (response.status === 200) {
      this.makeToast(
        `Successfully deleted ${response.data.processed || userIds.length} users`,
        'Bulk Delete Complete',
        'success',
        true,
        5000
      );
      this.clearSelection();
      this.loadData();
    }
  } catch (error) {
    const errorMsg = error.response?.data?.message || error.response?.data?.error || 'Unknown error';
    this.makeToast(errorMsg, 'Bulk Delete Failed', 'danger');
  }
}
```

Key points:
- Frontend validates no admins in selection before showing confirm
- Shows usernames in confirmation prompt
- Requires typing exactly "DELETE" to proceed
- Clears selection and refreshes table after success
  </action>
  <verify>Method blocks admin deletion. Type-to-confirm requires exact "DELETE".</verify>
  <done>Bulk delete with admin protection and type-to-confirm</done>
</task>

<task type="auto">
  <name>Task 3: Add filter presets UI</name>
  <files>app/src/views/admin/ManageUser.vue</files>
  <action>
1. Add filter preset row in template, BEFORE the search/filter row (after card header, around line 47):

```vue
<!-- Filter presets row -->
<BRow v-if="filterPresets.presets.value.length > 0 || hasActiveFilters" class="px-2 pt-2">
  <BCol>
    <div class="d-flex gap-2 align-items-center flex-wrap">
      <span class="text-muted small">Quick filters:</span>
      <BButton
        v-for="preset in filterPresets.presets.value"
        :key="preset.name"
        size="sm"
        variant="outline-secondary"
        class="py-0"
        @click="loadFilterPreset(preset.name)"
      >
        {{ preset.name }}
        <i
          class="bi bi-x-lg ms-1"
          @click.stop="deleteFilterPreset(preset.name)"
        />
      </BButton>
      <BButton
        v-if="hasActiveFilters"
        v-b-tooltip.hover
        size="sm"
        variant="outline-primary"
        class="py-0"
        title="Save current filter as preset"
        @click="showSavePresetPrompt"
      >
        <i class="bi bi-plus-lg" /> Save Preset
      </BButton>
    </div>
  </BCol>
</BRow>
```

2. Add methods for filter presets:

```javascript
loadFilterPreset(name) {
  const presetFilter = this.filterPresets.loadPreset(name);
  if (presetFilter) {
    // Merge preset into current filter structure
    Object.keys(presetFilter).forEach(key => {
      if (this.filter[key]) {
        this.filter[key] = presetFilter[key];
      }
    });
    this.filtered();
    this.makeToast(`Loaded preset: ${name}`, 'Filter Preset', 'info', true, 2000);
  }
},

deleteFilterPreset(name) {
  if (confirm(`Delete preset "${name}"?`)) {
    this.filterPresets.deletePreset(name);
    this.makeToast(`Deleted preset: ${name}`, 'Filter Preset', 'info', true, 2000);
  }
},

showSavePresetPrompt() {
  const name = prompt('Enter a name for this filter preset:');
  if (name && name.trim()) {
    // Save current filter state
    this.filterPresets.savePreset(name.trim(), JSON.parse(JSON.stringify(this.filter)));
    this.makeToast(`Saved preset: ${name.trim()}`, 'Filter Preset', 'success', true, 3000);
  }
},
```

3. Add default quick filter presets on mount (in mounted(), after loadData):
```javascript
// Initialize default presets if none exist
if (this.filterPresets.presets.value.length === 0) {
  // Add common presets
  this.filterPresets.savePreset('Pending', {
    any: { content: null, join_char: null, operator: 'contains' },
    user_role: { content: null, join_char: ',', operator: 'any' },
    approved: { content: '0', join_char: null, operator: 'equals' },
  });
  this.filterPresets.savePreset('Curators', {
    any: { content: null, join_char: null, operator: 'contains' },
    user_role: { content: 'Curator', join_char: ',', operator: 'any' },
    approved: { content: null, join_char: null, operator: 'equals' },
  });
}
```
  </action>
  <verify>Filter preset buttons render. Save/load/delete work. Presets persist across page refresh.</verify>
  <done>Filter presets save/load/delete with UI</done>
</task>

</tasks>

<verification>
- [ ] Bulk Approve: Shows confirmation, calls API, refreshes table, clears selection
- [ ] Bulk Delete: Blocks if admin selected, shows type-to-confirm, requires "DELETE"
- [ ] Bulk Role: Prompts for role, validates input, calls API
- [ ] All bulk actions show success/error toast
- [ ] Filter presets appear as buttons above search bar
- [ ] "Save Preset" button appears when filters active
- [ ] Clicking preset loads saved filter
- [ ] X button on preset deletes it
- [ ] Presets persist after page refresh (localStorage)
- [ ] `npm run lint` passes
</verification>

<success_criteria>
- Bulk approve works with simple confirmation
- Bulk delete requires type-to-confirm "DELETE"
- Bulk delete blocked if admins in selection
- Bulk role assignment with valid role selection
- Filter presets save to localStorage
- Preset buttons load filters on click
- Default "Pending" and "Curators" presets created on first load
</success_criteria>

<checkpoint type="human-verify" gate="blocking">
  <what-built>Complete user management workflows: bulk selection, bulk actions (approve/delete/role), filter presets</what-built>
  <how-to-verify>
1. Start dev server: `cd app && npm run dev`
2. Navigate to Admin > Manage Users
3. Test selection:
   - Click checkbox on 3 users
   - Verify "3 selected" badge appears
   - Navigate to page 2 and back - selection should persist
   - Try selecting 21 users - should show warning
4. Test bulk approve:
   - Select 2 pending users
   - Click Approve button
   - Confirm dialog appears
   - After confirm, table refreshes, selection clears
5. Test bulk delete:
   - Select 2 non-admin users
   - Click Delete button
   - Type "DELETE" in prompt
   - Users are deleted, table refreshes
6. Test admin protection:
   - Select an Administrator user
   - Click Delete button
   - Should show error "Cannot delete: selection contains admin users"
7. Test filter presets:
   - Apply a filter (e.g., Role = Curator)
   - Click "Save Preset", enter name "My Curators"
   - Clear filters
   - Click "My Curators" button - filter should restore
   - Refresh page - preset should still exist
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/29-user-management-workflows/29-04-SUMMARY.md`
</output>
