---
phase: 02-test-infrastructure-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - api/config.yml
  - api/tests/testthat/helper-db.R
autonomous: true

must_haves:
  truths:
    - "Test database configuration exists separate from dev/prod"
    - "get_test_db_connection() returns valid DBI connection to test database"
    - "skip_if_no_test_db() properly skips tests when DB unavailable"
  artifacts:
    - path: "api/config.yml"
      provides: "sysndd_db_test configuration block"
      contains: "sysndd_db_test"
    - path: "api/tests/testthat/helper-db.R"
      provides: "Database connection helpers for tests"
      exports: ["get_test_db_connection", "skip_if_no_test_db", "with_test_db_transaction"]
  key_links:
    - from: "api/tests/testthat/helper-db.R"
      to: "api/config.yml"
      via: "config::get('sysndd_db_test')"
      pattern: "config::get.*sysndd_db_test"
---

<objective>
Configure isolated test database connection for the R API test suite.

Purpose: Test database isolation is critical - tests must never touch dev or production data. This plan adds the test DB config and creates reusable helper functions for database connections in tests.

Output: `api/config.yml` has `sysndd_db_test` section, `helper-db.R` provides `get_test_db_connection()`, `skip_if_no_test_db()`, and `with_test_db_transaction()` functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-test-infrastructure-foundation/02-CONTEXT.md
@.planning/phases/02-test-infrastructure-foundation/02-RESEARCH.md
@api/config.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add test database configuration</name>
  <files>api/config.yml</files>
  <action>
Add a new `sysndd_db_test` configuration block to `api/config.yml`.

The test config should:
- Use a separate database name (`sysndd_db_test`) to avoid touching dev/prod data
- Use the same host/port as local development (127.0.0.1:7654)
- Use port 7779 for the test API (dev uses 7778, prod uses 7777)
- Include all necessary fields (dbname, user, password, salt, secret, etc.)

Add this section after the `sysndd_db_local` block:

```yaml
  sysndd_db_test:
    workdir: "C:/development/sysndd/api"
    dbtype: mysql
    dbname: sysndd_db_test
    user: bernt
    password: "Nur7DoofeFliegen."
    salt: "F75m1mwbGh)z"
    server: "0.0.0.0"
    host: "127.0.0.1"
    port: "7654"
    port_self: "7779"
    secret: mHzU/}bny4-==rm0]9~bsq.2Ob2`lHgu2#+K(/Dih#7bN@KmMLf\AK9y:Inf+FN
    refresh: 3600
    base_url: "http://127.0.0.1"
    api_base_url: "http://127.0.0.1:7779"
    mail_noreply_user: "noreply@sysndd.org"
    mail_noreply_host: "smtp.strato.de"
    mail_noreply_port: 587
    mail_noreply_use_ssl: TRUE
    mail_noreply_overwrite: TRUE
    mail_noreply_password: "Nur7DoofeFliegen."
    archive_access_key: "fbDoOOgwotN718O1"
    archive_secret_key: "3YTXC8vPSNSfkVCG"
    archive_base_url: "https://sysndd.dbmr.unibe.ch/"
    omim_token: "9GJLEFvqSmWaImCijeRdVA"
```

Note: The only differences from local config are:
- `dbname: sysndd_db_test` (separate test database)
- `port_self: "7779"` (test API port)
- `api_base_url: "http://127.0.0.1:7779"` (test API URL)
  </action>
  <verify>Run `Rscript -e "config::get('sysndd_db_test', file = 'config.yml')" | grep dbname` from api/ directory - should show "sysndd_db_test"</verify>
  <done>config.yml contains sysndd_db_test section with isolated test database name and test API port 7779</done>
</task>

<task type="auto">
  <name>Task 2: Create database helper functions</name>
  <files>api/tests/testthat/helper-db.R</files>
  <action>
Create `api/tests/testthat/helper-db.R` with database connection helpers.

```r
# tests/testthat/helper-db.R
# Database connection helpers for tests
#
# These functions provide isolated test database access with proper cleanup.
# Uses config::get() to load sysndd_db_test configuration.

#' Get test database connection
#'
#' Creates a DBI connection to the test database.
#' Caller is responsible for disconnecting.
#'
#' @return DBI connection to test database
#' @examples
#' con <- get_test_db_connection()
#' # ... use connection ...
#' DBI::dbDisconnect(con)
get_test_db_connection <- function() {
  # Load test config from api/config.yml
  config_path <- if (file.exists("config.yml")) {
    "config.yml"
  } else if (file.exists("../config.yml")) {
    "../config.yml"
  } else {
    stop("config.yml not found. Run tests from api/ directory.")
  }

  test_config <- config::get("sysndd_db_test", file = config_path)

  if (is.null(test_config)) {
    stop("sysndd_db_test configuration not found in config.yml")
  }

  DBI::dbConnect(
    RMariaDB::MariaDB(),
    dbname = test_config$dbname,
    host = test_config$host,
    user = test_config$user,
    password = test_config$password,
    port = as.integer(test_config$port)
  )
}


#' Check if test database is available
#'
#' Attempts to connect to test database and returns TRUE/FALSE.
#' Used internally by skip_if_no_test_db().
#'
#' @return Logical indicating if test DB is available
test_db_available <- function() {
  tryCatch({
    con <- get_test_db_connection()
    DBI::dbDisconnect(con)
    TRUE
  }, error = function(e) {
    FALSE
  })
}


#' Skip test if test database unavailable
#'
#' Call at the start of integration tests that require database.
#' Provides informative skip message.
#'
#' @examples
#' test_that("database query works", {
#'   skip_if_no_test_db()
#'   # ... test code ...
#' })
skip_if_no_test_db <- function() {
  if (!test_db_available()) {
    testthat::skip("Test database (sysndd_db_test) not available")
  }
}


#' Run code with test database transaction (auto-rollback)
#'
#' Wraps code in a transaction that is always rolled back,
#' ensuring tests don't leave data in the database.
#'
#' @param code Code block to execute within transaction
#' @return Result of code block
#'
#' @examples
#' test_that("entity creation works", {
#'   with_test_db_transaction({
#'     con <- getOption(".test_db_con")
#'     # ... insert data ...
#'     # Transaction will be rolled back after test
#'   })
#' })
with_test_db_transaction <- function(code) {
  skip_if_no_test_db()

  con <- get_test_db_connection()
  withr::defer(DBI::dbDisconnect(con))

  DBI::dbBegin(con)
  withr::defer(DBI::dbRollback(con))

  # Make connection available to code block
  withr::local_options(list(.test_db_con = con))

  force(code)
}


#' Get test configuration value
#'
#' Helper to access test config values (secret, etc.)
#'
#' @param key Configuration key to retrieve
#' @return Configuration value
get_test_config <- function(key = NULL) {
  config_path <- if (file.exists("config.yml")) {
    "config.yml"
  } else if (file.exists("../config.yml")) {
    "../config.yml"
  } else {
    stop("config.yml not found")
  }

  config <- config::get("sysndd_db_test", file = config_path)

  if (is.null(key)) {
    return(config)
  }

  config[[key]]
}
```

This file will be automatically sourced by setup.R (created in Plan 02-01) via the helper-*.R pattern matching.
  </action>
  <verify>
1. File exists: `ls api/tests/testthat/helper-db.R`
2. Syntax valid: `Rscript -e "source('api/tests/testthat/helper-db.R'); cat('Syntax OK\n')"`
3. Functions defined: `Rscript -e "source('api/tests/testthat/helper-db.R'); cat(exists('get_test_db_connection'), exists('skip_if_no_test_db'), '\n')"`
  </verify>
  <done>
- helper-db.R exists with get_test_db_connection(), skip_if_no_test_db(), with_test_db_transaction(), get_test_config()
- Functions use config::get('sysndd_db_test') for isolated test database
- Transaction helper ensures automatic rollback for clean test state
  </done>
</task>

</tasks>

<verification>
Run from `api/` directory:

1. **Config verification:**
   ```bash
   Rscript -e "cfg <- config::get('sysndd_db_test', file = 'config.yml'); cat('dbname:', cfg\$dbname, '\nport_self:', cfg\$port_self, '\n')"
   ```
   Expected output: `dbname: sysndd_db_test` and `port_self: 7779`

2. **Helper syntax check:**
   ```bash
   Rscript -e "source('tests/testthat/helper-db.R')"
   ```
   Should complete without errors.

3. **Function availability:**
   ```bash
   Rscript -e "source('tests/testthat/helper-db.R'); cat('Functions:', exists('get_test_db_connection'), exists('skip_if_no_test_db'), exists('with_test_db_transaction'), '\n')"
   ```
   Should output: `Functions: TRUE TRUE TRUE`

Note: Actual database connection test will be done when test DB is set up. The skip_if_no_test_db() function handles missing DB gracefully.
</verification>

<success_criteria>
- config.yml has sysndd_db_test section with isolated database name
- Test API port is 7779 (avoids conflict with dev 7778 and prod 7777)
- helper-db.R provides get_test_db_connection(), skip_if_no_test_db(), with_test_db_transaction()
- Helper functions load without syntax errors
- Requirement TEST-06 (test database connection) is complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-test-infrastructure-foundation/02-02-SUMMARY.md`
</output>
