---
phase: 02-test-infrastructure-foundation
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - api/tests/testthat/test-unit-helper-functions.R
autonomous: true

must_haves:
  truths:
    - "is_valid_email correctly validates email addresses"
    - "generate_initials creates correct initials from names"
    - "generate_sort_expressions parses sort strings correctly"
    - "At least 5 unit tests pass for helper functions"
  artifacts:
    - path: "api/tests/testthat/test-unit-helper-functions.R"
      provides: "Unit tests for helper-functions.R"
      min_lines: 80
  key_links:
    - from: "api/tests/testthat/test-unit-helper-functions.R"
      to: "api/functions/helper-functions.R"
      via: "source() and function calls"
      pattern: "source.*helper-functions"
---

<objective>
Write unit tests for core utility functions in helper-functions.R.

Purpose: The helper-functions.R file contains pure functions (is_valid_email, generate_initials, generate_sort_expressions, etc.) that are ideal for TDD-style unit testing. These tests validate the business logic foundation without requiring database or API access.

Output: `api/tests/testthat/test-unit-helper-functions.R` with at least 5 passing unit tests covering email validation, initials generation, and sort expression parsing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-test-infrastructure-foundation/02-CONTEXT.md
@.planning/phases/02-test-infrastructure-foundation/02-RESEARCH.md
@api/functions/helper-functions.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for is_valid_email</name>
  <files>api/tests/testthat/test-unit-helper-functions.R</files>
  <action>
Create `api/tests/testthat/test-unit-helper-functions.R` with unit tests for helper functions.

Start with is_valid_email() tests - this function uses regex to validate email addresses.

```r
# tests/testthat/test-unit-helper-functions.R
# Unit tests for api/functions/helper-functions.R
#
# These tests cover pure functions that don't require database access.
# Run with: Rscript -e "testthat::test_file('tests/testthat/test-unit-helper-functions.R')"

# Load required libraries
library(testthat)
library(dplyr)
library(tibble)
library(stringr)
library(tidyr)

# Source the functions being tested
# Note: test_path() resolves relative to tests/testthat/ directory
source(file.path(dirname(test_path()), "..", "functions", "helper-functions.R"))

# =============================================================================
# is_valid_email() tests
# =============================================================================

test_that("is_valid_email returns TRUE for valid email addresses", {
  expect_true(is_valid_email("test@example.com"))
  expect_true(is_valid_email("user.name@domain.org"))
  expect_true(is_valid_email("user+tag@example.co.uk"))
  expect_true(is_valid_email("USER@CAPS.COM"))
  expect_true(is_valid_email("john.doe123@university.edu"))
})

test_that("is_valid_email returns FALSE for invalid email addresses", {
  expect_false(is_valid_email("not-an-email"))
  expect_false(is_valid_email("missing@"))
  expect_false(is_valid_email("@nodomain.com"))
  expect_false(is_valid_email("spaces in@email.com"))
  expect_false(is_valid_email(""))
})

test_that("is_valid_email handles edge cases", {
  # Single character domain parts should fail (needs 2+ chars in TLD)
  expect_false(is_valid_email("test@example.c"))

  # Numbers in email are valid
  expect_true(is_valid_email("user123@domain456.com"))

  # Dots in local part are valid
  expect_true(is_valid_email("first.last@example.com"))

  # Underscores are valid
  expect_true(is_valid_email("user_name@example.com"))
})
```
  </action>
  <verify>Run `cd api && Rscript -e "testthat::test_file('tests/testthat/test-unit-helper-functions.R')"` - should show 3 passing test blocks for is_valid_email</verify>
  <done>is_valid_email tests exist and pass, covering valid emails, invalid emails, and edge cases</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for generate_initials and generate_sort_expressions</name>
  <files>api/tests/testthat/test-unit-helper-functions.R</files>
  <action>
Add additional test blocks to `api/tests/testthat/test-unit-helper-functions.R` for:

1. generate_initials() - creates initials from first and last name
2. generate_sort_expressions() - parses sort strings into dplyr expressions

Append these tests to the existing file:

```r
# =============================================================================
# generate_initials() tests
# =============================================================================

test_that("generate_initials creates correct initials from names", {
  expect_equal(generate_initials("John", "Doe"), "JD")
  expect_equal(generate_initials("Ada", "Lovelace"), "AL")
  expect_equal(generate_initials("Marie", "Curie"), "MC")
})

test_that("generate_initials handles single-letter names", {
  expect_equal(generate_initials("A", "B"), "AB")
})

test_that("generate_initials handles lowercase input", {
  # Function takes first char regardless of case
  expect_equal(generate_initials("john", "doe"), "jd")
})


# =============================================================================
# generate_sort_expressions() tests
# =============================================================================

test_that("generate_sort_expressions parses ascending sort", {
  result <- generate_sort_expressions("+name", unique_id = "id")

  expect_true("name" %in% result)
  # unique_id should be appended if not present
  expect_true("id" %in% result)
})

test_that("generate_sort_expressions parses descending sort", {
  result <- generate_sort_expressions("-name", unique_id = "id")

  expect_true("desc(name)" %in% result)
  expect_true("id" %in% result)
})

test_that("generate_sort_expressions handles multiple columns", {
  result <- generate_sort_expressions("+name,-age,+date", unique_id = "id")

  expect_true("name" %in% result)
  expect_true("desc(age)" %in% result)
  expect_true("date" %in% result)
  expect_true("id" %in% result)
})

test_that("generate_sort_expressions defaults to ascending without prefix", {

  result <- generate_sort_expressions("name", unique_id = "id")

  expect_true("name" %in% result)
})

test_that("generate_sort_expressions includes unique_id only once", {
  # When unique_id is already in sort list, don't duplicate
  result <- generate_sort_expressions("+entity_id,-name", unique_id = "entity_id")

  # entity_id should appear only once
  expect_equal(sum(grepl("entity_id", result)), 1)
})
```

After adding these tests, the file should have at least 11 test blocks covering:
- is_valid_email (3 tests)
- generate_initials (3 tests)
- generate_sort_expressions (5 tests)
  </action>
  <verify>Run `cd api && Rscript -e "testthat::test_file('tests/testthat/test-unit-helper-functions.R')"` - should show all tests passing (11 test blocks)</verify>
  <done>
- test-unit-helper-functions.R has 11+ test blocks
- All tests pass
- Coverage includes is_valid_email, generate_initials, generate_sort_expressions
- Requirement TEST-03 (unit tests for utility functions) is complete with 5+ passing tests
  </done>
</task>

</tasks>

<verification>
Run from `api/` directory:

1. **Test file syntax:**
   ```bash
   Rscript -e "parse('tests/testthat/test-unit-helper-functions.R')"
   ```
   Should complete without errors.

2. **Run unit tests:**
   ```bash
   Rscript -e "testthat::test_file('tests/testthat/test-unit-helper-functions.R')"
   ```
   Should show all tests passing.

3. **Full test suite:**
   ```bash
   Rscript -e "testthat::test_dir('tests/testthat', filter = 'unit', reporter = 'progress')"
   ```
   Should show unit tests running and passing.

4. **Count tests:**
   ```bash
   grep -c "test_that" tests/testthat/test-unit-helper-functions.R
   ```
   Should be >= 11.
</verification>

<success_criteria>
- test-unit-helper-functions.R exists with 11+ test blocks
- All tests pass when run via testthat::test_file()
- Tests cover: is_valid_email (valid, invalid, edge cases), generate_initials, generate_sort_expressions
- No database or API dependencies in these unit tests
- Requirement TEST-03 (unit tests for core utility functions) is complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-test-infrastructure-foundation/02-03-SUMMARY.md`
</output>
