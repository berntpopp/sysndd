---
phase: 02-test-infrastructure-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/tests/testthat/setup.R
  - api/tests/testthat.R
autonomous: true

must_haves:
  truths:
    - "testthat::test_dir('tests/testthat') runs without package errors"
    - "Test helpers are automatically loaded before tests run"
    - "setup.R initializes test environment correctly"
  artifacts:
    - path: "api/tests/testthat/setup.R"
      provides: "Global test setup with library loading and helper sourcing"
      min_lines: 20
    - path: "api/tests/testthat.R"
      provides: "Test runner entry point"
      exports: ["test_check"]
  key_links:
    - from: "api/tests/testthat.R"
      to: "testthat::test_check()"
      via: "Standard testthat runner"
      pattern: "test_check"
    - from: "api/tests/testthat/setup.R"
      to: "helper files"
      via: "source() calls"
      pattern: "source.*helper"
---

<objective>
Create the testthat test infrastructure foundation for the R API.

Purpose: Establish the directory structure and entry points that all subsequent test plans depend on. This enables TDD for the rest of Phase 2 and future work.

Output: Working test infrastructure with `api/tests/testthat/` directory, setup.R, and test runner entry point. Running `Rscript -e "testthat::test_dir('tests/testthat')"` from `api/` should complete without errors (with 0 tests initially).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-test-infrastructure-foundation/02-CONTEXT.md
@.planning/phases/02-test-infrastructure-foundation/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install testing packages</name>
  <files>api/tests/testthat/setup.R</files>
  <action>
Install the required testing packages if not already present:
- testthat (>= 3.0.0)
- dittodb (for database mocking)
- withr (for cleanup/teardown)
- httr2 (for HTTP testing)
- mirai (for async API testing)

Run: `Rscript -e "install.packages(c('testthat', 'dittodb', 'withr', 'httr2', 'mirai'), repos='https://cloud.r-project.org')"`

Verify packages installed: `Rscript -e "library(testthat); library(dittodb); library(withr); library(httr2); library(mirai); cat('All packages loaded successfully\n')"`
  </action>
  <verify>Run `Rscript -e "library(testthat); library(dittodb); library(withr); library(httr2); library(mirai); cat('OK\n')"` returns "OK" without errors</verify>
  <done>All 5 testing packages (testthat, dittodb, withr, httr2, mirai) are installed and loadable</done>
</task>

<task type="auto">
  <name>Task 2: Create test directory structure and core files</name>
  <files>api/tests/testthat/setup.R, api/tests/testthat.R</files>
  <action>
Create the test directory structure following testthat 3e conventions:

1. Create directories:
   - `api/tests/testthat/`
   - `api/tests/testthat/fixtures/` (for dittodb fixtures)

2. Create `api/tests/testthat.R` (test runner entry point):
```r
# Test runner for SysNDD API
# Run with: Rscript -e "testthat::test_dir('tests/testthat')"

library(testthat)

# Set working directory to api/ for correct path resolution
if (basename(getwd()) != "api") {
  stop("Tests must be run from the api/ directory")
}

test_check("sysndd")
```

3. Create `api/tests/testthat/setup.R` (global test setup):
```r
# tests/testthat/setup.R
# Global test setup - runs before any test file

# Load testing libraries
library(testthat)
library(dittodb)
library(withr)
library(httr2)

# Load tidyverse for data manipulation (used in assertions)
library(dplyr)
library(tibble)
library(stringr)

# Source helper files (will be created in subsequent plans)
# These use test_path() for portable path resolution
helper_files <- list.files(
  test_path(),
  pattern = "^helper-.*\\.R$",
  full.names = TRUE
)
for (helper in helper_files) {
  source(helper, local = TRUE)
}

# Configure testthat options
withr::local_options(
  list(
    testthat.progress.max_fails = 50,  # Don't stop early
    testthat.progress.show_status = TRUE
  ),
  .local_envir = teardown_env()
)

# Log test initialization
message("SysNDD API test environment initialized")
```

Note: The setup.R file sources helper-*.R files dynamically. These will be created in Plans 02-02, 02-03, 02-04.
  </action>
  <verify>
1. Directory exists: `ls -la api/tests/testthat/`
2. Files created: `ls api/tests/testthat.R api/tests/testthat/setup.R`
3. Test runner works: `cd api && Rscript -e "testthat::test_dir('tests/testthat')" 2>&1 | head -20`
  </verify>
  <done>
- `api/tests/testthat/` directory exists with `setup.R` and `fixtures/` subdirectory
- `api/tests/testthat.R` entry point exists
- Running testthat::test_dir() completes without errors (0 tests, 0 failures)
  </done>
</task>

</tasks>

<verification>
Run from `api/` directory:

1. **Package check:**
   ```bash
   Rscript -e "library(testthat); library(dittodb); library(withr); library(httr2); library(mirai)"
   ```
   Should complete without errors.

2. **Directory structure:**
   ```bash
   ls -la tests/testthat/
   ```
   Should show: setup.R, fixtures/

3. **Test execution:**
   ```bash
   Rscript -e "testthat::test_dir('tests/testthat', reporter = 'progress')"
   ```
   Should show "0 tests" and exit cleanly (no errors).
</verification>

<success_criteria>
- All 5 testing packages installed and loadable
- `api/tests/testthat/` directory structure exists
- `api/tests/testthat/setup.R` loads libraries and sources helpers
- `api/tests/testthat.R` provides test entry point
- `testthat::test_dir('tests/testthat')` runs without errors
- Requirements TEST-01 (framework) and TEST-02 (structure) partially complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-test-infrastructure-foundation/02-01-SUMMARY.md`
</output>
