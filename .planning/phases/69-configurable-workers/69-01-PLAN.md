---
phase: 69-configurable-workers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/start_sysndd_api.R
  - api/endpoints/health_endpoints.R
  - docker-compose.yml
  - docker-compose.override.yml
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Operator can set MIRAI_WORKERS=N in docker-compose and API spawns exactly N workers"
    - "Invalid values (0, 9, 'abc') result in bounded defaults (1-8) being applied"
    - "Health endpoint /api/health/performance includes configured worker count"
    - "Startup log message shows actual worker count used"
  artifacts:
    - path: "api/start_sysndd_api.R"
      provides: "MIRAI_WORKERS env var parsing with bounds validation"
      contains: "MIRAI_WORKERS"
    - path: "api/endpoints/health_endpoints.R"
      provides: "Worker count in performance endpoint response"
      contains: "configured"
    - path: "docker-compose.yml"
      provides: "MIRAI_WORKERS env var with production default"
      contains: "MIRAI_WORKERS"
    - path: "docker-compose.override.yml"
      provides: "MIRAI_WORKERS env var with development default"
      contains: "MIRAI_WORKERS"
  key_links:
    - from: "api/start_sysndd_api.R"
      to: "mirai::daemons()"
      via: "worker_count variable passed to n parameter"
      pattern: "daemons\\(\\s*n\\s*=\\s*worker_count"
    - from: "api/endpoints/health_endpoints.R"
      to: "MIRAI_WORKERS env var"
      via: "Sys.getenv() call in worker_status"
      pattern: "Sys\\.getenv\\(\"MIRAI_WORKERS\""
---

<objective>
Implement configurable mirai worker count via MIRAI_WORKERS environment variable.

Purpose: Allow operators to tune worker count for memory-constrained servers (issue #150). A 4GB VPS may only run 1 worker safely, while a 32GB server can run 4-8.

Output: Modified API startup that reads MIRAI_WORKERS, validates bounds (1-8), logs configuration, and exposes count in health endpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Existing patterns to follow
@api/start_sysndd_api.R (lines 184-204 show DB_POOL_SIZE pattern)
@api/endpoints/health_endpoints.R (lines 112-130 show pool_stats pattern)
@docker-compose.yml (line 158 shows DB_POOL_SIZE env var pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement MIRAI_WORKERS configuration in API startup</name>
  <files>api/start_sysndd_api.R</files>
  <action>
Modify the mirai daemon initialization section (around lines 374-381) to:

1. Read worker count from environment variable with default:
   ```r
   worker_count <- as.integer(Sys.getenv("MIRAI_WORKERS", "2"))
   ```

2. Handle NA from invalid input (e.g., "abc"):
   ```r
   if (is.na(worker_count)) worker_count <- 2L
   ```

3. Validate bounds (minimum 1, maximum 8):
   ```r
   worker_count <- max(1L, min(worker_count, 8L))
   ```

4. Pass to daemons():
   ```r
   daemons(
     n = worker_count,
     dispatcher = TRUE,
     autoexit = tools::SIGINT
   )
   ```

5. Update the log message to use the variable:
   ```r
   message(sprintf("[%s] Started mirai daemon pool with %d workers", Sys.time(), worker_count))
   ```

Follow the existing DB_POOL_SIZE pattern (lines 184-204) for consistency.
  </action>
  <verify>
Grep for MIRAI_WORKERS in start_sysndd_api.R:
```bash
grep -n "MIRAI_WORKERS" api/start_sysndd_api.R
```
Should show Sys.getenv call. Also verify daemons() uses worker_count variable:
```bash
grep -A5 "daemons(" api/start_sysndd_api.R
```
  </verify>
  <done>
- MIRAI_WORKERS is read from environment with default 2
- Invalid values (NA) fall back to default
- Values are bounded to 1-8 range
- daemons() receives the validated worker_count
- Startup log message shows actual worker count
  </done>
</task>

<task type="auto">
  <name>Task 2: Expose worker configuration in health endpoint</name>
  <files>api/endpoints/health_endpoints.R</files>
  <action>
Modify the /health/performance endpoint's worker_status section (around lines 205-223) to:

1. Read configured value from environment:
   ```r
   configured_workers <- as.integer(Sys.getenv("MIRAI_WORKERS", "2"))
   if (is.na(configured_workers)) configured_workers <- 2L
   configured_workers <- max(1L, min(configured_workers, 8L))
   ```

2. Update the worker_status response to include configured count:
   ```r
   worker_status <- tryCatch(
     {
       status <- mirai::status()
       list(
         configured = configured_workers,
         connections = status$connections,
         dispatcher_active = TRUE
       )
     },
     error = function(e) {
       list(
         configured = configured_workers,
         connections = 0,
         dispatcher_active = FALSE,
         error = e$message
       )
     }
   )
   ```

3. Remove the hard-coded `total_workers = 8` field (it was incorrect anyway).

This follows the existing pool_stats pattern (lines 112-130) which exposes DB_POOL_SIZE.
  </action>
  <verify>
Check that configured appears in the endpoint response:
```bash
grep -A20 "worker_status <- tryCatch" api/endpoints/health_endpoints.R
```
Should show `configured = configured_workers` in both success and error branches.
  </verify>
  <done>
- /api/health/performance response includes workers.configured field
- workers.connections shows actual mirai daemon connections
- Hard-coded total_workers = 8 is removed
- Error branch also includes configured count
  </done>
</task>

<task type="auto">
  <name>Task 3: Add MIRAI_WORKERS to docker-compose files</name>
  <files>docker-compose.yml, docker-compose.override.yml</files>
  <action>
1. In docker-compose.yml, add MIRAI_WORKERS to the api service environment section (around line 158, after DB_POOL_SIZE):
   ```yaml
   environment:
     ENVIRONMENT: production
     PASSWORD: ${PASSWORD}
     SMTP_PASSWORD: ${SMTP_PASSWORD}
     DB_POOL_SIZE: ${DB_POOL_SIZE:-5}
     MIRAI_WORKERS: ${MIRAI_WORKERS:-2}
     GEMINI_API_KEY: ${GEMINI_API_KEY:-}
     CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-}
   ```

2. In docker-compose.override.yml, add MIRAI_WORKERS with development default (1 worker) to the api service environment section (around line 65):
   ```yaml
   api:
     environment:
       ENVIRONMENT: development
       MIRAI_WORKERS: ${MIRAI_WORKERS:-1}
   ```

Note: docker-compose.dev.yml is for databases only (API runs locally in that workflow), so no changes needed there.
  </action>
  <verify>
Check both files have MIRAI_WORKERS:
```bash
grep -n "MIRAI_WORKERS" docker-compose.yml docker-compose.override.yml
```
Should show MIRAI_WORKERS in both files with correct defaults (2 for production, 1 for dev).
  </verify>
  <done>
- docker-compose.yml has MIRAI_WORKERS=${MIRAI_WORKERS:-2}
- docker-compose.override.yml has MIRAI_WORKERS=${MIRAI_WORKERS:-1}
- Operators can override via environment variable or .env file
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Syntax check** - R files parse without error:
   ```bash
   cd api && Rscript -e "parse('start_sysndd_api.R')" && Rscript -e "parse('endpoints/health_endpoints.R')"
   ```

2. **Docker compose validation** - YAML is valid:
   ```bash
   docker compose config --quiet && echo "docker-compose.yml valid"
   docker compose -f docker-compose.yml -f docker-compose.override.yml config --quiet && echo "override valid"
   ```

3. **Lint check** - No new lintr issues:
   ```bash
   cd api && Rscript -e "lintr::lint('start_sysndd_api.R')"
   cd api && Rscript -e "lintr::lint('endpoints/health_endpoints.R')"
   ```
</verification>

<success_criteria>
Requirements coverage:
- [x] MEM-01: mirai worker count is configurable via MIRAI_WORKERS environment variable
- [x] MEM-02: Worker count is bounded between 1 and 8 workers
- [x] MEM-03: Worker count is exposed in health endpoint response for monitoring
- [x] MEM-04: docker-compose.yml includes MIRAI_WORKERS with default 2
- [x] MEM-05: docker-compose.override.yml includes MIRAI_WORKERS with default 1

Observable behaviors:
1. API with MIRAI_WORKERS=4 logs "Started mirai daemon pool with 4 workers"
2. API with MIRAI_WORKERS=0 logs "Started mirai daemon pool with 1 workers" (bounded)
3. API with MIRAI_WORKERS=20 logs "Started mirai daemon pool with 8 workers" (bounded)
4. API with MIRAI_WORKERS=abc logs "Started mirai daemon pool with 2 workers" (default)
5. GET /api/health/performance returns {"workers": {"configured": N, "connections": N, ...}}
</success_criteria>

<output>
After completion, create `.planning/phases/69-configurable-workers/69-01-SUMMARY.md`
</output>
