---
phase: 06-security-compose-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
autonomous: false

must_haves:
  truths:
    - "docker compose up starts all services without errors"
    - "Traefik routes /api/* to API service on port 7777"
    - "Traefik routes /* to frontend service on port 80"
    - "MySQL is isolated on backend network only"
    - "Health checks pass for all services within 60 seconds"
    - "No deprecated warnings from docker compose config"
  artifacts:
    - path: "docker-compose.yml"
      provides: "Modern Docker Compose configuration with Traefik, networks, health checks"
      contains: "traefik:v3.6"
    - path: "api/.dockerignore"
      provides: "Build context exclusions for API"
      exists: true
    - path: "app/.dockerignore"
      provides: "Build context exclusions for frontend"
      exists: true
  key_links:
    - from: "traefik service"
      to: "api service"
      via: "Docker labels and proxy network"
      pattern: "traefik.http.routers.api"
    - from: "traefik service"
      to: "app service"
      via: "Docker labels and proxy network"
      pattern: "traefik.http.routers.app"
    - from: "api service"
      to: "mysql service"
      via: "backend network"
      pattern: "networks:.*backend"
---

<objective>
Modernize docker-compose.yml with Traefik reverse proxy, named networks, health checks, and resource limits.

Purpose: Replace abandoned dockercloud/haproxy with actively maintained Traefik v3.6, implement proper network isolation, and bring Docker Compose configuration to modern standards.

Output: A production-ready docker-compose.yml that passes all deprecation checks and properly isolates services.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-security-compose-foundation/06-CONTEXT.md
@.planning/phases/06-security-compose-foundation/06-RESEARCH.md
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify .dockerignore files exist</name>
  <files>api/.dockerignore, app/.dockerignore</files>
  <action>
Verify that .dockerignore files exist in both api/ and app/ directories. These were created in v1 and should already be present.

Check that they contain appropriate exclusions:
- api/.dockerignore: Should exclude .git, tests/, renv/library/, scripts/, *.md, logs/
- app/.dockerignore: Should exclude node_modules/, dist/, .git, tests/, *.md

If files exist with reasonable content, mark SEC-02 and SEC-03 as complete (verification only, no changes needed).
  </action>
  <verify>
    ls -la api/.dockerignore app/.dockerignore
    cat api/.dockerignore
    cat app/.dockerignore
  </verify>
  <done>Both .dockerignore files exist with appropriate exclusions. SEC-02 and SEC-03 verified.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite docker-compose.yml with modern configuration</name>
  <files>docker-compose.yml</files>
  <action>
Completely rewrite docker-compose.yml to implement all Phase 6 requirements. Follow the patterns from 06-RESEARCH.md exactly.

**Requirements to implement:**
- SEC-01: Replace dockercloud/haproxy:1.6.7 with traefik:v3.6
- SEC-07: Mount Docker socket read-only (/var/run/docker.sock:/var/run/docker.sock:ro)
- COMP-01: Remove version field entirely (no version: '3.8' or similar)
- COMP-02: Remove links: directive, use networks instead
- COMP-03: Add named networks (sysndd_proxy, sysndd_backend with internal: true)
- COMP-04: Convert bind mounts to named volumes (mysql_data, mysql_backup)
- COMP-05: Add health checks to ALL services (60s start_period, 30s interval, 3 retries)
- COMP-06: Update MySQL from 8.0.29 to 8.0.40
- COMP-07: Use caching_sha2_password (--authentication-policy=caching_sha2_password)
- COMP-08: Add memory limits (API: 4608M, MySQL: 1024M, App/Traefik/Backup: 256M each)
- COMP-09: Configure Traefik auto-discovery with Docker labels on api and app services

**Network topology (from CONTEXT.md):**
- traefik: proxy network only
- app: proxy network only
- api: proxy AND backend networks
- mysql: backend network only (NOT on proxy)
- mysql-cron-backup: backend network only

**Traefik configuration (from CONTEXT.md):**
- Dashboard disabled (--api.dashboard=false)
- HTTP only, port 80 (no TLS in this phase)
- Minimal logging (--log.level=WARN)
- Ping enabled for health checks (--ping=true)
- Docker provider with exposedbydefault=false

**Service naming:**
- Use container_name for each service: sysndd_traefik, sysndd_mysql, sysndd_api, sysndd_app, sysndd_mysql_backup

**Health checks:**
- Traefik: traefik healthcheck --ping
- MySQL: mysqladmin ping -h localhost -u root -p${MYSQL_ROOT_PASSWORD}
- API: curl -sf http://localhost:7777/api/status_list (use existing endpoint)
- App: wget --no-verbose --tries=1 --spider http://localhost:80/
- Backup: No health check needed (periodic cron job)

**Traefik routing labels:**
- API: PathPrefix(`/api`), port 7777
- App: PathPrefix(`/`), port 80, priority=1 (lower than API)

**Volume definitions at bottom:**
- mysql_data: name: sysndd_mysql_data
- mysql_backup: name: sysndd_mysql_backup

**Keep existing functionality:**
- Preserve all environment variables (MYSQL_DATABASE, MYSQL_USER, etc.)
- Keep API develop/watch configuration for hot-reload
- Keep API volume mount for development (./api/:/sysndd_api_volume/)
- Keep restart policies (use unless-stopped for all)

**Remove:**
- Port 7654:3306 mapping on MySQL (will be re-added in Phase 9 for dev)
- Port 443:443 on app (Traefik handles all incoming traffic)
- Port 80:80 on app (Traefik handles all incoming traffic)
- Port range 7777-7787 on api (Traefik routes to internal port)
- alb service entirely (replaced by traefik)
- links: directive on alb
- sysndd_api_volume at bottom (not a named volume, just inline volume mount)
  </action>
  <verify>
    # Check no deprecated warnings
    docker compose config 2>&1 | grep -i "warning\|deprecated" || echo "No deprecation warnings"

    # Check Docker socket is read-only
    docker compose config | grep -A2 "docker.sock"

    # Check networks defined
    docker compose config | grep -A5 "^networks:"

    # Check volumes defined
    docker compose config | grep -A5 "^volumes:"

    # Verify Traefik version
    docker compose config | grep "traefik:v3.6"

    # Verify MySQL version
    docker compose config | grep "mysql:8.0.40"
  </verify>
  <done>docker-compose.yml rewritten with all Phase 6 requirements. No deprecation warnings from docker compose config.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Docker Compose modernization with Traefik reverse proxy, named networks, health checks, and resource limits</what-built>
  <how-to-verify>
1. Start all services:
   ```bash
   docker compose up -d
   ```

2. Wait for health checks (up to 60 seconds):
   ```bash
   watch docker compose ps
   ```
   All services should show "healthy" or "running" status.

3. Test Traefik routing:
   ```bash
   # Frontend should return HTML
   curl -s http://localhost/ | head -5

   # API should return JSON
   curl -s http://localhost/api/status_list | head -5
   ```

4. Verify network isolation:
   ```bash
   # MySQL should NOT be on proxy network
   docker network inspect sysndd_proxy | grep -i mysql || echo "MySQL correctly NOT on proxy"

   # MySQL should be on backend network
   docker network inspect sysndd_backend | grep -i mysql && echo "MySQL correctly on backend"
   ```

5. Stop services when done:
   ```bash
   docker compose down
   ```

Expected results:
- All services start without errors
- Health checks pass within 60 seconds
- curl to / returns frontend HTML
- curl to /api/status_list returns API JSON response
- MySQL isolated to backend network only
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
Phase 6 requirements verification:

**Security:**
- [ ] SEC-01: Traefik v3.6 replaces dockercloud/haproxy
- [ ] SEC-02: api/.dockerignore exists
- [ ] SEC-03: app/.dockerignore exists
- [ ] SEC-07: Docker socket mounted read-only (:ro)

**Docker Compose:**
- [ ] COMP-01: No version field in compose file
- [ ] COMP-02: No links: directive, using networks
- [ ] COMP-03: Named networks (sysndd_proxy, sysndd_backend)
- [ ] COMP-04: Named volumes (mysql_data, mysql_backup)
- [ ] COMP-05: Health checks on all services
- [ ] COMP-06: MySQL updated to 8.0.40
- [ ] COMP-07: caching_sha2_password authentication
- [ ] COMP-08: Memory limits on all services
- [ ] COMP-09: Traefik labels on api and app services

Commands to verify:
```bash
# No deprecation warnings
docker compose config 2>&1 | grep -i "warning\|deprecated"

# Services start and become healthy
docker compose up -d && sleep 60 && docker compose ps

# Routing works
curl http://localhost/api/status_list
curl http://localhost/

# Network isolation
docker network inspect sysndd_proxy
docker network inspect sysndd_backend
```
</verification>

<success_criteria>
1. `docker compose up` starts all services with Traefik handling routing
2. Services communicate via named networks (proxy, backend) with MySQL isolated from public network
3. Health checks pass for all services within 60 seconds of startup
4. `docker compose config` shows no deprecated warnings (no version field, no links)
5. Docker socket mounted read-only (:ro) in Traefik service
</success_criteria>

<output>
After completion, create `.planning/phases/06-security-compose-foundation/06-01-SUMMARY.md`
</output>
