---
phase: 62-admin-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/endpoints/jobs_endpoints.R
  - api/functions/comparisons-functions.R
  - api/functions/comparisons-sources.R
  - db/migrations/007_comparisons_config.sql
  - api/functions/migration-definitions.R
  - app/src/views/admin/ManageAnnotations.vue
  - app/src/views/analyses/CurationComparisons.vue
autonomous: true

must_haves:
  truths:
    - "Admin can trigger comparisons data refresh from ManageAnnotations"
    - "Refresh downloads from all 7 external databases"
    - "Progress shows which source is being downloaded"
    - "Any source failure aborts entire refresh (all-or-nothing)"
    - "CurationComparisons shows last-updated date dynamically"
  artifacts:
    - path: "api/functions/comparisons-functions.R"
      provides: "Comparisons data download and merge logic"
      min_lines: 200
    - path: "api/functions/comparisons-sources.R"
      provides: "Source URL configuration fetching"
      min_lines: 50
    - path: "api/endpoints/jobs_endpoints.R"
      provides: "POST /comparisons_update/submit endpoint"
      contains: "comparisons_update"
    - path: "db/migrations/007_comparisons_config.sql"
      provides: "comparisons_config table for source URLs and metadata"
      contains: "CREATE TABLE"
    - path: "app/src/views/admin/ManageAnnotations.vue"
      provides: "Comparisons Data Refresh section"
      contains: "Comparisons"
  key_links:
    - from: "app/src/views/admin/ManageAnnotations.vue"
      to: "/api/jobs/comparisons_update/submit"
      via: "axios.post in refreshComparisons()"
      pattern: "comparisons_update/submit"
    - from: "api/endpoints/jobs_endpoints.R"
      to: "api/functions/comparisons-functions.R"
      via: "mirai executor_fn"
      pattern: "comparisons_update_async"
    - from: "app/src/views/analyses/CurationComparisons.vue"
      to: "/api/comparisons/metadata"
      via: "fetch on mount"
      pattern: "/comparisons/metadata"
---

<objective>
Refactor standalone comparisons import script into async job pattern with admin UI

Purpose: Enable admin-triggered refresh of 7 external NDD database comparisons data via the existing async job infrastructure. The 639-line standalone R script becomes API-integrated following the HGNC/PubTator update patterns.

Output: New async job endpoint, refactored R functions, database config table, ManageAnnotations section with progress tracking
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-admin-infrastructure/62-CONTEXT.md
@.planning/phases/62-admin-infrastructure/62-RESEARCH.md

@api/endpoints/jobs_endpoints.R (async job patterns - HGNC, ontology, pubtator)
@api/functions/job-manager.R (create_job, get_job_status)
@api/functions/job-progress.R (progress reporting)
@api/functions/pubtator-functions.R (database transaction patterns)
@app/src/views/admin/ManageAnnotations.vue (admin UI pattern)
@app/src/composables/useAsyncJob.ts (job polling composable)
@db/11_Rcommands_sysndd_db_table_database_comparisons.R (source script to refactor)
@db/data/ndd_databases_links/ndd_databases_links.txt (current source URLs)
@api/endpoints/comparisons_endpoints.R (existing comparisons endpoints)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for comparisons config</name>
  <files>
    db/migrations/007_comparisons_config.sql
    api/functions/migration-definitions.R
  </files>
  <action>
Create migration 007 to add comparisons_config table for storing source URLs and metadata.

Table schema:
```sql
CREATE TABLE IF NOT EXISTS comparisons_config (
  id INT PRIMARY KEY AUTO_INCREMENT,
  source_name VARCHAR(50) NOT NULL UNIQUE,
  source_url TEXT NOT NULL,
  file_format VARCHAR(10) NOT NULL,
  is_active BOOLEAN DEFAULT TRUE,
  last_updated DATETIME NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

Insert initial data from ndd_databases_links.txt:
- radboudumc_ID (pdf)
- gene2phenotype_ID (csv.gz)
- panelapp_ID (tsv)
- sfari (csv)
- geisinger_DBD (csv)
- orphanet_id (json)
- phenotype_hpoa (txt)
- omim_genemap2 (txt)

Add metadata table for tracking last successful refresh:
```sql
CREATE TABLE IF NOT EXISTS comparisons_metadata (
  id INT PRIMARY KEY AUTO_INCREMENT,
  last_full_refresh DATETIME NULL,
  last_refresh_status VARCHAR(20) DEFAULT 'never',
  last_refresh_error TEXT NULL,
  sources_count INT DEFAULT 0,
  rows_imported INT DEFAULT 0
);

INSERT INTO comparisons_metadata (last_refresh_status) VALUES ('never');
```

Register migration in migration-definitions.R following existing pattern.
  </action>
  <verify>
Run `make test-api` to verify migration runs without errors.
Check database has new tables: `SHOW TABLES LIKE 'comparisons%';`
  </verify>
  <done>
Migration 007 exists, runs successfully, comparisons_config and comparisons_metadata tables created with initial data
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor comparisons import logic into API functions</name>
  <files>
    api/functions/comparisons-functions.R
    api/functions/comparisons-sources.R
  </files>
  <action>
Create two new function files following modern R patterns:

**comparisons-sources.R** (source configuration):
- `get_active_sources(conn)` - Fetch active sources from comparisons_config
- `update_source_last_updated(conn, source_name)` - Update timestamp after successful download
- `get_comparisons_metadata(conn)` - Get last refresh info for UI display

**comparisons-functions.R** (core import logic):
Refactor the 639-line script into modular functions:

- `download_source_data(source_config, temp_dir)` - Download single source to temp file
  - Handle pdf (pdftools), csv.gz, csv, tsv, json, txt formats
  - Return path to downloaded file or error

- `parse_radboudumc_pdf(file_path)` - Parse Radboud PDF to tibble
- `parse_gene2phenotype_csv(file_path)` - Parse G2P CSV to tibble
- `parse_panelapp_tsv(file_path)` - Parse PanelApp TSV to tibble
- `parse_sfari_csv(file_path)` - Parse SFARI CSV to tibble
- `parse_geisinger_csv(file_path)` - Parse Geisinger CSV to tibble
- `parse_omim_genemap2(file_path, phenotype_hpoa_path)` - Parse OMIM with HPO annotations
- `parse_orphanet_json(file_path)` - Parse Orphanet JSON to tibble

- `standardize_comparison_data(parsed_data, source_name)` - Normalize to common schema
  - Columns: symbol, hgnc_id, disease_ontology_id, disease_ontology_name, inheritance, category, pathogenicity_mode, phenotype, publication_id, list, version, import_date, granularity

- `resolve_hgnc_symbols(symbols, db_config)` - Batch lookup HGNC IDs from symbols
  - Use non_alt_loci_set table (local lookup, no HGNC API calls in daemon)
  - Handle prev_symbol and alias_symbol lookups

- `comparisons_update_async(params)` - Main async entry point
  - Called from mirai daemon
  - Downloads all sources, parses, standardizes, merges
  - All-or-nothing: any failure aborts entire refresh
  - Uses db_with_transaction pattern for atomic update
  - Updates comparisons_metadata on success

Key patterns to follow:
- Pass db_config as params (not pool connection) - mirai daemon pattern
- Create connection inside daemon function
- Use DBI::dbBind for all queries (no sprintf SQL)
- Progress reporting via create_progress_reporter()
- Cleanup temp files in tryCatch finally block
  </action>
  <verify>
Run `R CMD check` on functions for syntax errors.
Unit tests pass: source the files and verify function signatures exist.
  </verify>
  <done>
comparisons-functions.R and comparisons-sources.R exist with all specified functions, following async job patterns from pubtator and HGNC updates
  </done>
</task>

<task type="auto">
  <name>Task 3: Add comparisons_update job endpoint and admin UI</name>
  <files>
    api/endpoints/jobs_endpoints.R
    api/endpoints/comparisons_endpoints.R
    app/src/views/admin/ManageAnnotations.vue
    app/src/views/analyses/CurationComparisons.vue
  </files>
  <action>
**API Endpoint (jobs_endpoints.R):**
Add POST /comparisons_update/submit endpoint following HGNC update pattern:

```r
#* Submit Comparisons Update Job
#* @tag jobs
#* @post /comparisons_update/submit
function(req, res) {
  require_role(req, res, "Administrator")

  # Extract db_config BEFORE mirai
  db_config <- list(
    dbname = dw$dbname, host = dw$host,
    user = dw$user, password = dw$password, port = dw$port
  )

  # Check for duplicate job
  dup_check <- check_duplicate_job("comparisons_update", list(operation = "comparisons_update"))
  if (dup_check$duplicate) {
    res$status <- 409
    return(list(error = "DUPLICATE_JOB", existing_job_id = dup_check$existing_job_id))
  }

  # Create async job
  result <- create_job(
    operation = "comparisons_update",
    params = list(db_config = db_config),
    timeout_ms = 1800000,  # 30 min
    executor_fn = function(params) {
      comparisons_update_async(params)
    }
  )

  res$status <- 202
  res$setHeader("Location", paste0("/api/jobs/", result$job_id, "/status"))
  list(job_id = result$job_id, status = "accepted", estimated_seconds = 300)
}
```

**Metadata Endpoint (comparisons_endpoints.R):**
Add GET /metadata endpoint to return last refresh info:
```r
#* Get Comparisons Metadata
#* @tag comparisons
#* @get /metadata
function() {
  pool %>%
    tbl("comparisons_metadata") %>%
    collect() %>%
    slice(1)
}
```

**Admin UI (ManageAnnotations.vue):**
Add new section after Pubtator Cache Management, following same pattern:

```vue
<!-- Comparisons Data Refresh Section -->
<BRow class="justify-content-md-center py-2">
  <BCol col md="12">
    <BCard header-tag="header" ...>
      <template #header>
        <h5 class="mb-0 text-start font-weight-bold">
          Comparisons Data Refresh
          <span v-if="comparisonsMetadata.last_full_refresh" class="badge bg-secondary ms-2 fw-normal">
            Last: {{ formatDate(comparisonsMetadata.last_full_refresh) }}
          </span>
          <span class="badge bg-info ms-2 fw-normal">
            {{ comparisonsMetadata.sources_count }} sources
          </span>
        </h5>
      </template>

      <BButton variant="primary" :disabled="comparisonsJob.isLoading.value" @click="refreshComparisons">
        <BSpinner v-if="comparisonsJob.isLoading.value" small type="grow" class="me-2" />
        {{ comparisonsJob.isLoading.value ? 'Updating...' : 'Refresh Comparisons Data' }}
      </BButton>

      <!-- Progress display (copy pattern from HGNC section) -->
    </BCard>
  </BCol>
</BRow>
```

Add composable and functions:
- `const comparisonsJob = useAsyncJob(...)`
- `comparisonsMetadata` ref with fetch on mount
- `refreshComparisons()` async function

**CurationComparisons.vue:**
Convert to Composition API with script setup (match LLM components style).
Add dynamic metadata display in card header or popover showing last-updated date fetched from /api/comparisons/metadata.
  </action>
  <verify>
Start dev server: `make dev`
Navigate to ManageAnnotations - Comparisons section visible
Click refresh button - job starts, progress shows
Navigate to CurationComparisons - last-updated date displays
  </verify>
  <done>
Admin can trigger comparisons refresh from ManageAnnotations with progress tracking. CurationComparisons shows dynamic last-updated date. Job follows all-or-nothing pattern.
  </done>
</task>

</tasks>

<verification>
1. Run `make test-api` - all tests pass including migration
2. Start dev stack: `make dev`
3. Login as admin, navigate to ManageAnnotations
4. Verify Comparisons Data Refresh section shows (after HGNC section)
5. Click Refresh - job starts, progress updates
6. After completion, verify comparisons_metadata updated
7. Navigate to CurationComparisons - verify last-updated date shows
8. Check database: `SELECT COUNT(*) FROM ndd_database_comparison;` - data refreshed
</verification>

<success_criteria>
- Migration 007 creates comparisons_config and comparisons_metadata tables
- POST /api/jobs/comparisons_update/submit endpoint returns 202 with job_id
- GET /api/comparisons/metadata returns last refresh info
- ManageAnnotations shows Comparisons section with last-updated badge and refresh button
- Refresh job downloads all 7 sources, shows progress per source
- Any source failure aborts entire refresh (all-or-nothing)
- CurationComparisons header shows dynamic last-updated date
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/62-admin-infrastructure/62-01-SUMMARY.md`
</output>
