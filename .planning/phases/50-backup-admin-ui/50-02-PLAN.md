---
phase: 50-backup-admin-ui
plan: 02
type: execute
wave: 2
depends_on: ["50-01"]
files_modified:
  - app/src/views/admin/ManageBackups.vue
  - app/src/router/routes.ts
autonomous: false

must_haves:
  truths:
    - "Admin can navigate to /ManageBackups and see backup list"
    - "Admin can download backup files from the list"
    - "Admin can trigger manual backup and see progress"
    - "Restore requires typing RESTORE exactly before button enables"
    - "Concurrent operations show appropriate status"
  artifacts:
    - path: "app/src/views/admin/ManageBackups.vue"
      provides: "Backup management admin view"
      min_lines: 200
    - path: "app/src/router/routes.ts"
      provides: "ManageBackups route with auth guard"
      contains: "ManageBackups"
  key_links:
    - from: "app/src/views/admin/ManageBackups.vue"
      to: "/api/backup/list"
      via: "axios fetch on mount"
      pattern: "axios.*backup/list"
    - from: "app/src/views/admin/ManageBackups.vue"
      to: "/api/backup/create"
      via: "useAsyncJob composable"
      pattern: "backup/create"
    - from: "app/src/views/admin/ManageBackups.vue"
      to: "/api/backup/restore"
      via: "modal confirmation + useAsyncJob"
      pattern: "backup/restore"
---

<objective>
Create the backup management admin UI view.

Purpose: Administrators can view, download, create, and restore database backups through the admin panel. This fulfills BKUP-02 (admin UI displays backup list with download links) and BKUP-04 (restore requires typed confirmation).

Output: ManageBackups.vue with full backup management functionality and route configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-backup-admin-ui/50-CONTEXT.md
@.planning/phases/50-backup-admin-ui/50-RESEARCH.md
@.planning/phases/50-backup-admin-ui/50-01-SUMMARY.md
@app/src/views/admin/ManageAnnotations.vue
@app/src/composables/useAsyncJob.ts
@app/src/router/routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ManageBackups.vue admin view</name>
  <files>app/src/views/admin/ManageBackups.vue</files>
  <action>
Create new file `app/src/views/admin/ManageBackups.vue` following ManageAnnotations.vue patterns:

**Template structure:**
1. Container with BContainer/BRow/BCol layout (md="10" centered)
2. Header: "Manage Backups"

3. **Backup List Card:**
   - Header: "Available Backups" with Refresh button (top-right, outline-secondary, small)
   - BTable with columns:
     - filename (monospace font)
     - size_bytes (formatted as human-readable: "1.2 GB", "458 MB")
     - created_at (absolute date format: "2026-01-29 14:30")
     - actions (Download and Restore buttons)
   - Sort by created_at desc (newest first) by default
   - Striped, hover, small, responsive table
   - Loading spinner while fetching

4. **Backup Now Card:**
   - Header: "Create Manual Backup"
   - "Backup Now" button (variant="primary")
   - Progress display below button when job running (use useAsyncJob pattern from ManageAnnotations.vue)
   - Status badge + step text + animated progress bar + elapsed time
   - Toast on completion/failure

5. **Restore Modal (BModal):**
   - Title: "Restore Database"
   - Danger variant for ok button
   - Content:
     - `<p class="text-danger fw-bold">This will overwrite the current database. Type RESTORE to confirm.</p>`
     - BFormInput for confirmation text (v-model="restoreConfirmText", placeholder="RESTORE", autocomplete="off")
   - ok-title="Restore"
   - ok-variant="danger"
   - :ok-disabled="restoreConfirmText !== 'RESTORE'" (case-sensitive exact match)
   - @ok handler starts restore job
   - @hidden handler resets restoreConfirmText

**Script setup:**
1. Imports: ref, computed, onMounted, watch from vue; axios; useToast; useAsyncJob; BTable, BButton, BModal, BFormInput, BProgress, BSpinner, BCard, BContainer, BRow, BCol

2. Types:
   ```typescript
   interface BackupItem {
     filename: string;
     size_bytes: number;
     created_at: string;
     table_count: number | null;
   }
   ```

3. State:
   - `backups = ref<BackupItem[]>([])`
   - `loading = ref(false)`
   - `showRestoreModal = ref(false)`
   - `selectedBackup = ref<BackupItem | null>(null)`
   - `restoreConfirmText = ref('')`
   - Create two useAsyncJob instances: `backupJob` and `restoreJob`

4. Methods:
   - `fetchBackupList()`: GET /api/backup/list, unwrap R/Plumber values, map to BackupItem[]
   - `formatFileSize(bytes: number)`: Convert to human-readable ("1.2 GB", "458 MB", etc.)
   - `formatDate(dateString: string)`: Format as "YYYY-MM-DD HH:mm"
   - `downloadBackup(filename: string)`: Blob download via axios with auth header, trigger browser download
   - `promptRestore(backup: BackupItem)`: Set selectedBackup, show modal
   - `confirmRestore()`: Reset restoreConfirmText, POST /api/backup/restore with selectedBackup.filename, start restoreJob
   - `triggerBackup()`: POST /api/backup/create, start backupJob

5. Watchers:
   - Watch backupJob.status: On 'completed', show success toast + refresh list. On 'failed', show error toast.
   - Watch restoreJob.status: On 'completed', show success toast with message "Database restored. You may need to log out and log back in for changes to take effect." + refresh list. On 'failed', show error toast.

6. Table fields definition:
   ```typescript
   const backupFields = [
     { key: 'filename', label: 'Filename', sortable: true },
     { key: 'size_bytes', label: 'Size', sortable: true },
     { key: 'created_at', label: 'Created', sortable: true },
     { key: 'actions', label: 'Actions', sortable: false },
   ];
   ```

7. onMounted: Call fetchBackupList()

**Download implementation (from RESEARCH.md):**
```typescript
async function downloadBackup(filename: string) {
  try {
    const response = await axios({
      url: `${import.meta.env.VITE_API_URL}/api/backup/download/${filename}`,
      method: 'GET',
      responseType: 'blob',
      headers: {
        Authorization: `Bearer ${localStorage.getItem('token')}`,
      },
    });

    const url = window.URL.createObjectURL(new Blob([response.data]));
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
  } catch (error) {
    makeToast('Download failed', 'Error', 'danger');
  }
}
```

**File size formatting:**
```typescript
function formatFileSize(bytes: number): string {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}
```
  </action>
  <verify>
1. Run `npm run lint` in app/ - no ESLint errors
2. Run `npm run build` in app/ - build succeeds
3. Visual verification in next task
  </verify>
  <done>
    - ManageBackups.vue created with backup list table
    - Download functionality implemented with blob download
    - Backup Now button with useAsyncJob progress
    - Restore modal with type-to-confirm pattern
    - Watchers handle job completion/failure
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ManageBackups route</name>
  <files>app/src/router/routes.ts</files>
  <action>
Add new route for ManageBackups view in routes.ts:

1. Add route after the existing AdminStatistics route (around line 697):

```typescript
{
  path: '/ManageBackups',
  name: 'ManageBackups',
  component: () => import('@/views/admin/ManageBackups.vue'),
  meta: { sitemap: { ignoreRoute: true } },
  beforeEnter: (to: RouteLocationNormalized, from: RouteLocationNormalized, next: NavigationGuardNext) => {
    const allowed_roles = ['Administrator'];
    let expires = 0;
    let timestamp = 0;
    let user_role = 'Viewer';

    if (localStorage.token) {
      expires = JSON.parse(localStorage.user).exp;
      user_role = JSON.parse(localStorage.user).user_role;
      timestamp = Math.floor(new Date().getTime() / 1000);
    }

    if (!localStorage.user || timestamp > expires || !allowed_roles.includes(user_role[0])) {
      next({ name: 'Login' });
    } else {
      next();
    }
  },
},
```

This follows the exact pattern used by ManageUser, ManageAnnotations, and other admin routes.
  </action>
  <verify>
1. `npm run build` in app/ succeeds (route syntax valid)
2. `npm run lint` passes
3. Verify route exists: `grep -n "ManageBackups" app/src/router/routes.ts`
  </verify>
  <done>
    - Route /ManageBackups added to routes.ts
    - Administrator role guard in place
    - Lazy loading component import
    - sitemap ignoreRoute set
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete backup admin UI with list view, download, backup creation, and restore with confirmation modal.
  </what-built>
  <how-to-verify>
1. Start the development environment: `make up`
2. Log in as Administrator at http://localhost:8080/Login
3. Navigate to http://localhost:8080/ManageBackups

**Verify backup list:**
- [ ] Page loads without errors
- [ ] Table shows available backups (if any exist in /backup volume)
- [ ] Columns: Filename, Size, Created, Actions
- [ ] Size displayed in human-readable format (MB, GB)
- [ ] Refresh button works

**Verify download:**
- [ ] Click Download button on any backup
- [ ] Browser downloads the .sql file
- [ ] File content is valid SQL

**Verify Backup Now:**
- [ ] Click "Backup Now" button
- [ ] Progress bar appears with animated stripes
- [ ] Elapsed time counter runs
- [ ] On completion: success toast, list refreshes, new backup appears

**Verify Restore (careful - this overwrites the database!):**
- [ ] Click Restore button on a backup
- [ ] Modal appears with warning message
- [ ] "Restore" button is disabled initially
- [ ] Type "restore" (lowercase) - button stays disabled
- [ ] Type "RESTORE" (uppercase) - button enables
- [ ] Clear input, type "RESTORE" again, click button
- [ ] Progress appears, restore completes
- [ ] Success toast with re-login suggestion
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 50 requirements verification:
- BKUP-02: Admin UI displays backup list with download links
- BKUP-04: Restore requires typed confirmation ("RESTORE" to proceed)
</verification>

<success_criteria>
- [ ] ManageBackups.vue created with all features
- [ ] Route /ManageBackups accessible to Administrators
- [ ] Backup list displays with download capability
- [ ] "Backup Now" triggers async backup with progress
- [ ] Restore modal requires typing "RESTORE" exactly
- [ ] Restore button disabled until confirmation text matches
- [ ] Success/error toasts provide feedback
- [ ] List auto-refreshes after backup/restore completes
</success_criteria>

<output>
After completion, create `.planning/phases/50-backup-admin-ui/50-02-SUMMARY.md`
</output>
