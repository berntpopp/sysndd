---
phase: 50-backup-admin-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/endpoints/backup_endpoints.R
autonomous: true

must_haves:
  truths:
    - "Admin can download backup files via API"
    - "Download returns raw SQL file with correct Content-Type"
    - "Non-existent files return 404"
  artifacts:
    - path: "api/endpoints/backup_endpoints.R"
      provides: "GET /download/:filename endpoint"
      contains: "@get /download/<filename>"
  key_links:
    - from: "api/endpoints/backup_endpoints.R"
      to: "/backup directory"
      via: "readBin() file serving"
      pattern: "readBin.*backup"
---

<objective>
Add backup file download endpoint to the API layer.

Purpose: Enable the admin UI to download backup files directly. Phase 49 created list/create/restore but not download - UI needs to fetch actual backup files for admin to save locally.

Output: GET /api/backup/download/:filename endpoint returning raw SQL file with appropriate headers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-backup-admin-ui/50-CONTEXT.md
@.planning/phases/50-backup-admin-ui/50-RESEARCH.md
@api/endpoints/backup_endpoints.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add backup download endpoint</name>
  <files>api/endpoints/backup_endpoints.R</files>
  <action>
Add a new endpoint to backup_endpoints.R for downloading backup files:

1. Create GET /download/<filename> endpoint with:
   - `require_role(req, res, "Administrator")` check
   - Validate filename exists in /backup directory
   - Return 404 if file not found
   - Read file using `readBin()` for binary-safe transfer
   - Set headers:
     - `Content-Type: application/sql` (or `application/gzip` for .gz files)
     - `Content-Disposition: attachment; filename="{filename}"`
     - `Content-Length: {file_size}`
   - Use `#* @serializer contentType list(type="application/octet-stream")` to return raw bytes

2. Add path traversal protection:
   - Validate filename contains no path separators (`/`, `\`)
   - Validate filename ends with `.sql` or `.sql.gz`
   - Reject any other patterns to prevent directory traversal attacks

3. Handle gzip files:
   - Detect .gz extension
   - Set `Content-Type: application/gzip` for .gz files
   - Keep original extension in Content-Disposition filename

Place the endpoint after the existing /restore endpoint for logical grouping.
  </action>
  <verify>
Test endpoint manually:
```bash
# Get auth token (if needed)
TOKEN=$(curl -s -X POST http://localhost:9999/api/user/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@test.com","password":"test"}' | jq -r '.token')

# List backups to get a filename
curl -s http://localhost:9999/api/backup/list \
  -H "Authorization: Bearer $TOKEN" | jq '.data[0].filename'

# Download first backup (should return SQL content)
FILENAME=$(curl -s http://localhost:9999/api/backup/list \
  -H "Authorization: Bearer $TOKEN" | jq -r '.data[0].filename')
curl -I http://localhost:9999/api/backup/download/$FILENAME \
  -H "Authorization: Bearer $TOKEN"
# Should see: Content-Type, Content-Disposition headers

# Test 404 for non-existent file
curl -s http://localhost:9999/api/backup/download/nonexistent.sql \
  -H "Authorization: Bearer $TOKEN"
# Should return 404 error

# Test path traversal protection
curl -s http://localhost:9999/api/backup/download/../etc/passwd \
  -H "Authorization: Bearer $TOKEN"
# Should return 400 error
```
  </verify>
  <done>
    - GET /api/backup/download/:filename returns backup file content
    - Correct Content-Type header for .sql and .sql.gz files
    - Content-Disposition triggers download with original filename
    - 404 returned for non-existent files
    - 400 returned for invalid filename patterns (path traversal attempts)
  </done>
</task>

</tasks>

<verification>
API endpoint verification:
1. Download endpoint accessible at /api/backup/download/:filename
2. Returns raw file bytes with correct headers
3. 404 for missing files, 400 for invalid filenames
4. Administrator role required (401/403 without auth)
</verification>

<success_criteria>
- [ ] GET /api/backup/download/:filename endpoint exists
- [ ] Returns SQL file content with Content-Type: application/sql
- [ ] Content-Disposition header triggers browser download
- [ ] Path traversal attacks blocked (no ../ in filename)
- [ ] Non-existent files return 404
- [ ] Unauthorized requests return 401/403
</success_criteria>

<output>
After completion, create `.planning/phases/50-backup-admin-ui/50-01-SUMMARY.md`
</output>
