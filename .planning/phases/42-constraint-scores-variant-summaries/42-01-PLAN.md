---
phase: 42-constraint-scores-variant-summaries
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/types/external.ts
  - app/src/types/index.ts
  - app/src/composables/useGeneExternalData.ts
  - app/src/composables/index.ts
autonomous: true

must_haves:
  truths:
    - "useGeneExternalData composable fetches from /api/external/gene/<symbol> and returns per-source state objects"
    - "gnomad state object has independent loading/error/data refs"
    - "clinvar state object has independent loading/error/data refs"
    - "retry() function re-fetches all data"
    - "TypeScript interfaces match the actual backend API response structure"
  artifacts:
    - path: "app/src/types/external.ts"
      provides: "TypeScript interfaces for gnomAD constraints, ClinVar variants, and aggregation response"
      exports: ["GnomADConstraints", "ClinVarVariant", "ExternalDataResponse", "SourceState"]
    - path: "app/src/composables/useGeneExternalData.ts"
      provides: "Composable with per-source loading/error/data state"
      exports: ["useGeneExternalData"]
  key_links:
    - from: "app/src/composables/useGeneExternalData.ts"
      to: "/api/external/gene/<symbol>"
      via: "axios GET request"
      pattern: "axios\\.get.*external/gene"
    - from: "app/src/composables/useGeneExternalData.ts"
      to: "app/src/types/external.ts"
      via: "import type"
      pattern: "import.*from.*types/external"
    - from: "app/src/types/index.ts"
      to: "app/src/types/external.ts"
      via: "barrel re-export"
      pattern: "export.*external"
    - from: "app/src/composables/index.ts"
      to: "app/src/composables/useGeneExternalData.ts"
      via: "barrel re-export"
      pattern: "useGeneExternalData"
---

<objective>
Create the TypeScript type definitions for external genomic API responses and the useGeneExternalData composable that fetches from the combined backend endpoint with per-source state isolation.

Purpose: COMPOSE-01/02/03 requirements -- the data layer that all Phase 42 UI components depend on. Per-source loading/error/data state enables independent card rendering and graceful degradation.

Output: `app/src/types/external.ts` (interfaces), `app/src/composables/useGeneExternalData.ts` (composable), updated barrel exports.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-constraint-scores-variant-summaries/42-CONTEXT.md
@.planning/phases/42-constraint-scores-variant-summaries/42-RESEARCH.md

Key references:
@app/src/composables/useAsyncJob.ts (existing composable pattern with reactive state)
@app/src/composables/index.ts (barrel export pattern)
@app/src/types/api.ts (existing type definition pattern)
@app/src/types/index.ts (barrel export for types)
@api/functions/external-proxy-gnomad.R (backend data structure -- constraints fields)
@api/endpoints/external_endpoints.R (aggregation endpoint response structure -- sources.gnomad_constraints.constraints, sources.gnomad_clinvar.variants, errors object)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypeScript interfaces for external API responses</name>
  <files>app/src/types/external.ts, app/src/types/index.ts</files>
  <action>
Create `app/src/types/external.ts` with these interfaces matching the ACTUAL backend response structure from `api/endpoints/external_endpoints.R`:

1. **GnomADConstraints** interface with all constraint fields (all `number | null`):
   - pLI
   - oe_lof, oe_lof_lower, oe_lof_upper
   - oe_mis, oe_mis_lower, oe_mis_upper
   - oe_syn, oe_syn_lower, oe_syn_upper
   - exp_lof, obs_lof, exp_mis, obs_mis, exp_syn, obs_syn
   - lof_z, mis_z, syn_z

2. **ClinVarVariant** interface:
   - clinical_significance: string
   - clinvar_variation_id: string
   - gold_stars: number
   - hgvsc: string | null
   - hgvsp: string | null
   - in_gnomad: boolean
   - major_consequence: string
   - pos: number
   - review_status: string
   - variant_id: string

3. **ExternalDataResponse** interface matching aggregation endpoint output:
   - gene_symbol: string
   - sources: object with optional gnomad_constraints (contains constraints: GnomADConstraints), gnomad_clinvar (contains variants: ClinVarVariant[], variant_count: number), and other sources (uniprot, ensembl, alphafold, mgi, rgd) as unknown for now
   - errors: Record<string, ExternalApiError>
   - timestamp: string

4. **ExternalApiError** interface (RFC 9457):
   - type: string
   - title: string
   - status: number
   - detail: string
   - source: string

5. **SourceState<T>** generic interface:
   - loading: boolean
   - error: string | null
   - data: T | null

IMPORTANT: The aggregation endpoint key is `gnomad_constraints` (not `gnomad`), and the constraint data is nested under `.constraints`. The ClinVar key is `gnomad_clinvar` with data under `.variants`. Verify by reading `api/endpoints/external_endpoints.R` lines 488-496 where source keys are defined.

Update `app/src/types/index.ts` to add `export * from './external';` after the existing exports.
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` and confirm no TypeScript errors. Verify the barrel export resolves: `grep "external" app/src/types/index.ts`.
  </verify>
  <done>
TypeScript interfaces exist in `app/src/types/external.ts`, exported via barrel, and type-check passes. Interface field names match actual backend API response keys from the aggregation endpoint.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useGeneExternalData composable with per-source state</name>
  <files>app/src/composables/useGeneExternalData.ts, app/src/composables/index.ts</files>
  <action>
Create `app/src/composables/useGeneExternalData.ts` following the existing composable pattern (see useAsyncJob.ts):

1. **Function signature:** `export function useGeneExternalData(geneSymbol: Ref<string> | string)`
   - Accept both reactive ref and plain string (normalize internally with `toRef`)

2. **Per-source state objects** (COMPOSE-02/03): Create separate reactive state for each source:
   ```typescript
   const gnomad = {
     loading: ref(true),
     error: ref<string | null>(null),
     data: ref<GnomADConstraints | null>(null)
   }
   const clinvar = {
     loading: ref(true),
     error: ref<string | null>(null),
     data: ref<ClinVarVariant[] | null>(null)
   }
   ```

3. **fetchData() function:**
   - Reset all loading states to true, errors to null
   - GET `${import.meta.env.VITE_API_URL}/api/external/gene/${symbol.value}`
   - Use axios (already in project as devDependency used in components)
   - Do NOT send Authorization header -- external proxy endpoints are public (AUTH_ALLOWLIST per 40-04)
   - Parse response and distribute to per-source state:
     - `result.sources?.gnomad_constraints?.constraints` -> `gnomad.data`
     - `result.sources?.gnomad_clinvar?.variants` -> `clinvar.data`
     - Check `result.errors?.gnomad_constraints` for gnomad errors
     - Check `result.errors?.gnomad_clinvar` for clinvar errors
     - Handle `found: false` in sources as "no data available" (not error)
   - Set loading to false for each source after processing (even on error)
   - Catch network errors: set both sources to error state

4. **retry() function:** Simply calls fetchData() again

5. **Computed loading:** `const loading = computed(() => gnomad.loading.value || clinvar.loading.value)`

6. **Return:** `{ gnomad, clinvar, loading, fetchData, retry }`

7. **Export types:** Export `UseGeneExternalDataReturn` interface for consumers

IMPORTANT PATTERNS TO FOLLOW:
- Use the project's axios instance pattern (check how other composables/components use axios -- likely `import axios from 'axios'`)
- Per-source states are plain objects with ref properties (NOT ref of object) -- this allows `gnomad.loading.value` template access
- Do NOT auto-fetch on creation -- let the consumer call fetchData() explicitly (matches existing patterns)
- No Authorization header needed -- endpoints are public

Update `app/src/composables/index.ts` to add barrel export:
```typescript
// Gene external data composable
export { useGeneExternalData } from './useGeneExternalData';
export type { UseGeneExternalDataReturn } from './useGeneExternalData';
```
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` and confirm no TypeScript errors. Verify the composable is exported: `grep "useGeneExternalData" app/src/composables/index.ts`.
  </verify>
  <done>
useGeneExternalData composable exists with per-source loading/error/data state objects (COMPOSE-01/02/03), fetches from combined endpoint, handles error isolation, and is exported from barrel. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors
2. `grep -r "GnomADConstraints" app/src/types/external.ts` -- interface exists
3. `grep -r "ClinVarVariant" app/src/types/external.ts` -- interface exists
4. `grep -r "useGeneExternalData" app/src/composables/index.ts` -- export exists
5. `grep "external" app/src/types/index.ts` -- barrel re-export exists
</verification>

<success_criteria>
- TypeScript interfaces match backend API response structure (gnomad_constraints key, nested .constraints, gnomad_clinvar key, nested .variants)
- Composable exposes per-source state objects with independent loading/error/data refs (COMPOSE-02/03)
- Composable fetches from combined endpoint without auth header (COMPOSE-01)
- All files type-check without errors
- Barrel exports updated in both composables/index.ts and types/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/42-constraint-scores-variant-summaries/42-01-SUMMARY.md`
</output>
