---
phase: 42-constraint-scores-variant-summaries
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/components/gene/GeneConstraintCard.vue
  - app/src/components/gene/GeneClinVarCard.vue
autonomous: true

must_haves:
  truths:
    - "GeneConstraintCard renders gnomAD constraint table with Category/Expected/Observed/Metrics columns"
    - "pLoF row includes pLI value embedded in the row (not prominently displayed)"
    - "LOEUF < 0.6 is highlighted in amber/yellow (gnomAD v4 guideline)"
    - "Confidence interval bars rendered with pure CSS/SVG (no D3.js)"
    - "GeneClinVarCard shows colored ACMG badges with counts per pathogenicity class"
    - "Both cards handle loading, error, and no-data states independently"
    - "Screen reader users get numeric values via aria-label on SVG bars and badges"
  artifacts:
    - path: "app/src/components/gene/GeneConstraintCard.vue"
      provides: "gnomAD constraint scores table card with o/e CI bars"
      min_lines: 100
    - path: "app/src/components/gene/GeneClinVarCard.vue"
      provides: "ClinVar pathogenicity summary card with ACMG colored badges"
      min_lines: 60
  key_links:
    - from: "app/src/components/gene/GeneConstraintCard.vue"
      to: "app/src/types/external.ts"
      via: "import type GnomADConstraints"
      pattern: "import.*GnomADConstraints.*from.*types"
    - from: "app/src/components/gene/GeneClinVarCard.vue"
      to: "app/src/types/external.ts"
      via: "import type ClinVarVariant"
      pattern: "import.*ClinVarVariant.*from.*types"
---

<objective>
Create the two Vue 3 card components that display gnomAD constraint scores and ClinVar variant pathogenicity summaries. These are presentation components that receive data via props.

Purpose: GNOMAD-01 through GNOMAD-05, CLINVAR-01/02, A11Y-01/02 -- the visual cards that researchers see on the gene page showing constraint metrics and variant burden.

Output: `app/src/components/gene/GeneConstraintCard.vue`, `app/src/components/gene/GeneClinVarCard.vue`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-constraint-scores-variant-summaries/42-CONTEXT.md
@.planning/phases/42-constraint-scores-variant-summaries/42-RESEARCH.md

Key references:
@app/src/views/pages/GeneView.vue (existing component style -- BCard, BTable, BButton, Bootstrap Icons patterns)
@app/src/composables/useAsyncJob.ts (reactive state pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GeneConstraintCard component</name>
  <files>app/src/components/gene/GeneConstraintCard.vue</files>
  <action>
Create `app/src/components/gene/` directory if it does not exist, then create `GeneConstraintCard.vue` as a Vue 3 SFC with `<script setup lang="ts">`.

**Props interface:**
```typescript
interface Props {
  geneSymbol: string
  loading: boolean
  error: string | null
  data: GnomADConstraints | null
}
```
Import `GnomADConstraints` from `@/types/external`. (This file is created by Plan 42-01. If running in parallel, the import will resolve once both plans are complete and integrated.)

**Emits:** `{ retry: [] }` -- emitted when retry button clicked in error state.

**Template structure** (per CONTEXT.md decisions):

1. **BCard** with header containing:
   - Title: "Gene Constraint (gnomAD)"
   - External link button to `https://gnomad.broadinstitute.org/gene/${geneSymbol}` (BButton variant="link", target="_blank", with bi-box-arrow-up-right icon)

2. **Loading state** (`v-if="loading"`): BSpinner centered with `label="Loading constraint data..."` and `role="status"`

3. **Error state** (`v-else-if="error"`): Centered muted text with error message + retry BButton (variant="outline-primary", size="sm"). Add `role="alert"` to error div.

4. **No-data state** (`v-else-if="!data"`): Info icon + "No constraint data available for this gene" text

5. **Constraint table** (`v-else`): BTable with these fields matching gnomAD layout:
   - Category (15% width): "Synonymous", "Missense", "pLoF" (bold text)
   - Expected SNVs (15%): `exp_syn`, `exp_mis`, `exp_lof` -- format with 1 decimal
   - Observed SNVs (15%): `obs_syn`, `obs_mis`, `obs_lof` -- format as integer
   - Constraint Metrics (55%): Z-score + o/e ratio + CI bar + pLI (for pLoF row only)

6. **Confidence interval SVG bars** (inline in metrics cell):
   - SVG 100px wide x 12px tall, `role="img"`, aria-label with numeric o/e ratio and CI bounds
   - Gray background rect (0-2 range mapped to 0-100px)
   - Colored CI bar rect from oe_lower to oe_upper (mapped via `scaleOE()` function: `value * 50`, clamped 0-100)
   - Point estimate circle at oe value
   - Color logic: pLoF row with oe_upper < 0.6 gets amber (#ffc107), all others get gray (#6c757d) -- per GNOMAD-05
   - Text showing `(oe_lower - oe_upper)` after the bar

7. **pLI display** (GNOMAD-01): Only in pLoF row, embedded after metrics (not prominent) -- `"pLI: X.XX"` label

8. **LOEUF highlighting** (GNOMAD-02/05): When oe_lof_upper < 0.6, the CI bar for pLoF row is amber (#ffc107)

9. **Helper functions:**
   - `scaleOE(value: number | null): number` -- maps 0-2 range to 0-100px SVG
   - `getOEColor(oe_upper: number | null, category: string): string` -- amber if pLoF + < 0.6, else gray
   - `formatNumber(value: number | null, decimals: number): string` -- returns "N/A" for null
   - `getCIAriaLabel(item): string` -- full ARIA label with o/e ratio and CI bounds for screen readers (A11Y-02)

10. **Card accessibility:**
    - Card wrapper: `role="region"`, `aria-label="Gene constraint scores from gnomAD"`
    - SVG bars: `role="img"` with descriptive aria-label
    - Error div: `role="alert"`

**Style:** Scoped CSS for `.constraint-card { min-height: 300px }` (prevents layout shift per Pitfall 6), `.metrics-cell { display: flex; align-items: center; flex-wrap: wrap }`, `.ci-bar-container { display: inline-flex; align-items: center }`

Use `<BTable :items="tableItems" :fields="tableFields" small striped hover>` with slot templates for category (bold) and metrics (custom render with SVG bars).

IMPORTANT: No interpretation text -- researchers interpret values themselves (per CONTEXT.md decision). No transcript reference note. pLI is embedded in pLoF row, not headline.
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit 2>&1 | head -20` to check for Vue SFC type errors. If vue-tsc is not available, run `npx tsc --noEmit`. Verify file exists and has required elements: `grep -c "aria-label" app/src/components/gene/GeneConstraintCard.vue` should be >= 3.
  </verify>
  <done>
GeneConstraintCard.vue exists with: gnomAD-style constraint table (Category/Expected/Observed/Metrics), SVG confidence interval bars with aria-labels, pLI embedded in pLoF row, LOEUF < 0.6 amber highlight, loading/error/no-data states, and screen reader accessibility. Satisfies GNOMAD-01/02/03/04/05 and A11Y-01/02.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GeneClinVarCard component</name>
  <files>app/src/components/gene/GeneClinVarCard.vue</files>
  <action>
Create `app/src/components/gene/GeneClinVarCard.vue` as a Vue 3 SFC with `<script setup lang="ts">`.

**Props interface:**
```typescript
interface Props {
  geneSymbol: string
  loading: boolean
  error: string | null
  data: ClinVarVariant[] | null
}
```
Import `ClinVarVariant` from `@/types/external`.

**Emits:** `{ retry: [] }`

**Template structure** (per CONTEXT.md decisions):

1. **BCard** with header containing:
   - Title: "ClinVar Variants ({{ totalCount }})" -- shows total count in header
   - External link button to `https://www.ncbi.nlm.nih.gov/clinvar/?term=${geneSymbol}[gene]` (same pattern as constraint card)

2. **Loading state:** BSpinner with `label="Loading ClinVar data..."` and `role="status"`

3. **Error state:** Muted text + retry button + `role="alert"`

4. **No-data state** (`totalCount === 0`): Info icon + "No ClinVar variants available for this gene"

5. **Badge row** (`v-else`): `<div class="d-flex flex-wrap gap-2 p-3">` containing BBadge for each ACMG class WITH variants (filter out zero-count categories):
   - Pathogenic: `variant="danger"` (red) -- CLINVAR-02
   - Likely Pathogenic: custom orange styling (NOT `variant="warning"` which is amber/yellow -- use custom CSS `.badge-lp { background-color: #fd7e14 !important; color: #fff !important; }`)
   - VUS: `variant="warning"` (amber/yellow, closest to "yellow" requirement) -- CLINVAR-02
   - Likely Benign: custom light-green styling (`.badge-lb { background-color: #20c997 !important; color: #fff !important; }`) to differentiate from Benign
   - Benign: `variant="success"` (green) -- CLINVAR-02

   Each badge: `<BBadge :aria-label="'${label}: ${count} variants'" class="py-2 px-3">` with bold label + count in parentheses. Example: **Pathogenic** (15)

6. **Classification counting logic:**
   - Count by `clinical_significance` field from gnomAD API
   - Handle case-insensitive matching
   - "Pathogenic" (not "Likely pathogenic") -> pathogenic count
   - "Likely_pathogenic" or "Likely pathogenic" -> likely_pathogenic count
   - "Uncertain_significance" or "Uncertain significance" -> vus count
   - "Likely_benign" or "Likely benign" -> likely_benign count
   - "Benign" (not "Likely benign") -> benign count
   - NOTE: gnomAD ClinVar data uses underscores (e.g., "Likely_pathogenic"). Handle BOTH underscore and space formats for robustness.

7. **Card accessibility:**
    - Card wrapper: `role="region"`, `aria-label="ClinVar variant summary"`
    - Each badge: `aria-label` with category name and count (A11Y-01)
    - Error div: `role="alert"`

**Style:** Scoped CSS for `.clinvar-card { min-height: 200px }` and custom badge colors for Likely Pathogenic (orange) and Likely Benign (teal/light-green) to achieve full 5-color ACMG spectrum.

IMPORTANT: No ClinVar review star rating. Data is from gnomAD API, not NCBI directly (CLINVAR-03). Filter out categories with 0 variants from display.
  </action>
  <verify>
Verify file exists and has ACMG color classes: `grep -c "badge" app/src/components/gene/GeneClinVarCard.vue` should be >= 5. Check aria-label: `grep -c "aria-label" app/src/components/gene/GeneClinVarCard.vue` should be >= 3.
  </verify>
  <done>
GeneClinVarCard.vue exists with: ACMG 5-class colored badges (red/orange/yellow/light-green/green) showing counts per classification, loading/error/no-data states, external link to ClinVar, screen reader accessibility. Satisfies CLINVAR-01/02/03 and A11Y-01.
  </done>
</task>

</tasks>

<verification>
1. Both component files exist in `app/src/components/gene/`
2. GeneConstraintCard has BTable with constraint metrics, SVG CI bars, pLI in pLoF row
3. GeneClinVarCard has ACMG-colored BBadge elements with counts
4. Both cards have loading spinner, error state with retry, and no-data state
5. aria-label attributes present on SVG bars and badges (A11Y-01/02)
6. No D3.js imports (user decision: pure CSS/SVG)
7. No interpretation text in constraint card (user decision)
8. `npx tsc --noEmit` passes (after Plan 01 creates types)
</verification>

<success_criteria>
- GeneConstraintCard renders gnomAD-style table with Category/Expected/Observed/Metrics columns (GNOMAD-04)
- pLI displayed in pLoF row, not prominently (GNOMAD-01, CONTEXT.md decision)
- LOEUF < 0.6 highlighted amber (GNOMAD-02/05, gnomAD v4 guideline)
- Missense Z-score shown in Missense row (GNOMAD-03)
- SVG confidence interval bars with aria-labels (A11Y-02)
- GeneClinVarCard shows 5 ACMG pathogenicity classes with correct colors (CLINVAR-01/02)
- Both cards handle loading/error/no-data independently
- No D3.js dependency used
</success_criteria>

<output>
After completion, create `.planning/phases/42-constraint-scores-variant-summaries/42-02-SUMMARY.md`
</output>
