---
phase: 42-constraint-scores-variant-summaries
plan: 03
type: execute
wave: 2
depends_on: ["42-01", "42-02"]
files_modified:
  - app/src/views/pages/GeneView.vue
autonomous: false

must_haves:
  truths:
    - "Gene page shows constraint card and ClinVar card when navigating to a gene"
    - "Cards load independently -- ClinVar card can show data while constraint card is loading/failed"
    - "Error in one card does not affect the other card"
    - "Retry button in error state triggers re-fetch"
    - "Cards render below the existing gene info table"
  artifacts:
    - path: "app/src/views/pages/GeneView.vue"
      provides: "Gene page with integrated constraint and ClinVar cards"
      contains: "GeneConstraintCard"
  key_links:
    - from: "app/src/views/pages/GeneView.vue"
      to: "app/src/composables/useGeneExternalData.ts"
      via: "import and call composable"
      pattern: "useGeneExternalData"
    - from: "app/src/views/pages/GeneView.vue"
      to: "app/src/components/gene/GeneConstraintCard.vue"
      via: "component import and template usage"
      pattern: "GeneConstraintCard"
    - from: "app/src/views/pages/GeneView.vue"
      to: "app/src/components/gene/GeneClinVarCard.vue"
      via: "component import and template usage"
      pattern: "GeneClinVarCard"
---

<objective>
Integrate the useGeneExternalData composable and both card components into GeneView.vue so the gene page displays constraint scores and ClinVar variant summaries.

Purpose: Wire everything together so users see the constraint and ClinVar cards when viewing a gene page. This is the final integration step that makes Phase 42 features visible.

Output: Updated `app/src/views/pages/GeneView.vue` with external data cards.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-constraint-scores-variant-summaries/42-CONTEXT.md
@.planning/phases/42-constraint-scores-variant-summaries/42-RESEARCH.md

Prior plan outputs (MUST read before executing):
@.planning/phases/42-constraint-scores-variant-summaries/42-01-SUMMARY.md
@.planning/phases/42-constraint-scores-variant-summaries/42-02-SUMMARY.md

Key references:
@app/src/views/pages/GeneView.vue (existing gene page -- Options API, needs composable integration)
@app/src/composables/useGeneExternalData.ts (composable from 42-01)
@app/src/components/gene/GeneConstraintCard.vue (component from 42-02)
@app/src/components/gene/GeneClinVarCard.vue (component from 42-02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate external data cards into GeneView.vue</name>
  <files>app/src/views/pages/GeneView.vue</files>
  <action>
Modify `app/src/views/pages/GeneView.vue` to add constraint and ClinVar cards.

IMPORTANT: GeneView.vue currently uses Options API (`export default { ... }`). Since Phase 41 will later refactor this to Composition API, minimize disruption here. Add the composable integration in the existing `setup()` function (which already exists and returns `makeToast` and `colorAndSymbols`).

**Changes to make:**

1. **Import the composable and components** (add to existing imports):
   ```javascript
   import { useGeneExternalData } from '@/composables/useGeneExternalData';
   import GeneConstraintCard from '@/components/gene/GeneConstraintCard.vue';
   import GeneClinVarCard from '@/components/gene/GeneClinVarCard.vue';
   ```

2. **Register components** (add to existing components object):
   ```javascript
   components: {
     TablesEntities,
     GeneBadge,
     GeneConstraintCard,
     GeneClinVarCard,
   },
   ```

3. **Add composable to setup() function:**
   ```javascript
   setup() {
     const { makeToast } = useToast();
     const colorAndSymbols = useColorAndSymbols();

     // Get gene symbol from route for external data
     const route = useRoute();
     const geneSymbol = ref(route.params.symbol as string);

     // External data composable (per-source state)
     const externalData = useGeneExternalData(geneSymbol);

     useHead({ ... }); // existing

     return {
       makeToast,
       ...colorAndSymbols,
       geneSymbol,
       externalData,
     };
   },
   ```
   Add `import { ref } from 'vue'` and `import { useRoute } from 'vue-router'` if not already imported.

4. **Add fetchData call in mounted()** (after existing loadGeneInfo):
   ```javascript
   mounted() {
     this.loadGeneInfo();
     this.externalData.fetchData();
   },
   ```

5. **Add card template** after the existing gene overview card and BEFORE the TablesEntities component:
   ```html
   <!-- External genomic data cards -->
   <BRow class="mt-3 mb-3" v-if="!loading">
     <BCol md="6" class="mb-3">
       <GeneConstraintCard
         :gene-symbol="geneSymbol"
         :loading="externalData.gnomad.loading.value"
         :error="externalData.gnomad.error.value"
         :data="externalData.gnomad.data.value"
         @retry="externalData.retry"
       />
     </BCol>
     <BCol md="6" class="mb-3">
       <GeneClinVarCard
         :gene-symbol="geneSymbol"
         :loading="externalData.clinvar.loading.value"
         :error="externalData.clinvar.error.value"
         :data="externalData.clinvar.data.value"
         @retry="externalData.retry"
       />
     </BCol>
   </BRow>
   ```

   Place this AFTER the `</BCard>` closing tag (line ~370 area, after the gene overview card) and BEFORE the `<TablesEntities>` component. Wrap in `v-if="!loading"` so cards only appear after gene data loads (prevents flash of cards before we know the gene exists).

**IMPORTANT NOTES:**
- The `.value` access on `externalData.gnomad.loading.value` etc. is needed because the composable returns raw refs, and in Options API template we need `.value` when accessing refs returned from setup()
- Test that the Options API + Composition API hybrid works: setup() returns the composable object, template accesses nested refs
- If `.value` in template causes issues with Options API, consider unwrapping in setup() return:
  ```javascript
  return {
    gnomadLoading: externalData.gnomad.loading,
    gnomadError: externalData.gnomad.error,
    gnomadData: externalData.gnomad.data,
    clinvarLoading: externalData.clinvar.loading,
    clinvarError: externalData.clinvar.error,
    clinvarData: externalData.clinvar.data,
    retryExternalData: externalData.retry,
  };
  ```
  And update template bindings accordingly. Vue 3 auto-unwraps refs returned from setup(), so `:loading="gnomadLoading"` would work without `.value`.
  </action>
  <verify>
1. Run `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty 2>&1 | head -30` to check for type errors
2. Run `cd /home/bernt-popp/development/sysndd/app && npm run build 2>&1 | tail -20` to verify Vite build succeeds
3. Verify imports: `grep "GeneConstraintCard\|GeneClinVarCard\|useGeneExternalData" app/src/views/pages/GeneView.vue`
  </verify>
  <done>
GeneView.vue imports and renders both card components, wired to useGeneExternalData composable. Cards appear below gene info, above entities table. Build succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 42: Constraint Scores and Variant Summaries cards on the gene page. The gene page now displays:
1. gnomAD constraint scores table (Synonymous/Missense/pLoF with Expected/Observed/Metrics including o/e confidence interval bars)
2. ClinVar variant summary with ACMG-colored pathogenicity badges
3. Independent loading states per card
4. Error handling with retry buttons
5. Accessibility: aria-labels on SVG bars and badges
  </what-built>
  <how-to-verify>
1. Start the dev server: `cd /home/bernt-popp/development/sysndd/app && npm run dev`
2. Navigate to a gene page (e.g., `/Genes/BRCA1` or `/Genes/SCN1A`)
3. Verify CONSTRAINT CARD:
   - Card header says "Gene Constraint (gnomAD)" with external link
   - Table shows Synonymous, Missense, pLoF rows
   - Each row has Expected SNVs, Observed SNVs, and Constraint Metrics
   - Metrics column shows Z-score, o/e ratio, and horizontal confidence interval bar
   - pLoF row shows pLI value
   - If gene is highly constrained (LOEUF < 0.6), the pLoF CI bar is amber/yellow
4. Verify CLINVAR CARD:
   - Card header says "ClinVar Variants (N)" with external link to NCBI
   - Colored badges for Pathogenic (red), Likely Pathogenic (orange), VUS (yellow), Likely Benign (light green), Benign (green)
   - Each badge shows classification text and count
5. Verify INDEPENDENT LOADING:
   - Both cards should load their data (they share the same API call, but display independently)
6. Verify ERROR HANDLING:
   - Try a non-existent gene symbol to see "No constraint data available" message
7. Verify ACCESSIBILITY:
   - Right-click an SVG CI bar > Inspect > check for aria-label with numeric values
   - Check badges have aria-label attributes
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Gene page at `/Genes/BRCA1` shows both constraint and ClinVar cards
2. Cards render below gene info card, above entities table
3. Constraint table has 3 rows (Synonymous, Missense, pLoF) with metrics
4. ClinVar badges show ACMG colors with variant counts
5. Loading spinners visible briefly during data fetch
6. App builds without errors: `npm run build`
</verification>

<success_criteria>
- Gene page displays gnomAD constraint card with pLI, LOEUF, Z-scores in table format (GNOMAD-01/02/03/04)
- Gene page displays ClinVar card with ACMG-colored badges (CLINVAR-01/02)
- Cards load independently (COMPOSE-02) and handle errors independently (COMPOSE-03)
- Screen reader accessible (A11Y-01/02)
- App builds and runs without errors
- User visually confirms the layout and data display
</success_criteria>

<output>
After completion, create `.planning/phases/42-constraint-scores-variant-summaries/42-03-SUMMARY.md`
</output>
