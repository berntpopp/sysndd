---
phase: 30-statistics-dashboard
plan: 03
type: execute
wave: 2
depends_on: [30-01, 30-02]
files_modified:
  - app/src/views/admin/AdminStatistics.vue
autonomous: true

must_haves:
  truths:
    - "Admin sees line chart of entity submissions over time"
    - "Admin sees bar chart of top 10 contributor leaderboard"
    - "Each chart includes context with trend indicators"
    - "Dashboard has card-based layout with loading spinners"
    - "Admin can toggle granularity (monthly/weekly/daily)"
    - "Admin can select custom date range"
  artifacts:
    - path: "app/src/views/admin/AdminStatistics.vue"
      provides: "Complete statistics dashboard with charts"
      min_lines: 300
  key_links:
    - from: "AdminStatistics.vue"
      to: "EntityTrendChart.vue"
      via: "import and component usage"
      pattern: "EntityTrendChart"
    - from: "AdminStatistics.vue"
      to: "ContributorBarChart.vue"
      via: "import and component usage"
      pattern: "ContributorBarChart"
    - from: "AdminStatistics.vue"
      to: "/api/statistics/entities_over_time"
      via: "axios fetch"
      pattern: "entities_over_time"
    - from: "AdminStatistics.vue"
      to: "/api/statistics/contributor_leaderboard"
      via: "axios fetch"
      pattern: "contributor_leaderboard"
---

<objective>
Modernize AdminStatistics.vue to use the new chart components with KPI cards, loading states, and granularity controls.

Purpose: Transform the basic text-based statistics page into a visual dashboard with Chart.js visualizations.
Output: Complete statistics dashboard matching all STAT-* requirements
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-statistics-dashboard/30-CONTEXT.md
@.planning/phases/30-statistics-dashboard/30-RESEARCH.md
@.planning/phases/30-statistics-dashboard/30-01-SUMMARY.md
@.planning/phases/30-statistics-dashboard/30-02-SUMMARY.md
@app/src/views/admin/AdminStatistics.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert AdminStatistics to Composition API with dashboard layout</name>
  <files>app/src/views/admin/AdminStatistics.vue</files>
  <action>
Rewrite AdminStatistics.vue with:

**Structure:**
1. KPI stat cards row at top (3-4 cards: Total Entities, New This Period, Contributors, Avg Per Day)
2. Entity Trend chart (line chart, full width)
3. Contributor Leaderboard chart (bar chart, full width)
4. Existing text statistics cards moved below charts

**Composition API conversion:**
- Use `<script setup lang="ts">` syntax
- Import useToast from existing composable
- Define reactive refs for: loading states, date range, granularity, chart data
- Use `onMounted` to fetch initial data

**State management:**
```typescript
const loading = ref({
  trend: false,
  leaderboard: false,
  stats: false
});
const granularity = ref<'month' | 'week' | 'day'>('month');
const leaderboardScope = ref<'all_time' | 'range'>('all_time');
const startDate = ref('');
const endDate = ref(new Date().toISOString().split('T')[0]);
const lastUpdated = ref<Date | null>(null);

// Chart data
const trendData = ref<Array<{ date: string; count: number }>>([]);
const leaderboardData = ref<Array<{ user_name: string; entity_count: number }>>([]);

// KPI data
const kpiStats = ref({
  totalEntities: 0,
  newThisPeriod: 0,
  totalContributors: 0,
  avgPerDay: 0,
  trendDelta: 0 // percentage change vs previous period
});
```

**API calls:**
1. `fetchTrendData()` - calls `/api/statistics/entities_over_time` with granularity param
   - Transform response: `data[0].values` array contains `{ entry_date, count, cumulative_count }`
   - Map to `{ date: entry_date, count: count }` for chart

2. `fetchLeaderboard()` - calls `/api/statistics/contributor_leaderboard` with scope and dates
   - Map response to `{ user_name: display_name, entity_count }`

3. `fetchKPIStats()` - calls existing `/updates` endpoint + calculates trend
   - Fetch current period stats
   - Fetch previous period stats (equal length)
   - Calculate delta percentage

**Layout (BContainer > BRow > BCol pattern):**
```vue
<BContainer fluid>
  <!-- Header with date controls -->
  <BRow class="mb-3">
    <BCol md="6">
      <h3>Admin Statistics</h3>
      <small v-if="lastUpdated" class="text-muted">
        Data as of {{ formatDateTime(lastUpdated) }}
        <BButton size="sm" variant="link" @click="refreshAll">
          <i class="bi bi-arrow-clockwise"></i> Refresh
        </BButton>
      </small>
    </BCol>
    <BCol md="6" class="text-end">
      <!-- Date range controls -->
      <BFormGroup label="Date Range" class="d-inline-block me-2">
        <BFormInput v-model="startDate" type="date" size="sm" />
      </BFormGroup>
      <BFormGroup label="to" class="d-inline-block me-2">
        <BFormInput v-model="endDate" type="date" size="sm" />
      </BFormGroup>
      <BButton variant="primary" size="sm" @click="fetchStatistics">
        Apply
      </BButton>
    </BCol>
  </BRow>

  <!-- KPI Cards Row -->
  <BRow class="mb-4">
    <BCol md="3" v-for="stat in kpiCards" :key="stat.label">
      <StatCard
        :label="stat.label"
        :value="stat.value"
        :delta="stat.delta"
        :context="stat.context"
      />
    </BCol>
  </BRow>

  <!-- Entity Trend Chart -->
  <BRow class="mb-4">
    <BCol>
      <BCard>
        <template #header>
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Entity Submissions Over Time</h5>
            <BFormRadioGroup
              v-model="granularity"
              :options="granularityOptions"
              button-variant="outline-primary"
              size="sm"
              buttons
              @change="fetchTrendData"
            />
          </div>
        </template>
        <EntityTrendChart
          :entity-data="trendData"
          :loading="loading.trend"
          :show-moving-average="true"
        />
      </BCard>
    </BCol>
  </BRow>

  <!-- Contributor Leaderboard -->
  <BRow class="mb-4">
    <BCol>
      <BCard>
        <template #header>
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Top Contributors</h5>
            <BFormRadioGroup
              v-model="leaderboardScope"
              :options="[
                { text: 'All Time', value: 'all_time' },
                { text: 'Date Range', value: 'range' }
              ]"
              button-variant="outline-primary"
              size="sm"
              buttons
              @change="fetchLeaderboard"
            />
          </div>
        </template>
        <ContributorBarChart
          :contributors="leaderboardData"
          :loading="loading.leaderboard"
        />
      </BCard>
    </BCol>
  </BRow>

  <!-- Existing text stats (keep for reference) -->
  <BRow v-if="statistics" class="mb-3">
    <!-- ... existing stats cards ... -->
  </BRow>
</BContainer>
```

**Imports:**
```typescript
import { ref, computed, onMounted } from 'vue';
import useToast from '@/composables/useToast';
import EntityTrendChart from './components/charts/EntityTrendChart.vue';
import ContributorBarChart from './components/charts/ContributorBarChart.vue';
import StatCard from './components/statistics/StatCard.vue';
```

**Key behaviors:**
- Initial load fetches last 12 months of data by default
- Granularity toggle refreshes trend chart only
- Leaderboard scope toggle refreshes leaderboard only
- "Apply" button refreshes all with new date range
- Loading spinners shown per-chart section
- KPI trend delta calculated as `((current - previous) / previous) * 100`
  </action>
  <verify>
1. Component renders without errors: `npm run dev` and visit /admin/statistics
2. Charts load with data from API endpoints
3. Granularity toggle updates trend chart
4. Leaderboard scope toggle switches between all-time and date range
5. KPI cards show values with trend arrows
  </verify>
  <done>
- AdminStatistics.vue converted to Composition API
- KPI stat cards row displayed at top
- EntityTrendChart integrated with granularity toggle
- ContributorBarChart integrated with scope toggle
- Loading spinners shown during data fetch
- Date range controls functional
- "Data as of" timestamp with refresh button
  </done>
</task>

<task type="auto">
  <name>Task 2: Add trend delta calculation and scientific context</name>
  <files>app/src/views/admin/AdminStatistics.vue</files>
  <action>
Enhance the KPI stats with trend calculation:

```typescript
async function calculateTrendDelta(): Promise<number> {
  // Get date range length in days
  const rangeLength = Math.abs(
    new Date(endDate.value).getTime() - new Date(startDate.value).getTime()
  ) / (1000 * 60 * 60 * 24);

  // Calculate previous period dates
  const prevEndDate = new Date(startDate.value);
  prevEndDate.setDate(prevEndDate.getDate() - 1);
  const prevStartDate = new Date(prevEndDate);
  prevStartDate.setDate(prevStartDate.getDate() - rangeLength);

  // Fetch both periods
  const [currentStats, prevStats] = await Promise.all([
    fetchUpdatesStats(startDate.value, endDate.value),
    fetchUpdatesStats(
      prevStartDate.toISOString().split('T')[0],
      prevEndDate.toISOString().split('T')[0]
    )
  ]);

  // Calculate percentage change
  if (prevStats.total_new_entities === 0) return 100; // All growth if no previous
  return Math.round(
    ((currentStats.total_new_entities - prevStats.total_new_entities) /
     prevStats.total_new_entities) * 100
  );
}
```

**KPI cards computed array:**
```typescript
const kpiCards = computed(() => [
  {
    label: 'Total Entities',
    value: kpiStats.value.totalEntities,
    context: 'Active NDD phenotype entries'
  },
  {
    label: 'New This Period',
    value: kpiStats.value.newThisPeriod,
    delta: kpiStats.value.trendDelta,
    context: 'vs previous equal period'
  },
  {
    label: 'Contributors',
    value: kpiStats.value.totalContributors,
    context: 'Users with entity submissions'
  },
  {
    label: 'Avg Per Day',
    value: kpiStats.value.avgPerDay,
    context: 'In selected date range'
  }
]);
```

**Context text for charts:**
Add descriptive text under each chart header explaining what the visualization shows:

```vue
<!-- Under Entity Trend header -->
<p class="text-muted small mb-2">
  Cumulative entity submissions showing database growth over time.
  Dashed line shows 3-month moving average for trend smoothing.
</p>

<!-- Under Leaderboard header -->
<p class="text-muted small mb-2">
  Top 10 contributors ranked by number of entity submissions.
  {{ leaderboardScope === 'all_time' ? 'All-time totals.' : 'Filtered to selected date range.' }}
</p>
```
  </action>
  <verify>
1. KPI cards show trend delta with up/down arrows
2. Chart sections include descriptive context text
3. "vs previous equal period" context is accurate
  </verify>
  <done>
- Trend delta calculated by comparing equal-length periods
- KPI cards display scientific context labels
- Charts include explanatory text below headers
- All STAT-04 requirements met (baselines, comparisons, context)
  </done>
</task>

</tasks>

<verification>
1. AdminStatistics renders with all chart components
2. API calls to `/entities_over_time` and `/contributor_leaderboard` succeed
3. Granularity toggle (month/week/day) updates trend chart
4. Leaderboard scope toggle (all-time/range) updates bar chart
5. KPI cards show values with trend arrows where applicable
6. Loading spinners appear during data fetch
7. "Data as of" timestamp updates after refresh
8. No console errors or warnings
</verification>

<success_criteria>
- STAT-01: Line chart for entities over time with 12-month default view
- STAT-02: Bar chart for top 10 contributors
- STAT-03: Charts use Chart.js via vue-chartjs (tree-shaken)
- STAT-04: Scientific context on each chart and KPI card
- STAT-05: Card-based layout with loading spinners
- User decisions: Granularity toggle, date picker, moving average, leaderboard scope toggle
</success_criteria>

<output>
After completion, create `.planning/phases/30-statistics-dashboard/30-03-SUMMARY.md`
</output>
