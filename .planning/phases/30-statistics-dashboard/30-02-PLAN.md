---
phase: 30-statistics-dashboard
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - api/endpoints/statistics_endpoints.R
autonomous: true

must_haves:
  truths:
    - "Admin can fetch contributor leaderboard data via API"
    - "Leaderboard returns top N users sorted by entity count"
    - "Endpoint supports date range filtering"
  artifacts:
    - path: "api/endpoints/statistics_endpoints.R"
      provides: "contributor_leaderboard endpoint"
      contains: "@get /contributor_leaderboard"
  key_links:
    - from: "statistics_endpoints.R"
      to: "ndd_entity table"
      via: "pool %>% tbl('ndd_entity')"
      pattern: "tbl.*ndd_entity"
---

<objective>
Add a contributor leaderboard API endpoint that returns the top N users ranked by entity submissions.

Purpose: Provide backend data for the ContributorBarChart visualization.
Output: New `/api/statistics/contributor_leaderboard` endpoint
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-statistics-dashboard/30-CONTEXT.md
@api/endpoints/statistics_endpoints.R
@api/endpoints/user_endpoints.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add contributor_leaderboard endpoint</name>
  <files>api/endpoints/statistics_endpoints.R</files>
  <action>
Add a new endpoint to `api/endpoints/statistics_endpoints.R` after the existing statistics endpoints:

```r
#* Get Contributor Leaderboard
#*
#* This endpoint retrieves the top contributors ranked by entity count.
#*
#* # `Details`
#* Aggregates entity counts per user, returning the top N contributors.
#* Supports optional date range filtering.
#*
#* # `Authorization`
#* Only Administrators can access this endpoint.
#*
#* # `Return`
#* Returns a list with 'data' containing user_name and entity_count for each contributor.
#*
#* @tag statistics
#* @serializer json list(na="string")
#* @param top Number of top contributors to return (default: 10)
#* @param start_date Optional start date for filtering (YYYY-MM-DD)
#* @param end_date Optional end date for filtering (YYYY-MM-DD)
#* @param scope Either "all_time" or "range" - determines whether to use date filtering
#* @get /contributor_leaderboard
function(req, res, top = 10, start_date = NULL, end_date = NULL, scope = "all_time") {
  require_role(req, res, "Administrator")

  # Get entity data with user info
  entity_data <- pool %>%
    tbl("ndd_entity") %>%
    select(entity_id, created_by, entry_date, is_active, ndd_phenotype) %>%
    collect() %>%
    filter(is_active == 1) %>%
    mutate(ndd_phenotype = case_when(
      ndd_phenotype == 1 ~ "Yes",
      ndd_phenotype == 0 ~ "No"
    )) %>%
    filter(ndd_phenotype == "Yes")

  # Apply date range filter if scope is "range" and dates provided
  if (scope == "range" && !is.null(start_date) && !is.null(end_date)) {
    entity_data <- entity_data %>%
      filter(entry_date >= as.Date(start_date) & entry_date <= as.Date(end_date))
  }

  # Get user table for names
  user_data <- pool %>%
    tbl("user") %>%
    select(user_id, user_name, first_name, family_name) %>%
    collect()

  # Aggregate by creator and join with user names
  leaderboard <- entity_data %>%
    group_by(created_by) %>%
    summarise(entity_count = n()) %>%
    arrange(desc(entity_count)) %>%
    head(as.integer(top)) %>%
    left_join(user_data, by = c("created_by" = "user_id")) %>%
    mutate(display_name = ifelse(
      !is.na(first_name) & !is.na(family_name),
      paste(first_name, family_name),
      user_name
    )) %>%
    select(user_id = created_by, user_name, display_name, entity_count)

  list(
    data = leaderboard,
    meta = list(
      top = as.integer(top),
      scope = scope,
      start_date = start_date,
      end_date = end_date,
      total_contributors = nrow(entity_data %>% distinct(created_by))
    )
  )
}
```

Key implementation details:
- Follows existing endpoint patterns (require_role, pool connection)
- Returns both `user_name` and `display_name` (first + last name if available)
- Supports both all-time and date-range scopes (matching CONTEXT decision for leaderboard toggle)
- Returns meta information including total contributor count
- Administrator-only access (consistent with other admin statistics endpoints)
  </action>
  <verify>
Test endpoint after API restart:
```bash
# From project root with API running
curl -s "http://localhost:8080/api/statistics/contributor_leaderboard?top=5" \
  -H "Authorization: Bearer $TOKEN" | jq '.data | length'
# Should return 5 (or fewer if less contributors exist)
```
  </verify>
  <done>
- `/api/statistics/contributor_leaderboard` endpoint exists
- Returns top N contributors with entity counts
- Supports date range filtering via scope parameter
- Returns meta with total_contributors count
  </done>
</task>

</tasks>

<verification>
1. Endpoint exists in statistics_endpoints.R with `@get /contributor_leaderboard`
2. Endpoint requires Administrator role
3. Returns data in format: `{ data: [{ user_name, display_name, entity_count }], meta: {...} }`
4. Supports `top`, `start_date`, `end_date`, `scope` parameters
</verification>

<success_criteria>
- New endpoint accessible at `/api/statistics/contributor_leaderboard`
- Returns array of top N users with entity counts
- Supports all-time and date-range scopes
- Follows existing codebase patterns for authentication and data access
</success_criteria>

<output>
After completion, create `.planning/phases/30-statistics-dashboard/30-02-SUMMARY.md`
</output>
