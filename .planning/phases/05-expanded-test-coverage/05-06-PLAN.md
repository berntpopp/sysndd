---
phase: 05-expanded-test-coverage
plan: 06
type: execute
wave: 2
depends_on: ["05-05"]
files_modified:
  - api/tests/testthat/test-unit-hpo-functions.R
  - api/tests/testthat/test-unit-genereviews-functions.R
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "HPO local ontology functions have test coverage"
    - "GeneReviews string parsing logic has test coverage"
    - "Overall coverage percentage has increased toward 70% target"
  artifacts:
    - path: "api/tests/testthat/test-unit-hpo-functions.R"
      provides: "HPO function tests using local ontologyIndex"
      min_lines: 100
    - path: "api/tests/testthat/test-unit-genereviews-functions.R"
      provides: "GeneReviews pure string manipulation tests"
      min_lines: 60
  key_links:
    - from: "api/tests/testthat/test-unit-hpo-functions.R"
      to: "api/functions/hpo-functions.R"
      via: "source() and test_that()"
      pattern: "hpo_children_from_term|hpo_all_children_from_term"
---

<objective>
Close coverage gap with HPO and GeneReviews function tests.

Purpose: Continue addressing VERIFICATION.md Gap 1 - add tests for HPO local ontology functions (which don't require network) and GeneReviews string parsing logic.

Output:
- test-unit-hpo-functions.R testing local ontology functions via ontologyIndex
- test-unit-genereviews-functions.R testing pure string manipulation patterns
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-expanded-test-coverage/05-VERIFICATION.md
@.planning/phases/05-expanded-test-coverage/05-05-SUMMARY.md

# Functions to test
@api/functions/hpo-functions.R
@api/functions/genereviews-functions.R

# Pattern from existing tests
@api/tests/testthat/test-unit-ontology-functions.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HPO function tests with local ontology</name>
  <files>
    api/tests/testthat/test-unit-hpo-functions.R
  </files>
  <action>
Test HPO functions that use local ontologyIndex (NO network calls):

**Testable functions:**
1. `hpo_children_from_term(term_input_id, hpo_input)` - lines 37-48
   - Uses ontologyIndex::get_term_property() with local ontology
   - Can mock or use a small test ontology

2. `hpo_all_children_from_term(term_input_id, hpo_input)` - lines 64-81
   - Recursive function using hpo_children_from_term()
   - Test with mock ontology to verify recursion

**Test approach:**
Create a minimal mock HPO ontology using ontologyIndex structure:
```r
# Create mock ontology with known structure
mock_hpo <- list(
  id = c("HP:0000001", "HP:0000002", "HP:0000003"),
  name = c("All", "Term2", "Term3"),
  children = list(
    "HP:0000001" = c("HP:0000002", "HP:0000003"),
    "HP:0000002" = character(0),
    "HP:0000003" = character(0)
  )
)
class(mock_hpo) <- "ontology_index"
```

**Test cases:**
- hpo_children_from_term() returns expected children for root term
- hpo_children_from_term() returns empty tibble for leaf term
- hpo_all_children_from_term() returns all descendants including self
- Result tibbles have correct column structure (term, query_date)

**Skip network functions:**
Do NOT test hpo_name_from_term(), hpo_definition_from_term(), hpo_children_count_from_term(), hpo_children_from_term_api(), hpo_all_children_from_term_api() - these call the HPO JAX API.
  </action>
  <verify>
Run `cd api && Rscript -e "testthat::test_file('tests/testthat/test-unit-hpo-functions.R')"` and verify all tests pass.
  </verify>
  <done>
    test-unit-hpo-functions.R created with tests for:
    - hpo_children_from_term() with mock ontology (4+ test cases)
    - hpo_all_children_from_term() with mock ontology (3+ test cases)
    All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GeneReviews string parsing tests</name>
  <files>
    api/tests/testthat/test-unit-genereviews-functions.R
  </files>
  <action>
Test pure string manipulation patterns used in GeneReviews functions.

**Note:** All functions in genereviews-functions.R make network calls to NCBI. However, we can test the string parsing PATTERNS used within them.

**Testable patterns (extracted logic):**

1. PMID normalization pattern (used in multiple functions):
   ```r
   str_replace_all(pmid_input, "PMID:", "")
   ```
   Test: "PMID:12345" -> "12345", "12345" -> "12345"

2. Bookshelf ID extraction pattern (from info_from_genereviews, lines 76-82):
   ```r
   str_replace("/pubmed/", "") %>% str_replace("/", "")
   ```
   Test href parsing

3. Title cleaning pattern (lines 84-90):
   ```r
   str_replace_all("title", "") %>%
   str_replace_all("\\/", "") %>%
   str_replace_all("<>", "") %>%
   str_replace_all(" -.+", "")
   ```

4. Abstract/text cleaning pattern (lines 92-97):
   ```r
   str_replace_all("<.+?>", "") %>%
   str_replace_all("\n", " ") %>%
   str_squish()
   ```

5. Date parsing and formatting (lines 132-142):
   ```r
   separate(Date, c("Day", "Month", "Year"), sep = " ")
   mutate(Month = match(Month, month.name))
   ```

**Test approach:**
Create test helpers that apply the string transformation patterns to test inputs, verifying the regex patterns work correctly.

```r
test_that("PMID normalization removes PMID: prefix", {
  expect_equal(str_replace_all("PMID:12345", "PMID:", ""), "12345")
  expect_equal(str_replace_all("12345", "PMID:", ""), "12345")
})
```
  </action>
  <verify>
Run `cd api && Rscript -e "testthat::test_file('tests/testthat/test-unit-genereviews-functions.R')"` and verify all tests pass.
  </verify>
  <done>
    test-unit-genereviews-functions.R created with tests for:
    - PMID normalization patterns
    - URL/href parsing patterns
    - Title and text cleaning patterns
    - Date parsing patterns
    All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run final coverage check and assess gap closure</name>
  <files></files>
  <action>
Run comprehensive coverage analysis:

1. Run `make test-api` to verify all tests pass
2. Run `make coverage` to get updated coverage percentage
3. Run `time make test-api` to verify still under 2 minutes

Assess gap closure:
- Compare coverage to 12.4% baseline
- Document which function files now have coverage
- Note remaining gaps and their root causes (DB/network dependencies)

If coverage is still significantly below 70%:
- Document that the remaining gap is due to functions tightly coupled to DB/network
- Note that these require integration tests with running services, outside phase scope
- Recommend this as future work or accept adjusted target

Record findings for SUMMARY.md.
  </action>
  <verify>
    `make test-api` passes all tests
    `make coverage` completes successfully
    Test suite under 2 minutes
  </verify>
  <done>
    Coverage analysis complete
    Gap closure assessment documented
    Remaining gaps identified with root causes
  </done>
</task>

</tasks>

<verification>
Final verification:
1. All new tests pass in `make test-api`
2. `make coverage` shows coverage improvement
3. Test suite still completes in under 2 minutes
4. Gap closure assessment documents what was achieved vs remaining
</verification>

<success_criteria>
1. test-unit-hpo-functions.R tests local ontology functions
2. test-unit-genereviews-functions.R tests string parsing patterns
3. Coverage has increased from baseline
4. Test suite performance maintained under 2 minutes
5. Clear documentation of what gaps remain and why
</success_criteria>

<output>
After completion, create `.planning/phases/05-expanded-test-coverage/05-06-SUMMARY.md`
</output>
