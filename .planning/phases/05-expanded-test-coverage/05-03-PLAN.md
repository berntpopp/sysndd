---
phase: 05-expanded-test-coverage
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - api/tests/testthat/test-external-hgnc.R
  - api/tests/testthat/test-external-ensembl.R
  - api/tests/testthat/test-unit-file-functions.R
  - api/tests/testthat/fixtures/api.genome.ucsc.edu/
  - api/tests/testthat/fixtures/rest.ensembl.org/
autonomous: true
user_setup: []

must_haves:
  truths:
    - "HGNC and Ensembl API functions tested with httptest2 fixtures"
    - "File utility functions tested without external dependencies"
    - "Tests skip gracefully when network unavailable and no fixtures exist"
  artifacts:
    - path: "api/tests/testthat/test-external-hgnc.R"
      provides: "HGNC API function tests"
      min_lines: 80
    - path: "api/tests/testthat/test-unit-file-functions.R"
      provides: "File utility function tests"
      min_lines: 50
  key_links:
    - from: "api/tests/testthat/test-external-hgnc.R"
      to: "api/functions/hgnc-functions.R"
      via: "source() and test_that()"
      pattern: "hgnc_id_from_symbol"
---

<objective>
Add tests for external API functions (HGNC, Ensembl) and file utility functions.

Purpose: Expand coverage for external API functions using httptest2 mocking (COV-01, leveraging Phase 3 infrastructure) and pure utility functions in file-functions.R.

Output:
- test-external-hgnc.R with HGNC API tests using httptest2 fixtures
- test-external-ensembl.R with Ensembl API tests
- test-unit-file-functions.R for file utility functions
- Recorded httptest2 fixtures for HGNC and Ensembl endpoints
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-expanded-test-coverage/05-CONTEXT.md
@.planning/phases/05-expanded-test-coverage/05-RESEARCH.md
@.planning/phases/05-expanded-test-coverage/05-01-SUMMARY.md

# Functions to test
@api/functions/hgnc-functions.R
@api/functions/ensembl-functions.R
@api/functions/file-functions.R

# Existing httptest2 infrastructure from Phase 3
@api/tests/testthat/helper-mock-apis.R
@api/tests/testthat/test-external-pubmed.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HGNC and Ensembl API tests with httptest2</name>
  <files>
    api/tests/testthat/test-external-hgnc.R
    api/tests/testthat/test-external-ensembl.R
    api/tests/testthat/fixtures/
  </files>
  <action>
First, examine the existing HGNC and Ensembl functions to understand their API calls:
```bash
cat api/functions/hgnc-functions.R
cat api/functions/ensembl-functions.R
```

Then create tests following the pattern established in test-external-pubmed.R and test-external-pubtator.R.

1. Create `api/tests/testthat/test-external-hgnc.R`:

```r
# tests/testthat/test-external-hgnc.R
# Tests for HGNC API functions using httptest2 mocking
#
# These tests use httptest2 to mock external HGNC API calls.
# Fixtures are stored in tests/testthat/fixtures/

library(testthat)
library(httptest2)
library(dplyr)
library(tibble)
library(stringr)

# Source the helper for skip logic
source(file.path(dirname(getwd()), "testthat", "helper-mock-apis.R"), local = TRUE)

# Source functions being tested
api_dir <- if (basename(getwd()) == "api") {
  getwd()
} else if (file.exists("../../functions/hgnc-functions.R")) {
  normalizePath("../..")
} else {
  stop("Cannot find api directory")
}
source(file.path(api_dir, "functions", "hgnc-functions.R"))

# =============================================================================
# hgnc_id_from_symbol() tests
# =============================================================================

test_that("hgnc_id_from_symbol returns HGNC ID for valid gene symbol", {
  skip_if_no_fixtures_or_network()

  with_mock_dir("fixtures", {
    # Test with a common gene symbol
    result <- hgnc_id_from_symbol("BRCA1")

    expect_true(!is.na(result))
    expect_true(is.numeric(result) || is.character(result))
  })
})

test_that("hgnc_id_from_symbol handles unknown symbol gracefully", {
  skip_if_no_fixtures_or_network()

  with_mock_dir("fixtures", {
    result <- hgnc_id_from_symbol("NOT_A_REAL_GENE_SYMBOL_12345")

    # Should return NA or empty for unknown symbol
    expect_true(is.na(result) || length(result) == 0)
  })
})

# =============================================================================
# hgnc_id_from_symbol_grouped() tests (if exists)
# =============================================================================

test_that("hgnc_id_from_symbol_grouped handles multiple symbols", {
  skip_if_no_fixtures_or_network()

  # This function may use vectorized calls
  # Test with a single known symbol first
  with_mock_dir("fixtures", {
    result <- tryCatch(
      hgnc_id_from_symbol_grouped("TP53"),
      error = function(e) NA
    )

    if (!is.na(result)) {
      expect_true(is.numeric(result) || is.character(result))
    }
  })
})

# =============================================================================
# Additional HGNC helper tests (pure functions)
# =============================================================================

# If there are pure utility functions in hgnc-functions.R that don't call API,
# test them directly without mocking
```

2. Create `api/tests/testthat/test-external-ensembl.R`:

```r
# tests/testthat/test-external-ensembl.R
# Tests for Ensembl API functions using httptest2 mocking

library(testthat)
library(httptest2)
library(dplyr)
library(tibble)
library(stringr)

# Source the helper for skip logic
source(file.path(dirname(getwd()), "testthat", "helper-mock-apis.R"), local = TRUE)

# Source functions being tested
api_dir <- if (basename(getwd()) == "api") {
  getwd()
} else if (file.exists("../../functions/ensembl-functions.R")) {
  normalizePath("../..")
} else {
  stop("Cannot find api directory")
}

# Ensembl functions may have additional dependencies
tryCatch({
  source(file.path(api_dir, "functions", "ensembl-functions.R"))
}, error = function(e) {
  message("Note: ensembl-functions.R requires additional dependencies: ", e$message)
})

# =============================================================================
# Ensembl API tests
# =============================================================================

test_that("Ensembl functions can be loaded", {
  # Basic test to verify functions are available
  skip_if_not(exists("ensembl-functions.R"), "Ensembl functions not loaded")

  # Add specific function tests based on what's available
  # Check api/functions/ensembl-functions.R for actual function names
})

# Note: Add more specific tests after examining ensembl-functions.R
# The exact tests depend on which functions are exported
```

3. Record fixtures if running with network access:
   - Run tests once with network to generate fixtures
   - httptest2 saves responses to fixtures/ directory
   - Subsequent runs use cached fixtures
  </action>
  <verify>
    Run the tests (they will skip if no fixtures and no network):
    ```bash
    cd api && Rscript -e "testthat::test_file('tests/testthat/test-external-hgnc.R')"
    cd api && Rscript -e "testthat::test_file('tests/testthat/test-external-ensembl.R')"
    ```
    Verify tests either pass or skip gracefully.
    Check that `make test-api` still passes with new test files.
  </verify>
  <done>
    test-external-hgnc.R created with HGNC API tests.
    test-external-ensembl.R created with Ensembl API tests.
    Tests skip gracefully when no fixtures/network.
    Fixtures directory structure ready for recorded responses.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create file utility function tests</name>
  <files>
    api/tests/testthat/test-unit-file-functions.R
  </files>
  <action>
Examine file-functions.R for pure utility functions that can be tested:
```bash
cat api/functions/file-functions.R
```

Create `api/tests/testthat/test-unit-file-functions.R`:

```r
# tests/testthat/test-unit-file-functions.R
# Unit tests for api/functions/file-functions.R
#
# These tests cover pure file utility functions that don't require
# external API calls or database access.

library(testthat)
library(stringr)
library(withr)

# Source functions being tested
api_dir <- if (basename(getwd()) == "api") {
  getwd()
} else if (file.exists("../../functions/file-functions.R")) {
  normalizePath("../..")
} else {
  stop("Cannot find api directory")
}
source(file.path(api_dir, "functions", "file-functions.R"))

# =============================================================================
# check_file_age() tests
# =============================================================================

test_that("check_file_age returns FALSE when no matching files exist", {
  withr::with_tempdir({
    result <- check_file_age("nonexistent_file", getwd(), max_age = 1)
    expect_false(result)
  })
})

test_that("check_file_age returns TRUE for recent files", {
  withr::with_tempdir({
    # Create a file with today's date
    today <- format(Sys.Date(), "%Y-%m-%d")
    filename <- paste0("test_file.", today, ".csv")
    writeLines("test", filename)

    result <- check_file_age("test_file", getwd(), max_age = 1)
    expect_true(result)
  })
})

test_that("check_file_age returns FALSE for old files", {
  withr::with_tempdir({
    # Create a file with an old date (6 months ago)
    old_date <- format(Sys.Date() - 180, "%Y-%m-%d")
    filename <- paste0("test_file.", old_date, ".csv")
    writeLines("test", filename)

    result <- check_file_age("test_file", getwd(), max_age = 1)
    expect_false(result)
  })
})

# =============================================================================
# get_newest_file() tests
# =============================================================================

test_that("get_newest_file returns the most recent file", {
  withr::with_tempdir({
    # Create multiple files with different dates
    old_date <- format(Sys.Date() - 30, "%Y-%m-%d")
    new_date <- format(Sys.Date(), "%Y-%m-%d")

    old_file <- paste0("test_file.", old_date, ".csv")
    new_file <- paste0("test_file.", new_date, ".csv")

    writeLines("old", old_file)
    writeLines("new", new_file)

    result <- get_newest_file("test_file", getwd())

    # Should return the newer file
    expect_true(grepl(new_date, result))
  })
})

test_that("get_newest_file handles single file", {
  withr::with_tempdir({
    today <- format(Sys.Date(), "%Y-%m-%d")
    filename <- paste0("single_file.", today, ".csv")
    writeLines("test", filename)

    result <- get_newest_file("single_file", getwd())

    expect_true(file.exists(result))
    expect_true(grepl("single_file", result))
  })
})

# =============================================================================
# Other file utility functions (add based on file-functions.R content)
# =============================================================================

# Add more tests based on the actual functions in file-functions.R
# Common patterns:
# - File path construction
# - Extension handling
# - Directory listing utilities
```

Adapt the tests based on the actual functions found in file-functions.R. The above are common patterns based on the function names seen in ontology-functions.R.
  </action>
  <verify>
    Run `cd api && Rscript -e "testthat::test_file('tests/testthat/test-unit-file-functions.R')"` and verify all tests pass.
    Run `make test-api` to ensure all tests pass together.
  </verify>
  <done>
    test-unit-file-functions.R created with tests for:
    - check_file_age() function (3+ tests)
    - get_newest_file() function (2+ tests)
    - Other file utility functions as applicable
    All tests pass. File functions have coverage.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Run `make test-api` - all tests pass
2. Run `make coverage` - hgnc-functions.R, ensembl-functions.R, file-functions.R show coverage
3. Tests skip gracefully without network (skip_if_no_fixtures_or_network)
4. No new test failures introduced
</verification>

<success_criteria>
1. test-external-hgnc.R and test-external-ensembl.R created with httptest2 mocking
2. test-unit-file-functions.R tests pure file utilities
3. All tests pass or skip gracefully
4. Coverage increased for external API and file functions
5. Follows existing httptest2 patterns from Phase 3
</success_criteria>

<output>
After completion, create `.planning/phases/05-expanded-test-coverage/05-03-SUMMARY.md`
</output>
