---
phase: 05-expanded-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/renv.lock
  - Makefile
  - api/tests/testthat/helper-skip.R
  - api/tests/testthat/test-unit-helper-functions.R
  - .gitignore
autonomous: true
user_setup: []

must_haves:
  truths:
    - "make coverage generates console output showing percentage"
    - "make test-api-full runs all tests including slow ones"
    - "Coverage reports stored in coverage/ directory"
    - "Helper function tests cover pagination, filtering, field selection"
  artifacts:
    - path: "Makefile"
      provides: "coverage and test-api-full targets"
      contains: "coverage:"
    - path: "api/tests/testthat/helper-skip.R"
      provides: "Slow test skip utility"
      exports: ["skip_if_not_slow_tests"]
    - path: "api/tests/testthat/test-unit-helper-functions.R"
      provides: "Expanded helper function unit tests"
      min_lines: 200
  key_links:
    - from: "Makefile"
      to: "covr::package_coverage"
      via: "Rscript invocation"
      pattern: "covr::.*coverage"
---

<objective>
Set up coverage infrastructure and expand helper function unit tests.

Purpose: Establish the foundation for coverage measurement (COV-03) and expand pure function unit tests to cover remaining testable helpers in helper-functions.R (COV-01).

Output:
- `make coverage` target generating HTML reports to `coverage/` directory
- `make test-api-full` target running slow tests (RUN_SLOW_TESTS=true)
- `helper-skip.R` with skip_if_not_slow_tests() utility
- Expanded tests for generate_filter_expressions(), select_tibble_fields(), generate_cursor_pag_inf()
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-expanded-test-coverage/05-CONTEXT.md
@.planning/phases/05-expanded-test-coverage/05-RESEARCH.md

# Existing test infrastructure
@api/tests/testthat/setup.R
@api/tests/testthat/test-unit-helper-functions.R
@api/functions/helper-functions.R
@Makefile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add covr and create coverage infrastructure</name>
  <files>
    api/renv.lock
    Makefile
    api/tests/testthat/helper-skip.R
    .gitignore
  </files>
  <action>
1. Add covr package to renv:
   ```bash
   cd api && R -e "renv::install('covr'); renv::snapshot(prompt = FALSE)"
   ```

2. Create `api/tests/testthat/helper-skip.R` with skip utility:
   ```r
   # tests/testthat/helper-skip.R
   # Utility for skipping slow tests

   #' Skip test unless RUN_SLOW_TESTS environment variable is set
   #'
   #' Use this for tests that take >5 seconds (DB operations, external APIs)
   skip_if_not_slow_tests <- function() {
     testthat::skip_if_not(
       Sys.getenv("RUN_SLOW_TESTS") == "true",
       "Slow test - set RUN_SLOW_TESTS=true to run"
     )
   }
   ```

3. Add to `.gitignore` (if not present):
   ```
   # Coverage reports
   coverage/
   ```

4. Add Makefile targets after the Testing section (~line 102):
   - Add `coverage` and `test-api-full` to .PHONY declarations
   - Add new targets:
   ```makefile
   test-api-full: check-r ## [test] Run full R API test suite including slow tests
   	@printf "$(CYAN)==> Running full R API test suite (including slow tests)...$(RESET)\n"
   	@cd /mnt/c/development/sysndd/api && RUN_SLOW_TESTS=true Rscript -e "testthat::test_dir('tests/testthat')" && \
   		printf "$(GREEN)✓ test-api-full complete$(RESET)\n" || \
   		(printf "$(RED)✗ test-api-full failed$(RESET)\n" && exit 1)

   coverage: check-r ## [test] Generate test coverage report with covr
   	@printf "$(CYAN)==> Calculating test coverage...$(RESET)\n"
   	@mkdir -p /mnt/c/development/sysndd/coverage
   	@cd /mnt/c/development/sysndd/api && Rscript -e " \
   		library(covr); \
   		cov <- file_coverage( \
   			source_files = list.files('functions', pattern = '\\\\.R$$', full.names = TRUE), \
   			test_files = list.files('tests/testthat', pattern = '^test-.*\\\\.R$$', full.names = TRUE) \
   		); \
   		pct <- percent_coverage(cov); \
   		cat('\\n========================================\\n'); \
   		cat('Overall coverage: ', round(pct, 1), '%\\n'); \
   		cat('========================================\\n\\n'); \
   		print(as.data.frame(cov)[, c('filename', 'first_line', 'value')]); \
   		if (pct < 70) { \
   			cat('\\nWARNING: Coverage ', round(pct, 1), '% below 70% threshold\\n'); \
   		}; \
   		report(cov, file = '../coverage/coverage-report.html', browse = FALSE); \
   		cat('\\nHTML report: coverage/coverage-report.html\\n'); \
   	" && printf "$(GREEN)✓ coverage complete$(RESET)\n" || \
   		(printf "$(RED)✗ coverage failed$(RESET)\n" && exit 1)
   ```

Note: Use `file_coverage()` not `package_coverage()` since the API is not an R package. This measures coverage of functions/*.R against tests/testthat/test-*.R.
  </action>
  <verify>
    Run `make coverage` and verify:
    1. Command executes without error
    2. Console output shows coverage percentage
    3. `coverage/coverage-report.html` file is created
    Run `make help` and verify new targets appear under Testing section.
  </verify>
  <done>
    `make coverage` generates console output with percentage and HTML report in coverage/ directory.
    `make test-api-full` target exists and runs with RUN_SLOW_TESTS=true.
    helper-skip.R provides skip_if_not_slow_tests() function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Expand helper function unit tests</name>
  <files>
    api/tests/testthat/test-unit-helper-functions.R
  </files>
  <action>
Add comprehensive unit tests for the remaining testable pure functions in helper-functions.R. These functions don't require database access and can be tested with mocked data.

Expand the existing test-unit-helper-functions.R to include:

1. **generate_filter_expressions()** tests:
   - Test "contains" operation: `generate_filter_expressions("contains(name,'John')")` returns valid filter expression
   - Test "equals" operation: `generate_filter_expressions("equals(status,'active')")`
   - Test "any" operation with multiple values
   - Test "and" logical operator combining filters
   - Test "or" logical operator
   - Test empty/null string returns empty string
   - Test unsupported operations throw error

2. **select_tibble_fields()** tests:
   - Test selecting specific columns from tibble
   - Test empty fields_requested returns all columns
   - Test unique_id is always included even if not requested
   - Test error thrown for non-existent columns

3. **generate_cursor_pag_inf()** tests:
   - Test pagination with page_size="all" returns all rows
   - Test pagination with numeric page_size returns correct slice
   - Test page_after cursor positions correctly
   - Test meta contains correct perPage, currentPage, totalPages
   - Test links contain prev/self/next/last

4. **generate_tibble_fspec()** tests:
   - Test generates correct field specs from tibble
   - Test filterable/selectable/multi_selectable logic based on unique values
   - Test handles fspecInput filtering

5. **generate_panel_hash() and generate_json_hash()** tests:
   - Test consistent hashing for same input
   - Test different inputs produce different hashes
   - Test HGNC prefix removal in panel hash

6. **nest_gene_tibble()** tests:
   - Test nesting groups by symbol/hgnc_id/entities_count
   - Test result has entities column as list-column

Create test fixtures as tibbles within the test file. Use `withr::local_options()` if any global state is needed.

Target: ~150-200 additional lines of tests covering these functions.
  </action>
  <verify>
    Run `cd api && Rscript -e "testthat::test_file('tests/testthat/test-unit-helper-functions.R')"` and verify:
    1. All tests pass
    2. New tests for filter expressions, pagination, field selection are included
    Run `make coverage` and verify helper-functions.R coverage has increased.
  </verify>
  <done>
    test-unit-helper-functions.R contains comprehensive tests for:
    - generate_filter_expressions() (6+ test cases)
    - select_tibble_fields() (4+ test cases)
    - generate_cursor_pag_inf() (5+ test cases)
    - generate_tibble_fspec() (3+ test cases)
    - generate_panel_hash/generate_json_hash() (3+ test cases)
    - nest_gene_tibble() (2+ test cases)
    All tests pass. helper-functions.R coverage improved.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Run `make test-api` - all existing tests still pass
2. Run `make coverage` - generates report, shows percentage
3. Run `make test-api-full` - runs including any slow tests
4. Verify `coverage/coverage-report.html` exists and is viewable
5. helper-functions.R coverage should be >50% (targeting 70%+ across all functions)
</verification>

<success_criteria>
1. `make coverage` executes successfully and reports coverage percentage
2. `make test-api-full` target available and executes with RUN_SLOW_TESTS=true
3. helper-skip.R provides skip utility following testthat conventions
4. test-unit-helper-functions.R expanded with tests for filter/pagination/field functions
5. All tests pass (existing + new)
6. Coverage infrastructure ready for subsequent plans to build upon
</success_criteria>

<output>
After completion, create `.planning/phases/05-expanded-test-coverage/05-01-SUMMARY.md`
</output>
