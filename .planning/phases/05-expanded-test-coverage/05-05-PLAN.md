---
phase: 05-expanded-test-coverage
plan: 05
type: execute
wave: 1
depends_on: ["05-04"]
files_modified:
  - api/tests/testthat/test-unit-logging-functions.R
  - api/tests/testthat/test-unit-config-functions.R
  - api/tests/testthat/test-unit-publication-functions.R
  - api/scripts/coverage.R
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Logging pure functions have test coverage"
    - "Config function has test coverage"
    - "Publication XML parsing function has test coverage"
    - "Coverage script includes all test files"
  artifacts:
    - path: "api/tests/testthat/test-unit-logging-functions.R"
      provides: "Logging function tests"
      min_lines: 80
    - path: "api/tests/testthat/test-unit-config-functions.R"
      provides: "Config function tests"
      min_lines: 40
    - path: "api/tests/testthat/test-unit-publication-functions.R"
      provides: "Publication XML parsing tests"
      min_lines: 100
  key_links:
    - from: "api/tests/testthat/test-unit-logging-functions.R"
      to: "api/functions/logging-functions.R"
      via: "source() and test_that()"
      pattern: "convert_empty|read_log_files"
    - from: "api/tests/testthat/test-unit-publication-functions.R"
      to: "api/functions/publication-functions.R"
      via: "source() and test_that()"
      pattern: "table_articles_from_xml"
---

<objective>
Close coverage gap by testing pure functions in logging, config, and publication files.

Purpose: Address VERIFICATION.md Gap 1 - coverage is 12.4%, need to increase by testing previously untested pure functions that don't require database or network.

Output:
- test-unit-logging-functions.R testing convert_empty() and read_log_files()
- test-unit-config-functions.R testing update_api_spec_examples()
- test-unit-publication-functions.R testing table_articles_from_xml()
- Updated coverage.R to include all test files in coverage measurement
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-expanded-test-coverage/05-VERIFICATION.md

# Functions to test
@api/functions/logging-functions.R
@api/functions/config-functions.R
@api/functions/publication-functions.R

# Pattern from existing tests
@api/tests/testthat/test-unit-file-functions.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create logging function tests</name>
  <files>
    api/tests/testthat/test-unit-logging-functions.R
  </files>
  <action>
Create tests for the pure functions in logging-functions.R:

1. **convert_empty()** (lines 119-125) - Simple pure function:
   - Test empty string returns "-"
   - Test non-empty string returns unchanged
   - Test whitespace handling

2. **read_log_files()** (lines 38-99) - File reading with validation:
   - Test folder validation (non-existent folder throws error)
   - Test col_names validation (empty throws, duplicates throw)
   - Test file pattern matching (no files matching throws)
   - Test successful read with temp directory containing mock log files
   - Use withr::with_tempdir() for isolated file operations

Structure following existing patterns from test-unit-file-functions.R:
- Source functions using robust path detection
- Use testthat test_that() blocks
- Clear descriptive test names
- Skip gracefully if dependencies unavailable

Do NOT test log_message_to_db() - it requires database connection.
  </action>
  <verify>
Run `cd api && Rscript -e "testthat::test_file('tests/testthat/test-unit-logging-functions.R')"` and verify all tests pass.
  </verify>
  <done>
    test-unit-logging-functions.R created with tests for:
    - convert_empty() (3+ test cases)
    - read_log_files() input validation (4+ test cases)
    - read_log_files() with mock temp files (3+ test cases)
    All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create config and publication function tests</name>
  <files>
    api/tests/testthat/test-unit-config-functions.R
    api/tests/testthat/test-unit-publication-functions.R
  </files>
  <action>
**Config function tests (config-functions.R):**

Test update_api_spec_examples() (lines 24-34):
- Test with empty spec and api_spec_json (returns unchanged)
- Test with matching paths/methods updates examples
- Test with non-matching paths skips gracefully
- Test preserves other spec properties

**Publication function tests (publication-functions.R):**

Test table_articles_from_xml() (lines 113-235):
This is a pure XML parsing function that extracts article data from PubMed XML.

Create mock XML strings representing PubMed article format:
```xml
<PubmedArticleSet>
  <PubmedArticle>
    <MedlineCitation>
      <PMID>12345678</PMID>
      <Article>
        <ArticleTitle>Test Article</ArticleTitle>
        <Abstract><AbstractText>Test abstract</AbstractText></Abstract>
        <Journal>
          <Title>Test Journal</Title>
          <ISOAbbreviation>Test J</ISOAbbreviation>
        </Journal>
        <AuthorList>
          <Author><LastName>Smith</LastName><ForeName>John</ForeName></Author>
        </AuthorList>
      </Article>
    </MedlineCitation>
    <PubmedData>
      <ArticleIdList>
        <ArticleId IdType="doi">10.1234/test</ArticleId>
      </ArticleIdList>
      <History>
        <PubMedPubDate PubStatus="pubmed">
          <Year>2024</Year><Month>1</Month><Day>15</Day>
        </PubMedPubDate>
      </History>
    </PubmedData>
  </PubmedArticle>
</PubmedArticleSet>
```

Test cases:
- Basic article parsing extracts all expected fields
- Missing DOI handling (falls back to alternatives or empty)
- Missing author handling (collective name fallback)
- Date parsing and formatting
- Keywords and MeSH terms concatenation

Note: publication-functions.R sources genereviews-functions.R and uses tidyverse. Load required packages in test setup.
  </action>
  <verify>
Run `cd api && Rscript -e "testthat::test_file('tests/testthat/test-unit-config-functions.R')"` and verify all tests pass.
Run `cd api && Rscript -e "testthat::test_file('tests/testthat/test-unit-publication-functions.R')"` and verify all tests pass.
  </verify>
  <done>
    test-unit-config-functions.R created with tests for update_api_spec_examples()
    test-unit-publication-functions.R created with tests for table_articles_from_xml()
    All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update coverage script to include all tests</name>
  <files>
    api/scripts/coverage.R
  </files>
  <action>
The coverage script currently only includes test-unit-* files (line 37-41).

Update to include ALL test files that don't require network/database:
- test-unit-*.R (existing)
- test-external-*.R (uses httptest2 mocking - should work offline)
- test-database-functions.R (tests validation, not actual DB)

Change line 37-41 from:
```r
test_files <- list.files(
  "tests/testthat",
  pattern = "^test-unit-.*\\.R$",
  full.names = TRUE
)
```

To:
```r
test_files <- list.files(
  "tests/testthat",
  pattern = "^test-(unit|external|database)-.*\\.R$",
  full.names = TRUE
)
```

Also add additional dependencies that may be needed:
- xml2 (for publication tests)
- readr (for logging tests)
- fs (for logging tests)

Run `make coverage` after update to verify improved coverage percentage.
  </action>
  <verify>
Run `make coverage` and verify:
1. More test files are included in coverage measurement
2. Coverage percentage has increased from 12.4%
3. HTML report is generated successfully
  </verify>
  <done>
    coverage.R updated to include test-external-* and test-database-* files
    Coverage percentage has increased
    All tests pass during coverage run
  </done>
</task>

</tasks>

<verification>
Final verification:
1. `make test-api` passes all tests including new ones
2. `make coverage` shows improved coverage percentage
3. New test files follow existing patterns and naming conventions
4. Test suite still completes in under 2 minutes
</verification>

<success_criteria>
1. test-unit-logging-functions.R tests convert_empty() and read_log_files()
2. test-unit-config-functions.R tests update_api_spec_examples()
3. test-unit-publication-functions.R tests table_articles_from_xml()
4. coverage.R includes more test files in measurement
5. Overall coverage has increased from 12.4%
6. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-expanded-test-coverage/05-05-SUMMARY.md`
</output>
