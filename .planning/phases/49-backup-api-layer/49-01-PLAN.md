---
phase: 49-backup-api-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - api/functions/backup-functions.R
  - api/endpoints/backup_endpoints.R
  - api/start_sysndd_api.R
autonomous: true

must_haves:
  truths:
    - "API container can read backup files from /backup directory"
    - "GET /api/backup/list returns paginated backup file list"
    - "Each backup entry includes filename, size_bytes, created_at"
    - "Backups are sorted newest-first by default"
  artifacts:
    - path: "docker-compose.yml"
      provides: "Volume mount for API container"
      contains: "mysql_backup:/backup"
    - path: "api/functions/backup-functions.R"
      provides: "Backup business logic"
      exports: ["list_backup_files"]
      min_lines: 40
    - path: "api/endpoints/backup_endpoints.R"
      provides: "Backup REST endpoints"
      exports: ["GET /list"]
      min_lines: 50
    - path: "api/start_sysndd_api.R"
      provides: "Endpoint mounting"
      contains: "pr_mount(\"/api/backup\""
  key_links:
    - from: "api/endpoints/backup_endpoints.R"
      to: "api/functions/backup-functions.R"
      via: "source or function call"
      pattern: "list_backup_files"
    - from: "api/start_sysndd_api.R"
      to: "api/endpoints/backup_endpoints.R"
      via: "pr_mount"
      pattern: "backup_endpoints.R"
---

<objective>
Create backup infrastructure and list endpoint for programmatic backup management.

Purpose: Administrators can view available backup files with metadata (size, date) via REST API. This is the foundation for the backup management feature - the list endpoint is needed before backup creation/restore endpoints.

Output: Working GET /api/backup/list endpoint returning paginated backup files with metadata. Docker volume mount enabling API container access to backups.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/49-backup-api-layer/49-CONTEXT.md
@.planning/phases/49-backup-api-layer/49-RESEARCH.md

# Reference patterns
@api/functions/job-manager.R
@api/endpoints/admin_endpoints.R
@api/start_sysndd_api.R
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add backup volume mount to API container</name>
  <files>docker-compose.yml</files>
  <action>
Add mysql_backup volume mount to the api service in docker-compose.yml.

Mount configuration:
- Volume: `mysql_backup:/backup:rw`
- Add to existing volumes list under api service
- Use :rw (read-write) since API needs to create backups

The volume `mysql_backup` already exists (used by mysql and mysql-cron-backup containers). Adding it to api allows the R code to access backup files at /backup path inside the container.
  </action>
  <verify>
Run `grep -A 20 "^  api:" docker-compose.yml | grep "mysql_backup:/backup"` to confirm volume is added.
  </verify>
  <done>
API container has mysql_backup volume mounted at /backup with read-write access.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create backup functions module</name>
  <files>api/functions/backup-functions.R</files>
  <action>
Create new file api/functions/backup-functions.R with backup business logic.

Functions to implement:

1. `list_backup_files(backup_dir = "/backup")`:
   - Use fs::dir_info() to list .sql and .sql.gz files
   - Return tibble with: filename, size_bytes, created_at (ISO 8601 UTC)
   - Include table_count as NA_integer_ (computed later per RESEARCH.md recommendation)
   - Sort by created_at descending (newest first)
   - Handle empty directory gracefully (return empty tibble)

2. `get_backup_metadata(backup_dir = "/backup")`:
   - Return summary: total count, total size in bytes
   - Used for API response meta field

Follow existing patterns from api/functions/file-functions.R for fs package usage.

Code structure:
```r
#' Backup Functions Module
#'
#' Provides backup file listing and metadata functions.
#' @name backup-functions

#' List backup files with metadata
#' @param backup_dir Character path to backup directory
#' @return Tibble with filename, size_bytes, created_at, table_count
list_backup_files <- function(backup_dir = "/backup") {
  # Implementation using fs::dir_info()
}

#' Get backup directory metadata
#' @param backup_dir Character path to backup directory
#' @return List with total_count, total_size_bytes
get_backup_metadata <- function(backup_dir = "/backup") {
  # Implementation
}
```

Important: Use basename() on file paths to return only filenames, not full paths.
  </action>
  <verify>
Run lintr on the new file: `cd /home/bernt-popp/development/sysndd && Rscript -e "lintr::lint('api/functions/backup-functions.R')"`

Confirm no lintr errors.
  </verify>
  <done>
backup-functions.R exists with list_backup_files() and get_backup_metadata() functions, passes lintr.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create backup endpoints and mount to API</name>
  <files>api/endpoints/backup_endpoints.R, api/start_sysndd_api.R</files>
  <action>
Create new file api/endpoints/backup_endpoints.R with list endpoint.

Endpoint to implement:

GET /list - List available backups
- Tag: backup
- Requires Administrator role (use require_role pattern from admin_endpoints.R)
- Query params: page (default 1), sort (default "newest", optional "oldest")
- Page size: 20 (per CONTEXT.md)
- Returns paginated response: {data: [...], total: N, page: 1, page_size: 20, meta: {...}}
- Each item in data: {filename, size_bytes, created_at, table_count}

Code structure:
```r
# api/endpoints/backup_endpoints.R
#
# Backup management API endpoints.
# Provides listing, creation, and restore of database backups.
#
# Note: All required modules (db-helpers.R, middleware.R, backup-functions.R)
# are sourced by start_sysndd_api.R before endpoints are loaded.

## -------------------------------------------------------------------##
## Backup List Endpoint
## -------------------------------------------------------------------##

#* List available backups
#*
#* Returns paginated list of backup files with metadata.
#* Requires Administrator role.
#*
#* @tag backup
#* @serializer json list(na="string")
#* @get /list
function(req, res, page = 1, sort = "newest") {
  require_role(req, res, "Administrator")
  # Implementation
}
```

Then update api/start_sysndd_api.R:
1. Add `source("functions/backup-functions.R", local = TRUE)` in section 4 (after job-manager.R)
2. Add `pr_mount("/api/backup", pr("endpoints/backup_endpoints.R"))` in section 13 (after admin endpoints)
  </action>
  <verify>
1. Run lintr: `Rscript -e "lintr::lint('api/endpoints/backup_endpoints.R')"`
2. Check mount added: `grep "api/backup" api/start_sysndd_api.R`
3. Check source added: `grep "backup-functions.R" api/start_sysndd_api.R`
  </verify>
  <done>
backup_endpoints.R exists with GET /list endpoint, mounted at /api/backup, backup-functions.R sourced at startup.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Docker configuration valid:
   - `docker compose config 2>&1 | head -20` should not show errors
   - Volume mount visible in config output

2. R code passes linting:
   - `Rscript -e "lintr::lint('api/functions/backup-functions.R')"` - no errors
   - `Rscript -e "lintr::lint('api/endpoints/backup_endpoints.R')"` - no errors

3. Integration points correct:
   - backup-functions.R sourced in start_sysndd_api.R
   - backup_endpoints.R mounted at /api/backup
</verification>

<success_criteria>
1. docker-compose.yml has mysql_backup:/backup:rw mount for api service
2. api/functions/backup-functions.R exists with list_backup_files() function
3. api/endpoints/backup_endpoints.R exists with GET /list endpoint
4. api/start_sysndd_api.R sources backup-functions.R and mounts /api/backup
5. All R code passes lintr (0 errors)
</success_criteria>

<output>
After completion, create `.planning/phases/49-backup-api-layer/49-01-SUMMARY.md`
</output>
