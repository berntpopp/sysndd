---
phase: 08-frontend-dockerfile-modernization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/Dockerfile
  - app/docker/nginx/nginx.conf
  - app/docker/nginx/local.conf
  - docker-compose.yml
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Frontend container runs as non-root user (UID 101)"
    - "Frontend container listens on port 8080 internally"
    - "Frontend build uses Node.js 20 LTS for Vue 2 compatibility"
    - "Frontend production image based on Alpine (nginx-unprivileged)"
    - "Health check responds within 5 seconds of container start"
    - "Brotli compression modules still functional"
  artifacts:
    - path: "app/Dockerfile"
      provides: "Multi-stage build with Node 20 Alpine builder and nginx-unprivileged production"
      contains: "node:20-alpine"
    - path: "app/docker/nginx/nginx.conf"
      provides: "Non-root compatible nginx configuration"
      contains: "pid /tmp/nginx.pid"
    - path: "app/docker/nginx/local.conf"
      provides: "Server block listening on non-privileged port"
      contains: "listen 8080"
    - path: "docker-compose.yml"
      provides: "Updated app service with port 8080 and wget health check"
      contains: "loadbalancer.server.port=8080"
  key_links:
    - from: "app/Dockerfile"
      to: "nginxinc/nginx-unprivileged"
      via: "FROM statement"
      pattern: "FROM nginxinc/nginx-unprivileged"
    - from: "docker-compose.yml"
      to: "app/Dockerfile"
      via: "build context and health check"
      pattern: "wget.*localhost:8080"
---

<objective>
Modernize frontend Dockerfile with Node.js 20 LTS, Alpine base, non-root nginx user, and HEALTHCHECK instruction.

Purpose: Improve security by running nginx as non-root (SEC-06), reduce image size with Alpine base (FRONT-02), upgrade Node.js for build stage (FRONT-01), and enable container health monitoring (FRONT-03).

Output: Updated app/Dockerfile with 3-stage build (Node 20 Alpine builder, brotli module builder, nginx-unprivileged production), updated nginx configs for non-root, updated docker-compose.yml with port 8080 and wget health check.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-frontend-dockerfile-modernization/08-RESEARCH.md

# Current files to modify
@app/Dockerfile
@app/docker/nginx/nginx.conf
@app/docker/nginx/local.conf
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modernize app/Dockerfile with Node 20 Alpine and nginx-unprivileged</name>
  <files>app/Dockerfile</files>
  <action>
Rewrite app/Dockerfile with 3-stage build:

**Stage 1: Builder (Vue.js build)**
- Change FROM `node:16.16.0-bullseye` to `node:20-alpine AS builder`
- IMPORTANT: Use Node.js 20 LTS (NOT 22/24) for Vue 2.7 + Vue CLI 5 + webpack 5 compatibility (see 08-RESEARCH.md)
- Remove npm upgrade step (npm 10.x bundled with Node 20)
- Use BuildKit cache mount for npm: `RUN --mount=type=cache,target=/root/.npm npm ci --no-audit --no-fund --legacy-peer-deps`
- Keep `--legacy-peer-deps` flag (required by existing package.json)
- Keep VUE_MODE build arg and `npm run build -- --mode ${VUE_MODE}`

**Stage 2: Brotli/Nonce Module Builder (KEEP EXISTING)**
- Keep existing `brotli_nonce_builder` stage unchanged - it compiles custom nginx modules
- It requires Debian-based image for build-essential and development libraries
- Uses nginx:${nginx_version} as base (NOT Alpine - needs apt-get)

**Stage 3: Production (nginx-unprivileged)**
- Change FROM `nginx:${nginx_version}` to `nginxinc/nginx-unprivileged:${nginx_version}-alpine`
- Remove timezone configuration (not needed, adds unnecessary layers)
- Copy brotli modules from brotli_nonce_builder stage with --chown=nginx:nginx
- Copy nginx configs with --chown=nginx:nginx
- Copy dist from builder with --chown=nginx:nginx
- Remove manual default.conf deletion (replaced by COPY)
- Change EXPOSE from 80 to 8080
- Add HEALTHCHECK instruction:
  ```dockerfile
  HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
      CMD wget --spider --tries=1 --no-verbose http://localhost:8080/ || exit 1
  ```
- Keep existing ENTRYPOINT
- DO NOT add USER directive - inherited from base image (nginx user, UID 101)

**ARG declarations at top:**
```dockerfile
ARG NODE_VERSION=20
ARG NGINX_VERSION=1.27.4
ARG VUE_MODE=docker
```

**Critical constraints:**
- Node.js 20 required for Vue 2.7 compatibility (OpenSSL 3.0 MD4 issue in Node 22+)
- nginxinc/nginx-unprivileged runs as nginx user (UID 101) by default
- Port must be 8080 (non-privileged port for non-root user)
- wget included in Alpine busybox (no need to install curl)
  </action>
  <verify>
Run syntax check:
```bash
cd /home/bernt-popp/development/sysndd && docker build --check ./app/
```
Verify key patterns in Dockerfile:
- `grep -q "node:20-alpine" app/Dockerfile`
- `grep -q "nginxinc/nginx-unprivileged" app/Dockerfile`
- `grep -q "EXPOSE 8080" app/Dockerfile`
- `grep -q "HEALTHCHECK" app/Dockerfile`
  </verify>
  <done>
app/Dockerfile contains:
- Stage 1: node:20-alpine with BuildKit cache mount
- Stage 2: brotli_nonce_builder unchanged (Debian-based)
- Stage 3: nginxinc/nginx-unprivileged:1.27.4-alpine with HEALTHCHECK
- EXPOSE 8080
- All COPY commands use --chown=nginx:nginx
  </done>
</task>

<task type="auto">
  <name>Task 2: Update nginx configs for non-root operation</name>
  <files>app/docker/nginx/nginx.conf, app/docker/nginx/local.conf</files>
  <action>
**Update nginx.conf for non-root compatibility:**
1. Remove `user nginx;` directive (line 1) - not supported in non-root mode, causes "user directive not supported" error
2. Change `pid /var/run/nginx.pid;` to `pid /tmp/nginx.pid;` - /var/run not writable by non-root
3. Keep all other settings unchanged (worker_processes, gzip, security headers, etc.)

**Update local.conf for non-privileged port:**
1. Change `listen 80;` to `listen 8080;`
2. Change `listen [::]:80;` to `listen [::]:8080;`
3. Keep all other settings unchanged (location blocks, try_files, error_page)

**Why these changes:**
- nginxinc/nginx-unprivileged image is pre-configured to run as UID 101 (nginx user)
- Ports below 1024 require root privileges, must use 8080
- PID file location must be writable by non-root user (/tmp)
- "user nginx;" directive conflicts with non-root operation
  </action>
  <verify>
Verify nginx configs:
```bash
cd /home/bernt-popp/development/sysndd
# nginx.conf should NOT have "user nginx;" at start
! grep -q "^user nginx;" app/docker/nginx/nginx.conf
# nginx.conf should have pid in /tmp
grep -q "pid /tmp/nginx.pid" app/docker/nginx/nginx.conf
# local.conf should listen on 8080
grep -q "listen 8080;" app/docker/nginx/local.conf
grep -q "listen \[::\]:8080;" app/docker/nginx/local.conf
```
  </verify>
  <done>
nginx.conf: No "user nginx;" directive, pid file at /tmp/nginx.pid
local.conf: Listens on port 8080 for both IPv4 and IPv6
  </done>
</task>

<task type="auto">
  <name>Task 3: Update docker-compose.yml for non-root app service</name>
  <files>docker-compose.yml</files>
  <action>
Update app service in docker-compose.yml:

1. **Update health check command** - change from curl to wget (available in Alpine):
   ```yaml
   healthcheck:
     test: ["CMD", "wget", "--spider", "--tries=1", "--no-verbose", "http://localhost:8080/"]
     interval: 30s
     timeout: 5s
     retries: 3
     start_period: 10s
   ```

2. **Update Traefik label for container port** - Traefik routes to container port:
   ```yaml
   - "traefik.http.services.app.loadbalancer.server.port=8080"
   ```

**Why these changes:**
- Container now runs nginx on port 8080 (non-privileged)
- curl not available in Alpine minimal images, wget is bundled with busybox
- Traefik needs to route to the correct container port (8080 instead of 80)
- start_period reduced to 10s (nginx starts faster than R/plumber)

**Keep unchanged:**
- build context (./app/)
- container_name, restart, networks
- Traefik router labels (rule, entrypoints, priority)
- resource limits
  </action>
  <verify>
Verify docker-compose.yml:
```bash
cd /home/bernt-popp/development/sysndd
# Health check uses wget and port 8080
grep -A5 "healthcheck:" docker-compose.yml | grep -q "wget.*8080"
# Traefik label has port 8080
grep -q "loadbalancer.server.port=8080" docker-compose.yml
# Validate compose syntax
docker compose config --quiet
```
  </verify>
  <done>
docker-compose.yml app service:
- Health check uses wget with port 8080
- Traefik label routes to container port 8080
- Compose config validates without errors
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify the complete implementation:

1. **Build test** - Build the app image (validates Dockerfile syntax and stages):
```bash
cd /home/bernt-popp/development/sysndd
DOCKER_BUILDKIT=1 docker build -t sysndd-app-test ./app/
```

2. **Image inspection** - Verify Alpine base and non-root user:
```bash
# Check final stage base image
docker inspect sysndd-app-test --format '{{.Config.User}}' | grep -v root
# Check exposed port
docker inspect sysndd-app-test --format '{{json .Config.ExposedPorts}}' | grep -q "8080"
# Check health check configured
docker inspect sysndd-app-test --format '{{json .Config.Healthcheck}}' | grep -q "wget"
```

3. **Container run test** - Start container and verify health:
```bash
# Run container briefly
docker run -d --name app-test -p 8888:8080 sysndd-app-test
sleep 5
# Verify responds on port 8080
curl -sf http://localhost:8888/ > /dev/null && echo "Health check passed"
# Check process not running as root
docker exec app-test id | grep -v "uid=0"
# Cleanup
docker stop app-test && docker rm app-test
docker rmi sysndd-app-test
```

4. **Compose validation**:
```bash
docker compose config --quiet && echo "Compose config valid"
```
</verification>

<success_criteria>
Phase 8 requirements complete when:
1. [FRONT-01] Frontend build uses Node.js 20 LTS - verified by `grep "node:20-alpine" app/Dockerfile`
2. [FRONT-02] Final image based on nginx Alpine - verified by `grep "nginx-unprivileged.*alpine" app/Dockerfile`
3. [SEC-06] App runs as non-root (UID 101) - verified by `docker exec app-test id` showing nginx user
4. [FRONT-03] HEALTHCHECK instruction present - verified by `docker inspect` showing health check config
5. Brotli modules functional - verified by successful build (stage 2 compiles modules)
6. Container listens on port 8080 - verified by curl test to mapped port
</success_criteria>

<output>
After completion, create `.planning/phases/08-frontend-dockerfile-modernization/08-01-SUMMARY.md`
</output>
