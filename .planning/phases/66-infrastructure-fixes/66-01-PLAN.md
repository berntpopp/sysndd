---
phase: 66-infrastructure-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/Dockerfile
  - docker-compose.yml
  - app/public/brain-neurodevelopmental-disorders-sysndd.png
autonomous: true

must_haves:
  truths:
    - "API container can write to bind-mounted /app/data directory without permission errors"
    - "Dockerfile UID is configurable via ARG with default 1000"
    - "docker compose --scale api=4 succeeds without container naming conflict"
    - "Favicon image loads without 404 errors in browser"
  artifacts:
    - path: "api/Dockerfile"
      provides: "ARG-based UID/GID configuration"
      contains: "ARG UID=1000"
    - path: "docker-compose.yml"
      provides: "API service without container_name"
      min_lines: 200
    - path: "app/public/brain-neurodevelopmental-disorders-sysndd.png"
      provides: "Favicon image file"
  key_links:
    - from: "api/Dockerfile"
      to: "container filesystem"
      via: "useradd -u ${UID}"
      pattern: "useradd -u \\$\\{UID\\}"
    - from: "docker-compose.yml"
      to: "horizontal scaling"
      via: "no container_name on api service"
      pattern: "api:\\s*\\n\\s*build:"
---

<objective>
Fix API container infrastructure for horizontal scaling on production VPS.

Purpose: Enable multi-container deployments by fixing UID mismatch (containers can't write to host directories), removing container naming conflicts that block scaling, and restoring the missing favicon image.

Output: Updated Dockerfile with configurable UID, docker-compose.yml without API container_name, favicon image copied to public root.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/66-infrastructure-fixes/66-RESEARCH.md
@api/Dockerfile
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ARG-based UID/GID to API Dockerfile</name>
  <files>api/Dockerfile</files>
  <action>
Modify the production stage (Stage 3) of api/Dockerfile to use ARG-based UID/GID instead of hardcoded 1001.

Current code at lines 160-162:
```dockerfile
# Create non-root user with specific UID/GID for security
RUN groupadd -g 1001 api && \
    useradd -u 1001 -g api -m -s /bin/bash apiuser
```

Replace with:
```dockerfile
# Build-time UID/GID configuration for host bind mount compatibility
# Default 1000 matches most Linux host users; override with --build-arg UID=1001
ARG UID=1000
ARG GID=1000

# Create non-root user with configurable UID/GID for security
RUN groupadd -g ${GID} api && \
    useradd -u ${UID} -g api -m -s /bin/bash apiuser
```

Also update the comment at line 12 to reflect the new UID:
```dockerfile
# - Non-root user (default uid 1000, configurable via --build-arg)
```
  </action>
  <verify>
Run `grep -E "ARG (UID|GID)=1000|useradd -u \\\${UID}" api/Dockerfile` returns matches for both ARG declarations and the templated useradd command.
  </verify>
  <done>
Dockerfile uses ARG UID=1000 and ARG GID=1000 with ${UID} and ${GID} in the useradd/groupadd commands. Default is 1000, overridable via --build-arg.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove container_name from API service in docker-compose.yml</name>
  <files>docker-compose.yml</files>
  <action>
Remove the `container_name: sysndd_api` line from the api service in docker-compose.yml.

Current line 124:
```yaml
  api:
    build: ./api/
    container_name: sysndd_api  # Remove this line
    restart: unless-stopped
```

After change:
```yaml
  api:
    build: ./api/
    restart: unless-stopped
```

Keep `container_name` on singleton services (traefik, mysql, mysql-cron-backup, app) - only remove from api service to enable horizontal scaling with `docker compose --scale api=4`.
  </action>
  <verify>
Run `grep -n "container_name.*api" docker-compose.yml` returns no matches. Run `grep -c "container_name" docker-compose.yml` should return 4 (traefik, mysql, mysql_backup, app remain).
  </verify>
  <done>
API service no longer has container_name directive. Other services (traefik, mysql, mysql-cron-backup, app) retain their container names for singleton operation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Copy favicon image from _old directory to public root</name>
  <files>app/public/brain-neurodevelopmental-disorders-sysndd.png</files>
  <action>
Copy the favicon image from `app/public/_old/brain-neurodevelopmental-disorders-sysndd.png` to `app/public/brain-neurodevelopmental-disorders-sysndd.png`.

The index.html already references this file at line 9:
```html
<link rel="icon" type="image/png" href="<%= BASE_URL %>brain-neurodevelopmental-disorders-sysndd.png">
```

The file exists in `app/public/_old/` (13861 bytes, PNG format) but is missing from the public root, causing 404 errors.

Run:
```bash
cp app/public/_old/brain-neurodevelopmental-disorders-sysndd.png app/public/brain-neurodevelopmental-disorders-sysndd.png
```

Verify the file was copied:
```bash
ls -la app/public/brain-neurodevelopmental-disorders-sysndd.png
```
  </action>
  <verify>
Run `ls -la app/public/brain-neurodevelopmental-disorders-sysndd.png` shows file exists with size ~13861 bytes.
  </verify>
  <done>
Favicon image exists at `app/public/brain-neurodevelopmental-disorders-sysndd.png` and will load without 404 errors when the app is built and served.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Dockerfile UID verification:**
   ```bash
   grep -E "ARG (UID|GID)=1000" api/Dockerfile
   grep "useradd -u \${UID}" api/Dockerfile
   ```

2. **Docker Compose scaling verification:**
   ```bash
   grep -c "container_name" docker-compose.yml  # Should be 4 (not 5)
   grep -v "container_name" docker-compose.yml | grep -A2 "api:"  # No container_name on api
   ```

3. **Favicon verification:**
   ```bash
   ls -la app/public/brain-neurodevelopmental-disorders-sysndd.png  # File exists
   file app/public/brain-neurodevelopmental-disorders-sysndd.png     # PNG image
   ```

4. **Build verification (optional but recommended):**
   ```bash
   docker build --build-arg UID=1000 --build-arg GID=1000 -t sysndd-api:test api/
   docker run --rm sysndd-api:test id apiuser  # Should show uid=1000(apiuser) gid=1000(api)
   ```
</verification>

<success_criteria>
1. `api/Dockerfile` contains `ARG UID=1000` and `ARG GID=1000` with templated useradd/groupadd
2. `docker-compose.yml` API service has no `container_name` directive
3. `app/public/brain-neurodevelopmental-disorders-sysndd.png` file exists (copied from _old)
4. All file changes committed with appropriate message
</success_criteria>

<output>
After completion, create `.planning/phases/66-infrastructure-fixes/66-01-SUMMARY.md`
</output>
