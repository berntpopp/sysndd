---
phase: 57-pubtator-improvements
plan: 02
type: execute
wave: 2
depends_on: ["57-01"]
files_modified:
  - app/src/components/analyses/PubtatorNDDGenes.vue
  - app/src/views/analyses/PubtatorNDD.vue
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Curator can see novel gene badge showing count of genes not in SysNDD"
    - "Curator can filter genes by publication count (2+, 5+, 10+)"
    - "Curator can filter genes by date range (last 1/2/5 years)"
    - "User can see PMIDs as clickable chips in gene row"
    - "User can expand gene row to see publication details"
    - "Curator can export filtered gene list to Excel"
  artifacts:
    - path: "app/src/components/analyses/PubtatorNDDGenes.vue"
      provides: "Enhanced genes table with prioritization, filtering, and export"
      contains: "is_novel"
    - path: "app/src/views/analyses/PubtatorNDD.vue"
      provides: "Parent view with novel gene count badge on Genes tab"
      contains: "novelGeneCount"
  key_links:
    - from: "app/src/components/analyses/PubtatorNDDGenes.vue"
      to: "/api/publication/pubtator/genes"
      via: "axios GET with filter params"
      pattern: "publication/pubtator/genes"
    - from: "app/src/components/analyses/PubtatorNDDGenes.vue"
      to: "useExcelExport"
      via: "composable import and exportToExcel call"
      pattern: "useExcelExport"
    - from: "app/src/components/analyses/PubtatorNDDGenes.vue"
      to: "app/src/views/analyses/PubtatorNDD.vue"
      via: "emit('novel-count', count)"
      pattern: "@novel-count"
---

<objective>
Enhance the PubtatorNDDGenes component with gene prioritization features, filtering, expandable publication details, and Excel export for curator workflow.

Purpose: PUBT-02 requires gene prioritization display. PUBT-03 requires novel gene highlighting. PUBT-04 requires gene-literature exploration. PUBT-05 requires Excel export. PUBT-06 requires documentation.

Output:
- Enhanced Genes table with novel badge, filtering, expandable details
- Novel gene count badge on Genes tab
- Excel export for filtered gene list
- Complete help documentation

**PUBT-06 Documentation Coverage (this plan):**
- [ ] Stats help badge - completed in Plan 01, Task 1
- [x] Genes help badge (Task 1) - explains gene prioritization, filtering, export
- [x] Parent view help badge (Task 2) - explains overall Pubtator analysis feature
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-pubtator-improvements/57-CONTEXT.md
@.planning/phases/57-pubtator-improvements/57-RESEARCH.md
@.planning/phases/57-pubtator-improvements/57-01-SUMMARY.md

# Key source files
@app/src/components/analyses/PubtatorNDDGenes.vue
@app/src/views/analyses/PubtatorNDD.vue
@app/src/composables/useExcelExport.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance PubtatorNDDGenes with Prioritization and Filtering</name>
  <files>app/src/components/analyses/PubtatorNDDGenes.vue</files>
  <action>
Modernize and enhance PubtatorNDDGenes.vue component.

**Executor guidance:** This task has 10 action steps covering multiple features. Complete steps sequentially and verify each feature works before proceeding. If context pressure builds or quality degrades, pause and report partial completion - remaining steps can continue in a follow-up execution.

1. **Convert to Composition API** (`<script setup lang="ts">`):
   - Import composables: useToast, useUrlParsing, useTableData, useExcelExport
   - Define props with defineProps
   - Define emits with defineEmits: `const emit = defineEmits<{ 'novel-count': [count: number] }>()`

2. **Add new fields to table columns**:
   ```typescript
   const fields = [
     { key: 'gene_symbol', label: 'Gene', sortable: true, filterable: true },
     { key: 'gene_name', label: 'Name', sortable: true, filterable: true },
     { key: 'publication_count', label: 'Pubs', sortable: true },
     { key: 'oldest_pub_date', label: 'Oldest Pub', sortable: true },
     { key: 'is_novel', label: 'Novel', sortable: true },
     { key: 'pmids', label: 'PMIDs', sortable: false },
     { key: 'actions', label: '', sortable: false },
   ];
   ```

3. **Add prioritization filters** in the controls row:
   - Publication count filter (BFormSelect): "All", "2+", "5+", "10+"
   - Date range filter (BFormSelect): "All time", "Last 1 year", "Last 2 years", "Last 5 years"
   - These filters modify the API filter string

4. **Render is_novel column** with badge:
   ```vue
   <template #cell-is_novel="{ row }">
     <BBadge v-if="row.is_novel === 1" variant="warning" pill>
       <i class="bi bi-star-fill me-1" />
       Novel
     </BBadge>
     <BBadge v-else variant="success" pill>
       In SysNDD
     </BBadge>
   </template>
   ```

5. **Render PMIDs as clickable chips** (max 5 shown):
   ```vue
   <template #cell-pmids="{ row }">
     <div class="d-flex flex-wrap gap-1">
       <BButton
         v-for="pmid in parsePmids(row.pmids).slice(0, 5)"
         :key="pmid"
         size="sm"
         variant="outline-primary"
         class="btn-xs"
         :href="'https://pubmed.ncbi.nlm.nih.gov/' + pmid"
         target="_blank"
       >
         {{ pmid }}
       </BButton>
       <BBadge v-if="parsePmids(row.pmids).length > 5" variant="secondary" pill>
         +{{ parsePmids(row.pmids).length - 5 }}
       </BBadge>
     </div>
   </template>
   ```

   Add helper: `const parsePmids = (pmids: string) => pmids ? pmids.split(',') : [];`

6. **Add row expansion** for publication details:
   - Add `details` slot to show all PMIDs with titles when expanded
   - Use BCollapse or details-row pattern from GenericTable

7. **Emit novel gene count** after data loads:
   ```typescript
   const novelCount = computed(() =>
     items.value.filter(g => g.is_novel === 1).length
   );
   watch(novelCount, (count) => emit('novel-count', count), { immediate: true });
   ```

8. **Add Excel export button** in header controls:
   ```vue
   <BButton
     variant="outline-success"
     size="sm"
     :disabled="isExporting"
     @click="handleExcelExport"
   >
     <BSpinner v-if="isExporting" small class="me-1" />
     <i v-else class="bi bi-file-earmark-excel me-1" />
     Export
   </BButton>
   ```

9. **Implement handleExcelExport function**:
   ```typescript
   const handleExcelExport = async () => {
     const exportData = items.value.map(gene => ({
       gene_symbol: gene.gene_symbol,
       gene_name: gene.gene_name,
       publication_count: gene.publication_count,
       oldest_pub_date: gene.oldest_pub_date,
       in_sysndd: gene.is_novel ? 'No' : 'Yes',
       pmids: gene.pmids || ''
     }));

     await exportToExcel(exportData, {
       filename: `pubtator_genes_${new Date().toISOString().split('T')[0]}`,
       sheetName: 'Gene Prioritization',
       headers: {
         gene_symbol: 'Gene Symbol',
         gene_name: 'Gene Name',
         publication_count: 'Publication Count',
         oldest_pub_date: 'Oldest Publication',
         in_sysndd: 'In SysNDD',
         pmids: 'PMIDs'
       }
     });
   };
   ```

10. **Add help badge with popover** (PUBT-06) in header:
    - Explain gene prioritization criteria
    - Explain what "Novel" means (coverage gap)
    - Explain filtering options
    - Explain export functionality
  </action>
  <verify>
    - Navigate to /analyses/pubtator/genes
    - Novel genes show warning badge, SysNDD genes show success badge
    - Filter dropdowns work (2+, 5+, 10+ publications)
    - PMIDs render as clickable chips
    - Export button downloads Excel file
    - Help badge shows popover with documentation
  </verify>
  <done>Genes table shows prioritization with novel badges, filtering, PMID chips, and Excel export</done>
</task>

<task type="auto">
  <name>Task 2: Add Novel Gene Count Badge to Parent View</name>
  <files>app/src/views/analyses/PubtatorNDD.vue</files>
  <action>
Update PubtatorNDD.vue to show novel gene count badge on Genes tab.

**Important:** Use emit pattern (NOT provide/inject) for consistency with must_haves.key_links.

1. **Convert to Composition API** (`<script setup lang="ts">`):
   - Current component uses Options API with just a name
   - Add reactive state for novelGeneCount

2. **Add novel count state**:
   ```typescript
   const novelGeneCount = ref<number>(0);

   const handleNovelCount = (count: number) => {
     novelGeneCount.value = count;
   };
   ```

3. **Update Genes tab** to show badge:
   ```vue
   <BNavItem :to="{ name: 'PubtatorNDDGenes' }" exact exact-active-class="active">
     Genes
     <BBadge
       v-if="novelGeneCount > 0"
       variant="warning"
       pill
       class="ms-1"
     >
       {{ novelGeneCount }} novel
     </BBadge>
   </BNavItem>
   ```

4. **Listen for emit from child component**:
   - Since router-view renders the child, use the @novel-count event on router-view:
   ```vue
   <router-view @novel-count="handleNovelCount" />
   ```

   This works because Vue router-view passes through events from rendered components.

5. **Add header documentation** (PUBT-06):
   - Add explanatory text above the card
   - Add help badge explaining the overall Pubtator analysis feature
   ```vue
   <h6 class="mb-3 text-start">
     Exploring gene-literature connections from
     <mark v-b-tooltip.hover title="NCBI's biomedical text mining service">PubTator</mark>
     for neurodevelopmental disorders.
     <BBadge id="popover-badge-help-pubtator" pill href="#" variant="info">
       <i class="bi bi-question-circle-fill" />
     </BBadge>
     <BPopover target="popover-badge-help-pubtator" variant="info" triggers="focus">
       <template #title>About PubTator Analysis</template>
       <p>PubTator is NCBI's text mining system that identifies biomedical concepts
       (genes, diseases, chemicals) in scientific literature.</p>
       <p>This analysis searches for NDD-related publications and tracks which genes
       are mentioned. Use it to:</p>
       <ul class="mb-0">
         <li><strong>Table:</strong> Browse cached publications</li>
         <li><strong>Genes:</strong> Find genes for curation (prioritized by coverage gap)</li>
         <li><strong>Stats:</strong> View publication distribution</li>
       </ul>
     </BPopover>
   </h6>
   ```
  </action>
  <verify>
    - Navigate to /analyses/pubtator
    - Genes tab shows "(X novel)" badge when novel genes exist
    - Help badge above card explains Pubtator concept
    - Badge count updates when navigating to Genes tab
  </verify>
  <done>Parent view shows novel gene count badge on Genes tab and has comprehensive documentation</done>
</task>

<task type="auto">
  <name>Task 3: Add Stat Card for Novel Genes in Stats View</name>
  <files>app/src/components/analyses/PubtatorNDDStats.vue</files>
  <action>
Enhance the Stats view to include a novel gene summary card (per CONTEXT.md decision):

1. **Add stats cards section** above the bar chart:
   ```vue
   <BRow class="mb-3">
     <BCol md="4">
       <BCard class="text-center h-100" border-variant="primary">
         <BCardTitle class="text-primary">{{ totalGenes }}</BCardTitle>
         <BCardText>Total Genes</BCardText>
       </BCard>
     </BCol>
     <BCol md="4">
       <BCard class="text-center h-100" border-variant="warning">
         <BCardTitle class="text-warning">{{ novelGenes }}</BCardTitle>
         <BCardText>Novel Genes (not in SysNDD)</BCardText>
       </BCard>
     </BCol>
     <BCol md="4">
       <BCard class="text-center h-100" border-variant="success">
         <BCardTitle class="text-success">{{ inSysnddGenes }}</BCardTitle>
         <BCardText>Genes in SysNDD</BCardText>
       </BCard>
     </BCol>
   </BRow>
   ```

2. **Compute stats from API response**:
   ```typescript
   const totalGenes = computed(() => statsData.value.length);
   const novelGenes = computed(() => statsData.value.filter(g => g.is_novel === 1).length);
   const inSysnddGenes = computed(() => statsData.value.filter(g => g.is_novel === 0).length);
   ```

3. **Fetch more data** for accurate counts:
   - Change page_size to get all genes or use meta.totalItems
   - Or add a separate lightweight count endpoint

4. **Add loading state** for stats cards while data fetches

This gives curators a quick overview of the coverage gap before diving into the detailed gene list.
  </action>
  <verify>
    - Navigate to /analyses/pubtator/stats
    - Three stat cards display: Total Genes, Novel Genes, Genes in SysNDD
    - Cards update when data loads
    - Bar chart still renders correctly below cards
  </verify>
  <done>Stats view shows summary cards with novel gene count alongside bar chart</done>
</task>

</tasks>

<verification>
1. Gene prioritization test:
   - Visit /analyses/pubtator/genes
   - Novel genes (is_novel=1) have warning badge
   - SysNDD genes (is_novel=0) have success badge
   - Genes sorted by coverage gap then oldest date

2. Filtering test:
   - Select "5+" from publication count filter
   - Only genes with 5+ publications shown
   - Select "Last 2 years" from date filter
   - Only genes with recent publications shown
   - Filters combine correctly

3. PMID chips test:
   - PMIDs render as clickable buttons
   - Clicking opens PubMed in new tab
   - "+N more" badge shows for genes with >5 PMIDs

4. Excel export test:
   - Apply some filters
   - Click Export button
   - Excel file downloads
   - File contains only filtered genes
   - Columns match expected format

5. Novel count badge test:
   - Navigate to /analyses/pubtator
   - Genes tab shows "(X novel)" badge
   - Count matches actual novel genes

6. Stats cards test:
   - Visit /analyses/pubtator/stats
   - Three cards show Total, Novel, In SysNDD counts
   - Counts are accurate
</verification>

<success_criteria>
1. Genes table shows novel gene badges with clear visual distinction (PUBT-03)
2. Curator can filter by publication count and date range (PUBT-02)
3. User can click PMIDs to explore gene-literature connections (PUBT-04)
4. Curator can export filtered gene list to Excel (PUBT-05)
5. Help documentation explains Pubtator concept and features (PUBT-06 - Genes and Parent views)
6. Novel gene count badge visible on Genes tab
7. Stats view includes summary cards with novel gene count
</success_criteria>

<output>
After completion, create `.planning/phases/57-pubtator-improvements/57-02-SUMMARY.md`
</output>

<post_execution_enhancements>
## Post-Plan Styling Refinements (2026-01-31)

After initial plan completion, the following styling enhancements were made to match PublicationsNDD design:

1. **Show/Hide button alignment** (PubtatorNDDGenes.vue):
   - Changed variant from `outline-secondary` to `outline-primary` (blue color)
   - Changed from `size="sm"` to `class="btn-xs"` to match GenericTable button size
   - Button now matches PublicationsNDDTable's Details column styling

2. **Details title left-alignment** (PubtatorNDDGenes.vue):
   - Added `text-align: left;` to `.details-title` CSS class
   - Publication titles in expanded rows are now left-aligned matching PublicationsNDD

3. **Row expansion content styling**:
   - Updated template structure to match PublicationsNDD pattern
   - Changed from chevron icons to "Show"/"Hide" text labels
   - Improved PMID, date, and journal badge styling

**Commit:** `style(pubtator): match Show/Hide button to PublicationsNDD styling`
</post_execution_enhancements>
