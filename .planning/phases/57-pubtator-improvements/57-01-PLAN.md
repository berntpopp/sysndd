---
phase: 57-pubtator-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/components/analyses/PubtatorNDDStats.vue
  - api/endpoints/publication_endpoints.R
  - app/src/views/admin/ManageAnnotations.vue
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Stats page renders without errors"
    - "Stats page fetches data from correct API endpoint"
    - "API returns is_novel and oldest_pub_date fields for each gene"
    - "API returns pmids field as comma-separated string for each gene"
    - "Admin can trigger Pubtator cache update from ManageAnnotations"
    - "Admin can see Pubtator stats (last update, publication count, gene count)"
  artifacts:
    - path: "app/src/components/analyses/PubtatorNDDStats.vue"
      provides: "Fixed stats visualization using correct API endpoint"
      contains: "/api/publication/pubtator/genes"
    - path: "api/endpoints/publication_endpoints.R"
      provides: "Enhanced genes endpoint with prioritization fields"
      contains: "is_novel"
    - path: "app/src/views/admin/ManageAnnotations.vue"
      provides: "Pubtator admin section with update trigger and stats"
      contains: "pubtator"
  key_links:
    - from: "app/src/components/analyses/PubtatorNDDStats.vue"
      to: "/api/publication/pubtator/genes"
      via: "axios GET request in fetchStats()"
      pattern: "publication/pubtator/genes"
    - from: "app/src/views/admin/ManageAnnotations.vue"
      to: "/api/admin/pubtator"
      via: "axios calls for update trigger and stats"
      pattern: "pubtator"
---

<objective>
Fix the broken PubtatorNDD Stats page and extend the backend API to support gene prioritization features. Also add admin infrastructure for Pubtator data management.

Purpose: PUBT-01 requires fixing the Stats page which currently calls a non-existent endpoint. PUBT-02/03 require API changes to return prioritization data (is_novel, oldest_pub_date, pmids). Admin infrastructure enables curators to trigger updates and monitor cache status.

Output:
- Working Stats page that renders D3 visualizations
- Enhanced /publication/pubtator/genes endpoint with prioritization fields
- Admin panel section for Pubtator management

**PUBT-06 Documentation Coverage (this plan):**
- [x] Stats help badge (Task 1) - explains Pubtator concept and stats visualization
- [ ] Genes help badge - deferred to Plan 02, Task 1
- [ ] Parent view help badge - deferred to Plan 02, Task 2
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-pubtator-improvements/57-CONTEXT.md
@.planning/phases/57-pubtator-improvements/57-RESEARCH.md

# Key source files
@app/src/components/analyses/PubtatorNDDStats.vue
@api/endpoints/publication_endpoints.R
@app/src/views/admin/ManageAnnotations.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Stats Page API Call and Add Documentation</name>
  <files>app/src/components/analyses/PubtatorNDDStats.vue</files>
  <action>
Fix the PubtatorNDDStats.vue component:

1. **Fix API endpoint** (line ~118): Change from `/api/pubtator` to `/api/publication/pubtator/genes`
   - The current endpoint doesn't exist; this is the root cause of the Stats page failure
   - Update the URL construction to match the genes endpoint pattern

2. **Update data processing** in `processStatsData()`:
   - The genes endpoint returns different structure than expected
   - Parse `publication_count` field directly (already aggregated by gene)
   - For gene category: use `gene_symbol` and `publication_count`
   - For publication category: group by publication_count value (histogram)

3. **Add help badge with popover** following CurationComparisons pattern (PUBT-06):
   - Add BBadge with `id="popover-badge-help-pubtator-stats"` after the title
   - Add BPopover explaining what Pubtator is and how the stats work
   - Content should explain: "PubTator is NCBI's text mining service that identifies genes mentioned in biomedical literature. These statistics show the distribution of NDD-related publications per gene from our cached PubTator searches."

4. **Convert to Composition API** (script setup):
   - Current component uses Options API
   - Convert to `<script setup lang="ts">` for consistency with other modern components
   - Use composables: useToast

Do NOT change the D3 visualization logic itself - it works correctly once data is provided.
  </action>
  <verify>
    - Navigate to /analyses/pubtator/stats
    - Stats page loads without console errors
    - Bar chart displays gene publication counts
    - Help badge shows popover on click
  </verify>
  <done>Stats page displays D3 bar chart with data from /api/publication/pubtator/genes endpoint, help badge explains Pubtator concept</done>
</task>

<task type="auto">
  <name>Task 2: Enhance Genes API Endpoint for Prioritization</name>
  <files>api/endpoints/publication_endpoints.R</files>
  <action>
Enhance the `/publication/pubtator/genes` endpoint in publication_endpoints.R to return prioritization fields:

1. **Add is_novel field** to the SQL/dplyr query:
   - is_novel = 1 when gene has no matching entity_id (coverage gap)
   - Use: `CASE WHEN MAX(entity_id) IS NULL THEN 1 ELSE 0 END AS is_novel`
   - This must be computed AFTER grouping by gene

2. **Add oldest_pub_date field**:
   - `MIN(date) AS oldest_pub_date`
   - This shows when the gene first appeared in NDD literature
   - Useful for finding "long-overlooked" genes

3. **Add pmids field**:
   - `GROUP_CONCAT(DISTINCT pmid ORDER BY date SEPARATOR ',') AS pmids`
   - Comma-separated list of PMIDs for the gene (string, NOT array)
   - Used by frontend for expandable publication details

4. **Update default sort order** to prioritize by is_novel DESC, then oldest_pub_date ASC:
   - Non-SysNDD genes first (is_novel = 1)
   - Then by oldest publication date (long-overlooked genes)
   - This matches the CONTEXT.md decision on prioritization criteria

5. **Update fspec parameter** to include new fields:
   - Add `is_novel,oldest_pub_date,pmids` to the default fspec value

Implementation approach:
- The current endpoint uses `nest_pubtator_gene_tibble_mem()` for nesting
- Add the new computed columns BEFORE nesting in `df_counts` section
- Use dplyr::mutate with purrr::map_int for is_novel and purrr::map_chr for pmids
- Compute oldest_pub_date from the nested publications tibble

Note: Use `dplyr::select()` explicitly to avoid masking issues.
  </action>
  <verify>
    - `curl -s "localhost:3838/api/publication/pubtator/genes?page_size=5" | jq '.data[0] | {is_novel, oldest_pub_date, pmids}'`
    - Response includes: is_novel (0 or 1), oldest_pub_date (date string), pmids (comma-separated string, NOT array)
    - Verify pmids is a string: `curl -s "localhost:3838/api/publication/pubtator/genes?page_size=1" | jq '.data[0].pmids | type'` should return "string"
    - Genes with is_novel=1 appear before is_novel=0 in default sort
  </verify>
  <done>API endpoint returns is_novel, oldest_pub_date, and pmids (as comma-separated string) fields for each gene, sorted by coverage gap then recency</done>
</task>

<task type="auto">
  <name>Task 3: Add Pubtator Admin Section to ManageAnnotations</name>
  <files>app/src/views/admin/ManageAnnotations.vue</files>
  <action>
Add a new Pubtator section to ManageAnnotations.vue following the existing card pattern:

1. **Add Pubtator stats state** in the script section:
   ```typescript
   const pubtatorStats = ref({
     last_update: null as string | null,
     publication_count: null as number | null,
     gene_count: null as number | null,
   });
   const loadingPubtatorStats = ref(false);
   ```

2. **Create fetchPubtatorStats function**:
   - Call `/api/publication/pubtator/genes?page_size=1` to get meta.totalItems for gene count
   - Call `/api/publication/pubtator/table?page_size=1` to get meta.totalItems for publication count
   - For last_update, fetch from existing annotationDates or add a new field

3. **Add Pubtator update job instance** using useAsyncJob:
   ```typescript
   const pubtatorJob = useAsyncJob(
     (jobId: string) => `${import.meta.env.VITE_API_URL}/api/jobs/${jobId}/status`
   );
   ```

4. **Create updatePubtatorCache function**:
   - POST to `/api/jobs/pubtator_update/submit` (following HGNC pattern)
   - Track job via pubtatorJob.startJob(response.data.job_id)

5. **Add BCard section** for Pubtator (place after HGNC section):
   ```vue
   <BCard header-tag="header" body-class="p-1" header-class="p-1"
          border-variant="dark" class="mb-3 text-start">
     <template #header>
       <h5 class="mb-0 text-start font-weight-bold">
         Pubtator Cache Management
         <span v-if="pubtatorStats.last_update" class="badge bg-secondary ms-2 fw-normal">
           Last: {{ formatDate(pubtatorStats.last_update) }}
         </span>
         <span v-if="pubtatorStats.publication_count" class="badge bg-info ms-2 fw-normal">
           {{ pubtatorStats.publication_count?.toLocaleString() }} pubs
         </span>
         <span v-if="pubtatorStats.gene_count" class="badge bg-info ms-2 fw-normal">
           {{ pubtatorStats.gene_count?.toLocaleString() }} genes
         </span>
       </h5>
     </template>
     <!-- Update button with progress display -->
   </BCard>
   ```

6. **Add job watch** for completion/failure notifications (copy HGNC pattern)

7. **Call fetchPubtatorStats** in onMounted

Note: The actual pubtator_update job endpoint may not exist yet in the API. Create the UI that will call it - the backend job can be added in a future phase or this phase if time permits. For now, show a "Coming soon" message if the endpoint returns 404.
  </action>
  <verify>
    - Navigate to /admin/annotations
    - Pubtator section visible with stats badges
    - Update button renders (may show "Coming soon" if backend not ready)
  </verify>
  <done>Admin panel has Pubtator section showing cache stats and update trigger button</done>
</task>

</tasks>

<verification>
1. Stats page test:
   - Visit /analyses/pubtator/stats
   - Page loads without errors
   - D3 bar chart renders with gene data
   - Category dropdown works (Top Genes / Publications by Gene Count)
   - Help popover explains Pubtator concept

2. API test:
   - `curl "localhost:3838/api/publication/pubtator/genes?page_size=3" | jq`
   - Response includes is_novel, oldest_pub_date, pmids fields
   - pmids is a comma-separated string (not an array)
   - Default sort shows is_novel=1 genes first

3. Admin panel test:
   - Visit /admin/annotations (requires admin auth)
   - Pubtator section visible below HGNC section
   - Stats badges show publication and gene counts
</verification>

<success_criteria>
1. PubtatorNDD Stats page renders D3 bar chart without errors (PUBT-01)
2. /publication/pubtator/genes endpoint returns is_novel, oldest_pub_date, pmids as comma-separated string (PUBT-02, PUBT-03 foundation)
3. ManageAnnotations has Pubtator section with stats display
4. Help badge documents Pubtator concept on Stats page (PUBT-06 partial - Stats view)
</success_criteria>

<output>
After completion, create `.planning/phases/57-pubtator-improvements/57-01-SUMMARY.md`
</output>
