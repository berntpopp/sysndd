---
phase: 24-versioning-pagination-cleanup
plan: 05
type: execute
wave: 3
depends_on: ["24-03", "24-04"]
files_modified:
  - api/functions/genereviews-functions.R
  - api/functions/helper-functions.R
  - api/functions/external-functions.R
  - api/functions/ontology-functions.R
  - api/functions/endpoint-functions.R
autonomous: true
user_setup: []

must_haves:
  truths:
    - "GeneReviews title matching bug is fixed"
    - "Error handling added to generate_filter_expressions"
    - "Obsolete TODO comments removed"
    - "Intentional future-work TODOs documented or converted to issues"
    - "At least 20 of 23 TODO comments addressed"
  artifacts:
    - path: "api/functions/genereviews-functions.R"
      provides: "Fixed title matching logic"
      contains: "mutate|filter"
    - path: "api/functions/helper-functions.R"
      provides: "Error handling for filter expressions"
      contains: "tryCatch|stop"
  key_links:
    - from: "api/functions/genereviews-functions.R"
      to: "pool"
      via: "database query"
      pattern: "pool.*tbl"
---

<objective>
Resolve TODO comments and fix identified bugs

Purpose: Improve code quality by addressing technical debt (TEST-01)
Output: 20+ TODO comments resolved, GeneReviews bug fixed
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-versioning-pagination-cleanup/24-RESEARCH.md

# TODO analysis from research
# 23 TODOs in application code:
# - analyses-functions.R: 5 (LOW - future ML/stats)
# - helper-functions.R: 6 (MEDIUM - error handling)
# - external-functions.R: 3 (MEDIUM - incomplete API integration)
# - genereviews-functions.R: 2 (HIGH - bug fix)
# - ontology-functions.R: 3 (MEDIUM - refactoring)
# - endpoint-functions.R: 1 (MEDIUM)
# - hgnc-functions.R: 1 (LOW)
# - oxo-functions.R: 1 (LOW)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix GeneReviews title matching bug (HIGH priority)</name>
  <files>api/functions/genereviews-functions.R</files>
  <action>
Address the HIGH priority TODO about "title now having multiple matches":

1. Find the TODO comment (around line 32 or 123 based on research)

2. Understand the bug:
   - Title matching returns multiple results
   - Need to handle disambiguation or select best match

3. Fix approach:
   - If multiple matches, use slice_head(n=1) to get first/best match
   - OR use more specific matching criteria
   - Add logging for when multiple matches occur

4. Remove or update the TODO comment after fix

5. Test by calling the function to verify it doesn't error on multiple matches

Pattern for handling multiple matches:
```r
matches <- data %>%
  filter(title == search_title)

if (nrow(matches) > 1) {
  log_warn("Multiple title matches found", title = search_title, count = nrow(matches))
  matches <- matches %>% slice_head(n = 1)
}
```
  </action>
  <verify>
grep -c "TODO" api/functions/genereviews-functions.R (should be reduced)
No runtime errors when function called
  </verify>
  <done>GeneReviews title matching bug fixed, TODO resolved</done>
</task>

<task type="auto">
  <name>Task 2: Add error handling to helper-functions.R (MEDIUM priority)</name>
  <files>api/functions/helper-functions.R</files>
  <action>
Address 6 TODOs related to error handling and type checking:

1. generate_filter_expressions (around line 304-307):
   - Add validation for column existence
   - Add tryCatch for malformed filter expressions
   - Return informative error messages

2. Other helper function TODOs (around line 934-935):
   - Review each TODO
   - Implement error handling where practical
   - Document as intentional if complex (e.g., "TODO: future optimization")

For each TODO:
- If bug fix: implement fix, remove TODO
- If simple improvement: implement, remove TODO
- If complex future work: keep TODO with clear context OR create GitHub issue

Pattern for validation:
```r
generate_filter_expressions <- function(filter_list, data_columns) {
  # Validate columns exist
  unknown_cols <- setdiff(names(filter_list), data_columns)
  if (length(unknown_cols) > 0) {
    stop(paste("Unknown filter columns:", paste(unknown_cols, collapse = ", ")))
  }

  # Original logic...
}
```
  </action>
  <verify>
grep -c "TODO" api/functions/helper-functions.R (should be reduced by 4-6)
  </verify>
  <done>Error handling added to helper functions, TODOs addressed</done>
</task>

<task type="auto">
  <name>Task 3: Address remaining function file TODOs</name>
  <files>api/functions/external-functions.R, api/functions/ontology-functions.R, api/functions/endpoint-functions.R, api/functions/hgnc-functions.R, api/functions/oxo-functions.R, api/functions/analyses-functions.R</files>
  <action>
Review and address remaining TODOs across function files:

1. external-functions.R (3 TODOs):
   - Sanity checks and response handling
   - Add basic validation or document as known limitation

2. ontology-functions.R (3 TODOs):
   - Code duplication and logic clarification
   - Extract common function if straightforward
   - Add comments explaining column logic

3. endpoint-functions.R (1 TODO):
   - Review context, implement or document

4. hgnc-functions.R (1 TODO):
   - "Extract to function" - implement if quick win (<15 min)
   - Otherwise document intent

5. oxo-functions.R (1 TODO):
   - Retry logic - add exponential backoff if straightforward
   - Otherwise document as enhancement

6. analyses-functions.R (5 TODOs):
   - These are future ML/stats enhancements
   - Keep as documented TODOs OR create GitHub issues
   - Add context: "TODO(future): ML enhancement - ..."

For each file:
- Count TODOs before and after
- Document changes in summary

Target: Address at least 15 TODOs (total 20+ including Tasks 1-2)
  </action>
  <verify>
Total TODO count reduced by at least 15 across all files
  </verify>
  <done>Remaining function file TODOs addressed or documented</done>
</task>

</tasks>

<verification>
- [ ] GeneReviews title matching bug fixed (no runtime errors)
- [ ] Error handling added to generate_filter_expressions
- [ ] At least 20 of 23 TODOs addressed
- [ ] Remaining TODOs are clearly documented as intentional future work
- [ ] No regression in existing functionality
</verification>

<success_criteria>
TEST-01: 30 TODO comments resolved or documented as intentional
  - Note: Research found 23 in app code, target 20+ addressed
  - Remaining marked as intentional future enhancements
</success_criteria>

<output>
After completion, create `.planning/phases/24-versioning-pagination-cleanup/24-05-SUMMARY.md`
</output>
