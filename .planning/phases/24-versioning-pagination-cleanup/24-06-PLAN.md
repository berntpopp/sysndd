---
phase: 24-versioning-pagination-cleanup
plan: 06
type: execute
wave: 3
depends_on: ["24-03", "24-04"]
files_modified:
  - api/.lintr
  - api/functions/*.R
  - api/endpoints/*.R
autonomous: true
user_setup: []

must_haves:
  truths:
    - "lintr issues reduced to under 200"
    - "High-value issues (potential bugs, complexity) prioritized"
    - "Cosmetic fixes applied via styler where safe"
    - "Justified exceptions use # nolint comments"
  artifacts:
    - path: "api/.lintr"
      provides: "Updated lintr configuration"
      contains: "linters_with_defaults"
  key_links:
    - from: "api/.lintr"
      to: "api/functions/*.R"
      via: "lintr configuration"
      pattern: "exclusions"
---

<objective>
Reduce lintr issues from ~1240 to under 200

Purpose: Improve code quality and maintainability (TEST-02)
Output: Cleaner codebase with <200 lintr issues

**Scope Note:** This plan applies styler to entire directories (functions/*.R, endpoints/*.R).
This is intentional - styler is designed for bulk automated formatting and is safe for this use case.
Risks acknowledged and mitigated:
- SQL string breaks: Task 2 includes review step and revert instructions if SQL queries break
- Functional changes: styler only changes whitespace/formatting, not logic
- Security code excluded: core/ directory is NOT styled (security-critical)
The bulk approach is more efficient than file-by-file and produces consistent formatting.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-versioning-pagination-cleanup/24-RESEARCH.md

# Existing lintr config
@api/.lintr
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run lintr and categorize issues</name>
  <files>N/A (analysis task)</files>
  <action>
1. Run lintr on the api directory:
   cd /home/bernt-popp/development/sysndd/api
   Rscript -e "lintr::lint_dir('.')" > lintr_report.txt 2>&1

2. Count total issues:
   wc -l lintr_report.txt

3. Categorize by type:
   - line_length_linter: Often false positives in SQL
   - cyclocomp_linter: Flag complex functions for review
   - indentation_linter: Fixable with styler
   - trailing_whitespace: Fixable with styler
   - object_name_linter: Disabled in config
   - other: Review individually

4. Identify files with most issues:
   - Focus on functions/*.R and endpoints/*.R
   - Exclude tests/ (already in .lintr exclusions)

5. Create prioritized fix list:
   - HIGH: Potential bugs (undefined variables, etc.)
   - MEDIUM: Complexity issues (cyclomatic complexity)
   - LOW: Style issues (line length, whitespace)

Output: List of high-priority issues to fix manually
  </action>
  <verify>
lintr_report.txt exists with issue count
Priority list identified
  </verify>
  <done>lintr issues categorized and prioritized</done>
</task>

<task type="auto">
  <name>Task 2: Apply automated style fixes with styler</name>
  <files>api/functions/*.R, api/endpoints/*.R</files>
  <action>
Use styler for safe automated fixes (bulk operation):

1. Apply styler to functions directory:
   Rscript -e "styler::style_dir('functions')"

2. Apply styler to endpoints directory:
   Rscript -e "styler::style_dir('endpoints')"

3. Do NOT style:
   - tests/ (could break test structure)
   - core/ (security-critical code)

4. Review changes:
   git diff --stat
   - Verify no functional changes
   - Check SQL strings not broken incorrectly

5. If styler breaks SQL queries:
   - Revert those files: git checkout -- file.R
   - Add # nolint comment to affected lines

Styler typically fixes:
- Trailing whitespace
- Inconsistent indentation
- Spacing around operators
- Line breaks

Does NOT fix:
- Line length (needs manual review)
- Cyclomatic complexity (needs refactoring)

**Expected scope:** 20-30 files may be touched. This is acceptable - styler makes
consistent, predictable changes. Review git diff to confirm no logic changes.
  </action>
  <verify>
git diff shows style changes only (whitespace, formatting)
No functional logic changes
API starts successfully after changes
  </verify>
  <done>Automated style fixes applied safely</done>
</task>

<task type="auto">
  <name>Task 3: Fix high-value lintr issues manually</name>
  <files>api/functions/*.R, api/endpoints/*.R</files>
  <action>
Fix high-priority issues identified in Task 1:

1. Cyclomatic complexity issues:
   - Identify functions with complexity > 15
   - Refactor if straightforward (extract helper functions)
   - Add # nolint: cyclocomp_linter if complex but correct

2. Potential bugs (if any):
   - Undefined variables
   - Unused variables
   - Missing function arguments

3. Line length issues (selective):
   - SQL queries: Add # nolint end of line
   - Long strings: Break appropriately
   - Long function calls: Use multi-line format

4. Add # nolint comments for justified exceptions:
   - SQL queries that must stay on one line
   - Complex regex patterns
   - Code matching external API contracts

Pattern for nolint:
```r
# nolint start: line_length_linter
sql <- "SELECT col1, col2, col3, col4 FROM very_long_table_name WHERE condition"
# nolint end
```

Or inline:
```r
sql <- "SELECT * FROM table"  # nolint: line_length_linter
```
  </action>
  <verify>
Re-run lintr: Rscript -e "lintr::lint_dir('.')" | wc -l
Count should be under 200
  </verify>
  <done>lintr issues reduced to under 200</done>
</task>

</tasks>

<verification>
- [ ] Initial lintr count documented (baseline)
- [ ] styler applied to functions/ and endpoints/
- [ ] High-priority issues fixed manually
- [ ] # nolint comments added for justified exceptions
- [ ] Final lintr count under 200
- [ ] No functional regressions (API starts, tests pass)
</verification>

<success_criteria>
TEST-02: lintr issues reduced (target: <200 from current ~1240)
- Focus on high-value fixes (bugs, complexity)
- Use # nolint for justified exceptions
- Don't chase perfection - diminishing returns
</success_criteria>

<output>
After completion, create `.planning/phases/24-versioning-pagination-cleanup/24-06-SUMMARY.md`
</output>
