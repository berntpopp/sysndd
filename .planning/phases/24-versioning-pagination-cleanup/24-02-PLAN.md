---
phase: 24-versioning-pagination-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - api/functions/helper-functions.R
  - api/functions/pagination-helpers.R
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Page size is capped at configurable maximum (default 500)"
    - "Page size below 1 defaults to 10"
    - "Existing pagination behavior unchanged for valid page_size values"
    - "Warning logged when page_size exceeds max"
  artifacts:
    - path: "api/functions/pagination-helpers.R"
      provides: "Pagination utilities with max limit enforcement"
      exports: ["generate_cursor_pag_inf_safe", "validate_page_size"]
    - path: "api/functions/helper-functions.R"
      provides: "Source for pagination-helpers.R"
      contains: "source.*pagination-helpers"
  key_links:
    - from: "api/functions/pagination-helpers.R"
      to: "api/functions/helper-functions.R"
      via: "generate_cursor_pag_inf call"
      pattern: "generate_cursor_pag_inf\\("
---

<objective>
Create pagination safety wrapper with max page_size enforcement

Purpose: Prevent DoS via unlimited page_size requests (PAG-02)
Output: generate_cursor_pag_inf_safe function with configurable max limit
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-versioning-pagination-cleanup/24-RESEARCH.md

# Existing pagination implementation
@api/functions/helper-functions.R (lines 602-680 - generate_cursor_pag_inf)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pagination-helpers.R with safe wrapper</name>
  <files>api/functions/pagination-helpers.R</files>
  <action>
Create new pagination-helpers.R with:

1. Global config constant:
   PAGINATION_MAX_SIZE <- 500  # PAG-02 requirement

2. validate_page_size function:
   - Input: page_size (character or numeric), max_size (default 500)
   - If page_size == "all", return "all" unchanged
   - Convert to integer
   - If > max_size: log warning, cap at max_size
   - If < 1: return 10 (default)
   - Return validated integer as character (for consistency with existing API)

3. generate_cursor_pag_inf_safe function:
   - Same signature as generate_cursor_pag_inf plus max_page_size param
   - Calls validate_page_size first
   - Delegates to generate_cursor_pag_inf (from helper-functions.R)
   - Uses log_warn for over-limit warnings (from core/logging.R)

Pattern:
```r
generate_cursor_pag_inf_safe <- function(
  pagination_tibble,
  page_size = "all",
  page_after = 0,
  pagination_identifier = "entity_id",
  max_page_size = PAGINATION_MAX_SIZE
) {
  validated_size <- validate_page_size(page_size, max_page_size)
  generate_cursor_pag_inf(pagination_tibble, validated_size, page_after, pagination_identifier)
}
```

Add file header with Google R Style Guide conventions.
  </action>
  <verify>
File exists: api/functions/pagination-helpers.R
Contains: PAGINATION_MAX_SIZE, validate_page_size, generate_cursor_pag_inf_safe
  </verify>
  <done>Pagination safety wrapper created with max limit enforcement</done>
</task>

<task type="auto">
  <name>Task 2: Source pagination-helpers.R in helper-functions.R</name>
  <files>api/functions/helper-functions.R</files>
  <action>
Add source() call at the end of helper-functions.R to load pagination-helpers.R:

1. Find the end of helper-functions.R (before any trailing whitespace)

2. Add:
```r
# Source pagination helpers with safety limits
source(file.path(find.package("sysndd", lib.loc = "."), "..", "functions", "pagination-helpers.R"))
```

Wait - helper-functions.R is NOT a package. Use relative path instead:
```r
# Source pagination helpers with safety limits
source("functions/pagination-helpers.R")
```

Actually, check how other sources work in this codebase. Looking at start_sysndd_api.R pattern:
- Files are sourced from the api/ directory context
- Use relative paths from api/ root

The safest approach: Source pagination-helpers.R in start_sysndd_api.R instead (next task).

ACTUALLY - helper-functions.R is sourced by start_sysndd_api.R. So we should source pagination-helpers.R from start_sysndd_api.R directly to ensure proper load order.

MODIFY THIS TASK: No changes to helper-functions.R. Move sourcing to Task 3.
  </action>
  <verify>
helper-functions.R unchanged OR source line added at end
  </verify>
  <done>Pagination helpers loading configured</done>
</task>

<task type="auto">
  <name>Task 3: Source pagination-helpers.R in start_sysndd_api.R</name>
  <files>api/start_sysndd_api.R</files>
  <action>
Add source() call for pagination-helpers.R in start_sysndd_api.R:

1. Find the section where helper-functions.R is sourced (around line 35-50)

2. Add after helper-functions.R source:
```r
source("functions/pagination-helpers.R")
```

This ensures:
- helper-functions.R loaded first (provides generate_cursor_pag_inf)
- pagination-helpers.R loaded second (provides safe wrapper)
- All endpoints have access to both functions

Verify the source works by checking there are no errors in the section order.
  </action>
  <verify>
grep -q "pagination-helpers.R" api/start_sysndd_api.R
  </verify>
  <done>pagination-helpers.R sourced after helper-functions.R in startup</done>
</task>

</tasks>

<verification>
- [ ] PAGINATION_MAX_SIZE constant set to 500
- [ ] validate_page_size returns "all" unchanged
- [ ] validate_page_size caps values > 500 at 500
- [ ] validate_page_size returns 10 for values < 1
- [ ] generate_cursor_pag_inf_safe delegates to original function
- [ ] pagination-helpers.R sourced in start_sysndd_api.R
</verification>

<success_criteria>
PAG-02: Configurable page_size with max limit (100-500) - Set to 500
Foundation ready for extending pagination to remaining endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/24-versioning-pagination-cleanup/24-02-SUMMARY.md`
</output>
