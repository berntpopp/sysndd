---
phase: 24-versioning-pagination-cleanup
plan: 04
type: execute
wave: 2
depends_on: ["24-02"]
files_modified:
  - api/endpoints/list_endpoints.R
  - api/endpoints/search_endpoints.R
  - api/endpoints/status_endpoints.R
autonomous: true
user_setup: []

must_haves:
  truths:
    - "GET /api/list/* endpoints return paginated response with links/meta/data"
    - "GET /api/status/_list returns paginated response"
    - "Search endpoints return top N results with pagination metadata"
    - "Default page_size maintains backward compatibility"
  artifacts:
    - path: "api/endpoints/list_endpoints.R"
      provides: "Paginated list endpoints"
      contains: "generate_cursor_pag_inf"
    - path: "api/endpoints/status_endpoints.R"
      provides: "Paginated status list endpoint"
      contains: "generate_cursor_pag_inf"
  key_links:
    - from: "api/endpoints/list_endpoints.R"
      to: "api/functions/pagination-helpers.R"
      via: "generate_cursor_pag_inf_safe call"
      pattern: "generate_cursor_pag_inf_safe"
---

<objective>
Extend cursor pagination to list and status endpoints

Purpose: Enable paginated access to dropdown/list data (PAG-01, PAG-04)
Output: Paginated /api/list/*, /api/status/_list endpoints
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-versioning-pagination-cleanup/24-RESEARCH.md
@.planning/phases/24-versioning-pagination-cleanup/24-02-SUMMARY.md

# Existing pagination pattern
@api/endpoints/entity_endpoints.R (lines 11-100)

# Endpoints to update
@api/endpoints/list_endpoints.R
@api/endpoints/status_endpoints.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pagination to list endpoints</name>
  <files>api/endpoints/list_endpoints.R</files>
  <action>
Update list_endpoints.R to add pagination to applicable endpoints:

1. GET /api/list/status:
   - Add page_after = 0, page_size = "all" parameters
   - Add composite key sorting: arrange(category_id)
   - Apply generate_cursor_pag_inf_safe with "category_id" as identifier
   - Wrap result in list(links=, meta=, data=) structure

2. GET /api/list/phenotype:
   - Add page_after = 0, page_size = "all" parameters
   - Add sorting: arrange(phenotype_id) or arrange(HPO_term)
   - Apply pagination with "phenotype_id" as identifier
   - Note: Handle tree=TRUE case separately (may not need pagination)

3. GET /api/list/inheritance:
   - Add pagination parameters
   - Sort by appropriate identifier
   - Apply pagination

4. GET /api/list/variation_ontology:
   - Add pagination parameters
   - Sort by appropriate identifier
   - Apply pagination

For each endpoint:
- Add @param annotations for page_after and page_size
- Keep tree parameter functionality unchanged
- When tree=TRUE, skip pagination (tree structure doesn't paginate well)
- When tree=FALSE, apply pagination

Pattern:
```r
function(tree = FALSE, page_after = 0, page_size = "all") {
  tree <- as.logical(tree)

  data <- pool %>%
    tbl("table_name") %>%
    arrange(id_column) %>%
    collect()

  if (tree) {
    # Return tree structure unchanged
    format_as_tree(data)
  } else {
    # Apply pagination
    pagination_info <- generate_cursor_pag_inf_safe(
      data, page_size, page_after, "id_column"
    )
    list(links = pagination_info$links, meta = pagination_info$meta, data = pagination_info$data)
  }
}
```
  </action>
  <verify>
grep -q "generate_cursor_pag_inf" api/endpoints/list_endpoints.R
grep -q "page_size" api/endpoints/list_endpoints.R
  </verify>
  <done>List endpoints return paginated responses</done>
</task>

<task type="auto">
  <name>Task 2: Add pagination to status/_list endpoint</name>
  <files>api/endpoints/status_endpoints.R</files>
  <action>
Find and update the GET /_list endpoint in status_endpoints.R:

1. Add pagination parameters:
   - page_after = 0
   - page_size = "all"

2. Add @param annotations

3. Add sorting before collect():
   - Use appropriate identifier column (likely status_id or similar)

4. Apply pagination:
```r
pagination_info <- generate_cursor_pag_inf_safe(
  status_list,
  page_size,
  page_after,
  "status_id"  # or appropriate identifier
)

list(
  links = pagination_info$links,
  meta = pagination_info$meta,
  data = pagination_info$data
)
```

If the endpoint doesn't exist or has different structure, adapt accordingly.
  </action>
  <verify>
grep -q "generate_cursor_pag_inf" api/endpoints/status_endpoints.R || echo "Check endpoint structure"
  </verify>
  <done>Status list endpoint returns paginated response</done>
</task>

<task type="auto">
  <name>Task 3: Update API documentation for pagination</name>
  <files>api/endpoints/list_endpoints.R, api/endpoints/status_endpoints.R</files>
  <action>
Ensure all updated endpoints have proper Swagger documentation:

1. For each paginated endpoint, verify annotations include:
   - @param page_after Cursor after which entries are shown (default: 0)
   - @param page_size Page size in cursor pagination (default: "all")
   - @response 200 documentation mentioning pagination structure

2. Update any @return or @response descriptions to indicate:
   - links: pagination navigation URLs
   - meta: pagination metadata (perPage, currentPage, totalPages)
   - data: actual response data

3. Verify tree parameter documentation is clear:
   - When tree=TRUE, pagination is not applied
   - When tree=FALSE or not specified, pagination is applied

This satisfies PAG-04: API documentation updated with pagination details.
  </action>
  <verify>
All paginated endpoints have @param annotations for page_after and page_size
  </verify>
  <done>API documentation reflects pagination parameters</done>
</task>

</tasks>

<verification>
- [ ] GET /api/list/status returns paginated structure (tree=FALSE)
- [ ] GET /api/list/phenotype returns paginated structure (tree=FALSE)
- [ ] GET /api/list/inheritance returns paginated structure
- [ ] GET /api/list/variation_ontology returns paginated structure
- [ ] GET /api/status/_list returns paginated structure
- [ ] tree=TRUE endpoints return original structure (not paginated)
- [ ] All endpoints have proper @param documentation
</verification>

<success_criteria>
PAG-01: Cursor-based pagination standardized for list/status endpoints
PAG-04: API documentation updated with pagination details
</success_criteria>

<output>
After completion, create `.planning/phases/24-versioning-pagination-cleanup/24-04-SUMMARY.md`
</output>
