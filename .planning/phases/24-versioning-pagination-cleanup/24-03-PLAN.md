---
phase: 24-versioning-pagination-cleanup
plan: 03
type: execute
wave: 2
depends_on: ["24-02"]
files_modified:
  - api/endpoints/user_endpoints.R
  - api/endpoints/re_review_endpoints.R
autonomous: true
user_setup: []

must_haves:
  truths:
    - "GET /api/user/table returns paginated response with links/meta/data"
    - "GET /api/re_review/table returns paginated response with links/meta/data"
    - "Default page_size maintains backward compatibility (returns all if not specified)"
    - "Composite key sorting ensures stable pagination"
  artifacts:
    - path: "api/endpoints/user_endpoints.R"
      provides: "Paginated user table endpoint"
      contains: "generate_cursor_pag_inf"
    - path: "api/endpoints/re_review_endpoints.R"
      provides: "Paginated re-review table endpoint"
      contains: "generate_cursor_pag_inf"
  key_links:
    - from: "api/endpoints/user_endpoints.R"
      to: "api/functions/pagination-helpers.R"
      via: "generate_cursor_pag_inf_safe call"
      pattern: "generate_cursor_pag_inf_safe"
    - from: "api/endpoints/re_review_endpoints.R"
      to: "api/functions/pagination-helpers.R"
      via: "generate_cursor_pag_inf_safe call"
      pattern: "generate_cursor_pag_inf_safe"
---

<objective>
Extend cursor pagination to user and re_review table endpoints

Purpose: Enable paginated access to user and re-review management tables (PAG-01)
Output: /api/user/table and /api/re_review/table with cursor pagination
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-versioning-pagination-cleanup/24-RESEARCH.md
@.planning/phases/24-versioning-pagination-cleanup/24-02-SUMMARY.md

# Existing pagination pattern (reference implementation)
@api/endpoints/entity_endpoints.R (lines 11-100 - GET / with pagination)

# Endpoints to update
@api/endpoints/user_endpoints.R (lines 22-70 - GET table)
@api/endpoints/re_review_endpoints.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pagination to user/table endpoint</name>
  <files>api/endpoints/user_endpoints.R</files>
  <action>
Update GET /api/user/table endpoint to use cursor pagination:

1. Add pagination parameters to function signature:
   - page_after = 0
   - page_size = "all" (default "all" for backward compatibility)

2. Update Plumber annotations:
   - @param page_after Cursor after which entries are shown (default: 0)
   - @param page_size Page size in cursor pagination (default: "all")

3. Add composite key sorting for stable pagination:
   - arrange(created_at, user_id) before collect()

4. Apply pagination after collect():
```r
pagination_info <- generate_cursor_pag_inf_safe(
  user_table,
  page_size,
  page_after,
  "user_id"  # Unique identifier for cursor
)

list(
  links = pagination_info$links,
  meta = pagination_info$meta,
  data = pagination_info$data
)
```

5. Both Administrator and Curator branches need pagination applied.

Preserve existing role-based filtering logic (Admin sees all, Curator sees unapproved).
  </action>
  <verify>
grep -q "generate_cursor_pag_inf" api/endpoints/user_endpoints.R
grep -q "page_after" api/endpoints/user_endpoints.R
  </verify>
  <done>User table endpoint returns paginated response</done>
</task>

<task type="auto">
  <name>Task 2: Add pagination to re_review/table endpoint</name>
  <files>api/endpoints/re_review_endpoints.R</files>
  <action>
First, find the GET /table endpoint in re_review_endpoints.R. If it doesn't exist, create it.

Based on the file structure, look for a table endpoint that returns re-review data.

If endpoint exists, update with pagination:

1. Add pagination parameters:
   - page_after = 0
   - page_size = "all"

2. Add Plumber annotations:
   - @param page_after Cursor after which entries are shown (default: 0)
   - @param page_size Page size in cursor pagination (default: "all")

3. Add composite key sorting:
   - arrange(created_at, re_review_entity_id) before collect()

4. Apply pagination:
```r
pagination_info <- generate_cursor_pag_inf_safe(
  re_review_table,
  page_size,
  page_after,
  "re_review_entity_id"
)

list(
  links = pagination_info$links,
  meta = pagination_info$meta,
  data = pagination_info$data
)
```

If no table endpoint exists yet, this task may need adjustment. Check file first.
  </action>
  <verify>
grep -q "generate_cursor_pag_inf" api/endpoints/re_review_endpoints.R || echo "No table endpoint found - check file"
  </verify>
  <done>Re-review table endpoint returns paginated response (if endpoint exists)</done>
</task>

<task type="auto">
  <name>Task 3: Verify pagination endpoints work</name>
  <files>N/A</files>
  <action>
1. Start API and test paginated user endpoint:
   curl -H "Authorization: Bearer $TOKEN" "http://localhost:8000/api/user/table?page_size=5"

2. Expected response structure:
   {
     "links": { "prev": "...", "self": "...", "next": "...", "last": "..." },
     "meta": { "perPage": 5, "currentPage": 1, "totalPages": N, ... },
     "data": [ ... ]
   }

3. Test backward compatibility (no pagination params):
   curl -H "Authorization: Bearer $TOKEN" "http://localhost:8000/api/user/table"
   - Should return all users (page_size="all" default)

4. Test re_review/table similarly if endpoint exists.

5. Verify pagination follows next link:
   - Get next link from first response
   - Request with page_after parameter
   - Verify different results returned
  </action>
  <verify>
curl response contains "links", "meta", "data" keys
Default request returns all records (backward compatible)
  </verify>
  <done>User and re-review pagination verified working</done>
</task>

</tasks>

<verification>
- [ ] GET /api/user/table returns links/meta/data structure
- [ ] GET /api/user/table?page_size=5 returns 5 records
- [ ] GET /api/user/table (no params) returns all records
- [ ] Pagination uses composite key sorting (created_at, id)
- [ ] Re-review table endpoint paginated (if exists)
- [ ] No breaking changes to existing API consumers
</verification>

<success_criteria>
PAG-01: Cursor-based pagination standardized for user/re_review tabular endpoints
PAG-05: Default pagination settings provided for backward compatibility
</success_criteria>

<output>
After completion, create `.planning/phases/24-versioning-pagination-cleanup/24-03-SUMMARY.md`
</output>
