---
phase: 34-critical-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/views/curate/ModifyEntity.vue
  - app/src/views/curate/ManageReReview.vue
autonomous: true

must_haves:
  truths:
    - "ModifyEntity status dropdown shows all status options when opened"
    - "Component names in Vue DevTools match filenames"
    - "Status modal waits for options to load before displaying"
  artifacts:
    - path: "app/src/views/curate/ModifyEntity.vue"
      provides: "Fixed ModifyEntity with loading state for status dropdown"
      contains: "name: 'ModifyEntity'"
    - path: "app/src/views/curate/ManageReReview.vue"
      provides: "Fixed component name"
      contains: "name: 'ManageReReview'"
  key_links:
    - from: "ModifyEntity.vue showStatusModify()"
      to: "status_options loaded"
      via: "await loadStatusList() before modal show"
      pattern: "await.*loadStatusList"
    - from: "ModifyEntity.vue status dropdown"
      to: "status_options"
      via: "loading state guard with null check"
      pattern: "status_options === null"
---

<objective>
Fix ModifyEntity status dropdown and component name mismatches

Purpose: The ModifyEntity status dropdown shows empty options because the component renders before async options load completes. Additionally, ManageReReview.vue has incorrect component name 'ApproveStatus' which breaks Vue DevTools debugging.

Output: Working status dropdown with loading state guard, and correct component names for debugging
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/34-critical-bug-fixes/34-RESEARCH.md

Components to fix:
@app/src/views/curate/ModifyEntity.vue
@app/src/views/curate/ManageReReview.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ModifyEntity status dropdown loading state</name>
  <files>app/src/views/curate/ModifyEntity.vue</files>
  <action>
Fix the empty status dropdown by adding proper loading state management:

1. **Fix component name** (line 625):
   - Change `name: 'ApproveStatus'` to `name: 'ModifyEntity'`

2. **Update data() to distinguish loading from empty** (around line 637):
   - Change `status_options: []` to `status_options: null`
   - Add `status_options_loading: false`
   ```javascript
   data() {
     return {
       status_options: null,  // null = not loaded, [] = loaded but empty
       status_options_loading: false,
       // ... rest unchanged
     };
   }
   ```

3. **Update `loadStatusList()` to track loading state** (around line 696):
   ```javascript
   async loadStatusList() {
     this.status_options_loading = true;
     const apiUrl = `${import.meta.env.VITE_API_URL}/api/list/status?tree=true`;
     try {
       const response = await this.axios.get(apiUrl);
       this.status_options = Array.isArray(response.data)
         ? response.data
         : response.data?.data || [];
     } catch (e) {
       this.makeToast(e, 'Error', 'danger');
       this.status_options = [];
     } finally {
       this.status_options_loading = false;
     }
   }
   ```

4. **Update `showStatusModify()` to ensure options loaded** (around line 932):
   - Ensure loadStatusList() completes before showing modal
   - Add guard against empty options
   ```javascript
   async showStatusModify() {
     // Load entity and status data
     await this.getEntity();
     await this.getStatus();

     // Ensure status options are loaded
     if (this.status_options === null) {
       await this.loadStatusList();
     }

     // Guard against empty options
     if (!this.status_options || this.status_options.length === 0) {
       this.makeToast('Failed to load status options. Please refresh and try again.', 'Error', 'danger');
       return;
     }

     this.$refs.modifyStatusModal.show();
   }
   ```

5. **Update status dropdown template** (around line 560):
   - Add loading spinner
   - Update condition to handle null (not loaded) state
   ```vue
   <!-- Status dropdown with loading state -->
   <BSpinner v-if="status_options_loading" small label="Loading..." />
   <BFormSelect
     v-else-if="status_options && status_options.length > 0"
     id="status-select"
     v-model="status_info.category_id"
     :options="normalizeStatusOptions(status_options)"
     size="sm"
   >
     <template #first>
       <BFormSelectOption :value="null">
         Select status...
       </BFormSelectOption>
     </template>
   </BFormSelect>
   <BAlert v-else-if="status_options !== null" variant="warning" class="mb-0">
     No status options available
   </BAlert>
   ```

6. **Apply same defensive pattern to phenotypes and variation options**:
   - In data(): Change `phenotypes_options: []` to `phenotypes_options: null`
   - In data(): Change `variation_ontology_options: []` to `variation_ontology_options: null`
   - Update `loadPhenotypesList()` and `loadVariationOntologyList()` with defensive checks:
   ```javascript
   async loadPhenotypesList() {
     const apiUrl = `${import.meta.env.VITE_API_URL}/api/list/phenotype?tree=true`;
     try {
       const response = await this.axios.get(apiUrl);
       this.phenotypes_options = Array.isArray(response.data)
         ? response.data
         : response.data?.data || [];
     } catch (e) {
       this.makeToast(e, 'Error', 'danger');
       this.phenotypes_options = [];
     }
   }

   async loadVariationOntologyList() {
     const apiUrl = `${import.meta.env.VITE_API_URL}/api/list/variation_ontology?tree=true`;
     try {
       const response = await this.axios.get(apiUrl);
       this.variation_ontology_options = Array.isArray(response.data)
         ? response.data
         : response.data?.data || [];
     } catch (e) {
       this.makeToast(e, 'Error', 'danger');
       this.variation_ontology_options = [];
     }
   }
   ```

7. **Update template conditions for phenotypes and variation selects**:
   - Change `v-if="phenotypes_options && phenotypes_options.length > 0"` to include null check
   - Change `v-if="variation_ontology_options && variation_ontology_options.length > 0"` to include null check
  </action>
  <verify>
Verify component name fixed:
```bash
grep -n "name:" /home/bernt-popp/development/sysndd/app/src/views/curate/ModifyEntity.vue | head -3
```
Verify loading state property added:
```bash
grep -n "status_options_loading" /home/bernt-popp/development/sysndd/app/src/views/curate/ModifyEntity.vue
```
Verify defensive patterns:
```bash
grep -n "Array.isArray" /home/bernt-popp/development/sysndd/app/src/views/curate/ModifyEntity.vue
```
Verify await in showStatusModify:
```bash
grep -A5 "showStatusModify" /home/bernt-popp/development/sysndd/app/src/views/curate/ModifyEntity.vue | head -10
```
Run lint check:
```bash
cd /home/bernt-popp/development/sysndd/app && npm run lint -- --no-fix src/views/curate/ModifyEntity.vue 2>&1 | tail -10
```
  </verify>
  <done>
- Component name is 'ModifyEntity' (not 'ApproveStatus')
- status_options initialized as null with status_options_loading flag
- loadStatusList() has defensive Array.isArray check and loading state
- showStatusModify() awaits loadStatusList() and guards against empty options
- Status dropdown template has loading spinner and handles null/empty states
- No lint errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix ManageReReview component name and defensive patterns</name>
  <files>app/src/views/curate/ManageReReview.vue</files>
  <action>
Fix component name and add defensive patterns:

1. **Fix component name** (line 142):
   - Change `name: 'ApproveStatus'` to `name: 'ManageReReview'`

2. **Add defensive pattern to `loadUserList()`** (around line 221):
   ```javascript
   async loadUserList() {
     const apiUrl = `${import.meta.env.VITE_API_URL}/api/user/list?roles=Curator,Reviewer`;
     try {
       const response = await this.axios.get(apiUrl, {
         headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
       });
       const data = response.data;
       this.user_options = Array.isArray(data)
         ? data.map((item) => ({
             value: item.user_id,
             text: item.user_name,
             role: item.user_role,
           }))
         : [];
     } catch (e) {
       this.makeToast(e, 'Error', 'danger');
       this.user_options = [];
     }
   }
   ```

3. **Add defensive pattern to `loadReReviewTableData()`** (around line 238):
   ```javascript
   async loadReReviewTableData() {
     this.loadingReReviewManagment = true;
     const apiUrl = `${import.meta.env.VITE_API_URL}/api/re_review/assignment_table`;
     try {
       const response = await this.axios.get(apiUrl, {
         headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
       });
       const data = response.data;
       if (Array.isArray(data)) {
         this.items_ReReviewTable = data;
         this.totalRows = data.length;
       } else if (data?.data && Array.isArray(data.data)) {
         this.items_ReReviewTable = data.data;
         this.totalRows = data.meta?.[0]?.totalItems || data.data.length;
       } else {
         console.error('Unexpected re-review table response format:', data);
         this.items_ReReviewTable = [];
         this.totalRows = 0;
       }
     } catch (e) {
       this.makeToast(e, 'Error', 'danger');
       this.items_ReReviewTable = [];
       this.totalRows = 0;
     } finally {
       const uiStore = useUiStore();
       uiStore.requestScrollbarUpdate();
       this.loadingReReviewManagment = false;
     }
   }
   ```

4. **Add missing data property** (in data() around line 147):
   - Add `loadingReReviewManagment: false` to data (currently referenced but not declared)
  </action>
  <verify>
Verify component name fixed:
```bash
grep -n "name:" /home/bernt-popp/development/sysndd/app/src/views/curate/ManageReReview.vue | head -3
```
Verify defensive patterns:
```bash
grep -n "Array.isArray" /home/bernt-popp/development/sysndd/app/src/views/curate/ManageReReview.vue
```
Verify loading property added:
```bash
grep -n "loadingReReviewManagment" /home/bernt-popp/development/sysndd/app/src/views/curate/ManageReReview.vue
```
Run lint check:
```bash
cd /home/bernt-popp/development/sysndd/app && npm run lint -- --no-fix src/views/curate/ManageReReview.vue 2>&1 | tail -10
```
  </verify>
  <done>
- Component name is 'ManageReReview' (not 'ApproveStatus')
- loadUserList() validates response before map
- loadReReviewTableData() defensively handles both response formats
- loadingReReviewManagment property declared in data()
- No lint errors
  </done>
</task>

</tasks>

<verification>
All bugs in ModifyEntity and ManageReReview fixed:

```bash
# Verify component names
grep "name: 'ModifyEntity'" /home/bernt-popp/development/sysndd/app/src/views/curate/ModifyEntity.vue
grep "name: 'ManageReReview'" /home/bernt-popp/development/sysndd/app/src/views/curate/ManageReReview.vue

# Verify no remaining 'ApproveStatus' names in curate views
grep -r "name: 'ApproveStatus'" /home/bernt-popp/development/sysndd/app/src/views/curate/
# Expected: no output (no matches)

# Verify defensive patterns count
grep -c "Array.isArray" /home/bernt-popp/development/sysndd/app/src/views/curate/ModifyEntity.vue
# Expected: 3+ (status, phenotypes, variation)

grep -c "Array.isArray" /home/bernt-popp/development/sysndd/app/src/views/curate/ManageReReview.vue
# Expected: 2+ (loadUserList, loadReReviewTableData)

# Verify status loading state
grep "status_options_loading" /home/bernt-popp/development/sysndd/app/src/views/curate/ModifyEntity.vue

# Verify no lint errors in both files
cd /home/bernt-popp/development/sysndd/app && npm run lint -- --no-fix src/views/curate/ModifyEntity.vue src/views/curate/ManageReReview.vue
```
</verification>

<success_criteria>
1. ModifyEntity.vue has `name: 'ModifyEntity'`
2. ManageReReview.vue has `name: 'ManageReReview'`
3. No curate views have `name: 'ApproveStatus'` remaining
4. ModifyEntity status dropdown has loading state guard (null vs empty distinction)
5. showStatusModify() awaits loadStatusList() before showing modal
6. All API response handlers have defensive Array.isArray checks
7. No TypeScript or ESLint errors in either file
</success_criteria>

<output>
After completion, create `.planning/phases/34-critical-bug-fixes/34-02-SUMMARY.md`
</output>
