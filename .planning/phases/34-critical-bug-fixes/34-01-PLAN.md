---
phase: 34-critical-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/views/curate/ApproveUser.vue
autonomous: true

must_haves:
  truths:
    - "ApproveUser page loads without JavaScript errors"
    - "User table displays when API returns data"
    - "Modal shows fresh data when opened for different user"
    - "Component name appears as 'ApproveUser' in Vue DevTools"
  artifacts:
    - path: "app/src/views/curate/ApproveUser.vue"
      provides: "Fixed ApproveUser component with defensive patterns"
      contains: "name: 'ApproveUser'"
  key_links:
    - from: "ApproveUser.vue loadUserTableData()"
      to: "/api/user/table"
      via: "defensive Array.isArray check"
      pattern: "Array\\.isArray"
    - from: "ApproveUser.vue modal"
      to: "user selection"
      via: "@show event handler"
      pattern: "@show"
---

<objective>
Fix ApproveUser.vue critical bugs blocking curator onboarding

Purpose: ApproveUser page crashes with "TypeError: reduce is not a function" when API response format differs from expected. This blocks curator onboarding as admins cannot approve new users. Additionally, the modal shows stale data when reopened for a different user, and the component name is incorrect for debugging.

Output: Working ApproveUser page with defensive API handling, correct component name, and proper modal lifecycle
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/34-critical-bug-fixes/34-RESEARCH.md

Reference implementation (working defensive patterns):
@app/src/views/admin/ManageUser.vue

Component to fix:
@app/src/views/curate/ApproveUser.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add defensive API response handling to ApproveUser</name>
  <files>app/src/views/curate/ApproveUser.vue</files>
  <action>
Apply defensive programming patterns from ManageUser.vue to fix the crash:

1. **Fix `loadUserTableData()` method** (around line 228):
   - Add try/finally pattern to ensure `loadingUsersApprove = false` always runs
   - Add defensive check: validate `response.data` is an array before assignment
   - Handle both direct array and paginated wrapper formats
   - On unexpected format, log error and set empty state
   ```javascript
   async loadUserTableData() {
     this.loadingUsersApprove = true;
     const apiUrl = `${import.meta.env.VITE_API_URL}/api/user/table`;
     try {
       const response = await this.axios.get(apiUrl, {
         headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
       });
       const data = response.data;
       // Defensive check for both API formats
       if (Array.isArray(data)) {
         this.items_UsersTable = data;
         this.totalRows_UsersTable = data.length;
       } else if (data?.data && Array.isArray(data.data)) {
         this.items_UsersTable = data.data;
         this.totalRows_UsersTable = data.meta?.[0]?.totalItems || data.data.length;
       } else {
         console.error('Unexpected user table response format:', data);
         this.items_UsersTable = [];
         this.totalRows_UsersTable = 0;
       }
       const uiStore = useUiStore();
       uiStore.requestScrollbarUpdate();
     } catch (e) {
       this.makeToast(e, 'Error', 'danger');
       this.items_UsersTable = [];
       this.totalRows_UsersTable = 0;
     } finally {
       this.loadingUsersApprove = false;
     }
   }
   ```

2. **Fix `loadRoleList()` method** (around line 248):
   - Add defensive check before `.map()` call
   ```javascript
   const data = response.data;
   this.role_options = Array.isArray(data)
     ? data.map((item) => ({ value: item.role, text: item.role }))
     : [];
   ```

3. **Fix `loadUserList()` method** (around line 261):
   - Add defensive check before `.map()` call
   ```javascript
   const data = response.data;
   this.user_options = Array.isArray(data)
     ? data.map((item) => ({
         value: item.user_id,
         text: item.user_name,
         role: item.user_role,
       }))
     : [];
   ```

4. **Fix component name** (line 147):
   - Change `name: 'ApproveStatus'` to `name: 'ApproveUser'`
  </action>
  <verify>
Run TypeScript check:
```bash
cd /home/bernt-popp/development/sysndd/app && npm run type-check 2>&1 | grep -i "ApproveUser\|error" | head -20
```
Verify component name fixed:
```bash
grep -n "name:" /home/bernt-popp/development/sysndd/app/src/views/curate/ApproveUser.vue | head -3
```
Verify defensive patterns added:
```bash
grep -n "Array.isArray" /home/bernt-popp/development/sysndd/app/src/views/curate/ApproveUser.vue
```
  </verify>
  <done>
- `loadUserTableData()` has defensive Array.isArray check and try/finally pattern
- `loadRoleList()` validates response before map
- `loadUserList()` validates response before map
- Component name is 'ApproveUser'
- No TypeScript errors in ApproveUser.vue
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix modal data staleness with @show handler</name>
  <files>app/src/views/curate/ApproveUser.vue</files>
  <action>
Fix modal to reset and load fresh data when opened:

1. **Add @show event to modal** (around line 96):
   - Add `@show="prepareApproveUserModal"` alongside existing `@hide`
   ```vue
   <BModal
     :id="approveUserModal.id"
     size="lg"
     centered
     ok-title="Submit"
     no-close-on-esc
     no-close-on-backdrop
     header-bg-variant="dark"
     header-text-variant="light"
     @show="prepareApproveUserModal"
     @hide="resetUserApproveModal"
     @ok="handleUserApproveOk"
   >
   ```

2. **Add data property for selected user ID** (in data() around line 157):
   - Add `selectedUserId: null` to track which user is being approved

3. **Simplify `infoApproveUser` method** (around line 278):
   - Just set the selected ID and show modal, let @show handle the rest
   ```javascript
   infoApproveUser(item, index, button) {
     this.selectedUserId = item.user_id;
     const { showModal } = useModalControls();
     showModal(this.approveUserModal.id);
   }
   ```

4. **Add `prepareApproveUserModal` method**:
   - Reset stale data first
   - Then load fresh data for selected user
   ```javascript
   prepareApproveUserModal() {
     // Reset stale state
     this.approveUserModal.title = '';
     this.approve_user = null;
     this.user_approved = false;

     // Load fresh data for selected user
     if (this.selectedUserId) {
       const user = this.items_UsersTable.find(u => u.user_id === this.selectedUserId);
       if (user) {
         this.approveUserModal.title = user.user_name;
         this.approve_user = user;
       }
     }
   }
   ```

5. **Update `handleUserApproveOk`** (around line 294):
   - Change from array access `this.approve_user[0]` to direct object `this.approve_user`
   - Add null check
   ```javascript
   async handleUserApproveOk(bvModalEvt) {
     if (!this.approve_user) {
       this.makeToast('No user selected', 'Error', 'danger');
       return;
     }
     const apiUrl = `${import.meta.env.VITE_API_URL}/api/user/approval?user_id=${this.approve_user.user_id}&status_approval=${this.user_approved}`;
     // ... rest of method unchanged
   }
   ```

6. **Update `resetUserApproveModal`** (around line 285):
   - Add `selectedUserId: null` reset
   - Change `approve_user: []` to `approve_user: null`
   ```javascript
   resetUserApproveModal() {
     this.approveUserModal = {
       id: 'approve-usermodal',
       title: '',
       content: [],
     };
     this.selectedUserId = null;
     this.approve_user = null;
     this.user_approved = false;
   }
   ```

7. **Update data() `approve_user` initialization**:
   - Change from `approve_user: []` (if present) to not declaring it (let it be set as needed)
   - Or initialize as `approve_user: null`
  </action>
  <verify>
Verify @show handler added:
```bash
grep -n "@show" /home/bernt-popp/development/sysndd/app/src/views/curate/ApproveUser.vue
```
Verify method exists:
```bash
grep -n "prepareApproveUserModal" /home/bernt-popp/development/sysndd/app/src/views/curate/ApproveUser.vue
```
Run lint check:
```bash
cd /home/bernt-popp/development/sysndd/app && npm run lint -- --no-fix src/views/curate/ApproveUser.vue 2>&1 | tail -10
```
  </verify>
  <done>
- Modal has @show="prepareApproveUserModal" handler
- prepareApproveUserModal method resets state then loads fresh user data
- approve_user is now single object, not array
- handleUserApproveOk checks for null before accessing user_id
- No lint errors
  </done>
</task>

</tasks>

<verification>
All ApproveUser bugs fixed:

```bash
# Verify component name
grep "name: 'ApproveUser'" /home/bernt-popp/development/sysndd/app/src/views/curate/ApproveUser.vue

# Verify defensive patterns
grep -c "Array.isArray" /home/bernt-popp/development/sysndd/app/src/views/curate/ApproveUser.vue
# Expected: 3 or more (loadUserTableData, loadRoleList, loadUserList)

# Verify modal @show handler
grep "@show=\"prepareApproveUserModal\"" /home/bernt-popp/development/sysndd/app/src/views/curate/ApproveUser.vue

# Verify no TypeScript/lint errors
cd /home/bernt-popp/development/sysndd/app && npm run lint -- --no-fix src/views/curate/ApproveUser.vue
```
</verification>

<success_criteria>
1. ApproveUser.vue has `name: 'ApproveUser'` (not 'ApproveStatus')
2. `loadUserTableData()` defensively handles both array and paginated response formats
3. `loadRoleList()` and `loadUserList()` validate response before `.map()`
4. Modal has `@show` handler that resets state before loading fresh data
5. `handleUserApproveOk()` uses single user object with null check
6. No TypeScript or ESLint errors
</success_criteria>

<output>
After completion, create `.planning/phases/34-critical-bug-fixes/34-01-SUMMARY.md`
</output>
