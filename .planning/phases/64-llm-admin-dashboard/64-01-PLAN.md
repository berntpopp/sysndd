---
phase: 64-llm-admin-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/endpoints/llm_admin_endpoints.R
  - api/functions/llm-cache-repository.R
  - api/start_sysndd_api.R
autonomous: true

must_haves:
  truths:
    - "Admin can GET /api/llm/config to see model configuration"
    - "Admin can PUT /api/llm/config to change model selection"
    - "Admin can GET /api/llm/cache/stats to see cache statistics"
    - "Admin can GET /api/llm/cache/summaries with pagination and filters"
    - "Admin can DELETE /api/llm/cache to clear cache"
    - "Admin can POST /api/llm/regenerate to trigger batch regeneration"
    - "Admin can GET /api/llm/logs to view generation logs"
    - "Admin can POST /api/llm/cache/:id/validate to manually validate summaries"
    - "All endpoints require Administrator role"
  artifacts:
    - path: "api/endpoints/llm_admin_endpoints.R"
      provides: "All LLM admin API endpoints"
      exports: ["GET /config", "PUT /config", "GET /cache/stats", "GET /cache/summaries", "DELETE /cache", "POST /regenerate", "GET /logs", "POST /cache/:id/validate"]
    - path: "api/functions/llm-cache-repository.R"
      provides: "Extended cache query functions"
      exports: ["get_cache_statistics", "get_cached_summaries_paginated", "clear_llm_cache", "get_generation_logs_paginated"]
    - path: "api/start_sysndd_api.R"
      provides: "Router mount for /api/llm"
      contains: "pr_mount.*llm"
  key_links:
    - from: "api/endpoints/llm_admin_endpoints.R"
      to: "api/functions/llm-cache-repository.R"
      via: "function calls"
      pattern: "get_cache_statistics|get_cached_summaries_paginated|clear_llm_cache"
    - from: "api/endpoints/llm_admin_endpoints.R"
      to: "api/functions/llm-batch-generator.R"
      via: "function call for regeneration"
      pattern: "trigger_llm_batch_generation"
    - from: "api/start_sysndd_api.R"
      to: "api/endpoints/llm_admin_endpoints.R"
      via: "pr_mount"
      pattern: 'pr_mount.*api/llm.*llm_admin_endpoints'
---

<objective>
Create backend API endpoints for LLM administration

Purpose: Expose existing LLM cache and service functionality through admin-only API endpoints, enabling frontend dashboard to manage LLM configuration, cache, and logs.

Output: Complete REST API at /api/llm/* with config, cache, logs, and regeneration endpoints
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-llm-admin-dashboard/64-RESEARCH.md
@.planning/LLM_ADMIN_DASHBOARD_PLAN.md
@api/endpoints/admin_endpoints.R (authorization pattern)
@api/functions/llm-cache-repository.R (extend with admin queries)
@api/functions/llm-service.R (LLM service patterns)
@api/functions/job-manager.R (async job pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend llm-cache-repository.R with admin query functions</name>
  <files>api/functions/llm-cache-repository.R</files>
  <action>
Add the following functions to llm-cache-repository.R:

1. **get_cache_statistics()** - Returns aggregate stats for dashboard:
   - Total entries, by_status (pending/validated/rejected), by_type (functional/phenotype)
   - Last generation timestamp, total tokens used, estimated cost USD
   - Query llm_cluster_summary_cache WHERE is_current = TRUE
   - Query llm_generation_log for token totals (status = 'success')
   - Cost estimate: $0.075/1M input + $0.30/1M output (Gemini 2.0 Flash)
   - Use %||% operator for NULL handling

2. **get_cached_summaries_paginated()** - Paginated cache browser:
   - Parameters: cluster_type (NULL = all), validation_status (NULL = all), page (1-indexed), per_page (default 20)
   - Build WHERE clause dynamically with parameterized queries
   - Return list(data = tibble, total = count, page = page, per_page = per_page)
   - Order by created_at DESC

3. **clear_llm_cache()** - Delete cache entries:
   - Parameter: cluster_type ('all', 'functional', 'phenotype')
   - Use db_with_transaction for atomicity
   - If cluster_type == 'all', DELETE FROM llm_cluster_summary_cache
   - Otherwise DELETE WHERE cluster_type = ?
   - Return list(count = affected_rows)

4. **get_generation_logs_paginated()** - Paginated log viewer:
   - Parameters: cluster_type, status, from_date, to_date, page, per_page (default 50)
   - Build WHERE clause dynamically
   - Date filters: created_at >= from_date, created_at <= to_date
   - Order by created_at DESC
   - Return list(data = tibble, total = count, page = page)

Follow existing patterns in the file for NULL handling (convert to NA_character_), logging, and db_execute_query usage.
  </action>
  <verify>
Run: cd /home/bernt-popp/development/sysndd/api && Rscript -e "source('functions/llm-cache-repository.R'); print(exists('get_cache_statistics')); print(exists('get_cached_summaries_paginated')); print(exists('clear_llm_cache')); print(exists('get_generation_logs_paginated'))"
All should return TRUE.
  </verify>
  <done>
Four new functions (get_cache_statistics, get_cached_summaries_paginated, clear_llm_cache, get_generation_logs_paginated) exist and can be sourced without error.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create llm_admin_endpoints.R with all admin endpoints</name>
  <files>api/endpoints/llm_admin_endpoints.R</files>
  <action>
Create new file api/endpoints/llm_admin_endpoints.R with these endpoints:

**File header:**
```r
# api/endpoints/llm_admin_endpoints.R
#
# LLM Administration endpoints for managing configuration, prompts, cache, and logs.
# All endpoints require Administrator role.
```

**Endpoints to implement:**

1. **GET /config** - Get LLM configuration
   - require_role(req, res, "Administrator")
   - Return: gemini_configured (is_gemini_configured()), current_model (get_default_gemini_model()), available_models (list_gemini_models()), rate_limit (GEMINI_RATE_LIMIT)
   - Source llm-service.R functions

2. **PUT /config** - Update model selection
   - require_role(req, res, "Administrator")
   - Parameter: model (string)
   - Validate against available_models$model_id
   - If valid: Sys.setenv(GEMINI_MODEL = model) - session-only, not persisted
   - Return 400 if invalid model, success message if valid

3. **GET /cache/stats** - Get cache statistics
   - require_role(req, res, "Administrator")
   - Call get_cache_statistics() from llm-cache-repository.R
   - Return the statistics object

4. **GET /cache/summaries** - Get cached summaries paginated
   - require_role(req, res, "Administrator")
   - Parameters: cluster_type, validation_status, page (default 1), per_page (default 20)
   - Call get_cached_summaries_paginated() with params
   - Convert page/per_page to integer

5. **DELETE /cache** - Clear cache
   - require_role(req, res, "Administrator")
   - Parameter: cluster_type (default 'all')
   - Call clear_llm_cache(cluster_type)
   - Return success + cleared_count

6. **POST /regenerate** - Trigger regeneration job
   - require_role(req, res, "Administrator")
   - Check is_gemini_configured() first, return 503 if not
   - Parameters: cluster_type (default 'all'), force (default FALSE)
   - Pre-fetch cluster data from database (pool not available in daemon)
   - Use create_job() with operation = "llm_regenerate"
   - Set timeout_ms = 7200000 (2 hours)
   - Executor function: call trigger_llm_batch_generation() with appropriate args
   - Return 202 Accepted with job_id and status_url

7. **GET /logs** - Get generation logs paginated
   - require_role(req, res, "Administrator")
   - Parameters: cluster_type, status, from_date, to_date, page, per_page
   - Call get_generation_logs_paginated() with params

8. **POST /cache/:cache_id/validate** - Manual validation
   - require_role(req, res, "Administrator")
   - Parameters: cache_id (path), action ('validate' or 'reject')
   - Get user_id from token via get_user_id_from_token(req)
   - Call update_validation_status(cache_id, status, validated_by)
   - Return success message

**Plumber annotations:**
- Use @tag llm-admin for all endpoints
- Use @serializer json for responses
- Document parameters with @param annotations
  </action>
  <verify>
Run: cd /home/bernt-popp/development/sysndd/api && Rscript -e "library(plumber); pr <- pr('endpoints/llm_admin_endpoints.R'); print(length(pr\$endpoints[[1]]))"
Should output number > 0 (endpoints parsed successfully).
  </verify>
  <done>
llm_admin_endpoints.R exists with 8 endpoints, can be parsed by Plumber without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Mount LLM admin router and run linting</name>
  <files>api/start_sysndd_api.R</files>
  <action>
1. **Update start_sysndd_api.R** to mount the LLM admin endpoints:
   - Find the pr_mount chain (around line 589-620)
   - Add after the existing mounts: pr_mount("/api/llm", pr("endpoints/llm_admin_endpoints.R")) %>%
   - Place it logically near other admin endpoints (after /api/admin or /api/statistics)

2. **Run R linting** to verify code quality:
   - Run: cd /home/bernt-popp/development/sysndd && make lint-api
   - Fix any lintr issues (line length, naming, spacing)
   - Focus on new code in llm-cache-repository.R and llm_admin_endpoints.R

3. **Verify API starts** without errors:
   - The pr() constructor should parse all endpoints successfully
   - Check that required functions (is_gemini_configured, list_gemini_models, etc.) are available
  </action>
  <verify>
Run: cd /home/bernt-popp/development/sysndd && make lint-api
Should complete with no errors. Check that start_sysndd_api.R contains "/api/llm" mount.
  </verify>
  <done>
LLM admin endpoints mounted at /api/llm, R linter passes with no errors, API can parse all endpoints.
  </done>
</task>

</tasks>

<verification>
1. All 4 new cache repository functions exist and source without error
2. llm_admin_endpoints.R parses successfully with Plumber
3. /api/llm mount added to start_sysndd_api.R
4. R linting passes (make lint-api)
5. No existing tests broken
</verification>

<success_criteria>
- GET /api/llm/config endpoint returns model configuration (require auth)
- PUT /api/llm/config endpoint accepts model parameter (require auth)
- GET /api/llm/cache/stats returns aggregate statistics
- GET /api/llm/cache/summaries supports pagination and filtering
- DELETE /api/llm/cache clears cache entries
- POST /api/llm/regenerate creates async job and returns job_id
- GET /api/llm/logs returns paginated generation logs
- POST /api/llm/cache/:id/validate updates validation status
- All endpoints return 403 for non-admin users
- R linting passes
</success_criteria>

<output>
After completion, create `.planning/phases/64-llm-admin-dashboard/64-01-SUMMARY.md`
</output>
