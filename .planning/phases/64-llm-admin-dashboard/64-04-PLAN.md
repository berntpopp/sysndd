---
phase: 64-llm-admin-dashboard
plan: 04
type: execute
wave: 2
depends_on: ["64-02", "64-03"]
files_modified:
  - app/src/views/admin/ManageLLM.vue
  - app/src/components/llm/LlmConfigPanel.vue
  - app/src/components/llm/LlmPromptEditor.vue
  - app/src/components/llm/LlmCacheManager.vue
  - app/src/components/llm/LlmLogViewer.vue
  - app/src/components/TheHeader.vue
autonomous: false

must_haves:
  truths:
    - "Admin can navigate to ManageLLM from header menu"
    - "Overview tab shows cache statistics (total, validated, pending, cost)"
    - "Configuration tab shows current model and allows changing"
    - "Prompts tab shows all 4 prompt templates with editing"
    - "Cache tab shows cached summaries with validation actions"
    - "Logs tab shows paginated generation logs with filters"
    - "Regeneration button triggers async job with progress"
    - "All data refreshes when Refresh button clicked"
  artifacts:
    - path: "app/src/views/admin/ManageLLM.vue"
      provides: "Main LLM admin view with tabs"
      min_lines: 200
    - path: "app/src/components/llm/LlmConfigPanel.vue"
      provides: "Model configuration panel"
      min_lines: 80
    - path: "app/src/components/llm/LlmPromptEditor.vue"
      provides: "Prompt template editor"
      min_lines: 120
    - path: "app/src/components/llm/LlmCacheManager.vue"
      provides: "Cache management with validation"
      min_lines: 200
    - path: "app/src/components/llm/LlmLogViewer.vue"
      provides: "Generation log viewer"
      min_lines: 150
  key_links:
    - from: "app/src/views/admin/ManageLLM.vue"
      to: "app/src/composables/useLlmAdmin.ts"
      via: "composable import"
      pattern: "useLlmAdmin"
    - from: "app/src/components/TheHeader.vue"
      to: "app/src/views/admin/ManageLLM.vue"
      via: "router-link"
      pattern: "ManageLLM"
---

<objective>
Create LLM admin dashboard UI components

Purpose: Build the complete admin interface for managing LLM configuration, prompts, cache, and logs, using Bootstrap-Vue-Next components and the useLlmAdmin composable.

Output: ManageLLM.vue main view with 5 tabs, 4 sub-components, and navigation menu link
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-llm-admin-dashboard/64-RESEARCH.md
@.planning/LLM_ADMIN_DASHBOARD_PLAN.md
@app/src/views/admin/ManageAnnotations.vue (admin view pattern)
@app/src/composables/useAsyncJob.ts (job tracking pattern)
@app/src/composables/useLlmAdmin.ts (API composable from Plan 03)
@app/src/types/llm.ts (types from Plan 03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ManageLLM.vue main admin view</name>
  <files>app/src/views/admin/ManageLLM.vue</files>
  <action>
Create app/src/views/admin/ManageLLM.vue following ManageAnnotations.vue pattern:

```vue
<template>
  <BContainer fluid>
    <BRow class="justify-content-md-center py-2">
      <BCol col md="12">
        <!-- Header Card -->
        <BCard header-tag="header" body-class="p-0" header-class="p-2">
          <template #header>
            <BRow class="align-items-center">
              <BCol>
                <h5 class="mb-0 text-start fw-bold">
                  LLM Administration
                  <BBadge
                    v-if="config && !config.gemini_configured"
                    variant="warning"
                    class="ms-2"
                  >
                    Not Configured
                  </BBadge>
                  <BBadge
                    v-else-if="config"
                    variant="success"
                    class="ms-2"
                  >
                    {{ config.current_model }}
                  </BBadge>
                </h5>
              </BCol>
              <BCol class="text-end">
                <BButton
                  variant="outline-primary"
                  size="sm"
                  :disabled="loading"
                  @click="refreshAll"
                >
                  <BSpinner v-if="loading" small class="me-1" />
                  Refresh
                </BButton>
              </BCol>
            </BRow>
          </template>

          <!-- Tab Navigation -->
          <BTabs v-model="activeTab" pills card nav-class="px-3 pt-2">
            <!-- Overview Tab -->
            <BTab title="Overview">
              <BRow class="g-3 mb-4">
                <BCol md="3">
                  <BCard class="text-center h-100">
                    <div class="h2 mb-0">{{ cacheStats?.total_entries ?? 0 }}</div>
                    <small class="text-muted">Total Summaries</small>
                  </BCard>
                </BCol>
                <BCol md="3">
                  <BCard class="text-center h-100 border-success">
                    <div class="h2 mb-0 text-success">
                      {{ cacheStats?.by_status?.validated ?? 0 }}
                    </div>
                    <small class="text-muted">Validated</small>
                  </BCard>
                </BCol>
                <BCol md="3">
                  <BCard class="text-center h-100 border-warning">
                    <div class="h2 mb-0 text-warning">
                      {{ cacheStats?.by_status?.pending ?? 0 }}
                    </div>
                    <small class="text-muted">Pending Review</small>
                  </BCard>
                </BCol>
                <BCol md="3">
                  <BCard class="text-center h-100">
                    <div class="h2 mb-0">
                      ${{ (cacheStats?.estimated_cost_usd ?? 0).toFixed(2) }}
                    </div>
                    <small class="text-muted">Est. Cost (USD)</small>
                  </BCard>
                </BCol>
              </BRow>

              <!-- Quick Actions -->
              <BCard class="mb-4">
                <template #header>
                  <h6 class="mb-0">Quick Actions</h6>
                </template>
                <BRow class="g-2">
                  <BCol md="4">
                    <BButton
                      variant="outline-danger"
                      class="w-100"
                      :disabled="!config?.gemini_configured || regenerationJob.isRunning.value"
                      @click="showClearModal = true"
                    >
                      Clear Cache & Regenerate
                    </BButton>
                  </BCol>
                  <BCol md="4">
                    <BButton
                      variant="outline-primary"
                      class="w-100"
                      :disabled="!config?.gemini_configured || regenerationJob.isRunning.value"
                      @click="handleRegenerate('functional')"
                    >
                      Regenerate Functional
                    </BButton>
                  </BCol>
                  <BCol md="4">
                    <BButton
                      variant="outline-primary"
                      class="w-100"
                      :disabled="!config?.gemini_configured || regenerationJob.isRunning.value"
                      @click="handleRegenerate('phenotype')"
                    >
                      Regenerate Phenotype
                    </BButton>
                  </BCol>
                </BRow>
              </BCard>

              <!-- Active Job Progress -->
              <BCard v-if="regenerationJob.isRunning.value" class="mb-4">
                <template #header>
                  <h6 class="mb-0">Regeneration in Progress</h6>
                </template>
                <BProgress
                  :value="regenerationJob.progressPercent.value"
                  :max="100"
                  show-progress
                  animated
                />
                <div class="mt-2 text-muted small">
                  {{ regenerationJob.statusMessage.value }}
                  <span class="float-end">{{ regenerationJob.elapsedTimeDisplay.value }}</span>
                </div>
              </BCard>
            </BTab>

            <!-- Configuration Tab -->
            <BTab title="Configuration">
              <LlmConfigPanel
                :config="config"
                :loading="loading"
                @update-model="handleModelUpdate"
              />
            </BTab>

            <!-- Prompts Tab -->
            <BTab title="Prompts">
              <LlmPromptEditor
                :prompts="prompts"
                :loading="loading"
                @save="handlePromptSave"
              />
            </BTab>

            <!-- Cache Tab -->
            <BTab title="Cache">
              <LlmCacheManager
                :stats="cacheStats"
                @clear="handleCacheClear"
                @validate="handleValidate"
                @regenerate="handleRegenerate"
              />
            </BTab>

            <!-- Logs Tab -->
            <BTab title="Logs">
              <LlmLogViewer />
            </BTab>
          </BTabs>
        </BCard>
      </BCol>
    </BRow>

    <!-- Clear Cache Confirmation Modal -->
    <BModal v-model="showClearModal" title="Clear Cache & Regenerate" ok-variant="danger">
      <template #default>
        <p>This will:</p>
        <ol>
          <li>Delete all cached LLM summaries</li>
          <li>Trigger regeneration for all clusters</li>
          <li>This may take several minutes and incur API costs</li>
        </ol>
        <BFormGroup label="Clear which clusters?">
          <BFormRadioGroup v-model="clearType" :options="clearOptions" stacked />
        </BFormGroup>
      </template>
      <template #footer>
        <BButton variant="secondary" @click="showClearModal = false">Cancel</BButton>
        <BButton variant="danger" @click="handleClearAndRegenerate">
          Clear & Regenerate
        </BButton>
      </template>
    </BModal>
  </BContainer>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { useAuth } from '@/composables/useAuth';
import { useLlmAdmin } from '@/composables/useLlmAdmin';
import { useAsyncJob } from '@/composables/useAsyncJob';
import { useToast } from '@/composables/useToast';
import LlmConfigPanel from '@/components/llm/LlmConfigPanel.vue';
import LlmPromptEditor from '@/components/llm/LlmPromptEditor.vue';
import LlmCacheManager from '@/components/llm/LlmCacheManager.vue';
import LlmLogViewer from '@/components/llm/LlmLogViewer.vue';
import type { PromptType, ClusterType } from '@/types/llm';

const { getToken } = useAuth();
const { showToast } = useToast();
const {
  config,
  prompts,
  cacheStats,
  loading,
  fetchConfig,
  fetchPrompts,
  fetchCacheStats,
  updateModel,
  updatePrompt,
  clearCache,
  triggerRegeneration,
  updateValidationStatus,
} = useLlmAdmin();

// Async job tracking for regeneration
const regenerationJob = useAsyncJob(
  (jobId) => `${import.meta.env.VITE_API_URL}/api/jobs/${jobId}/status`
);

// Local state
const activeTab = ref(0);
const showClearModal = ref(false);
const clearType = ref<ClusterType | 'all'>('all');

const clearOptions = [
  { text: 'All clusters', value: 'all' },
  { text: 'Functional clusters only', value: 'functional' },
  { text: 'Phenotype clusters only', value: 'phenotype' },
];

// Lifecycle
onMounted(async () => {
  await refreshAll();
});

// Methods
async function refreshAll() {
  const token = await getToken();
  if (!token) return;

  try {
    await Promise.all([
      fetchConfig(token),
      fetchPrompts(token),
      fetchCacheStats(token),
    ]);
  } catch {
    showToast('Failed to load LLM configuration', 'Error', 'danger');
  }
}

async function handleModelUpdate(model: string) {
  const token = await getToken();
  if (!token) return;

  try {
    await updateModel(token, model);
    showToast(`Model updated to ${model}`, 'Success', 'success');
  } catch {
    showToast('Failed to update model', 'Error', 'danger');
  }
}

async function handlePromptSave(type: PromptType, template: string, version: string) {
  const token = await getToken();
  if (!token) return;

  try {
    await updatePrompt(token, type, template, version);
    showToast('Prompt template saved', 'Success', 'success');
    await fetchPrompts(token);
  } catch {
    showToast('Failed to save prompt', 'Error', 'danger');
  }
}

async function handleCacheClear(type: ClusterType | 'all') {
  const token = await getToken();
  if (!token) return;

  try {
    const result = await clearCache(token, type);
    showToast(`Cleared ${result.cleared_count} cached summaries`, 'Success', 'success');
    await fetchCacheStats(token);
  } catch {
    showToast('Failed to clear cache', 'Error', 'danger');
  }
}

async function handleRegenerate(type: ClusterType | 'all', force = false) {
  const token = await getToken();
  if (!token) return;

  try {
    const result = await triggerRegeneration(token, type, force);
    regenerationJob.startJob(result.job_id, () => {
      showToast('Regeneration complete', 'Success', 'success');
      refreshAll();
    });
    showToast('Regeneration job started', 'Info', 'info');
  } catch {
    showToast('Failed to start regeneration', 'Error', 'danger');
  }
}

async function handleClearAndRegenerate() {
  showClearModal.value = false;
  await handleCacheClear(clearType.value);
  await handleRegenerate(clearType.value, true);
}

async function handleValidate(cacheId: number, action: 'validate' | 'reject') {
  const token = await getToken();
  if (!token) return;

  try {
    await updateValidationStatus(token, cacheId, action);
    showToast(`Summary ${action}d successfully`, 'Success', 'success');
    await fetchCacheStats(token);
  } catch {
    showToast(`Failed to ${action} summary`, 'Error', 'danger');
  }
}
</script>
```
  </action>
  <verify>
File exists at app/src/views/admin/ManageLLM.vue
  </verify>
  <done>
ManageLLM.vue created with 5 tabs (Overview, Configuration, Prompts, Cache, Logs), job tracking, and modal dialogs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create LlmConfigPanel and LlmPromptEditor components</name>
  <files>
    app/src/components/llm/LlmConfigPanel.vue
    app/src/components/llm/LlmPromptEditor.vue
  </files>
  <action>
Create app/src/components/llm/ directory if not exists.

**LlmConfigPanel.vue:**
```vue
<template>
  <BCard>
    <template #header>
      <h6 class="mb-0">Model Configuration</h6>
    </template>

    <BAlert v-if="!config?.gemini_configured" variant="warning" :model-value="true">
      <strong>Gemini API not configured.</strong>
      Set the <code>GEMINI_API_KEY</code> environment variable to enable LLM features.
    </BAlert>

    <BForm v-else @submit.prevent>
      <BFormGroup label="Current Model" label-for="model-select">
        <BFormSelect
          id="model-select"
          v-model="selectedModel"
          :options="modelOptions"
          :disabled="loading"
          @change="handleModelChange"
        />
        <BFormText v-if="selectedModelInfo">
          {{ selectedModelInfo.description }}
          <br />
          <small class="text-muted">
            Rate limit: {{ selectedModelInfo.rpm_limit }} RPM
            <span v-if="selectedModelInfo.rpd_limit">
              , {{ selectedModelInfo.rpd_limit }} RPD
            </span>
          </small>
        </BFormText>
      </BFormGroup>

      <BFormGroup label="Rate Limiting" class="mt-4">
        <BRow>
          <BCol md="6">
            <BFormGroup label="Capacity (requests)" label-size="sm">
              <BFormInput
                :model-value="config?.rate_limit?.capacity"
                type="number"
                disabled
                size="sm"
              />
            </BFormGroup>
          </BCol>
          <BCol md="6">
            <BFormGroup label="Window (seconds)" label-size="sm">
              <BFormInput
                :model-value="config?.rate_limit?.fill_time_s"
                type="number"
                disabled
                size="sm"
              />
            </BFormGroup>
          </BCol>
        </BRow>
        <BFormText>
          Rate limiting is configured in the API. Edit
          <code>llm-service.R</code> to change.
        </BFormText>
      </BFormGroup>
    </BForm>
  </BCard>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue';
import type { LlmConfig } from '@/types/llm';

const props = defineProps<{
  config: LlmConfig | null;
  loading: boolean;
}>();

const emit = defineEmits<{
  (e: 'update-model', model: string): void;
}>();

const selectedModel = ref(props.config?.current_model || '');

watch(
  () => props.config?.current_model,
  (newVal) => {
    if (newVal) selectedModel.value = newVal;
  }
);

const modelOptions = computed(() =>
  props.config?.available_models?.map((m) => ({
    value: m.model_id,
    text: `${m.display_name} - ${m.recommended_for}`,
  })) ?? []
);

const selectedModelInfo = computed(() =>
  props.config?.available_models?.find((m) => m.model_id === selectedModel.value)
);

function handleModelChange() {
  emit('update-model', selectedModel.value);
}
</script>
```

**LlmPromptEditor.vue:**
```vue
<template>
  <BCard>
    <template #header>
      <BRow class="align-items-center">
        <BCol>
          <h6 class="mb-0">Prompt Templates</h6>
        </BCol>
        <BCol class="text-end">
          <BFormSelect
            v-model="selectedPrompt"
            :options="promptOptions"
            size="sm"
            class="w-auto"
          />
        </BCol>
      </BRow>
    </template>

    <div v-if="currentPrompt">
      <BFormGroup :label="`${promptLabels[selectedPrompt]} Prompt`">
        <BFormTextarea
          v-model="editedTemplate"
          rows="20"
          class="font-monospace"
          :disabled="loading"
        />
      </BFormGroup>

      <BRow class="align-items-center">
        <BCol>
          <BFormGroup label="Version" label-cols="auto" class="mb-0">
            <BFormInput v-model="editedVersion" size="sm" class="w-auto" />
          </BFormGroup>
        </BCol>
        <BCol class="text-end">
          <BButton
            variant="secondary"
            size="sm"
            class="me-2"
            :disabled="!hasChanges"
            @click="resetPrompt"
          >
            Reset
          </BButton>
          <BButton
            variant="primary"
            size="sm"
            :disabled="!hasChanges || loading"
            @click="savePrompt"
          >
            Save Changes
          </BButton>
        </BCol>
      </BRow>
    </div>
  </BCard>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue';
import type { PromptTemplates, PromptType } from '@/types/llm';

const props = defineProps<{
  prompts: PromptTemplates | null;
  loading: boolean;
}>();

const emit = defineEmits<{
  (e: 'save', type: PromptType, template: string, version: string): void;
}>();

const selectedPrompt = ref<PromptType>('functional_generation');
const editedTemplate = ref('');
const editedVersion = ref('');

const promptOptions = [
  { value: 'functional_generation', text: 'Functional - Generation' },
  { value: 'functional_judge', text: 'Functional - Judge' },
  { value: 'phenotype_generation', text: 'Phenotype - Generation' },
  { value: 'phenotype_judge', text: 'Phenotype - Judge' },
];

const promptLabels: Record<PromptType, string> = {
  functional_generation: 'Functional Cluster Generation',
  functional_judge: 'Functional Cluster Validation',
  phenotype_generation: 'Phenotype Cluster Generation',
  phenotype_judge: 'Phenotype Cluster Validation',
};

const currentPrompt = computed(() => props.prompts?.[selectedPrompt.value]);

watch(
  [selectedPrompt, () => props.prompts],
  () => {
    if (currentPrompt.value) {
      editedTemplate.value = currentPrompt.value.template_text;
      editedVersion.value = currentPrompt.value.version;
    }
  },
  { immediate: true }
);

const hasChanges = computed(() => {
  if (!currentPrompt.value) return false;
  return (
    editedTemplate.value !== currentPrompt.value.template_text ||
    editedVersion.value !== currentPrompt.value.version
  );
});

function resetPrompt() {
  if (currentPrompt.value) {
    editedTemplate.value = currentPrompt.value.template_text;
    editedVersion.value = currentPrompt.value.version;
  }
}

function savePrompt() {
  emit('save', selectedPrompt.value, editedTemplate.value, editedVersion.value);
}
</script>
```
  </action>
  <verify>
Files exist at app/src/components/llm/LlmConfigPanel.vue and app/src/components/llm/LlmPromptEditor.vue
  </verify>
  <done>
LlmConfigPanel.vue and LlmPromptEditor.vue created with proper TypeScript types and emit patterns.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create LlmCacheManager and LlmLogViewer components</name>
  <files>
    app/src/components/llm/LlmCacheManager.vue
    app/src/components/llm/LlmLogViewer.vue
  </files>
  <action>
**LlmCacheManager.vue:**
```vue
<template>
  <div>
    <!-- Stats Summary -->
    <BRow class="g-3 mb-4">
      <BCol md="6">
        <BCard>
          <template #header>
            <h6 class="mb-0">Functional Clusters</h6>
          </template>
          <div class="d-flex justify-content-around text-center">
            <div>
              <div class="h4 mb-0">{{ stats?.by_type?.functional?.count ?? 0 }}</div>
              <small class="text-muted">Total</small>
            </div>
            <div>
              <div class="h4 mb-0 text-success">
                {{ stats?.by_type?.functional?.validated ?? 0 }}
              </div>
              <small class="text-muted">Validated</small>
            </div>
            <div>
              <div class="h4 mb-0 text-warning">
                {{ stats?.by_type?.functional?.pending ?? 0 }}
              </div>
              <small class="text-muted">Pending</small>
            </div>
          </div>
          <template #footer>
            <BButtonGroup size="sm" class="w-100">
              <BButton variant="outline-danger" @click="$emit('clear', 'functional')">
                Clear
              </BButton>
              <BButton variant="outline-primary" @click="$emit('regenerate', 'functional')">
                Regenerate
              </BButton>
            </BButtonGroup>
          </template>
        </BCard>
      </BCol>
      <BCol md="6">
        <BCard>
          <template #header>
            <h6 class="mb-0">Phenotype Clusters</h6>
          </template>
          <div class="d-flex justify-content-around text-center">
            <div>
              <div class="h4 mb-0">{{ stats?.by_type?.phenotype?.count ?? 0 }}</div>
              <small class="text-muted">Total</small>
            </div>
            <div>
              <div class="h4 mb-0 text-success">
                {{ stats?.by_type?.phenotype?.validated ?? 0 }}
              </div>
              <small class="text-muted">Validated</small>
            </div>
            <div>
              <div class="h4 mb-0 text-warning">
                {{ stats?.by_type?.phenotype?.pending ?? 0 }}
              </div>
              <small class="text-muted">Pending</small>
            </div>
          </div>
          <template #footer>
            <BButtonGroup size="sm" class="w-100">
              <BButton variant="outline-danger" @click="$emit('clear', 'phenotype')">
                Clear
              </BButton>
              <BButton variant="outline-primary" @click="$emit('regenerate', 'phenotype')">
                Regenerate
              </BButton>
            </BButtonGroup>
          </template>
        </BCard>
      </BCol>
    </BRow>

    <!-- Cached Summaries Table -->
    <BCard>
      <template #header>
        <BRow class="align-items-center">
          <BCol>
            <h6 class="mb-0">Cached Summaries</h6>
          </BCol>
          <BCol md="3">
            <BFormSelect
              v-model="filters.cluster_type"
              :options="typeOptions"
              size="sm"
              @change="loadSummaries"
            />
          </BCol>
          <BCol md="3">
            <BFormSelect
              v-model="filters.validation_status"
              :options="statusOptions"
              size="sm"
              @change="loadSummaries"
            />
          </BCol>
        </BRow>
      </template>

      <BTable :items="summaries" :fields="fields" :busy="loading" responsive hover small>
        <template #cell(cluster_type)="data">
          <BBadge :variant="data.value === 'functional' ? 'primary' : 'info'">
            {{ data.value }}
          </BBadge>
        </template>
        <template #cell(validation_status)="data">
          <BBadge :variant="statusVariant(data.value)">
            {{ data.value }}
          </BBadge>
        </template>
        <template #cell(actions)="data">
          <BButtonGroup size="sm">
            <BButton
              v-if="data.item.validation_status === 'pending'"
              variant="outline-success"
              @click="$emit('validate', data.item.cache_id, 'validate')"
            >
              Approve
            </BButton>
            <BButton
              v-if="data.item.validation_status === 'pending'"
              variant="outline-danger"
              @click="$emit('validate', data.item.cache_id, 'reject')"
            >
              Reject
            </BButton>
            <BButton variant="outline-secondary" @click="viewDetails(data.item)">
              View
            </BButton>
          </BButtonGroup>
        </template>
      </BTable>

      <!-- Pagination -->
      <BRow class="mt-3">
        <BCol>
          <BPagination
            v-model="page"
            :total-rows="totalRows"
            :per-page="perPage"
            size="sm"
            @update:model-value="loadSummaries"
          />
        </BCol>
        <BCol class="text-end text-muted small">
          Showing {{ summaries.length }} of {{ totalRows }} summaries
        </BCol>
      </BRow>
    </BCard>

    <!-- Summary Detail Modal -->
    <BModal v-model="showDetailModal" size="lg" :title="`Summary #${selectedSummary?.cache_id}`">
      <pre v-if="selectedSummary" class="bg-light p-3 rounded overflow-auto" style="max-height: 60vh">{{
        JSON.stringify(selectedSummary.summary_json, null, 2)
      }}</pre>
    </BModal>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue';
import { useAuth } from '@/composables/useAuth';
import { useLlmAdmin } from '@/composables/useLlmAdmin';
import type { CacheStats, CachedSummary, ClusterType, ValidationStatus } from '@/types/llm';

defineProps<{
  stats: CacheStats | null;
}>();

defineEmits<{
  (e: 'clear', type: ClusterType): void;
  (e: 'validate', cacheId: number, action: 'validate' | 'reject'): void;
  (e: 'regenerate', type: ClusterType): void;
}>();

const { getToken } = useAuth();
const { fetchCachedSummaries } = useLlmAdmin();

const summaries = ref<CachedSummary[]>([]);
const loading = ref(false);
const page = ref(1);
const perPage = ref(20);
const totalRows = ref(0);
const showDetailModal = ref(false);
const selectedSummary = ref<CachedSummary | null>(null);

const filters = reactive({
  cluster_type: undefined as ClusterType | undefined,
  validation_status: undefined as ValidationStatus | undefined,
});

const typeOptions = [
  { value: undefined, text: 'All Types' },
  { value: 'functional', text: 'Functional' },
  { value: 'phenotype', text: 'Phenotype' },
];

const statusOptions = [
  { value: undefined, text: 'All Statuses' },
  { value: 'validated', text: 'Validated' },
  { value: 'pending', text: 'Pending' },
  { value: 'rejected', text: 'Rejected' },
];

const fields = [
  { key: 'cache_id', label: 'ID', sortable: true },
  { key: 'cluster_type', label: 'Type', sortable: true },
  { key: 'cluster_number', label: 'Cluster #', sortable: true },
  { key: 'model_name', label: 'Model', sortable: true },
  { key: 'validation_status', label: 'Status', sortable: true },
  { key: 'created_at', label: 'Created', sortable: true },
  { key: 'actions', label: 'Actions' },
];

function statusVariant(status: string) {
  switch (status) {
    case 'validated':
      return 'success';
    case 'pending':
      return 'warning';
    case 'rejected':
      return 'danger';
    default:
      return 'secondary';
  }
}

function viewDetails(summary: CachedSummary) {
  selectedSummary.value = summary;
  showDetailModal.value = true;
}

async function loadSummaries() {
  const token = await getToken();
  if (!token) return;

  loading.value = true;
  try {
    const result = await fetchCachedSummaries(token, {
      cluster_type: filters.cluster_type,
      validation_status: filters.validation_status,
      page: page.value,
      per_page: perPage.value,
    });
    summaries.value = result.data;
    totalRows.value = result.total;
  } finally {
    loading.value = false;
  }
}

onMounted(() => loadSummaries());
</script>
```

**LlmLogViewer.vue:**
```vue
<template>
  <BCard>
    <template #header>
      <BRow class="align-items-center">
        <BCol>
          <h6 class="mb-0">Generation Logs</h6>
        </BCol>
        <BCol md="2">
          <BFormSelect
            v-model="filters.cluster_type"
            :options="typeOptions"
            size="sm"
            @change="loadLogs"
          />
        </BCol>
        <BCol md="2">
          <BFormSelect
            v-model="filters.status"
            :options="statusOptions"
            size="sm"
            @change="loadLogs"
          />
        </BCol>
        <BCol md="2">
          <BFormInput
            v-model="filters.from_date"
            type="date"
            size="sm"
            placeholder="From"
            @change="loadLogs"
          />
        </BCol>
        <BCol md="2">
          <BFormInput
            v-model="filters.to_date"
            type="date"
            size="sm"
            placeholder="To"
            @change="loadLogs"
          />
        </BCol>
      </BRow>
    </template>

    <BTable :items="logs" :fields="fields" :busy="loading" responsive hover small striped>
      <template #cell(status)="data">
        <BBadge :variant="statusVariant(data.value)">
          {{ formatStatus(data.value) }}
        </BBadge>
      </template>
      <template #cell(tokens)="data">
        <span v-if="data.item.tokens_input">
          {{ data.item.tokens_input }} / {{ data.item.tokens_output }}
        </span>
        <span v-else class="text-muted">-</span>
      </template>
      <template #cell(latency)="data">
        <span v-if="data.item.latency_ms">
          {{ (data.item.latency_ms / 1000).toFixed(2) }}s
        </span>
        <span v-else class="text-muted">-</span>
      </template>
      <template #cell(error_message)="data">
        <span
          v-if="data.value"
          class="text-danger text-truncate d-inline-block"
          style="max-width: 200px"
          :title="data.value"
        >
          {{ data.value }}
        </span>
      </template>
    </BTable>

    <!-- Pagination -->
    <BRow class="mt-3">
      <BCol>
        <BPagination
          v-model="page"
          :total-rows="totalRows"
          :per-page="perPage"
          size="sm"
          @update:model-value="loadLogs"
        />
      </BCol>
      <BCol class="text-end text-muted small">
        Showing {{ logs.length }} of {{ totalRows }} logs
      </BCol>
    </BRow>
  </BCard>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue';
import { useAuth } from '@/composables/useAuth';
import { useLlmAdmin } from '@/composables/useLlmAdmin';
import type { GenerationLog, ClusterType, LogStatus } from '@/types/llm';

const { getToken } = useAuth();
const { fetchLogs } = useLlmAdmin();

const logs = ref<GenerationLog[]>([]);
const loading = ref(false);
const page = ref(1);
const perPage = ref(50);
const totalRows = ref(0);

const filters = reactive({
  cluster_type: undefined as ClusterType | undefined,
  status: undefined as LogStatus | undefined,
  from_date: undefined as string | undefined,
  to_date: undefined as string | undefined,
});

const typeOptions = [
  { value: undefined, text: 'All Types' },
  { value: 'functional', text: 'Functional' },
  { value: 'phenotype', text: 'Phenotype' },
];

const statusOptions = [
  { value: undefined, text: 'All Statuses' },
  { value: 'success', text: 'Success' },
  { value: 'validation_failed', text: 'Validation Failed' },
  { value: 'api_error', text: 'API Error' },
  { value: 'timeout', text: 'Timeout' },
];

const fields = [
  { key: 'log_id', label: 'ID', sortable: true },
  { key: 'cluster_type', label: 'Type' },
  { key: 'cluster_number', label: 'Cluster #' },
  { key: 'model_name', label: 'Model' },
  { key: 'status', label: 'Status' },
  { key: 'tokens', label: 'Tokens (In/Out)' },
  { key: 'latency', label: 'Latency' },
  { key: 'error_message', label: 'Error' },
  { key: 'created_at', label: 'Time', sortable: true },
];

function statusVariant(status: string) {
  switch (status) {
    case 'success':
      return 'success';
    case 'validation_failed':
      return 'warning';
    case 'api_error':
      return 'danger';
    case 'timeout':
      return 'secondary';
    default:
      return 'light';
  }
}

function formatStatus(status: string) {
  return status.replace(/_/g, ' ');
}

async function loadLogs() {
  const token = await getToken();
  if (!token) return;

  loading.value = true;
  try {
    const result = await fetchLogs(token, {
      cluster_type: filters.cluster_type,
      status: filters.status,
      from_date: filters.from_date,
      to_date: filters.to_date,
      page: page.value,
      per_page: perPage.value,
    });
    logs.value = result.data;
    totalRows.value = result.total;
  } finally {
    loading.value = false;
  }
}

onMounted(() => loadLogs());
</script>
```
  </action>
  <verify>
Files exist at app/src/components/llm/LlmCacheManager.vue and app/src/components/llm/LlmLogViewer.vue
  </verify>
  <done>
LlmCacheManager.vue and LlmLogViewer.vue created with pagination, filtering, and validation actions.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add navigation link and run linting</name>
  <files>app/src/components/TheHeader.vue</files>
  <action>
1. **Add ManageLLM to admin navigation** in TheHeader.vue:
   - Find the admin dropdown menu (search for ManageAnnotations or ManageBackups)
   - Add new menu item following same pattern:
   ```vue
   <BDropdownItem :to="{ name: 'ManageLLM' }">
     LLM Management
   </BDropdownItem>
   ```
   - Place it logically near other admin items

2. **Run frontend linting and type-check:**
   - cd /home/bernt-popp/development/sysndd/app && npm run lint
   - cd /home/bernt-popp/development/sysndd/app && npm run type-check
   - Fix any issues in new components

3. **Create components directory if needed:**
   - mkdir -p app/src/components/llm
  </action>
  <verify>
Run: cd /home/bernt-popp/development/sysndd/app && npm run lint && npm run type-check
Both should pass without errors.
  </verify>
  <done>
ManageLLM navigation link added to TheHeader.vue, all frontend linting and type-check pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete LLM Admin Dashboard with:
- ManageLLM.vue with 5 tabs (Overview, Configuration, Prompts, Cache, Logs)
- LlmConfigPanel.vue for model selection
- LlmPromptEditor.vue for prompt template editing
- LlmCacheManager.vue for cache management and validation
- LlmLogViewer.vue for generation log viewing
- Navigation link in admin menu
  </what-built>
  <how-to-verify>
1. Start development environment: make dev
2. Log in as Administrator
3. Navigate to Admin menu -> LLM Management
4. Verify Overview tab shows statistics (may be 0 if no summaries exist)
5. Verify Configuration tab shows model selector (may show "Not Configured" if no API key)
6. Verify Prompts tab shows all 4 prompt types with editor
7. Verify Cache tab shows summary table with filters
8. Verify Logs tab shows generation log table with filters
9. If Gemini API is configured:
   - Try changing model selection
   - Try editing a prompt and saving
   - Try triggering regeneration (check job progress)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. ManageLLM.vue exists with 5 tabs
2. All 4 sub-components exist in app/src/components/llm/
3. Navigation link added to TheHeader.vue
4. TypeScript type-check passes (npm run type-check)
5. ESLint passes (npm run lint)
6. UI renders correctly in browser
</verification>

<success_criteria>
- Admin can navigate to /ManageLLM from header menu
- Overview tab displays cache statistics
- Configuration tab allows model selection
- Prompts tab shows all 4 prompts with editing capability
- Cache tab displays paginated summaries with validation actions
- Logs tab displays filtered generation logs
- Regeneration button triggers async job with progress display
- All operations work with proper error handling
</success_criteria>

<output>
After completion, create `.planning/phases/64-llm-admin-dashboard/64-04-SUMMARY.md`
</output>
