---
phase: 77-ontology-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/functions/omim-functions.R
  - api/tests/testthat/test-unit-omim-functions.R
autonomous: true

must_haves:
  truths:
    - "build_omim_from_genemap2() accepts parsed genemap2 tibble, hgnc_list, and moi_list and returns disease_ontology_set schema"
    - "Inheritance modes from genemap2 short forms are mapped to full HPO term names via 15-entry case_when"
    - "HPO term names are joined with moi_list to produce hpo_mode_of_inheritance_term IDs"
    - "Duplicate MIM numbers receive _1, _2 version suffixes after grouping by disease_ontology_id"
    - "Single-occurrence MIM numbers have no version suffix (e.g., OMIM:123456 not OMIM:123456_1)"
    - "disease_ontology_source is set to 'mim2gene' for MONDO SSSOM mapping compatibility"
    - "Gene symbols are joined with hgnc_list to produce hgnc_id values"
  artifacts:
    - path: "api/functions/omim-functions.R"
      provides: "build_omim_from_genemap2() function"
      contains: "build_omim_from_genemap2"
    - path: "api/tests/testthat/test-unit-omim-functions.R"
      provides: "Unit tests for build_omim_from_genemap2()"
      contains: "build_omim_from_genemap2"
  key_links:
    - from: "api/functions/omim-functions.R"
      to: "moi_list parameter"
      via: "left_join for HPO term ID lookup"
      pattern: "left_join.*moi_list"
    - from: "api/functions/omim-functions.R"
      to: "hgnc_list parameter"
      via: "left_join for HGNC ID lookup"
      pattern: "left_join.*hgnc_list"
    - from: "api/functions/omim-functions.R"
      to: "disease_ontology_set schema"
      via: "Output columns match schema exactly"
      pattern: "disease_ontology_id_version.*disease_ontology_id.*disease_ontology_name"
---

<objective>
Create the build_omim_from_genemap2() function that transforms parsed genemap2 data into the disease_ontology_set schema, with inheritance mode normalization, HGNC ID lookup, and duplicate MIM versioning.

Purpose: This is the core data transformation that replaces the mim2gene + JAX API workflow. The old build_omim_ontology_set() cannot map inheritance modes (mim2gene.txt lacks them). build_omim_from_genemap2() uses genemap2's Phenotypes column data, which includes inheritance information, eliminating the need for the slow JAX API.

Output: New build_omim_from_genemap2() function in omim-functions.R + comprehensive unit tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/77-ontology-migration/77-RESEARCH.md

@api/functions/omim-functions.R
@api/tests/testthat/test-unit-omim-functions.R
@db/02_Rcommands_sysndd_db_table_disease_ontology_set.R (lines 268-312 for proven pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create build_omim_from_genemap2() in omim-functions.R</name>
  <files>api/functions/omim-functions.R</files>
  <action>
Add a new function `build_omim_from_genemap2()` to omim-functions.R. Place it AFTER the existing `build_omim_ontology_set()` function (after line ~585, at the end of the file).

Do NOT modify or remove `build_omim_ontology_set()` -- it will be removed in Phase 79 cleanup. The new function coexists alongside it.

**Function signature:**
```r
build_omim_from_genemap2 <- function(genemap2_parsed, hgnc_list, moi_list)
```

**Parameters:**
- `genemap2_parsed`: Tibble from Phase 76's parse_genemap2(). Expected columns: Approved_Symbol, disease_ontology_name, MIM_Number (or disease_ontology_id as "OMIM:XXXXXX"), hpo_mode_of_inheritance_term_name, Mapping_key. The exact columns depend on what parse_genemap2() outputs -- handle both raw parsed (with MIM_Number) and pre-processed (with disease_ontology_id) by checking column existence.
- `hgnc_list`: Tibble with columns: symbol, hgnc_id
- `moi_list`: Tibble with columns: hpo_mode_of_inheritance_term_name, hpo_mode_of_inheritance_term

**Implementation steps (adapt from db/02_Rcommands lines 268-312):**

1. **Ensure disease_ontology_id exists:**
   If genemap2_parsed has `MIM_Number` but not `disease_ontology_id`, create it:
   `mutate(disease_ontology_id = paste0("OMIM:", MIM_Number))`
   If it already has `disease_ontology_id`, use it as-is.

2. **Join with HGNC list for hgnc_id:**
   ```r
   left_join(hgnc_list %>% dplyr::select(symbol, hgnc_id),
             by = c("Approved_Symbol" = "symbol"))
   ```
   Use `dplyr::select()` explicitly (biomaRt masking issue per CLAUDE.md).

3. **Expand and normalize inheritance modes:**
   ```r
   separate_rows(hpo_mode_of_inheritance_term_name, sep = ", ") %>%
   mutate(hpo_mode_of_inheritance_term_name = str_replace_all(
     hpo_mode_of_inheritance_term_name, "\\?", "")) %>%
   ```

4. **Apply 15-entry inheritance mode mapping (exact mapping from db script lines 285-299):**
   ```r
   mutate(hpo_mode_of_inheritance_term_name = case_when(
     hpo_mode_of_inheritance_term_name == "Autosomal dominant" ~ "Autosomal dominant inheritance",
     hpo_mode_of_inheritance_term_name == "Autosomal recessive" ~ "Autosomal recessive inheritance",
     hpo_mode_of_inheritance_term_name == "Digenic dominant" ~ "Digenic inheritance",
     hpo_mode_of_inheritance_term_name == "Digenic recessive" ~ "Digenic inheritance",
     hpo_mode_of_inheritance_term_name == "Isolated cases" ~ "Sporadic",
     hpo_mode_of_inheritance_term_name == "Mitochondrial" ~ "Mitochondrial inheritance",
     hpo_mode_of_inheritance_term_name == "Multifactorial" ~ "Multifactorial inheritance",
     hpo_mode_of_inheritance_term_name == "Pseudoautosomal dominant" ~ "X-linked dominant inheritance",
     hpo_mode_of_inheritance_term_name == "Pseudoautosomal recessive" ~ "X-linked recessive inheritance",
     hpo_mode_of_inheritance_term_name == "Somatic mosaicism" ~ "Somatic mosaicism",
     hpo_mode_of_inheritance_term_name == "Somatic mutation" ~ "Somatic mutation",
     hpo_mode_of_inheritance_term_name == "X-linked" ~ "X-linked inheritance",
     hpo_mode_of_inheritance_term_name == "X-linked dominant" ~ "X-linked dominant inheritance",
     hpo_mode_of_inheritance_term_name == "X-linked recessive" ~ "X-linked recessive inheritance",
     hpo_mode_of_inheritance_term_name == "Y-linked" ~ "Y-linked inheritance"
   ))
   ```
   NOTE: Values not matching any case_when condition become NA -- this is correct behavior for unknown inheritance modes.

5. **Log warning for unmapped inheritance terms:**
   After the case_when, check for entries where `hpo_mode_of_inheritance_term_name` was non-NA BEFORE mapping but became NA AFTER. Log with `warning()` mentioning the unmapped terms. This satisfies the open question about mapping completeness.

6. **Join with moi_list to get HPO term IDs:**
   ```r
   left_join(moi_list, by = c("hpo_mode_of_inheritance_term_name"))
   ```
   This produces `hpo_mode_of_inheritance_term` column (the HPO ID like "HP:0000006").

7. **Select, deduplicate, and apply versioning (exact pattern from db script lines 301-308):**
   ```r
   dplyr::select(disease_ontology_id, hgnc_id, disease_ontology_name,
                 hpo_mode_of_inheritance_term) %>%
   unique() %>%
   arrange(disease_ontology_id, hgnc_id, disease_ontology_name,
           hpo_mode_of_inheritance_term) %>%
   group_by(disease_ontology_id) %>%
   mutate(n = 1, count = n(), version = cumsum(n)) %>%
   ungroup() %>%
   mutate(disease_ontology_id_version = case_when(
     count == 1 ~ disease_ontology_id,
     count >= 1 ~ paste0(disease_ontology_id, "_", version)
   ))
   ```
   CRITICAL: Versioning happens AFTER inheritance expansion and deduplication. This ensures the same MIM+gene+inheritance combination doesn't create spurious versions.

8. **Add metadata columns and select final schema:**
   ```r
   mutate(
     disease_ontology_source = "mim2gene",  # Keep "mim2gene" for MONDO SSSOM compatibility
     disease_ontology_date = format(Sys.Date(), "%Y-%m-%d"),
     disease_ontology_is_specific = TRUE
   ) %>%
   dplyr::select(
     disease_ontology_id_version, disease_ontology_id, disease_ontology_name,
     disease_ontology_source, disease_ontology_date, disease_ontology_is_specific,
     hgnc_id, hpo_mode_of_inheritance_term
   )
   ```

   CRITICAL on disease_ontology_source: MUST be "mim2gene" (NOT "genemap2" or "morbidmap"). The MONDO SSSOM mapping function `add_mondo_mappings_to_ontology()` in mondo-functions.R (line 258) filters for `disease_ontology_source == "mim2gene"`. Changing this breaks MONDO equivalence mapping (Pitfall 4 from research).

**Add roxygen2 documentation** following the style of `build_omim_ontology_set()` above it. Document that this function:
- Replaces the mim2gene + JAX API workflow with genemap2 data
- Maps genemap2 inheritance short forms to full HPO term names
- Applies versioning for duplicate MIM numbers (ONTO-04)
- Keeps disease_ontology_source = "mim2gene" for MONDO compatibility (ONTO-05)
- Include @param and @return documentation
- Include @export tag

**Line length:** Keep all lines under 120 characters per api/.lintr. Use nolint comments for function signatures if needed, following the pattern used elsewhere in the file (e.g., line 517).
  </action>
  <verify>
Run: `cd /home/bernt-popp/development/sysndd && Rscript -e "source('api/functions/file-functions.R'); source('api/functions/omim-functions.R'); cat('build_omim_from_genemap2 exists:', exists('build_omim_from_genemap2'), '\n')"`

Then run lintr:
`cd /home/bernt-popp/development/sysndd/api && Rscript -e "lintr::lint('functions/omim-functions.R')"`

Then run existing tests to check for regressions:
`cd /home/bernt-popp/development/sysndd/api && Rscript -e "testthat::test_file('tests/testthat/test-unit-omim-functions.R')"`
  </verify>
  <done>build_omim_from_genemap2() function exists in omim-functions.R, sources without error, passes lintr, and all existing omim-functions tests still pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for build_omim_from_genemap2()</name>
  <files>api/tests/testthat/test-unit-omim-functions.R</files>
  <action>
Add a new test section to the EXISTING test-unit-omim-functions.R file. Place it after the existing `build_omim_ontology_set()` tests section (after line ~451), before the "Data format validation tests" section.

Add the following section header and tests:

```
# =============================================================================
# build_omim_from_genemap2() tests
# =============================================================================
```

**Test 1: "build_omim_from_genemap2 creates correct output schema"**
Create mock data:
- genemap2_parsed tibble with columns: Approved_Symbol, disease_ontology_name, disease_ontology_id, hpo_mode_of_inheritance_term_name, Mapping_key
  - 2 rows: ("GENE1", "Disease A", "OMIM:100050", "Autosomal dominant", "3") and ("GENE2", "Disease B", "OMIM:100100", "Autosomal recessive", "3")
- hgnc_list: tibble(symbol = c("GENE1", "GENE2"), hgnc_id = c("HGNC:1", "HGNC:2"))
- moi_list: tibble(hpo_mode_of_inheritance_term_name = c("Autosomal dominant inheritance", "Autosomal recessive inheritance"), hpo_mode_of_inheritance_term = c("HP:0000006", "HP:0000007"))

Source omim-functions.R, call build_omim_from_genemap2(), assert:
- Result has all 8 required columns: disease_ontology_id_version, disease_ontology_id, disease_ontology_name, disease_ontology_source, disease_ontology_date, disease_ontology_is_specific, hgnc_id, hpo_mode_of_inheritance_term
- disease_ontology_source is "mim2gene" for all rows
- disease_ontology_is_specific is TRUE for all rows
- nrow(result) == 2

**Test 2: "build_omim_from_genemap2 normalizes inheritance modes"**
Create mock data with raw genemap2 inheritance terms:
- genemap2_parsed: 3 rows with hpo_mode_of_inheritance_term_name = "Autosomal dominant", "X-linked recessive", "Mitochondrial"
- moi_list with the normalized names: "Autosomal dominant inheritance" -> "HP:0000006", "X-linked recessive inheritance" -> "HP:0001417", "Mitochondrial inheritance" -> "HP:0001427"

Assert:
- All hpo_mode_of_inheritance_term values are NOT NA
- Correct HPO term IDs are assigned for each inheritance mode

**Test 3: "build_omim_from_genemap2 handles duplicate MIM versioning"**
Create mock data where same MIM number appears with different genes:
- genemap2_parsed: 3 rows, 2 with disease_ontology_id = "OMIM:100050" (different genes), 1 with "OMIM:100100"
- hgnc_list mapping for all 3 genes

Assert:
- OMIM:100050 entries get _1 and _2 suffixes
- OMIM:100100 entry has no version suffix (just "OMIM:100100")
- Total nrow matches expected

**Test 4: "build_omim_from_genemap2 handles entries with no inheritance info"**
Create mock data where hpo_mode_of_inheritance_term_name is NA:
- genemap2_parsed: 1 row with hpo_mode_of_inheritance_term_name = NA

Assert:
- Result has 1 row
- hpo_mode_of_inheritance_term is NA
- Other fields are still populated correctly

**Test 5: "build_omim_from_genemap2 handles entries with multiple comma-separated inheritance modes"**
Create mock data with comma-separated inheritance: "Autosomal dominant, Autosomal recessive"
- genemap2_parsed: 1 row with hpo_mode_of_inheritance_term_name = "Autosomal dominant, Autosomal recessive"
- moi_list with both normalized terms

Assert:
- Result has 2 rows (expanded via separate_rows)
- Both inheritance modes are correctly normalized and have HPO term IDs
- Both rows share the same disease_ontology_id

**Test 6: "build_omim_from_genemap2 handles MIM_Number column (raw parsed format)"**
Create mock data with MIM_Number column instead of disease_ontology_id:
- genemap2_parsed: tibble with Approved_Symbol, disease_ontology_name, MIM_Number = "100050", hpo_mode_of_inheritance_term_name, Mapping_key (NO disease_ontology_id column)

Assert:
- Result has disease_ontology_id = "OMIM:100050" (auto-created from MIM_Number)

**Test 7: "build_omim_from_genemap2 preserves MONDO compatibility with mim2gene source"**
Assert that disease_ontology_source is exactly "mim2gene" (not "genemap2", not "morbidmap").
This is critical for ONTO-05 (MONDO SSSOM mapping).

All tests follow the existing pattern: wrap source() + function call in tryCatch, skip on dependency errors.
  </action>
  <verify>
Run all omim-functions tests:
`cd /home/bernt-popp/development/sysndd/api && Rscript -e "testthat::test_file('tests/testthat/test-unit-omim-functions.R')"`

Verify all tests pass including new build_omim_from_genemap2 tests.

Run lintr on test file:
`cd /home/bernt-popp/development/sysndd/api && Rscript -e "lintr::lint('tests/testthat/test-unit-omim-functions.R')"`
  </verify>
  <done>All new build_omim_from_genemap2() tests pass. All existing omim-functions tests continue to pass. Zero lintr issues on test file.</done>
</task>

</tasks>

<verification>
1. `source('api/functions/omim-functions.R')` succeeds and `build_omim_from_genemap2` function exists
2. `lintr::lint('functions/omim-functions.R')` returns 0 issues
3. `lintr::lint('tests/testthat/test-unit-omim-functions.R')` returns 0 issues
4. All tests in test-unit-omim-functions.R pass (existing + new)
5. build_omim_from_genemap2() output schema matches: disease_ontology_id_version, disease_ontology_id, disease_ontology_name, disease_ontology_source, disease_ontology_date, disease_ontology_is_specific, hgnc_id, hpo_mode_of_inheritance_term
6. disease_ontology_source is "mim2gene" in all output rows
</verification>

<success_criteria>
- build_omim_from_genemap2() added to omim-functions.R with complete inheritance normalization (15-entry mapping), HGNC joining, and versioning logic
- 7 new unit tests cover: schema output, inheritance normalization, versioning, NA inheritance, comma-separated inheritance, MIM_Number fallback, MONDO compatibility
- All existing tests pass (no regressions)
- Zero lintr issues on both modified files
</success_criteria>

<output>
After completion, create `.planning/phases/77-ontology-migration/77-01-SUMMARY.md`
</output>
