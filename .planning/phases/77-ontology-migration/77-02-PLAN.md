---
phase: 77-ontology-migration
plan: 02
type: execute
wave: 2
depends_on: ["77-01"]
files_modified:
  - api/functions/ontology-functions.R
  - api/tests/testthat/test-unit-ontology-functions.R
autonomous: true

must_haves:
  truths:
    - "process_omim_ontology() calls download_genemap2() and parse_genemap2() instead of mim2gene + JAX API"
    - "process_omim_ontology() calls build_omim_from_genemap2() to transform parsed data into ontology set"
    - "process_omim_ontology() still downloads mim2gene.txt for deprecation tracking (ONTO-06)"
    - "Ontology update runs in under 60 seconds without JAX API sequential calls (ONTO-02)"
    - "process_combine_ontology() flow is unchanged -- only the internal OMIM processing is swapped"
    - "MONDO SSSOM mappings continue to be applied after genemap2 processing (ONTO-05)"
    - "Progress callback reports genemap2 steps instead of JAX API steps"
  artifacts:
    - path: "api/functions/ontology-functions.R"
      provides: "Modified process_omim_ontology() using genemap2 workflow"
      contains: "download_genemap2"
    - path: "api/tests/testthat/test-unit-ontology-functions.R"
      provides: "Tests verifying genemap2 integration in ontology workflow"
      contains: "build_omim_from_genemap2"
  key_links:
    - from: "api/functions/ontology-functions.R"
      to: "api/functions/omim-functions.R"
      via: "download_genemap2(), parse_genemap2(), build_omim_from_genemap2() calls"
      pattern: "download_genemap2|parse_genemap2|build_omim_from_genemap2"
    - from: "api/functions/ontology-functions.R"
      to: "api/functions/omim-functions.R"
      via: "download_mim2gene() + parse_mim2gene() calls for deprecation tracking"
      pattern: "download_mim2gene.*deprecat"
    - from: "api/functions/ontology-functions.R"
      to: "api/functions/mondo-functions.R"
      via: "add_mondo_mappings_to_ontology() unchanged in process_combine_ontology()"
      pattern: "add_mondo_mappings_to_ontology"
---

<objective>
Replace process_omim_ontology() to use genemap2 instead of mim2gene + JAX API, achieving 50x+ speed improvement while maintaining mim2gene for deprecation tracking and MONDO SSSOM compatibility.

Purpose: This is the integration step that wires the new build_omim_from_genemap2() (from Plan 01) into the existing ontology processing pipeline. The JAX API sequential calls (~7 minutes for ~8,500 entries) are eliminated. Only process_omim_ontology() changes -- process_combine_ontology() and all downstream MONDO processing remain unchanged.

Output: Modified process_omim_ontology() in ontology-functions.R + updated tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/77-ontology-migration/77-RESEARCH.md
@.planning/phases/77-ontology-migration/77-01-SUMMARY.md

@api/functions/ontology-functions.R
@api/functions/omim-functions.R
@api/functions/mondo-functions.R
@api/tests/testthat/test-unit-ontology-functions.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite process_omim_ontology() to use genemap2 workflow</name>
  <files>api/functions/ontology-functions.R</files>
  <action>
Replace the body of `process_omim_ontology()` (lines 343-389) with the genemap2 workflow. Keep the SAME function signature -- `process_omim_ontology(hgnc_list, moi_list, max_file_age = 3, progress_callback = NULL)` -- so callers (process_combine_ontology on line 160) need zero changes.

**New implementation:**

```r
process_omim_ontology <- function(hgnc_list, moi_list, max_file_age = 3, progress_callback = NULL) {
  # Step 1: Download genemap2.txt (Phase 76 shared infrastructure)
  if (!is.null(progress_callback)) {
    progress_callback(step = "Downloading genemap2.txt", current = 1, total = 4)
  }
  genemap2_file <- download_genemap2("data/", force = FALSE)

  # Step 2: Parse genemap2 (Phase 76 shared function)
  if (!is.null(progress_callback)) {
    progress_callback(step = "Parsing genemap2.txt", current = 2, total = 4)
  }
  genemap2_parsed <- parse_genemap2(genemap2_file)

  # Step 3: Build ontology set with inheritance mapping
  if (!is.null(progress_callback)) {
    progress_callback(step = "Building OMIM ontology set from genemap2", current = 3, total = 4)
  }
  omim_terms <- build_omim_from_genemap2(genemap2_parsed, hgnc_list, moi_list)

  # Step 4: Download mim2gene.txt for deprecation tracking (ONTO-06)
  # mim2gene.txt is free/public (no auth needed) and tracks moved/removed entries
  if (!is.null(progress_callback)) {
    progress_callback(
      step = "Downloading mim2gene.txt for deprecation tracking",
      current = 4,
      total = 4
    )
  }
  tryCatch({
    mim2gene_file <- download_mim2gene("data/", force = FALSE, max_age_months = max_file_age)
    mim2gene_data <- parse_mim2gene(mim2gene_file)
    deprecated_mims <- get_deprecated_mim_numbers(mim2gene_data)
    if (length(deprecated_mims) > 0) {
      message(sprintf(
        "[OMIM] Found %d deprecated (moved/removed) MIM entries in mim2gene.txt",
        length(deprecated_mims)
      ))
    }
  }, error = function(e) {
    warning(sprintf(
      "[OMIM] Could not download mim2gene.txt for deprecation tracking: %s",
      e$message
    ))
  })

  # Save debug/cache CSV
  omim_file_date <- format(Sys.Date(), "%Y-%m-%d")
  csv_file_path <- paste0("results/ontology/omim_genemap2.", omim_file_date, ".csv")
  if (!dir.exists("results/ontology")) {
    dir.create("results/ontology", recursive = TRUE)
  }
  write_csv(omim_terms, file = csv_file_path, na = "NULL")

  return(omim_terms)
}
```

**Key changes from old implementation:**
1. REMOVED: `download_mim2gene()` as PRIMARY data source (Step 1 old) -- replaced with `download_genemap2()`
2. REMOVED: `fetch_all_disease_names()` JAX API call (Step 2 old) -- this was the 7-minute bottleneck
3. REMOVED: `build_omim_ontology_set()` call (Step 3 old) -- replaced with `build_omim_from_genemap2()`
4. ADDED: `parse_genemap2()` call for genemap2 data extraction
5. ADDED: mim2gene.txt download as SECONDARY step (Step 4) for deprecation tracking only (ONTO-06)
6. CHANGED: CSV filename from `omim_mim2gene.{date}.csv` to `omim_genemap2.{date}.csv`
7. KEPT: Same function signature, same 4-step progress callback structure, same return type

**Also update the roxygen2 documentation** for process_omim_ontology():
- Change description from "mim2gene.txt + JAX API workflow" to "genemap2.txt-based workflow"
- Update @param moi_list description: remove "(for compatibility, not used in mim2gene workflow)" -- moi_list IS now used for inheritance mapping
- Update @details to mention genemap2 parsing, inheritance mapping, and deprecation tracking via mim2gene
- Keep @export tag

**Do NOT modify process_combine_ontology()** -- it calls process_omim_ontology() and that interface is unchanged.

**Do NOT modify any other function** in this file. identify_critical_ontology_changes(), process_mondo_ontology(), get_mondo_mappings(), get_ontology_object() all stay the same.

**Line length:** Keep all lines under 120 characters per api/.lintr. Use nolint comments only where absolutely necessary, following existing patterns.
  </action>
  <verify>
Run: `cd /home/bernt-popp/development/sysndd && Rscript -e "source('api/functions/file-functions.R'); source('api/functions/ontology-functions.R'); cat('process_omim_ontology exists:', exists('process_omim_ontology'), '\n')"`

Note: This will source omim-functions.R and mondo-functions.R transitively via ontology-functions.R's conditional sourcing. If it fails on missing dependencies (ontologyIndex), that's expected in bare R -- the function definition itself should parse correctly.

Run lintr:
`cd /home/bernt-popp/development/sysndd/api && Rscript -e "lintr::lint('functions/ontology-functions.R')"`

Run existing ontology tests:
`cd /home/bernt-popp/development/sysndd/api && Rscript -e "testthat::test_file('tests/testthat/test-unit-ontology-functions.R')"`
  </verify>
  <done>process_omim_ontology() rewritten to use download_genemap2() + parse_genemap2() + build_omim_from_genemap2() workflow. mim2gene.txt still downloaded for deprecation tracking. Function sources without error. All existing ontology tests pass. Zero lintr issues.</done>
</task>

<task type="auto">
  <name>Task 2: Update ontology-functions tests for genemap2 workflow</name>
  <files>api/tests/testthat/test-unit-ontology-functions.R</files>
  <action>
Add new tests and update existing test data in test-unit-ontology-functions.R to reflect the genemap2 workflow.

**1. Update the OMIM term structure test (line ~296-321):**

The existing test at line ~296 uses `disease_ontology_source = "morbidmap"`. Update it to reflect the current source naming:
- Change `disease_ontology_source = "morbidmap"` to `disease_ontology_source = "mim2gene"`
- Update the assertion from `expect_equal(omim_mock$disease_ontology_source, "morbidmap")` to `expect_equal(omim_mock$disease_ontology_source, "mim2gene")`
- Add a comment explaining: `# Source is "mim2gene" for MONDO SSSOM compatibility (ONTO-05)`

**2. Add new test section after the versioning tests (after line ~374):**

```
# =============================================================================
# build_omim_from_genemap2() integration tests
# =============================================================================
```

**Test: "build_omim_from_genemap2 output integrates with identify_critical_ontology_changes"**
Create mock data that simulates the full pipeline:
- Create an "old" disease_ontology_set (from previous run) with 2 OMIM entries
- Create a "new" disease_ontology_set using build_omim_from_genemap2 output format (with inheritance data)
- Create a mock ndd_entity_view_ontology_set referencing one of the old entries
- Call identify_critical_ontology_changes() and verify it correctly identifies changes

This test validates that the output schema from build_omim_from_genemap2() is compatible with the downstream critical changes detection.

Mock data for "new" set should include:
- disease_ontology_id_version, disease_ontology_id, hgnc_id, hpo_mode_of_inheritance_term, disease_ontology_name
- With disease_ontology_source = "mim2gene" and disease_ontology_is_specific = TRUE

**Test: "genemap2 workflow produces richer data than mim2gene workflow"**
Compare mock output structures:
- Old mim2gene output: hpo_mode_of_inheritance_term = NA (mim2gene has no inheritance data)
- New genemap2 output: hpo_mode_of_inheritance_term = "HP:0000006" (genemap2 has inheritance data)
Assert that the genemap2 output has non-NA inheritance terms while old mim2gene output would have NA.

**Test: "process_omim_ontology progress callback receives correct step names"**
Create a mock progress_callback that records all calls. Verify it receives:
- Step 1: contains "genemap2" (not "mim2gene" as primary)
- Step 2: contains "Parsing"
- Step 3: contains "Building"
- Step 4: contains "mim2gene" and "deprecation"

Note: This test cannot actually call process_omim_ontology() (requires network). Instead, validate the expected step descriptions as documentation of the contract. Use a simple assertion that the step names are well-defined string constants. If testing with live function is not feasible, wrap in tryCatch and skip.

All tests follow the existing pattern in the file: wrap function calls in tryCatch with skip on dependency errors.
  </action>
  <verify>
Run all ontology tests:
`cd /home/bernt-popp/development/sysndd/api && Rscript -e "testthat::test_file('tests/testthat/test-unit-ontology-functions.R')"`

Verify all tests pass including updated and new tests.

Run lintr on test file:
`cd /home/bernt-popp/development/sysndd/api && Rscript -e "lintr::lint('tests/testthat/test-unit-ontology-functions.R')"`
  </verify>
  <done>OMIM term structure test updated to use "mim2gene" source. New integration tests verify build_omim_from_genemap2 output compatibility with downstream functions. All tests pass. Zero lintr issues.</done>
</task>

</tasks>

<verification>
1. `source('api/functions/ontology-functions.R')` succeeds
2. process_omim_ontology() body references download_genemap2, parse_genemap2, build_omim_from_genemap2
3. process_omim_ontology() body still downloads mim2gene.txt for deprecation tracking
4. process_combine_ontology() is UNCHANGED (same code as before)
5. All tests in test-unit-ontology-functions.R pass
6. `lintr::lint('functions/ontology-functions.R')` returns 0 issues
7. `lintr::lint('tests/testthat/test-unit-ontology-functions.R')` returns 0 issues
8. Docstring for process_omim_ontology() references genemap2 (not JAX API)
</verification>

<success_criteria>
- process_omim_ontology() uses genemap2 workflow (download_genemap2 + parse_genemap2 + build_omim_from_genemap2)
- JAX API calls (fetch_all_disease_names, fetch_jax_disease_name) no longer called from process_omim_ontology
- mim2gene.txt still downloaded for deprecation tracking (ONTO-06)
- process_combine_ontology() unchanged
- OMIM term structure test updated from "morbidmap" to "mim2gene"
- New integration tests verify schema compatibility
- All existing tests pass (no regressions)
- Zero lintr issues on both modified files
</success_criteria>

<output>
After completion, create `.planning/phases/77-ontology-migration/77-02-SUMMARY.md`
</output>
