---
phase: 51-smtp-testing-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.dev.yml
  - api/config.yml
  - api/endpoints/admin_endpoints.R
autonomous: true

must_haves:
  truths:
    - "Mailpit container starts with docker compose -f docker-compose.dev.yml up"
    - "Mailpit Web UI accessible at localhost:8025"
    - "API can connect to Mailpit SMTP on port 1025 when using dev config"
    - "GET /api/admin/smtp/test returns connection status"
  artifacts:
    - path: "docker-compose.dev.yml"
      provides: "Mailpit service definition"
      contains: "mailpit"
    - path: "api/config.yml"
      provides: "Dev SMTP configuration pointing to Mailpit"
      contains: "sysndd_db_dev"
    - path: "api/endpoints/admin_endpoints.R"
      provides: "SMTP test endpoint"
      contains: "/smtp/test"
  key_links:
    - from: "api/endpoints/admin_endpoints.R"
      to: "api/config.yml"
      via: "dw$mail_noreply_host config access"
      pattern: "dw\\$mail_noreply"
---

<objective>
Add Mailpit container for email capture in development and create SMTP test endpoint.

Purpose: Enable developers to verify email functionality locally without sending real emails, and provide administrators with SMTP connection health visibility.

Output:
- Mailpit container in docker-compose.dev.yml
- sysndd_db_dev config profile with Mailpit SMTP settings
- GET /api/admin/smtp/test endpoint returning connection status
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-smtp-testing-infrastructure/51-CONTEXT.md
@.planning/phases/51-smtp-testing-infrastructure/51-RESEARCH.md

# Existing patterns
@docker-compose.dev.yml
@docker-compose.yml
@api/config.yml
@api/endpoints/admin_endpoints.R
@api/functions/helper-functions.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Mailpit to docker-compose.dev.yml</name>
  <files>docker-compose.dev.yml</files>
  <action>
Add Mailpit service to docker-compose.dev.yml alongside existing mysql-dev and mysql-test services.

Add to services section:
```yaml
mailpit:
  image: axllent/mailpit:v1.28.4
  container_name: sysndd_mailpit
  restart: unless-stopped
  ports:
    - "127.0.0.1:8025:8025"  # Web UI
    - "127.0.0.1:1025:1025"  # SMTP (for local R development)
  environment:
    MP_SMTP_AUTH_ACCEPT_ANY: 1
    MP_SMTP_AUTH_ALLOW_INSECURE: 1
    MP_MAX_MESSAGES: 500
  healthcheck:
    test: ["CMD", "wget", "--spider", "--tries=1", "--no-verbose", "http://localhost:8025/"]
    interval: 30s
    timeout: 5s
    retries: 3
    start_period: 10s
```

Notes:
- Bind to 127.0.0.1 only (not exposed externally)
- No network needed (only accessed from host, not other containers)
- MP_SMTP_AUTH_ACCEPT_ANY allows any credentials (dev only)
- MP_MAX_MESSAGES limits inbox size to 500
  </action>
  <verify>Run `docker compose -f docker-compose.dev.yml config | grep -A 20 mailpit` to confirm service definition</verify>
  <done>Mailpit service defined in docker-compose.dev.yml with correct ports and settings</done>
</task>

<task type="auto">
  <name>Task 2: Add sysndd_db_dev config profile</name>
  <files>api/config.yml</files>
  <action>
Add new sysndd_db_dev configuration profile to config.yml that points SMTP to Mailpit.

Add after sysndd_db_local section:
```yaml
sysndd_db_dev:
  workdir: "/app"
  dbtype: mysql
  dbname: sysndd_db
  user: bernt
  password: "changeme"
  salt: "F75m1mwbGh)z"
  server: "0.0.0.0"
  host: "mysql-dev"
  port: "3306"
  port_self: "7777"
  secret: mHzU/}bny4-==rm0]9~bsq.2Ob2`lHgu2#+K(/Dih#7bN@KmMLf\AK9y:Inf+FN
  refresh: 3600
  base_url: "http://localhost"
  api_base_url: "http://localhost:7777"
  mail_noreply_user: "noreply@sysndd.org"
  mail_noreply_host: "127.0.0.1"
  mail_noreply_port: 1025
  mail_noreply_use_ssl: FALSE
  mail_noreply_overwrite: TRUE
  mail_noreply_password: ""
  archive_access_key: "fbDoOOgwotN718O1"
  archive_secret_key: "3YTXC8vPSNSfkVCG"
  archive_base_url: "https://sysndd.dbmr.unibe.ch/"
  omim_token: "9GJLEFvqSmWaImCijeRdVA"
```

Key differences from sysndd_db_local:
- mail_noreply_host: "127.0.0.1" (Mailpit accessible from host)
- mail_noreply_port: 1025 (Mailpit SMTP port)
- mail_noreply_use_ssl: FALSE (Mailpit doesn't use SSL)
- mail_noreply_password: "" (Mailpit accepts any password)

Also update sysndd_db_local and sysndd_db_test to use Mailpit:
- Change mail_noreply_host to "127.0.0.1"
- Change mail_noreply_port to 1025
- Change mail_noreply_use_ssl to FALSE
  </action>
  <verify>Run `grep -A 3 "mail_noreply" api/config.yml` to confirm Mailpit settings in dev profiles</verify>
  <done>sysndd_db_dev profile exists with Mailpit SMTP settings; local and test profiles updated</done>
</task>

<task type="auto">
  <name>Task 3: Create SMTP test endpoint</name>
  <files>api/endpoints/admin_endpoints.R</files>
  <action>
Add GET /smtp/test endpoint to admin_endpoints.R that tests SMTP connection.

Add at end of file before final comment block:
```r
#* Test SMTP connection status
#*
#* Attempts to connect to the configured SMTP server and returns
#* connection status. Does not send any email.
#*
#* # `Authorization`
#* Restricted to Administrator role.
#*
#* # `Return`
#* - success: Boolean indicating if connection succeeded
#* - host: SMTP host that was tested
#* - port: SMTP port that was tested
#* - error: Error message if connection failed (null on success)
#*
#* @tag admin
#* @serializer unboxedJSON
#* @get /smtp/test
function(req, res) {
  require_role(req, res, "Administrator")

  smtp_host <- dw$mail_noreply_host
  smtp_port <- as.integer(dw$mail_noreply_port)

  result <- tryCatch({
    # Attempt socket connection to SMTP server
    con <- socketConnection(
      host = smtp_host,
      port = smtp_port,
      open = "r+",
      blocking = TRUE,
      timeout = 5
    )
    close(con)

    list(
      success = TRUE,
      host = smtp_host,
      port = smtp_port,
      error = NULL
    )
  }, error = function(e) {
    list(
      success = FALSE,
      host = smtp_host,
      port = smtp_port,
      error = e$message
    )
  })

  result
}
```

Notes:
- Uses raw socket connection (not blastula) for connection test only
- 5 second timeout prevents hanging
- Returns structured response for UI consumption
- Follows existing endpoint patterns (require_role, unboxedJSON serializer)
  </action>
  <verify>Run `grep -A 5 "@get /smtp/test" api/endpoints/admin_endpoints.R` to confirm endpoint exists</verify>
  <done>GET /api/admin/smtp/test endpoint created with socket-based connection test</done>
</task>

</tasks>

<verification>
1. Docker Compose validation:
   ```bash
   docker compose -f docker-compose.dev.yml config
   ```
   Expected: Valid YAML with mailpit service

2. Start Mailpit and verify:
   ```bash
   docker compose -f docker-compose.dev.yml up -d mailpit
   docker compose -f docker-compose.dev.yml ps mailpit
   ```
   Expected: mailpit container running, healthy

3. Mailpit Web UI accessible:
   ```bash
   curl -s http://localhost:8025/api/v1/messages | head -20
   ```
   Expected: JSON response (empty messages list)

4. SMTP port accessible:
   ```bash
   nc -zv localhost 1025
   ```
   Expected: Connection succeeded

5. R lintr passes:
   ```bash
   cd api && Rscript -e "lintr::lint('endpoints/admin_endpoints.R')"
   ```
   Expected: No lint errors
</verification>

<success_criteria>
- SMTP-01 partial: Mailpit container configured in docker-compose.dev.yml
- SMTP-02: GET /api/admin/smtp/test endpoint returns connection status
- Mailpit Web UI accessible at localhost:8025 when container running
- Config profiles updated with Mailpit SMTP settings
</success_criteria>

<output>
After completion, create `.planning/phases/51-smtp-testing-infrastructure/51-01-SUMMARY.md`
</output>
