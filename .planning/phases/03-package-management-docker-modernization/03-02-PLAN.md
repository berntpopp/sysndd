---
phase: 03-package-management-docker-modernization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.dev.yml
  - api/.dockerignore
  - app/.dockerignore
  - docker-compose.yml
autonomous: true
user_setup: []

must_haves:
  truths:
    - "docker compose -f docker-compose.dev.yml up db starts database on port 7654"
    - "docker compose -f docker-compose.dev.yml up test-db starts test database on port 7655"
    - "Database data persists across container restarts via named volumes"
    - "Docker builds exclude unnecessary files via .dockerignore"
  artifacts:
    - path: "docker-compose.dev.yml"
      provides: "Development database containers"
      contains: "mysql-dev"
    - path: "api/.dockerignore"
      provides: "API build context filter"
      min_lines: 5
    - path: "app/.dockerignore"
      provides: "Frontend build context filter"
      min_lines: 5
  key_links:
    - from: "docker-compose.dev.yml"
      to: "api/config.yml"
      via: "port 7654 matching existing config"
      pattern: "7654:3306"
---

<objective>
Create Docker Compose development configuration and add .dockerignore files for optimized builds.

Purpose: Enable hybrid development workflow where databases run in Docker while API runs locally. This provides consistent database behavior with fast local development iteration. The .dockerignore files reduce build context size by 50%+.

Output:
- docker-compose.dev.yml with dev database and test database services
- api/.dockerignore excluding tests, docs, git files
- app/.dockerignore excluding node_modules, tests, git files
- Updated docker-compose.yml removing obsolete version field
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-package-management-docker-modernization/03-RESEARCH.md

# Existing compose file to understand current patterns
@docker-compose.yml

# Config shows expected port (7654)
# Note: config.yml is gitignored, but we know from RESEARCH.md that port 7654 is standard
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create docker-compose.dev.yml for hybrid development</name>
  <files>docker-compose.dev.yml</files>
  <action>
Create docker-compose.dev.yml at the repository root with two MySQL services:

```yaml
# Development database containers for hybrid workflow
# Usage: docker compose -f docker-compose.dev.yml up -d
#
# This starts databases in Docker while you run the API locally.
# API connects to localhost:7654 (dev) or localhost:7655 (test)

services:
  mysql-dev:
    image: mysql:8.0.40
    container_name: sysndd_mysql_dev
    restart: unless-stopped
    command: mysqld --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-sysndd_db}
      MYSQL_USER: ${MYSQL_USER:-bernt}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-changeme}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
    ports:
      - "7654:3306"
    volumes:
      - mysql_dev_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  mysql-test:
    image: mysql:8.0.40
    container_name: sysndd_mysql_test
    restart: unless-stopped
    command: mysqld --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_DATABASE: sysndd_db_test
      MYSQL_USER: ${MYSQL_USER:-bernt}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-changeme}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
    ports:
      - "7655:3306"
    volumes:
      - mysql_test_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

volumes:
  mysql_dev_data:
    name: sysndd_mysql_dev_data
  mysql_test_data:
    name: sysndd_mysql_test_data
```

**Key decisions:**
- Port 7654 for dev matches existing config.yml (no config changes needed)
- Port 7655 for test DB (matches helper-db.R expectations)
- MySQL 8.0.40 (latest stable 8.0.x)
- Named volumes for data persistence across restarts
- Health checks for readiness detection
- Default passwords in compose file, override via .env or env vars
- `start_period: 30s` gives MySQL time to initialize

**Do NOT include:**
- The API service (that runs locally in hybrid mode)
- The app service (that also runs locally via npm run serve)
- The backup service (not needed for development)
  </action>
  <verify>
```bash
# Validate YAML syntax
docker compose -f docker-compose.dev.yml config

# Start dev database only
docker compose -f docker-compose.dev.yml up -d mysql-dev

# Check it's running on correct port
docker compose -f docker-compose.dev.yml ps

# Test connection (after ~30s startup)
docker compose -f docker-compose.dev.yml exec mysql-dev mysqladmin ping -h localhost -u root -proot
```
  </verify>
  <done>
- docker-compose.dev.yml exists at repository root
- Contains mysql-dev service on port 7654
- Contains mysql-test service on port 7655
- Both services use named volumes for persistence
- Both services have health checks
- YAML validates successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add .dockerignore files and modernize docker-compose.yml</name>
  <files>
    api/.dockerignore
    app/.dockerignore
    docker-compose.yml
  </files>
  <action>
**Part A: Create api/.dockerignore**

Create api/.dockerignore to exclude unnecessary files from build context:

```dockerignore
# Git
.git
.gitignore

# Tests (not needed in production image)
tests/
testthat/

# Development files
*.Rproj
.Rproj.user/
.Rhistory
.RData
.Ruserdata

# renv cache (lockfile IS needed, but not the library)
renv/library/
renv/local/
renv/cellar/
renv/lock/
renv/python/
renv/sandbox/
renv/staging/

# Documentation
*.md
docs/

# Scripts (linting tools not needed in prod)
scripts/

# IDE
.vscode/
.idea/

# Logs
*.log
logs/
```

**Part B: Create app/.dockerignore**

Create app/.dockerignore to exclude unnecessary files from build context:

```dockerignore
# Dependencies (rebuilt in container)
node_modules/

# Build output (rebuilt in container)
dist/

# Git
.git
.gitignore

# Tests
tests/
*.spec.js
*.test.js
__tests__/
coverage/

# Development files
.env.local
.env.*.local

# IDE
.vscode/
.idea/
*.swp
*.swo

# Documentation
*.md

# Logs
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# OS files
.DS_Store
Thumbs.db
```

**Part C: Modernize docker-compose.yml**

Edit docker-compose.yml to remove the obsolete `version:` field:
- Remove line 1: `version: '3.8'`
- The version field is ignored by modern Docker Compose (2.0+)
- Leaving it generates a warning in newer Docker versions

Also update external volume path to use named volume (optional improvement):
- Change `../data/mysql/:/var/lib/mysql/` to named volume if desired
- For now, just remove the version field to minimize changes
  </action>
  <verify>
```bash
# Check api/.dockerignore exists and has content
wc -l api/.dockerignore
# Should be 25+ lines

# Check app/.dockerignore exists and has content
wc -l app/.dockerignore
# Should be 25+ lines

# Verify docker-compose.yml no longer has version field
grep -n "^version:" docker-compose.yml && echo "ERROR: version field still present" || echo "OK: version field removed"

# Validate all compose files
docker compose config
docker compose -f docker-compose.dev.yml config
```
  </verify>
  <done>
- api/.dockerignore exists with patterns for git, tests, renv cache, docs
- app/.dockerignore exists with patterns for node_modules, git, tests
- docker-compose.yml no longer has obsolete version field
- Both .dockerignore files reduce build context significantly
  </done>
</task>

</tasks>

<verification>
1. **Dev compose validation:**
   ```bash
   docker compose -f docker-compose.dev.yml config --quiet && echo "Valid"
   ```

2. **Production compose validation:**
   ```bash
   docker compose config --quiet && echo "Valid"
   ```

3. **Dockerignore effectiveness (approximate):**
   ```bash
   # Estimate API build context reduction
   find api -type f | wc -l  # Total files
   find api -type f ! -path "*/renv/library/*" ! -path "*/tests/*" ! -path "*/.git/*" | wc -l  # After ignore
   ```

4. **Quick start test:**
   ```bash
   docker compose -f docker-compose.dev.yml up -d mysql-dev
   sleep 35  # Wait for MySQL initialization
   docker compose -f docker-compose.dev.yml exec mysql-dev mysqladmin ping -h localhost -u root -proot
   docker compose -f docker-compose.dev.yml down
   ```
</verification>

<success_criteria>
1. `docker compose -f docker-compose.dev.yml up db` starts database on port 7654
2. `docker compose -f docker-compose.dev.yml up test-db` starts test database on port 7655
3. Data persists in named volumes across container restarts
4. api/.dockerignore reduces build context by excluding renv/library, tests, docs
5. app/.dockerignore reduces build context by excluding node_modules, tests
6. docker-compose.yml no longer has deprecated version field
</success_criteria>

<output>
After completion, create `.planning/phases/03-package-management-docker-modernization/03-02-SUMMARY.md`
</output>
