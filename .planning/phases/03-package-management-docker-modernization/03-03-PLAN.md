---
phase: 03-package-management-docker-modernization
plan: 03
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - api/Dockerfile
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Docker build completes in under 10 minutes (down from 45+ minutes)"
    - "All R packages are installed from pre-compiled binaries when available"
    - "Package versions match renv.lock for reproducibility"
    - "System dependencies are installed in consolidated layer"
  artifacts:
    - path: "api/Dockerfile"
      provides: "Optimized multi-layer R API image"
      contains: "renv::restore"
      min_lines: 40
  key_links:
    - from: "api/Dockerfile"
      to: "api/renv.lock"
      via: "COPY renv.lock and renv::restore()"
      pattern: "COPY.*renv.lock"
    - from: "api/Dockerfile"
      to: "packagemanager.posit.co"
      via: "P3M repository for binaries"
      pattern: "packagemanager.posit.co"
---

<objective>
Optimize the API Dockerfile to reduce build time from ~45 minutes to ~5-10 minutes.

Purpose: The current Dockerfile has 34 separate RUN commands using devtools::install_version() which compiles packages from source. This plan replaces it with a modern renv-based approach using pak and Posit Package Manager (P3M) for pre-compiled binaries.

Output:
- Rewritten api/Dockerfile using renv::restore() with pak backend
- Consolidated system dependency installation (1 layer instead of 14+)
- BuildKit cache mount for renv cache persistence
- Reduced build time target: 5-10 minutes
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-package-management-docker-modernization/03-RESEARCH.md

# CRITICAL: Read the summary from Plan 01 to understand renv setup
@.planning/phases/03-package-management-docker-modernization/03-01-SUMMARY.md

# Current Dockerfile to understand existing patterns
@api/Dockerfile

# renv.lock created in Plan 01 - contains all package versions
@api/renv.lock
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite Dockerfile with renv and pak optimization</name>
  <files>api/Dockerfile</files>
  <action>
Replace the entire api/Dockerfile with an optimized version that uses renv::restore():

```dockerfile
# syntax=docker/dockerfile:1.4
# SysNDD API - Optimized R Plumber Docker Image
#
# Build time target: 5-10 minutes (down from 45+ minutes)
# Key optimizations:
# - Posit Package Manager (P3M) pre-compiled binaries
# - pak for parallel package installation
# - renv::restore() from lockfile
# - Consolidated system dependencies
# - BuildKit cache for renv library

FROM rocker/r-ver:4.4.2 AS base

# Set R repository to Posit Package Manager for pre-compiled Linux binaries
# This avoids source compilation for most packages
ENV RENV_CONFIG_REPOS_OVERRIDE="https://packagemanager.posit.co/cran/__linux__/jammy/latest"

# Enable pak for faster parallel downloads
ENV RENV_CONFIG_PAK_ENABLED=TRUE

# Global renv cache location (for BuildKit cache mount)
ENV RENV_PATHS_CACHE=/renv_cache

# Install all system dependencies in ONE layer
# These are required by various R packages (RMariaDB, xml2, jose, etc.)
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Build essentials
    build-essential \
    # OpenSSL for jose, httr, curl
    libssl-dev \
    # curl for httr, RCurl
    libcurl4-openssl-dev \
    # XML for xml2, rvest
    libxml2-dev \
    # MariaDB/MySQL client for RMariaDB
    libmariadb-dev \
    # Java for rJava, xlsx
    default-jdk \
    # Sodium for secure hashing
    libsodium-dev \
    # PCRE for stringr regex
    libpcre3-dev \
    # ICU for stringi
    libicu-dev \
    # Compression libraries
    libbz2-dev \
    liblzma-dev \
    zlib1g-dev \
    # Git for devtools (if needed for any GitHub packages)
    git \
    && rm -rf /var/lib/apt/lists/* \
    && R CMD javareconf

# Install renv (required for restore)
RUN R -e 'install.packages("renv", repos = "https://cloud.r-project.org")'

# Set working directory
WORKDIR /app

# Copy renv infrastructure first (for layer caching)
# If renv.lock hasn't changed, Docker will use cached layers
COPY renv.lock renv.lock
COPY renv/activate.R renv/activate.R
COPY renv/settings.json renv/settings.json
COPY .Rprofile .Rprofile

# Restore packages from lockfile with BuildKit cache
# The cache mount persists the renv cache across builds
# This dramatically speeds up rebuilds when only a few packages change
RUN --mount=type=cache,target=/renv_cache \
    R -e 'renv::restore()'

# Copy application code AFTER package installation
# This ensures code changes don't invalidate the package cache layer
COPY endpoints/ endpoints/
COPY functions/ functions/
COPY config.yml config.yml
COPY start_sysndd_api.R start_sysndd_api.R

# Expose API port
EXPOSE 7777

# Start the Plumber API
CMD ["Rscript", "start_sysndd_api.R"]
```

**Key changes from current Dockerfile:**

1. **Base image:** rocker/r-ver:4.4.2 instead of rocker/tidyverse:4.3.2
   - Smaller base (~800MB vs ~2GB)
   - tidyverse packages come via renv.lock instead

2. **Package installation:** renv::restore() instead of 34 devtools::install_version() calls
   - Single command installs all packages
   - Versions locked via renv.lock
   - pak enables parallel downloads

3. **Binary packages:** P3M repository provides pre-compiled .deb-like R packages
   - No source compilation for most packages
   - ~70% faster installation

4. **System dependencies:** Single consolidated RUN instead of interleaved apt-get
   - Better layer caching
   - Cleaner Dockerfile

5. **BuildKit cache:** Persistent renv cache across builds
   - Subsequent builds reuse downloaded packages
   - Only changed packages need re-download

6. **Copy order optimization:**
   - renv files first (rarely change)
   - Application code last (frequently changes)
   - Maximizes cache hit rate

**Important:** The renv.lock file MUST exist before this Dockerfile can be used. Plan 03-01 creates it.
  </action>
  <verify>
```bash
# Validate Dockerfile syntax (requires Docker)
docker build --check api/

# Or manually verify key patterns exist:
grep -q "renv::restore" api/Dockerfile && echo "OK: renv::restore present"
grep -q "packagemanager.posit.co" api/Dockerfile && echo "OK: P3M repository configured"
grep -q "RENV_CONFIG_PAK_ENABLED" api/Dockerfile && echo "OK: pak enabled"
grep -q "cache,target=/renv_cache" api/Dockerfile && echo "OK: BuildKit cache configured"

# Count RUN commands (should be ~3-4, not 34+)
grep -c "^RUN" api/Dockerfile
```
  </verify>
  <done>
- api/Dockerfile completely rewritten
- Uses renv::restore() instead of individual install_version() calls
- P3M repository configured for binary packages
- pak enabled for parallel downloads
- System dependencies consolidated into single RUN layer
- BuildKit cache configured for renv
- Copy order optimized for cache efficiency
- RUN command count reduced from 34+ to ~3-4
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify Dockerfile builds successfully</name>
  <files>api/Dockerfile</files>
  <action>
Build the Docker image to verify it works:

```bash
# Build with BuildKit enabled and timing
DOCKER_BUILDKIT=1 time docker build -t sysndd-api:test ./api/

# If build fails, capture the error and diagnose:
# - Missing system dependency? Add to apt-get install
# - Package not found? Check renv.lock has correct version
# - P3M binary unavailable? Some packages may compile from source (acceptable)
```

**Expected build phases:**
1. System dependencies: ~1-2 minutes
2. renv installation: ~30 seconds
3. Package restore: ~3-7 minutes (mostly downloads, minimal compilation)
4. Code copy: ~5 seconds

**Total expected time:** 5-10 minutes

**If build fails:**
1. Check error message for missing system library
2. Add library to apt-get install line
3. Rebuild and re-test

**Common issues:**
- BiocManager packages (STRINGdb, biomaRt) may need Bioconductor repo
  - Solution: These should be in renv.lock; renv handles Bioconductor automatically
- Java configuration for xlsx/rJava
  - Solution: `R CMD javareconf` is already in Dockerfile
  </action>
  <verify>
```bash
# Test that image runs and API starts
docker run --rm -d --name sysndd-api-test -p 7778:7777 sysndd-api:test

# Wait for startup
sleep 10

# Check if container is still running (didn't crash)
docker ps | grep sysndd-api-test && echo "OK: Container running"

# Stop test container
docker stop sysndd-api-test

# Check image size
docker images sysndd-api:test --format "{{.Size}}"
```
  </verify>
  <done>
- Docker build completes successfully
- Build time under 10 minutes on first build
- Container starts without crash
- Image size reasonable (~2-3GB with all R packages)
  </done>
</task>

</tasks>

<verification>
1. **Build time measurement:**
   ```bash
   DOCKER_BUILDKIT=1 time docker build -t sysndd-api:test ./api/ 2>&1 | tail -5
   # Should show real time < 10 minutes
   ```

2. **Package verification:**
   ```bash
   docker run --rm sysndd-api:test Rscript -e "installed.packages()[,'Package']" | head -20
   # Should list expected packages (plumber, RMariaDB, etc.)
   ```

3. **API startup test:**
   ```bash
   docker run --rm -d --name api-test sysndd-api:test
   sleep 5
   docker logs api-test 2>&1 | grep -i "running\|listening\|started"
   docker stop api-test
   ```

4. **Layer count check:**
   ```bash
   docker history sysndd-api:test --no-trunc | wc -l
   # Should be ~10-15 layers (not 40+)
   ```
</verification>

<success_criteria>
1. api/Dockerfile rewritten with renv-based package installation
2. Docker build completes in under 10 minutes
3. All packages install successfully (from P3M binaries where available)
4. Container starts without errors
5. RUN commands reduced from 34+ to ~3-4
6. Build uses layer caching effectively (rebuild after code change < 30 seconds)
</success_criteria>

<output>
After completion, create `.planning/phases/03-package-management-docker-modernization/03-03-SUMMARY.md`
</output>
