---
phase: 32-async-jobs
plan: 03
type: execute
wave: 3
depends_on: ["32-02"]
files_modified:
  - api/endpoints/jobs_endpoints.R
  - app/src/views/admin/ManageAnnotations.vue
autonomous: true

must_haves:
  truths:
    - "Admin can see table of recent async jobs (last 20) sorted newest first"
    - "Job history table shows job type, status, started timestamp, duration, and user"
    - "Failed jobs in history show truncated error message with tooltip for full text"
    - "Status column shows colored badges (green=completed, red=failed, blue=running)"
  artifacts:
    - path: "api/endpoints/jobs_endpoints.R"
      provides: "Job history list endpoint"
      contains: "jobs/history"
    - path: "app/src/views/admin/ManageAnnotations.vue"
      provides: "Job history table using GenericTable"
      contains: "JobHistoryTable"
  key_links:
    - from: "app/src/views/admin/ManageAnnotations.vue"
      to: "/api/jobs/history"
      via: "axios GET"
      pattern: "api/jobs/history"
    - from: "app/src/views/admin/ManageAnnotations.vue"
      to: "app/src/components/small/GenericTable.vue"
      via: "component import"
      pattern: "GenericTable"
---

<objective>
Add job history API endpoint and display table in ManageAnnotations.vue

Purpose: Admins need visibility into recent async job activity - what jobs ran, when, how long they took, and whether they succeeded or failed. This completes the async job UI by providing a history view.

Output: Backend /api/jobs/history endpoint returning recent jobs, job history table in ManageAnnotations.vue using GenericTable component.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-async-jobs/32-CONTEXT.md
@.planning/phases/32-async-jobs/32-RESEARCH.md
@.planning/phases/32-async-jobs/32-01-SUMMARY.md
@.planning/phases/32-async-jobs/32-02-SUMMARY.md
@api/endpoints/jobs_endpoints.R
@api/functions/job-manager.R
@app/src/views/admin/ManageAnnotations.vue
@app/src/components/small/GenericTable.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add get_job_history function to job-manager.R</name>
  <files>api/functions/job-manager.R</files>
  <action>
Add a `get_job_history()` function to job-manager.R that returns recent jobs from the jobs_env environment.

Function specification:
```r
#' Get Job History
#'
#' Returns a list of recent jobs from the jobs environment.
#' Includes both running and completed jobs, sorted by submission time (newest first).
#'
#' @param limit Integer maximum number of jobs to return (default 20)
#' @return List of job records with: job_id, operation, status, submitted_at, completed_at, duration_seconds, error_message
get_job_history <- function(limit = 20) {
  # Implementation:
  # 1. Get all job IDs from jobs_env
  # 2. Extract relevant fields from each job
  # 3. Calculate duration_seconds (completed_at - submitted_at for completed jobs, or now - submitted_at for running)
  # 4. Sort by submitted_at descending
  # 5. Return top `limit` jobs
}
```

The function should return a data frame or list with columns:
- job_id: UUID string
- operation: "clustering", "phenotype_clustering", "ontology_update", "hgnc_update"
- status: "pending", "running", "completed", "failed"
- submitted_at: ISO 8601 timestamp
- completed_at: ISO 8601 timestamp or NULL
- duration_seconds: integer (calculated)
- error_message: string or NULL (extracted from job$error$message)

Handle edge cases:
- Empty jobs_env: return empty list
- Jobs without completed_at: use current time for duration calculation
- Jobs with complex error objects: extract just the message string
  </action>
  <verify>
1. Run: `cd /home/bernt-popp/development/sysndd/api && Rscript -e "lintr::lint('functions/job-manager.R')"`
2. Verify function signature matches specification
3. Verify function handles empty jobs_env
  </verify>
  <done>
get_job_history() function exists in job-manager.R, returns job list sorted by submitted_at descending, calculates duration, extracts error messages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add job history API endpoint</name>
  <files>api/endpoints/jobs_endpoints.R</files>
  <action>
Add a new endpoint to list recent job history.

Create: `GET /api/jobs/history`

The endpoint should:
1. Require Administrator role (since job history is admin-only information)
2. Accept optional `limit` query parameter (default 20, max 100)
3. Call `get_job_history(limit)` from job-manager.R
4. Return JSON with { data: [...jobs], meta: { count: N, limit: L } }

Example response:
```json
{
  "data": [
    {
      "job_id": "550e8400-e29b-41d4-a716-446655440000",
      "operation": "ontology_update",
      "status": "completed",
      "submitted_at": "2026-01-25T10:30:00Z",
      "completed_at": "2026-01-25T10:35:00Z",
      "duration_seconds": 300,
      "error_message": null
    }
  ],
  "meta": {
    "count": 1,
    "limit": 20
  }
}
```

Place the endpoint BEFORE the `/<job_id>/status` route (which is a catch-all pattern).
  </action>
  <verify>
1. Run: `grep -n "jobs/history" /home/bernt-popp/development/sysndd/api/endpoints/jobs_endpoints.R`
2. Verify endpoint exists and requires Administrator role
3. Verify endpoint is placed before the catch-all /<job_id>/status route
  </verify>
  <done>
GET /api/jobs/history endpoint exists, requires Administrator role, returns job list with metadata.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add job history table to ManageAnnotations.vue</name>
  <files>app/src/views/admin/ManageAnnotations.vue</files>
  <action>
Add a Job History section to ManageAnnotations.vue below the existing cards.

Implementation:
1. Import GenericTable component (already used in deprecated entities section)
2. Add reactive state for job history:
   ```typescript
   const jobHistory = ref<JobHistoryItem[]>([]);
   const jobHistoryLoading = ref(false);
   ```
3. Add fetchJobHistory() function that calls GET /api/jobs/history
4. Call fetchJobHistory() on mount and after any job completes

Template structure:
```vue
<BCard header-tag="header" class="mb-3">
  <template #header>
    <h5 class="mb-0 text-start font-weight-bold d-flex align-items-center">
      Job History
      <BButton
        size="sm"
        variant="outline-secondary"
        class="ms-auto"
        @click="fetchJobHistory"
        :disabled="jobHistoryLoading"
      >
        <BSpinner v-if="jobHistoryLoading" small class="me-1" />
        Refresh
      </BButton>
    </h5>
  </template>

  <GenericTable
    :items="jobHistory"
    :fields="jobHistoryFields"
    :is-busy="jobHistoryLoading"
    :sort-by="[{ key: 'submitted_at', order: 'desc' }]"
  >
    <!-- Custom cells for job_type, status, duration, error -->
  </GenericTable>
</BCard>
```

Table fields definition:
```typescript
const jobHistoryFields = [
  { key: 'operation', label: 'Job Type', sortable: true },
  { key: 'status', label: 'Status', sortable: true },
  { key: 'submitted_at', label: 'Started', sortable: true },
  { key: 'duration_seconds', label: 'Duration', sortable: true },
  { key: 'error_message', label: 'Error', sortable: false },
];
```

Custom cell templates:
- **operation**: Display as badge (e.g., "HGNC Update", "Ontology Update")
- **status**: Colored badge (bg-success for completed, bg-danger for failed, bg-primary for running, bg-info for pending)
- **submitted_at**: Format as locale datetime string
- **duration_seconds**: Format as "Xm Ys" (reuse elapsedTimeDisplay logic)
- **error_message**: Truncate to 50 chars with tooltip for full message, show "—" if null

Use the formatDuration helper from existing code or create one:
```typescript
function formatDuration(seconds: number | null): string {
  if (!seconds) return '—';
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
}
```
  </action>
  <verify>
1. Run: `cd /home/bernt-popp/development/sysndd/app && npm run type-check`
2. Verify GenericTable is used for job history
3. Verify fetchJobHistory calls /api/jobs/history
4. Verify custom cell templates exist for status badges and duration formatting
  </verify>
  <done>
ManageAnnotations.vue displays Job History table with GenericTable, shows job type/status/duration/errors with proper formatting and badges.
  </done>
</task>

</tasks>

<verification>
Phase verification commands:
```bash
# Backend linting
cd /home/bernt-popp/development/sysndd/api && Rscript -e "lintr::lint('functions/job-manager.R')"
cd /home/bernt-popp/development/sysndd/api && Rscript -e "lintr::lint('endpoints/jobs_endpoints.R')"

# Frontend type check
cd /home/bernt-popp/development/sysndd/app && npm run type-check

# Verify job history function exists
grep -n "get_job_history" /home/bernt-popp/development/sysndd/api/functions/job-manager.R

# Verify endpoint exists
grep -n "jobs/history" /home/bernt-popp/development/sysndd/api/endpoints/jobs_endpoints.R

# Verify GenericTable usage for job history
grep -n "GenericTable" /home/bernt-popp/development/sysndd/app/src/views/admin/ManageAnnotations.vue
grep -n "jobHistory" /home/bernt-popp/development/sysndd/app/src/views/admin/ManageAnnotations.vue
```
</verification>

<success_criteria>
- [ ] get_job_history() function added to job-manager.R
- [ ] GET /api/jobs/history endpoint created
- [ ] Endpoint requires Administrator role
- [ ] Endpoint returns jobs sorted by submitted_at descending
- [ ] Job history table added to ManageAnnotations.vue
- [ ] Table uses GenericTable component
- [ ] Status column shows colored badges
- [ ] Duration column formatted as "Xm Ys"
- [ ] Error column truncated with tooltip
- [ ] Table refreshes after job completion
- [ ] TypeScript check passes
- [ ] R lintr check passes
</success_criteria>

<output>
After completion, create `.planning/phases/32-async-jobs/32-03-SUMMARY.md`
</output>
