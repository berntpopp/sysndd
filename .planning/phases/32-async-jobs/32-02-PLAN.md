---
phase: 32-async-jobs
plan: 02
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - api/endpoints/jobs_endpoints.R
  - app/src/views/admin/ManageAnnotations.vue
autonomous: true

must_haves:
  truths:
    - "HGNC update button triggers async job with progress display"
    - "HGNC card header shows 'Last: YYYY-MM-DD' badge before starting job"
    - "HGNC progress bar shows elapsed time and indeterminate animation"
    - "Failed HGNC jobs show specific error message (not generic 'Job failed')"
  artifacts:
    - path: "api/endpoints/jobs_endpoints.R"
      provides: "HGNC update async job submission endpoint"
      contains: "hgnc_update/submit"
    - path: "app/src/views/admin/ManageAnnotations.vue"
      provides: "HGNC section using useAsyncJob composable"
      contains: "useAsyncJob"
  key_links:
    - from: "app/src/views/admin/ManageAnnotations.vue"
      to: "app/src/composables/useAsyncJob.ts"
      via: "composable import"
      pattern: "import.*useAsyncJob.*from '@/composables'"
    - from: "app/src/views/admin/ManageAnnotations.vue"
      to: "/api/jobs/hgnc_update/submit"
      via: "axios POST"
      pattern: "api/jobs/hgnc_update/submit"
---

<objective>
Add HGNC async job endpoint and refactor ManageAnnotations.vue to use useAsyncJob composable

Purpose: HGNC update currently uses synchronous endpoint with no progress feedback. Convert to async pattern with progress display (matching ontology update UX), and refactor ManageAnnotations.vue to use the new useAsyncJob composable for both jobs.

Output: Backend HGNC async endpoint, ManageAnnotations.vue refactored with useAsyncJob composable, progress UI for HGNC updates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-async-jobs/32-CONTEXT.md
@.planning/phases/32-async-jobs/32-RESEARCH.md
@.planning/phases/32-async-jobs/32-01-SUMMARY.md
@api/endpoints/jobs_endpoints.R
@api/endpoints/admin_endpoints.R
@api/functions/job-manager.R
@app/src/views/admin/ManageAnnotations.vue
@app/src/composables/useAsyncJob.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add HGNC async job endpoint</name>
  <files>api/endpoints/jobs_endpoints.R</files>
  <action>
Add a new async job endpoint for HGNC updates following the pattern of ontology_update/submit (lines 328-424 in jobs_endpoints.R).

Create: `POST /api/jobs/hgnc_update/submit`

The endpoint should:
1. Require Administrator role (use `require_role(req, res, "Administrator")`)
2. Check for duplicate running jobs using `check_duplicate_job("hgnc_update", list(operation = "hgnc_update"))`
3. Create async job using `create_job()` with:
   - operation = "hgnc_update"
   - params = list() (HGNC update has no variable params)
   - executor_fn that calls `update_process_hgnc_data()` (from external-functions.R)
4. Return HTTP 202 Accepted with job_id and status_url

Key differences from ontology_update:
- No database pre-fetch needed (HGNC updates directly in daemon since it writes to files)
- Faster estimated time (estimated_seconds = 60-120)
- Retry-After = 10 (shorter than ontology update's 30)

Note: The existing synchronous endpoint in admin_endpoints.R (update_hgnc_data) should remain for backward compatibility - we're adding a new async version.
  </action>
  <verify>
1. Run: `grep -n "hgnc_update/submit" /home/bernt-popp/development/sysndd/api/endpoints/jobs_endpoints.R`
2. Verify endpoint uses require_role and check_duplicate_job
3. Verify endpoint returns 202 status
  </verify>
  <done>
POST /api/jobs/hgnc_update/submit endpoint exists, requires Administrator role, checks for duplicates, creates async job, and returns 202 Accepted.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor ManageAnnotations.vue to use useAsyncJob</name>
  <files>app/src/views/admin/ManageAnnotations.vue</files>
  <action>
Refactor ManageAnnotations.vue to use the useAsyncJob composable from Plan 01.

Changes required:

1. **Convert to Composition API with script setup** (or hybrid setup + options):
   - Import useAsyncJob from '@/composables'
   - Create two job instances: one for ontology updates, one for HGNC updates
   ```typescript
   const ontologyJob = useAsyncJob((jobId) => `${import.meta.env.VITE_API_URL}/api/jobs/${jobId}/status`);
   const hgncJob = useAsyncJob((jobId) => `${import.meta.env.VITE_API_URL}/api/jobs/${jobId}/status`);
   ```

2. **Remove manual polling code** (lines 565-588, 578-587):
   - Remove pollInterval, elapsedTimer data properties
   - Remove startPolling(), stopPolling(), startElapsedTimer(), stopElapsedTimer() methods
   - Remove manual setInterval/clearInterval calls

3. **Update updateOntologyAnnotations()** (lines 527-563):
   - After receiving job_id from API, call `ontologyJob.startJob(response.data.job_id)`
   - Watch for ontologyJob.status === 'completed' to refresh annotation dates
   - Watch for ontologyJob.status === 'failed' to show toast with ontologyJob.error

4. **Update HGNC section** (lines 93-133):
   - Change button to call new async endpoint `/api/jobs/hgnc_update/submit`
   - Add progress display identical to ontology section (lines 46-88)
   - Use hgncJob reactive state for progress UI
   - Display hgncJob.elapsedTimeDisplay in progress bar

5. **Update template bindings**:
   - Replace `loading` with `ontologyJob.isLoading.value`
   - Replace `jobStatus` with `ontologyJob.status.value`
   - Replace `jobStep` with `ontologyJob.step.value`
   - Replace `progressPercent` computed with `ontologyJob.progressPercent.value`
   - Replace `elapsedTimeDisplay` computed with `ontologyJob.elapsedTimeDisplay.value`
   - Add similar bindings for HGNC section using hgncJob

6. **Keep existing non-job functionality**:
   - Keep fetchAnnotationDates() method
   - Keep fetchDeprecatedEntities() method
   - Keep deprecated entities table
   - Keep annotationDates reactive state

IMPORTANT: Do NOT remove the beforeUnmount cleanup - useAsyncJob handles cleanup internally but the component may have other cleanup needs.
  </action>
  <verify>
1. Run: `cd /home/bernt-popp/development/sysndd/app && npm run type-check`
2. Verify useAsyncJob is imported
3. Verify no setInterval/clearInterval in the file (except in useAsyncJob itself)
4. Verify both ontology and HGNC sections have progress display
  </verify>
  <done>
ManageAnnotations.vue uses useAsyncJob composable for both ontology and HGNC jobs, has progress display for HGNC, and all manual polling code is removed.
  </done>
</task>

</tasks>

<verification>
Phase verification commands:
```bash
# Backend syntax check
cd /home/bernt-popp/development/sysndd/api && Rscript -e "lintr::lint('endpoints/jobs_endpoints.R')"

# Frontend type check
cd /home/bernt-popp/development/sysndd/app && npm run type-check

# Verify HGNC endpoint exists
grep -n "hgnc_update/submit" /home/bernt-popp/development/sysndd/api/endpoints/jobs_endpoints.R

# Verify useAsyncJob usage in ManageAnnotations
grep -n "useAsyncJob" /home/bernt-popp/development/sysndd/app/src/views/admin/ManageAnnotations.vue

# Verify no manual setInterval in ManageAnnotations (should be 0 matches)
grep -c "setInterval" /home/bernt-popp/development/sysndd/app/src/views/admin/ManageAnnotations.vue || echo "OK - no setInterval found"
```
</verification>

<success_criteria>
- [ ] POST /api/jobs/hgnc_update/submit endpoint created
- [ ] Endpoint requires Administrator role
- [ ] Endpoint returns 202 Accepted with job_id
- [ ] ManageAnnotations.vue imports and uses useAsyncJob
- [ ] HGNC section has progress bar with elapsed time
- [ ] HGNC card header shows "Last: YYYY-MM-DD" badge
- [ ] No manual setInterval/clearInterval in ManageAnnotations.vue
- [ ] Both ontology and HGNC jobs show specific error messages on failure
- [ ] TypeScript check passes
</success_criteria>

<output>
After completion, create `.planning/phases/32-async-jobs/32-02-SUMMARY.md`
</output>
