---
phase: 32-async-jobs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/composables/useAsyncJob.ts
  - app/src/composables/index.ts
autonomous: true

must_haves:
  truths:
    - "useAsyncJob composable provides reactive job state (status, step, progress, error)"
    - "Polling intervals cleanup automatically when component unmounts"
    - "Elapsed time updates every second and displays as 'Xm Ys' format"
    - "Progress bar switches between indeterminate (striped) and determinate (percentage) based on data"
  artifacts:
    - path: "app/src/composables/useAsyncJob.ts"
      provides: "Reusable async job composable with polling, progress, and cleanup"
      exports: ["useAsyncJob"]
      min_lines: 100
    - path: "app/src/composables/index.ts"
      provides: "Composable exports index"
      contains: "useAsyncJob"
  key_links:
    - from: "app/src/composables/useAsyncJob.ts"
      to: "@vueuse/core"
      via: "useIntervalFn import"
      pattern: "import.*useIntervalFn.*from '@vueuse/core'"
    - from: "app/src/composables/useAsyncJob.ts"
      to: "vue lifecycle"
      via: "onUnmounted cleanup"
      pattern: "onUnmounted"
---

<objective>
Extract useAsyncJob composable from ManageAnnotations.vue async job pattern

Purpose: Create a reusable composable for all long-running jobs (ontology updates, HGNC updates, clustering) with proper polling cleanup to prevent memory leaks. This formalizes the proven ManageAnnotations pattern into a shareable module.

Output: useAsyncJob.ts composable with VueUse useIntervalFn for auto-cleanup, reactive state management, and elapsed time display.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-async-jobs/32-CONTEXT.md
@.planning/phases/32-async-jobs/32-RESEARCH.md
@app/src/views/admin/ManageAnnotations.vue
@app/src/composables/useTableData.ts
@app/src/composables/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAsyncJob composable</name>
  <files>app/src/composables/useAsyncJob.ts</files>
  <action>
Create useAsyncJob.ts composable extracting the async job pattern from ManageAnnotations.vue (lines 346-641).

The composable should:
1. Accept a `statusEndpoint` function parameter that returns the polling URL given a job ID
2. Use VueUse `useIntervalFn` for BOTH polling (3s) and elapsed time (1s) intervals - this provides automatic cleanup via tryOnCleanup
3. Return reactive state: jobId, status, step, progress, error, elapsedSeconds
4. Return computed properties: hasRealProgress, progressPercent, elapsedTimeDisplay, progressVariant, isLoading, isPolling
5. Return control methods: startJob(jobId), stopPolling(), reset()
6. Handle R/Plumber array wrapping (scalars come as single-element arrays)
7. Stop polling on terminal states ('completed', 'failed')
8. Include explicit `onUnmounted(() => stopPolling())` as a safety net

TypeScript interface for job state:
```typescript
interface JobProgress {
  current: number;
  total: number;
}

type JobStatus = 'idle' | 'accepted' | 'running' | 'completed' | 'failed';
```

Key patterns from ManageAnnotations.vue to preserve:
- elapsedTimeDisplay: "Xm Ys" format (lines 398-405)
- statusBadgeClass: bg-info/bg-primary/bg-success/bg-danger (lines 411-418)
- progressVariant: danger for failed, success for completed, primary otherwise (lines 406-409)
- hasRealProgress: check progress.total > 0 (line 388-390)
- progressPercent: Math.round((current/total)*100) (lines 391-396)

DO NOT use manual setInterval - use VueUse useIntervalFn exclusively (handles cleanup automatically).
  </action>
  <verify>
1. Run: `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit src/composables/useAsyncJob.ts`
2. Verify file exports useAsyncJob function
3. Verify VueUse useIntervalFn is imported
4. Verify onUnmounted is imported from vue
  </verify>
  <done>
useAsyncJob.ts exists with TypeScript types, VueUse useIntervalFn for polling, elapsed time display, progress computation, and cleanup on unmount.
  </done>
</task>

<task type="auto">
  <name>Task 2: Export useAsyncJob from composables index</name>
  <files>app/src/composables/index.ts</files>
  <action>
Add useAsyncJob export to the composables index file.

Add this line following the existing export pattern:
```typescript
export { default as useAsyncJob } from './useAsyncJob';
// OR if using named export:
export { useAsyncJob } from './useAsyncJob';
```

Match the existing export style in index.ts (check if it uses default or named exports).
  </action>
  <verify>
1. Run: `grep -n "useAsyncJob" /home/bernt-popp/development/sysndd/app/src/composables/index.ts`
2. Verify the export line exists
  </verify>
  <done>
useAsyncJob is exported from composables index and can be imported via `import { useAsyncJob } from '@/composables'`
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify composable with type check</name>
  <files>app/src/composables/useAsyncJob.ts</files>
  <action>
Run full TypeScript check on the composables directory to ensure no type errors.

Also verify the composable follows Vue 3 composable naming conventions (use-prefixed) and returns refs/computed in a plain object for destructuring.
  </action>
  <verify>
1. Run: `cd /home/bernt-popp/development/sysndd/app && npm run type-check` (or `npx vue-tsc --noEmit`)
2. Verify no TypeScript errors related to useAsyncJob
3. Verify composable returns plain object (not reactive wrapper)
  </verify>
  <done>
useAsyncJob.ts passes TypeScript validation, exports are correct, and composable follows Vue 3 conventions.
  </done>
</task>

</tasks>

<verification>
Phase verification commands:
```bash
# TypeScript check
cd /home/bernt-popp/development/sysndd/app && npm run type-check

# Verify composable exists and has key exports
grep -n "export.*useAsyncJob" app/src/composables/useAsyncJob.ts
grep -n "useIntervalFn" app/src/composables/useAsyncJob.ts
grep -n "onUnmounted" app/src/composables/useAsyncJob.ts

# Verify index exports
grep -n "useAsyncJob" app/src/composables/index.ts
```
</verification>

<success_criteria>
- [ ] useAsyncJob.ts created with TypeScript types
- [ ] Uses VueUse useIntervalFn for polling (not manual setInterval)
- [ ] Handles elapsed time display in "Xm Ys" format
- [ ] Computes hasRealProgress, progressPercent, progressVariant
- [ ] Stops polling on terminal states
- [ ] Includes onUnmounted cleanup as safety net
- [ ] Exported from composables index
- [ ] Passes TypeScript type check
</success_criteria>

<output>
After completion, create `.planning/phases/32-async-jobs/32-01-SUMMARY.md`
</output>
