---
phase: 76-shared-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/functions/file-functions.R
  - api/functions/omim-functions.R
autonomous: true

must_haves:
  truths:
    - "get_omim_download_key() reads OMIM_DOWNLOAD_KEY from environment and stops with informative error if unset"
    - "download_genemap2() returns cached file path when genemap2 file exists and is less than 1 day old"
    - "download_genemap2(force=TRUE) downloads fresh file even when cache exists"
    - "check_file_age_days() correctly distinguishes files younger vs older than N days"
    - "Downloaded genemap2 file is named genemap2.YYYY-MM-DD.txt in data/ directory"
  artifacts:
    - path: "api/functions/file-functions.R"
      provides: "check_file_age_days() function for day-precision TTL checking"
      contains: "check_file_age_days"
    - path: "api/functions/omim-functions.R"
      provides: "get_omim_download_key() and download_genemap2() functions"
      contains: "download_genemap2"
  key_links:
    - from: "api/functions/omim-functions.R"
      to: "api/functions/file-functions.R"
      via: "check_file_age_days() and get_newest_file() calls"
      pattern: "check_file_age_days.*genemap2"
    - from: "api/functions/omim-functions.R"
      to: "OMIM_DOWNLOAD_KEY env var"
      via: "Sys.getenv in get_omim_download_key()"
      pattern: "Sys\\.getenv.*OMIM_DOWNLOAD_KEY"
---

<objective>
Add genemap2.txt download infrastructure with environment variable API key and 1-day TTL disk caching.

Purpose: INFRA-01 (env var for API key) and INFRA-02 (disk caching with 1-day TTL) are the foundation that all downstream OMIM work depends on. Without caching, repeated downloads trigger OMIM IP blocking. Without env var, the API key remains hardcoded in source.

Output: Two new functions in omim-functions.R (get_omim_download_key, download_genemap2) and one new function in file-functions.R (check_file_age_days).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/76-shared-infrastructure/76-RESEARCH.md

@api/functions/file-functions.R
@api/functions/omim-functions.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add day-precision file age check to file-functions.R</name>
  <files>api/functions/file-functions.R</files>
  <action>
Add a new function `check_file_age_days()` to file-functions.R, placed after the existing `check_file_age()` function (after line ~116). This function provides day-precision TTL checking needed for genemap2.txt 1-day caching.

The function signature: `check_file_age_days <- function(file_basename, folder, days)`

Implementation follows the same pattern as `check_file_age()` but uses `difftime()` with `units = "days"` instead of `interval() / months(1)`:

1. Construct regex pattern: `paste0(file_basename, "\\.\\d{4}-\\d{2}-\\d{2}")`
2. List files with `fs::dir_ls(folder, regexp = pattern)`
3. If no files, set `newest_date <- as.Date("1970-01-01")`
4. Otherwise extract dates with `stringr::str_extract(files, "\\d{4}-\\d{2}-\\d{2}")`, convert to Date, get max
5. Compute: `time_diff <- as.numeric(difftime(Sys.Date(), newest_date, units = "days"))`
6. Return `time_diff < days` (TRUE if file is fresh enough, FALSE if expired)

Add roxygen2 documentation matching the style of check_file_age(). Include `@param days A numeric. The number of days to compare the file's age with.` and `@return A logical. Returns TRUE if the most recent file is younger than the specified number of days, and FALSE otherwise.`

Do NOT modify the existing check_file_age() function -- it continues to work with months for all existing callers.
  </action>
  <verify>
Run: `cd /home/bernt-popp/development/sysndd && Rscript -e "source('api/functions/file-functions.R'); cat('check_file_age_days exists:', exists('check_file_age_days'), '\n')"`

Verify the function exists and is properly sourced without errors.
  </verify>
  <done>check_file_age_days() function exists in file-functions.R, sources without error, and returns TRUE/FALSE based on day-precision file age comparison.</done>
</task>

<task type="auto">
  <name>Task 2: Add get_omim_download_key() and download_genemap2() to omim-functions.R</name>
  <files>api/functions/omim-functions.R</files>
  <action>
Add two new functions to omim-functions.R. Place them AFTER the existing `download_mim2gene()` function (after line ~72) and BEFORE `parse_mim2gene()`.

**Function 1: get_omim_download_key()**

```r
get_omim_download_key <- function() {
  api_key <- Sys.getenv("OMIM_DOWNLOAD_KEY", "")
  if (api_key == "") {
    stop(
      "OMIM_DOWNLOAD_KEY environment variable not set.\n",
      "Add to .env file: OMIM_DOWNLOAD_KEY=your_key_here\n",
      "Or set in Docker Compose: environment: - OMIM_DOWNLOAD_KEY=${OMIM_DOWNLOAD_KEY}"
    )
  }
  return(api_key)
}
```

Add roxygen2 docs: retrieves the OMIM download API key from OMIM_DOWNLOAD_KEY environment variable. Stops with informative error if not set.

**Function 2: download_genemap2()**

Follow the exact same httr2 pattern as existing `download_mim2gene()` but with these differences:
- Uses `check_file_age_days()` instead of `check_file_age()` for 1-day TTL (not month-based)
- Parameters: `output_path = "data/"`, `force = FALSE`, `max_age_days = 1`
- URL: `sprintf("https://data.omim.org/downloads/%s/genemap2.txt", get_omim_download_key())`
- Output filename: `paste0(output_path, "genemap2.", current_date, ".txt")`
- Uses `message()` for logging: `[OMIM] Using cached genemap2.txt: {path}` on cache hit, `[OMIM] Downloaded genemap2.txt to {path}` on download
- Same httr2 retry logic: `max_tries = 3`, `max_seconds = 60`, `backoff = ~ 2^.x`, `req_timeout(30)`
- Same error handling: check `resp_status(response) != 200`, stop with HTTP status code in message
- Same directory creation: `if (!dir_exists(output_path)) dir_create(output_path)`
- Same binary write: `writeBin(resp_body_raw(response), output_file)`

Add roxygen2 documentation following download_mim2gene() style but noting: uses OMIM_DOWNLOAD_KEY environment variable (see get_omim_download_key()), 1-day TTL via check_file_age_days(), and that genemap2.txt requires an authenticated download URL.

IMPORTANT: Do NOT use `dplyr::select` or any dplyr in these functions -- they are pure download/caching functions using only httr2, fs, and base R.
  </action>
  <verify>
Run: `cd /home/bernt-popp/development/sysndd && Rscript -e "source('api/functions/file-functions.R'); source('api/functions/omim-functions.R'); cat('download_genemap2 exists:', exists('download_genemap2'), '\n'); cat('get_omim_download_key exists:', exists('get_omim_download_key'), '\n')"`

Verify both functions source without error.

Then run the existing omim-functions tests to ensure no regressions:
`cd /home/bernt-popp/development/sysndd/api && Rscript -e "testthat::test_file('tests/testthat/test-unit-omim-functions.R')"`

Then run lintr on modified files:
`cd /home/bernt-popp/development/sysndd/api && Rscript -e "lintr::lint('functions/file-functions.R')"` and `Rscript -e "lintr::lint('functions/omim-functions.R')"`
  </verify>
  <done>
get_omim_download_key() reads OMIM_DOWNLOAD_KEY env var and stops with informative error if unset. download_genemap2() downloads genemap2.txt with httr2 retry logic, 1-day TTL caching via check_file_age_days(), and date-stamped filename. Both functions source without error. All existing omim-functions tests pass. No lintr issues.
  </done>
</task>

</tasks>

<verification>
1. `source('api/functions/file-functions.R')` succeeds and `check_file_age_days` function exists
2. `source('api/functions/omim-functions.R')` succeeds and both `get_omim_download_key` and `download_genemap2` functions exist
3. All existing tests in `test-unit-omim-functions.R` continue to pass
4. `lintr::lint('functions/file-functions.R')` returns 0 issues
5. `lintr::lint('functions/omim-functions.R')` returns 0 issues
6. `get_omim_download_key()` stops with error when OMIM_DOWNLOAD_KEY is not set
</verification>

<success_criteria>
- check_file_age_days() added to file-functions.R with day-precision TTL checking
- get_omim_download_key() added to omim-functions.R reading OMIM_DOWNLOAD_KEY env var
- download_genemap2() added to omim-functions.R with 1-day TTL caching and httr2 retry logic
- All existing tests pass (no regressions)
- Zero lintr issues on both modified files
</success_criteria>

<output>
After completion, create `.planning/phases/76-shared-infrastructure/76-01-SUMMARY.md`
</output>
