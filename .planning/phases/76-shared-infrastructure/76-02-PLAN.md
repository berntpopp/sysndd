---
phase: 76-shared-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["76-01"]
files_modified:
  - api/functions/omim-functions.R
  - api/tests/testthat/test-unit-omim-functions.R
  - api/tests/testthat/fixtures/genemap2-sample.txt
autonomous: true

must_haves:
  truths:
    - "parse_genemap2() extracts disease_ontology_name, disease_ontology_id (OMIM:MIM), Mapping_key, and hpo_mode_of_inheritance_term_name from genemap2.txt Phenotypes column"
    - "parse_genemap2() handles genemap2.txt with 14 columns and stops with clear error if column count changes"
    - "parse_genemap2() normalizes 14 OMIM inheritance terms to standardized HPO term names"
    - "parse_genemap2() handles entries with no Phenotypes, no inheritance mode, and nested parentheses in disease names"
    - "Unit tests verify parsing with fixture file and do not download from OMIM"
    - "Unit tests verify check_file_age_days() caching logic from Plan 01"
  artifacts:
    - path: "api/functions/omim-functions.R"
      provides: "Shared parse_genemap2() function extracted from comparisons-functions.R"
      contains: "parse_genemap2"
    - path: "api/tests/testthat/test-unit-omim-functions.R"
      provides: "Unit tests for parse_genemap2(), check_file_age_days(), and download caching"
      contains: "parse_genemap2"
    - path: "api/tests/testthat/fixtures/genemap2-sample.txt"
      provides: "Mock genemap2.txt fixture with representative edge cases"
      min_lines: 10
  key_links:
    - from: "api/tests/testthat/test-unit-omim-functions.R"
      to: "api/functions/omim-functions.R"
      via: "source() and function calls in tests"
      pattern: "parse_genemap2"
    - from: "api/functions/omim-functions.R"
      to: "api/functions/comparisons-functions.R"
      via: "parse_genemap2 is extracted FROM comparisons, will be called BY comparisons in Phase 78"
      pattern: "parse_genemap2"
---

<objective>
Add shared parse_genemap2() function and comprehensive unit tests with fixture data.

Purpose: INFRA-03 (defensive column mapping) and INFRA-04 (Phenotypes column parsing with disease name, MIM number, mapping key, and inheritance extraction) complete the shared infrastructure. The parser is extracted from the production-tested comparisons-functions.R::parse_omim_genemap2() and generalized for reuse by both ontology (Phase 77) and comparisons (Phase 78) systems.

Output: parse_genemap2() function in omim-functions.R, genemap2-sample.txt fixture, and expanded test suite covering parsing edge cases and download caching logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/76-shared-infrastructure/76-RESEARCH.md
@.planning/phases/76-shared-infrastructure/76-01-SUMMARY.md

@api/functions/omim-functions.R
@api/functions/comparisons-functions.R
@api/tests/testthat/test-unit-omim-functions.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create genemap2 fixture and add parse_genemap2() to omim-functions.R</name>
  <files>
    api/tests/testthat/fixtures/genemap2-sample.txt
    api/functions/omim-functions.R
  </files>
  <action>
**Step A: Create genemap2-sample.txt fixture file**

Create `api/tests/testthat/fixtures/genemap2-sample.txt` -- a mock genemap2.txt file for unit testing. This file must NOT contain real OMIM data to avoid licensing issues. Use synthetic but structurally accurate data.

The file format:
- Lines starting with `#` are comments (include 3-4 comment lines mimicking OMIM header)
- Tab-separated, 14 columns, NO header row
- Column positions: Chromosome, Genomic_Position_Start, Genomic_Position_End, Cyto_Location, Computed_Cyto_Location, MIM_Number, Gene_Symbols, Gene_Name, Approved_Symbol, Entrez_Gene_ID, Ensembl_Gene_ID, Comments, Phenotypes, Mouse_Gene_Symbol_ID

Include these edge case rows (at minimum 6-8 data rows):

1. **Standard single phenotype with inheritance**: Gene with one disease, one MIM number, mapping key 3, "Autosomal dominant"
2. **Multiple phenotypes (semicolon-separated)**: Gene with 2+ diseases in Phenotypes column separated by "; "
3. **Multiple inheritance modes (comma-separated)**: Entry with "Autosomal dominant, Autosomal recessive"
4. **No phenotype**: Row where Phenotypes column (X13) is empty/NA
5. **Phenotype with nested parentheses in disease name**: Disease name like "Deafness, autosomal recessive 1A (Connexin 26)" containing parentheses
6. **No inheritance mode**: Phenotype entry with only disease name + MIM + mapping key, no inheritance after last paren
7. **Question mark inheritance**: Entry with "?Autosomal dominant" (uncertain)
8. **No approved symbol**: Row where Approved_Symbol (X9) is empty

Example row (tab-separated, showing what fields look like):
```
chr1\t1000000\t1100000\t1p36.33\t1p36.33\t100001\tTGENE1, TG1\tTest Gene 1\tTGENE1\t1001\tENSG00000000001\t\tTest disease 1, 100010 (3), Autosomal dominant\tTgene1
```

**Step B: Add parse_genemap2() function to omim-functions.R**

Add the shared `parse_genemap2()` function to omim-functions.R. Place it AFTER the new `download_genemap2()` function added in Plan 01 and BEFORE the existing `parse_mim2gene()` function.

Extract and generalize from `comparisons-functions.R::parse_omim_genemap2()` (lines 405-466). The shared function does NOT include the HPO phenotype filtering or NDD-specific logic -- those stay in comparisons-functions.R. The shared function ONLY handles:

1. **Read genemap2.txt** with `readr::read_tsv(genemap2_path, col_names = FALSE, comment = "#", show_col_types = FALSE)`

2. **Defensive column count check**: `if (ncol(raw_data) != 14) stop(sprintf("genemap2.txt column count mismatch. Expected 14, got %d. OMIM may have changed file format.", ncol(raw_data)))`

3. **Position-based column mapping** (copy from comparisons-functions.R lines 412-427):
   ```r
   dplyr::select(
     Chromosome = X1, Genomic_Position_Start = X2, Genomic_Position_End = X3,
     Cyto_Location = X4, Computed_Cyto_Location = X5, MIM_Number = X6,
     Gene_Symbols = X7, Gene_Name = X8, Approved_Symbol = X9,
     Entrez_Gene_ID = X10, Ensembl_Gene_ID = X11, Comments = X12,
     Phenotypes = X13, Mouse_Gene_Symbol_ID = X14
   )
   ```

4. **Select relevant columns**: `dplyr::select(Approved_Symbol, Phenotypes)`
   (Matches comparisons-functions.R source â€” gene-level MIM_Number not needed for Phenotypes parsing)

5. **Multi-stage Phenotypes parsing** (copy from comparisons-functions.R lines 429-446):
   - `separate_rows(Phenotypes, sep = "; ")` -- split multiple phenotypes
   - `separate(Phenotypes, c("disease_ontology_name", "hpo_mode_of_inheritance_term_name"), "\\), (?!.+\\))", fill = "right")` -- extract inheritance
   - `separate(disease_ontology_name, c("disease_ontology_name", "Mapping_key"), "\\((?!.+\\()", fill = "right")` -- extract mapping key
   - `mutate(Mapping_key = str_replace_all(Mapping_key, "\\)", ""))` -- clean paren
   - `separate(disease_ontology_name, c("disease_ontology_name", "MIM_Number"), ", (?=[0-9]{6})", fill = "right")` -- extract disease MIM number
   - Clean whitespace in Mapping_key and MIM_Number
   - `filter(!is.na(MIM_Number))` -- remove entries without disease MIM
   - `filter(!is.na(Approved_Symbol))` -- remove entries without gene symbol
   - `mutate(disease_ontology_id = paste0("OMIM:", MIM_Number))`

6. **Inheritance term processing** (copy from comparisons-functions.R lines 444-466):
   - `separate_rows(hpo_mode_of_inheritance_term_name, sep = ", ")` -- split multiple inheritance modes
   - `mutate(hpo_mode_of_inheritance_term_name = str_replace_all(hpo_mode_of_inheritance_term_name, "\\?", ""))` -- remove question marks
   - Remove MIM_Number column (now captured in disease_ontology_id) with `dplyr::select(-MIM_Number)`
   - `unique()` -- deduplicate

7. **Inheritance term normalization** with `case_when()` -- all 14 mappings (copy from comparisons-functions.R lines 449-466):
   - "Autosomal dominant" -> "Autosomal dominant inheritance"
   - "Autosomal recessive" -> "Autosomal recessive inheritance"
   - "Digenic dominant" -> "Digenic inheritance"
   - "Digenic recessive" -> "Digenic inheritance"
   - "Isolated cases" -> "Sporadic"
   - "Mitochondrial" -> "Mitochondrial inheritance"
   - "Multifactorial" -> "Multifactorial inheritance"
   - "Pseudoautosomal dominant" -> "X-linked dominant inheritance"
   - "Pseudoautosomal recessive" -> "X-linked recessive inheritance"
   - "Somatic mosaicism" -> "Somatic mosaicism"
   - "Somatic mutation" -> "Somatic mutation"
   - "X-linked" -> "X-linked inheritance"
   - "X-linked dominant" -> "X-linked dominant inheritance"
   - "X-linked recessive" -> "X-linked recessive inheritance"
   - "Y-linked" -> "Y-linked inheritance"
   - TRUE ~ hpo_mode_of_inheritance_term_name (pass through unknowns)

Return tibble with columns: Approved_Symbol, disease_ontology_name, disease_ontology_id, Mapping_key, hpo_mode_of_inheritance_term_name

Add roxygen2 documentation:
- Title: "Parse genemap2.txt file from OMIM"
- Description: Reads and parses the genemap2.txt file, extracting disease names, MIM numbers, mapping keys, and inheritance modes from the Phenotypes column. Uses position-based column mapping for defensive handling of column name variations.
- @param genemap2_path Character string, path to the genemap2.txt file
- @return Tibble with columns: Approved_Symbol, disease_ontology_name, disease_ontology_id, Mapping_key, hpo_mode_of_inheritance_term_name
- @details section explaining: genemap2.txt has no header row (uses # comment lines), columns mapped by position (14 columns expected), Phenotypes column uses multi-stage parsing with negative lookaheads
- @export

IMPORTANT: Use explicit `dplyr::select()`, `dplyr::mutate()`, `dplyr::filter()`, `tidyr::separate_rows()`, `tidyr::separate()`, `stringr::str_replace_all()` to avoid namespace conflicts (especially with biomaRt::select).
  </action>
  <verify>
Run: `cd /home/bernt-popp/development/sysndd && Rscript -e "source('api/functions/file-functions.R'); source('api/functions/omim-functions.R'); cat('parse_genemap2 exists:', exists('parse_genemap2'), '\n')"`

Quick smoke test with fixture:
`cd /home/bernt-popp/development/sysndd && Rscript -e "source('api/functions/file-functions.R'); source('api/functions/omim-functions.R'); result <- parse_genemap2('api/tests/testthat/fixtures/genemap2-sample.txt'); cat('Rows:', nrow(result), '\n'); cat('Columns:', paste(names(result), collapse=', '), '\n')"`

Run lintr: `cd /home/bernt-popp/development/sysndd/api && Rscript -e "lintr::lint('functions/omim-functions.R')"`
  </verify>
  <done>
parse_genemap2() exists in omim-functions.R, correctly parses the fixture file extracting disease names/MIM numbers/mapping keys/inheritance, returns expected columns, and has zero lintr issues.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive unit tests for parse_genemap2() and download caching</name>
  <files>api/tests/testthat/test-unit-omim-functions.R</files>
  <action>
Expand the existing test file `api/tests/testthat/test-unit-omim-functions.R` by adding new test sections AFTER the existing "Data format validation tests" section (after line ~489).

Add three new test sections:

**Section 1: check_file_age_days() tests** (from Plan 01's file-functions.R addition)

```r
# =============================================================================
# check_file_age_days() tests
# =============================================================================
```

Tests to add (use `withr::with_tempdir` for isolated test directories):

1. `"check_file_age_days returns FALSE when no matching files exist"` -- Create empty temp dir, call `check_file_age_days("genemap2", tempdir, 1)`, expect FALSE.

2. `"check_file_age_days returns TRUE for file created today"` -- Create file named `genemap2.{today's date}.txt` in temp dir, call with days=1, expect TRUE.

3. `"check_file_age_days returns FALSE for file older than threshold"` -- Create file named `genemap2.{date 3 days ago}.txt`, call with days=1, expect FALSE.

4. `"check_file_age_days returns TRUE for file within threshold"` -- Create file named `genemap2.{yesterday's date}.txt`, call with days=2, expect TRUE (file is 1 day old, threshold is 2 days).

Source file-functions.R at the top of these tests using the existing `api_dir` pattern.

**Section 2: download_genemap2() caching logic tests**

```r
# =============================================================================
# download_genemap2() caching logic tests
# =============================================================================
```

Tests (these test caching behavior WITHOUT making network calls):

1. `"download_genemap2 returns cached file when fresh"` -- In temp dir, create `genemap2.{today's date}.txt` with some content. Set OMIM_DOWNLOAD_KEY env var (to anything, it won't be used). Call `download_genemap2(output_path = tempdir)`. Expect it returns the cached file path without error. Use `withr::with_envvar(c(OMIM_DOWNLOAD_KEY = "test_key"), { ... })`.

2. `"get_omim_download_key stops when env var not set"` -- Use `withr::with_envvar(c(OMIM_DOWNLOAD_KEY = ""), { ... })`. Expect `get_omim_download_key()` throws error matching "OMIM_DOWNLOAD_KEY".

3. `"get_omim_download_key returns key when set"` -- Use `withr::with_envvar(c(OMIM_DOWNLOAD_KEY = "test_key_123"), { ... })`. Expect `get_omim_download_key()` returns "test_key_123".

**Section 3: parse_genemap2() tests**

```r
# =============================================================================
# parse_genemap2() tests
# =============================================================================
```

Tests using the fixture file:

1. `"parse_genemap2 returns expected columns"` -- Parse fixture file, check that result has columns: Approved_Symbol, disease_ontology_name, disease_ontology_id, Mapping_key, hpo_mode_of_inheritance_term_name.

2. `"parse_genemap2 extracts disease MIM numbers as OMIM: IDs"` -- Parse fixture, check all disease_ontology_id values match `^OMIM:\\d{6}$` pattern.

3. `"parse_genemap2 normalizes inheritance terms"` -- Parse fixture, check that "Autosomal dominant" becomes "Autosomal dominant inheritance" (and "Autosomal recessive" becomes "Autosomal recessive inheritance").

4. `"parse_genemap2 handles multiple phenotypes per gene"` -- Parse fixture, check that the gene with multiple phenotypes (semicolon-separated) appears in multiple rows.

5. `"parse_genemap2 removes question marks from inheritance"` -- Parse fixture, check no "?" characters remain in hpo_mode_of_inheritance_term_name column.

6. `"parse_genemap2 filters entries without MIM number"` -- Parse fixture, verify no NA values in disease_ontology_id.

7. `"parse_genemap2 filters entries without approved symbol"` -- Parse fixture, verify no NA values in Approved_Symbol.

8. `"parse_genemap2 stops on unexpected column count"` -- Create a temp file with only 10 tab-separated columns (not 14), call parse_genemap2(), expect error matching "column count mismatch".

9. `"parse_genemap2 handles nested parentheses in disease names"` -- Parse fixture, check that disease names with parentheses (like "Connexin 26") are preserved in disease_ontology_name.

Use `testthat::test_path("fixtures/genemap2-sample.txt")` to locate the fixture file. Wrap the source + test logic in the same `tryCatch` pattern used by existing tests in this file.

IMPORTANT: Follow the EXACT same test structure pattern as existing tests in this file -- `tryCatch({ source(...); test assertions }, error = function(e) { skip(...) })` wrapping pattern.
  </action>
  <verify>
Run the full test file:
`cd /home/bernt-popp/development/sysndd/api && Rscript -e "testthat::test_file('tests/testthat/test-unit-omim-functions.R')"`

All tests should pass (both existing and new).

Run lintr on the test file:
`cd /home/bernt-popp/development/sysndd/api && Rscript -e "lintr::lint('tests/testthat/test-unit-omim-functions.R')"`

Run the full file-functions test suite to confirm no regressions:
`cd /home/bernt-popp/development/sysndd/api && Rscript -e "testthat::test_file('tests/testthat/test-unit-file-functions.R')"`
  </verify>
  <done>
All new tests pass: check_file_age_days (4 tests), download caching logic (3 tests), parse_genemap2 (9 tests). All existing tests continue to pass. Zero lintr issues on test file. Total new test count: ~16 new tests added.
  </done>
</task>

</tasks>

<verification>
1. `parse_genemap2("api/tests/testthat/fixtures/genemap2-sample.txt")` returns tibble with expected columns and multiple rows
2. Fixture file has 14 tab-separated columns per data row and includes edge cases (nested parens, multiple phenotypes, no inheritance)
3. All tests in `test-unit-omim-functions.R` pass (both old and new)
4. `test-unit-file-functions.R` tests still pass (no regressions from check_file_age_days addition)
5. `lintr::lint('functions/omim-functions.R')` returns 0 issues
6. `lintr::lint('tests/testthat/test-unit-omim-functions.R')` returns 0 issues
7. Column count validation stops with error on non-14-column files
8. Inheritance normalization maps all 14 OMIM terms to HPO standardized names
</verification>

<success_criteria>
- parse_genemap2() in omim-functions.R extracts disease name, MIM number, mapping key, and inheritance from Phenotypes column
- Defensive column count check stops with clear error if genemap2.txt format changes
- 14 inheritance term mappings normalize OMIM terms to HPO vocabulary
- genemap2-sample.txt fixture covers edge cases without using real OMIM data
- ~16 new unit tests pass covering parsing, caching, and env var handling
- All pre-existing tests pass (no regressions)
- Zero lintr issues across all modified files
</success_criteria>

<output>
After completion, create `.planning/phases/76-shared-infrastructure/76-02-SUMMARY.md`
</output>
