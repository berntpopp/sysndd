---
phase: 46-model-organism-phenotypes
plan: 02
type: execute
wave: 2
depends_on: ["46-01"]
files_modified:
  - app/src/components/gene/ModelOrganismsCard.vue
  - app/src/views/pages/GeneView.vue
autonomous: true

must_haves:
  truths:
    - "User can see mouse phenotype count with zygosity breakdown"
    - "User can see rat phenotype count"
    - "Card is hidden when neither mouse nor rat has data"
    - "Error state distinguishes API failure from 'no data'"
    - "External links to MGI and RGD databases work"
  artifacts:
    - path: "app/src/components/gene/ModelOrganismsCard.vue"
      provides: "Combined MGI + RGD phenotype display card"
      min_lines: 150
    - path: "app/src/views/pages/GeneView.vue"
      provides: "Updated gene page with Model Organisms card"
      contains: "ModelOrganismsCard"
  key_links:
    - from: "app/src/components/gene/ModelOrganismsCard.vue"
      to: "app/src/types/external.ts"
      via: "imports MGIPhenotypeData, RGDPhenotypeData"
      pattern: "import.*MGIPhenotypeData.*RGDPhenotypeData"
    - from: "app/src/views/pages/GeneView.vue"
      to: "app/src/composables/useModelOrganismData.ts"
      via: "imports useModelOrganismData"
      pattern: "import.*useModelOrganismData"
    - from: "app/src/views/pages/GeneView.vue"
      to: "app/src/components/gene/ModelOrganismsCard.vue"
      via: "renders ModelOrganismsCard component"
      pattern: "<ModelOrganismsCard"
---

<objective>
Create the Model Organisms card component and integrate it into GeneView.vue.

Purpose: Display mouse (MGI) and rat (RGD) phenotype data in a combined card with two-column layout, following the established card pattern from GeneClinVarCard.vue.

Output: ModelOrganismsCard.vue component with loading/error/data states, integrated into the gene page after the ClinVar card.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-model-organism-phenotypes/46-CONTEXT.md
@.planning/phases/46-model-organism-phenotypes/46-RESEARCH.md
@.planning/phases/46-model-organism-phenotypes/46-01-SUMMARY.md

# Existing patterns to follow
@app/src/components/gene/GeneClinVarCard.vue
@app/src/views/pages/GeneView.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ModelOrganismsCard.vue component</name>
  <files>app/src/components/gene/ModelOrganismsCard.vue</files>
  <action>
Create a new Vue component at app/src/components/gene/ModelOrganismsCard.vue following the GeneClinVarCard.vue pattern.

**Props interface:**
```typescript
interface Props {
  geneSymbol: string
  mgiLoading: boolean
  mgiError: string | null
  mgiData: MGIPhenotypeData | null
  rgdLoading: boolean
  rgdError: string | null
  rgdData: RGDPhenotypeData | null
}
```

**Emits:** `retry` (for retry button)

**Card structure (per CONTEXT.md):**

1. **Header:** "Model Organisms" with no external link (links are in each section)

2. **Hide card entirely** if both sources have no data AND no error:
   - Use `v-if="showCard"` computed that returns true if:
     - mgiData exists OR mgiError exists OR
     - rgdData exists OR rgdError exists OR
     - mgiLoading OR rgdLoading

3. **Two-column layout** using BRow/BCol:
   - Mouse (MGI) on left: cols="12" md="6" with right border on md+
   - Rat (RGD) on right: cols="12" md="6"

4. **Mouse (MGI) section:**
   - Section header: Icon (bi-mouse or bi-heart-pulse as mouse icon doesn't exist) + "Mouse (MGI)"
   - Loading state: BSpinner with "Loading mouse data..."
   - Error state: Icon + error message + retry button
   - Empty state: "No mouse phenotype data"
   - Data state:
     - Total count badge (variant="primary"): "N phenotypes"
     - Zygosity breakdown badges (if any phenotypes have zygosity):
       - Homozygous: variant="danger", label "hm (N)"
       - Heterozygous: custom warning class, label "ht (N)"
       - Conditional: variant="info", label "cn (N)"
     - External link button to MGI database page

5. **Rat (RGD) section:**
   - Section header: Icon (bi-database) + "Rat (RGD)"
   - Loading state: BSpinner with "Loading rat data..."
   - Error state: Icon + error message + retry button
   - Empty state: "No rat phenotype data"
   - Data state:
     - Total count badge (variant="primary"): "N phenotypes"
     - External link button to RGD database page
     - Note: No zygosity breakdown (RGD API doesn't provide it)

6. **Accessibility (WCAG 2.2 AA):**
   - Card: role="region" aria-label="Model organism phenotypes"
   - All badges: aria-label with full description
     - Example: `:aria-label="\`${count} total phenotypes from MGI\`"`
     - Zygosity: `:aria-label="\`${count} homozygous phenotypes\`"`
   - Error states: role="alert"
   - Section headers: <h6> with small class
   - External links: aria-label="View gene on MGI database (opens in new tab)"

7. **Zygosity counting logic:**
   - Computed property to count phenotypes by zygosity from mgiData.phenotypes array
   - Handle missing/undefined zygosity gracefully (some phenotypes may not have it)

**Styling:**
- Match GeneClinVarCard styling (BCard with body-class="p-0", border-variant="dark")
- Custom badge class for heterozygous (yellow/warning): `.badge-warning-custom`
- Border between columns on md+ screens: `.border-end-md` with media query
  </action>
  <verify>
Run `npm run type-check` in app directory - should pass.
Run `npm run lint` in app directory - should pass.
Check file exists: `ls -la app/src/components/gene/ModelOrganismsCard.vue`
  </verify>
  <done>
ModelOrganismsCard.vue exists with:
- Two-column layout (Mouse left, Rat right)
- Independent loading/error/empty/data states per source
- MGI shows total count + zygosity breakdown badges
- RGD shows total count only
- Card hidden when both sources empty and not loading/error
- All badges have aria-labels for accessibility
- External links to MGI and RGD database pages
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ModelOrganismsCard into GeneView.vue</name>
  <files>app/src/views/pages/GeneView.vue</files>
  <action>
Update GeneView.vue to fetch model organism data and render the ModelOrganismsCard.

**1. Add imports:**
```typescript
import { useModelOrganismData } from '@/composables/useModelOrganismData';
import ModelOrganismsCard from '@/components/gene/ModelOrganismsCard.vue';
```

**2. Add composable usage after existing composables:**
```typescript
// Model organism data (MGI + RGD)
const { mgi, rgd, fetchData: fetchModelOrganismData, retry: retryModelOrganismData } = useModelOrganismData(geneSymbol);
```

**3. Update fetchExternalData function:**
Add fetchModelOrganismData to the Promise.all:
```typescript
async function fetchExternalData(): Promise<void> {
  await Promise.all([
    fetchClinvarData(),
    fetchUniprotData(),
    fetchModelOrganismData()
  ]);
}
```

**4. Add retryModelOrganismData to the retry functions or create a combined retry.**

**5. Add ModelOrganismsCard to the template:**
Place AFTER the existing GeneClinVarCard row, in a new BRow. Position per CONTEXT.md: "after ClinVar card".

```vue
<!-- Model Organisms Card (MGI + RGD phenotypes) -->
<div class="container-fluid">
  <BContainer fluid>
    <BRow class="justify-content-md-center pt-2">
      <BCol cols="12" md="6" class="mb-2">
        <ModelOrganismsCard
          :gene-symbol="geneSymbol"
          :mgi-loading="mgi.loading.value"
          :mgi-error="mgi.error.value"
          :mgi-data="mgi.data.value"
          :rgd-loading="rgd.loading.value"
          :rgd-error="rgd.error.value"
          :rgd-data="rgd.data.value"
          @retry="retryModelOrganismData"
        />
      </BCol>
    </BRow>
  </BContainer>
</div>
```

Note: The card itself is full-width within the column (cols="12" md="6"), positioned in the left column. Adjust layout as needed to match existing card positioning.

Actually, looking at the existing layout:
- GeneConstraintCard and GeneClinVarCard are side-by-side (each md="6")
- ProteinDomainLollipopCard is full width (cols="12")

For ModelOrganismsCard, place it similarly to the constraint/ClinVar row OR as a new row. Per CONTEXT.md "after ClinVar card", put it in a new row:

```vue
<!-- Model Organisms Card (MGI + RGD phenotypes) - after ClinVar row -->
<div class="container-fluid">
  <BContainer fluid>
    <BRow class="justify-content-md-center pt-2">
      <BCol cols="12" md="6" class="mb-2">
        <ModelOrganismsCard
          :gene-symbol="geneSymbol"
          :mgi-loading="mgi.loading.value"
          :mgi-error="mgi.error.value"
          :mgi-data="mgi.data.value"
          :rgd-loading="rgd.loading.value"
          :rgd-error="rgd.error.value"
          :rgd-data="rgd.data.value"
          @retry="retryModelOrganismData"
        />
      </BCol>
    </BRow>
  </BContainer>
</div>
```

Place this BEFORE the Protein Domain Lollipop Plot section.
  </action>
  <verify>
Run `npm run type-check` in app directory - should pass.
Run `npm run lint` in app directory - should pass.
Run `npm run dev` and visit a gene page (e.g., /Gene/SCN1A) - Model Organisms card should appear.
  </verify>
  <done>
GeneView.vue updated with:
- useModelOrganismData composable imported and used
- fetchModelOrganismData called in parallel with other external data
- ModelOrganismsCard component rendered after ClinVar card row
- Retry handler wired to retryModelOrganismData
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `cd app && npm run type-check`
2. ESLint passes: `cd app && npm run lint`
3. Dev server starts: `cd app && npm run dev`
4. ModelOrganismsCard visible on gene page (e.g., /Gene/SCN1A)
5. Card shows two columns (mouse left, rat right) on desktop
6. Loading spinners appear while fetching
7. Phenotype counts display with badges
8. External links work (MGI and RGD open in new tabs)
</verification>

<success_criteria>
- ORGANISM-01: Mouse phenotype card displays phenotype count with zygosity breakdown (hm/ht/cn badges)
- ORGANISM-02: Rat phenotype card displays phenotype count
- ORGANISM-03: Data fetched via backend proxy endpoints (not direct frontend calls)
- ORGANISM-04: Empty state shows "No [mouse/rat] phenotype data" when gene has no phenotypes
- Card hidden entirely when neither source has data/error/loading
</success_criteria>

<output>
After completion, create `.planning/phases/46-model-organism-phenotypes/46-02-SUMMARY.md`
</output>
