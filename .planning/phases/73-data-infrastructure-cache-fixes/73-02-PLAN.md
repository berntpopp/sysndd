---
phase: 73-data-infrastructure-cache-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - api/start_sysndd_api.R
  - docs/DEPLOYMENT.md
autonomous: true

must_haves:
  truths:
    - "After a code deployment that changes cached data structures, GeneNetworks table and LLM summaries display correctly"
    - "Stale memoisation cache does not serve outdated formats after code changes"
    - "Deployment documentation explains when and how to handle cache invalidation"
  artifacts:
    - path: "api/start_sysndd_api.R"
      provides: "CACHE_VERSION-based cache invalidation on startup"
      contains: "CACHE_VERSION"
    - path: "docs/DEPLOYMENT.md"
      provides: "Cache management documentation for deployments"
      contains: "Cache"
  key_links:
    - from: "api/start_sysndd_api.R"
      to: "CACHE_VERSION env var"
      via: "Sys.getenv and cache directory management"
      pattern: "CACHE_VERSION"
    - from: "api/start_sysndd_api.R"
      to: "/app/cache directory"
      via: "fs::dir_ls and unlink on version mismatch"
      pattern: "cache.*version"
---

<objective>
Implement cache versioning so stale memoisation cache is automatically invalidated when code deployments change cached data structures.

Purpose: DATA-03 (issue #157) prevents stale cache from serving outdated data after code changes. Currently, the memoise disk cache (`/app/cache`, `max_age = Inf`) persists across container restarts, which means code changes that affect cached function outputs (e.g., adding `nrow(.) > 0` filtering) produce stale results until manual cache clearing.

Output: Modified `api/start_sysndd_api.R` with CACHE_VERSION-based invalidation at startup, and updated `docs/DEPLOYMENT.md` with cache management section.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/73-data-infrastructure-cache-fixes/73-RESEARCH.md

# Key source files
@api/start_sysndd_api.R
@docs/DEPLOYMENT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CACHE_VERSION-based cache invalidation to API startup</name>
  <files>api/start_sysndd_api.R</files>
  <action>
Modify `api/start_sysndd_api.R` to add cache version tracking and automatic invalidation. Insert this logic BEFORE the existing memoisation setup (before the "9) Memoize certain functions" section, around line 353).

Implementation:

1. Add a new section "8.5) Cache version management" BEFORE the memoisation section:

```r
## -------------------------------------------------------------------##
# 8.5) Cache version management
## -------------------------------------------------------------------##
# The memoise disk cache persists across container restarts with max_age = Inf.
# When code changes affect memoised function outputs (return structure, filtering
# logic, etc.), stale cache entries serve outdated data.
#
# CACHE_VERSION environment variable triggers automatic cache clearing when
# incremented. Operators should bump this on deployments that change cached
# data structures. See docs/DEPLOYMENT.md for details.
#
# How it works:
# 1. Read CACHE_VERSION from environment (default: "1")
# 2. Compare against .cache_version file in cache directory
# 3. If mismatch (or no file): clear all cache files and write new version
# 4. If match: skip (cache is current)

cache_dir <- "/app/cache"
cache_version <- Sys.getenv("CACHE_VERSION", "1")
cache_version_file <- file.path(cache_dir, ".cache_version")

# Ensure cache directory exists
if (!dir.exists(cache_dir)) {
  dir.create(cache_dir, recursive = TRUE)
}

# Check stored version
stored_version <- tryCatch(
  readLines(cache_version_file, n = 1, warn = FALSE),
  error = function(e) ""
)

if (length(stored_version) == 0) stored_version <- ""

if (stored_version != cache_version) {
  message(sprintf(
    "[%s] Cache version mismatch (stored: '%s', current: '%s') - clearing cache",
    Sys.time(), stored_version, cache_version
  ))

  # Remove all .rds cache files but preserve directory structure
  cache_files <- list.files(cache_dir, pattern = "\\.rds$", full.names = TRUE, recursive = TRUE)
  if (length(cache_files) > 0) {
    unlink(cache_files)
    message(sprintf("[%s] Cleared %d cached files", Sys.time(), length(cache_files)))
  }

  # Write new version marker
  writeLines(cache_version, cache_version_file)
  message(sprintf("[%s] Cache version set to '%s'", Sys.time(), cache_version))
} else {
  message(sprintf("[%s] Cache version '%s' is current - no clearing needed", Sys.time(), cache_version))
}
```

2. Place this IMMEDIATELY BEFORE the line `cm <- cachem::cache_disk(` (the start of section 9).

Key design decisions:
- Use `.cache_version` file (dot-prefix) so cachem ignores it (cachem stores .rds files)
- Only delete `.rds` files to preserve the directory structure and the version file itself
- Default CACHE_VERSION to "1" so existing deployments without the env var work without change
- Use `list.files(..., recursive = TRUE)` to also clear the `external/dynamic/` subdirectory
- Do NOT use `memoise::forget()` because the memoised functions are not yet created at this point in startup

IMPORTANT: Do NOT change the existing memoisation section (section 9). The cache clearing happens BEFORE cachem::cache_disk() is called, so cachem starts fresh.

Also add CACHE_VERSION to the docker-compose.yml environment section for the api service. Check docker-compose.yml for the api service environment block and add:
```yaml
CACHE_VERSION: ${CACHE_VERSION:-1}
```
  </action>
  <verify>
1. Read `api/start_sysndd_api.R` and verify:
   - New section 8.5 exists before section 9
   - CACHE_VERSION read from Sys.getenv with default "1"
   - Version comparison logic with .cache_version file
   - Cache files cleared on mismatch (pattern = "\\.rds$", recursive = TRUE)
   - Version file written after clearing
   - Existing memoisation section (section 9) is unchanged
2. Grep for "CACHE_VERSION" in api/start_sysndd_api.R -- expect 3+ occurrences
3. Verify docker-compose.yml has CACHE_VERSION in api environment
  </verify>
  <done>
`api/start_sysndd_api.R` has CACHE_VERSION-based cache invalidation that automatically clears stale .rds files when the version env var is incremented, running before memoised functions are created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document cache management in DEPLOYMENT.md</name>
  <files>docs/DEPLOYMENT.md</files>
  <action>
Add a "Cache Management" section to `docs/DEPLOYMENT.md` BEFORE the "Docker Compose Files" section (before line 170). This section documents the CACHE_VERSION mechanism and provides operational guidance.

Add the following section:

```markdown
## Cache Management

The SysNDD API uses [memoise](https://memoise.r-lib.org/) with disk-based caching (`/app/cache`) for expensive computations (gene clustering, network edges, statistics). Cache entries have infinite TTL and persist across container restarts.

### CACHE_VERSION Environment Variable

Controls automatic cache invalidation on deployment. When the value changes, all cached `.rds` files are cleared on next API startup.

| Setting | Default | Description |
|---------|---------|-------------|
| `CACHE_VERSION` | 1 | Cache version identifier; increment to invalidate |

**When to increment CACHE_VERSION:**

| Change Type | Increment? | Example |
|-------------|------------|---------|
| Modified memoised function logic | Yes | Changed filtering in `gen_string_clust_obj()` |
| Changed return structure of cached function | Yes | Added/removed columns from cached tibble |
| New API endpoint (not cached) | No | Added `/api/foo/bar` |
| Frontend-only changes | No | Updated Vue components |
| Database schema migration | Maybe | Only if cached queries reference changed columns |

**Configuration:**

```yaml
# docker-compose.yml (already configured)
services:
  api:
    environment:
      CACHE_VERSION: ${CACHE_VERSION:-1}
```

Or via `.env` file:

```bash
CACHE_VERSION=2  # Increment from previous value
```

### Manual Cache Clearing

For immediate cache invalidation without redeployment:

```bash
# Clear all cached data
docker exec sysndd-api-1 rm -f /app/cache/*.rds
docker exec sysndd-api-1 rm -rf /app/cache/external/dynamic/*.rds

# Restart to rebuild cache on demand
docker compose restart api
```

### Cached Functions

The following functions use disk memoisation:

| Function | Purpose | Cache Impact |
|----------|---------|--------------|
| `gen_string_clust_obj_mem` | STRING protein clustering | High (large objects) |
| `gen_mca_clust_obj_mem` | MCA clustering | High |
| `gen_network_edges_mem` | Network edge data | Medium |
| `generate_stat_tibble_mem` | Statistics tables | Low |
| `generate_gene_news_tibble_mem` | Gene news data | Low |
| `nest_gene_tibble_mem` | Gene table nesting | Low |
| `generate_tibble_fspec_mem` | Functional spec tables | Low |
| `read_log_files_mem` | Log file parsing | Low |
| `nest_pubtator_gene_tibble_mem` | Pubtator gene data | Low |

### Troubleshooting

**Symptom: Code deployed but behavior unchanged**
- Cause: Stale cache serving pre-deployment data
- Solution: Increment `CACHE_VERSION` in `.env` and restart: `docker compose up -d`

**Symptom: "No records to show" after code fix**
- Cause: Cached empty/differently-structured tibble from before the fix
- Solution: Clear cache manually (see above) or increment CACHE_VERSION
```

Also add CACHE_VERSION to the "Optional (with defaults)" environment variables table in the existing "Environment Variables Reference" section:

| `CACHE_VERSION` | 1 | Cache version; increment to clear stale cache on restart |

Update the "Last Updated" date at the top of the file to today's date.
  </action>
  <verify>
1. Read `docs/DEPLOYMENT.md` and verify:
   - "Cache Management" section exists with CACHE_VERSION table
   - "When to increment" guidance table
   - Manual clearing commands
   - Cached functions table listing all 9 memoised functions
   - Troubleshooting entries for cache issues
   - CACHE_VERSION added to environment variables reference table
   - Last Updated date is current
2. Grep for "CACHE_VERSION" in docs/DEPLOYMENT.md -- expect 5+ occurrences
  </verify>
  <done>
`docs/DEPLOYMENT.md` has comprehensive cache management section documenting CACHE_VERSION usage, when to increment, manual clearing commands, cached function inventory, and troubleshooting guidance.
  </done>
</task>

</tasks>

<verification>
1. `api/start_sysndd_api.R` contains CACHE_VERSION logic before memoisation setup
2. Cache invalidation clears .rds files recursively when version changes
3. `docs/DEPLOYMENT.md` has Cache Management section with operational guidance
4. CACHE_VERSION env var is in docker-compose.yml api service environment
5. Existing memoisation setup (section 9) is completely unchanged
6. Default CACHE_VERSION="1" means no behavior change for existing deployments
</verification>

<success_criteria>
- CACHE_VERSION env var controls automatic cache invalidation on API startup
- Version mismatch clears all .rds files and writes new version marker
- Version match skips clearing (no-op for normal restarts)
- DEPLOYMENT.md documents when and how to manage cache
- Backward compatible (default "1" means no clearing unless explicitly set)
</success_criteria>

<output>
After completion, create `.planning/phases/73-data-infrastructure-cache-fixes/73-02-SUMMARY.md`
</output>
