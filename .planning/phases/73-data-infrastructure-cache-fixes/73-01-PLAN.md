---
phase: 73-data-infrastructure-cache-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - db/migrations/012_widen_comparison_columns.sql
  - db/migrations/013_update_gene2phenotype_source.sql
autonomous: true

must_haves:
  truths:
    - "Comparisons Data Refresh job completes without column truncation errors"
    - "Gene2Phenotype download fetches data from the new API URL and parses the updated CSV format"
    - "Both migrations are idempotent (can be re-run without error)"
  artifacts:
    - path: "db/migrations/012_widen_comparison_columns.sql"
      provides: "Column widening migration for ndd_database_comparison"
      contains: "migrate_012_widen_comparison_columns"
    - path: "db/migrations/013_update_gene2phenotype_source.sql"
      provides: "Gene2Phenotype URL and format update"
      contains: "gene2phenotype"
  key_links:
    - from: "db/migrations/012_widen_comparison_columns.sql"
      to: "ndd_database_comparison table"
      via: "ALTER TABLE MODIFY with INFORMATION_SCHEMA guards"
      pattern: "INFORMATION_SCHEMA\\.COLUMNS"
    - from: "db/migrations/013_update_gene2phenotype_source.sql"
      to: "comparisons_config table"
      via: "UPDATE statement"
      pattern: "UPDATE comparisons_config"
---

<objective>
Create two database migrations to fix column truncation errors and update the Gene2Phenotype external data source URL.

Purpose: DATA-01 (issue #158) fixes production column truncation errors during Comparisons Data Refresh by widening narrow VARCHAR columns to TEXT. DATA-02 (issue #156) updates the Gene2Phenotype source URL from the deprecated downloads endpoint to the new API endpoint, and changes the file_format from csv.gz to csv.

Output: Two idempotent SQL migration files that the migration runner auto-applies on next API startup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/73-data-infrastructure-cache-fixes/73-RESEARCH.md

# Key source files for understanding patterns
@db/migrations/009_ndd_database_comparison.sql
@db/migrations/010_fix_radboudumc_url.sql
@api/functions/migration-runner.R
@api/functions/comparisons-functions.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration 012 to widen ndd_database_comparison columns</name>
  <files>db/migrations/012_widen_comparison_columns.sql</files>
  <action>
Create `db/migrations/012_widen_comparison_columns.sql` following the stored procedure + INFORMATION_SCHEMA pattern from migration 009.

The migration handles databases restored from OLD backups where ndd_database_comparison was created with narrow VARCHAR columns (before migration 009 was applied which creates them as TEXT). On databases where 009 already ran, these columns are already TEXT and the INFORMATION_SCHEMA checks will cause the migration to skip them (idempotent).

Structure:
1. Use `DELIMITER //` for stored procedure
2. `DROP PROCEDURE IF EXISTS migrate_012_widen_comparison_columns //`
3. Create procedure `migrate_012_widen_comparison_columns()` with these column checks:

   a. `version`: IF DATA_TYPE = 'varchar' AND CHARACTER_MAXIMUM_LENGTH < 255 THEN MODIFY to VARCHAR(255)
      - Reason: version strings come from filenames which are bounded but can be long paths
      - Keep as VARCHAR(255) since version is bounded data

   b. `publication_id`: IF DATA_TYPE = 'varchar' THEN MODIFY to TEXT
      - Reason: concatenated PMIDs (e.g., "12345678,23456789,...") can be arbitrarily long

   c. `phenotype`: IF DATA_TYPE = 'varchar' THEN MODIFY to TEXT
      - Reason: concatenated HPO terms can be very long

   d. `disease_ontology_name`: IF DATA_TYPE = 'varchar' THEN MODIFY to TEXT
      - Reason: long disease names from OMIM/Orphanet

   e. `inheritance`: IF DATA_TYPE = 'varchar' THEN MODIFY to TEXT
      - Reason: multiple inheritance terms concatenated

   f. `pathogenicity_mode`: IF DATA_TYPE = 'varchar' THEN MODIFY to TEXT
      - Reason: free-text pathogenicity descriptions

   g. `disease_ontology_id`: IF DATA_TYPE = 'varchar' AND CHARACTER_MAXIMUM_LENGTH < 500 THEN MODIFY to TEXT
      - Reason: multiple disease IDs concatenated (OMIM:123456;ORPHA:1234;...)

   h. `granularity`: IF DATA_TYPE = 'varchar' AND CHARACTER_MAXIMUM_LENGTH < 500 THEN MODIFY to TEXT
      - Reason: detailed granularity descriptions

Each check uses:
```sql
IF EXISTS (
    SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_SCHEMA = DATABASE()
      AND TABLE_NAME = 'ndd_database_comparison'
      AND COLUMN_NAME = '{column}'
      AND DATA_TYPE = 'varchar'
      {AND CHARACTER_MAXIMUM_LENGTH < N -- for VARCHAR targets only}
) THEN
    ALTER TABLE ndd_database_comparison
      MODIFY COLUMN {column} {new_type};
END IF;
```

4. `CALL migrate_012_widen_comparison_columns() //`
5. `DROP PROCEDURE IF EXISTS migrate_012_widen_comparison_columns //`
6. `DELIMITER ;`

Add header comment block matching existing migration style:
```
-- Migration: 012_widen_comparison_columns
-- Description: Widen ndd_database_comparison columns to prevent truncation (#158)
-- ...
```

IMPORTANT: Use `DATA_TYPE = 'varchar'` check (not CHARACTER_MAXIMUM_LENGTH alone) for columns being converted to TEXT, because TEXT columns have NULL for CHARACTER_MAXIMUM_LENGTH. This ensures the migration is truly idempotent -- if columns are already TEXT, the check returns no rows and the ALTER is skipped.

Do NOT group multiple ALTERs in a single IF block -- check each column independently so partial application is possible and each modification is atomic.
  </action>
  <verify>
1. Read the created file and verify:
   - DELIMITER syntax is correct (matches migration 009 pattern)
   - All 8 columns have independent INFORMATION_SCHEMA checks
   - Each IF block checks DATA_TYPE = 'varchar' before converting to TEXT
   - Stored procedure is created, called, and dropped
2. Run `wc -l db/migrations/012_widen_comparison_columns.sql` -- expect 80-120 lines
3. Verify migration filename sorts after 011: `ls db/migrations/ | tail -5`
  </verify>
  <done>
File `db/migrations/012_widen_comparison_columns.sql` exists with idempotent stored procedure that widens 8 columns (version to VARCHAR(255), and publication_id/phenotype/disease_ontology_name/inheritance/pathogenicity_mode/disease_ontology_id/granularity to TEXT), using INFORMATION_SCHEMA checks to skip columns already at target type.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create migration 013 to update Gene2Phenotype source URL and format</name>
  <files>db/migrations/013_update_gene2phenotype_source.sql</files>
  <action>
Create `db/migrations/013_update_gene2phenotype_source.sql` following the simple UPDATE pattern from migration 010.

This migration updates the Gene2Phenotype entry in `comparisons_config`:
- Old URL: `https://www.ebi.ac.uk/gene2phenotype/downloads/DDG2P.csv.gz`
- New URL: `https://www.ebi.ac.uk/gene2phenotype/api/panel/DD/download`
- Old format: `csv.gz`
- New format: `csv`

Structure (matches migration 010 exactly):
```sql
-- Migration 013: Update Gene2Phenotype source URL and format
--
-- Gene2Phenotype moved from legacy download to API-based endpoint.
-- The new endpoint returns plain CSV (not gzipped).
--
-- Old URL: https://www.ebi.ac.uk/gene2phenotype/downloads/DDG2P.csv.gz
-- New URL: https://www.ebi.ac.uk/gene2phenotype/api/panel/DD/download
-- Old format: csv.gz
-- New format: csv
--
-- Fixes: https://github.com/berntpopp/sysndd/issues/156

UPDATE comparisons_config
SET source_url = 'https://www.ebi.ac.uk/gene2phenotype/api/panel/DD/download',
    file_format = 'csv'
WHERE source_name = 'gene2phenotype';
```

This is naturally idempotent (UPDATE with WHERE clause -- running twice sets same values, second run affects 0 rows but does not error).

Do NOT use a stored procedure -- simple DML UPDATEs do not need INFORMATION_SCHEMA guards (as established by migration 010 pattern).
  </action>
  <verify>
1. Read the created file and verify:
   - UPDATE sets both source_url AND file_format
   - WHERE clause uses source_name = 'gene2phenotype'
   - New URL is `https://www.ebi.ac.uk/gene2phenotype/api/panel/DD/download`
   - New format is `csv`
   - Comment block references issue #156
2. Verify migration filename sorts after 012: `ls db/migrations/ | tail -5`
  </verify>
  <done>
File `db/migrations/013_update_gene2phenotype_source.sql` exists with UPDATE statement that changes Gene2Phenotype source_url to the new API endpoint and file_format to csv.
  </done>
</task>

</tasks>

<verification>
1. Both migration files exist in `db/migrations/` and sort correctly after 011
2. Migration 012 uses stored procedure with INFORMATION_SCHEMA guards (idempotent DDL)
3. Migration 013 uses simple UPDATE (naturally idempotent DML)
4. No syntax errors in SQL (DELIMITER usage matches migration 009 pattern)
5. Run `ls -1 db/migrations/*.sql | wc -l` -- expect 13 files (11 existing + 2 new)
</verification>

<success_criteria>
- Two new migration files created with correct naming (012, 013)
- Migration 012 widens 8 columns with individual INFORMATION_SCHEMA checks
- Migration 013 updates Gene2Phenotype URL and format
- Both migrations are idempotent (safe to run multiple times)
- Files follow established patterns (009 for DDL, 010 for DML)
</success_criteria>

<output>
After completion, create `.planning/phases/73-data-infrastructure-cache-fixes/73-01-SUMMARY.md`
</output>
