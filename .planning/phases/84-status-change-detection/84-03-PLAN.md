---
phase: 84-status-change-detection
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/views/curate/ApproveReview.vue
  - app/src/views/curate/ApproveStatus.vue
autonomous: true

must_haves:
  truths:
    - "In ApproveReview, clicking Submit on the status modal without changes closes modal silently"
    - "In ApproveReview, clicking Submit on the review modal without changes closes modal silently"
    - "In ApproveStatus, clicking Submit on the status modal without changes closes modal silently"
    - "In ApproveStatus, review_change indicator (exclamation-triangle) appears on the review edit button when backend reports review_change"
    - "Closing any form modal with unsaved changes triggers a confirmation dialog"
  artifacts:
    - path: "app/src/views/curate/ApproveReview.vue"
      provides: "Change detection on status and review forms, silent skip, unsaved warning"
      contains: "hasStatusChanges"
    - path: "app/src/views/curate/ApproveStatus.vue"
      provides: "Change detection on status form, silent skip, unsaved warning, review_change indicator"
      contains: "review_change"
  key_links:
    - from: "ApproveReview.vue submitStatusChange()"
      to: "hasStatusChanges check"
      via: "silent skip guard"
      pattern: "hasStatusChanges"
    - from: "ApproveStatus.vue actions cell"
      to: "row.item.review_change"
      via: "exclamation-triangle-fill icon"
      pattern: "review_change"
---

<objective>
Add change detection to ApproveReview and ApproveStatus views: silent skip on save when unchanged, unsaved-changes confirmation on modal close, and fix missing review_change indicator in ApproveStatus.

Purpose: These views use raw Status/Review class instances (not composables), so change detection is done locally by storing loaded values and comparing before submit. Also fixes the gap where ApproveStatus doesn't show review_change indicators despite backend providing the data.
Output: Both approve views with full change detection and consistent change indicators.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/84-status-change-detection/84-CONTEXT.md
@.planning/phases/84-status-change-detection/84-RESEARCH.md

@app/src/views/curate/ApproveReview.vue
@app/src/views/curate/ApproveStatus.vue
@app/src/views/curate/ApproveReview.vue (lines 384-393 for status_change indicator pattern)
@api/endpoints/status_endpoints.R (line 142 for review_change calculation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add change detection to ApproveReview status and review forms</name>
  <files>app/src/views/curate/ApproveReview.vue</files>
  <action>
ApproveReview uses raw `Status` and `Review` class instances (NOT composables). It has two modals: one for editing reviews and one for editing statuses. Both need change detection.

**1. Add loaded data tracking in data():**

Add to the `data()` return object (around line 1069):
```javascript
statusLoadedData: null, // Snapshot of status values when loaded
reviewLoadedData: null, // Snapshot of review values when loaded
```

**2. Add computed properties:**

Add a `computed` section to the component (between `data()` and `mounted()` or wherever appropriate -- ApproveReview uses Options API):
```javascript
computed: {
  hasStatusChanges() {
    if (!this.statusLoadedData) return false;
    return (
      this.status_info.category_id !== this.statusLoadedData.category_id ||
      this.status_info.comment !== this.statusLoadedData.comment ||
      this.status_info.problematic !== this.statusLoadedData.problematic
    );
  },
  hasReviewChanges() {
    if (!this.reviewLoadedData) return false;
    return (
      this.review_info.synopsis !== this.reviewLoadedData.synopsis ||
      this.review_info.comment !== this.reviewLoadedData.comment ||
      !this.arraysAreEqual(
        [...this.select_phenotype].sort(),
        [...this.reviewLoadedData.phenotypes].sort()
      ) ||
      !this.arraysAreEqual(
        [...this.select_variation].sort(),
        [...this.reviewLoadedData.variationOntology].sort()
      ) ||
      !this.arraysAreEqual(
        [...this.select_additional_references].sort(),
        [...this.reviewLoadedData.publications].sort()
      ) ||
      !this.arraysAreEqual(
        [...this.select_gene_reviews].sort(),
        [...this.reviewLoadedData.genereviews].sort()
      )
    );
  },
},
```

Note: ApproveReview already has an `arraysAreEqual` method (line 1855-1860). Use it directly.

**3. Snapshot loaded data in loadStatusInfo():**

Find `loadStatusInfo()` in ApproveReview (search for it -- it loads status data into `this.status_info`). After setting all status_info fields, add:
```javascript
this.statusLoadedData = {
  category_id: this.status_info.category_id,
  comment: this.status_info.comment || '',
  problematic: this.status_info.problematic || false,
};
```

**4. Snapshot loaded data in loadReviewInfo():**

Find `loadReviewInfo()` in ApproveReview (search for it -- it loads review data). After setting all form data fields (review_info, select_phenotype, select_variation, etc.), add:
```javascript
this.reviewLoadedData = {
  synopsis: this.review_info.synopsis || '',
  comment: this.review_info.comment || '',
  phenotypes: [...this.select_phenotype],
  variationOntology: [...this.select_variation],
  publications: [...this.select_additional_references],
  genereviews: [...this.select_gene_reviews],
};
```

**5. Add silent skip to submitStatusChange() (line 1623):**

At the top of the method, before the existing `if (this.status_info.status_approved === 0)` check:
```javascript
async submitStatusChange() {
  // Silent skip when nothing changed
  if (!this.hasStatusChanges) {
    this.$refs[this.statusModal.id].hide();
    return;
  }
  // ... existing logic
}
```

**6. Add silent skip to submitReviewChange() (line 1568):**

At the top:
```javascript
async submitReviewChange() {
  // Silent skip when nothing changed
  if (!this.hasReviewChanges) {
    this.$refs[this.reviewModal.id].hide();
    return;
  }
  this.isBusy = true;
  // ... existing logic
}
```

**7. Add @hide handlers to both modals:**

Find the status modal BModal element (search for `statusModal.id`) and add `@hide="onStatusModalHide"`.
Find the review modal BModal element (search for `reviewModal.id`) and add `@hide="onReviewModalHide"`.

Add the handler methods:
```javascript
onStatusModalHide(event) {
  if (this.hasStatusChanges && !this.isBusy) {
    const confirmed = window.confirm('You have unsaved status changes. Discard them?');
    if (!confirmed) {
      event.preventDefault();
    }
  }
},
onReviewModalHide(event) {
  if (this.hasReviewChanges && !this.isBusy) {
    const confirmed = window.confirm('You have unsaved review changes. Discard them?');
    if (!confirmed) {
      event.preventDefault();
    }
  }
},
```

**8. Reset loaded data in resetForm() (line 1789):**

Add at the end of resetForm():
```javascript
this.statusLoadedData = null;
this.reviewLoadedData = null;
```
  </action>
  <verify>
1. `cd /home/bernt-popp/development/sysndd/app && npm run type-check` -- no TypeScript errors
2. `cd /home/bernt-popp/development/sysndd/app && npm run lint` -- no ESLint errors
  </verify>
  <done>ApproveReview has change detection on both status and review modals with silent skip and unsaved-changes warning. No regressions.</done>
</task>

<task type="auto">
  <name>Task 2: Add change detection to ApproveStatus and fix missing review_change indicator</name>
  <files>app/src/views/curate/ApproveStatus.vue</files>
  <action>
ApproveStatus uses raw `Status` class instance for its status edit modal. It also needs the missing review_change indicator.

**1. Add loaded data tracking in data():**

Add to the `data()` return object (around line 740):
```javascript
statusLoadedData: null, // Snapshot of status values when loaded
```

**2. Add computed property:**

Add a `computed` section:
```javascript
computed: {
  hasStatusChanges() {
    if (!this.statusLoadedData) return false;
    return (
      this.status_info.category_id !== this.statusLoadedData.category_id ||
      this.status_info.comment !== this.statusLoadedData.comment ||
      this.status_info.problematic !== this.statusLoadedData.problematic
    );
  },
},
```

**3. Snapshot loaded data in loadStatusInfo() (line 1019):**

After setting all status_info fields (after line 1037):
```javascript
this.statusLoadedData = {
  category_id: this.status_info.category_id,
  comment: this.status_info.comment || '',
  problematic: this.status_info.problematic || false,
};
```

**4. Add silent skip to submitStatusChange() (line 1057):**

At the top:
```javascript
async submitStatusChange() {
  // Silent skip when nothing changed
  if (!this.hasStatusChanges) {
    this.$refs[this.statusModal.id].hide();
    return;
  }
  // ... existing logic
}
```

**5. Add @hide handler to status modal:**

Find the status edit modal BModal element (search for `statusModal.id`) and add `@hide="onStatusModalHide"`.

Add handler:
```javascript
onStatusModalHide(event) {
  if (this.hasStatusChanges && !this.isBusy) {
    const confirmed = window.confirm('You have unsaved status changes. Discard them?');
    if (!confirmed) {
      event.preventDefault();
    }
  }
},
```

**6. Reset loaded data in resetForm() (line 1088):**

Add: `this.statusLoadedData = null;`

**7. Fix missing review_change indicator in the actions cell template:**

Find the actions cell template (line 346 area, `#cell(actions)="row"`). The edit status button currently has a plain pen icon (lines 362-372):
```vue
<BButton
  v-b-tooltip.hover.left
  size="sm"
  class="me-1 btn-xs"
  variant="secondary"
  title="Edit status"
  ...
>
  <i class="bi bi-pen" aria-hidden="true" />
</BButton>
```

There is NO review edit button in ApproveStatus (curators don't edit reviews from the status approval view). However, the CONTEXT.md says to show a review_change indicator. The backend provides `review_change` in the status table data. The indicator should appear on the existing status action button area or as a separate visual indicator.

Since ApproveStatus doesn't have a review edit button, add the review_change indicator as a standalone warning badge in the actions column, AFTER the approve button:
```vue
<span
  v-if="row.item.review_change"
  v-b-tooltip.hover.right
  title="Review change pending"
  class="ms-1"
>
  <i
    class="bi bi-exclamation-triangle-fill text-warning"
    style="font-size: 0.8em"
    aria-hidden="true"
  />
</span>
```

Alternatively, match the pattern from ApproveReview more closely by wrapping the status edit (pen) button's icon in a position-relative span like the stoplights pattern:
```vue
<BButton
  v-b-tooltip.hover.left
  size="sm"
  class="me-1 btn-xs"
  variant="secondary"
  :title="row.item.review_change ? 'Edit status (review change pending)' : 'Edit status'"
  :aria-label="`Edit status for entity ${row.item.entity_id}${row.item.review_change ? ' (review change pending)' : ''}`"
  @click="infoStatus(row.item, row.index, $event.target)"
>
  <span class="position-relative d-inline-block" style="font-size: 0.9em">
    <i class="bi bi-pen" aria-hidden="true" />
    <i
      v-if="row.item.review_change"
      class="bi bi-exclamation-triangle-fill position-absolute text-warning"
      style="top: -0.3em; right: -0.5em; font-size: 0.7em"
      aria-hidden="true"
    />
  </span>
</BButton>
```

This matches the exact pattern from ApproveReview's status_change indicator on the stoplights button.

**8. Add review_change to legend items:**

Add to the `legendItems` array (line 742-752):
```javascript
{
  icon: 'bi bi-exclamation-triangle-fill',
  color: '#ffc107',
  label: 'Review change pending',
},
```
  </action>
  <verify>
1. `cd /home/bernt-popp/development/sysndd/app && npm run type-check` -- no TypeScript errors
2. `cd /home/bernt-popp/development/sysndd/app && npm run lint` -- no ESLint errors
3. `cd /home/bernt-popp/development/sysndd/app && npx vitest run --reporter=verbose` -- all existing tests pass
  </verify>
  <done>
ApproveStatus has change detection with silent skip and unsaved-changes warning.
ApproveStatus shows review_change indicator (exclamation-triangle on edit button) when backend reports review_change.
ApproveReview already has status_change indicator (confirmed existing).
Legend items updated in ApproveStatus.
No regressions.
  </done>
</task>

</tasks>

<verification>
1. TypeScript check passes: `cd /home/bernt-popp/development/sysndd/app && npm run type-check`
2. ESLint passes: `cd /home/bernt-popp/development/sysndd/app && npm run lint`
3. All tests pass: `cd /home/bernt-popp/development/sysndd/app && npx vitest run --reporter=verbose`
</verification>

<success_criteria>
- ApproveReview: silent skip on status submit without changes
- ApproveReview: silent skip on review submit without changes
- ApproveReview: unsaved-changes warning on modal close
- ApproveStatus: silent skip on status submit without changes
- ApproveStatus: unsaved-changes warning on modal close
- ApproveStatus: review_change exclamation-triangle indicator visible when backend flag is set
- ApproveStatus: legend includes "Review change pending" entry
- No regressions in existing approve workflows
</success_criteria>

<output>
After completion, create `.planning/phases/84-status-change-detection/84-03-SUMMARY.md`
</output>
