---
phase: 28-table-foundation
plan: 02
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - app/src/views/admin/ManageUser.vue
autonomous: true

must_haves:
  truths:
    - "Admin can search users by name, email, or institution with instant results (300ms debounce)"
    - "Admin can filter users by role (Curator/Reviewer/Admin) via multi-select dropdown"
    - "Admin can filter users by approval status (pending/approved)"
    - "Admin can paginate through users with page size control (10/25/50/100)"
    - "Admin can bookmark filtered/sorted user table state via URL (refresh preserves state)"
    - "Admin can export current filtered user data to Excel/CSV"
    - "Active filters displayed as removable pills below filter bar"
    - "Result count visible: 'Showing 1-20 of 156 users'"
  artifacts:
    - path: "app/src/views/admin/ManageUser.vue"
      provides: "Modernized user management table with TablesEntities pattern"
      min_lines: 500
  key_links:
    - from: "app/src/views/admin/ManageUser.vue"
      to: "/api/user/table"
      via: "axios GET with filter/sort/pagination params"
      pattern: "api/user/table"
    - from: "app/src/views/admin/ManageUser.vue"
      to: "history.replaceState"
      via: "URL state sync after API success"
      pattern: "history\\.replaceState"
    - from: "app/src/views/admin/ManageUser.vue"
      to: "useExcelExport"
      via: "composable import for CSV export"
      pattern: "useExcelExport"
---

<objective>
Modernize ManageUser.vue with the TablesEntities pattern for search, pagination, filtering, and URL state sync.

Purpose: Transform the basic user table into a modern, feature-rich management interface matching the established Entities table UX.

Output: A fully modernized ManageUser.vue with search, multi-select role filter, pagination, URL sync, and CSV export.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-table-foundation/28-RESEARCH.md
@.planning/phases/28-table-foundation/28-01-SUMMARY.md
@app/src/components/tables/TablesEntities.vue (reference pattern)
@app/src/views/admin/ManageUser.vue
@app/src/composables/useTableData.ts
@app/src/composables/useTableMethods.ts
@app/src/composables/useUrlParsing.ts
@app/src/composables/useExcelExport.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add search, filter, and pagination infrastructure</name>
  <files>app/src/views/admin/ManageUser.vue</files>
  <action>
Transform ManageUser.vue to use the TablesEntities pattern:

1. **Add module-level caching** (CRITICAL - prevents duplicate API calls on remount):
```javascript
// Module-level variables outside export default
let moduleLastApiParams = null;
let moduleApiCallInProgress = false;
let moduleLastApiCallTime = 0;
let moduleLastApiResponse = null;
```

2. **Add setup() composables**:
```javascript
import { useToast, useUrlParsing, useTableData, useTableMethods, useExcelExport } from '@/composables';

setup(props) {
  const { makeToast } = useToast();
  const { filterObjToStr, filterStrToObj, sortStringToVariables } = useUrlParsing();
  const { isExporting, exportToExcel } = useExcelExport();

  const tableData = useTableData({
    pageSizeInput: 25,
    sortInput: '+user_name',
    pageAfterInput: '0',
  });

  // Filter object structure for user table
  const filter = ref({
    any: { content: null, join_char: null, operator: 'contains' },
    user_name: { content: null, join_char: null, operator: 'contains' },
    email: { content: null, join_char: null, operator: 'contains' },
    user_role: { content: null, join_char: ',', operator: 'any' },
    approved: { content: null, join_char: null, operator: 'equals' },
    // ... other fields
  });

  return { ...tableData, filter, makeToast, filterObjToStr, filterStrToObj, isExporting, exportToExcel };
}
```

3. **Add isInitializing flag** for watcher guard:
```javascript
data() {
  return {
    isInitializing: true,
    loadDataDebounceTimer: null,
    // ... existing data
  };
}
```

4. **Add watchers with initialization guard**:
```javascript
watch: {
  filter: {
    handler() {
      if (this.isInitializing) return;
      this.filtered();
    },
    deep: true,
  },
  sortBy: {
    handler() {
      if (this.isInitializing) return;
      this.handleSortByOrDescChange();
    },
    deep: true,
  },
}
```

5. **Update mounted() for URL state initialization**:
```javascript
mounted() {
  // Parse URL params
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('sort')) {
    const sort_object = this.sortStringToVariables(urlParams.get('sort'));
    this.sortBy = sort_object.sortBy;
    this.sort = urlParams.get('sort');
  }
  if (urlParams.get('filter')) {
    this.filter = this.filterStrToObj(urlParams.get('filter'), this.filter);
    this.filter_string = urlParams.get('filter');
  }
  if (urlParams.get('page_after')) {
    this.currentItemID = parseInt(urlParams.get('page_after'), 10) || 0;
  }
  if (urlParams.get('page_size')) {
    this.perPage = parseInt(urlParams.get('page_size'), 10) || 25;
  }

  this.loadRoleList();
  this.$nextTick(() => {
    this.loadData();
    this.$nextTick(() => {
      this.isInitializing = false;
    });
  });
}
```

6. **Add loadData() with debouncing and module-level cache**:
```javascript
loadData() {
  if (this.loadDataDebounceTimer) {
    clearTimeout(this.loadDataDebounceTimer);
  }
  this.loadDataDebounceTimer = setTimeout(() => {
    this.loadDataDebounceTimer = null;
    this.doLoadData();
  }, 50);
},

async doLoadData() {
  const urlParam = `sort=${this.sort}&filter=${this.filter_string}&page_after=${this.currentItemID}&page_size=${this.perPage}`;
  const now = Date.now();

  // Prevent duplicate API calls
  if (moduleLastApiParams === urlParam && (now - moduleLastApiCallTime) < 500) {
    if (moduleLastApiResponse) {
      this.applyApiResponse(moduleLastApiResponse);
    }
    return;
  }

  if (moduleApiCallInProgress && moduleLastApiParams === urlParam) return;

  moduleLastApiParams = urlParam;
  moduleLastApiCallTime = now;
  moduleApiCallInProgress = true;
  this.isBusy = true;

  const apiUrl = `${import.meta.env.VITE_API_URL}/api/user/table?${urlParam}`;

  try {
    const response = await this.axios.get(apiUrl, {
      headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
    });
    moduleApiCallInProgress = false;
    moduleLastApiResponse = response.data;
    this.applyApiResponse(response.data);
    this.updateBrowserUrl(); // Update URL AFTER API success
    this.isBusy = false;
  } catch (e) {
    moduleApiCallInProgress = false;
    this.makeToast(e, 'Error', 'danger');
    this.isBusy = false;
  }
}
```

7. **Add updateBrowserUrl() using history.replaceState** (NOT router.replace):
```javascript
updateBrowserUrl() {
  if (this.isInitializing) return;
  const searchParams = new URLSearchParams();
  if (this.sort) searchParams.set('sort', this.sort);
  if (this.filter_string) searchParams.set('filter', this.filter_string);
  if (this.currentItemID > 0) searchParams.set('page_after', String(this.currentItemID));
  searchParams.set('page_size', String(this.perPage));

  const newUrl = `${window.location.pathname}?${searchParams.toString()}`;
  window.history.replaceState({ ...window.history.state }, '', newUrl);
}
```

8. **Add filtered(), handlePageChange(), handlePerPageChange(), handleSortByOrDescChange(), removeFilters()** methods following TablesEntities pattern.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/sysndd/app
npm run build 2>&1 | grep -E "(error|Error)" || echo "Build successful"
```
  </verify>
  <done>ManageUser.vue has search/filter/pagination infrastructure with module-level caching and URL sync</done>
</task>

<task type="auto">
  <name>Task 2: Add filter UI controls and result display</name>
  <files>app/src/views/admin/ManageUser.vue</files>
  <action>
Add the filter UI to ManageUser.vue template:

1. **Add header with controls** (matching TablesEntities layout):
```vue
<BCard header-tag="header" body-class="p-0" header-class="p-1" border-variant="dark">
  <template #header>
    <BRow>
      <BCol>
        <h5 class="mb-1 text-start">
          <strong>Manage Users</strong>
          <BBadge variant="secondary" class="ms-2">{{ totalRows }} users</BBadge>
        </h5>
      </BCol>
      <BCol class="text-end">
        <BButton
          v-b-tooltip.hover
          size="sm"
          class="me-1"
          :variant="isExporting ? 'secondary' : 'outline-primary'"
          :disabled="isExporting"
          title="Export to Excel"
          @click="handleExport"
        >
          <BSpinner v-if="isExporting" small />
          <i v-else class="bi bi-file-earmark-excel" />
        </BButton>
        <BButton
          v-b-tooltip.hover
          size="sm"
          :variant="removeFiltersButtonVariant"
          :title="removeFiltersButtonTitle"
          @click="removeFilters"
        >
          <i class="bi bi-funnel" />
        </BButton>
      </BCol>
    </BRow>
  </template>
```

2. **Add search and pagination row**:
```vue
<BRow class="px-2 py-2">
  <BCol sm="8">
    <BInputGroup>
      <template #prepend>
        <BInputGroupText><i class="bi bi-search" /></BInputGroupText>
      </template>
      <BFormInput
        v-model="filter.any.content"
        placeholder="Search by name, email, institution..."
        debounce="300"
        type="search"
        @update:model-value="filtered()"
      />
    </BInputGroup>
  </BCol>
  <BCol sm="4">
    <BContainer v-if="totalRows > perPage">
      <TablePaginationControls
        :total-rows="totalRows"
        :initial-per-page="perPage"
        :page-options="pageOptions"
        :current-page="currentPage"
        @page-change="handlePageChange"
        @per-page-change="handlePerPageChange"
      />
    </BContainer>
  </BCol>
</BRow>
```

3. **Add filter row with role multi-select and approval status**:
```vue
<BRow class="px-2 pb-2">
  <BCol sm="4">
    <BFormSelect
      v-model="filter.user_role.content"
      :options="roleFilterOptions"
      size="sm"
      @update:model-value="filtered()"
    >
      <template #first>
        <BFormSelectOption :value="null">All Roles</BFormSelectOption>
      </template>
    </BFormSelect>
  </BCol>
  <BCol sm="4">
    <BFormSelect
      v-model="filter.approved.content"
      :options="approvalFilterOptions"
      size="sm"
      @update:model-value="filtered()"
    >
      <template #first>
        <BFormSelectOption :value="null">All Status</BFormSelectOption>
      </template>
    </BFormSelect>
  </BCol>
  <BCol sm="4">
    <!-- Result count display -->
    <span class="text-muted small">
      Showing {{ (currentPage - 1) * perPage + 1 }}-{{ Math.min(currentPage * perPage, totalRows) }} of {{ totalRows }}
    </span>
  </BCol>
</BRow>
```

4. **Add active filter pills** (below filter bar):
```vue
<BRow v-if="hasActiveFilters" class="px-2 pb-2">
  <BCol>
    <BBadge
      v-for="(activeFilter, index) in activeFilters"
      :key="index"
      variant="secondary"
      class="me-2 mb-1"
    >
      {{ activeFilter.label }}: {{ activeFilter.value }}
      <BButton
        size="sm"
        variant="link"
        class="p-0 ms-1 text-light"
        @click="clearFilter(activeFilter.key)"
      >
        <i class="bi bi-x" />
      </BButton>
    </BBadge>
    <BButton
      size="sm"
      variant="link"
      class="p-0"
      @click="removeFilters"
    >
      Clear all
    </BButton>
  </BCol>
</BRow>
```

5. **Add computed properties for filters**:
```javascript
computed: {
  roleFilterOptions() {
    return this.role_options; // Already loaded from API
  },
  approvalFilterOptions() {
    return [
      { value: '1', text: 'Approved' },
      { value: '0', text: 'Pending' },
    ];
  },
  hasActiveFilters() {
    return Object.values(this.filter).some(f => f.content !== null && f.content !== '');
  },
  activeFilters() {
    const filters = [];
    if (this.filter.any.content) filters.push({ key: 'any', label: 'Search', value: this.filter.any.content });
    if (this.filter.user_role.content) filters.push({ key: 'user_role', label: 'Role', value: this.filter.user_role.content });
    if (this.filter.approved.content !== null) {
      filters.push({ key: 'approved', label: 'Status', value: this.filter.approved.content === '1' ? 'Approved' : 'Pending' });
    }
    return filters;
  },
}
```

6. **Add imports for components**:
```javascript
import TablePaginationControls from '@/components/small/TablePaginationControls.vue';
```

7. **Add clearFilter method**:
```javascript
clearFilter(key) {
  if (this.filter[key]) {
    this.filter[key].content = null;
  }
  this.filtered();
}
```
  </action>
  <verify>
Start dev server and visually verify:
- Search input with debounce
- Role dropdown filter
- Approval status filter
- Active filter pills with remove buttons
- Pagination controls
- Result count display
  </verify>
  <done>ManageUser.vue has complete filter UI with search, role filter, status filter, pills, and pagination</done>
</task>

<task type="auto">
  <name>Task 3: Add CSV export and polish</name>
  <files>app/src/views/admin/ManageUser.vue</files>
  <action>
Complete the ManageUser modernization with export and polish:

1. **Add handleExport method**:
```javascript
handleExport() {
  this.exportToExcel(this.users, {
    filename: `users_export_${new Date().toISOString().split('T')[0]}`,
    sheetName: 'Users',
    headers: {
      user_name: 'User Name',
      email: 'Email',
      user_role: 'Role',
      approved: 'Approved',
      abbreviation: 'Abbreviation',
      first_name: 'First Name',
      family_name: 'Family Name',
      orcid: 'ORCID',
      comment: 'Comment',
      created_at: 'Created',
    },
  });
}
```

2. **Update fields definition** to match API fspec:
```javascript
fields: [
  { key: 'user_name', label: 'Name', sortable: true, filterable: true, class: 'text-start' },
  { key: 'email', label: 'Email', sortable: true, filterable: true, class: 'text-start' },
  { key: 'user_role', label: 'Role', sortable: true, selectable: true, class: 'text-start' },
  { key: 'approved', label: 'Status', sortable: true, selectable: true, class: 'text-center' },
  { key: 'abbreviation', label: 'Abbrev.', sortable: true, class: 'text-start' },
  { key: 'created_at', label: 'Created', sortable: true, class: 'text-start' },
  { key: 'actions', label: 'Actions', class: 'text-center' },
],
```

3. **Add per-column filter inputs** in table header (following TablesEntities pattern):
```vue
<template #filter-controls>
  <td v-for="field in fields" :key="field.key">
    <BFormInput
      v-if="field.filterable"
      v-model="filter[field.key].content"
      :placeholder="'Filter ' + field.label"
      debounce="300"
      type="search"
      size="sm"
      @update:model-value="filtered()"
    />
    <BFormSelect
      v-else-if="field.selectable && field.key === 'user_role'"
      v-model="filter[field.key].content"
      :options="roleFilterOptions"
      size="sm"
      @update:model-value="filtered()"
    >
      <template #first>
        <BFormSelectOption :value="null">All</BFormSelectOption>
      </template>
    </BFormSelect>
  </td>
</template>
```

4. **Add applyApiResponse method**:
```javascript
applyApiResponse(data) {
  this.users = data.data;
  this.totalRows = data.meta[0].totalItems;
  this.$nextTick(() => {
    this.currentPage = data.meta[0].currentPage;
  });
  this.totalPages = data.meta[0].totalPages;
  this.prevItemID = Number(data.meta[0].prevItemID) || 0;
  this.currentItemID = Number(data.meta[0].currentItemID) || 0;
  this.nextItemID = Number(data.meta[0].nextItemID) || 0;
  this.lastItemID = Number(data.meta[0].lastItemID) || 0;
  this.executionTime = data.meta[0].executionTime;

  // Update fields from API fspec if available
  if (data.meta[0].fspec) {
    // Keep actions column from local fields
    const actionsField = this.fields.find(f => f.key === 'actions');
    this.fields = [...data.meta[0].fspec, actionsField].filter(Boolean);
  }

  const uiStore = useUiStore();
  uiStore.requestScrollbarUpdate();
}
```

5. **Add loading spinner overlay** during data fetch:
```vue
<div class="position-relative">
  <BSpinner
    v-if="isBusy"
    class="position-absolute top-50 start-50 translate-middle"
    variant="primary"
  />
  <GenericTable
    :items="users"
    :fields="fields"
    :sort-by="sortBy"
    :class="{ 'opacity-50': isBusy }"
    @update:sort-by="handleSortUpdate"
  >
    <!-- slots -->
  </GenericTable>
</div>
```

6. **Add empty state** when no results:
```vue
<div v-if="!isBusy && users.length === 0" class="text-center py-4">
  <i class="bi bi-people fs-1 text-muted" />
  <p class="text-muted mt-2">No users found matching your filters</p>
  <BButton v-if="hasActiveFilters" variant="link" @click="removeFilters">
    Clear filters
  </BButton>
</div>
```

7. **Update handleSortUpdate to trigger filtered()**:
```javascript
handleSortUpdate(newSortBy) {
  this.sortBy = newSortBy;
  this.handleSortByOrDescChange();
}
```
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/sysndd/app
npm run build 2>&1 | grep -E "(error|Error)" || echo "Build successful"
npm run lint -- --fix
```

Manual verification:
1. Export button downloads Excel file with current filtered data
2. Loading spinner shows during API calls
3. Empty state shows when no results
4. Column sorting works and updates URL
  </verify>
  <done>ManageUser.vue is fully modernized with CSV export, loading states, empty states, and complete TablesEntities pattern</done>
</task>

</tasks>

<verification>
Build and lint:
```bash
cd /home/bernt-popp/development/sysndd/app
npm run build
npm run lint
```

Manual testing checklist:
- [ ] Search filters users by name, email, institution
- [ ] Role dropdown filters by role
- [ ] Status dropdown filters by approval status
- [ ] Pagination controls work (page size, navigation)
- [ ] URL updates reflect current filter/sort/pagination state
- [ ] Page refresh restores filter/sort/pagination from URL
- [ ] Export downloads Excel with current filtered data
- [ ] Loading spinner during data fetch
- [ ] Empty state when no results
- [ ] Active filter pills display and are removable
</verification>

<success_criteria>
- [ ] ManageUser.vue uses TablesEntities pattern (module-level caching, URL sync, debounced search)
- [ ] Search input with 300ms debounce filters across name, email, institution
- [ ] Role multi-select dropdown filter works
- [ ] Approval status dropdown filter works
- [ ] Active filters displayed as removable pills
- [ ] Pagination controls (10/25/50/100 page size, navigation)
- [ ] URL state sync (filter, sort, page_after, page_size in URL)
- [ ] Browser back/forward navigation works
- [ ] CSV export with current filters
- [ ] Loading spinner during API calls
- [ ] Empty state when no results
- [ ] Result count displayed ("Showing 1-20 of 156 users")
- [ ] Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/28-table-foundation/28-02-SUMMARY.md`
</output>
