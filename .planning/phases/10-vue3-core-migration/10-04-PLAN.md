---
phase: 10-vue3-core-migration
plan: 04
type: execute
wave: 2
depends_on: ["10-02"]
files_modified:
  - app/src/stores/ui.js
  - app/src/App.vue
  - app/src/components/analyses/PublicationsNDDTable.vue
  - app/src/components/analyses/PubtatorNDDGenes.vue
  - app/src/components/analyses/PubtatorNDDTable.vue
  - app/src/components/tables/TablesEntities.vue
  - app/src/components/tables/TablesGenes.vue
  - app/src/components/tables/TablesLogs.vue
  - app/src/components/tables/TablesPhenotypes.vue
  - app/src/views/admin/ManageOntology.vue
  - app/src/views/admin/ManageUser.vue
  - app/src/views/curate/ApproveReview.vue
  - app/src/views/curate/ApproveStatus.vue
  - app/src/views/curate/ApproveUser.vue
  - app/src/views/curate/ManageReReview.vue
  - app/src/views/tables/Panels.vue
  - app/src/assets/js/eventBus.js
autonomous: true

must_haves:
  truths:
    - "Scrollbar updates when data loads in tables"
    - "No EventBus import or usage in any component"
    - "App.vue reacts to scrollbar update requests"
  artifacts:
    - path: "app/src/stores/ui.js"
      provides: "Pinia store for UI state and scrollbar events"
      contains: "scrollbarUpdateTrigger"
    - path: "app/src/App.vue"
      provides: "Scrollbar listener using Pinia watcher"
      contains: "useUiStore"
  key_links:
    - from: "app/src/components/tables/TablesEntities.vue"
      to: "app/src/stores/ui.js"
      via: "Pinia action call"
      pattern: "requestScrollbarUpdate"
    - from: "app/src/App.vue"
      to: "app/src/stores/ui.js"
      via: "Pinia state watch"
      pattern: "scrollbarUpdateTrigger"
---

<objective>
Replace the custom EventBus pattern with a Pinia store for cross-component communication.

Purpose: Vue 3 removed the $on/$off/$once instance methods. The EventBus pattern (new Vue() as event emitter) no longer works in Vue 3 without @vue/compat. Per CONTEXT.md decision, we use Pinia stores (not mitt) for all event replacement.

Output: A Pinia UI store that handles scrollbar update requests, with all 14 emitting components updated to use the store action instead of EventBus.$emit.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/10-vue3-core-migration/10-CONTEXT.md
@.planning/phases/10-vue3-core-migration/10-RESEARCH.md
@.planning/phases/10-vue3-core-migration/10-02-SUMMARY.md
@app/src/App.vue
@app/src/assets/js/eventBus.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Pinia UI store for scrollbar events</name>
  <files>app/src/stores/ui.js</files>
  <action>
Create the stores directory and ui.js file:

```bash
mkdir -p app/src/stores
```

Create app/src/stores/ui.js with this content:
```javascript
// src/stores/ui.js
// Pinia store for UI state and cross-component communication
// Replaces EventBus for 'update-scrollbar' event

import { defineStore } from 'pinia';

export const useUiStore = defineStore('ui', {
  state: () => ({
    // Counter pattern: increment triggers watchers
    // This replaces EventBus.$emit('update-scrollbar')
    scrollbarUpdateTrigger: 0,
  }),

  actions: {
    /**
     * Request scrollbar update across the application
     * Call this from any component that loads data and needs scrollbar refresh
     * Replaces: EventBus.$emit('update-scrollbar')
     */
    requestScrollbarUpdate() {
      this.scrollbarUpdateTrigger++;
    },
  },
});
```

WHY counter pattern:
- Vue watchers trigger on value change
- Incrementing a number guarantees the watcher fires
- Simple, predictable, debuggable via Vue DevTools
  </action>
  <verify>
```bash
cat app/src/stores/ui.js
ls -la app/src/stores/
```
File should exist with defineStore and requestScrollbarUpdate
  </verify>
  <done>Pinia UI store created with scrollbarUpdateTrigger state and requestScrollbarUpdate action</done>
</task>

<task type="auto">
  <name>Task 2: Update App.vue to listen via Pinia</name>
  <files>app/src/App.vue</files>
  <action>
Update App.vue to use Pinia store instead of EventBus:

1. REMOVE EventBus import:
```javascript
// DELETE this line:
import EventBus from '@/assets/js/eventBus';
```

2. ADD Pinia imports:
```javascript
import { useUiStore } from '@/stores/ui';
import { mapState } from 'pinia';
```

3. ADD computed property to watch the store:
```javascript
computed: {
  ...mapState(useUiStore, ['scrollbarUpdateTrigger']),
},
```

4. ADD watcher for the trigger:
```javascript
watch: {
  $route() {
    this.$refs.scroll.$el.scrollTop = 0;
  },
  scrollbarUpdateTrigger: {
    handler() {
      this.updateScrollbar();
    },
    // No immediate: true - only react to changes after initial render
  },
},
```

5. REMOVE created() hook EventBus listener:
```javascript
// DELETE this:
created() {
  EventBus.$on('update-scrollbar', this.updateScrollbar);
},
```

6. CHANGE beforeDestroy to beforeUnmount (also fixing lifecycle hook):
```javascript
// DELETE this:
beforeDestroy() {
  EventBus.$off('update-scrollbar', this.updateScrollbar);
},
```
The Pinia watcher auto-cleans up, so no beforeUnmount needed for this purpose.
If no other cleanup needed, remove the lifecycle hook entirely.

KEEP the updateScrollbar method unchanged.
  </action>
  <verify>
```bash
grep -c "EventBus" app/src/App.vue || echo "No EventBus"
grep "useUiStore" app/src/App.vue
grep "scrollbarUpdateTrigger" app/src/App.vue
grep "beforeDestroy" app/src/App.vue || echo "No beforeDestroy"
```
Should show: No EventBus, useUiStore present, scrollbarUpdateTrigger present, no beforeDestroy
  </verify>
  <done>App.vue listens to scrollbar updates via Pinia watcher, EventBus removed, lifecycle hook fixed</done>
</task>

<task type="auto">
  <name>Task 3: Replace EventBus.$emit in all emitting components</name>
  <files>
    app/src/components/analyses/PublicationsNDDTable.vue
    app/src/components/analyses/PubtatorNDDGenes.vue
    app/src/components/analyses/PubtatorNDDTable.vue
    app/src/components/tables/TablesEntities.vue
    app/src/components/tables/TablesGenes.vue
    app/src/components/tables/TablesLogs.vue
    app/src/components/tables/TablesPhenotypes.vue
    app/src/views/admin/ManageOntology.vue
    app/src/views/admin/ManageUser.vue
    app/src/views/curate/ApproveReview.vue
    app/src/views/curate/ApproveStatus.vue
    app/src/views/curate/ApproveUser.vue
    app/src/views/curate/ManageReReview.vue
    app/src/views/tables/Panels.vue
  </files>
  <action>
For EACH of the 14 files that emit 'update-scrollbar':

1. REMOVE EventBus import:
```javascript
// DELETE:
import EventBus from '@/assets/js/eventBus';
```

2. ADD Pinia store import (at top of script):
```javascript
import { useUiStore } from '@/stores/ui';
```

3. REPLACE EventBus.$emit calls with Pinia action:

FIND pattern (typically in methods after data loads):
```javascript
EventBus.$emit('update-scrollbar');
```

REPLACE with:
```javascript
const uiStore = useUiStore();
uiStore.requestScrollbarUpdate();
```

NOTE: In Options API components, you can call useUiStore() inside the method.
The store instance is created on first call and cached automatically.

FILES AND LOCATIONS to update:
- TablesEntities.vue, TablesGenes.vue, TablesPhenotypes.vue, TablesLogs.vue:
  Look in methods that load/process data (loadTableData, etc.)
- Panels.vue: Look in data loading methods
- ManageUser.vue, ManageOntology.vue: Look in admin data loading
- ApproveReview.vue, ApproveStatus.vue, ApproveUser.vue, ManageReReview.vue:
  Look in curation workflow methods
- PublicationsNDDTable.vue, PubtatorNDDTable.vue, PubtatorNDDGenes.vue:
  Look in analysis data loading methods

IMPORTANT: Do NOT touch any $root.$emit patterns - those are for Bootstrap-Vue modals and stay until Phase 11.
  </action>
  <verify>
```bash
# Verify no EventBus imports remain
grep -r "import EventBus" app/src/ || echo "No EventBus imports"

# Verify no EventBus.$emit calls remain
grep -r "EventBus.\$emit" app/src/ || echo "No EventBus.$emit calls"

# Verify Pinia store is imported in key files
grep -l "useUiStore" app/src/components/tables/*.vue | wc -l
```
Should show: No EventBus imports, no EventBus.$emit, 4 table components with useUiStore
  </verify>
  <done>All 14 components updated to use Pinia store action instead of EventBus.$emit</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. No EventBus references:
```bash
grep -r "EventBus" app/src/ --include="*.vue" --include="*.js" | grep -v "eventBus.js" || echo "Clean"
```

2. Delete the eventBus.js file (no longer needed):
```bash
rm app/src/assets/js/eventBus.js
```

3. Functional test - verify scrollbar updates work:
- Start dev server: `npm run serve`
- Navigate to /Entities page
- Scroll down in the table
- The perfect-scrollbar should update when data loads
- No console errors related to EventBus or scrollbar

4. Build check:
```bash
cd /home/bernt-popp/development/sysndd/app && npm run build 2>&1 | tail -10
```
</verification>

<success_criteria>
- Pinia UI store exists at app/src/stores/ui.js
- App.vue watches scrollbarUpdateTrigger via Pinia
- All 14 components call uiStore.requestScrollbarUpdate()
- No EventBus imports or usage anywhere in codebase
- eventBus.js file deleted
- Scrollbar updates correctly when navigating to data tables
- Build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-vue3-core-migration/10-04-SUMMARY.md`
</output>
