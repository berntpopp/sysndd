---
phase: 60-llm-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/Dockerfile
  - api/endpoints/analysis_endpoints.R
  - app/src/components/llm/LlmSummaryCard.vue
  - app/src/components/analyses/AnalyseGeneClusters.vue
  - app/src/components/analyses/AnalysesPhenotypeClusters.vue
autonomous: true

must_haves:
  truths:
    - "Dockerfile R version matches renv.lock R version (4.4.3)"
    - "Functional cluster pages display cached LLM summaries above cluster content"
    - "Phenotype cluster pages display cached LLM summaries above cluster content"
    - "Summaries show AI-generated badge with sparkles icon"
    - "Summaries show confidence label (High/Medium/Low) with color coding"
    - "Summaries show model name and generation date"
    - "Missing summaries result in hidden section (no placeholder)"
  artifacts:
    - path: "api/Dockerfile"
      provides: "Docker image with correct R version for ellmer compatibility"
      contains: "rocker/r-ver:4.4.3"
    - path: "api/endpoints/analysis_endpoints.R"
      provides: "GET endpoints for summary retrieval"
      exports: ["functional_cluster_summary", "phenotype_cluster_summary"]
    - path: "app/src/components/llm/LlmSummaryCard.vue"
      provides: "Reusable AI summary display component"
      min_lines: 100
    - path: "app/src/components/analyses/AnalyseGeneClusters.vue"
      provides: "Functional cluster view with LLM summary integration"
      contains: "LlmSummaryCard"
    - path: "app/src/components/analyses/AnalysesPhenotypeClusters.vue"
      provides: "Phenotype cluster view with LLM summary integration"
      contains: "LlmSummaryCard"
  key_links:
    - from: "app/src/components/llm/LlmSummaryCard.vue"
      to: "summary prop"
      via: "Props interface"
      pattern: "defineProps.*summary"
    - from: "app/src/components/analyses/AnalyseGeneClusters.vue"
      to: "/api/analysis/functional_cluster_summary"
      via: "axios GET on cluster selection"
      pattern: "axios\\.get.*functional_cluster_summary"
    - from: "app/src/components/analyses/AnalysesPhenotypeClusters.vue"
      to: "/api/analysis/phenotype_cluster_summary"
      via: "axios GET on cluster selection"
      pattern: "axios\\.get.*phenotype_cluster_summary"
---

<objective>
Display cached LLM-generated cluster summaries on functional and phenotype cluster analysis pages with clear AI provenance indicators.

Purpose: Users need to see AI-generated summaries that provide context about gene clusters before diving into detailed data. Clear provenance (model, date, confidence) ensures transparency about AI-generated content.

Output: API endpoints for summary retrieval + reusable LlmSummaryCard.vue component + integration in both analysis views
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/60-llm-display/60-CONTEXT.md
@.planning/phases/60-llm-display/60-RESEARCH.md

# Source files to understand patterns
@api/endpoints/analysis_endpoints.R
@api/functions/llm-cache-repository.R
@app/src/components/analyses/AnalyseGeneClusters.vue
@app/src/components/analyses/AnalysesPhenotypeClusters.vue
</context>

<tasks>

<task type="auto">
  <name>Task 0: Fix R version mismatch in Dockerfile for ellmer compatibility</name>
  <files>api/Dockerfile</files>
  <action>
Fix the R version mismatch between Dockerfile and renv.lock that causes ellmer package compatibility issues.

**Problem:**
- Dockerfile uses `rocker/r-ver:4.5.2`
- renv.lock specifies `"R": { "Version": "4.4.3" }`
- Posit Package Manager (P3M) pre-compiled binaries are R-version specific
- Using R 4.5.2 with packages compiled for R 4.4.3 causes binary incompatibility
- ellmer and its dependencies (S7, coro, httr2) fail to load properly

**Solution:**
Update api/Dockerfile to use rocker/r-ver:4.4.3 to match the renv.lock:

1. Change base image from `rocker/r-ver:4.5.2` to `rocker/r-ver:4.4.3`
2. Update P3M URL to use Ubuntu jammy (22.04) binaries for R 4.4.x:
   - Change `noble` to `jammy` in RENV_CONFIG_REPOS_OVERRIDE
   - R 4.4.3 on rocker uses Ubuntu 22.04 (jammy), not 24.04 (noble)
3. Update LABEL version to reflect correct R version

**Changes:**
```dockerfile
# Line 21: Change base image
FROM rocker/r-ver:4.4.3 AS base

# Line 25: Update P3M URL for jammy (Ubuntu 22.04)
ENV RENV_CONFIG_REPOS_OVERRIDE="https://packagemanager.posit.co/cran/__linux__/jammy/latest"

# Line 180: Update metadata
LABEL maintainer="SysNDD Team" \
      version="3.0" \
      description="SysNDD R Plumber API (R 4.4.3, Multi-Stage Optimized)"
```

**Why this matters for ellmer:**
- ellmer 0.4.0 uses S7 0.2.1 for its object system
- S7 uses compiled code that must match R's internal ABI
- Pre-compiled P3M binaries for R 4.5.x won't work with R 4.4.x and vice versa
- This causes "cannot load shared object" or "object not found" errors at runtime

**References:**
- [Using renv with Docker](https://rstudio.github.io/renv/articles/docker.html)
- [Posit Package Manager](https://packagemanager.posit.co/)
- [rocker-versioned2 images](https://github.com/rocker-org/rocker-versioned2)
  </action>
  <verify>
Build the Docker image to verify no package loading errors:
```bash
cd api && DOCKER_BUILDKIT=1 docker build -t sysndd-api:test .
```
The build should complete without "cannot load shared object" or "namespace not found" errors.

Verify R version in built image:
```bash
docker run --rm sysndd-api:test R --version | head -1
# Should show: R version 4.4.3
```
  </verify>
  <done>
api/Dockerfile uses rocker/r-ver:4.4.3 base image, P3M URL points to jammy binaries, Docker build succeeds without package loading errors.
  </done>
</task>

<task type="auto">
  <name>Task 1: Add API endpoints to retrieve cached LLM summaries</name>
  <files>api/endpoints/analysis_endpoints.R</files>
  <action>
Add two new GET endpoints to analysis_endpoints.R for retrieving cached LLM summaries:

1. **GET /api/analysis/functional_cluster_summary**
   - Parameters: cluster_hash (string), cluster_number (int)
   - Source llm-cache-repository.R functions
   - Call get_cached_summary(cluster_hash, require_validated = FALSE)
   - Return 404 with message if no summary exists (client handles gracefully)
   - Parse summary_json if it's a string (MySQL JSON column behavior)
   - Return: cache_id, cluster_type, cluster_number, model_name, created_at, validation_status, summary_json

2. **GET /api/analysis/phenotype_cluster_summary**
   - Same structure as functional endpoint
   - Different cluster_type in response

Implementation pattern (from research):
```r
#* Get LLM Summary for Functional Cluster
#* @tag analysis
#* @serializer json list(na="string")
#* @param cluster_hash:str SHA256 hash of cluster composition
#* @param cluster_number:int Cluster number
#* @get functional_cluster_summary
function(cluster_hash, cluster_number, res) {
  source("functions/llm-cache-repository.R", local = TRUE)

  cached <- get_cached_summary(cluster_hash, require_validated = FALSE)

  if (is.null(cached) || nrow(cached) == 0) {
    res$status <- 404
    return(list(message = "Summary not found for this cluster"))
  }

  # Parse JSON if needed
  summary_json <- if (is.character(cached$summary_json[1])) {
    jsonlite::fromJSON(cached$summary_json[1])
  } else {
    cached$summary_json[[1]]
  }

  list(
    cache_id = cached$cache_id[1],
    cluster_type = cached$cluster_type[1],
    cluster_number = cached$cluster_number[1],
    model_name = cached$model_name[1],
    created_at = as.character(cached$created_at[1]),
    validation_status = cached$validation_status[1],
    summary_json = summary_json
  )
}
```

Important:
- Source llm-cache-repository.R at function level (not file level) since it may not be needed for other endpoints
- Convert created_at to string for JSON serialization
- Only return current summaries (is_current = TRUE is handled by get_cached_summary)
- Hide rejected summaries per CONTEXT.md (validation_status = 'rejected' should not be returned - add filter)
  </action>
  <verify>
Run `make lint-api` to check R code style.
Test endpoints manually after API restart:
- `curl http://localhost:8080/api/analysis/functional_cluster_summary?cluster_hash=test&cluster_number=1` should return 404 (no summary)
- If summaries exist in cache, endpoint should return JSON with summary_json structure
  </verify>
  <done>
Both GET endpoints exist in analysis_endpoints.R, return 404 when no summary found, return structured JSON with summary data when cached summary exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create reusable LlmSummaryCard.vue component</name>
  <files>app/src/components/llm/LlmSummaryCard.vue</files>
  <action>
Create new directory `app/src/components/llm/` and LlmSummaryCard.vue component.

Component requirements (from CONTEXT.md):
- Position: Above cluster content as overview
- Container: Card with distinct background (bg-variant="light")
- Content: Summary text + key themes as chips + pathways as chips
- AI badge: Sparkles icon (bi-stars) + model name + generation date
- Confidence: Color-coded badge (success/warning/danger for high/medium/low)
- Empty state: Component returns null if no summary (v-if at top level)

Props interface:
```typescript
interface SummaryJson {
  summary: string;
  key_themes?: string[];
  pathways?: string[];
  tags?: string[];
  clinical_relevance?: string;
  confidence?: string;
  derived_confidence?: {
    score: 'high' | 'medium' | 'low';
    avg_fdr: number;
    term_count: number;
  };
}

interface Props {
  summary: SummaryJson;
  modelName: string;
  createdAt: string;
  validationStatus?: string;
}
```

Component structure:
```vue
<template>
  <BCard v-if="summary" class="llm-summary-card mb-3" bg-variant="light">
    <template #header>
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
          <i class="bi bi-stars me-2 text-warning" />
          AI-Generated Summary
        </h6>
        <BBadge
          v-if="derivedConfidence"
          v-b-tooltip.hover.left="confidenceTooltip"
          :variant="confidenceVariant"
        >
          {{ confidenceLabel }}
        </BBadge>
      </div>
    </template>

    <!-- Summary text -->
    <p class="summary-text mb-3">{{ summary.summary }}</p>

    <!-- Key themes -->
    <div v-if="hasKeyThemes" class="mb-2">
      <strong class="me-2">Key themes:</strong>
      <BBadge
        v-for="theme in summary.key_themes"
        :key="theme"
        variant="secondary"
        class="me-1 mb-1"
      >
        {{ theme }}
      </BBadge>
    </div>

    <!-- Pathways -->
    <div v-if="hasPathways" class="mb-2">
      <strong class="me-2">Pathways:</strong>
      <BBadge
        v-for="pathway in summary.pathways"
        :key="pathway"
        variant="info"
        class="me-1 mb-1"
      >
        {{ pathway }}
      </BBadge>
    </div>

    <!-- Clinical relevance (if present) -->
    <p v-if="summary.clinical_relevance" class="text-muted small mb-0">
      <strong>Clinical relevance:</strong> {{ summary.clinical_relevance }}
    </p>

    <template #footer>
      <small class="text-muted">
        <i
          v-b-tooltip.hover.top="provenanceTooltip"
          class="bi bi-info-circle me-1"
        />
        Generated by {{ modelName }} on {{ formattedDate }}
      </small>
    </template>
  </BCard>
</template>
```

Computed properties:
- `derivedConfidence`: Use summary.derived_confidence (NOT summary.confidence which is LLM self-assessment)
- `confidenceLabel`: Capitalize score (High/Medium/Low)
- `confidenceVariant`: Map score to Bootstrap variant (success/warning/danger)
- `confidenceTooltip`: "HIGH confidence based on N significant terms (avg FDR: X.XXe-XX)"
- `formattedDate`: Use date-fns format(new Date(createdAt), 'MMM d, yyyy')
- `provenanceTooltip`: "AI-generated summary from {model}\nConfidence based on {term_count} enrichment terms"
- `hasKeyThemes`: summary.key_themes?.length > 0
- `hasPathways`: summary.pathways?.length > 0

Style notes:
- Use Bootstrap utilities, not custom CSS where possible
- Card should feel integrated with cluster content, not foreign
- Sparkles icon in warning color (text-warning class)
- Don't make genes/pathways clickable (per CONTEXT.md)
  </action>
  <verify>
Run `make lint-app` to verify no ESLint errors.
Run `npm run type-check --prefix app` to verify TypeScript compiles.
Component file exists at app/src/components/llm/LlmSummaryCard.vue with proper Vue 3 + TypeScript structure.
  </verify>
  <done>
LlmSummaryCard.vue exists with:
- Props for summary, modelName, createdAt
- Conditional rendering (v-if="summary" at root)
- AI badge with sparkles icon
- Confidence badge with color coding and tooltip
- Key themes and pathways as chips
- Provenance footer with date formatting
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate LlmSummaryCard into cluster analysis components</name>
  <files>
app/src/components/analyses/AnalyseGeneClusters.vue
app/src/components/analyses/AnalysesPhenotypeClusters.vue
  </files>
  <action>
Integrate LlmSummaryCard into both analysis components.

**AnalyseGeneClusters.vue changes:**

1. Import LlmSummaryCard:
```typescript
import LlmSummaryCard from '@/components/llm/LlmSummaryCard.vue';
```

2. Register in components object.

3. Add data properties:
```typescript
currentSummary: null as SummaryResponse | null,
summaryLoading: false,
```

4. Add method to fetch summary (call when cluster changes):
```typescript
async fetchClusterSummary(clusterHash: string, clusterNumber: number) {
  this.summaryLoading = true;
  try {
    const response = await this.axios.get(
      `${import.meta.env.VITE_API_URL}/api/analysis/functional_cluster_summary`,
      { params: { cluster_hash: clusterHash, cluster_number: clusterNumber } }
    );
    this.currentSummary = response.data;
  } catch (error) {
    if (error.response?.status === 404) {
      // No summary yet - silently handle
      this.currentSummary = null;
    } else {
      console.warn('Failed to fetch cluster summary:', error);
      this.currentSummary = null;
    }
  } finally {
    this.summaryLoading = false;
  }
}
```

5. Call fetchClusterSummary when cluster data loads (after setActiveCluster or when network cluster changes).
   - In handleClustersChanged: When single cluster selected, fetch summary using hash_filter
   - The hash_filter from cluster data IS the cluster_hash (same generation method)

6. Add template for summary card - place ABOVE the table card in the RIGHT PANE:
```vue
<!-- LLM Summary Card (above table) -->
<LlmSummaryCard
  v-if="currentSummary && !summaryLoading"
  :summary="currentSummary.summary_json"
  :model-name="currentSummary.model_name"
  :created-at="currentSummary.created_at"
  :validation-status="currentSummary.validation_status"
/>
<div v-else-if="summaryLoading" class="mb-3">
  <BSpinner small class="me-2" />
  <span class="text-muted">Loading summary...</span>
</div>
<!-- No placeholder when summary doesn't exist -->
```

7. Reset currentSummary when showing all clusters or multiple clusters (summary is per-cluster).

**AnalysesPhenotypeClusters.vue changes:**

Similar integration:

1. Import and register LlmSummaryCard.

2. Add data properties for currentSummary and summaryLoading.

3. Add fetchClusterSummary method (use phenotype_cluster_summary endpoint).

4. Call when activeCluster changes (in watcher or setActiveCluster).
   - Use selectedCluster.hash_filter as cluster_hash

5. Add template ABOVE the table BCard in the RIGHT COLUMN:
```vue
<!-- LLM Summary Card (above table) -->
<LlmSummaryCard
  v-if="currentSummary && !summaryLoading"
  :summary="currentSummary.summary_json"
  :model-name="currentSummary.model_name"
  :created-at="currentSummary.created_at"
  :validation-status="currentSummary.validation_status"
/>
```

Important notes:
- Don't block cluster display on summary fetch (cluster data loads first, summary fetches in parallel)
- Catch 404 silently - don't show toast or error message
- Only show summary for single cluster selection (hide when "All Clusters" selected in functional view)
- Use hash_filter field from cluster data as cluster_hash parameter
  </action>
  <verify>
Run `make lint-app` to verify no ESLint errors.
Run `npm run type-check --prefix app` to verify TypeScript compiles.
Start app with `npm run dev --prefix app` and verify:
- Navigate to Analysis > Gene Clusters - no console errors
- Navigate to Analysis > Phenotype Clusters - no console errors
- If summaries exist in cache, card appears above table
- If no summary, section is simply absent (no placeholder)
  </verify>
  <done>
Both analysis components:
- Import and use LlmSummaryCard component
- Fetch summary from appropriate API endpoint
- Display summary card above table when available
- Hide section when no summary (not show error)
- Loading spinner shown during fetch
  </done>
</task>

</tasks>

<verification>
Phase-level verification:

1. **Docker build succeeds:**
   - `cd api && DOCKER_BUILDKIT=1 docker build -t sysndd-api:test .` completes without errors
   - No "cannot load shared object" or "namespace not found" errors during package restore
   - `docker run --rm sysndd-api:test R --version` shows R version 4.4.3

2. **API endpoints work:**
   - `curl http://localhost:8080/api/analysis/functional_cluster_summary?cluster_hash=test&cluster_number=1` returns 404
   - With valid cache data, returns JSON with summary_json structure

3. **Component renders correctly:**
   - LlmSummaryCard shows AI badge with sparkles
   - Confidence badge has correct color (green/yellow/red)
   - Key themes and pathways render as chips
   - Date formatted as "Jan 31, 2026" style

4. **Integration works:**
   - Functional clusters page loads without errors
   - Phenotype clusters page loads without errors
   - Summary card appears above table when data exists
   - No visual issues or layout shifts

5. **Error handling:**
   - 404 responses handled silently (no toast)
   - Network errors logged to console only
   - Cluster view works even when summary fetch fails
</verification>

<success_criteria>
1. Dockerfile uses R 4.4.3 matching renv.lock; Docker build succeeds without package errors
2. Both API endpoints return cached summaries or 404
3. LlmSummaryCard.vue component renders summaries with AI provenance
4. AnalyseGeneClusters.vue shows summary card for single cluster selection
5. AnalysesPhenotypeClusters.vue shows summary card for active cluster
6. Missing summaries result in hidden section (no error, no placeholder)
7. Confidence badge shows High/Medium/Low with color coding
8. All linting and type checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/60-llm-display/60-01-SUMMARY.md`
</output>
