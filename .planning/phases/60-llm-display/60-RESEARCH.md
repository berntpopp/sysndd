# Phase 60: LLM Display - Research

**Researched:** 2026-02-01
**Domain:** Vue 3 + TypeScript frontend integration with LLM summary cache
**Confidence:** HIGH

## Summary

Researched how to display cached LLM-generated cluster summaries on functional and phenotype cluster analysis pages. The codebase uses Bootstrap-Vue-Next for UI components, has established patterns for card displays, badges, and tooltips. Summary data comes from `llm_cluster_summary_cache` table via existing cache repository layer.

**Key findings:**
- Both cluster analysis components already exist in `app/src/components/analyses/` with established card layouts
- LLM summaries stored in MySQL JSON column with structured schema (summary, key_themes, pathways, tags, clinical_relevance, confidence)
- No API endpoint exists yet to retrieve summaries - needs to be added to analysis_endpoints.R
- Bootstrap-Vue-Next (v0.42.0) provides BCard, BBadge, BTooltip components for rich display
- Derived confidence (high/medium/low) calculated from FDR values and term counts, separate from LLM self-assessment

**Primary recommendation:** Create reusable LlmSummaryCard.vue component that consumes summary data via props, add GET endpoints to retrieve summaries by cluster hash, integrate card above existing cluster content in both analysis pages.

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| Vue 3 | 3.x | Component framework | Project standard, all views use Vue 3 Composition API |
| Bootstrap-Vue-Next | ^0.42.0 | UI component library | Project-wide standard for cards, badges, tooltips |
| TypeScript | 5.x | Type safety | All new Vue components use TypeScript |
| Axios | 1.x | HTTP client | Standard for API calls throughout app |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| useToast | composable | User feedback | Display errors/success messages |
| date-fns | 2.x | Date formatting | Format generation timestamps |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Custom tooltip | Bootstrap tooltip | Native tooltip lacks rich content support, BTooltip more feature-rich |
| Inline styles | Tailwind CSS | Project doesn't use Tailwind, Bootstrap utilities preferred |

**Installation:**
No new dependencies needed - all required libraries already in package.json

## Architecture Patterns

### Recommended Component Structure
```
app/src/
├── components/
│   ├── llm/
│   │   └── LlmSummaryCard.vue      # Reusable summary display component
│   └── analyses/
│       ├── AnalyseGeneClusters.vue  # Integrate summary card
│       └── AnalysesPhenotypeClusters.vue  # Integrate summary card
└── composables/
    └── useLlmSummary.ts             # Fetch and manage summary state (optional)
```

### Pattern 1: Reusable Summary Card Component
**What:** Vue component that receives summary data via props and renders consistently across both cluster types
**When to use:** Display AI-generated summaries with provenance metadata
**Example:**
```vue
<!-- components/llm/LlmSummaryCard.vue -->
<template>
  <BCard v-if="summary" class="llm-summary-card mb-3" bg-variant="light">
    <template #header>
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
          <i class="bi bi-stars me-2" />
          AI-Generated Summary
        </h6>
        <BBadge
          v-b-tooltip.hover.left="confidenceTooltip"
          :variant="confidenceVariant"
        >
          {{ confidenceLabel }}
        </BBadge>
      </div>
    </template>

    <!-- Summary text -->
    <p class="summary-text">{{ summary.summary }}</p>

    <!-- Key themes -->
    <div v-if="summary.key_themes?.length" class="mb-2">
      <strong>Key themes:</strong>
      <div class="mt-1">
        <BBadge
          v-for="theme in summary.key_themes"
          :key="theme"
          variant="secondary"
          class="me-1 mb-1"
        >
          {{ theme }}
        </BBadge>
      </div>
    </div>

    <!-- Pathways -->
    <div v-if="summary.pathways?.length" class="mb-2">
      <strong>Pathways:</strong>
      <div class="mt-1">
        <BBadge
          v-for="pathway in summary.pathways"
          :key="pathway"
          variant="info"
          class="me-1 mb-1"
        >
          {{ pathway }}
        </BBadge>
      </div>
    </div>

    <!-- Provenance footer -->
    <template #footer>
      <small class="text-muted">
        <i
          v-b-tooltip.hover.top="metadataTooltip"
          class="bi bi-info-circle me-1"
        />
        Generated by {{ modelName }} on {{ formattedDate }}
      </small>
    </template>
  </BCard>
</template>

<script setup lang="ts">
import { computed } from 'vue';
// Source: SysNDD research phase 60, based on AnalyseGeneClusters.vue patterns
</script>
```

### Pattern 2: API Integration in Analysis Components
**What:** Fetch summary via GET endpoint after cluster data loads
**When to use:** Parent component needs to retrieve summary for current cluster
**Example:**
```typescript
// In AnalyseGeneClusters.vue
async loadClusterSummary(clusterHash: string, clusterNumber: number, clusterType: string) {
  try {
    const response = await this.axios.get(
      `${import.meta.env.VITE_API_URL}/api/analysis/${clusterType}_cluster_summary`,
      { params: { cluster_hash: clusterHash, cluster_number: clusterNumber } }
    );
    this.currentSummary = response.data;
  } catch (e) {
    // Silently fail - summary is optional enhancement
    this.currentSummary = null;
  }
}
// Source: Based on AnalyseGeneClusters.vue loadClusterData() pattern
```

### Pattern 3: Conditional Rendering
**What:** Only show summary card when data exists, hide on empty/error states
**When to use:** Summaries may not exist for all clusters (batch generation ongoing)
**Example:**
```vue
<!-- Only render card if summary exists -->
<LlmSummaryCard
  v-if="currentSummary"
  :summary="currentSummary.summary_json"
  :model-name="currentSummary.model_name"
  :created-at="currentSummary.created_at"
  :confidence="currentSummary.summary_json.derived_confidence"
  class="mb-3"
/>

<!-- No placeholder when summary doesn't exist - just skip section -->
<!-- Source: User decision from CONTEXT.md - "No summary: Hide summary section entirely" -->
```

### Anti-Patterns to Avoid
- **Don't trigger generation from UI:** Summaries come from batch pipeline only (Phase 59). Frontend is read-only.
- **Don't block cluster display on summary:** Summary fetch should be async and non-blocking. Cluster data displays independently.
- **Don't show raw JSON:** Always parse and display structured fields (summary, key_themes, pathways).
- **Don't make genes/pathways clickable:** User decision - display as styled chips but NOT interactive links.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Date formatting | Custom date formatter | date-fns or native Intl.DateTimeFormat | Locale support, timezone handling |
| Confidence badge colors | Manual color mapping | Bootstrap variant system | Consistent with app theme, accessible contrast ratios |
| Loading states | Custom spinners | BSpinner from Bootstrap-Vue-Next | Consistent loading indicators across app |
| Tooltip positioning | Custom tooltip logic | v-b-tooltip directive | Handles overflow, mobile, accessibility |

**Key insight:** Bootstrap-Vue-Next provides comprehensive component library. Leverage existing patterns from AnalyseGeneClusters.vue and AnalysesPhenotypeClusters.vue rather than creating new UI patterns.

## Common Pitfalls

### Pitfall 1: Assuming Summary Always Exists
**What goes wrong:** Component crashes with null reference when summary doesn't exist
**Why it happens:** Batch generation is asynchronous - clusters may not have summaries yet
**How to avoid:** Always use optional chaining (`summary?.summary`) and conditional rendering (`v-if="summary"`)
**Warning signs:** Console errors "Cannot read property of null", blank cards appearing

### Pitfall 2: Displaying LLM Confidence Instead of Derived Confidence
**What goes wrong:** Shows unreliable LLM self-assessment instead of objective metrics
**Why it happens:** Summary JSON contains both `confidence` (LLM self-assessment) and `derived_confidence` (FDR-based)
**How to avoid:** Always use `summary.derived_confidence.score` for display, not `summary.confidence`
**Warning signs:** Confidence levels don't match enrichment data quality

### Pitfall 3: Not Parsing JSON from API
**What goes wrong:** Display shows raw JSON string instead of structured data
**Why it happens:** MySQL JSON column may return as string depending on driver
**How to avoid:** Always parse `summary_json` field: `JSON.parse(cached.summary_json)` in API or check type in Vue
**Warning signs:** Display shows `[object Object]` or JSON string in UI

### Pitfall 4: Blocking Cluster Display on Summary Fetch
**What goes wrong:** Entire cluster view waits for optional summary, degrading UX
**Why it happens:** Sequential loading instead of parallel fetch
**How to avoid:** Load cluster data and summary in parallel, render cluster immediately
**Warning signs:** Cluster table appears slowly even when data is ready

### Pitfall 5: Showing Errors When Summary Missing
**What goes wrong:** Error toast appears when cluster has no summary yet
**Why it happens:** API 404 treated as error instead of expected state
**How to avoid:** Catch 404 silently, treat as "no summary available", don't show user-facing error
**Warning signs:** Users see error messages on newly generated clusters

## Code Examples

Verified patterns from codebase analysis:

### Retrieving Summary from API (Backend - R/Plumber)
```r
# api/endpoints/analysis_endpoints.R (NEW ENDPOINT)
#* Get LLM Summary for Functional Cluster
#* @tag analysis
#* @serializer json list(na="string")
#* @param cluster_hash:str SHA256 hash of cluster composition
#* @param cluster_number:int Cluster number
#* @get functional_cluster_summary
function(cluster_hash, cluster_number) {
  # Source llm-cache-repository.R functions
  source("functions/llm-cache-repository.R", local = TRUE)

  # Query cache - don't require validated (show pending summaries)
  cached <- get_cached_summary(cluster_hash, require_validated = FALSE)

  if (is.null(cached) || nrow(cached) == 0) {
    # No summary exists - return 404 (client will handle gracefully)
    res$status <- 404
    return(list(message = "Summary not found for this cluster"))
  }

  # Parse JSON if needed
  summary_json <- if (is.character(cached$summary_json[1])) {
    jsonlite::fromJSON(cached$summary_json[1])
  } else {
    cached$summary_json[[1]]
  }

  # Return summary with metadata
  list(
    cache_id = cached$cache_id[1],
    cluster_type = cached$cluster_type[1],
    cluster_number = cached$cluster_number[1],
    model_name = cached$model_name[1],
    created_at = cached$created_at[1],
    validation_status = cached$validation_status[1],
    summary_json = summary_json
  )
}
# Source: llm-cache-repository.R get_cached_summary() pattern
```

### Fetching Summary in Vue Component
```typescript
// app/src/components/analyses/AnalyseGeneClusters.vue (INTEGRATION)
import { ref } from 'vue';

const currentSummary = ref<SummaryData | null>(null);
const summaryLoading = ref(false);

async function fetchClusterSummary(clusterHash: string, clusterNumber: number) {
  summaryLoading.value = true;
  try {
    const response = await axios.get(
      `${import.meta.env.VITE_API_URL}/api/analysis/functional_cluster_summary`,
      { params: { cluster_hash: clusterHash, cluster_number: clusterNumber } }
    );
    currentSummary.value = response.data;
  } catch (error) {
    if (error.response?.status === 404) {
      // No summary yet - silently handle (don't show error)
      currentSummary.value = null;
    } else {
      // Actual error - log but don't block UI
      console.warn('Failed to fetch cluster summary:', error);
      currentSummary.value = null;
    }
  } finally {
    summaryLoading.value = false;
  }
}
// Source: Based on AnalyseGeneClusters.vue loadClusterDataSync() error handling pattern
```

### Confidence Badge with Tooltip
```vue
<template>
  <BBadge
    v-b-tooltip.hover.left="confidenceTooltipText"
    :variant="confidenceVariant"
    class="confidence-badge"
  >
    {{ confidenceLabel }}
  </BBadge>
</template>

<script setup lang="ts">
import { computed } from 'vue';

interface Props {
  derivedConfidence: {
    score: 'high' | 'medium' | 'low';
    avg_fdr: number;
    term_count: number;
  };
}

const props = defineProps<Props>();

const confidenceLabel = computed(() => {
  return props.derivedConfidence.score.charAt(0).toUpperCase() +
         props.derivedConfidence.score.slice(1);
});

const confidenceVariant = computed(() => {
  const variants = {
    high: 'success',
    medium: 'warning',
    low: 'danger'
  };
  return variants[props.derivedConfidence.score];
});

const confidenceTooltipText = computed(() => {
  const { avg_fdr, term_count, score } = props.derivedConfidence;
  return `${score.toUpperCase()} confidence based on ${term_count} significant terms (avg FDR: ${avg_fdr?.toExponential(2) || 'N/A'})`;
});
// Source: User decision from CONTEXT.md - "Confidence tooltip should mention objective factors"
</script>
```

### AI Provenance Badge
```vue
<template>
  <div class="ai-provenance">
    <i
      v-b-tooltip.hover.top="provenanceTooltip"
      class="bi bi-stars ai-icon"
    />
    <span class="model-info">{{ modelName }} · {{ formattedDate }}</span>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import { format } from 'date-fns';

interface Props {
  modelName: string;
  createdAt: string;
  promptVersion?: string;
  derivedConfidence?: {
    avg_fdr: number;
    term_count: number;
  };
}

const props = defineProps<Props>();

const formattedDate = computed(() => {
  return format(new Date(props.createdAt), 'MMM d, yyyy');
});

const provenanceTooltip = computed(() => {
  let tooltip = `AI-generated summary from ${props.modelName}`;
  if (props.promptVersion) {
    tooltip += ` (prompt v${props.promptVersion})`;
  }
  if (props.derivedConfidence) {
    tooltip += `\nConfidence based on ${props.derivedConfidence.term_count} enrichment terms`;
  }
  return tooltip;
});
// Source: User decision from CONTEXT.md - "Tooltip shows prompt version, detailed confidence"
</script>

<style scoped>
.ai-provenance {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.875rem;
  color: #6c757d;
}

.ai-icon {
  color: #ffc107; /* Sparkles icon in warning color */
}
</style>
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Static cluster descriptions | AI-generated summaries | Phase 59 (2026-01) | Dynamic, context-aware summaries |
| Manual curation | LLM-as-judge validation | Phase 59 (2026-01) | Automated quality checks |
| Client-side generation | Server-side batch caching | Phase 59 (2026-01) | Better performance, no API key exposure |
| Numeric confidence scores | Descriptive labels (High/Medium/Low) | User decision | More user-friendly, less intimidating |

**Deprecated/outdated:**
- **On-demand LLM generation:** All summaries now pre-generated via batch pipeline (Phase 59). Frontend never calls LLM directly.
- **Percentage-based confidence:** Use descriptive labels, not "87% confident" style displays.

## Open Questions

Things that couldn't be fully resolved:

1. **How to generate cluster_hash on frontend for functional clusters?**
   - What we know: Backend uses `generate_cluster_hash(identifiers, cluster_type)` with sorted hgnc_ids
   - What's unclear: Does frontend have access to hgnc_ids in cluster data, or only hash_filter field?
   - Recommendation: Check if `hash_filter` field in cluster data matches cluster_hash from backend, or if new hash generation needed

2. **Should validation_status affect display styling?**
   - What we know: Summaries can be pending/validated/rejected
   - What's unclear: Whether rejected summaries should be shown with warning styling or hidden entirely
   - Recommendation: Show pending and validated summaries, hide rejected summaries per user decision (error states = hide section)

3. **Loading state during initial batch generation?**
   - What we know: User wants skeleton/spinner for "in progress" state
   - What's unclear: How to detect if batch job is running vs. cluster simply has no summary
   - Recommendation: Check job status endpoint for active llm_generation job, show skeleton if running

## Sources

### Primary (HIGH confidence)
- `api/functions/llm-cache-repository.R` - Cache schema, retrieval functions
- `api/functions/llm-service.R` - Summary JSON structure, confidence calculation
- `db/migrations/006_add_llm_summary_cache.sql` - Table schema, validation_status enum
- `app/src/components/analyses/AnalyseGeneClusters.vue` - Component structure, card patterns
- `app/src/components/analyses/AnalysesPhenotypeClusters.vue` - Component structure, Bootstrap usage
- `app/package.json` - Bootstrap-Vue-Next version (0.42.0)

### Secondary (MEDIUM confidence)
- `.planning/phases/60-llm-display/60-CONTEXT.md` - User decisions on display format

### Tertiary (LOW confidence)
- None - all findings verified from codebase

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Directly read from package.json and component imports
- Architecture: HIGH - Analyzed existing Vue components with similar patterns
- Pitfalls: HIGH - Based on common Vue + API integration errors, validated against codebase patterns

**Research date:** 2026-02-01
**Valid until:** 2026-03-01 (30 days - stable patterns, no fast-moving dependencies)
