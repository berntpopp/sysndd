---
phase: 40-backend-external-api-layer
plan: 03
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - api/functions/external-proxy-alphafold.R
  - api/functions/external-proxy-mgi.R
  - api/functions/external-proxy-rgd.R
  - api/start_sysndd_api.R
autonomous: true

must_haves:
  truths:
    - "AlphaFold proxy returns 3D structure metadata and file URLs for a gene symbol"
    - "MGI proxy returns mouse phenotype data for a gene symbol"
    - "RGD proxy returns rat phenotype data for a gene symbol"
    - "All three proxy functions use memoised caching with appropriate TTL"
  artifacts:
    - path: "api/functions/external-proxy-alphafold.R"
      provides: "fetch_alphafold_structure() + memoised version"
      min_lines: 40
    - path: "api/functions/external-proxy-mgi.R"
      provides: "fetch_mgi_phenotypes() + memoised version"
      min_lines: 40
    - path: "api/functions/external-proxy-rgd.R"
      provides: "fetch_rgd_phenotypes() + memoised version"
      min_lines: 40
  key_links:
    - from: "api/functions/external-proxy-alphafold.R"
      to: "external-proxy-functions.R"
      via: "uses make_external_request and cache_static"
      pattern: "make_external_request|cache_static"
    - from: "api/functions/external-proxy-mgi.R"
      to: "external-proxy-functions.R"
      via: "uses make_external_request and cache_stable"
      pattern: "make_external_request|cache_stable"
    - from: "api/functions/external-proxy-rgd.R"
      to: "external-proxy-functions.R"
      via: "uses make_external_request and cache_stable"
      pattern: "make_external_request|cache_stable"
---

<objective>
Implement proxy functions for AlphaFold, MGI (mouse), and RGD (rat) APIs with per-source caching and memoisation.

Purpose: These three sources provide structure metadata and model organism phenotype data -- required by Phases 45-46. They can be built in parallel with Plan 02 since they only depend on Plan 01's shared infrastructure.

Output: Three per-source function files + memoised wrappers registered in API startup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/40-backend-external-api-layer/40-CONTEXT.md
@.planning/phases/40-backend-external-api-layer/40-RESEARCH.md
@.planning/phases/40-backend-external-api-layer/40-01-SUMMARY.md

Key existing files:
@api/functions/external-proxy-functions.R (shared infrastructure from Plan 01)
@api/functions/omim-functions.R (httr2 pattern reference)
@api/start_sysndd_api.R (where to register new source files)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AlphaFold and MGI proxy functions</name>
  <files>api/functions/external-proxy-alphafold.R, api/functions/external-proxy-mgi.R</files>
  <action>
**File 1: `api/functions/external-proxy-alphafold.R`**

Create with:

1. **`fetch_alphafold_structure(gene_symbol)`**:
   - Validates gene_symbol with `validate_gene_symbol()`.
   - Step 1: Look up UniProt accession for the gene symbol. Use UniProt REST search:
     `https://rest.uniprot.org/uniprotkb/search?query=gene_exact:{gene_symbol}+AND+organism_id:9606+AND+reviewed:true&fields=accession&format=json&size=1`
   - Use `make_external_request()` with api_name = "alphafold" (for error reporting) but throttle = `EXTERNAL_API_THROTTLE$uniprot` (since querying UniProt).
   - If no results, return `list(found = FALSE, source = "alphafold")`.
   - Step 2: Fetch AlphaFold prediction metadata using the UniProt accession:
     `https://alphafold.ebi.ac.uk/api/prediction/{accession}`
   - Use `make_external_request()` with api_name = "alphafold" and throttle = `EXTERNAL_API_THROTTLE$alphafold`.
   - The response is an array; take the first element.
   - Extract: entryId, uniprotAccession, uniprotId, uniprotDescription, modelCreatedDate, latestVersion, pdbUrl, cifUrl, bcifUrl, paeImageUrl, modelUrl (mmCIF URL for Mol* viewer).
   - If 404 (no AlphaFold structure), return `list(found = FALSE, source = "alphafold")`.
   - Return: `list(source = "alphafold", gene_symbol = gene_symbol, uniprot_accession = accession, entry_id = entryId, pdb_url = pdbUrl, cif_url = cifUrl, bcif_url = bcifUrl, pae_image_url = paeImageUrl, model_url = modelUrl, model_created_date = modelCreatedDate, latest_version = latestVersion)`.
   - Wrap in tryCatch.

2. **Memoised wrapper**:
   - `fetch_alphafold_structure_mem <- memoise::memoise(fetch_alphafold_structure, cache = cache_static)` (30-day TTL)

**File 2: `api/functions/external-proxy-mgi.R`**

Create with:

1. **`fetch_mgi_phenotypes(gene_symbol)`**:
   - Validates gene_symbol with `validate_gene_symbol()`.
   - Use MGI mouse gene detail API:
     `https://www.informatics.jax.org/api/gxd/gene/summary?markerSymbol={gene_symbol}`
   - NOTE: This endpoint may not exist at this exact URL. Use a more reliable approach:
     First try the MGI search API: `http://www.informatics.jax.org/api/marker/search?nomen={gene_symbol}&organism=mouse`
   - Use `make_external_request()` with api_name = "mgi" and throttle = `EXTERNAL_API_THROTTLE$mgi`.
   - If result is empty or gene not found, return `list(found = FALSE, source = "mgi")`.
   - If the MGI search API is unavailable or returns unexpected format, try fallback:
     `http://www.informatics.jax.org/diseasePortal/phenoByGene/{gene_symbol}` (returns JSON phenotype data).
   - Extract from response: marker_id (MGI ID), symbol, name, phenotype_count if available.
   - If detailed phenotype data available, extract: phenotype annotations grouped by mammalian phenotype (MP) terms with zygosity.
   - Return: `list(source = "mgi", gene_symbol = gene_symbol, mgi_id = marker_id, mouse_symbol = symbol, phenotype_count = count, phenotypes = phenotype_list, mgi_url = paste0("https://www.informatics.jax.org/marker/", marker_id))`.
   - NOTE: MGI API endpoints are not well documented (flagged in 40-RESEARCH.md as LOW confidence). The implementation should be defensive -- if any API call returns unexpected format, return `list(found = FALSE, source = "mgi", message = "MGI API returned unexpected format")`. Do NOT crash.
   - Wrap entire function in tryCatch.

2. **Memoised wrapper**:
   - `fetch_mgi_phenotypes_mem <- memoise::memoise(fetch_mgi_phenotypes, cache = cache_stable)` (14-day TTL)

Add roxygen2 docs for all functions. Follow Google R Style Guide.
  </action>
  <verify>
`Rscript -e "source('api/functions/external-proxy-functions.R'); source('api/functions/external-proxy-alphafold.R'); source('api/functions/external-proxy-mgi.R')"` parses without error. Lintr passes.
  </verify>
  <done>
AlphaFold proxy returns structure metadata with PDB/CIF URLs via UniProt accession lookup. MGI proxy returns mouse phenotype data with defensive error handling for undocumented API.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RGD proxy functions and register all three sources</name>
  <files>api/functions/external-proxy-rgd.R, api/start_sysndd_api.R</files>
  <action>
**File: `api/functions/external-proxy-rgd.R`**

Create with:

1. **`fetch_rgd_phenotypes(gene_symbol)`**:
   - Validates gene_symbol with `validate_gene_symbol()`.
   - Step 1: Look up RGD gene by human ortholog symbol. Use RGD REST API:
     `https://rest.rgd.mcw.edu/rgdws/genes/species/Human/{gene_symbol}`
     This returns the human gene entry. Then from that, find the rat ortholog via:
     `https://rest.rgd.mcw.edu/rgdws/orthologs/gene/{rgd_id}/Rat`
   - Alternatively, try direct search for the gene symbol in rat:
     `https://rest.rgd.mcw.edu/rgdws/genes/species/Rat/{gene_symbol}`
   - Use `make_external_request()` with api_name = "rgd" and throttle = `EXTERNAL_API_THROTTLE$rgd`.
   - If not found, return `list(found = FALSE, source = "rgd")`.
   - Step 2: If we find the rat RGD ID, fetch phenotype annotations:
     `https://rest.rgd.mcw.edu/rgdws/annotations/rgdId/{rat_rgd_id}/phenotype`
   - Extract: rgd_id, symbol, name, annotation_count, phenotype terms.
   - Return: `list(source = "rgd", gene_symbol = gene_symbol, rgd_id = rat_rgd_id, rat_symbol = rat_symbol, phenotype_count = length(annotations), phenotypes = annotation_list, rgd_url = paste0("https://rgd.mcw.edu/rgdweb/report/gene/main.html?id=", rat_rgd_id))`.
   - NOTE: Like MGI, RGD API endpoints are not well documented (LOW confidence in research). Implement defensively -- return `list(found = FALSE, source = "rgd", message = "RGD API returned unexpected format")` rather than crashing.
   - Wrap entire function in tryCatch.

2. **Memoised wrapper**:
   - `fetch_rgd_phenotypes_mem <- memoise::memoise(fetch_rgd_phenotypes, cache = cache_stable)` (14-day TTL)

**Register in start_sysndd_api.R:**

Add three source lines in section 4, after the lines added in Plan 02 (external-proxy-gnomad.R, external-proxy-uniprot.R, external-proxy-ensembl.R):
```r
source("functions/external-proxy-alphafold.R", local = TRUE)
source("functions/external-proxy-mgi.R", local = TRUE)
source("functions/external-proxy-rgd.R", local = TRUE)
```

Add roxygen2 docs. Follow Google R Style Guide.
  </action>
  <verify>
`Rscript -e "source('api/functions/external-proxy-functions.R'); source('api/functions/external-proxy-rgd.R')"` parses without error. `grep "external-proxy-alphafold\|external-proxy-mgi\|external-proxy-rgd" api/start_sysndd_api.R` shows three source lines. Lintr passes.
  </verify>
  <done>
RGD proxy returns rat phenotype data with human-to-rat ortholog lookup. All three sources (AlphaFold, MGI, RGD) registered in API startup with memoised wrappers using appropriate TTL.
  </done>
</task>

</tasks>

<verification>
1. All three proxy files parse without R syntax errors
2. Memoised wrappers use correct cache backends (static for AlphaFold, stable for MGI/RGD)
3. All functions validate gene_symbol input
4. Defensive error handling for undocumented APIs (MGI, RGD) -- never crashes
5. start_sysndd_api.R sources all three new files
6. Lintr passes for all new files
</verification>

<success_criteria>
- AlphaFold proxy: 1 function (structure metadata) with UniProt accession lookup step
- MGI proxy: 1 function (mouse phenotypes) with defensive handling for undocumented API
- RGD proxy: 1 function (rat phenotypes) with human ortholog lookup
- All functions have memoised wrappers with per-source TTL (30d static, 14d stable)
- All functions use shared infrastructure from Plan 01
- All files registered in API startup
</success_criteria>

<output>
After completion, create `.planning/phases/40-backend-external-api-layer/40-03-SUMMARY.md`
</output>
