---
phase: 40-backend-external-api-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/functions/external-proxy-functions.R
  - api/start_sysndd_api.R
  - api/.gitignore
autonomous: true

must_haves:
  truths:
    - "Shared proxy infrastructure exists with per-source cache backends, retry logic, and rate limiting"
    - "Disk-based cache persists across R/Plumber restarts with per-source TTL"
    - "RFC 9457 error format includes source identification field for external API failures"
  artifacts:
    - path: "api/functions/external-proxy-functions.R"
      provides: "Shared proxy helpers: make_external_request, create_external_error, cache backends, throttle configs"
      min_lines: 80
    - path: "api/start_sysndd_api.R"
      provides: "Sources external-proxy-functions.R and loads ghql library"
  key_links:
    - from: "api/functions/external-proxy-functions.R"
      to: "httr2"
      via: "req_retry + req_throttle + req_timeout"
      pattern: "req_retry|req_throttle"
    - from: "api/functions/external-proxy-functions.R"
      to: "cachem"
      via: "cache_disk with per-source TTL directories"
      pattern: "cache_disk"
---

<objective>
Build the shared proxy infrastructure layer: cache backends with per-source TTL, a reusable HTTP request helper with retry/throttle/timeout, RFC 9457 error formatting with source identification, and rate-limit configuration constants for all 6 external APIs.

Purpose: All subsequent proxy function plans depend on this shared infrastructure. Without it, each source would duplicate retry logic, cache setup, and error handling.

Output: `api/functions/external-proxy-functions.R` with shared helpers, updated `api/start_sysndd_api.R` to source it and load ghql.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-backend-external-api-layer/40-CONTEXT.md
@.planning/phases/40-backend-external-api-layer/40-RESEARCH.md

Key existing files to reference:
@api/functions/omim-functions.R (httr2 retry pattern - lines 55-62, 163-207)
@api/core/errors.R (RFC 9457 error helpers using httpproblems)
@api/start_sysndd_api.R (cache setup lines 218-232, source lines 108-134)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared proxy infrastructure functions</name>
  <files>api/functions/external-proxy-functions.R</files>
  <action>
Create `api/functions/external-proxy-functions.R` with the following components:

1. **Per-source cache backends** using cachem::cache_disk:
   - `cache_static` at `/app/cache/external/static` with max_age = 30 days (30 * 24 * 3600 seconds) for constraint scores, AlphaFold URLs
   - `cache_stable` at `/app/cache/external/stable` with max_age = 14 days (14 * 24 * 3600) for protein domains, gene structure, phenotypes
   - `cache_dynamic` at `/app/cache/external/dynamic` with max_age = 7 days (7 * 24 * 3600) for ClinVar variants
   - Each with max_size = 200 * 1024^2 (200 MB)
   - Use `dir.create(dir, recursive = TRUE, showWarnings = FALSE)` to ensure directories exist before creating cache

2. **Rate limit configuration** as a named list `EXTERNAL_API_THROTTLE`:
   - `gnomad`: list(capacity = 10, fill_time_s = 60) -- 10 req/min (conservative, undocumented)
   - `ensembl`: list(capacity = 900, fill_time_s = 60) -- 15 req/sec
   - `uniprot`: list(capacity = 100, fill_time_s = 1) -- 100 req/sec (conservative)
   - `alphafold`: list(capacity = 20, fill_time_s = 60) -- 20 req/min (conservative)
   - `mgi`: list(capacity = 30, fill_time_s = 60) -- 30 req/min (conservative)
   - `rgd`: list(capacity = 30, fill_time_s = 60) -- 30 req/min (conservative)

3. **`make_external_request(url, api_name, throttle_config, ...)`** function:
   - Accepts url (character), api_name (character), throttle_config (list with capacity, fill_time_s)
   - Optional `method` parameter (default "GET"), `body` parameter for POST requests
   - Builds httr2 request: `request(url) %>% req_throttle(capacity, fill_time_s) %>% req_retry(max_tries = 5, max_seconds = 120, backoff = ~2^.x, is_transient = ~resp_status(.x) %in% c(429, 503, 504)) %>% req_timeout(30) %>% req_error(is_error = ~FALSE)`
   - If method is POST, add `req_method("POST")` and `req_body_json(body)`
   - Performs the request with `req_perform()`
   - On 404: returns `list(found = FALSE, source = api_name)`
   - On non-200: returns `list(error = TRUE, status = resp_status(response), source = api_name, message = paste(api_name, "returned HTTP", resp_status(response)))`
   - On success (200): returns `resp_body_json(response)`
   - Wraps entire body in tryCatch; on error returns `list(error = TRUE, source = api_name, message = conditionMessage(e))`
   - Follow the pattern from `fetch_jax_disease_name()` in omim-functions.R (lines 163-207)

4. **`create_external_error(api_name, detail, status = 503L, instance = NULL)`** function:
   - Returns RFC 9457 formatted error list with source identification:
     ```
     list(
       type = "https://sysndd.org/problems/external-api-failure",
       title = paste("Failed to fetch", api_name, "data"),
       status = status,
       detail = detail,
       source = api_name,
       instance = instance
     )
     ```
   - This is used by endpoints to return structured errors.

5. **`validate_gene_symbol(symbol)`** function:
   - Checks symbol is not NULL, not empty string, matches pattern `^[A-Z][A-Z0-9-]+$` (HGNC symbols are uppercase alphanumeric with possible hyphens)
   - Returns TRUE/FALSE. This prevents GraphQL injection and validates input before external API calls.

Add proper roxygen2 documentation for each function with `@param`, `@return`, `@export` tags. Use Google R Style Guide (2-space indent, snake_case). Add file header comment matching project convention.
  </action>
  <verify>
Run `Rscript -e "source('api/functions/external-proxy-functions.R')"` to verify the file parses without syntax errors. Run `cd /home/bernt-popp/development/sysndd/api && Rscript scripts/lint-check.R` to verify no lintr issues.
  </verify>
  <done>
external-proxy-functions.R exists with 5 exports: 3 cache backends (cache_static, cache_stable, cache_dynamic), EXTERNAL_API_THROTTLE config, make_external_request(), create_external_error(), validate_gene_symbol(). File parses without errors and passes lintr.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register infrastructure in API startup and add ghql dependency</name>
  <files>api/start_sysndd_api.R, api/.gitignore</files>
  <action>
1. **Update `api/start_sysndd_api.R`:**
   - In section 1 (Load Required Libraries), add `library(httr2)` if not already present (httr2 IS in renv.lock but not explicitly loaded -- currently `library(httr)` is on line 62, add `library(httr2)` nearby). Also add `library(ghql)` -- note: ghql is NOT in renv.lock, so it will need to be installed. Add it after httr2.
   - In section 4 (Load Additional Scripts), add `source("functions/external-proxy-functions.R", local = TRUE)` AFTER the existing `source("functions/external-functions.R", local = TRUE)` on line 126.

2. **Install ghql to renv:**
   - Run `cd /home/bernt-popp/development/sysndd/api && Rscript -e 'renv::install("ghql")' && Rscript -e 'renv::snapshot()'` to add ghql to the project's renv.lock.

3. **Update `api/.gitignore`** (if it exists) or create it:
   - Ensure `cache/` directory is gitignored (the Docker volume mounts to /app/cache, but for local development the api/cache/ directory should be ignored).
   - Add line `cache/` if not already present.

Important: Do NOT modify the existing cache setup on lines 218-232 of start_sysndd_api.R (that's for existing memoized functions with Inf TTL). The new external proxy caches are separate and self-contained in external-proxy-functions.R.
  </action>
  <verify>
Verify `grep "external-proxy-functions" api/start_sysndd_api.R` shows the source line. Verify `grep "ghql" api/start_sysndd_api.R` shows the library line. Verify `grep "httr2" api/start_sysndd_api.R` shows the library line. Check `grep "ghql" api/renv.lock` confirms the package is in the lockfile. Check `grep "cache" api/.gitignore` confirms cache is gitignored.
  </verify>
  <done>
start_sysndd_api.R loads httr2 and ghql libraries, sources external-proxy-functions.R. ghql is added to renv.lock. api/.gitignore excludes cache/ directory.
  </done>
</task>

</tasks>

<verification>
1. `Rscript -e "source('api/functions/external-proxy-functions.R')"` completes without error
2. `grep -c "make_external_request\|create_external_error\|validate_gene_symbol\|cache_static\|cache_stable\|cache_dynamic\|EXTERNAL_API_THROTTLE" api/functions/external-proxy-functions.R` returns 7+ matches
3. `grep "external-proxy-functions" api/start_sysndd_api.R` returns the source line
4. `grep "ghql" api/renv.lock` confirms package added
5. Lintr check passes: `cd api && Rscript scripts/lint-check.R`
</verification>

<success_criteria>
- Shared proxy infrastructure file exists with cache backends, throttle config, request helper, error formatter, and input validator
- API startup file sources the new functions file and loads required libraries
- ghql package added to renv.lock for gnomAD GraphQL support
- Cache directory gitignored for local development
- All code passes lintr
</success_criteria>

<output>
After completion, create `.planning/phases/40-backend-external-api-layer/40-01-SUMMARY.md`
</output>
