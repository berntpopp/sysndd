---
phase: 22-service-layer-middleware
plan: 03
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - api/services/entity-service.R
  - api/start_sysndd_api.R
autonomous: true

must_haves:
  truths:
    - "entity_create validates inputs and creates new entity in database"
    - "entity_deactivate marks entity as inactive with replacement"
    - "entity_get_full retrieves entity with related reviews and phenotypes"
    - "All entity business logic is in service, not in endpoints"
  artifacts:
    - path: "api/services/entity-service.R"
      provides: "Entity business logic and validation"
      exports: ["entity_create", "entity_deactivate", "entity_get_full", "entity_validate"]
      min_lines: 150
  key_links:
    - from: "api/services/entity-service.R"
      to: "database-functions.R"
      via: "Migrates post_db_entity, put_db_entity_deactivation"
      pattern: "dbExecute|dbAppendTable"
    - from: "api/services/entity-service.R"
      to: "pool"
      via: "Database queries via connection pool"
      pattern: "pool"
---

<objective>
Create entity service layer with business logic for entity CRUD operations.

Purpose: Extract entity-related business logic from entity_endpoints.R and database-functions.R into a dedicated service. The entity service handles entity creation, validation, deactivation, and retrieval with related data.

Output: `api/services/entity-service.R` with entity business logic, sourced in `start_sysndd_api.R`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-service-layer-middleware/22-RESEARCH.md
@api/functions/database-functions.R (lines 1-165 for post_db_entity, put_db_entity_deactivation)
@api/endpoints/entity_endpoints.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create entity-service.R with core functions</name>
  <files>api/services/entity-service.R</files>
  <action>
Create `api/services/entity-service.R` with entity business logic.

**Functions to implement:**

**1. entity_validate(entity_data):**
Validates entity data before creation/update:
- Required fields: hgnc_id, hpo_mode_of_inheritance_term, disease_ontology_id_version, ndd_phenotype
- Returns TRUE or stops with bad_request error

**2. entity_create(entity_data, user_id, pool):**
Creates a new entity in the database:
```r
#' Create a new entity
#'
#' @param entity_data List with hgnc_id, hpo_mode_of_inheritance_term,
#'   disease_ontology_id_version, ndd_phenotype
#' @param user_id User ID creating the entity
#' @param pool Database connection pool
#' @return List with status, message, and entity_id
entity_create <- function(entity_data, user_id, pool) {
  # Validate required fields
  entity_validate(entity_data)

  # Prepare entity tibble
  entity_tibble <- tibble::tibble(
    hgnc_id = entity_data$hgnc_id,
    hpo_mode_of_inheritance_term = entity_data$hpo_mode_of_inheritance_term,
    disease_ontology_id_version = entity_data$disease_ontology_id_version,
    ndd_phenotype = entity_data$ndd_phenotype,
    entry_user_id = user_id
  )

  # Get connection from pool
  conn <- pool::poolCheckout(pool)
  on.exit(pool::poolReturn(conn), add = TRUE)

  # Insert entity (using parameterized approach)
  result <- tryCatch({
    DBI::dbAppendTable(conn, "ndd_entity", entity_tibble)
    # Get last insert ID
    entity_id <- DBI::dbGetQuery(conn, "SELECT LAST_INSERT_ID() as entity_id")
    list(
      status = 200,
      message = "OK. Entry created.",
      entry = tibble::tibble(entity_id = entity_id$entity_id)
    )
  }, error = function(e) {
    logger::log_error("Entity creation failed", error = e$message)
    list(
      status = 500,
      message = "Internal Server Error. Entry not created.",
      error = e$message
    )
  })

  result
}
```

**3. entity_deactivate(entity_id, replacement, pool):**
Marks entity as inactive:
- Uses parameterized UPDATE query
- Sets is_active = 0, replaced_by = replacement
- Based on put_db_entity_deactivation from database-functions.R

**4. entity_get_full(entity_id, pool):**
Retrieves entity with all related data (reviews, status, phenotypes).

**5. entity_check_duplicate(entity_data, pool):**
Checks if entity with same quadruple already exists.

**Key implementation details:**
- Use pool::poolCheckout/poolReturn for connection management
- Use on.exit for cleanup guarantee
- Use parameterized queries (DBI::dbExecute with params)
- Return structured responses matching current API format
- Log operations at appropriate levels
  </action>
  <verify>
- File exists: api/services/entity-service.R
- Contains entity_create, entity_deactivate, entity_get_full, entity_validate
- Uses pool for database operations
- Uses parameterized queries
  </verify>
  <done>
- entity-service.R created with 5 entity functions
- Connection management uses pool checkout/return
- Parameterized queries prevent SQL injection
  </done>
</task>

<task type="auto">
  <name>Task 2: Source entity-service.R in start_sysndd_api.R</name>
  <files>api/start_sysndd_api.R</files>
  <action>
Add source line for entity-service.R in start_sysndd_api.R.

Add after auth-service.R source line:
```r
source("services/entity-service.R", local = TRUE)
```

The services should be sourced in dependency order:
1. auth-service.R (no dependencies on other services)
2. entity-service.R (no dependencies on other services)
3. review-service.R (may reference entity)
4. etc.
  </action>
  <verify>
- `grep -n "entity-service.R" api/start_sysndd_api.R` shows source line
- Line appears after auth-service.R
  </verify>
  <done>
- entity-service.R sourced in start_sysndd_api.R
- Loaded in correct order
  </done>
</task>

<task type="auto">
  <name>Task 3: Document migration from database-functions.R</name>
  <files></files>
  <action>
Document which functions from database-functions.R are replaced by entity-service.R:

**Migration mapping:**
| database-functions.R | entity-service.R | Notes |
|----------------------|------------------|-------|
| post_db_entity (lines 23-99) | entity_create | Same logic, uses pool instead of dbConnect |
| put_db_entity_deactivation (lines 129-165) | entity_deactivate | Same logic, uses pool |

**Not migrated yet (will be in later plans):**
- put_post_db_review -> review-service.R
- put_post_db_pub_con -> review-service.R or publication-service.R
- put_post_db_phen_con -> review-service.R
- put_post_db_var_ont_con -> review-service.R
- put_post_db_status -> status-service.R or approval-service.R
- post_db_hash -> hash-service.R (or keep in helper-functions.R)
- put_db_review_approve -> approval-service.R
- put_db_status_approve -> approval-service.R

The original functions in database-functions.R will be deleted after all migrations are complete (Plan 22-08).
  </action>
  <verify>
- Migration mapping documented
- Clear plan for remaining database-functions.R content
  </verify>
  <done>
- Migration mapping documented
- entity functions identified for replacement
  </done>
</task>

</tasks>

<verification>
- [ ] api/services/entity-service.R exists with ~150+ lines
- [ ] Contains entity_create, entity_deactivate, entity_get_full
- [ ] Uses pool checkout/return pattern
- [ ] Uses parameterized queries
- [ ] start_sysndd_api.R sources entity-service.R
- [ ] No syntax errors
</verification>

<success_criteria>
- Entity service layer provides centralized entity logic
- Functions match behavior of database-functions.R equivalents
- Connection management uses pool (no direct dbConnect)
- Parameterized queries prevent SQL injection
</success_criteria>

<output>
After completion, create `.planning/phases/22-service-layer-middleware/22-03-SUMMARY.md`
</output>
