---
phase: 22-service-layer-middleware
plan: 04
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - api/services/review-service.R
  - api/services/approval-service.R
  - api/start_sysndd_api.R
autonomous: true

must_haves:
  truths:
    - "review_create handles new review with synopsis validation"
    - "review_update handles review modifications with approval reset"
    - "approval_review_approve sets review to primary and approved"
    - "approval_status_approve sets status to active and approved"
  artifacts:
    - path: "api/services/review-service.R"
      provides: "Review business logic"
      exports: ["review_create", "review_update", "review_add_publications", "review_add_phenotypes"]
      min_lines: 180
    - path: "api/services/approval-service.R"
      provides: "Approval workflow logic"
      exports: ["approval_review_approve", "approval_status_approve"]
      min_lines: 100
  key_links:
    - from: "api/services/review-service.R"
      to: "database-functions.R"
      via: "Migrates put_post_db_review, put_post_db_pub_con, put_post_db_phen_con"
      pattern: "dbAppendTable|dbExecute"
    - from: "api/services/approval-service.R"
      to: "database-functions.R"
      via: "Migrates put_db_review_approve, put_db_status_approve"
      pattern: "dbExecute"
---

<objective>
Create review and approval service layers.

Purpose: Extract review and approval logic from database-functions.R into dedicated services. The review service handles review creation, updates, and associated data (publications, phenotypes). The approval service handles review and status approval workflows.

Output: `api/services/review-service.R` and `api/services/approval-service.R`, sourced in `start_sysndd_api.R`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-service-layer-middleware/22-RESEARCH.md
@api/functions/database-functions.R (lines 192-857 for review and status functions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review-service.R</name>
  <files>api/services/review-service.R</files>
  <action>
Create `api/services/review-service.R` with review business logic.

**Functions to implement:**

**1. review_create(review_data, user_id, pool, re_review = FALSE):**
Creates a new review:
- Validates synopsis is not empty
- Escapes single quotes in synopsis (SQL-safe)
- Inserts into ndd_entity_review
- Gets LAST_INSERT_ID as review_id
- If re_review, updates re_review_entity_connect
- Returns list(status, message, entry)

**2. review_update(review_data, pool):**
Updates existing review:
- Validates review_id present
- Builds parameterized UPDATE query
- Resets review_approved to 0
- Resets approving_user_id to NULL
- Returns list(status, message, entry)

**3. review_add_publications(publication_data, entity_id, review_id, pool, is_update = FALSE):**
Adds publication connections:
- Validates publications exist in publication table
- If is_update, deletes existing connections first
- Inserts new connections to ndd_review_publication_join
- Based on put_post_db_pub_con

**4. review_add_phenotypes(phenotypes_data, entity_id, review_id, pool, is_update = FALSE):**
Adds phenotype connections:
- Validates phenotypes exist in phenotype_list
- If is_update, deletes existing connections first
- Inserts to ndd_review_phenotype_connect
- Based on put_post_db_phen_con

**5. review_add_variation_ontology(vario_data, entity_id, review_id, pool, is_update = FALSE):**
Adds variation ontology connections:
- Similar pattern to phenotypes
- Based on put_post_db_var_ont_con

**Key patterns:**
- Use pool::poolCheckout/poolReturn
- Use parameterized queries for all user input
- Validate entity_id matches for PUT requests
- Return structured response with status code and message
  </action>
  <verify>
- File exists: api/services/review-service.R
- Contains review_create, review_update, review_add_publications, review_add_phenotypes
- Uses pool for database
- Uses parameterized queries
  </verify>
  <done>
- review-service.R created with 5 review functions
- Functions mirror database-functions.R logic with pool pattern
  </done>
</task>

<task type="auto">
  <name>Task 2: Create approval-service.R</name>
  <files>api/services/approval-service.R</files>
  <action>
Create `api/services/approval-service.R` with approval workflow logic.

**Functions to implement:**

**1. approval_review_approve(review_id, user_id, approve, pool):**
Approves or unapproves reviews:
```r
#' Approve or unapprove reviews
#'
#' @param review_id Review ID(s) to approve, or "all" for all pending
#' @param user_id User performing the approval
#' @param approve Logical - TRUE to approve, FALSE to unapprove
#' @param pool Database connection pool
#' @return List with status and message
approval_review_approve <- function(review_id, user_id, approve = FALSE, pool) {
  # Handle "all" case
  if (as.character(review_id) == "all") {
    pending <- pool %>%
      tbl("ndd_entity_review") %>%
      filter(review_approved == 0) %>%
      select(review_id) %>%
      collect()
    review_ids <- pending$review_id
  } else {
    review_ids <- as.integer(review_id)
  }

  if (length(review_ids) == 0) {
    return(list(status = 200, message = "No reviews to approve"))
  }

  # Get review data for entity_ids
  reviews <- pool %>%
    tbl("ndd_entity_review") %>%
    filter(review_id %in% !!review_ids) %>%
    collect()

  conn <- pool::poolCheckout(pool)
  on.exit(pool::poolReturn(conn), add = TRUE)

  if (approve) {
    entity_ids <- unique(reviews$entity_id)
    # Reset all reviews to not primary
    # Set approved reviews to primary
    # Add approving_user_id
    # Set review_approved = 1
    # (Use parameterized IN clauses)
  } else {
    # Add approving_user_id
    # Set review_approved = 0
  }

  list(status = 200, message = "OK. Review approved.", entry = review_ids)
}
```

**2. approval_status_approve(status_id, user_id, approve, pool):**
Approves or unapproves status entries:
- Similar pattern to review approval
- Handles "all" case for batch approval
- Sets is_active and status_approved flags
- Based on put_db_status_approve

**Key patterns:**
- Handle both single ID and "all" batch operations
- Use parameterized IN clauses for batch updates
- Transaction-like behavior (all or nothing)
  </action>
  <verify>
- File exists: api/services/approval-service.R
- Contains approval_review_approve, approval_status_approve
- Uses pool for database
- Handles both single and batch operations
  </verify>
  <done>
- approval-service.R created with 2 approval functions
- Batch approval via "all" parameter supported
  </done>
</task>

<task type="auto">
  <name>Task 3: Source both services in start_sysndd_api.R</name>
  <files>api/start_sysndd_api.R</files>
  <action>
Add source lines for review-service.R and approval-service.R.

Add after entity-service.R:
```r
source("services/review-service.R", local = TRUE)
source("services/approval-service.R", local = TRUE)
```
  </action>
  <verify>
- `grep -n "review-service.R" api/start_sysndd_api.R` shows source line
- `grep -n "approval-service.R" api/start_sysndd_api.R` shows source line
  </verify>
  <done>
- Both services sourced in start_sysndd_api.R
- Loaded in correct order
  </done>
</task>

</tasks>

<verification>
- [ ] api/services/review-service.R exists with ~180+ lines
- [ ] api/services/approval-service.R exists with ~100+ lines
- [ ] review-service.R contains review_create, review_update, review_add_publications, review_add_phenotypes
- [ ] approval-service.R contains approval_review_approve, approval_status_approve
- [ ] start_sysndd_api.R sources both files
- [ ] No syntax errors
</verification>

<success_criteria>
- Review service handles all review CRUD operations
- Approval service handles review and status approval workflows
- Connection management uses pool pattern
- Functions match database-functions.R behavior
</success_criteria>

<output>
After completion, create `.planning/phases/22-service-layer-middleware/22-04-SUMMARY.md`
</output>
