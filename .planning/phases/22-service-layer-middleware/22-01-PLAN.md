---
phase: 22-service-layer-middleware
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/core/middleware.R
  - api/start_sysndd_api.R
autonomous: true

must_haves:
  truths:
    - "require_auth filter validates JWT tokens for protected endpoints"
    - "require_auth filter is registered in start_sysndd_api.R and executes for all requests"
    - "require_role filter checks user has minimum required role"
    - "Public endpoints bypass authentication via allowlist"
    - "401 returned for missing/invalid credentials, 403 for insufficient role"
    - "User context (user_id, user_role) attached to req for downstream use"
  artifacts:
    - path: "api/core/middleware.R"
      provides: "Authentication and authorization middleware filters"
      exports: ["require_auth", "require_role", "AUTH_ALLOWLIST"]
      min_lines: 80
  key_links:
    - from: "api/core/middleware.R"
      to: "api/core/errors.R"
      via: "Uses error_unauthorized, error_forbidden for RFC 9457 responses"
      pattern: "error_unauthorized|error_forbidden"
    - from: "api/start_sysndd_api.R"
      to: "api/core/middleware.R"
      via: "Sources middleware and registers filters"
      pattern: "source.*middleware"
    - from: "api/start_sysndd_api.R"
      to: "require_auth"
      via: "Filter registration with pr_filter"
      pattern: "pr_filter.*require_auth"
---

<objective>
Create authentication and authorization middleware infrastructure.

Purpose: Centralize JWT validation and role-based access control into reusable Plumber filters, eliminating duplicated auth code scattered across 50+ endpoint functions. This provides a consistent security layer following the allowlist pattern from research.

Output: `api/core/middleware.R` with `require_auth` and `require_role` filters, registered in `start_sysndd_api.R`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-service-layer-middleware/22-RESEARCH.md
@api/start_sysndd_api.R
@api/core/errors.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create core/middleware.R with auth filters</name>
  <files>api/core/middleware.R</files>
  <action>
Create `api/core/middleware.R` with authentication and authorization middleware:

**1. AUTH_ALLOWLIST constant:**
Define public endpoints that bypass authentication:
```r
AUTH_ALLOWLIST <- c(
  "/api/gene/hash",
  "/api/entity/hash",
  "/api/jobs/clustering/submit",
  "/api/jobs/clustering/submit/",
  "/api/jobs/phenotype_clustering/submit",
  "/api/jobs/phenotype_clustering/submit/",
  "/api/user/password/reset/request",
  "/api/auth/signin",
  "/api/auth/signup",
  "/api/auth/verify",
  "/api/auth/refresh",
  "/health",
  "/health/",
  "/__docs__/",
  "/openapi.json"
)
```

**2. require_auth filter:**
- Uses global `dw$secret` for JWT decoding (approved global)
- Checks if path is in AUTH_ALLOWLIST or is OPTIONS request -> forward()
- GET requests without auth -> forward() (public read access)
- All other requests: validate Bearer token from HTTP_AUTHORIZATION
- On missing auth: return 401 via error_unauthorized()
- On invalid/expired token: return 401 via error_unauthorized()
- On success: attach user_id, user_role, user_name to req object, then forward()

**3. require_role helper function:**
Not a filter - a function endpoints call to enforce role requirements:
```r
require_role <- function(req, res, min_role) {
  role_levels <- c("Viewer" = 1, "Reviewer" = 2, "Curator" = 3, "Administrator" = 4)
  user_level <- role_levels[[req$user_role]] %||% 0
  required_level <- role_levels[[min_role]] %||% 1

  if (user_level < required_level) {
    res$status <- 403
    stop(error_forbidden(sprintf(
      "This action requires %s privileges. You have %s role.",
      min_role, req$user_role %||% "no"
    )))
  }
  invisible(TRUE)
}
```

**Key implementation details:**
- Use `jose::jwt_decode_hmac()` for JWT decoding (already used in checkSignInFilter)
- Use `stringr::str_remove()` for Bearer prefix removal
- Check token expiry: `user$exp < as.numeric(Sys.time())`
- Return RFC 9457 errors via core/errors.R helpers
- Log auth events at DEBUG level using logger
  </action>
  <verify>
- File exists at api/core/middleware.R
- Contains AUTH_ALLOWLIST, require_auth, require_role
- Uses error_unauthorized for 401 responses
- Uses error_forbidden for 403 responses
  </verify>
  <done>
- core/middleware.R created with auth filter and role helper
- Filter handles allowlist, JWT validation, and user context attachment
- RFC 9457 compliant error responses
  </done>
</task>

<task type="auto">
  <name>Task 2: Register middleware in start_sysndd_api.R</name>
  <files>api/start_sysndd_api.R</files>
  <action>
Update `api/start_sysndd_api.R` to source and use the new middleware:

**1. Source middleware.R:**
Add after line 129 (after core/logging_sanitizer.R):
```r
source("core/middleware.R", local = TRUE)
```

**2. Replace checkSignInFilter with require_auth:**
The existing checkSignInFilter (lines 265-335) implements similar logic but with inline allowlist.
Replace the registration at line 447:
- Change: `pr_filter("check_signin", checkSignInFilter)`
- To: `pr_filter("require_auth", require_auth)`

**3. Keep checkSignInFilter temporarily:**
Don't delete checkSignInFilter yet - it will be removed once all endpoints are migrated.
Add a comment above it:
```r
# DEPRECATED: Use require_auth filter instead.
# This will be removed after Phase 22 endpoint migration.
```

**4. Verify filter order:**
Filters must execute in order: cors -> require_auth
The current order (cors first) is correct.
  </action>
  <verify>
- `grep -n "middleware.R" api/start_sysndd_api.R` shows source line
- `grep -n "require_auth" api/start_sysndd_api.R` shows filter registration
- `grep -n "DEPRECATED" api/start_sysndd_api.R` shows deprecation comment
  </verify>
  <done>
- middleware.R sourced in start_sysndd_api.R
- require_auth filter registered
- Filter order maintained (cors first)
  </done>
</task>

<task type="auto">
  <name>Task 3: Test middleware with curl</name>
  <files></files>
  <action>
Verify middleware works correctly with curl tests. These tests confirm the middleware doesn't break existing functionality.

**Test commands (run against local API if available, otherwise skip with note):**

1. **Public endpoint (should return 200):**
```bash
curl -s -o /dev/null -w "%{http_code}" http://localhost:7778/health/
# Expected: 200
```

2. **Protected endpoint without auth (GET - should forward):**
```bash
curl -s -o /dev/null -w "%{http_code}" http://localhost:7778/api/entity/
# Expected: 200 (GET without auth is allowed for read access)
```

3. **Protected POST without auth (should return 401):**
```bash
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:7778/api/entity/
# Expected: 401
```

4. **Hash endpoint (public POST):**
```bash
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:7778/api/gene/hash -H "Content-Type: application/json" -d '{"symbol": "test"}'
# Expected: 200 or 400 (not 401 - auth is bypassed)
```

If API is not running, document expected behavior and note "API not running - manual verification needed".
  </action>
  <verify>
- curl commands documented
- Expected responses noted for each test case
- If API running: all tests pass
- If API not running: documented for future verification
  </verify>
  <done>
- Middleware curl tests documented
- Public endpoints bypass auth
- Protected endpoints require auth for non-GET requests
  </done>
</task>

</tasks>

<verification>
- [ ] api/core/middleware.R exists with ~80+ lines
- [ ] Contains require_auth filter function
- [ ] Contains require_role helper function
- [ ] Contains AUTH_ALLOWLIST constant
- [ ] start_sysndd_api.R sources middleware.R
- [ ] start_sysndd_api.R registers require_auth filter with pr_filter
- [ ] No syntax errors: `Rscript -e "source('api/core/middleware.R')"`
</verification>

<success_criteria>
- Middleware infrastructure is in place for auth consolidation
- require_auth filter handles JWT validation and user context
- require_role helper available for endpoint-level role checks
- Existing API functionality preserved (no breaking changes yet)
</success_criteria>

<output>
After completion, create `.planning/phases/22-service-layer-middleware/22-01-SUMMARY.md`
</output>
