---
phase: 22-service-layer-middleware
plan: 07
type: execute
wave: 3
depends_on: ["22-01", "22-03", "22-04", "22-05"]
files_modified:
  - api/endpoints/entity_endpoints.R
  - api/endpoints/review_endpoints.R
  - api/endpoints/status_endpoints.R
autonomous: true

must_haves:
  truths:
    - "entity_endpoints.R uses require_role for Curator+ endpoints"
    - "review_endpoints.R uses require_role for Reviewer+ endpoints"
    - "status_endpoints.R uses require_role for Reviewer+ endpoints"
    - "Baseline responses captured BEFORE refactoring"
    - "Old inline authorization code removed after service wiring"
  artifacts:
    - path: "api/endpoints/entity_endpoints.R"
      provides: "Refactored entity endpoints"
      contains: "require_role"
    - path: "api/endpoints/review_endpoints.R"
      provides: "Refactored review endpoints"
      contains: "require_role"
    - path: "api/endpoints/status_endpoints.R"
      provides: "Refactored status endpoints"
      contains: "require_role"
  key_links:
    - from: "api/endpoints/entity_endpoints.R"
      to: "api/core/middleware.R"
      via: "Uses require_role for authorization"
      pattern: "require_role"
    - from: "api/endpoints/entity_endpoints.R"
      to: "api/services/entity-service.R"
      via: "Calls entity service for business logic"
      pattern: "entity_create|entity_deactivate"
    - from: "api/endpoints/review_endpoints.R"
      to: "api/services/review-service.R"
      via: "Calls review service for business logic"
      pattern: "review_create|review_update"
---

<objective>
Refactor core data endpoints (entity, review, status) to use middleware and service layer.

Purpose: Complete the endpoint migration for core data operations. These are the most frequently used write operations and will benefit most from consistent middleware and service layer patterns. This plan focuses on the core data endpoints; admin endpoints are handled in Plan 22-07b.

Output: entity_endpoints.R, review_endpoints.R, status_endpoints.R using consistent require_role and service layer patterns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-service-layer-middleware/22-01-SUMMARY.md
@.planning/phases/22-service-layer-middleware/22-03-SUMMARY.md
@.planning/phases/22-service-layer-middleware/22-04-SUMMARY.md
@api/core/middleware.R
@api/services/entity-service.R
@api/services/review-service.R
</context>

<tasks>

<task type="auto">
  <name>Task 0: Capture baseline responses for entity/review/status endpoints</name>
  <files></files>
  <action>
Before refactoring, document current API responses for regression testing (QA-01 requirement).

**Capture baseline (if API running):**
```bash
# Entity endpoints
curl -s http://localhost:7778/api/entity/ | head -c 500
curl -s http://localhost:7778/api/entity/1 | head -c 500

# Review endpoints
curl -s http://localhost:7778/api/review/1 | head -c 500

# Status endpoints
curl -s http://localhost:7778/api/status/1 | head -c 500

# Document 401/403 responses for protected operations
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:7778/api/entity/
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:7778/api/review/
```

**Document expected behaviors:**
| Endpoint | Method | Auth Required | Min Role | Expected Response |
|----------|--------|---------------|----------|-------------------|
| /api/entity/ | GET | No | - | List of entities |
| /api/entity/ | POST | Yes | Curator | Created entity |
| /api/entity/<id> | GET | No | - | Entity details |
| /api/entity/deactivate | PUT | Yes | Curator | Deactivation result |
| /api/review/<entity_id> | GET | No | - | Review data |
| /api/review/ | POST | Yes | Reviewer | Created review |
| /api/review/approve | PUT | Yes | Curator | Approval result |
| /api/status/<entity_id> | GET | No | - | Status data |
| /api/status/ | POST | Yes | Reviewer | Created status |
| /api/status/approve | PUT | Yes | Curator | Approval result |

If API not running, note "baseline captured from code analysis".
  </action>
  <verify>
- Baseline behavior documented for each endpoint
- Expected role requirements identified
- Sample responses captured or noted
  </verify>
  <done>
- Pre-refactoring behavior captured
- Ready for safe refactoring with regression testing
  </done>
</task>

<task type="auto">
  <name>Task 1: Refactor entity_endpoints.R</name>
  <files>api/endpoints/entity_endpoints.R</files>
  <action>
Refactor entity_endpoints.R to use middleware and service layer.

**Role checks to replace (lines ~206, 447, 625):**
```r
# Before
if (req$user_role %in% c("Administrator", "Curator")) {
  # create/update logic
}

# After
require_role(req, res, "Curator")
# create/update logic (same or call service)
```

**Service layer integration:**

1. **POST /** (create entity):
```r
# Replace inline creation with:
require_role(req, res, "Curator")
result <- entity_create(
  entity_data = list(
    hgnc_id = hgnc_id,
    hpo_mode_of_inheritance_term = hpo_mode_of_inheritance_term,
    disease_ontology_id_version = disease_ontology_id_version,
    ndd_phenotype = ndd_phenotype
  ),
  user_id = req$user_id,
  pool = pool
)
```

2. **PUT /deactivate** (deactivate entity):
```r
# Replace inline deactivation with:
require_role(req, res, "Curator")
result <- entity_deactivate(entity_id, replacement, pool)
```

3. **Keep GET endpoints unchanged** (read operations don't need role checks or service calls for now).

**Verify old inline code is REMOVED:**
After adding service calls, delete the old inline database code that was replaced. Do not leave duplicated logic.
  </action>
  <verify>
- `grep -c "require_role" api/endpoints/entity_endpoints.R` shows 2+ usages
- `grep -c "entity_create\|entity_deactivate" api/endpoints/entity_endpoints.R` shows service calls
- `grep -c "req\$user_role %in%" api/endpoints/entity_endpoints.R` shows 0 (old pattern removed)
- No syntax errors
  </verify>
  <done>
- entity_endpoints.R uses require_role for Curator+ endpoints
- Service layer calls for create/deactivate
- Old inline authorization code removed
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor review_endpoints.R and status_endpoints.R</name>
  <files>api/endpoints/review_endpoints.R, api/endpoints/status_endpoints.R</files>
  <action>
**review_endpoints.R refactoring:**

1. **POST /review** (line ~197):
```r
# Before
if (req$user_role %in% c("Administrator", "Curator", "Reviewer")) {
  # create review
}

# After
require_role(req, res, "Reviewer")
result <- review_create(review_data, req$user_id, pool)
```

2. **PUT /approve** (line ~595):
```r
require_role(req, res, "Curator")
result <- approval_review_approve(review_id, req$user_id, review_ok, pool)
```

**status_endpoints.R refactoring:**

1. **POST /status** (line ~245):
```r
require_role(req, res, "Reviewer")
result <- status_create(status_data, pool)
```

2. **PUT /approve** (line ~285):
```r
require_role(req, res, "Curator")
result <- approval_status_approve(status_id, req$user_id, status_ok, pool)
```

**Verify old inline code is REMOVED:**
After adding service calls and require_role, ensure the old `if (req$user_role %in% ...)` patterns are deleted, not just commented out.
  </action>
  <verify>
- `grep -c "require_role" api/endpoints/review_endpoints.R` shows 2+ usages
- `grep -c "require_role" api/endpoints/status_endpoints.R` shows 2+ usages
- `grep -c "req\$user_role %in%" api/endpoints/review_endpoints.R` shows 0 (old pattern removed)
- `grep -c "req\$user_role %in%" api/endpoints/status_endpoints.R` shows 0 (old pattern removed)
- No syntax errors
  </verify>
  <done>
- review_endpoints.R uses require_role and service calls
- status_endpoints.R uses require_role and service calls
- Old inline authorization code removed from both files
  </done>
</task>

</tasks>

<verification>
- [ ] Baseline responses captured before refactoring
- [ ] entity_endpoints.R uses require_role (no old pattern remains)
- [ ] review_endpoints.R uses require_role (no old pattern remains)
- [ ] status_endpoints.R uses require_role (no old pattern remains)
- [ ] Service layer calls replace inline database code
- [ ] No syntax errors in any refactored file
- [ ] Responses match baseline after refactoring
</verification>

<success_criteria>
- Core data endpoints use consistent require_role pattern
- Duplicated authorization code eliminated (not just bypassed)
- Service layer calls for complex operations
- API behavior unchanged (verified against baseline)
</success_criteria>

<output>
After completion, create `.planning/phases/22-service-layer-middleware/22-07-SUMMARY.md`
</output>
