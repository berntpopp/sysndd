---
phase: 22-service-layer-middleware
plan: 07
type: execute
wave: 3
depends_on: ["22-01", "22-03", "22-04", "22-05"]
files_modified:
  - api/endpoints/entity_endpoints.R
  - api/endpoints/review_endpoints.R
  - api/endpoints/status_endpoints.R
  - api/endpoints/re_review_endpoints.R
  - api/endpoints/ontology_endpoints.R
  - api/endpoints/statistics_endpoints.R
  - api/endpoints/logging_endpoints.R
  - api/endpoints/jobs_endpoints.R
autonomous: true

must_haves:
  truths:
    - "entity_endpoints.R uses require_role for Curator+ endpoints"
    - "review_endpoints.R uses require_role for Reviewer+ endpoints"
    - "status_endpoints.R uses require_role for Reviewer+ endpoints"
    - "re_review_endpoints.R uses require_role consistently"
    - "All Administrator-only endpoints use require_role(Administrator)"
  artifacts:
    - path: "api/endpoints/entity_endpoints.R"
      provides: "Refactored entity endpoints"
      contains: "require_role"
    - path: "api/endpoints/review_endpoints.R"
      provides: "Refactored review endpoints"
      contains: "require_role"
  key_links:
    - from: "api/endpoints/entity_endpoints.R"
      to: "api/core/middleware.R"
      via: "Uses require_role for authorization"
      pattern: "require_role"
    - from: "api/endpoints/entity_endpoints.R"
      to: "api/services/entity-service.R"
      via: "Calls entity service for business logic"
      pattern: "entity_create|entity_deactivate"
---

<objective>
Refactor remaining endpoints to use middleware and service layer.

Purpose: Complete the endpoint migration to use require_role and service layer calls. This plan covers entity, review, status, and other endpoints with role checks.

Output: All endpoints using consistent middleware pattern.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-service-layer-middleware/22-01-SUMMARY.md
@.planning/phases/22-service-layer-middleware/22-03-SUMMARY.md
@.planning/phases/22-service-layer-middleware/22-04-SUMMARY.md
@api/core/middleware.R
@api/services/entity-service.R
@api/services/review-service.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor entity_endpoints.R</name>
  <files>api/endpoints/entity_endpoints.R</files>
  <action>
Refactor entity_endpoints.R to use middleware and service layer.

**Role checks to replace (lines ~206, 447, 625):**
```r
# Before
if (req$user_role %in% c("Administrator", "Curator")) {
  # create/update logic
}

# After
require_role(req, res, "Curator")
# create/update logic (same or call service)
```

**Service layer integration:**

1. **POST /** (create entity):
```r
# Replace inline creation with:
result <- entity_create(
  entity_data = list(
    hgnc_id = hgnc_id,
    hpo_mode_of_inheritance_term = hpo_mode_of_inheritance_term,
    disease_ontology_id_version = disease_ontology_id_version,
    ndd_phenotype = ndd_phenotype
  ),
  user_id = req$user_id,
  pool = pool
)
```

2. **PUT /deactivate** (deactivate entity):
```r
# Replace inline deactivation with:
result <- entity_deactivate(entity_id, replacement, pool)
```

3. **Keep GET endpoints unchanged** (read operations don't need role checks or service calls for now).
  </action>
  <verify>
- `grep -c "require_role" api/endpoints/entity_endpoints.R` shows 3+ usages
- `grep -c "entity_create\|entity_deactivate" api/endpoints/entity_endpoints.R` shows service calls
- No syntax errors
  </verify>
  <done>
- entity_endpoints.R uses require_role for Curator+ endpoints
- Service layer calls for create/deactivate
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor review_endpoints.R and status_endpoints.R</name>
  <files>api/endpoints/review_endpoints.R, api/endpoints/status_endpoints.R</files>
  <action>
**review_endpoints.R refactoring:**

1. **POST /review** (line ~197):
```r
# Before
if (req$user_role %in% c("Administrator", "Curator", "Reviewer")) {
  # create review
}

# After
require_role(req, res, "Reviewer")
result <- review_create(review_data, req$user_id, pool)
```

2. **PUT /approve** (line ~595):
```r
require_role(req, res, "Curator")
result <- approval_review_approve(review_id, req$user_id, review_ok, pool)
```

**status_endpoints.R refactoring:**

1. **POST /status** (line ~245):
```r
require_role(req, res, "Reviewer")
result <- status_create(status_data, pool)
```

2. **PUT /approve** (line ~285):
```r
require_role(req, res, "Curator")
result <- approval_status_approve(status_id, req$user_id, status_ok, pool)
```
  </action>
  <verify>
- `grep -c "require_role" api/endpoints/review_endpoints.R` shows usages
- `grep -c "require_role" api/endpoints/status_endpoints.R` shows usages
- No syntax errors
  </verify>
  <done>
- review_endpoints.R uses require_role and service calls
- status_endpoints.R uses require_role and service calls
  </done>
</task>

<task type="auto">
  <name>Task 3: Refactor remaining endpoints with role checks</name>
  <files>api/endpoints/re_review_endpoints.R, api/endpoints/ontology_endpoints.R, api/endpoints/statistics_endpoints.R, api/endpoints/logging_endpoints.R, api/endpoints/jobs_endpoints.R</files>
  <action>
**re_review_endpoints.R:**
Most complex file with ~15 role checks. Replace each with require_role:
- Lines 27, 85, 141: `require_role(req, res, "Reviewer")`
- Lines 327, 328: Complex logic - keep but simplify
- Lines 435, 520, 523, 578, 584, 636: Various role checks

**ontology_endpoints.R:**
- Line 100: `require_role(req, res, "Administrator")`
- Line 138: `require_role(req, res, "Administrator")`

**statistics_endpoints.R:**
- Lines 219, 267, 328, 369: All require Administrator
```r
# Before
if (is.null(req$user_role) || req$user_role != "Administrator") {
  res$status <- 403
  return(list(error = "Not authorized."))
}

# After
require_role(req, res, "Administrator")
```

**logging_endpoints.R:**
- Lines 50-51: `require_role(req, res, "Administrator")`

**jobs_endpoints.R:**
- Line 250: `require_role(req, res, "Administrator")` (for ontology_update)
  </action>
  <verify>
- `grep -rn "req\$user_role !=" api/endpoints/` count significantly reduced
- `grep -rn "require_role" api/endpoints/` shows usage across all refactored files
  </verify>
  <done>
- All endpoints with role checks refactored
- Consistent require_role pattern across codebase
  </done>
</task>

</tasks>

<verification>
- [ ] entity_endpoints.R uses require_role
- [ ] review_endpoints.R uses require_role
- [ ] status_endpoints.R uses require_role
- [ ] re_review_endpoints.R uses require_role
- [ ] ontology/statistics/logging/jobs endpoints use require_role
- [ ] No syntax errors in any refactored file
- [ ] Total role check patterns reduced by >80%
</verification>

<success_criteria>
- All endpoint files use consistent require_role pattern
- Duplicated authorization code eliminated
- Service layer calls for complex operations
- API behavior unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/22-service-layer-middleware/22-07-SUMMARY.md`
</output>
