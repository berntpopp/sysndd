---
phase: 22-service-layer-middleware
plan: 09
type: execute
wave: 4
depends_on: ["22-06", "22-07", "22-08"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "All endpoints return same data as before refactoring"
    - "Authentication flow works (signin, verify, refresh)"
    - "Role-based access control works (401/403 responses correct)"
    - "CRUD operations work (entity, review, status)"
    - "Frontend renders correctly with refactored API"
  artifacts: []
  key_links:
    - from: "curl tests"
      to: "production API"
      via: "Response comparison"
      pattern: "diff"
---

<objective>
Verify all endpoints maintain correct behavior after Phase 22 refactoring.

Purpose: Comprehensive verification that the middleware and service layer refactoring hasn't broken any API functionality. This includes curl tests for key endpoints and comparison with production responses.

Output: Verification report confirming API behavior is preserved.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-service-layer-middleware/22-06-SUMMARY.md
@.planning/phases/22-service-layer-middleware/22-07-SUMMARY.md
@.planning/phases/22-service-layer-middleware/22-08-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify authentication flow</name>
  <files></files>
  <action>
Test authentication endpoints work correctly.

**Test signin:**
```bash
# POST /api/auth/signin (public endpoint)
curl -s -X POST http://localhost:7778/api/auth/signin \
  -H "Content-Type: application/json" \
  -d '{"user_name":"test_user","password":"test_pass"}' \
  | jq '.access_token != null'
# Expected: true (or error if credentials invalid - that's OK, we're testing structure)
```

**Test verify:**
```bash
# GET /api/auth/verify (with token)
TOKEN="<token_from_signin>"
curl -s http://localhost:7778/api/auth/verify \
  -H "Authorization: Bearer $TOKEN" \
  | jq '.user_id != null'
# Expected: true
```

**Test 401 on protected endpoint without auth:**
```bash
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:7778/api/entity/
# Expected: 401
```

**Test 403 on admin endpoint with non-admin token:**
```bash
# With Reviewer token
curl -s -o /dev/null -w "%{http_code}" -X GET http://localhost:7778/api/logs/ \
  -H "Authorization: Bearer $REVIEWER_TOKEN"
# Expected: 403
```

Document results for each test case.
  </action>
  <verify>
- Signin returns token structure
- Verify returns user info
- Protected endpoints return 401 without auth
- Admin endpoints return 403 for non-admins
  </verify>
  <done>
- Authentication flow verified
- Correct HTTP status codes for auth failures
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify CRUD operations</name>
  <files></files>
  <action>
Test entity, review, and status CRUD operations.

**Test entity list (public GET):**
```bash
curl -s http://localhost:7778/api/entity/ | jq 'length > 0'
# Expected: true

# Compare with production
curl -s https://sysndd.dbmr.unibe.ch/API/entity/ | jq 'length > 0'
```

**Test review list:**
```bash
curl -s http://localhost:7778/api/review/1 | jq '.entity_id'
# Should return review data
```

**Test status list:**
```bash
curl -s http://localhost:7778/api/status/1 | jq '.entity_id'
# Should return status data
```

**Test gene endpoint:**
```bash
curl -s http://localhost:7778/api/gene/HGNC:1234 | jq 'type'
# Expected: "object" or "array"
```

**Test search:**
```bash
curl -s "http://localhost:7778/api/search/?q=MECP2" | jq 'length > 0'
# Expected: true
```

**Compare response structures with production:**
For each endpoint, verify core data fields match between local and production API.
  </action>
  <verify>
- Entity, review, status endpoints return data
- Response structures match production
- Search returns results
  </verify>
  <done>
- CRUD operations verified
- Response structures compatible
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 22 refactoring:
- Authentication middleware (require_auth filter)
- Authorization middleware (require_role helper)
- Service layer (auth, entity, review, approval, status, user, search services)
- Endpoint refactoring to use middleware and services
- database-functions.R decomposition and deletion
  </what-built>
  <how-to-verify>
**Full API Verification:**

1. Start the local API:
   ```bash
   cd api && Rscript start_sysndd_api.R
   ```

2. Test basic authentication:
   - Go to http://localhost:7778/__docs__/
   - Try the signin endpoint
   - Copy token for authenticated requests

3. Test key workflows in frontend:
   - Navigate to http://localhost:8080 (Vue frontend)
   - Log in with valid credentials
   - Browse entities list
   - View entity details
   - Check reviews display correctly
   - (If Curator+) Try creating/editing a review

4. Test admin functions (if Administrator):
   - Access user management
   - Access statistics
   - Access logs

5. Compare with production:
   - https://sysndd.dbmr.unibe.ch
   - Verify data displays correctly
   - Core functionality unchanged

**Expected:**
- All pages render without errors
- Data displays correctly
- Authentication works
- Role-based features accessible based on role
  </how-to-verify>
  <resume-signal>Type "verified" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] Authentication endpoints work
- [ ] Protected endpoints return 401/403 correctly
- [ ] Entity, review, status CRUD works
- [ ] Search returns results
- [ ] Frontend renders correctly
- [ ] Data matches production API structure
</verification>

<success_criteria>
- All Phase 22 changes verified working
- No regression in API functionality
- Frontend compatible with refactored API
- Ready for Phase 23
</success_criteria>

<output>
After completion, create `.planning/phases/22-service-layer-middleware/22-09-SUMMARY.md`
</output>
