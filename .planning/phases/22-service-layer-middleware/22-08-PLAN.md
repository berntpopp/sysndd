---
phase: 22-service-layer-middleware
plan: 08
type: execute
wave: 4
depends_on: ["22-03", "22-04", "22-05", "22-06", "22-07", "22-07b"]
files_modified:
  - api/functions/database-functions.R (DELETE)
  - api/start_sysndd_api.R
autonomous: true

must_haves:
  truths:
    - "database-functions.R is deleted (no longer exists)"
    - "All functions from database-functions.R are available in service layer"
    - "No endpoint or function references database-functions.R directly"
    - "API starts without errors after deletion"
    - "Function-to-endpoint dependency matrix verified before deletion"
  artifacts:
    - path: "api/functions/database-functions.R"
      provides: "DELETED - file should not exist"
  key_links:
    - from: "api/start_sysndd_api.R"
      to: "api/services/*-service.R"
      via: "Services replace database-functions.R"
      pattern: "source.*services"
---

<objective>
Delete database-functions.R after verifying all functions are migrated.

Purpose: The 1,226-line "god file" database-functions.R has been decomposed into the service layer. This plan verifies the migration is complete and safely deletes the file.

Output: database-functions.R deleted, API functional with service layer.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-service-layer-middleware/22-03-SUMMARY.md
@.planning/phases/22-service-layer-middleware/22-04-SUMMARY.md
@.planning/phases/22-service-layer-middleware/22-05-SUMMARY.md
@.planning/phases/22-service-layer-middleware/22-07-SUMMARY.md
@.planning/phases/22-service-layer-middleware/22-07b-SUMMARY.md
@api/functions/database-functions.R
@api/start_sysndd_api.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build function-to-endpoint dependency matrix and verify migration</name>
  <files></files>
  <action>
Create explicit mapping of which database-functions.R functions are used by which endpoints, then verify all are migrated.

**Step 1: Build the dependency matrix**

| Original Function | New Location | Used By Endpoints | Migration Status |
|-------------------|--------------|-------------------|------------------|
| post_db_entity | entity-service.R:entity_create | entity_endpoints.R POST / | Verify |
| put_db_entity_deactivation | entity-service.R:entity_deactivate | entity_endpoints.R PUT /deactivate | Verify |
| put_post_db_review | review-service.R:review_create, review_update | review_endpoints.R POST /, PUT / | Verify |
| put_post_db_pub_con | review-service.R:review_add_publications | review_endpoints.R POST /publications | Verify |
| put_post_db_phen_con | review-service.R:review_add_phenotypes | review_endpoints.R POST /phenotypes | Verify |
| put_post_db_var_ont_con | review-service.R:review_add_variation_ontology | review_endpoints.R POST /variation | Verify |
| put_post_db_status | status-service.R:status_create, status_update | status_endpoints.R POST /, PUT / | Verify |
| post_db_hash | helper-functions.R:post_db_hash | hash_endpoints.R | Move (not service) |
| put_db_review_approve | approval-service.R:approval_review_approve | review_endpoints.R PUT /approve | Verify |
| put_db_status_approve | approval-service.R:approval_status_approve | status_endpoints.R PUT /approve | Verify |

**Step 2: Verify with grep that endpoints call new service functions**
```bash
# Check entity endpoints use new service
grep -n "entity_create\|entity_deactivate" api/endpoints/entity_endpoints.R

# Check review endpoints use new service
grep -n "review_create\|review_update\|review_add_" api/endpoints/review_endpoints.R

# Check status endpoints use new service
grep -n "status_create\|status_update" api/endpoints/status_endpoints.R

# Check approval endpoints use new service
grep -n "approval_review_approve\|approval_status_approve" api/endpoints/review_endpoints.R api/endpoints/status_endpoints.R
```

**Step 3: Verify no endpoints reference old function names**
```bash
# Should return EMPTY (no matches)
grep -rn "post_db_entity\|put_db_entity_deactivation" api/endpoints/ --include="*.R"
grep -rn "put_post_db_review\|put_post_db_pub_con\|put_post_db_phen_con" api/endpoints/ --include="*.R"
grep -rn "put_post_db_var_ont_con\|put_post_db_status" api/endpoints/ --include="*.R"
grep -rn "put_db_review_approve\|put_db_status_approve" api/endpoints/ --include="*.R"
```

If any old function references found, document which endpoints need updating.
  </action>
  <verify>
- Dependency matrix created with all 10 functions mapped
- Service layer calls found in all relevant endpoints
- No endpoint references old function names (grep returns empty)
  </verify>
  <done>
- Function-to-endpoint matrix complete
- All functions verified migrated to service layer
- Ready for safe deletion
  </done>
</task>

<task type="auto">
  <name>Task 2: Move post_db_hash to helper-functions.R</name>
  <files>api/functions/helper-functions.R</files>
  <action>
The post_db_hash function is used by hash endpoints and isn't really "service layer" logic - it's a utility function. Move it to helper-functions.R.

1. Copy post_db_hash function (lines 881-978) to end of helper-functions.R

2. Update any references (check hash_endpoints.R):
```bash
grep -n "post_db_hash" api/endpoints/
```

The function should work unchanged since it uses global `pool` (approved global).
  </action>
  <verify>
- `grep "post_db_hash" api/functions/helper-functions.R` shows function exists
- Function works with hash endpoints
  </verify>
  <done>
- post_db_hash moved to helper-functions.R
- Hash functionality preserved
  </done>
</task>

<task type="auto">
  <name>Task 3: Delete database-functions.R and update start_sysndd_api.R</name>
  <files>api/functions/database-functions.R, api/start_sysndd_api.R</files>
  <action>
**Remove source line from start_sysndd_api.R:**

Find and remove (line ~110):
```r
source("functions/database-functions.R", local = TRUE)
```

**Delete database-functions.R:**
```bash
rm api/functions/database-functions.R
```

**Verify API loads:**
```bash
# Quick syntax check
cd api && Rscript -e "
  tryCatch({
    source('start_sysndd_api.R')
    cat('API loaded successfully\n')
  }, error = function(e) {
    cat('Error:', e$message, '\n')
    quit(status = 1)
  })
" 2>&1 | head -50
```

Note: This will attempt to start the API. If database not available, it may error on pool creation, which is expected. The key check is that no "object not found" errors for the migrated functions.
  </action>
  <verify>
- `ls api/functions/database-functions.R 2>/dev/null` returns nothing (file deleted)
- `grep "database-functions.R" api/start_sysndd_api.R` returns nothing
- API loads without "object not found" errors for migrated functions
  </verify>
  <done>
- database-functions.R deleted
- Source line removed from start_sysndd_api.R
- API functional with service layer
  </done>
</task>

</tasks>

<verification>
- [ ] Function-to-endpoint dependency matrix created and verified
- [ ] All functions from database-functions.R have service layer equivalents
- [ ] No endpoints reference old function names
- [ ] post_db_hash moved to helper-functions.R
- [ ] database-functions.R file deleted
- [ ] start_sysndd_api.R no longer sources database-functions.R
- [ ] No "object not found" errors when API loads
</verification>

<success_criteria>
- 1,226-line god file eliminated
- All functionality preserved in service layer
- Cleaner codebase with single-responsibility files
- API behavior unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/22-service-layer-middleware/22-08-SUMMARY.md`
</output>
