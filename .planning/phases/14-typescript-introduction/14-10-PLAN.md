---
phase: 14-typescript-introduction
plan: 10
type: execute
wave: 4
depends_on: ["14-07"]
files_modified:
  - app/.env.development
  - app/.env.production
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "API requests use single /api/ prefix, not /api/api/"
    - "Tables load data successfully without 404 errors"
    - "All API endpoints reachable in development"
  artifacts:
    - path: "app/.env.development"
      provides: "VITE_API_URL without trailing /api"
      contains: "VITE_API_URL=\"http://localhost:7778\""
    - path: "app/.env.production"
      provides: "VITE_API_URL without trailing /api"
      contains: "VITE_API_URL=\"https://sysndd.org\""
  key_links:
    - from: "app/.env.development"
      to: "app/src/composables/useTableMethods.js"
      via: "import.meta.env.VITE_API_URL"
      pattern: "VITE_API_URL/api/"
---

<objective>
Fix double /api/api/ prefix in API URLs causing 404 errors in table and analysis views.

Purpose: Enable data loading in all table and analysis components by correcting the API URL construction.

Output: All API requests use correct URLs (single /api/ prefix), tables load data without 404 errors.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

# Environment files
@app/.env.development
@app/.env.production

# Key files constructing API URLs
@app/src/composables/useTableMethods.js
@app/src/assets/js/constants/url_constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix VITE_API_URL in development environment</name>
  <files>app/.env.development</files>
  <action>
**Root cause:**
- `VITE_API_URL` is set to `http://localhost:7778/api`
- Codebase constructs URLs as `${VITE_API_URL}/api/endpoint`
- Result: `http://localhost:7778/api/api/endpoint` (double /api/)

**Fix:**
Update `app/.env.development` to remove `/api` from VITE_API_URL:

```env
VITE_API_URL="http://localhost:7778"
VITE_URL="http://localhost:5173"

# Legacy Vue CLI variables (commented out for reference during migration)
# VUE_APP_API_URL="http://localhost:7778/api"
# VUE_APP_URL="http://localhost:8080"
```

The codebase already adds `/api/` prefix in API calls, so VITE_API_URL should be just the base URL.
  </action>
  <verify>
Check file content: `cat app/.env.development | grep VITE_API_URL` should show `VITE_API_URL="http://localhost:7778"` without trailing `/api`.
  </verify>
  <done>
VITE_API_URL in development environment set to base URL without /api suffix.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix VITE_API_URL in production environment</name>
  <files>app/.env.production</files>
  <action>
Apply the same fix to production environment.

Update `app/.env.production`:

```env
VITE_API_URL="https://sysndd.org"
VITE_URL="https://sysndd.org"

# Legacy Vue CLI variables (commented out for reference during migration)
# VUE_APP_API_URL="https://sysndd.org/api"
# VUE_APP_URL="https://sysndd.org"
```

**Important:** Verify the production base URL is correct. The original was `https://sysndd.org/api`, so the base should be `https://sysndd.org`.
  </action>
  <verify>
Check file content: `cat app/.env.production | grep VITE_API_URL` should show `VITE_API_URL="https://sysndd.org"` without trailing `/api`.
  </verify>
  <done>
VITE_API_URL in production environment set to base URL without /api suffix.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify API URL construction is correct</name>
  <files>app/src/composables/useTableMethods.js</files>
  <action>
Verify that API calls in the codebase will now produce correct URLs.

**Check pattern in useTableMethods.js:**
Line ~150: `const apiUrl = \`${import.meta.env.VITE_API_URL}/api/${options.apiEndpoint}?${urlParam}\`;`

With VITE_API_URL="http://localhost:7778", this will produce:
`http://localhost:7778/api/entity?...` (correct)

**Do not modify** the source files - they are correct. The issue was the environment variable.

**Verify other patterns match:**
- url_constants.ts: `API_URL: import.meta.env.VITE_API_URL` - will be base URL
- apiService.ts: `${URLS.API_URL}/statistics/...` - expects base URL, gets it

**Note:** apiService.ts doesn't use `/api/` prefix, so check if statistics endpoints work differently.

Looking at apiService.ts:
```typescript
const url = `${URLS.API_URL}/statistics/category_count?type=${type}`;
```

This means apiService expects VITE_API_URL to include `/api` but other code expects it to NOT include `/api`.

**Resolution:** Check if the backend has `/api/statistics/` or just `/statistics/` endpoints.

If apiService.ts calls are broken after the fix, update apiService.ts to include `/api/`:
```typescript
const url = `${URLS.API_URL}/api/statistics/category_count?type=${type}`;
```
  </action>
  <verify>
1. Start dev server: `cd app && npm run dev`
2. Open browser to http://localhost:5173/Entities
3. Check Network tab - API requests should be to http://localhost:7778/api/entity (single /api/)
4. Table should load data without 404 errors
  </verify>
  <done>
API URL construction verified - single /api/ prefix in all requests, tables load data.
  </done>
</task>

<task type="auto">
  <name>Task 4: Fix apiService.ts if needed</name>
  <files>app/src/assets/js/services/apiService.ts</files>
  <action>
**Conditional task:** Only execute if apiService.ts calls fail after environment fix.

The apiService.ts uses URLS.API_URL directly without `/api/` prefix:
```typescript
const url = `${URLS.API_URL}/statistics/category_count?type=${type}`;
```

If this is producing `http://localhost:7778/statistics/...` (missing /api/), update to:
```typescript
const url = `${URLS.API_URL}/api/statistics/category_count?type=${type}`;
```

Apply same fix to all three methods:
- fetchStatistics()
- fetchNews()
- fetchSearchInfo()

**Only apply if verification in Task 3 shows apiService calls returning 404.**
  </action>
  <verify>
1. Home page loads statistics correctly (category counts)
2. News items load on home page
3. Search functionality works
  </verify>
  <done>
apiService.ts API calls work correctly with base URL configuration.
  </done>
</task>

</tasks>

<verification>
- [ ] `app/.env.development` has `VITE_API_URL="http://localhost:7778"`
- [ ] `app/.env.production` has `VITE_API_URL="https://sysndd.org"`
- [ ] Tables load data (no 404 errors for /api/api/)
- [ ] Statistics load on home page
- [ ] Search functionality works
- [ ] Dev server console shows single /api/ prefix in API URLs
</verification>

<success_criteria>
- All API requests use correct single /api/ prefix
- Table views (TablesEntities, etc.) load data without 404 errors
- Analysis views work correctly
- No runtime regressions in API-dependent features
</success_criteria>

<output>
After completion, create `.planning/phases/14-typescript-introduction/14-10-SUMMARY.md`
</output>
