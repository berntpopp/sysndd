---
phase: 14-typescript-introduction
plan: 04
type: execute
wave: 2
depends_on: ["14-01", "14-02"]
files_modified:
  - app/src/assets/js/services/apiService.ts
  - app/src/router/index.ts
  - app/src/router/routes.ts
autonomous: true

must_haves:
  truths:
    - "API service uses typed response types"
    - "Router uses Vue Router TypeScript types"
    - "Routes have type-safe meta definitions"
    - "Existing functionality preserved"
  artifacts:
    - path: "app/src/assets/js/services/apiService.ts"
      provides: "Type-safe API service"
      contains: "Promise<"
    - path: "app/src/router/index.ts"
      provides: "Typed router configuration"
      contains: "Router"
    - path: "app/src/router/routes.ts"
      provides: "Typed route definitions"
      contains: "RouteRecordRaw"
  key_links:
    - from: "app/src/assets/js/services/apiService.ts"
      to: "app/src/types/api.ts"
      via: "type import"
      pattern: "import type.*from '@/types'"
    - from: "app/src/router/routes.ts"
      to: "vue-router"
      via: "RouteRecordRaw import"
      pattern: "import type.*RouteRecordRaw"
---

<objective>
Convert API service and router to TypeScript with proper typing

Purpose: Add type safety to the API layer (ensuring correct response handling) and router (ensuring correct route definitions and meta types). These are critical infrastructure for type-safe component development.

Output: apiService.ts with typed methods, router/index.ts and routes.ts with Vue Router types
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/14-typescript-introduction/14-CONTEXT.md
@.planning/phases/14-typescript-introduction/14-RESEARCH.md
@app/src/assets/js/services/apiService.js
@app/src/router/index.js
@app/src/router/routes.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert API service to TypeScript</name>
  <files>app/src/assets/js/services/apiService.ts</files>
  <action>
Convert apiService.js to apiService.ts:

```bash
cd app && git mv src/assets/js/services/apiService.js src/assets/js/services/apiService.ts
```

Rewrite with TypeScript types and generic fetch method:

```typescript
// apiService.ts
/**
 * A type-safe service module for making API requests.
 *
 * Provides functions to interact with various endpoints of the application's API.
 * Uses typed responses from @/types/api for compile-time safety.
 */

import axios from 'axios';
import type { AxiosResponse } from 'axios';
import type {
  StatisticsResponse,
  NewsResponse,
  SearchResponse,
  StatisticsParams,
} from '@/types';
import URLS from '@/assets/js/constants/url_constants';

/**
 * API Service class with typed methods
 */
class ApiService {
  /**
   * Fetches statistical data based on a specified type.
   * @param type - The type of statistics to fetch ('entity' | 'gene')
   * @returns Promise resolving to the statistical data
   */
  async fetchStatistics(type: StatisticsParams['type']): Promise<StatisticsResponse> {
    const url = `${URLS.API_URL}/api/statistics/category_count?type=${type}`;
    const response: AxiosResponse<StatisticsResponse> = await axios.get(url);
    return response.data;
  }

  /**
   * Fetches the latest news items.
   * @param n - The number of news items to fetch
   * @returns Promise resolving to the latest news items
   */
  async fetchNews(n: number): Promise<NewsResponse> {
    const url = `${URLS.API_URL}/api/statistics/news?n=${n}`;
    const response: AxiosResponse<NewsResponse> = await axios.get(url);
    return response.data;
  }

  /**
   * Fetches search information based on a given input.
   * @param searchInput - The input to use for the search
   * @returns Promise resolving to the search results
   */
  async fetchSearchInfo(searchInput: string): Promise<SearchResponse> {
    const url = `${URLS.API_URL}/api/search/${searchInput}?helper=true`;
    const response: AxiosResponse<SearchResponse> = await axios.get(url);
    return response.data;
  }
}

// Export singleton instance (preserves existing usage pattern)
export default new ApiService();

// Also export the class for testing/extension
export { ApiService };
```

Key changes:
- Import types from @/types
- Add return type annotations to all methods
- Add parameter type annotations
- Type axios responses with AxiosResponse<T>
- Export both instance and class
  </action>
  <verify>
```bash
test -f app/src/assets/js/services/apiService.ts && echo "File exists"
grep -c "Promise<" app/src/assets/js/services/apiService.ts
```
Should show file exists and 3+ Promise return types.
  </verify>
  <done>apiService.ts converted with typed return values and parameter types</done>
</task>

<task type="auto">
  <name>Task 2: Convert router files to TypeScript</name>
  <files>app/src/router/index.ts, app/src/router/routes.ts</files>
  <action>
Convert router/index.js to router/index.ts:

```bash
cd app && git mv src/router/index.js src/router/index.ts
```

Update with TypeScript types:

```typescript
// router/index.ts
import { createRouter, createWebHistory } from 'vue-router';
import type { Router } from 'vue-router';
import { routes } from './routes';

// Support both Vite (import.meta.env) and Vue CLI (process.env) during migration
const baseUrl: string = import.meta.env.BASE_URL;

const router: Router = createRouter({
  history: createWebHistory(baseUrl),
  routes,
});

export default router;
```

Convert router/routes.js to router/routes.ts:

```bash
cd app && git mv src/router/routes.js src/router/routes.ts
```

Update with RouteRecordRaw typing. For the routes file, the key changes are:

1. Add type import at top:
```typescript
import type { RouteRecordRaw, RouteLocationNormalized, NavigationGuardNext } from 'vue-router';
```

2. Type the routes array:
```typescript
export const routes: RouteRecordRaw[] = [
  // ... existing route definitions
];
```

3. Add module augmentation for route meta (at the end of file):
```typescript
// Module augmentation for route meta types
declare module 'vue-router' {
  interface RouteMeta {
    sitemap?: {
      priority?: number;
      changefreq?: 'always' | 'hourly' | 'daily' | 'weekly' | 'monthly' | 'yearly' | 'never';
      ignoreRoute?: boolean;
    };
    requiresAuth?: boolean;
  }
}
```

4. Type the beforeEnter guards:
```typescript
beforeEnter: (
  to: RouteLocationNormalized,
  from: RouteLocationNormalized,
  next: NavigationGuardNext
) => {
  // existing logic
}
```

IMPORTANT: Keep all existing route definitions exactly as they are. Only add type annotations - do not change route paths, names, or components.

The routes.ts file is large (~700 lines). Focus on:
- Adding the type import at top
- Typing the routes array
- Typing the beforeEnter functions
- Adding module augmentation at bottom
  </action>
  <verify>
```bash
ls app/src/router/*.ts
echo "---"
grep "RouteRecordRaw" app/src/router/routes.ts
```
Should show index.ts, routes.ts, and the RouteRecordRaw type usage.
  </verify>
  <done>router/index.ts and routes.ts converted with Vue Router TypeScript types</done>
</task>

<task type="auto">
  <name>Task 3: Verify service and router integration</name>
  <files>None (verification only)</files>
  <action>
Run type check on the converted files to verify they compile correctly:

```bash
cd app && npx vue-tsc --noEmit
```

Expected: Warnings from unconverted components (OK during migration), but NO errors from:
- apiService.ts
- router/index.ts
- router/routes.ts

If type errors occur in the converted files, fix them:

Common issues and fixes:
1. Missing type imports -> Add the import
2. Implicit any parameters -> Add type annotation
3. Module not found -> Check @/types path works

Verify the app still runs:
```bash
cd app && npm run dev -- --port 5174 &
sleep 5
curl -s http://localhost:5174 | head -10
pkill -f "vite.*5174"
```

The app should start and serve pages correctly.
  </action>
  <verify>
```bash
cd app && npx vue-tsc --noEmit 2>&1 | grep -E "(apiService|router)" | head -10
```
Should show no errors for apiService.ts or router files (or only warnings).
  </verify>
  <done>API service and router TypeScript files compile without errors; app runs correctly</done>
</task>

</tasks>

<verification>
1. All service/router files are TypeScript:
   ```bash
   ls app/src/assets/js/services/*.ts app/src/router/*.ts
   ```

2. No JavaScript files remain:
   ```bash
   ls app/src/assets/js/services/*.js 2>/dev/null || echo "Clean"
   ls app/src/router/*.js 2>/dev/null || echo "Clean"
   ```

3. Type imports present:
   ```bash
   grep "import type" app/src/assets/js/services/apiService.ts
   grep "import type" app/src/router/routes.ts
   ```

4. App runs correctly:
   ```bash
   cd app && npm run dev
   ```
   Should start on port 5173
</verification>

<success_criteria>
- apiService.ts converted with typed responses
- router/index.ts converted with Router type
- router/routes.ts converted with RouteRecordRaw type
- Route meta module augmentation added
- beforeEnter guards typed
- No .js files remain in services/ or router/
- Type check passes for converted files
- App starts and runs correctly
</success_criteria>

<output>
After completion, create `.planning/phases/14-typescript-introduction/14-04-SUMMARY.md`
</output>
