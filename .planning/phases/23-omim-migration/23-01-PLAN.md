---
phase: 23-omim-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/scripts/validate-jax-api.R
  - .planning/phases/23-omim-migration/JAX-API-VALIDATION.md
autonomous: true

must_haves:
  truths:
    - "JAX API rate limits are empirically determined"
    - "Data completeness for phenotype MIM numbers is measured"
    - "Validation results inform implementation decisions"
  artifacts:
    - path: "api/scripts/validate-jax-api.R"
      provides: "Standalone validation script for JAX API testing"
      min_lines: 80
    - path: ".planning/phases/23-omim-migration/JAX-API-VALIDATION.md"
      provides: "Documented validation results and recommendations"
      contains: "Rate Limits"
  key_links:
    - from: "api/scripts/validate-jax-api.R"
      to: "https://ontology.jax.org/api/network/annotation/OMIM:"
      via: "httr2 requests"
      pattern: "ontology\\.jax\\.org"
---

<objective>
Create a standalone validation script to empirically test JAX Ontology API rate limits and data completeness before implementing the full OMIM migration.

Purpose: JAX API has no official rate limit documentation. This validation script tests real-world behavior to inform implementation decisions and prevent failed deployments.

Output: Validation script and documented results with specific recommendations for retry parameters, request delays, and data completeness thresholds.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-omim-migration/23-CONTEXT.md
@.planning/phases/23-omim-migration/23-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JAX API Validation Script</name>
  <files>api/scripts/validate-jax-api.R</files>
  <action>
Create a standalone R script that tests JAX Ontology API behavior:

1. Add httr2 to renv if not present (renv::install("httr2"))

2. Create the validation script with these sections:

**Setup:**
- Load httr2 for HTTP requests
- Define JAX API base URL: https://ontology.jax.org/api/network/annotation/OMIM:
- Download mim2gene.txt from https://omim.org/static/omim/data/mim2gene.txt
- Parse mim2gene.txt, filter for MIM_Entry_Type == "phenotype" to get phenotype MIM numbers
- Sample 100 random phenotype MIM numbers for testing

**Rate Limit Testing:**
- Test sequential requests with increasing batch sizes: 10, 25, 50, 100
- Track response times and HTTP status codes
- Detect 429 (rate limited) responses
- Test with NO delay, 25ms delay, 50ms delay, 100ms delay between requests
- Log all request/response timing to determine optimal pattern

**Data Completeness Testing:**
- For each sampled MIM number, fetch from JAX API
- Extract disease name from response using: pluck(data, "disease", "name", .default = NA)
- Count successful retrievals vs failures (404s, empty responses, missing names)
- Calculate completeness percentage

**Output:**
- Print summary statistics to console
- Save detailed results to api/data/jax-api-validation-results.csv with columns:
  mim_number, status_code, response_time_ms, disease_name, success
- Generate recommendations for:
  - Optimal delay between requests
  - Retry count and backoff strategy
  - Expected data completeness percentage

Use this pattern for requests:
```r
fetch_with_timing <- function(mim_number) {
  url <- paste0("https://ontology.jax.org/api/network/annotation/OMIM:", mim_number)
  start <- Sys.time()

  response <- tryCatch({
    request(url) %>%
      req_timeout(30) %>%
      req_perform()
  }, error = function(e) NULL)

  elapsed_ms <- as.numeric(difftime(Sys.time(), start, units = "secs")) * 1000

  # Return timing and result data
  ...
}
```

The script should be runnable standalone: `Rscript api/scripts/validate-jax-api.R`
  </action>
  <verify>
Run the script: `cd /mnt/c/development/sysndd && Rscript api/scripts/validate-jax-api.R`
Script completes without errors and outputs validation results.
  </verify>
  <done>
- Script exists at api/scripts/validate-jax-api.R
- Script downloads mim2gene.txt and samples phenotype MIM numbers
- Script tests JAX API with multiple delay settings
- Script calculates data completeness percentage
- Results saved to api/data/jax-api-validation-results.csv
  </done>
</task>

<task type="auto">
  <name>Task 2: Document Validation Results</name>
  <files>.planning/phases/23-omim-migration/JAX-API-VALIDATION.md</files>
  <action>
After running the validation script, document the findings in JAX-API-VALIDATION.md:

1. **Rate Limits**
   - Observed limits (requests/second that cause 429)
   - Optimal delay between requests
   - Recommended retry strategy (max_tries, backoff formula)

2. **Data Completeness**
   - Total phenotype MIM numbers in mim2gene.txt
   - Number tested in validation
   - Success rate (% with disease names)
   - Common failure patterns (404, empty response, missing field)

3. **Recommendations**
   - Final request delay setting
   - Retry parameters: max_tries=5, backoff=2^x, max_seconds=120
   - Data completeness threshold (if <95%, investigate further)
   - Whether to abort on any missing name or allow partial failures

4. **Implementation Decisions**
   - Based on results, document:
     - Final httr2::req_retry() parameters to use
     - Delay between batch requests (Sys.sleep value)
     - Validation strictness (abort vs warn on missing names)

Format as markdown with clear sections and code snippets for recommended settings.
  </action>
  <verify>
File exists and contains: Rate Limits, Data Completeness, Recommendations, Implementation Decisions sections.
  </verify>
  <done>
- JAX-API-VALIDATION.md exists with documented findings
- Specific parameter recommendations provided
- Implementation decisions recorded for Plan 02 to use
  </done>
</task>

</tasks>

<verification>
1. Validation script runs without errors
2. CSV results file contains timing and completeness data
3. Documentation provides clear implementation guidance
4. Recommendations are specific (actual numbers, not ranges)
</verification>

<success_criteria>
- JAX API behavior empirically documented (not assumed)
- Data completeness percentage known
- Implementation parameters decided (delay, retry, validation strictness)
- Plan 02 can proceed with confidence
</success_criteria>

<output>
After completion, create `.planning/phases/23-omim-migration/23-01-SUMMARY.md`
</output>
