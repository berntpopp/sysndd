---
phase: 23-omim-migration
plan: 03
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - api/functions/mondo-functions.R
  - api/data/mondo_mappings/.gitkeep
  - api/tests/testthat/test-unit-mondo-functions.R
autonomous: true

must_haves:
  truths:
    - "MONDO SSSOM mappings can be downloaded"
    - "SSSOM file parses to MONDO-to-OMIM mapping tibble"
    - "Multiple OMIM IDs per MONDO are handled (semicolon-separated)"
    - "Mapping data integrates with disease_ontology_set"
  artifacts:
    - path: "api/functions/mondo-functions.R"
      provides: "MONDO SSSOM mapping functions"
      exports: ["download_mondo_sssom", "parse_mondo_sssom", "get_mondo_for_omim"]
      min_lines: 80
    - path: "api/tests/testthat/test-unit-mondo-functions.R"
      provides: "Unit tests for MONDO functions"
      min_lines: 40
  key_links:
    - from: "api/functions/mondo-functions.R"
      to: "https://github.com/monarch-initiative/mondo"
      via: "httr2 download of SSSOM file"
      pattern: "mondo.*sssom"
---

<objective>
Create MONDO mapping functions to download and parse SSSOM files, providing MONDO-to-OMIM equivalence mappings for the curation interface.

Purpose: MONDO equivalence enhances the curation interface by showing curators suggested MONDO matches for OMIM diseases. Per CONTEXT.md, these mappings are fetched as part of the OMIM update job.

Output: api/functions/mondo-functions.R with functions to download SSSOM files and create MONDO-OMIM mapping tables.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-omim-migration/23-CONTEXT.md
@.planning/phases/23-omim-migration/23-RESEARCH.md
@api/functions/file-functions.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MONDO Functions Module</name>
  <files>api/functions/mondo-functions.R</files>
  <action>
Create api/functions/mondo-functions.R with these functions:

**1. download_mondo_sssom(output_path = "data/mondo_mappings/", force = FALSE)**
- Create output directory if not exists
- Check if recent SSSOM file exists using check_file_age() (cache 30 days)
- If not recent or force=TRUE, download from:
  https://github.com/monarch-initiative/mondo/raw/master/src/ontology/mappings/mondo_exactmatch_omim.sssom.tsv
  (or fallback to mondo-omim.sssom.tsv)
- Use httr2::request() with req_retry(max_tries=3)
- Save as data/mondo_mappings/mondo-omim.{date}.sssom.tsv
- Return path to file

**2. parse_mondo_sssom(file_path)**
- Read TSV file using readr::read_tsv() with comment="#" (SSSOM has metadata comments)
- Expected columns: subject_id, predicate_id, object_id, mapping_justification
- Filter for: str_detect(subject_id, "^MONDO:") AND str_detect(object_id, "^OMIM:")
- Return tibble with: mondo_id (subject_id), omim_id (object_id)
- Handle duplicates - some OMIM IDs map to multiple MONDO IDs

**3. get_mondo_for_omim(omim_id, mondo_mappings)**
- Look up omim_id in mondo_mappings tibble
- Return all matching MONDO IDs (may be multiple)
- If no match found, return NA_character_
- Format: "MONDO:0000123;MONDO:0000456" for multiple matches

**4. add_mondo_mappings_to_ontology(disease_ontology_set, mondo_mappings)**
- For each row in disease_ontology_set where disease_ontology_source == "mim2gene"
- Look up MONDO equivalent using disease_ontology_id
- Add MONDO column with mapping (NA if none found)
- Return updated disease_ontology_set

Include roxygen2 documentation for all functions.

Reference existing pattern from ontology-functions.R get_mondo_mappings() (lines 175-208) for how MONDO data is structured in this codebase.

Note: SSSOM (Simple Standard for Sharing Ontology Mappings) is a W3C standard format.
The mapping file uses: subject_id=MONDO, object_id=OMIM for exactMatch predicates.
  </action>
  <verify>
Source the file in R and check functions exist:
```r
source("api/functions/mondo-functions.R")
ls(pattern = "mondo|sssom")
```
  </verify>
  <done>
- mondo-functions.R exists with all 4 functions
- Functions have roxygen2 documentation
- SSSOM parsing handles comment lines correctly
- Multiple mappings are handled (semicolon-separated)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Directory and Unit Tests</name>
  <files>api/data/mondo_mappings/.gitkeep, api/tests/testthat/test-unit-mondo-functions.R</files>
  <action>
1. Create the mondo_mappings directory with .gitkeep:
   - mkdir -p api/data/mondo_mappings
   - touch api/data/mondo_mappings/.gitkeep

2. Create unit tests for MONDO functions:

**Test parse_mondo_sssom:**
- Create mock SSSOM data as temp file (with comment lines and data rows)
- Test that comments (# lines) are ignored
- Test MONDO and OMIM filtering works
- Test duplicate handling

**Test get_mondo_for_omim:**
- Test single match returns single ID
- Test multiple matches returns semicolon-separated IDs
- Test no match returns NA

**Test add_mondo_mappings_to_ontology:**
- Test MONDO column is added
- Test only mim2gene entries get mappings (not mondo entries)
- Test NA for unmapped OMIM IDs

Mock SSSOM format example:
```
# curie_map:
#   MONDO: http://purl.obolibrary.org/obo/MONDO_
#   OMIM: https://omim.org/entry/
subject_id	predicate_id	object_id	mapping_justification
MONDO:0000001	skos:exactMatch	OMIM:100100	semapv:LexicalMatching
MONDO:0000002	skos:exactMatch	OMIM:100200	semapv:LexicalMatching
```
  </action>
  <verify>
1. Directory exists: ls api/data/mondo_mappings/
2. Run tests: `cd /mnt/c/development/sysndd/api && Rscript -e "testthat::test_file('tests/testthat/test-unit-mondo-functions.R')"`
All tests pass.
  </verify>
  <done>
- api/data/mondo_mappings/ directory exists
- Unit tests exist and pass
- Tests cover parsing, lookup, and integration functions
  </done>
</task>

</tasks>

<verification>
1. `source("api/functions/mondo-functions.R")` succeeds without errors
2. All exported functions exist and have documentation
3. Unit tests pass
4. SSSOM comment lines are properly ignored
5. Multiple mappings handled correctly
</verification>

<success_criteria>
- MONDO functions module complete with SSSOM parsing
- Mappings integrate with disease_ontology_set structure
- MONDO equivalence available for curation interface (MONDO-02)
- Unit tests verify transformation logic
</success_criteria>

<output>
After completion, create `.planning/phases/23-omim-migration/23-03-SUMMARY.md`
</output>
