---
phase: 23-omim-migration
plan: 05
type: execute
wave: 4
depends_on: ["23-04"]
files_modified:
  - app/src/views/admin/ManageAnnotations.vue
  - app/src/views/EntityInfo.vue
autonomous: false

must_haves:
  truths:
    - "ManageAnnotations polls job status after triggering update"
    - "Progress steps displayed during update"
    - "Success/failure shown when job completes"
    - "MONDO equivalence visible in entity views"
  artifacts:
    - path: "app/src/views/admin/ManageAnnotations.vue"
      provides: "Async polling UI for ontology updates"
      min_lines: 150
    - path: "app/src/views/EntityInfo.vue"
      provides: "MONDO equivalence display"
      contains: "MONDO"
  key_links:
    - from: "app/src/views/admin/ManageAnnotations.vue"
      to: "/api/jobs/"
      via: "axios polling"
      pattern: "api/jobs"
---

<objective>
Update the frontend to support async OMIM updates with job polling and display MONDO equivalence in entity views.

Purpose: Completes the user-facing changes for the OMIM migration. ManageAnnotations needs to poll for job status instead of waiting synchronously. Entity views show MONDO equivalence for curator reference.

Output: Updated Vue components with async job handling and MONDO display.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-omim-migration/23-CONTEXT.md
@.planning/phases/23-omim-migration/23-04-SUMMARY.md
@app/src/views/admin/ManageAnnotations.vue
@app/src/views/EntityInfo.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ManageAnnotations for Async Polling</name>
  <files>app/src/views/admin/ManageAnnotations.vue</files>
  <action>
Update ManageAnnotations.vue to handle async job responses:

**1. Add new data properties:**
```javascript
data() {
  return {
    loading: false,
    loadingHgnc: false,
    // New async state
    jobId: null,
    jobStatus: null,
    jobStep: '',
    pollInterval: null,
  };
},
```

**2. Replace updateOntologyAnnotations method:**

```javascript
async updateOntologyAnnotations() {
  this.loading = true;
  this.jobStatus = null;
  this.jobStep = 'Starting update...';

  try {
    // Call async endpoint
    const response = await this.axios.put(
      `${import.meta.env.VITE_API_URL}/api/admin/update_ontology_async`,
      {},
      {
        headers: {
          Authorization: `Bearer ${localStorage.getItem('token')}`,
        },
      }
    );

    if (response.data.error) {
      this.makeToast(response.data.message || 'Failed to start update', 'Error', 'danger');
      this.loading = false;
      return;
    }

    this.jobId = response.data.job_id;
    this.jobStatus = 'accepted';
    this.jobStep = 'Job submitted, starting...';

    // Start polling
    this.startPolling();
  } catch (error) {
    this.makeToast('Failed to start ontology update', 'Error', 'danger');
    this.loading = false;
  }
},
```

**3. Add polling methods:**

```javascript
startPolling() {
  // Poll every 3 seconds
  this.pollInterval = setInterval(async () => {
    await this.checkJobStatus();
  }, 3000);
},

stopPolling() {
  if (this.pollInterval) {
    clearInterval(this.pollInterval);
    this.pollInterval = null;
  }
},

async checkJobStatus() {
  if (!this.jobId) return;

  try {
    const response = await this.axios.get(
      `${import.meta.env.VITE_API_URL}/api/jobs/${this.jobId}`,
      {
        headers: {
          Authorization: `Bearer ${localStorage.getItem('token')}`,
        },
      }
    );

    const data = response.data;

    if (data.error === 'JOB_NOT_FOUND') {
      this.stopPolling();
      this.makeToast('Job not found', 'Error', 'danger');
      this.loading = false;
      return;
    }

    this.jobStatus = data.status;
    this.jobStep = data.step || this.jobStep;

    if (data.status === 'completed') {
      this.stopPolling();
      this.loading = false;
      this.makeToast('Ontology annotations updated successfully', 'Success', 'success');
    } else if (data.status === 'failed') {
      this.stopPolling();
      this.loading = false;
      const errorMsg = data.error?.message || 'Update failed';
      this.makeToast(errorMsg, 'Error', 'danger');
    }
    // If still running, polling continues
  } catch (error) {
    this.stopPolling();
    this.loading = false;
    this.makeToast('Failed to check job status', 'Error', 'danger');
  }
},
```

**4. Add beforeUnmount hook:**
```javascript
beforeUnmount() {
  this.stopPolling();
},
```

**5. Update template to show progress:**

Replace the simple loading spinner with progress display:
```vue
<BButton
  variant="primary"
  :disabled="loading"
  @click="updateOntologyAnnotations"
>
  <BSpinner
    v-if="loading"
    small
    type="grow"
  />
  {{ loading ? jobStep : 'Update Ontology Annotations' }}
</BButton>

<div v-if="jobStatus" class="mt-2 small text-muted">
  Status: {{ jobStatus }}
  <span v-if="jobStep"> - {{ jobStep }}</span>
</div>
```
  </action>
  <verify>
1. Run frontend: `cd /mnt/c/development/sysndd/app && npm run serve`
2. Navigate to ManageAnnotations page
3. Click update button - should show progress and poll status
  </verify>
  <done>
- ManageAnnotations calls PUT /admin/update_ontology_async
- Polling implemented with 3-second interval
- Progress step displayed during update
- Success/failure toasts on completion
  </done>
</task>

<task type="auto">
  <name>Task 2: Add MONDO Display to Entity Views</name>
  <files>app/src/views/EntityInfo.vue</files>
  <action>
Add MONDO equivalence display to EntityInfo.vue:

**1. Find where disease_ontology_name is displayed** (in the entity info section)

**2. Add MONDO equivalence below it:**

Look for the disease ontology display (likely in a card or info section) and add:

```vue
<!-- After disease_ontology_name display -->
<BRow v-if="entity.MONDO">
  <BCol cols="4" class="text-muted">MONDO Equivalent:</BCol>
  <BCol cols="8">
    <template v-if="entity.MONDO.includes(';')">
      <!-- Multiple MONDO mappings -->
      <span
        v-for="(mondoId, index) in entity.MONDO.split(';')"
        :key="mondoId"
      >
        <a
          :href="`https://monarchinitiative.org/disease/${mondoId}`"
          target="_blank"
          rel="noopener"
        >
          {{ mondoId }}
        </a>
        <span v-if="index < entity.MONDO.split(';').length - 1">, </span>
      </span>
    </template>
    <template v-else>
      <a
        :href="`https://monarchinitiative.org/disease/${entity.MONDO}`"
        target="_blank"
        rel="noopener"
      >
        {{ entity.MONDO }}
      </a>
    </template>
  </BCol>
</BRow>
<BRow v-else-if="entity.disease_ontology_source === 'mim2gene'">
  <BCol cols="4" class="text-muted">MONDO Equivalent:</BCol>
  <BCol cols="8" class="text-muted fst-italic">No mapping available</BCol>
</BRow>
```

**3. Per CONTEXT.md:** Show empty if no MONDO equivalent (no special flagging).

The API response for entity should include MONDO field from disease_ontology_set join.
If MONDO is not in the API response, check the entity endpoint to ensure it joins with disease_ontology_set.MONDO column.
  </action>
  <verify>
1. View an entity page with known OMIM disease
2. Verify MONDO equivalent is displayed (or "No mapping available")
3. Click MONDO link - should open Monarch Initiative page
  </verify>
  <done>
- MONDO equivalence displayed in EntityInfo.vue
- Links to Monarch Initiative for MONDO IDs
- Empty state shown when no mapping exists
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    - ManageAnnotations async polling for OMIM update job
    - MONDO equivalence display in entity views
    - Full OMIM migration from genemap2 to mim2gene + JAX API
  </what-built>
  <how-to-verify>
    1. Start API: `cd /mnt/c/development/sysndd/api && Rscript start_sysndd_api.R`
    2. Start frontend: `cd /mnt/c/development/sysndd/app && npm run serve`
    3. Login as Administrator
    4. Navigate to ManageAnnotations
    5. Click "Update Ontology Annotations"
    6. Verify:
       - Button shows progress text (not just "Updating...")
       - Status updates every few seconds
       - Eventually shows success toast
    7. Navigate to any entity page with OMIM disease
    8. Verify MONDO equivalence section is visible
  </how-to-verify>
  <resume-signal>Type "approved" to confirm the OMIM migration works end-to-end, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. ManageAnnotations triggers async job and polls correctly
2. Progress steps visible during update
3. Success/failure properly reported
4. MONDO equivalence visible in entity views
5. All OMIM requirements (01-06) satisfied
6. MONDO requirements (01-03) satisfied
</verification>

<success_criteria>
- OMIM-05: ManageAnnotations view updated for new data sources
- OMIM-06: Fallback documented (show empty for missing MONDO)
- MONDO-02: Curation interface shows MONDO equivalents
- MONDO-03: Existing MONDO integration preserved
- End-to-end OMIM update works with new data sources
</success_criteria>

<output>
After completion, create `.planning/phases/23-omim-migration/23-05-SUMMARY.md`
</output>
