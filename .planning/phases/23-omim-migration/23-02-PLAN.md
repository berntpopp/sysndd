---
phase: 23-omim-migration
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - api/functions/omim-functions.R
  - api/tests/testthat/test-unit-omim-functions.R
autonomous: true

must_haves:
  truths:
    - "mim2gene.txt can be downloaded and parsed"
    - "Entry types (gene, phenotype, moved/removed) are preserved"
    - "JAX API disease names can be fetched with retry logic"
    - "Data validation catches missing required fields"
    - "Moved/removed entries flagged for deprecation workflow"
    - "Progress callback works during batch operations"
  artifacts:
    - path: "api/functions/omim-functions.R"
      provides: "OMIM data processing functions"
      exports: ["download_mim2gene", "parse_mim2gene", "fetch_jax_disease_name", "fetch_all_disease_names", "validate_omim_data", "get_deprecated_mim_numbers", "check_entities_for_deprecation", "build_omim_ontology_set"]
      min_lines: 200
    - path: "api/tests/testthat/test-unit-omim-functions.R"
      provides: "Unit tests for OMIM functions"
      min_lines: 50
  key_links:
    - from: "api/functions/omim-functions.R"
      to: "https://omim.org/static/omim/data/mim2gene.txt"
      via: "httr2 download"
      pattern: "omim\\.org.*mim2gene"
    - from: "api/functions/omim-functions.R"
      to: "https://ontology.jax.org/api/network/annotation/OMIM:"
      via: "httr2 with req_retry"
      pattern: "ontology\\.jax\\.org"
---

<objective>
Create the core OMIM functions module with mim2gene.txt parsing, JAX API integration for disease names, and comprehensive data validation.

Purpose: These functions replace the genemap2.txt-based approach with the new mim2gene.txt + JAX API data sources. They form the foundation for the async OMIM update job.

Output: api/functions/omim-functions.R with tested functions for downloading, parsing, fetching, and validating OMIM data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-omim-migration/23-CONTEXT.md
@.planning/phases/23-omim-migration/23-RESEARCH.md
@.planning/phases/23-omim-migration/23-01-SUMMARY.md
@api/functions/file-functions.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OMIM Functions Module</name>
  <files>api/functions/omim-functions.R</files>
  <action>
Create api/functions/omim-functions.R with these functions:

**1. download_mim2gene(output_path = "data/", force = FALSE)**
- Check if recent mim2gene file exists using check_file_age() from file-functions.R
- If not recent or force=TRUE, download from https://omim.org/static/omim/data/mim2gene.txt
- Use httr2::request() with req_retry(max_tries=3)
- Save as data/mim2gene.{date}.txt
- Return path to file

**2. parse_mim2gene(file_path, include_moved_removed = TRUE)**
- Read tab-delimited file with columns: MIM_Number, MIM_Entry_Type, Entrez_Gene_ID, Approved_Gene_Symbol_HGNC, Ensembl_Gene_ID
- **Preserve mim_entry_type column** for deprecation workflow
- Filter for MIM_Entry_Type == "phenotype" (these are disease entries)
- If include_moved_removed=TRUE, also include "moved/removed" entries (for deprecation detection)
- Return tibble with: mim_number, mim_entry_type, gene_symbol (Approved_Gene_Symbol_HGNC), is_deprecated (TRUE if moved/removed)
- Note: phenotype entries may have NA gene_symbol - this is expected
- Note: moved/removed entries should be flagged for re-review workflow

**3. fetch_jax_disease_name(mim_number)**
- Use parameters from JAX-API-VALIDATION.md (max_tries, backoff, delay)
- Make request to https://ontology.jax.org/api/network/annotation/OMIM:{mim_number}
- Extract disease name using purrr::pluck(data, "disease", "name", .default = NA_character_)
- Return disease name or NA_character_ on failure
- Log warnings for failures (not errors - don't stop batch)

**4. fetch_all_disease_names(mim_numbers, progress_callback = NULL)**
- Iterate over mim_numbers vector
- Call fetch_jax_disease_name for each
- Call progress_callback(step="Fetching disease names", current=i, total=n) if provided
- Add delay between requests (value from validation)
- Return tibble: mim_number, disease_name

**5. validate_omim_data(omim_data)**
- Check required fields: disease_ontology_id, hgnc_id, disease_ontology_name
- Count and list entries with missing values
- Check for duplicates in disease_ontology_id_version
- Return list(valid=TRUE/FALSE, errors=list(), message=string)
- Per CONTEXT.md: abort if ANY entry fails validation

**6. get_deprecated_mim_numbers(mim2gene_data)**
- Filter for mim_entry_type == "moved/removed"
- Return vector of deprecated MIM numbers (1,383 as of 2026-01-24)
- Used by ontology update to flag entities for re-review

**7. check_entities_for_deprecation(pool, deprecated_mim_numbers)**
- Query disease_ontology_set for any entries matching deprecated MIM numbers
- Return tibble of affected entities with: entity_id, disease_ontology_id, current status
- These entities should be flagged for curator review with MONDO replacement suggestions

**8. build_omim_ontology_set(mim2gene_data, disease_names, hgnc_list, moi_list)**
- Join mim2gene data with fetched disease names
- Match gene symbols to HGNC IDs using hgnc_list
- Map inheritance modes using moi_list
- Create disease_ontology_id_version (OMIM:{mim_number} or OMIM:{mim_number}_{version} for duplicates)
- Return tibble matching disease_ontology_set schema:
  disease_ontology_id_version, disease_ontology_id, disease_ontology_name,
  disease_ontology_source="mim2gene", disease_ontology_date, disease_ontology_is_specific=TRUE,
  hgnc_id, hpo_mode_of_inheritance_term

Include roxygen2 documentation for all functions.

Use this retry configuration (adjust based on 23-01 validation results):
```r
request(url) %>%
  req_retry(
    max_tries = 5,
    max_seconds = 120,
    backoff = ~ 2^.x,
    is_transient = ~ resp_status(.x) %in% c(429, 503, 504)
  ) %>%
  req_timeout(30)
```
  </action>
  <verify>
Source the file in R and check functions exist:
```r
source("api/functions/omim-functions.R")
ls(pattern = "omim|mim2gene|jax|validate")
```
  </verify>
  <done>
- omim-functions.R exists with all 8 functions
- Functions have roxygen2 documentation
- httr2 retry logic uses validated parameters
- Validation function aborts on any missing required field
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Unit Tests for OMIM Functions</name>
  <files>api/tests/testthat/test-unit-omim-functions.R</files>
  <action>
Create unit tests for the OMIM functions module:

**Test parse_mim2gene:**
- Create mock mim2gene data as temp file
- Test filtering for phenotype entries only
- Test handling of NA gene symbols

**Test validate_omim_data:**
- Test valid data returns valid=TRUE
- Test missing disease_ontology_id returns valid=FALSE with specific error
- Test missing disease_ontology_name returns valid=FALSE with MIM numbers listed
- Test duplicate detection

**Test build_omim_ontology_set:**
- Test disease_ontology_id_version creation (no version suffix for unique, _1, _2 for duplicates)
- Test source is set to "mim2gene"
- Test required columns are present

**Test get_deprecated_mim_numbers:**
- Test filtering for moved/removed entries
- Test returns vector of MIM numbers

Note: Do NOT test fetch_jax_disease_name with live API in unit tests.
The httptest package could be used for mocking, but for simplicity,
focus on the data transformation logic that doesn't require network calls.

Use existing test patterns from api/tests/testthat/test-unit-ontology-functions.R as reference.
  </action>
  <verify>
Run tests: `cd /mnt/c/development/sysndd/api && Rscript -e "testthat::test_file('tests/testthat/test-unit-omim-functions.R')"`
All tests pass.
  </verify>
  <done>
- Test file exists at api/tests/testthat/test-unit-omim-functions.R
- Tests cover parse_mim2gene, validate_omim_data, build_omim_ontology_set
- All tests pass
  </done>
</task>

</tasks>

<verification>
1. `source("api/functions/omim-functions.R")` succeeds without errors
2. All exported functions exist and have documentation
3. Unit tests pass
4. validate_omim_data correctly rejects data with missing required fields
</verification>

<success_criteria>
- OMIM functions module complete with mim2gene parsing
- Entry types preserved for deprecation detection (moved/removed)
- JAX API integration with validated retry parameters
- Strict validation that aborts on any missing field (per CONTEXT.md)
- Deprecation functions identify entities using obsolete OMIM IDs
- Unit tests verify core transformation logic
</success_criteria>

<output>
After completion, create `.planning/phases/23-omim-migration/23-02-SUMMARY.md`
</output>
