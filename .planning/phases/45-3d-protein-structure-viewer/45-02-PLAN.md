---
phase: 45-3d-protein-structure-viewer
plan: 02
type: execute
wave: 2
depends_on: ["45-01"]
files_modified:
  - app/src/components/gene/ProteinStructure3D.vue
  - app/src/components/gene/VariantPanel.vue
autonomous: true

must_haves:
  truths:
    - "ProteinStructure3D component renders NGL viewer with pLDDT confidence coloring in a 500px container"
    - "Toolbar provides cartoon, surface, and ball+stick toggle buttons with active state highlighting"
    - "Reset View button returns structure to default orientation"
    - "pLDDT legend displays the four confidence ranges with colored indicators"
    - "Loading state shows centered spinner with Loading 3D structure text"
    - "Empty state shows No AlphaFold structure available message when no structure URL provided"
    - "Error state shows failure message with retry option"
    - "VariantPanel lists ClinVar variants with ACMG-colored badges and multi-select checkboxes"
    - "Checking a variant checkbox highlights the residue as a spacefill sphere on the 3D structure"
    - "Unchecking removes the variant marker from the structure"
    - "Keyboard-accessible controls have aria-labels and keyboard event handlers"
  artifacts:
    - path: "app/src/components/gene/ProteinStructure3D.vue"
      provides: "3D protein structure viewer with NGL integration, toolbar, legend, and states"
    - path: "app/src/components/gene/VariantPanel.vue"
      provides: "ClinVar variant selection panel with multi-select checkboxes and ACMG coloring"
  key_links:
    - from: "app/src/components/gene/ProteinStructure3D.vue"
      to: "app/src/composables/use3DStructure.ts"
      via: "composable import"
      pattern: "use3DStructure"
    - from: "app/src/components/gene/ProteinStructure3D.vue"
      to: "app/src/types/alphafold.ts"
      via: "import type and constants"
      pattern: "PLDDT_LEGEND|RepresentationType|ACMG_COLORS"
    - from: "app/src/components/gene/VariantPanel.vue"
      to: "app/src/types/external.ts"
      via: "import type"
      pattern: "ClinVarVariant"
    - from: "app/src/components/gene/VariantPanel.vue"
      to: "app/src/types/alphafold.ts"
      via: "import constants"
      pattern: "ACMG_COLORS|parseResidueNumber|classifyClinicalSignificance"
---

<objective>
Create the ProteinStructure3D viewer component with representation toolbar, pLDDT legend, loading/error/empty states, and the VariantPanel sidebar component with multi-select ClinVar variant highlighting.

Purpose: These two components deliver the visual UI for the 3D structure viewer. ProteinStructure3D wraps the use3DStructure composable into a Vue component with all viewer chrome (toolbar, legend, states). VariantPanel provides the variant selection interface that drives spatial highlighting on the 3D structure. Together they form the "3D Structure" tab content in the gene visualization card.

Output: `app/src/components/gene/ProteinStructure3D.vue`, `app/src/components/gene/VariantPanel.vue`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-3d-protein-structure-viewer/45-CONTEXT.md
@.planning/phases/45-3d-protein-structure-viewer/45-RESEARCH.md
@.planning/phases/45-3d-protein-structure-viewer/45-01-SUMMARY.md

Key references:
@app/src/composables/use3DStructure.ts (composable API from Plan 01)
@app/src/types/alphafold.ts (types and constants from Plan 01)
@app/src/types/external.ts (ClinVarVariant interface)
@app/src/components/gene/GeneClinVarCard.vue (ACMG badge styling pattern, card styling pattern)
@app/src/components/gene/GeneConstraintCard.vue (loading/error/empty state pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProteinStructure3D component with viewer, toolbar, legend, and states</name>
  <files>app/src/components/gene/ProteinStructure3D.vue</files>
  <action>
Create `app/src/components/gene/ProteinStructure3D.vue` as a Vue 3 SFC with `<script setup lang="ts">`:

**Props interface:**
```typescript
interface Props {
  geneSymbol: string;
  structureUrl: string | null;  // AlphaFold PDB/CIF URL (null = no structure)
  variants: ClinVarVariant[];   // ClinVar variants for variant panel
}
```

**Emits:** None (self-contained component).

**Template structure (left-to-right layout: 70% viewer + 30% variant panel):**

```html
<div class="protein-structure-3d" role="region" aria-label="3D protein structure viewer">

  <!-- Loading State (before structure loads) -->
  <div v-if="isLoading" class="state-overlay">
    <BSpinner label="Loading 3D structure..." />
    <p class="text-muted mt-2 small">Loading 3D structure...</p>
  </div>

  <!-- Error State -->
  <div v-else-if="viewerError" class="state-overlay" role="alert">
    <i class="bi bi-exclamation-triangle text-warning fs-3"></i>
    <p class="text-muted mt-2 small">{{ viewerError }}</p>
    <BButton variant="outline-primary" size="sm" @click="retryLoad">Retry</BButton>
  </div>

  <!-- Empty State (no AlphaFold structure, STRUCT3D-07) -->
  <div v-else-if="!structureUrl" class="state-overlay">
    <i class="bi bi-box text-muted fs-3"></i>
    <p class="text-muted mt-2 small">
      No AlphaFold structure available for {{ geneSymbol }}
    </p>
  </div>

  <!-- Active Viewer Layout (70% viewer + 30% variant panel) -->
  <div v-show="isInitialized && !isLoading && structureUrl" class="viewer-layout">

    <!-- Left: NGL Viewer (70%) -->
    <div class="viewer-section">
      <!-- Controls Toolbar (STRUCT3D-02, STRUCT3D-06, A11Y-04) -->
      <div class="controls-toolbar" role="toolbar" aria-label="3D viewer controls">
        <BButtonGroup size="sm">
          <BButton
            v-for="repr in representationOptions"
            :key="repr.value"
            :variant="activeRepresentation === repr.value ? 'primary' : 'outline-secondary'"
            :aria-pressed="activeRepresentation === repr.value"
            :aria-label="`Show ${repr.label} representation`"
            @click="handleSetRepresentation(repr.value)"
            @keydown.enter="handleSetRepresentation(repr.value)"
          >
            {{ repr.label }}
          </BButton>
        </BButtonGroup>

        <BButton
          variant="outline-secondary"
          size="sm"
          aria-label="Reset view to default orientation"
          @click="resetView"
          @keydown.enter="resetView"
        >
          <i class="bi bi-arrow-clockwise"></i> Reset View
        </BButton>
      </div>

      <!-- NGL Viewport Container -->
      <div ref="viewerContainer" class="ngl-viewport" tabindex="0" aria-label="3D protein structure - use mouse to rotate, scroll to zoom" />

      <!-- pLDDT Legend (STRUCT3D-01) -->
      <div class="plddt-legend" aria-label="pLDDT confidence color legend">
        <span class="legend-title">pLDDT:</span>
        <span
          v-for="item in PLDDT_LEGEND"
          :key="item.label"
          class="legend-item"
        >
          <span class="legend-color" :style="{ backgroundColor: item.color }" :aria-hidden="true"></span>
          <span class="small">{{ item.label }}</span>
        </span>
      </div>
    </div>

    <!-- Right: Variant Panel (30%, STRUCT3D-04) -->
    <div class="variant-section">
      <VariantPanel
        :variants="variants"
        @toggle-variant="handleToggleVariant"
        @clear-all="handleClearVariants"
      />
    </div>
  </div>
</div>
```

**Script setup:**

```typescript
import { ref, watch, onMounted } from 'vue';
import { BSpinner, BButton, BButtonGroup } from 'bootstrap-vue-next';
import { use3DStructure } from '@/composables/use3DStructure';
import VariantPanel from './VariantPanel.vue';
import { PLDDT_LEGEND, ACMG_COLORS, classifyClinicalSignificance, parseResidueNumber } from '@/types/alphafold';
import type { RepresentationType } from '@/types/alphafold';
import type { ClinVarVariant } from '@/types/external';

const props = defineProps<Props>();

const viewerContainer = ref<HTMLElement | null>(null);

// Use the 3D structure composable
const {
  isInitialized,
  isLoading,
  error: composableError,
  activeRepresentation,
  loadStructure,
  addVariantMarker,
  removeVariantMarker,
  clearAllVariantMarkers,
  setRepresentation,
  resetView,
} = use3DStructure(viewerContainer);

// Local error state (combines composable error with component-level errors)
const viewerError = ref<string | null>(null);

// Representation toggle options
const representationOptions: { value: RepresentationType; label: string }[] = [
  { value: 'cartoon', label: 'Cartoon' },
  { value: 'surface', label: 'Surface' },
  { value: 'ball+stick', label: 'Ball+Stick' },
];

// Sync composable error to local error
watch(composableError, (val) => { viewerError.value = val; });

// Load structure when initialized and URL available
watch([isInitialized, () => props.structureUrl], async ([initialized, url]) => {
  if (initialized && url) {
    try {
      await loadStructure(url);
      viewerError.value = null;
    } catch {
      viewerError.value = 'Failed to load 3D structure. Please try again.';
    }
  }
});

// Representation toggle handler
function handleSetRepresentation(type: RepresentationType): void {
  setRepresentation(type);
}

// Variant toggle handler (called from VariantPanel)
function handleToggleVariant(payload: { variant: ClinVarVariant; selected: boolean }): void {
  const residue = parseResidueNumber(payload.variant.hgvsp);
  if (residue === null) return; // Skip variants without parseable position

  if (payload.selected) {
    const classification = classifyClinicalSignificance(payload.variant.clinical_significance);
    const color = classification ? ACMG_COLORS[classification] : '#999999';
    const label = payload.variant.hgvsp || payload.variant.variant_id;
    addVariantMarker(residue, color, label);
  } else {
    removeVariantMarker(residue);
  }
}

// Clear all variant markers
function handleClearVariants(): void {
  clearAllVariantMarkers();
}

// Retry loading
async function retryLoad(): Promise<void> {
  if (props.structureUrl) {
    viewerError.value = null;
    try {
      await loadStructure(props.structureUrl);
    } catch {
      viewerError.value = 'Failed to load 3D structure. Please try again.';
    }
  }
}
```

**Styles (scoped):**
```css
.protein-structure-3d {
  position: relative;
  height: 500px;  /* Fixed height per CONTEXT.md */
  display: flex;
  flex-direction: column;
}

.state-overlay {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
}

.viewer-layout {
  display: flex;
  height: 100%;
  gap: 0;
}

.viewer-section {
  flex: 7;  /* 70% width */
  position: relative;
  display: flex;
  flex-direction: column;
  min-width: 0;
}

.variant-section {
  flex: 3;  /* 30% width */
  border-left: 1px solid #dee2e6;
  overflow-y: auto;
  min-width: 0;
}

.controls-toolbar {
  display: flex;
  gap: 8px;
  padding: 6px 8px;
  background: #f8f9fa;
  border-bottom: 1px solid #dee2e6;
  align-items: center;
  flex-shrink: 0;
  z-index: 10;
}

.ngl-viewport {
  flex: 1;
  min-height: 0;
  outline: none;  /* Remove focus outline on viewer */
}

.ngl-viewport:focus-visible {
  outline: 2px solid #0d6efd;
  outline-offset: -2px;
}

.plddt-legend {
  display: flex;
  gap: 8px;
  padding: 4px 8px;
  background: #f8f9fa;
  border-top: 1px solid #dee2e6;
  align-items: center;
  flex-shrink: 0;
}

.legend-title {
  font-weight: 600;
  font-size: 0.75rem;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 3px;
  font-size: 0.75rem;
}

.legend-color {
  display: inline-block;
  width: 16px;
  height: 10px;
  border-radius: 2px;
  flex-shrink: 0;
}
```

CRITICAL implementation notes:
- The `v-show` (not `v-if`) on viewer-layout keeps the DOM alive for NGL Stage after initialization.
- The `viewerContainer` ref is watched by use3DStructure composable for lazy tab mount timing.
- NGL Stage handles mouse pan/zoom/rotate natively (STRUCT3D-05) -- no custom handlers needed.
- `tabindex="0"` on viewport enables keyboard focus for accessibility (A11Y-04).
- All buttons have `aria-label` and `aria-pressed` attributes (A11Y-04).
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors.
Verify component exists: `ls app/src/components/gene/ProteinStructure3D.vue`.
Verify composable import: `grep "use3DStructure" app/src/components/gene/ProteinStructure3D.vue`.
Verify pLDDT legend: `grep "PLDDT_LEGEND" app/src/components/gene/ProteinStructure3D.vue`.
Verify ACMG colors: `grep "ACMG_COLORS" app/src/components/gene/ProteinStructure3D.vue`.
Verify aria labels: `grep "aria-label" app/src/components/gene/ProteinStructure3D.vue`.
  </verify>
  <done>
ProteinStructure3D component renders NGL viewer with pLDDT coloring, representation toolbar (cartoon/surface/ball+stick), pLDDT legend, reset view button, and loading/error/empty states. 70/30 viewer-sidebar layout. All controls have aria-labels. Variant toggle events wired to composable add/removeVariantMarker.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create VariantPanel component with multi-select ClinVar variant highlighting</name>
  <files>app/src/components/gene/VariantPanel.vue</files>
  <action>
Create `app/src/components/gene/VariantPanel.vue` as a Vue 3 SFC with `<script setup lang="ts">`:

**Props interface:**
```typescript
interface Props {
  variants: ClinVarVariant[];
}
```

**Emits:**
```typescript
defineEmits<{
  'toggle-variant': [payload: { variant: ClinVarVariant; selected: boolean }];
  'clear-all': [];
}>();
```

**Template structure:**

```html
<div class="variant-panel" role="region" aria-label="ClinVar variant selection panel">
  <!-- Panel Header -->
  <div class="panel-header">
    <span class="fw-semibold small">Variants ({{ mappableVariants.length }})</span>
    <BButton
      v-if="selectedResidues.size > 0"
      variant="link"
      size="sm"
      class="text-decoration-none p-0"
      aria-label="Clear all highlighted variants"
      @click="clearAll"
    >
      Clear all
    </BButton>
  </div>

  <!-- No variants state -->
  <div v-if="mappableVariants.length === 0" class="text-center py-3">
    <span class="text-muted small">
      {{ variants.length === 0 ? 'No ClinVar variants available' : 'No variants with protein positions' }}
    </span>
  </div>

  <!-- Variant List (scrollable) -->
  <div v-else class="variant-list" role="list" aria-label="ClinVar variants with protein positions">
    <label
      v-for="item in mappableVariants"
      :key="item.variant.variant_id"
      class="variant-item"
      role="listitem"
    >
      <input
        type="checkbox"
        :checked="selectedResidues.has(item.residue)"
        :aria-label="`Highlight ${item.variant.hgvsp || item.variant.variant_id} on 3D structure`"
        @change="toggleVariant(item)"
      />
      <span
        class="acmg-dot"
        :style="{ backgroundColor: item.color }"
        :aria-hidden="true"
      ></span>
      <span class="variant-info">
        <span class="variant-notation small">
          {{ item.variant.hgvsp || item.variant.hgvsc || item.variant.variant_id }}
        </span>
        <span class="variant-class small text-muted">
          {{ item.label }}
        </span>
      </span>
    </label>
  </div>
</div>
```

**Script setup:**

```typescript
import { ref, computed } from 'vue';
import { BButton } from 'bootstrap-vue-next';
import type { ClinVarVariant } from '@/types/external';
import {
  ACMG_COLORS,
  ACMG_LABELS,
  parseResidueNumber,
  classifyClinicalSignificance,
  type AcmgClassification,
} from '@/types/alphafold';

const props = defineProps<Props>();
const emit = defineEmits<{...}>();

// Track selected residues for checkbox state
const selectedResidues = ref<Set<number>>(new Set());

// Processable variant item (variant + parsed residue + ACMG info)
interface MappableVariant {
  variant: ClinVarVariant;
  residue: number;
  classification: AcmgClassification | null;
  color: string;
  label: string;
}

// Filter variants to only those with parseable protein positions
// Sorted by residue number for spatial ordering
const mappableVariants = computed<MappableVariant[]>(() => {
  const items: MappableVariant[] = [];

  for (const variant of props.variants) {
    const residue = parseResidueNumber(variant.hgvsp);
    if (residue === null) continue; // Skip variants without protein position

    const classification = classifyClinicalSignificance(variant.clinical_significance);
    items.push({
      variant,
      residue,
      classification,
      color: classification ? ACMG_COLORS[classification] : '#999999',
      label: classification ? ACMG_LABELS[classification] : variant.clinical_significance,
    });
  }

  // Sort by residue number (ascending) for spatial ordering in list
  items.sort((a, b) => a.residue - b.residue);
  return items;
});

// Toggle variant selection
function toggleVariant(item: MappableVariant): void {
  const isCurrentlySelected = selectedResidues.value.has(item.residue);
  const newSelected = !isCurrentlySelected;

  if (newSelected) {
    selectedResidues.value.add(item.residue);
  } else {
    selectedResidues.value.delete(item.residue);
  }

  // Force reactivity update (Set mutation doesn't trigger)
  selectedResidues.value = new Set(selectedResidues.value);

  emit('toggle-variant', { variant: item.variant, selected: newSelected });
}

// Clear all selections
function clearAll(): void {
  selectedResidues.value = new Set();
  emit('clear-all');
}
```

**Styles (scoped):**
```css
.variant-panel {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 10px;
  background: #f8f9fa;
  border-bottom: 1px solid #dee2e6;
  flex-shrink: 0;
}

.variant-list {
  overflow-y: auto;
  flex: 1;
  min-height: 0;
}

.variant-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
  transition: background-color 0.15s;
}

.variant-item:hover {
  background-color: #f8f9fa;
}

.acmg-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

.variant-info {
  display: flex;
  flex-direction: column;
  min-width: 0;
}

.variant-notation {
  font-family: 'Courier New', monospace;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.variant-class {
  font-size: 0.7rem;
}
```

Key implementation details:
- Only variants with parseable HGVSP protein positions appear in the list (others silently skipped).
- Sorted by residue number so the list follows protein sequence order.
- Multi-select via checkboxes (CONTEXT.md decision) -- multiple variants can be highlighted simultaneously.
- ACMG-colored dots next to each variant (consistent with GeneClinVarCard badge colors).
- Scrollable list for genes with many variants.
- "Clear all" button removes all highlights from structure.
- Set reactivity workaround: reassign `new Set(...)` to trigger Vue updates (Set.add/delete are not reactive).
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors.
Verify component exists: `ls app/src/components/gene/VariantPanel.vue`.
Verify ACMG colors import: `grep "ACMG_COLORS" app/src/components/gene/VariantPanel.vue`.
Verify parseResidueNumber: `grep "parseResidueNumber" app/src/components/gene/VariantPanel.vue`.
Verify multi-select: `grep "checkbox" app/src/components/gene/VariantPanel.vue`.
Verify aria labels: `grep "aria-label" app/src/components/gene/VariantPanel.vue`.
  </verify>
  <done>
VariantPanel component lists ClinVar variants filtered to those with parseable protein positions, sorted by residue number. Multi-select checkboxes toggle variant highlighting. ACMG-colored dots and classification labels shown. Clear all button removes all markers. Scrollable for large variant sets. Aria labels on all interactive elements.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors
2. `ls app/src/components/gene/ProteinStructure3D.vue` -- component exists
3. `ls app/src/components/gene/VariantPanel.vue` -- component exists
4. `grep "use3DStructure" app/src/components/gene/ProteinStructure3D.vue` -- composable wired
5. `grep "PLDDT_LEGEND" app/src/components/gene/ProteinStructure3D.vue` -- legend rendered
6. `grep "ACMG_COLORS" app/src/components/gene/ProteinStructure3D.vue` -- ACMG colors used
7. `grep "addVariantMarker" app/src/components/gene/ProteinStructure3D.vue` -- variant wiring
8. `grep "resetView" app/src/components/gene/ProteinStructure3D.vue` -- reset button wired
9. `grep "checkbox" app/src/components/gene/VariantPanel.vue` -- multi-select checkboxes
10. `grep "parseResidueNumber" app/src/components/gene/VariantPanel.vue` -- residue parsing
11. `grep "aria-label" app/src/components/gene/ProteinStructure3D.vue` -- accessibility
12. `grep "aria-label" app/src/components/gene/VariantPanel.vue` -- accessibility
13. `grep "v-show" app/src/components/gene/ProteinStructure3D.vue` -- DOM preserved for NGL
14. `grep "500px" app/src/components/gene/ProteinStructure3D.vue` -- fixed height
</verification>

<success_criteria>
- ProteinStructure3D renders NGL viewer in a 500px fixed-height container
- Toolbar provides cartoon/surface/ball+stick toggle with visual active state
- Reset View button calls composable resetView (autoView)
- pLDDT legend shows 4 confidence ranges with colored indicators
- Loading state: spinner + "Loading 3D structure..." text
- Empty state: "No AlphaFold structure available for [symbol]" with icon
- Error state: warning icon + error message + retry button
- v-show preserves NGL DOM after initialization (not v-if)
- VariantPanel lists only variants with parseable HGVSP positions
- Variants sorted by residue number (protein sequence order)
- Multi-select checkboxes toggle spacefill markers via composable
- ACMG-colored dots match shared ACMG_COLORS constants
- Clear all button removes all variant markers
- All interactive controls have aria-labels (A11Y-04)
- Viewer container has tabindex="0" for keyboard focus
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/45-3d-protein-structure-viewer/45-02-SUMMARY.md`
</output>
