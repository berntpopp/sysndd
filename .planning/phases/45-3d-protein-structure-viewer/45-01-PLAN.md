---
phase: 45-3d-protein-structure-viewer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/package.json
  - app/src/types/external.ts
  - app/src/types/alphafold.ts
  - app/src/types/index.ts
  - app/src/composables/use3DStructure.ts
  - app/src/composables/index.ts
autonomous: true

must_haves:
  truths:
    - "NGL Viewer v2.4.0 is installed as a project dependency"
    - "AlphaFold metadata interface types the backend proxy response including pdb_url and cif_url"
    - "ACMG color constants are defined once and shared across components"
    - "use3DStructure composable initializes NGL Stage in non-reactive variable"
    - "Composable disposes WebGL context in onBeforeUnmount to prevent context leak"
    - "Composable loads AlphaFold PDB structure with bfactor colorScheme for pLDDT coloring"
    - "Composable supports cartoon, surface, and ball+stick representation toggling via setVisibility"
    - "Composable adds variant markers as spacefill representations at residue positions"
    - "Composable provides resetView to return structure to default orientation"
    - "Container ref watch pattern handles lazy tab mount timing"
  artifacts:
    - path: "app/src/types/alphafold.ts"
      provides: "AlphaFold metadata interface and ACMG color constants"
      exports: ["AlphaFoldMetadata", "ACMG_COLORS", "PLDDT_LEGEND", "RepresentationType", "parseResidueNumber"]
    - path: "app/src/composables/use3DStructure.ts"
      provides: "NGL Viewer lifecycle composable with markRaw pattern"
      exports: ["use3DStructure", "Use3DStructureReturn"]
  key_links:
    - from: "app/src/types/index.ts"
      to: "app/src/types/alphafold.ts"
      via: "barrel re-export"
      pattern: "export.*alphafold"
    - from: "app/src/composables/index.ts"
      to: "app/src/composables/use3DStructure.ts"
      via: "barrel re-export"
      pattern: "use3DStructure"
    - from: "app/src/composables/use3DStructure.ts"
      to: "app/src/types/alphafold.ts"
      via: "import type"
      pattern: "import.*from.*types"
    - from: "app/src/types/external.ts"
      to: "app/src/types/alphafold.ts"
      via: "typed alphafold source"
      pattern: "AlphaFoldMetadata"
---

<objective>
Install NGL Viewer, create AlphaFold type definitions with shared ACMG color constants, and build the use3DStructure composable that manages NGL Stage lifecycle with Vue 3 reactivity safety.

Purpose: Foundation layer for the 3D protein structure viewer. The composable follows the proven useCytoscape.ts non-reactive pattern to prevent Vue proxy interference with WebGL objects. ACMG color constants ensure consistency between GeneClinVarCard, the future lollipop plot (Phase 43), and this 3D viewer. The AlphaFold interface types the backend proxy response from Phase 40.

Output: NGL installed, `app/src/types/alphafold.ts` (types + constants + helpers), `app/src/composables/use3DStructure.ts` (composable), updated barrel exports, typed alphafold source in external.ts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-3d-protein-structure-viewer/45-CONTEXT.md
@.planning/phases/45-3d-protein-structure-viewer/45-RESEARCH.md

Key references:
@app/src/composables/useCytoscape.ts (CRITICAL pattern: non-reactive `let cy`, markRaw, onBeforeUnmount cleanup)
@app/src/types/external.ts (ExternalDataResponse with alphafold?: unknown -- needs typing)
@app/src/components/gene/GeneClinVarCard.vue (ACMG colors: #dc3545, #fd7e14, #ffc107, #20c997, #28a745)
@app/src/composables/useGeneExternalData.ts (per-source state pattern)
@api/functions/external-proxy-alphafold.R (backend response: pdb_url, cif_url, entry_id, uniprot_accession)
@app/src/composables/index.ts (barrel export pattern)
@app/src/types/index.ts (barrel export pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install NGL and create AlphaFold types with ACMG constants</name>
  <files>app/package.json, app/src/types/alphafold.ts, app/src/types/external.ts, app/src/types/index.ts</files>
  <action>
1. **Install NGL Viewer v2.4.0:**
   ```bash
   cd app && npm install ngl@2.4.0
   ```

2. **Create `app/src/types/alphafold.ts`** with these exports:

   a. **AlphaFoldMetadata** interface (matches backend `external-proxy-alphafold.R` response):
      - source: string (always "alphafold")
      - gene_symbol: string
      - uniprot_accession: string
      - entry_id: string (e.g., "AF-P38398-F1")
      - pdb_url: string (URL to PDB format structure file)
      - cif_url: string (URL to mmCIF format structure file)
      - bcif_url: string (URL to BinaryCIF format)
      - pae_image_url: string (URL to PAE image)
      - model_url: string (URL for viewer -- same as cif_url)
      - model_created_date: string (ISO date)
      - latest_version: number

   b. **ACMG_COLORS** const object (shared across all ACMG-colored components):
      ```typescript
      export const ACMG_COLORS = {
        pathogenic: '#dc3545',
        likely_pathogenic: '#fd7e14',
        vus: '#ffc107',
        likely_benign: '#20c997',
        benign: '#28a745',
      } as const;
      ```
      These hex values match GeneClinVarCard.vue `.badge-lp` (#fd7e14), `.badge-lb` (#20c997), and Bootstrap variants (danger=#dc3545, warning=#ffc107, success=#28a745).

   c. **ACMG_LABELS** const object (text labels for each classification):
      ```typescript
      export const ACMG_LABELS = {
        pathogenic: 'Pathogenic',
        likely_pathogenic: 'Likely Pathogenic',
        vus: 'VUS',
        likely_benign: 'Likely Benign',
        benign: 'Benign',
      } as const;
      ```

   d. **AcmgClassification** type: `keyof typeof ACMG_COLORS`

   e. **PLDDT_LEGEND** const array (AlphaFold confidence color legend):
      ```typescript
      export const PLDDT_LEGEND = [
        { label: 'Very High (>90)', color: '#0053d6', min: 90, max: 100 },
        { label: 'Confident (70-90)', color: '#65cbf3', min: 70, max: 90 },
        { label: 'Low (50-70)', color: '#ffdb13', min: 50, max: 70 },
        { label: 'Very Low (<50)', color: '#ff7d45', min: 0, max: 50 },
      ] as const;
      ```
      Colors match AlphaFold DB convention.

   f. **RepresentationType** type:
      ```typescript
      export type RepresentationType = 'cartoon' | 'surface' | 'ball+stick';
      ```

   g. **parseResidueNumber** function (extracts residue number from HGVSP notation):
      ```typescript
      export function parseResidueNumber(hgvsp: string | null): number | null {
        if (!hgvsp) return null;
        const match = hgvsp.match(/p\.\w{3}(\d+)/);
        return match ? parseInt(match[1], 10) : null;
      }
      ```
      Handles patterns like "p.Arg123Trp" -> 123, "p.Gly456del" -> 456.
      Returns null for null input or unrecognized format (insertions, frameshifts without position).

   h. **classifyClinicalSignificance** function (normalizes clinical_significance to AcmgClassification):
      ```typescript
      export function classifyClinicalSignificance(significance: string): AcmgClassification | null {
        const lower = significance.toLowerCase().replace(/_/g, ' ');
        if (lower.includes('pathogenic') && !lower.includes('likely')) return 'pathogenic';
        if (lower.includes('likely') && lower.includes('pathogenic')) return 'likely_pathogenic';
        if (lower.includes('uncertain') || lower.includes('vus')) return 'vus';
        if (lower.includes('likely') && lower.includes('benign')) return 'likely_benign';
        if (lower.includes('benign') && !lower.includes('likely')) return 'benign';
        return null;
      }
      ```
      Same logic as GeneClinVarCard.vue counts computed property, extracted to a shared function.

3. **Update `app/src/types/external.ts`** -- replace the `alphafold?: unknown;` line with:
   ```typescript
   alphafold?: AlphaFoldMetadata;
   ```
   Add the import at the top: `import type { AlphaFoldMetadata } from './alphafold';`

4. **Update `app/src/types/index.ts`** to add barrel export:
   ```typescript
   export * from './alphafold';
   ```
   Add after the existing `export * from './external';` line.
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors.
Verify NGL installed: `grep '"ngl"' app/package.json`.
Verify exports: `grep "alphafold" app/src/types/index.ts`.
Verify ACMG constants: `grep "ACMG_COLORS" app/src/types/alphafold.ts`.
Verify external.ts typed: `grep "AlphaFoldMetadata" app/src/types/external.ts`.
  </verify>
  <done>
NGL Viewer v2.4.0 installed. AlphaFold metadata interface matches backend response shape. ACMG color constants defined as shared source of truth. parseResidueNumber extracts amino acid positions from HGVSP. classifyClinicalSignificance normalizes significance strings. pLDDT legend constants match AlphaFold DB convention. External.ts alphafold source properly typed. All barrel exports updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create use3DStructure composable with NGL Stage lifecycle</name>
  <files>app/src/composables/use3DStructure.ts, app/src/composables/index.ts</files>
  <action>
Create `app/src/composables/use3DStructure.ts` following the useCytoscape.ts pattern precisely:

1. **Import NGL dynamically** for code splitting (lazy load when composable is first used):
   ```typescript
   // NGL is imported dynamically for code splitting
   // The lazy tab ensures this composable is only loaded when user clicks "3D Structure" tab
   import * as NGL from 'ngl';
   ```
   Note: Since the entire ProteinStructure3D component is lazy-loaded via `<BTab lazy>`, the static import is fine -- Vite tree-shakes the chunk. NGL will only be in the chunk that loads on tab click.

2. **Use3DStructureReturn** exported interface:
   ```typescript
   export interface Use3DStructureReturn {
     isInitialized: Readonly<Ref<boolean>>;
     isLoading: Readonly<Ref<boolean>>;
     error: Readonly<Ref<string | null>>;
     activeRepresentation: Readonly<Ref<RepresentationType>>;
     loadStructure: (url: string) => Promise<void>;
     addVariantMarker: (residue: number, color: string, label: string) => void;
     removeVariantMarker: (residue: number) => void;
     clearAllVariantMarkers: () => void;
     setRepresentation: (type: RepresentationType) => void;
     resetView: () => void;
     cleanup: () => void;
   }
   ```

3. **Function signature:**
   ```typescript
   export function use3DStructure(
     containerRef: Ref<HTMLElement | null>
   ): Use3DStructureReturn
   ```

4. **CRITICAL: Non-reactive NGL instances** (follow useCytoscape `let cy` pattern EXACTLY):
   ```typescript
   // CRITICAL: Non-reactive variable (NOT ref()) -- Vue reactivity
   // on WebGL objects causes frozen UI and 100+ layout recalculations
   let stage: InstanceType<typeof NGL.Stage> | null = null;
   let structureComponent: any = null; // NGL.Component (untyped in v2.4.0)

   // Representation references for visibility toggle (Map is non-reactive)
   // Each NGL representation is wrapped in markRaw before storage
   const representations = new Map<string, any>();
   ```
   NGL v2.4.0 TypeScript typings are incomplete, so use `any` for Component and RepresentationElement types with JSDoc comments explaining the actual NGL types.

5. **Reactive state** (only UI-facing state is reactive):
   ```typescript
   const isInitialized = ref(false);
   const isLoading = ref(false);
   const error = ref<string | null>(null);
   const activeRepresentation = ref<RepresentationType>('cartoon');
   ```

6. **initStage()** (private, called from container watch):
   ```typescript
   function initStage(): void {
     if (!containerRef.value) {
       console.warn('use3DStructure: container element not available');
       return;
     }

     // Clean up existing instance first
     if (stage) {
       stage.dispose();
       stage = null;
     }

     stage = new NGL.Stage(containerRef.value, {
       backgroundColor: 'white',
     });

     // Handle window resize
     window.addEventListener('resize', handleResize);
     isInitialized.value = true;
   }
   ```

7. **handleResize()** (private):
   ```typescript
   function handleResize(): void {
     if (stage) {
       stage.handleResize();
     }
   }
   ```

8. **loadStructure(url: string)** (public, loads AlphaFold PDB/CIF):
   ```typescript
   async function loadStructure(url: string): Promise<void> {
     if (!stage) {
       error.value = 'Viewer not initialized';
       return;
     }

     isLoading.value = true;
     error.value = null;

     try {
       // Remove previous structure
       if (structureComponent) {
         stage.removeAllComponents();
         representations.clear();
         structureComponent = null;
       }

       // Load structure file (NGL auto-detects PDB/CIF from URL extension)
       structureComponent = await stage.loadFile(url);

       // Default: cartoon with pLDDT confidence coloring (STRUCT3D-01)
       // AlphaFold stores pLDDT in b-factor column -- NGL's bfactor colorScheme
       // auto-maps to blue-cyan-yellow-orange gradient matching AlphaFold DB convention
       const cartoonRepr = structureComponent.addRepresentation('cartoon', {
         colorScheme: 'bfactor',
       });
       representations.set('cartoon', markRaw(cartoonRepr));

       // Pre-create surface and ball+stick (hidden) for instant toggle (STRUCT3D-02)
       // Using setVisibility is faster than remove+add (avoids geometry re-parsing)
       const surfaceRepr = structureComponent.addRepresentation('surface', {
         colorScheme: 'bfactor',
         visible: false,
       });
       representations.set('surface', markRaw(surfaceRepr));

       const ballStickRepr = structureComponent.addRepresentation('ball+stick', {
         colorScheme: 'bfactor',
         visible: false,
       });
       representations.set('ball+stick', markRaw(ballStickRepr));

       activeRepresentation.value = 'cartoon';

       // Auto-center and zoom to fit structure (STRUCT3D-05 default view)
       structureComponent.autoView();
     } catch (err) {
       console.error('use3DStructure: Failed to load structure:', err);
       error.value = 'Failed to load 3D structure. Please try again.';
       throw err;
     } finally {
       isLoading.value = false;
     }
   }
   ```

9. **setRepresentation(type: RepresentationType)** (public, STRUCT3D-02):
   ```typescript
   function setRepresentation(type: RepresentationType): void {
     if (!structureComponent) return;

     // Hide all base representations
     const baseTypes: RepresentationType[] = ['cartoon', 'surface', 'ball+stick'];
     baseTypes.forEach((name) => {
       const repr = representations.get(name);
       if (repr) {
         repr.setVisibility(name === type);
       }
     });

     activeRepresentation.value = type;
   }
   ```

10. **addVariantMarker(residue: number, color: string, label: string)** (public, STRUCT3D-03):
    ```typescript
    function addVariantMarker(residue: number, color: string, label: string): void {
      if (!structureComponent) return;

      const key = `variant-${residue}`;

      // Remove existing marker for this residue (toggle off/on)
      if (representations.has(key)) {
        removeVariantMarker(residue);
      }

      // Add spacefill representation at residue position (ACMG-colored sphere)
      const variantRepr = structureComponent.addRepresentation('spacefill', {
        sele: `${residue}`,       // NGL residue selection language
        color: color,              // ACMG hex color from ACMG_COLORS
        radius: 2.0,              // Enlarged sphere for visibility
        name: label,              // Variant label for identification
      });

      representations.set(key, markRaw(variantRepr));
    }
    ```

11. **removeVariantMarker(residue: number)** (public):
    ```typescript
    function removeVariantMarker(residue: number): void {
      const key = `variant-${residue}`;
      const repr = representations.get(key);
      if (repr && structureComponent) {
        structureComponent.removeRepresentation(repr);
        representations.delete(key);
      }
    }
    ```

12. **clearAllVariantMarkers()** (public):
    ```typescript
    function clearAllVariantMarkers(): void {
      if (!structureComponent) return;

      // Remove all variant-* representations
      for (const [key, repr] of representations.entries()) {
        if (key.startsWith('variant-')) {
          structureComponent.removeRepresentation(repr);
          representations.delete(key);
        }
      }
    }
    ```

13. **resetView()** (public, STRUCT3D-06):
    ```typescript
    function resetView(): void {
      if (structureComponent) {
        structureComponent.autoView();
      }
    }
    ```

14. **cleanup()** (public, STRUCT3D-08):
    ```typescript
    function cleanup(): void {
      window.removeEventListener('resize', handleResize);

      if (stage) {
        stage.dispose();  // CRITICAL: Releases WebGL context
        stage = null;
      }

      structureComponent = null;
      representations.clear();
      isInitialized.value = false;
      isLoading.value = false;
      error.value = null;
    }
    ```

15. **Lifecycle hooks** (STRUCT3D-08):
    ```typescript
    // CRITICAL: Cleanup prevents WebGL context leak
    // Browsers limit to 8-16 WebGL contexts per origin
    // Without dispose(), navigating 16 gene pages crashes with "Exceeded WebGL context limit"
    onBeforeUnmount(() => {
      cleanup();
    });
    ```

16. **Container watch** (handles lazy tab mount timing -- Pitfall 4 from RESEARCH.md):
    ```typescript
    // Initialize Stage when container becomes available (lazy tab mount)
    // Bootstrap Vue Next <BTab lazy> mounts content asynchronously
    // onMounted may fire before container ref is populated
    watch(containerRef, (newVal) => {
      if (newVal && !isInitialized.value) {
        initStage();
      }
    }, { immediate: true });
    ```

17. **Return:**
    ```typescript
    return {
      isInitialized: readonly(isInitialized),
      isLoading: readonly(isLoading),
      error: readonly(error),
      activeRepresentation: readonly(activeRepresentation),
      loadStructure,
      addVariantMarker,
      removeVariantMarker,
      clearAllVariantMarkers,
      setRepresentation,
      resetView,
      cleanup,
    };
    ```

CRITICAL PATTERNS from RESEARCH.md and useCytoscape.ts:
- `let stage` (NOT `ref()`) -- prevents Vue from proxying WebGL objects
- `markRaw()` on every NGL representation before storing in Map
- `stage.dispose()` in `onBeforeUnmount` -- prevents WebGL context leak
- `watch(containerRef)` with `immediate: true` -- handles lazy tab mount timing
- Pre-create all representations with `visible: false` -- `setVisibility()` is instant vs remove+add
- `readonly()` on all returned refs -- consumers cannot mutate composable state directly

Update `app/src/composables/index.ts` to add barrel export:
```typescript
// 3D structure viewer composable (NGL Viewer integration)
export { use3DStructure } from './use3DStructure';
export type { Use3DStructureReturn } from './use3DStructure';
```
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors.
Verify non-reactive pattern: `grep "let stage" app/src/composables/use3DStructure.ts`.
Verify markRaw usage: `grep "markRaw" app/src/composables/use3DStructure.ts`.
Verify cleanup: `grep "stage.dispose" app/src/composables/use3DStructure.ts`.
Verify onBeforeUnmount: `grep "onBeforeUnmount" app/src/composables/use3DStructure.ts`.
Verify container watch: `grep "watch(containerRef" app/src/composables/use3DStructure.ts`.
Verify barrel export: `grep "use3DStructure" app/src/composables/index.ts`.
  </verify>
  <done>
use3DStructure composable manages NGL Stage lifecycle with non-reactive WebGL instance, markRaw wrapping for all NGL objects, container watch for lazy tab timing, pre-created representations for instant toggle, variant marker add/remove/clear via spacefill representations, resetView via autoView, and proper WebGL context disposal in onBeforeUnmount. Follows useCytoscape.ts pattern exactly. Barrel exports updated.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors
2. `grep '"ngl"' app/package.json` -- NGL v2.4.0 installed
3. `grep "AlphaFoldMetadata" app/src/types/alphafold.ts` -- interface exported
4. `grep "ACMG_COLORS" app/src/types/alphafold.ts` -- shared color constants
5. `grep "PLDDT_LEGEND" app/src/types/alphafold.ts` -- pLDDT legend constants
6. `grep "parseResidueNumber" app/src/types/alphafold.ts` -- HGVSP parser
7. `grep "AlphaFoldMetadata" app/src/types/external.ts` -- typed alphafold source
8. `grep "alphafold" app/src/types/index.ts` -- barrel export
9. `grep "let stage" app/src/composables/use3DStructure.ts` -- non-reactive pattern
10. `grep "markRaw" app/src/composables/use3DStructure.ts` -- Vue safety
11. `grep "stage.dispose" app/src/composables/use3DStructure.ts` -- WebGL cleanup
12. `grep "onBeforeUnmount" app/src/composables/use3DStructure.ts` -- lifecycle hook
13. `grep "watch(containerRef" app/src/composables/use3DStructure.ts` -- lazy tab pattern
14. `grep "bfactor" app/src/composables/use3DStructure.ts` -- pLDDT colorScheme
15. `grep "use3DStructure" app/src/composables/index.ts` -- barrel export
</verification>

<success_criteria>
- NGL Viewer v2.4.0 installed in app/package.json
- AlphaFoldMetadata interface matches backend response (pdb_url, cif_url, entry_id, etc.)
- ACMG_COLORS shared constants match GeneClinVarCard hex values exactly
- PLDDT_LEGEND matches AlphaFold DB blue-cyan-yellow-orange convention
- parseResidueNumber extracts residue from HGVSP notation
- classifyClinicalSignificance normalizes significance strings to AcmgClassification
- external.ts alphafold source typed as AlphaFoldMetadata (not unknown)
- use3DStructure composable stores NGL Stage in non-reactive let variable
- All NGL objects wrapped in markRaw() before reactive storage
- Container watch handles lazy tab mount timing
- Pre-created representations enable instant toggle via setVisibility
- Variant markers use spacefill with ACMG colors at residue positions
- resetView returns to default orientation via autoView
- WebGL context properly disposed in onBeforeUnmount
- All barrel exports updated
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/45-3d-protein-structure-viewer/45-01-SUMMARY.md`
</output>
