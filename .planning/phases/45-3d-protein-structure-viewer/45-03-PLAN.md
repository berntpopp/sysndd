---
phase: 45-3d-protein-structure-viewer
plan: 03
type: execute
wave: 3
depends_on: ["45-02"]
files_modified:
  - app/src/composables/useGeneExternalData.ts
  - app/src/views/pages/GeneView.vue
autonomous: true

must_haves:
  truths:
    - "useGeneExternalData composable exposes alphafold source state with typed AlphaFoldMetadata"
    - "GeneView.vue renders a tabbed visualization card with 3D Structure tab"
    - "3D Structure tab uses BTab lazy prop so NGL chunk only loads on first click"
    - "ProteinStructure3D receives AlphaFold PDB URL and ClinVar variants from GeneView"
    - "When AlphaFold data has found=false the structure URL is null showing empty state"
    - "Tab card has fixed 500px height and no layout shift when switching tabs"
    - "WebGL context is cleaned up when navigating away from gene page"
    - "Route watcher cleans up previous structure state on gene-to-gene navigation"
  artifacts:
    - path: "app/src/composables/useGeneExternalData.ts"
      provides: "Extended composable with alphafold per-source state"
      exports: ["useGeneExternalData", "UseGeneExternalDataReturn"]
    - path: "app/src/views/pages/GeneView.vue"
      provides: "Gene page with tabbed visualization card integrating 3D structure viewer"
  key_links:
    - from: "app/src/views/pages/GeneView.vue"
      to: "app/src/components/gene/ProteinStructure3D.vue"
      via: "component import inside BTab lazy"
      pattern: "ProteinStructure3D"
    - from: "app/src/views/pages/GeneView.vue"
      to: "app/src/composables/useGeneExternalData.ts"
      via: "composable import"
      pattern: "alphafold"
    - from: "app/src/composables/useGeneExternalData.ts"
      to: "app/src/types/alphafold.ts"
      via: "import type"
      pattern: "AlphaFoldMetadata"
---

<objective>
Extend useGeneExternalData to expose AlphaFold data, then integrate ProteinStructure3D into GeneView.vue within a tabbed visualization card with lazy loading.

Purpose: This is the integration plan that wires the 3D viewer into the gene page. The composable extension adds AlphaFold as a per-source state (loading/error/data pattern matching gnomad and clinvar). GeneView.vue adds a tabbed card below the external data cards with a "3D Structure" tab that lazy-loads the NGL chunk only when clicked. The ClinVar variant data is passed from the composable to the variant panel for spatial highlighting.

Output: Extended `useGeneExternalData.ts` with alphafold state, updated `GeneView.vue` with tabbed visualization card.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-3d-protein-structure-viewer/45-CONTEXT.md
@.planning/phases/45-3d-protein-structure-viewer/45-RESEARCH.md
@.planning/phases/45-3d-protein-structure-viewer/45-01-SUMMARY.md
@.planning/phases/45-3d-protein-structure-viewer/45-02-SUMMARY.md

Key references:
@app/src/composables/useGeneExternalData.ts (extend with alphafold state)
@app/src/views/pages/GeneView.vue (integrate tabbed card)
@app/src/types/alphafold.ts (AlphaFoldMetadata type)
@app/src/types/external.ts (ExternalDataResponse.sources.alphafold, ClinVarVariant)
@app/src/components/gene/ProteinStructure3D.vue (component to integrate)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend useGeneExternalData composable with AlphaFold per-source state</name>
  <files>app/src/composables/useGeneExternalData.ts</files>
  <action>
Extend the existing `useGeneExternalData.ts` composable to include AlphaFold data. Follow the exact same per-source state pattern as gnomad and clinvar.

1. **Add import** for AlphaFoldMetadata:
   ```typescript
   import type {
     ExternalDataResponse,
     GnomADConstraints,
     ClinVarVariant,
   } from '@/types';
   import type { AlphaFoldMetadata } from '@/types/alphafold';
   ```

2. **Extend UseGeneExternalDataReturn interface** -- add alphafold source:
   ```typescript
   export interface UseGeneExternalDataReturn {
     gnomad: {
       loading: Ref<boolean>;
       error: Ref<string | null>;
       data: Ref<GnomADConstraints | null>;
     };
     clinvar: {
       loading: Ref<boolean>;
       error: Ref<string | null>;
       data: Ref<ClinVarVariant[] | null>;
     };
     /** AlphaFold 3D structure metadata state */
     alphafold: {
       loading: Ref<boolean>;
       error: Ref<string | null>;
       data: Ref<AlphaFoldMetadata | null>;
     };
     loading: Ref<boolean>;
     fetchData: () => Promise<void>;
     retry: () => Promise<void>;
   }
   ```

3. **Add alphafold per-source state** inside the composable function (same pattern as gnomad/clinvar):
   ```typescript
   const alphafold = {
     loading: ref<boolean>(true),
     error: ref<string | null>(null),
     data: ref<AlphaFoldMetadata | null>(null),
   };
   ```

4. **Update overall loading computed** to include alphafold:
   ```typescript
   const loading = computed<boolean>(
     () => gnomad.loading.value || clinvar.loading.value || alphafold.loading.value,
   );
   ```

5. **Add alphafold processing inside fetchData()** -- after the ClinVar processing block, before the loading=false assignments. Follow the exact same pattern as gnomad and clinvar:
   ```typescript
   // Process AlphaFold structure metadata
   if (result.sources?.alphafold) {
     const alphafoldSource = result.sources.alphafold as any;
     if (alphafoldSource.found === false) {
       alphafold.data.value = null;
       alphafold.error.value = null; // Not an error, just no structure available
     } else {
       alphafold.data.value = alphafoldSource as AlphaFoldMetadata;
       alphafold.error.value = null;
     }
   } else if (result.errors?.alphafold) {
     const error = result.errors.alphafold;
     alphafold.error.value = error.detail || error.title || 'Failed to load AlphaFold structure';
     alphafold.data.value = null;
   } else {
     // Source not present (unexpected)
     alphafold.error.value = 'AlphaFold structure data not available';
     alphafold.data.value = null;
   }
   ```

6. **Update loading resets** at the start of fetchData():
   ```typescript
   alphafold.loading.value = true;
   alphafold.error.value = null;
   ```

7. **Update loading=false assignments** (both in success and catch blocks):
   ```typescript
   // In try block, after processing:
   alphafold.loading.value = false;

   // In catch block:
   alphafold.error.value = message;
   alphafold.data.value = null;
   alphafold.loading.value = false;
   ```

8. **Update return object** to include alphafold:
   ```typescript
   return {
     gnomad,
     clinvar,
     alphafold,
     loading,
     fetchData,
     retry,
   };
   ```

IMPORTANT: Do NOT change any existing gnomad or clinvar logic. Only ADD the alphafold state alongside them, following the identical pattern.
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors.
Verify alphafold state: `grep "alphafold" app/src/composables/useGeneExternalData.ts`.
Verify AlphaFoldMetadata import: `grep "AlphaFoldMetadata" app/src/composables/useGeneExternalData.ts`.
Verify return includes alphafold: `grep -A 2 "return {" app/src/composables/useGeneExternalData.ts`.
  </verify>
  <done>
useGeneExternalData composable now exposes alphafold per-source state (loading/error/data) with typed AlphaFoldMetadata, following the exact same pattern as gnomad and clinvar. Overall loading includes alphafold. found=false handled as null data (not error). All existing gnomad and clinvar behavior unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ProteinStructure3D into GeneView.vue with tabbed visualization card</name>
  <files>app/src/views/pages/GeneView.vue</files>
  <action>
Update `app/src/views/pages/GeneView.vue` to add a tabbed visualization card with the 3D Structure tab. The card appears between the external data cards and the entities table.

1. **Add imports:**
   ```typescript
   import { BTabs, BTab } from 'bootstrap-vue-next';
   import ProteinStructure3D from '@/components/gene/ProteinStructure3D.vue';
   ```

2. **Destructure alphafold from useGeneExternalData:**
   Update the existing destructuring line:
   ```typescript
   const {
     gnomad,
     clinvar,
     alphafold,
     fetchData: fetchExternalData,
     retry: retryExternalData,
   } = useGeneExternalData(geneSymbol);
   ```

3. **Add computed property for AlphaFold structure URL:**
   ```typescript
   // AlphaFold structure PDB URL (null if no structure available)
   const alphafoldPdbUrl = computed(() => alphafold.data.value?.pdb_url || null);
   ```
   Use pdb_url (not cif_url) because NGL v2.4.0 handles PDB format most reliably and the backend always provides it.

4. **Add computed property for ClinVar variants (for variant panel):**
   ```typescript
   // ClinVar variants for 3D viewer variant panel
   const clinvarVariants = computed(() => clinvar.data.value || []);
   ```

5. **Add tabbed visualization card to template** -- insert between the external data cards row and the TablesEntities section:
   ```html
   <!-- Visualization Card with Tabs (Phase 43/44/45 visualizations) -->
   <div class="container-fluid">
     <BContainer fluid>
       <BRow class="justify-content-md-center pt-2">
         <BCol col md="12">
           <BCard
             body-class="p-0"
             header-class="p-1"
             border-variant="dark"
             class="visualization-card"
           >
             <template #header>
               <span class="fw-semibold small">Visualizations</span>
             </template>

             <BTabs
               content-class="p-0"
               nav-class="px-2 pt-1"
               small
             >
               <!-- 3D Structure tab: lazy loaded (NGL ~777KB chunk) -->
               <BTab title="3D Structure" lazy>
                 <ProteinStructure3D
                   :gene-symbol="geneSymbol"
                   :structure-url="alphafoldPdbUrl"
                   :variants="clinvarVariants"
                 />
               </BTab>

               <!-- Protein Domains tab placeholder (Phase 43 will add) -->
               <!-- <BTab title="Protein Domains">...</BTab> -->

               <!-- Gene Structure tab placeholder (Phase 44 will add) -->
               <!-- <BTab title="Gene Structure">...</BTab> -->
             </BTabs>
           </BCard>
         </BCol>
       </BRow>
     </BContainer>
   </div>
   ```

   Place this block AFTER the `<!-- External genomic data cards -->` section and BEFORE the `<!-- Associated Entities Table -->` section.

6. **Add scoped styles** for the visualization card:
   ```css
   .visualization-card :deep(.card-body) {
     min-height: 500px; /* Fixed height for all tabs -- no layout shift */
   }

   .visualization-card :deep(.tab-pane) {
     height: 500px; /* Each tab pane gets full height */
   }
   ```

7. **Important: The `<BTab lazy>` prop** ensures the ProteinStructure3D component (and its NGL import) only mounts when the user clicks the "3D Structure" tab. This means:
   - NGL's ~777KB chunk loads on first tab click, not on page load
   - The use3DStructure composable's `watch(containerRef)` pattern handles the async mount
   - WebGL context is created only when user actively wants 3D view
   - On subsequent tab switches (away and back), the lazy content persists (not re-mounted)

8. **WebGL cleanup on gene-to-gene navigation:** The existing `watch(() => route.params.symbol)` watcher calls `loadGeneInfo()` which resets the page. When the GeneView re-renders with new props (new gene symbol), Vue unmounts the old ProteinStructure3D component, triggering `onBeforeUnmount` in use3DStructure which calls `stage.dispose()`. This handles cleanup automatically -- no additional code needed.

CRITICAL: Do NOT modify any existing template sections (GeneHero, IdentifierCard, ClinicalResourcesCard, GeneConstraintCard, GeneClinVarCard, TablesEntities). Only ADD the new tabbed visualization card section between external data cards and entities table.
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors.
Verify ProteinStructure3D import: `grep "ProteinStructure3D" app/src/views/pages/GeneView.vue`.
Verify BTabs import: `grep "BTabs" app/src/views/pages/GeneView.vue`.
Verify lazy tab: `grep "lazy" app/src/views/pages/GeneView.vue`.
Verify alphafold destructure: `grep "alphafold" app/src/views/pages/GeneView.vue`.
Verify structure URL prop: `grep "alphafoldPdbUrl" app/src/views/pages/GeneView.vue`.
Verify visualization card: `grep "visualization-card" app/src/views/pages/GeneView.vue`.
Run `cd /home/bernt-popp/development/sysndd/app && npm run build 2>&1 | tail -20` -- build succeeds (verifies NGL chunk is created).
  </verify>
  <done>
GeneView.vue has a tabbed visualization card with "3D Structure" lazy tab. ProteinStructure3D receives AlphaFold PDB URL and ClinVar variants from the extended useGeneExternalData composable. NGL chunk only loads on first tab click. Fixed 500px card height prevents layout shift. WebGL cleanup handled automatically by Vue lifecycle on navigation. Placeholder comments for Phase 43/44 tabs.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors
2. `cd /home/bernt-popp/development/sysndd/app && npm run build 2>&1 | tail -20` -- build succeeds with NGL chunk
3. `grep "alphafold" app/src/composables/useGeneExternalData.ts` -- alphafold state present
4. `grep "AlphaFoldMetadata" app/src/composables/useGeneExternalData.ts` -- typed import
5. `grep "ProteinStructure3D" app/src/views/pages/GeneView.vue` -- component imported and used
6. `grep "BTabs" app/src/views/pages/GeneView.vue` -- tabbed card present
7. `grep "lazy" app/src/views/pages/GeneView.vue` -- lazy loading enabled
8. `grep "alphafoldPdbUrl" app/src/views/pages/GeneView.vue` -- URL computed and passed
9. `grep "clinvarVariants" app/src/views/pages/GeneView.vue` -- variants passed to viewer
10. `grep "visualization-card" app/src/views/pages/GeneView.vue` -- card styled
11. `grep "500px" app/src/views/pages/GeneView.vue` -- fixed height
12. Verify NGL chunk in build output (separate chunk file created by Vite code splitting)
</verification>

<success_criteria>
- useGeneExternalData exposes alphafold.loading, alphafold.error, alphafold.data (AlphaFoldMetadata)
- AlphaFold found=false yields null data (empty state, not error)
- Existing gnomad and clinvar logic completely unchanged
- GeneView.vue has tabbed visualization card between external data cards and entities table
- "3D Structure" tab uses BTab lazy prop for deferred NGL loading
- ProteinStructure3D receives alphafoldPdbUrl and clinvarVariants as props
- Card height fixed at 500px (no layout shift)
- NGL creates separate Vite chunk (code splitting works)
- Build succeeds without errors
- WebGL cleanup automatic on page navigation (Vue lifecycle handles it)
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/45-3d-protein-structure-viewer/45-03-SUMMARY.md`
</output>
