---
phase: 75-frontend-fixes-ux-improvements
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/components/forms/wizard/StepPhenotypeVariation.vue
  - app/src/views/curate/CreateEntity.vue
autonomous: true

must_haves:
  truths:
    - "Create Entity step 3 uses the same TreeMultiSelect component as ModifyEntity for phenotype selection"
    - "Create Entity step 3 uses TreeMultiSelect for variation ontology selection (not BFormSelect)"
    - "Selected values use compound modifier_id-ontology_id format matching ModifyEntity (e.g., '1-HP:0001999')"
    - "Entity creation submission still works correctly with the compound ID format"
  artifacts:
    - path: "app/src/components/forms/wizard/StepPhenotypeVariation.vue"
      provides: "Phenotype and variation selection using TreeMultiSelect with hierarchy navigation"
      contains: "TreeMultiSelect"
    - path: "app/src/views/curate/CreateEntity.vue"
      provides: "Entity creation wizard that loads tree data with transformModifierTree"
      contains: "transformModifierTree"
  key_links:
    - from: "app/src/components/forms/wizard/StepPhenotypeVariation.vue"
      to: "app/src/components/forms/TreeMultiSelect.vue"
      via: "component import and usage"
      pattern: "TreeMultiSelect"
    - from: "app/src/views/curate/CreateEntity.vue"
      to: "/api/list/phenotype?tree=true"
      via: "API fetch with transformModifierTree processing"
      pattern: "transformModifierTree"
    - from: "app/src/views/curate/CreateEntity.vue"
      to: "submissionPhenotype"
      via: "buildSubmissionObject splits compound IDs"
      pattern: "item\\.split\\('-'\\)"
---

<objective>
Replace basic BFormSelect with TreeMultiSelect component in Create Entity step 3 (Phenotype & Variation), matching the exact behavior of ModifyEntity's phenotype/variation selection.

Purpose: UX-01 ensures consistent search, hierarchy navigation, and multi-select behavior between Create Entity and Modify Entity workflows. Users should have the same TreeMultiSelect experience with searchable hierarchical trees instead of flat dropdown lists.
Output: Updated StepPhenotypeVariation.vue using TreeMultiSelect, updated CreateEntity.vue to load and transform tree data using transformModifierTree pattern from ModifyEntity.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/75-frontend-fixes-ux-improvements/75-CONTEXT.md
@.planning/phases/75-frontend-fixes-ux-improvements/75-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CreateEntity to load tree data with transformModifierTree</name>
  <files>app/src/views/curate/CreateEntity.vue</files>
  <action>
Currently CreateEntity.vue loads phenotype and variation options using `loadGroupedOptions()` which creates BFormSelect-style grouped options (optgroup format with `{ label, options: [{ value, text }] }`). This needs to change to the TreeMultiSelect tree format used by ModifyEntity.

**Changes to CreateEntity.vue:**

1. **Replace `loadGroupedOptions` with `loadTreeOptions`** that uses the `transformModifierTree` pattern from ModifyEntity.vue (lines 856-886). Add the `transformModifierTree` method:

```typescript
/**
 * Transform phenotype/variation tree to make all modifiers selectable children.
 * Copied from ModifyEntity.vue - API returns "present: X" as parent with
 * [uncertain, variable, rare, absent] as children. We want "X" as parent
 * with [present, uncertain, variable, rare, absent] as children.
 *
 * Output format matches TreeMultiSelect's expected { id, label, children } structure.
 */
const transformModifierTree = (
  nodes: { id: string; label: string; children?: { id: string; label: string }[] }[]
) => {
  return nodes.map((node) => {
    const phenotypeName = node.label.replace(/^present:\s*/, '');
    const ontologyCode = node.id.replace(/^\d+-/, '');
    return {
      id: `parent-${ontologyCode}`,
      label: phenotypeName,
      children: [
        { id: node.id, label: `present: ${phenotypeName}` },
        ...(node.children || []).map((child) => {
          const modifier = child.label.replace(/:\s*.*$/, '');
          return { id: child.id, label: `${modifier}: ${phenotypeName}` };
        }),
      ],
    };
  });
};
```

2. **Create a new `loadTreeOptions` function** replacing `loadGroupedOptions`:

```typescript
const loadTreeOptions = async (endpoint: string, targetRef: typeof phenotypeOptions) => {
  try {
    const response = await axios.get(
      `${import.meta.env.VITE_API_URL}/api/list/${endpoint}?tree=true`,
      { withCredentials: true }
    );
    const rawData = Array.isArray(response.data) ? response.data : response.data?.data || [];
    targetRef.value = transformModifierTree(rawData);
  } catch (e) {
    makeToast(e as Error, 'Error', 'danger');
    targetRef.value = [];
  }
};
```

3. **Update the type of `phenotypeOptions` and `variationOptions`** from `ref<GroupedSelectOptions>([])` to a more generic type that matches TreeMultiSelect's expected format:

```typescript
interface TreeOption {
  id: string;
  label: string;
  children?: TreeOption[];
}

const phenotypeOptions = ref<TreeOption[]>([]);
const variationOptions = ref<TreeOption[]>([]);
```

4. **Update the `onMounted` call** to use `loadTreeOptions` instead of `loadGroupedOptions`:

```typescript
await Promise.all([
  loadFlatOptions('inheritance', inheritanceOptions),
  loadTreeOptions('phenotype', phenotypeOptions),
  loadTreeOptions('variation_ontology', variationOptions),
  loadFlatOptions('status', statusOptions),
]);
```

5. **Remove the now-unused functions**: `loadGroupedOptions`, `createGroupedOptions`, `extractTermName`, `extractModifier`. Also remove the `GroupedSelectOptions` import if no longer used elsewhere in this file.

6. **Verify `buildSubmissionObject` still works**: The existing code in `buildSubmissionObject` (lines 395-403) already handles compound IDs correctly:
```typescript
const phenotypes = formData.phenotypes.map((item) => {
  const [prefix, id] = item.split('-');
  return new Phenotype(id, prefix);
});
```
This splits "1-HP:0001999" into prefix="1" and id="HP:0001999", which is exactly the compound format TreeMultiSelect will produce. No changes needed here.

7. **Update the `StepPhenotypeVariation` props** in the template: The props `phenotype-options` and `variation-options` are already passed. The prop type will change in StepPhenotypeVariation (Task 2).

IMPORTANT: Do NOT modify TreeMultiSelect.vue itself - it is stable and already used correctly by ModifyEntity.
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx eslint src/views/curate/CreateEntity.vue` to check for lint errors.
Run `cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit 2>&1 | grep -i "CreateEntity\|StepPhenotype" | head -20` to check TypeScript.
  </verify>
  <done>
CreateEntity.vue uses transformModifierTree to process API tree data into TreeMultiSelect format. The loadGroupedOptions and related helpers are removed. buildSubmissionObject correctly handles compound modifier_id-ontology_id format. ESLint passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace BFormSelect with TreeMultiSelect in StepPhenotypeVariation</name>
  <files>app/src/components/forms/wizard/StepPhenotypeVariation.vue</files>
  <action>
Rewrite StepPhenotypeVariation.vue to use TreeMultiSelect instead of BFormSelect, following the exact same pattern as ModifyEntity.vue (lines 501-523).

**Template changes:**

Replace the entire template with a version that uses TreeMultiSelect for both phenotype and variation selection:

1. **Replace phenotype BFormSelect** (lines 14-25) with:
```vue
<TreeMultiSelect
  v-if="phenotypeOptions && phenotypeOptions.length > 0"
  id="phenotype-select"
  v-model="formData.phenotypes"
  :options="phenotypeOptions"
  placeholder="Select phenotypes..."
  search-placeholder="Search phenotypes (name or HP:ID)..."
/>
<BSpinner v-else-if="phenotypeOptions === null" small label="Loading phenotypes..." />
```

2. **Replace variation BFormSelect** (lines 61-72) with:
```vue
<TreeMultiSelect
  v-if="variationOptions && variationOptions.length > 0"
  id="variation-select"
  v-model="formData.variationOntology"
  :options="variationOptions"
  placeholder="Select variation types..."
  search-placeholder="Search variation types..."
/>
<BSpinner v-else-if="variationOptions === null" small label="Loading variation types..." />
```

3. **Remove the custom BBadge display** (lines 31-52 and 78-99) for selected items. TreeMultiSelect has its own built-in chips/tags for showing selections. This eliminates the need for `getPhenotypeLabel`, `getVariationLabel`, `addPhenotype`, `removePhenotype`, `addVariation`, `removeVariation` methods.

4. **Keep the section structure** with BFormGroup labels, help text, and the info BAlert at the bottom.

**Script changes:**

1. **Import TreeMultiSelect** instead of BFormSelect-related components:
```typescript
import TreeMultiSelect from '@/components/forms/TreeMultiSelect.vue';
```

2. **Update the component definition**:
- Remove BFormSelect, BFormSelectOption, BBadge, BCloseButton from imports and components
- Add TreeMultiSelect to components
- Keep BFormGroup, BAlert, BSpinner

3. **Update props** to accept TreeMultiSelect-compatible options (array of `{ id, label, children }` objects):
```typescript
interface TreeOption {
  id: string;
  label: string;
  children?: TreeOption[];
}

props: {
  phenotypeOptions: {
    type: Array as PropType<TreeOption[] | null>,
    default: null,
  },
  variationOptions: {
    type: Array as PropType<TreeOption[] | null>,
    default: null,
  },
},
```

Use `null` as default (not `[]`) following the established "null = not loaded, [] = loaded but empty" pattern.

4. **Simplify setup**: Remove all the manual add/remove/getLabel functions. TreeMultiSelect handles selection internally via v-model. The `formData.phenotypes` and `formData.variationOntology` arrays are directly bound via v-model and will contain compound IDs like "1-HP:0001999".

The simplified setup only needs:
```typescript
setup() {
  const formData = inject<EntityFormData>('formData')!;
  return { formData };
}
```

5. **Remove the custom BBadge styles** from `<style scoped>` since we no longer have `.selected-item-badge` elements.

**Key behavioral match with ModifyEntity:**
- TreeMultiSelect v-model binds directly to `formData.phenotypes` array
- Selected values are compound IDs: "modifier_id-ontology_id" (e.g., "1-HP:0001999")
- Tree hierarchy: phenotype name as parent, modifiers (present, uncertain, variable, etc.) as selectable children
- Search: matches on label text (phenotype name or HP:ID)
- Built-in chips for showing selections (TreeMultiSelect handles this)
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx eslint src/components/forms/wizard/StepPhenotypeVariation.vue` to check lint.
Run `cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit 2>&1 | grep -i "StepPhenotype\|CreateEntity" | head -20` to check TypeScript.

Verify the file contains `TreeMultiSelect` component usage (not BFormSelect) by checking:
`grep -n "TreeMultiSelect\|BFormSelect" app/src/components/forms/wizard/StepPhenotypeVariation.vue`
Expected: TreeMultiSelect present, BFormSelect absent.
  </verify>
  <done>
StepPhenotypeVariation.vue uses TreeMultiSelect for both phenotype and variation ontology selection. v-model binds directly to formData.phenotypes and formData.variationOntology with compound modifier_id-ontology_id format. No BFormSelect remains. ESLint and TypeScript pass. The component behavior matches ModifyEntity's TreeMultiSelect usage exactly.
  </done>
</task>

</tasks>

<verification>
1. StepPhenotypeVariation.vue imports and uses TreeMultiSelect (not BFormSelect)
2. CreateEntity.vue uses transformModifierTree to process API tree data
3. formData.phenotypes contains compound IDs like "1-HP:0001999" (matching ModifyEntity)
4. buildSubmissionObject in CreateEntity.vue correctly splits compound IDs for API submission
5. ESLint passes for both modified files
6. No modifications to TreeMultiSelect.vue component itself
</verification>

<success_criteria>
- Create Entity step 3 shows TreeMultiSelect for phenotypes with searchable hierarchy (phenotype name as parent, modifiers as children)
- Create Entity step 3 shows TreeMultiSelect for variation ontology with same pattern
- Selected values use compound modifier_id-ontology_id format
- Entity creation form submission works end-to-end with the new component
- Behavior matches ModifyEntity exactly
</success_criteria>

<output>
After completion, create `.planning/phases/75-frontend-fixes-ux-improvements/75-03-SUMMARY.md`
</output>
