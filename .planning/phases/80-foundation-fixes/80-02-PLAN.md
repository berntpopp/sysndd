---
phase: 80-foundation-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/utils/timeSeriesUtils.ts
  - app/src/utils/__tests__/timeSeriesUtils.spec.ts
  - app/src/views/admin/AdminStatistics.vue
  - docker-compose.yml
autonomous: true

must_haves:
  truths:
    - "Entity trend chart produces monotonically non-decreasing cumulative totals across all granularities (daily, weekly, monthly)"
    - "Switching granularity does not produce downward spikes in the cumulative chart"
    - "Traefik production container starts without 'No domain found' warnings"
    - "TypeScript unit tests pass for mergeGroupedCumulativeSeries() with sparse data fixtures"
  artifacts:
    - path: "app/src/utils/timeSeriesUtils.ts"
      provides: "mergeGroupedCumulativeSeries() utility"
      exports: ["mergeGroupedCumulativeSeries", "TimeSeriesPoint", "GroupedTimeSeries", "AggregatedPoint"]
    - path: "app/src/utils/__tests__/timeSeriesUtils.spec.ts"
      provides: "Unit tests for mergeGroupedCumulativeSeries with sparse data"
      min_lines: 80
    - path: "app/src/views/admin/AdminStatistics.vue"
      provides: "Fixed fetchTrendData() using mergeGroupedCumulativeSeries"
      contains: "mergeGroupedCumulativeSeries"
    - path: "docker-compose.yml"
      provides: "Traefik Host() matchers on api and app router rules"
      contains: "Host(`sysndd.dbmr.unibe.ch`)"
  key_links:
    - from: "app/src/views/admin/AdminStatistics.vue"
      to: "app/src/utils/timeSeriesUtils.ts"
      via: "import statement"
      pattern: "import.*mergeGroupedCumulativeSeries.*timeSeriesUtils"
    - from: "docker-compose.yml"
      to: "traefik router rules"
      via: "docker labels"
      pattern: "Host\\(`sysndd\\.dbmr\\.unibe\\.ch`\\)"
---

<objective>
Fix entity trend chart time-series aggregation (#171) to use cumulative_count with forward-fill, and fix Traefik TLS routing (#169) by adding Host() matchers.

Purpose: Bug #171 causes the entity trend chart to show downward spikes because it re-derives cumulative totals by summing incremental `count` values across categories, which fails when sparse data means not all categories have entries at every date. Bug #169 causes Traefik "No domain found" warnings and non-deterministic TLS cert selection because router rules lack Host() matchers.

Output: `app/src/utils/timeSeriesUtils.ts` (shared utility), fixed `AdminStatistics.vue`, unit tests, and fixed `docker-compose.yml` with Host() matchers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/80-foundation-fixes/80-RESEARCH.md

@app/src/views/admin/AdminStatistics.vue
@app/src/utils/clusterColors.ts
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create timeSeriesUtils.ts utility and fix AdminStatistics.vue</name>
  <files>
    app/src/utils/timeSeriesUtils.ts
    app/src/views/admin/AdminStatistics.vue
  </files>
  <action>
1. Create `app/src/utils/timeSeriesUtils.ts` with the following exports:

```typescript
export interface TimeSeriesPoint {
  entry_date: string;
  count: number;
  cumulative_count: number;
}

export interface GroupedTimeSeries {
  group: string;
  values: TimeSeriesPoint[];
}

export interface AggregatedPoint {
  date: string;
  count: number;
}
```

Implement `mergeGroupedCumulativeSeries(groups: GroupedTimeSeries[]): AggregatedPoint[]`:
- Step 1: Collect union of all dates from all groups using a `Set<string>`
- Step 2: Build per-group lookup `Map<string, number>` mapping `entry_date` to `cumulative_count` (NOT `count`)
- Step 3: Sort dates chronologically (string sort works for YYYY-MM-DD format)
- Step 4: Forward-fill and sum: for each sorted date, iterate all groups. If group has a value at that date, update `lastSeen[i]`. Sum all `lastSeen` values for the total.
- Use `v.values ?? []` to handle null/undefined values arrays defensively
- Return array of `{ date, count: total }` where `count` is the cumulative total across all groups

The implementation should match the code in the RESEARCH.md exactly (lines 178-213).

Also add a named default export for the function (following the pattern in clusterColors.ts).

2. Fix `app/src/views/admin/AdminStatistics.vue` `fetchTrendData()` function (lines 397-441):

Replace the current broken aggregation logic with the shared utility:

- Add import at top of `<script setup>`:
  ```typescript
  import { mergeGroupedCumulativeSeries } from '@/utils/timeSeriesUtils';
  import type { GroupedTimeSeries } from '@/utils/timeSeriesUtils';
  ```

- Replace the body of `fetchTrendData()` (from line 411 "Transform response..." through line 433) with:
  ```typescript
  // Transform response using utility that correctly handles sparse data
  const allData: GroupedTimeSeries[] = response.data.data || [];
  trendData.value = mergeGroupedCumulativeSeries(allData);
  ```

- Also update the `totalEntities` KPI derivation in `fetchKPIStats()` (lines 604-606). The current code `trendData.value[trendData.value.length - 1].count` is correct because `mergeGroupedCumulativeSeries` returns `{ date, count }` where `count` is the cumulative total. No change needed there.

- Remove the unused inline `dateCountMap`, `sortedDates`, and `cumulative` variables that were part of the old broken approach.

- Remove the inline type annotation for the `forEach` callback since it's now handled by the utility's types.

IMPORTANT: Do NOT change any other functions in AdminStatistics.vue (fetchLeaderboard, fetchKPIStats, etc.). Only modify fetchTrendData() and the import section.
  </action>
  <verify>
    - `grep -c "mergeGroupedCumulativeSeries" app/src/views/admin/AdminStatistics.vue` returns >= 1
    - `grep -c "mergeGroupedCumulativeSeries" app/src/utils/timeSeriesUtils.ts` returns >= 1
    - `grep "dateCountMap" app/src/views/admin/AdminStatistics.vue` returns no matches (old approach removed)
    - `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` passes (TypeScript type check)
    - `cd /home/bernt-popp/development/sysndd/app && npx eslint src/utils/timeSeriesUtils.ts src/views/admin/AdminStatistics.vue` passes
  </verify>
  <done>
    - mergeGroupedCumulativeSeries() exists as a pure utility function with TypeScript types
    - AdminStatistics.vue fetchTrendData() uses the utility instead of broken inline aggregation
    - The utility correctly uses cumulative_count (not count) and forward-fills sparse data
    - TypeScript compilation and ESLint pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add TypeScript unit tests for mergeGroupedCumulativeSeries and fix Traefik TLS</name>
  <files>
    app/src/utils/__tests__/timeSeriesUtils.spec.ts
    docker-compose.yml
  </files>
  <action>
1. Create `app/src/utils/__tests__/timeSeriesUtils.spec.ts` with Vitest unit tests:

```typescript
import { describe, it, expect } from 'vitest';
import { mergeGroupedCumulativeSeries } from '../timeSeriesUtils';
import type { GroupedTimeSeries } from '../timeSeriesUtils';
```

Test cases to write:

**Test: "returns empty array for empty input"**
- Input: `[]`
- Assert: result is `[]`

**Test: "returns empty array for groups with no values"**
- Input: `[{ group: 'A', values: [] }]`
- Assert: result is `[]`

**Test: "handles single group with complete data"**
- Input: one group with 3 dates, each having count and cumulative_count
- Assert: output dates match, output counts equal cumulative_count values

**Test: "forward-fills missing dates within a group"**
- Input: one group with dates 2025-01-01 (cumulative=5) and 2025-01-03 (cumulative=7), missing 2025-01-02
- Second group with all 3 dates
- Assert: at 2025-01-02, first group's contribution is 5 (forward-filled)

**Test: "produces monotonically non-decreasing totals"** (KEY regression test)
- Input: 3 groups with SPARSE data (not all groups present at every date):
  ```typescript
  const groups: GroupedTimeSeries[] = [
    { group: 'Definitive', values: [
      { entry_date: '2025-01-01', count: 10, cumulative_count: 10 },
      { entry_date: '2025-01-03', count: 5, cumulative_count: 15 },
    ]},
    { group: 'Moderate', values: [
      { entry_date: '2025-01-01', count: 3, cumulative_count: 3 },
      { entry_date: '2025-01-02', count: 2, cumulative_count: 5 },
    ]},
    { group: 'Limited', values: [
      { entry_date: '2025-01-02', count: 1, cumulative_count: 1 },
      { entry_date: '2025-01-03', count: 1, cumulative_count: 2 },
    ]},
  ];
  ```
- Assert: result is monotonically non-decreasing:
  - 2025-01-01: 10 + 3 + 0 = 13
  - 2025-01-02: 10 + 5 + 1 = 16 (10 forward-filled from Definitive)
  - 2025-01-03: 15 + 5 + 2 = 22 (5 forward-filled from Moderate)
- Assert: each subsequent count >= previous count

**Test: "handles null/undefined values array"**
- Input: `[{ group: 'A', values: undefined as any }]`
- Assert: result is `[]` (defensive handling via `?? []`)

**Test: "correctly sums across multiple groups at same date"**
- Input: 2 groups both with entry at same date
- Assert: total is sum of both cumulative_counts

**Test: "dates are sorted chronologically"**
- Input: group with dates in reverse order
- Assert: output dates are sorted ascending

2. Fix Traefik TLS routing in `docker-compose.yml`:

Modify the `api` service labels section (lines 201-210):
- Change line 202 from:
  `- "traefik.http.routers.api.rule=PathPrefix(\`/api\`)"`
  to:
  `- "traefik.http.routers.api.rule=Host(\`sysndd.dbmr.unibe.ch\`) && PathPrefix(\`/api\`)"`

Modify the `app` service labels section (lines 237-242):
- Change line 239 from:
  `- "traefik.http.routers.app.rule=PathPrefix(\`/\`)"`
  to:
  `- "traefik.http.routers.app.rule=Host(\`sysndd.dbmr.unibe.ch\`) && PathPrefix(\`/\`)"`

IMPORTANT:
- Do NOT modify docker-compose.override.yml (development does not need Host() matchers since it runs on localhost)
- Do NOT modify docker-compose.dev.yml
- Do NOT change any other labels, ports, or configuration
- The Host() matcher is combined with `&&` (not `||`) per Traefik v3 syntax
  </action>
  <verify>
    - `cd /home/bernt-popp/development/sysndd/app && npx vitest run src/utils/__tests__/timeSeriesUtils.spec.ts` -- all tests pass
    - Test count >= 8
    - `grep "Host" docker-compose.yml` shows Host matcher on both api and app router rules
    - `grep -c "Host(\`sysndd.dbmr.unibe.ch\`)" docker-compose.yml` returns 2 (api + app)
    - `docker compose -f docker-compose.yml config` validates without errors (YAML syntax check)
  </verify>
  <done>
    - All unit tests pass for mergeGroupedCumulativeSeries()
    - Monotonically non-decreasing regression test with sparse data passes (DISP-05)
    - Forward-fill test confirms sparse data handling (DISP-04)
    - docker-compose.yml has Host() matchers on both api and app routers (INFRA-01)
    - Requirements DISP-04, DISP-05, INFRA-01, INFRA-02, TEST-02 (Phase 80 portion) satisfied
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `cd app && npx tsc --noEmit`
2. All vitest tests pass: `cd app && npx vitest run src/utils/__tests__/timeSeriesUtils.spec.ts`
3. ESLint passes: `cd app && npx eslint src/utils/timeSeriesUtils.ts src/views/admin/AdminStatistics.vue`
4. docker-compose.yml validates: `docker compose -f docker-compose.yml config`
5. Host() matchers present on both routers: `grep "Host" docker-compose.yml`
6. No regression in existing frontend tests: `cd app && npm run test:unit`
</verification>

<success_criteria>
- mergeGroupedCumulativeSeries() correctly forward-fills sparse cumulative data (DISP-04)
- Entity trend chart produces monotonically non-decreasing totals at all granularities (DISP-05)
- Traefik router rules include Host() matchers for deterministic TLS cert selection (INFRA-01)
- No "No domain found" warnings expected from Traefik at startup (INFRA-02)
- 8+ TypeScript unit tests pass with sparse data fixtures (TEST-02)
- No regression in existing frontend tests
</success_criteria>

<output>
After completion, create `.planning/phases/80-foundation-fixes/80-02-SUMMARY.md`
</output>
