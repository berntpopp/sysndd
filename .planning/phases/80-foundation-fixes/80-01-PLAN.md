---
phase: 80-foundation-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/functions/category-normalization.R
  - api/functions/endpoint-functions.R
  - api/endpoints/comparisons_endpoints.R
  - api/start_sysndd_api.R
  - api/tests/testthat/test-unit-category-normalization.R
autonomous: true

must_haves:
  truths:
    - "CurationComparisons table shows each database's own category rating for every gene, not a cross-database maximum"
    - "The definitive_only filter shows genes where the displayed database rates them as Definitive, not genes where any database does"
    - "Category normalization logic exists in exactly one place (DRY)"
    - "R unit tests pass for normalize_comparison_categories() with multi-source fixtures"
  artifacts:
    - path: "api/functions/category-normalization.R"
      provides: "Shared normalize_comparison_categories() helper"
      exports: ["normalize_comparison_categories"]
    - path: "api/functions/endpoint-functions.R"
      provides: "generate_comparisons_list() without cross-database max aggregation"
      contains: "normalize_comparison_categories"
    - path: "api/endpoints/comparisons_endpoints.R"
      provides: "upset endpoint using shared normalization helper"
      contains: "normalize_comparison_categories"
    - path: "api/tests/testthat/test-unit-category-normalization.R"
      provides: "Unit tests for category normalization with multi-source fixtures"
      min_lines: 50
  key_links:
    - from: "api/functions/endpoint-functions.R"
      to: "api/functions/category-normalization.R"
      via: "function call"
      pattern: "normalize_comparison_categories\\("
    - from: "api/endpoints/comparisons_endpoints.R"
      to: "api/functions/category-normalization.R"
      via: "function call"
      pattern: "normalize_comparison_categories\\("
    - from: "api/start_sysndd_api.R"
      to: "api/functions/category-normalization.R"
      via: "source() call"
      pattern: "source.*category-normalization"
---

<objective>
Fix CurationComparisons (#173) so each database's own category rating is preserved (no cross-database max aggregation) and extract duplicated category normalization into a shared helper.

Purpose: Bug #173 causes the CurationComparisons table to collapse per-source category values into a cross-database maximum via `group_by(symbol) %>% mutate(category_id = min(category_id))`. This means when gene X is "Definitive" in SysNDD but "Limited" in gene2phenotype, both columns show "Definitive". The `definitive_only` filter is also broken because it filters on this collapsed value instead of per-source values.

Output: `api/functions/category-normalization.R` (shared helper), fixed `endpoint-functions.R` and `comparisons_endpoints.R`, and unit tests verifying multi-source category preservation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/80-foundation-fixes/80-RESEARCH.md

@api/functions/endpoint-functions.R
@api/endpoints/comparisons_endpoints.R
@api/start_sysndd_api.R
@api/tests/testthat/test-unit-comparisons-functions.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract normalize_comparison_categories() and fix generate_comparisons_list()</name>
  <files>
    api/functions/category-normalization.R
    api/functions/endpoint-functions.R
    api/endpoints/comparisons_endpoints.R
    api/start_sysndd_api.R
  </files>
  <action>
1. Create `api/functions/category-normalization.R` with the `normalize_comparison_categories(data)` function:
   - Accept a data frame with `list` and `category` columns
   - Map source-specific category values to standard SysNDD categories using `dplyr::mutate()` + `dplyr::case_when()`
   - Mappings (copy from lines 69-93 of endpoint-functions.R):
     - gene2phenotype: strong/definitive -> Definitive, limited -> Limited, moderate -> Moderate, refuted/disputed -> Refuted, "both rd and if" -> Definitive
     - panelapp: "3" -> Definitive, "2" -> Limited, "1" -> Refuted
     - sfari: "1" -> Definitive, "2" -> Moderate, "3" -> Limited, NA -> Definitive
     - geisinger_DBD: all -> Definitive
     - radboudumc_ID: all -> Definitive
     - Default (SysNDD, omim_ndd, orphanet_id): keep existing category
   - Use `tolower()` for gene2phenotype comparisons (case-insensitive)
   - Return the data frame with normalized `category` column
   - Add roxygen2 documentation

2. Fix `api/functions/endpoint-functions.R` `generate_comparisons_list()`:
   - Replace lines 68-100 (the inline normalization + cross-database max aggregation block) with:
     ```r
     ndd_database_comparison_table_norm <- ndd_database_comparison_table_col %>%
       normalize_comparison_categories()
     ```
   - REMOVE the cross-database max aggregation entirely (lines 94-100):
     - Remove the `left_join(status_categories_list, ...)` on line 94
     - Remove `group_by(symbol) %>% mutate(category_id = min(category_id)) %>% ungroup()` on lines 96-98
     - Remove `select(-category) %>% left_join(status_categories_list, ...)` on lines 99-100
   - The `status_categories_list` query (lines 61-64) is no longer needed for this function -- remove it
   - In the `table_data` assignment (line 106-108), change `category = max_category` to just `category`:
     ```r
     table_data <- ndd_database_comparison_table_norm %>%
       select(symbol, hgnc_id, list, category) %>%
       unique()
     ```
   - The `definitive_only` filter (lines 112-115) now correctly filters per-source because `category` is the per-source normalized value, not the cross-database max

3. Fix `api/endpoints/comparisons_endpoints.R` upset endpoint (lines 99-159):
   - Replace the inline category normalization block (lines 126-143) with a call to the shared helper:
     ```r
     filtered_data <- filtered_data %>%
       normalize_comparison_categories() %>%
       filter(category == "Definitive")
     ```
   - Remove the temporary `normalized_category` column approach; the shared helper normalizes `category` directly
   - Update the filter from `normalized_category == "Definitive"` to `category == "Definitive"`

4. Add `source("functions/category-normalization.R", local = TRUE)` in `api/start_sysndd_api.R`:
   - Insert BEFORE the `source("functions/endpoint-functions.R", ...)` line (line 123)
   - This ensures the helper is available when endpoint-functions.R is sourced

IMPORTANT: Do NOT touch the `generate_panels_list()` function or `generate_stat_tibble()` function in endpoint-functions.R. Those use `group_by(symbol) %>% mutate(category_id = min(category_id))` for a DIFFERENT purpose (computing max category per gene within SysNDD itself, not across databases). That logic is correct for those functions.
  </action>
  <verify>
    - `grep -c "normalize_comparison_categories" api/functions/category-normalization.R` returns >= 1
    - `grep -c "normalize_comparison_categories" api/functions/endpoint-functions.R` returns >= 1
    - `grep -c "normalize_comparison_categories" api/endpoints/comparisons_endpoints.R` returns >= 1
    - `grep -c "group_by(symbol)" api/functions/endpoint-functions.R` returns 0 for the generate_comparisons_list function (still present in generate_panels_list and generate_stat_tibble)
    - `grep -c "category-normalization" api/start_sysndd_api.R` returns 1
    - `grep "normalized_category" api/endpoints/comparisons_endpoints.R` returns no matches (removed temp column)
    - R syntax check: `Rscript -e "parse('api/functions/category-normalization.R')"` exits 0
  </verify>
  <done>
    - normalize_comparison_categories() exists as a standalone shared function
    - generate_comparisons_list() uses the shared helper and does NOT aggregate categories across databases
    - upset endpoint uses the shared helper instead of inline duplication
    - start_sysndd_api.R sources the new file before endpoint-functions.R
    - generate_panels_list() and generate_stat_tibble() are NOT modified
  </done>
</task>

<task type="auto">
  <name>Task 2: Add R unit tests for category normalization with multi-source fixtures</name>
  <files>api/tests/testthat/test-unit-category-normalization.R</files>
  <action>
Create `api/tests/testthat/test-unit-category-normalization.R` following the test file pattern from `test-unit-comparisons-functions.R`:

1. File header: Determine `api_dir` using the same pattern as test-unit-comparisons-functions.R (lines 9-17)
2. Load required packages: testthat, tibble, dplyr
3. Source the function: `source(file.path(api_dir, "functions/category-normalization.R"))`

Test cases to write:

**Test: "normalize_comparison_categories maps gene2phenotype categories correctly"**
- Fixture: tibble with list="gene2phenotype" and categories: "strong", "Definitive", "limited", "Moderate", "refuted", "disputed", "both rd and if"
- Assert: all map to correct standard categories (Definitive, Definitive, Limited, Moderate, Refuted, Refuted, Definitive)

**Test: "normalize_comparison_categories maps panelapp confidence levels"**
- Fixture: tibble with list="panelapp" and categories: "3", "2", "1"
- Assert: maps to Definitive, Limited, Refuted

**Test: "normalize_comparison_categories maps sfari gene scores"**
- Fixture: tibble with list="sfari" and categories: "1", "2", "3", NA
- Assert: maps to Definitive, Moderate, Limited, Definitive

**Test: "normalize_comparison_categories maps geisinger_DBD and radboudumc_ID to Definitive"**
- Fixture: tibble with rows for both lists, various category values
- Assert: all map to Definitive

**Test: "normalize_comparison_categories preserves SysNDD and omim_ndd categories"**
- Fixture: tibble with list="SysNDD" and categories "Definitive", "Limited", "Moderate"
- Assert: categories unchanged

**Test: "per-source categories are preserved, not collapsed to cross-database max"**
- This is the KEY regression test
- Fixture: multi-source tibble where SAME gene has different categories across sources:
  ```r
  fixture <- tibble::tribble(
    ~symbol, ~hgnc_id, ~list, ~category,
    "GENE1", "HGNC:1", "SysNDD", "Definitive",
    "GENE1", "HGNC:1", "gene2phenotype", "limited",
    "GENE1", "HGNC:1", "panelapp", "2",
    "GENE2", "HGNC:2", "SysNDD", "Limited",
    "GENE2", "HGNC:2", "sfari", "1"
  )
  ```
- Call `normalize_comparison_categories(fixture)`
- Assert: GENE1's SysNDD row has "Definitive", GENE1's gene2phenotype row has "Limited", GENE1's panelapp row has "Limited"
- Assert: GENE2's SysNDD row has "Limited" (NOT "Definitive"), GENE2's sfari row has "Definitive"
- This verifies the bug fix: each source keeps its own category

**Test: "normalize_comparison_categories handles empty input"**
- Fixture: empty tibble with list and category columns
- Assert: returns 0-row tibble with same columns

**Test: "normalize_comparison_categories result is not grouped"**
- Fixture: any multi-row tibble
- Call normalize_comparison_categories()
- Assert: `dplyr::is_grouped_df(result)` returns FALSE (Pitfall 1 defense)

**Test: "normalize_comparison_categories handles case-insensitive gene2phenotype"**
- Fixture: gene2phenotype entries with mixed case: "Strong", "STRONG", "strong"
- Assert: all map to "Definitive"
  </action>
  <verify>
    - `cd /home/bernt-popp/development/sysndd && Rscript -e "testthat::test_file('api/tests/testthat/test-unit-category-normalization.R')"` -- all tests pass
    - Test count >= 9
  </verify>
  <done>
    - All unit tests pass for normalize_comparison_categories()
    - Multi-source regression test confirms per-source categories are preserved
    - Empty input, case insensitivity, and ungrouped output all verified
    - Requirements DISP-01, DISP-02, DISP-03, TEST-01 (Phase 80 portion) satisfied
  </done>
</task>

</tasks>

<verification>
1. R syntax check passes for all modified files
2. All unit tests in test-unit-category-normalization.R pass
3. Existing tests in test-unit-comparisons-functions.R still pass (no regression)
4. `grep -c "group_by(symbol)" api/functions/endpoint-functions.R` confirms generate_comparisons_list no longer has cross-database aggregation
5. `grep -c "normalize_comparison_categories" api/functions/endpoint-functions.R api/endpoints/comparisons_endpoints.R` confirms shared helper is used in both places
6. `make lint-api` passes (lintr clean)
</verification>

<success_criteria>
- normalize_comparison_categories() is a standalone reusable function (DISP-02)
- generate_comparisons_list() returns per-source category values without cross-database max aggregation (DISP-01)
- definitive_only filter works per-source (DISP-03)
- upset endpoint uses shared helper instead of inline duplication (DISP-02)
- 9+ unit tests pass with multi-source test fixtures (TEST-01)
- No regression in existing comparisons tests
</success_criteria>

<output>
After completion, create `.planning/phases/80-foundation-fixes/80-01-SUMMARY.md`
</output>
