---
phase: 12-vite-migration
plan: 03
type: execute
wave: 2
depends_on: [12-01]
files_modified:
  - app/.env
  - app/.env.development
  - app/.env.docker
  - app/.env.production
  - app/src/plugins/axios.js
  - app/src/registerServiceWorker.js
  - app/src/assets/js/constants/url_constants.js
  - app/src/assets/js/mixins/tableMethodsMixin.js
  - app/src/views/*.vue
  - app/src/components/**/*.vue
autonomous: true

must_haves:
  truths:
    - "All .env files use VITE_* prefix instead of VUE_APP_*"
    - "All source files use import.meta.env instead of process.env"
    - "import.meta.env.VITE_API_URL pattern exists in source code"
  artifacts:
    - path: "app/.env.docker"
      provides: "Docker mode environment configuration"
      contains: "VITE_API_URL"
    - path: "app/src/plugins/axios.js"
      provides: "Axios configuration with Vite env vars"
      contains: "import.meta.env"
  key_links:
    - from: "app/src/**/*.vue"
      to: ".env files"
      via: "import.meta.env"
      pattern: "import\\.meta\\.env\\.VITE_"
---

<objective>
Migrate all environment variables from Vue CLI format (VUE_APP_*) to Vite format (VITE_*) across all source files.

Purpose: Vite uses import.meta.env instead of process.env, and requires VITE_ prefix for client-exposed variables.
Output: All 152 environment variable references migrated, all .env files updated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-vite-migration/12-RESEARCH.md
@.planning/phases/12-vite-migration/12-01-SUMMARY.md
@app/.env
@app/.env.development
@app/.env.docker
@app/.env.production
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update .env files with VITE_ prefix</name>
  <files>app/.env, app/.env.development, app/.env.docker, app/.env.production</files>
  <action>
Update all environment files to use VITE_ prefix:

**app/.env.development:**
```
VITE_API_URL="http://localhost:7778/api"
VITE_URL="http://localhost:5173"
```
Note: Changed port from 8080 to 5173 (Vite default)

**app/.env.docker:**
```
VITE_API_URL="http://localhost"
VITE_URL="http://localhost"
VITE_MODE="docker"
```

**app/.env.production:**
```
VITE_API_URL="https://sysndd.org/api"
VITE_URL="https://sysndd.org"
```

**app/.env** (base file - update comment only):
```
# Base env file - loaded in all modes
# Mode-specific files override these values:
# - .env.development  -> npm run dev (local API on port 7778)
# - .env.docker       -> Docker Compose build (API via Traefik)
# - .env.production   -> Production deployment
#
# Vite exposes variables with VITE_ prefix to the client
# Do NOT put secrets here - they will be visible in browser
```

Keep the original VUE_APP_* variables commented out temporarily for reference during migration.
  </action>
  <verify>
```bash
# Check all .env files have VITE_ variables
for f in app/.env.development app/.env.docker app/.env.production; do
  grep -q "VITE_" "$f" && echo "PASS: $f has VITE_ vars" || echo "FAIL: $f missing VITE_ vars"
done
```
  </verify>
  <done>All .env files updated with VITE_ prefix for environment variables</done>
</task>

<task type="auto">
  <name>Task 2: Migrate process.env references in source files</name>
  <files>app/src/**/*.js, app/src/**/*.vue</files>
  <action>
Replace all 152 occurrences of process.env.VUE_APP_* with import.meta.env.VITE_*:

**Pattern replacement:**
- `process.env.VUE_APP_API_URL` → `import.meta.env.VITE_API_URL`
- `process.env.VUE_APP_URL` → `import.meta.env.VITE_URL`
- `process.env.VUE_APP_MODE` → `import.meta.env.VITE_MODE`

**Key files requiring updates (48 files total):**

1. **Core config files:**
   - app/src/plugins/axios.js (1 reference)
   - app/src/registerServiceWorker.js (1 reference)
   - app/src/assets/js/constants/url_constants.js (1 reference)
   - app/src/assets/js/mixins/tableMethodsMixin.js (2 references)

2. **Views with API URLs:** (multiple references each)
   - app/src/views/Login.vue
   - app/src/views/Register.vue
   - app/src/views/User.vue
   - app/src/views/PasswordReset.vue
   - app/src/views/API.vue
   - app/src/views/pages/*.vue
   - app/src/views/curate/*.vue
   - app/src/views/admin/*.vue
   - app/src/views/review/Review.vue

3. **Components with API calls:**
   - app/src/components/tables/*.vue
   - app/src/components/analyses/*.vue
   - app/src/components/HelperBadge.vue
   - app/src/components/small/LogoutCountdownBadge.vue

Use search and replace across all files. Verify each file compiles after changes.

**Also update any process.env.NODE_ENV references:**
- `process.env.NODE_ENV === 'development'` → `import.meta.env.DEV`
- `process.env.NODE_ENV === 'production'` → `import.meta.env.PROD`
- `process.env.NODE_ENV` → `import.meta.env.MODE`

Vite provides built-in DEV, PROD, and MODE variables.
  </action>
  <verify>
```bash
# Count remaining process.env references (should be 0)
grep -r "process\.env\.VUE_APP" app/src/ 2>/dev/null | wc -l | xargs -I {} test {} -eq 0 && echo "PASS: No VUE_APP_ references" || echo "FAIL: VUE_APP_ references remain"

# Count new import.meta.env references (should be ~152)
grep -r "import\.meta\.env\.VITE_" app/src/ 2>/dev/null | wc -l
```
  </verify>
  <done>All 152 process.env.VUE_APP_* references replaced with import.meta.env.VITE_*</done>
</task>

<task type="auto">
  <name>Task 3: Verify no process.env references remain</name>
  <files>app/src/**/*</files>
  <action>
Final verification sweep for any remaining process.env usages:

1. Search for any `process.env` patterns in src/:
   ```bash
   grep -r "process\.env" app/src/
   ```

2. If any found that are NOT in comments:
   - Evaluate if they need migration to import.meta.env
   - NODE_ENV checks should use import.meta.env.DEV/PROD/MODE

3. Check for any indirect process usage through variables:
   ```javascript
   // Bad pattern - won't work in Vite
   const env = process.env;
   const apiUrl = env.VUE_APP_API_URL;
   ```

4. Document any process.env that CANNOT be migrated (none expected).

Note: Some node_modules may have process.env references - those are OK, they run in Node.js during build, not in browser.
  </action>
  <verify>
```bash
# Final check - no process.env in app/src (excluding comments)
grep -r "process\.env" app/src/ --include="*.js" --include="*.vue" 2>/dev/null | grep -v "^.*//.*process\.env" | grep -v "^.*\*.*process\.env" | wc -l | xargs -I {} test {} -eq 0 && echo "PASS: No process.env in source" || echo "FAIL: process.env still in source"
```
  </verify>
  <done>Verification complete - no unmigrated process.env references in source code</done>
</task>

</tasks>

<verification>
1. `grep -r "VUE_APP_" app/.env*` returns only commented lines
2. `grep -r "VITE_" app/.env*` shows all environment variables
3. `grep -r "process\.env\.VUE_APP" app/src/` returns nothing (0 results)
4. `grep -r "import\.meta\.env\.VITE_" app/src/` returns ~152 results
5. Application loads environment variables correctly (tested in Plan 05)
</verification>

<success_criteria>
- All 4 .env files use VITE_* prefix
- All 152 source file references use import.meta.env.VITE_*
- No process.env.VUE_APP_* patterns remain in src/
- NODE_ENV checks use import.meta.env.DEV/PROD where applicable
- import.meta.env.VITE_API_URL pattern is findable via grep (immediate verification)
</success_criteria>

<output>
After completion, create `.planning/phases/12-vite-migration/12-03-SUMMARY.md`
</output>
