---
phase: 12-vite-migration
plan: 05
type: execute
wave: 3
depends_on: [12-01, 12-02, 12-03, 12-04]
files_modified:
  - app/Dockerfile
  - app/Dockerfile.dev
  - docker-compose.override.yml
autonomous: true

must_haves:
  truths:
    - "Vite dev server starts successfully in Docker container"
    - "Hot Module Replacement (HMR) works for file changes in Docker"
    - "Production Docker build succeeds with Vite"
  artifacts:
    - path: "app/Dockerfile.dev"
      provides: "Development Dockerfile for Vite dev server"
      contains: "npm run dev"
    - path: "app/Dockerfile"
      provides: "Production Dockerfile with Vite build"
      contains: "npm run build:vite"
    - path: "docker-compose.override.yml"
      provides: "Development overrides with Vite port 5173"
      contains: "5173"
  key_links:
    - from: "app/Dockerfile.dev"
      to: "app/vite.config.js"
      via: "dev server command"
      pattern: "npm run dev"
---

<objective>
Update Docker configuration to use Vite for both development (with HMR) and production builds.

Purpose: Docker is the primary development workflow - HMR must work reliably in containers.
Output: Dockerfile.dev and Dockerfile using Vite, docker-compose.override.yml updated for port 5173.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-vite-migration/12-RESEARCH.md
@.planning/phases/12-vite-migration/12-01-SUMMARY.md
@.planning/phases/12-vite-migration/12-02-SUMMARY.md
@.planning/phases/12-vite-migration/12-03-SUMMARY.md
@.planning/phases/12-vite-migration/12-04-SUMMARY.md
@app/Dockerfile
@app/Dockerfile.dev
@docker-compose.override.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update app/Dockerfile.dev for Vite</name>
  <files>app/Dockerfile.dev</files>
  <action>
Update the development Dockerfile to use Vite instead of Vue CLI:

```dockerfile
# Development Dockerfile for Vue.js with Vite Hot Module Reload
#
# Purpose: Development environment with Vite dev server HMR
# NOT FOR PRODUCTION - Use app/Dockerfile for production builds
#
# Source code is mounted via docker-compose.override.yml or Compose Watch
# This file only installs dependencies; source code comes from volume mount
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.override.yml up app

# Match production Node version (24 LTS for Vite 7 compatibility)
ARG NODE_VERSION=24

FROM node:${NODE_VERSION}-alpine

# Set working directory
WORKDIR /app

# Copy dependency manifests
COPY package*.json ./

# Install dependencies with BuildKit cache mount
# --legacy-peer-deps required by existing package.json (matches production)
RUN --mount=type=cache,target=/root/.npm \
    npm ci --no-audit --no-fund --legacy-peer-deps

# Environment variables for Vite dev server
ENV NODE_ENV=development
ENV HOST=0.0.0.0

# Expose Vite dev server port
EXPOSE 5173

# Health check with longer start-period for Vite first compilation
# Vite is faster than webpack, but first load still takes time
# Use 127.0.0.1 instead of localhost (IPv6 resolution issues in Alpine)
HEALTHCHECK --interval=30s --timeout=5s --start-period=60s --retries=3 \
    CMD wget --spider --tries=1 --no-verbose http://127.0.0.1:5173/ || exit 1

# Start Vite dev server
# --host 0.0.0.0 allows external connections (required for Docker/Traefik)
# --mode docker uses .env.docker with correct API URL (through Traefik)
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--mode", "docker"]
```

Key changes from previous version:
- NODE_VERSION 20 → 24 (Vite 7 requirement)
- Port 8080 → 5173 (Vite default)
- `npm run serve` → `npm run dev` (Vite command)
- Shorter start-period (60s vs 120s) - Vite is faster
- Removed NODE_OPTIONS heap size (Vite is more memory efficient)
  </action>
  <verify>
```bash
# Check key values in Dockerfile.dev
grep -q "EXPOSE 5173" app/Dockerfile.dev && echo "PASS: Port 5173 exposed" || echo "FAIL: Wrong port"
grep -q "npm run dev" app/Dockerfile.dev && echo "PASS: Uses npm run dev" || echo "FAIL: Wrong command"
grep -q "NODE_VERSION=24" app/Dockerfile.dev && echo "PASS: Node 24" || echo "FAIL: Wrong Node version"
```
  </verify>
  <done>Dockerfile.dev updated for Vite with port 5173, Node 24, and npm run dev command</done>
</task>

<task type="auto">
  <name>Task 2: Update app/Dockerfile for Vite production build</name>
  <files>app/Dockerfile</files>
  <action>
Update the production Dockerfile to use Vite build:

```dockerfile
# Build arguments
ARG NODE_VERSION=24
ARG NGINX_VERSION=1.27.4
ARG VUE_MODE=docker

# Stage 1: Build Vue.js application with Vite
FROM node:${NODE_VERSION}-alpine AS builder

# Build mode: docker (default), production, development
ARG VUE_MODE

# Set working directory
WORKDIR /app

# Copy dependency manifests (cache optimization layer)
COPY package*.json ./

# Install dependencies with BuildKit cache mount
# --legacy-peer-deps required by existing package.json
RUN --mount=type=cache,target=/root/.npm \
    npm ci --no-audit --no-fund --legacy-peer-deps

# Copy application source
COPY . .

# Build production bundle with Vite
RUN npm run build:vite -- --mode ${VUE_MODE}


# Stage 2: Production nginx server (using pre-built brotli image)
# fholzer/nginx-brotli has brotli pre-compiled - no 5 min compilation!
# Source: https://hub.docker.com/r/fholzer/nginx-brotli
FROM fholzer/nginx-brotli:latest AS production

# Configure for non-root operation (similar to nginx-unprivileged)
# Create nginx user if not exists and set permissions
RUN sed -i 's/listen\s*80;/listen 8080;/g' /etc/nginx/conf.d/default.conf 2>/dev/null || true \
    && sed -i 's/pid\s*\/var\/run\/nginx.pid;/pid \/tmp\/nginx.pid;/g' /etc/nginx/nginx.conf \
    && mkdir -p /var/cache/nginx /var/log/nginx /tmp \
    && chown -R nginx:nginx /var/cache/nginx /var/log/nginx /etc/nginx/conf.d /usr/share/nginx/html

# Copy nginx configuration (overwrites defaults)
COPY --chown=nginx:nginx ./docker/nginx/local.conf /etc/nginx/conf.d/default.conf
COPY --chown=nginx:nginx ./docker/nginx/nginx.conf /etc/nginx/nginx.conf

# Set working directory to nginx asset directory
WORKDIR /usr/share/nginx/html

# Remove default nginx static assets
RUN rm -rf ./*

# Copy static assets from builder stage
COPY --chown=nginx:nginx --from=builder /app/dist .

# Health check using wget (included in Alpine)
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD wget --spider --tries=1 --no-verbose http://localhost:8080/ || exit 1

# Expose non-privileged port
EXPOSE 8080

# Switch to non-root user
USER nginx

# Run nginx
ENTRYPOINT ["nginx", "-g", "daemon off;"]
```

Key changes:
- NODE_VERSION 20 → 24 (Vite 7 compatibility)
- `npm run build` → `npm run build:vite` (Vite build command)
- Updated comment to mention Vite

The nginx stage remains unchanged - it just serves the dist/ folder.
  </action>
  <verify>
```bash
# Check key values in Dockerfile
grep -q "NODE_VERSION=24" app/Dockerfile && echo "PASS: Node 24 default" || echo "FAIL: Wrong Node version"
grep -q "npm run build:vite" app/Dockerfile && echo "PASS: Uses Vite build" || echo "FAIL: Wrong build command"
```
  </verify>
  <done>Dockerfile updated for Vite production build with Node 24</done>
</task>

<task type="auto">
  <name>Task 3: Update docker-compose.override.yml for Vite</name>
  <files>docker-compose.override.yml</files>
  <action>
Update docker-compose.override.yml to use Vite port and configuration:

Changes to the `app` service section:

```yaml
  # FRONT-04, DEV-01, DEV-02: Frontend development with hot-reload
  app:
    # Expose Vite dev server directly for development
    # Use http://localhost:5173 to bypass Traefik routing issues
    ports:
      - "127.0.0.1:5173:5173"
    # Override healthcheck for development
    healthcheck:
      test: ["CMD", "wget", "--spider", "--tries=1", "--no-verbose", "http://127.0.0.1:5173/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    # Override build to use development Dockerfile
    build:
      context: ./app
      dockerfile: Dockerfile.dev
    # Volume mounts for live code changes
    volumes:
      # Mount entire app directory with caching for macOS/Windows performance
      - ./app:/app:cached
      # Anonymous volume for node_modules - CRITICAL for cross-platform
      # Prevents host node_modules from overriding container (native binaries differ)
      - /app/node_modules
    environment:
      NODE_ENV: development
    # Override memory limit from docker-compose.yml (256M is for nginx in prod)
    # Vite dev server needs less memory than webpack but still more than nginx
    deploy:
      resources:
        limits:
          memory: 2048M
    # DEV-05: Compose Watch configuration for frontend
    # Syncs source changes without full container restart
    develop:
      watch:
        # Sync source code changes
        - action: sync
          path: ./app/src
          target: /app/src
          ignore:
            - node_modules/
        # Sync public assets
        - action: sync
          path: ./app/public
          target: /app/public
        # Rebuild on dependency changes
        - action: rebuild
          path: ./app/package.json
        # Rebuild on Vite config changes (was vue.config.js)
        - action: rebuild
          path: ./app/vite.config.js
```

Key changes:
- Port 8080:8080 → 5173:5173
- Healthcheck URL port updated
- start_period 120s → 60s (Vite is faster)
- Memory 4096M → 2048M (Vite uses less memory)
- Watch path vue.config.js → vite.config.js
- Removed NODE_OPTIONS (not needed for Vite)
  </action>
  <verify>
```bash
# Check key values in docker-compose.override.yml
grep -q "5173:5173" docker-compose.override.yml && echo "PASS: Port 5173 mapped" || echo "FAIL: Wrong port"
grep -q "vite.config.js" docker-compose.override.yml && echo "PASS: Watches vite.config.js" || echo "FAIL: Wrong config watch"
```
  </verify>
  <done>docker-compose.override.yml updated for Vite port 5173 and configuration</done>
</task>

</tasks>

<verification>
1. `grep "5173" app/Dockerfile.dev` shows port exposed
2. `grep "npm run dev" app/Dockerfile.dev` shows Vite command
3. `grep "npm run build:vite" app/Dockerfile` shows Vite build
4. `grep "5173:5173" docker-compose.override.yml` shows port mapping
5. `grep "vite.config.js" docker-compose.override.yml` shows config watch
</verification>

<success_criteria>
- Dockerfile.dev uses Vite dev server on port 5173
- Dockerfile uses Vite for production build
- docker-compose.override.yml maps port 5173
- Node 24 LTS is used in both Dockerfiles
- HMR will work (vite.config.js has usePolling: true from Plan 01)
</success_criteria>

<output>
After completion, create `.planning/phases/12-vite-migration/12-05-SUMMARY.md`
</output>
