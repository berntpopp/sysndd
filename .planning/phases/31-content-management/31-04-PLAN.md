---
phase: 31-content-management
plan: 04
type: execute
wave: 3
depends_on:
  - 31-01
  - 31-03
files_modified:
  - app/src/views/admin/ManageAbout.vue
  - app/src/views/help/About.vue
  - app/src/main.ts
autonomous: false

must_haves:
  truths:
    - "Admin edits About page content in markdown textarea with toolbar"
    - "Admin sees live preview pane showing rendered HTML while typing"
    - "Admin can save draft without publishing (two buttons)"
    - "About page content loads from database table"
    - "API endpoint saves and retrieves About content with draft/published versions"
  artifacts:
    - path: "app/src/views/admin/ManageAbout.vue"
      provides: "CMS editor interface"
      min_lines: 200
    - path: "app/src/views/help/About.vue"
      provides: "Public About page loading from API"
      min_lines: 100
  key_links:
    - from: "app/src/views/admin/ManageAbout.vue"
      to: "useCmsContent"
      via: "import composable"
      pattern: "useCmsContent"
    - from: "app/src/views/admin/ManageAbout.vue"
      to: "SectionList"
      via: "import component"
      pattern: "SectionList"
    - from: "app/src/views/help/About.vue"
      to: "/api/about/published"
      via: "axios fetch"
      pattern: "/api/about/published"
---

<objective>
Build the complete ManageAbout CMS editor and update About.vue to load content from the database.

Purpose: Complete the CMS feature by assembling all components into ManageAbout.vue and updating About.vue to dynamically load published content instead of hardcoded HTML.
Output: Fully functional CMS editor for About page with draft/publish workflow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-content-management/31-CONTEXT.md
@.planning/phases/31-content-management/31-RESEARCH.md
@.planning/phases/31-content-management/31-01-SUMMARY.md
@.planning/phases/31-content-management/31-02-SUMMARY.md
@.planning/phases/31-content-management/31-03-SUMMARY.md

# Relevant patterns
@app/src/views/admin/ManageUser.vue (admin view pattern)
@app/src/views/help/About.vue (current About page structure)
@app/src/composables/useCmsContent.ts (API integration)
@app/src/components/cms/SectionList.vue (section management)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register vue-dompurify-html directive globally</name>
  <files>app/src/main.ts</files>
  <action>
Add vue-dompurify-html directive registration to main.ts:

1. Import the directive:
   ```typescript
   import VueDOMPurifyHTML from 'vue-dompurify-html';
   ```

2. Register before app.mount():
   ```typescript
   app.use(VueDOMPurifyHTML);
   ```

This makes v-dompurify-html directive available in all components, replacing unsafe v-html usage with XSS-sanitized rendering.

Place the import after other imports and the app.use() call alongside other plugin registrations (after router, pinia, etc.).
  </action>
  <verify>grep "vue-dompurify-html" app/src/main.ts shows import and app.use</verify>
  <done>vue-dompurify-html directive available globally</done>
</task>

<task type="auto">
  <name>Task 2: Build ManageAbout.vue CMS editor</name>
  <files>app/src/views/admin/ManageAbout.vue</files>
  <action>
Replace the existing stub ManageAbout.vue with a full CMS editor:

```vue
<template>
  <div class="container-fluid">
    <BContainer fluid>
      <!-- Header -->
      <BRow class="justify-content-md-center py-3">
        <BCol col md="11" lg="10">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h3 class="mb-1">
                <i class="bi bi-file-earmark-text me-2" />
                Manage About Page
              </h3>
              <p class="text-muted mb-0">
                Edit the About page content using markdown. Changes are saved as drafts until published.
              </p>
            </div>

            <!-- Status indicator -->
            <div class="text-end">
              <BBadge :variant="isDraft ? 'warning' : 'success'" class="me-2">
                {{ isDraft ? 'Draft' : 'Published' }}
              </BBadge>
              <span v-if="currentVersion" class="text-muted small">
                v{{ currentVersion }}
              </span>
            </div>
          </div>

          <!-- Action buttons -->
          <div class="d-flex gap-2 mb-4">
            <BButton
              variant="outline-secondary"
              :disabled="isSaving || isPublishing"
              @click="handleSaveDraft"
            >
              <BSpinner v-if="isSaving" small class="me-1" />
              <i v-else class="bi bi-save me-1" />
              Save Draft
            </BButton>
            <BButton
              variant="primary"
              :disabled="isSaving || isPublishing || sections.length === 0"
              @click="handlePublish"
            >
              <BSpinner v-if="isPublishing" small class="me-1" />
              <i v-else class="bi bi-send me-1" />
              Publish
            </BButton>

            <!-- Last saved indicator -->
            <div v-if="lastSavedAt" class="ms-auto text-muted small align-self-center">
              <i class="bi bi-clock-history me-1" />
              Last saved: {{ formatTime(lastSavedAt) }}
            </div>
          </div>

          <!-- Error alert -->
          <BAlert v-if="error" variant="danger" dismissible @dismissed="error = null">
            {{ error }}
          </BAlert>

          <!-- Loading state -->
          <div v-if="isLoading" class="text-center py-5">
            <BSpinner label="Loading..." />
            <p class="mt-2 text-muted">Loading content...</p>
          </div>

          <!-- Section editor list -->
          <template v-else>
            <SectionList
              v-if="sections.length > 0"
              :sections="sections"
              @update:sections="sections = $event"
              @section-blur="handleAutosave"
            />

            <BCard v-else class="text-center py-5 bg-light">
              <p class="text-muted mb-3">No sections yet. Add your first section to get started.</p>
              <BButton variant="primary" @click="addInitialSection">
                <i class="bi bi-plus-lg me-1" />
                Add First Section
              </BButton>
            </BCard>
          </template>
        </BCol>
      </BRow>

      <!-- Publish confirmation modal -->
      <BModal
        v-model="showPublishModal"
        title="Publish Content"
        ok-title="Publish"
        ok-variant="primary"
        @ok="confirmPublish"
      >
        <p>Are you sure you want to publish these changes?</p>
        <p class="text-muted small mb-0">
          This will make the current content visible to all users on the About page.
          {{ sections.length }} section(s) will be updated.
        </p>
      </BModal>
    </BContainer>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onBeforeUnmount, computed } from 'vue';
import { useCmsContent } from '@/composables';
import type { AboutSection } from '@/types';
import SectionList from '@/components/cms/SectionList.vue';

// CMS content composable
const {
  sections,
  isLoading,
  isSaving,
  isPublishing,
  error,
  lastSavedAt,
  currentVersion,
  isDraft,
  loadDraft,
  saveDraft,
  publish,
  addSection,
} = useCmsContent();

const showPublishModal = ref(false);

// Load content on mount
onMounted(async () => {
  await loadDraft();
});

// Autosave on navigate away
onBeforeUnmount(async () => {
  if (sections.value.length > 0) {
    await saveDraft();
  }
});

// Format time for display
function formatTime(date: Date | null): string {
  if (!date) return '';
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// Handle save draft button
async function handleSaveDraft() {
  const success = await saveDraft();
  if (success) {
    // Could show toast notification here
  }
}

// Handle autosave on blur
async function handleAutosave() {
  if (sections.value.length > 0) {
    await saveDraft();
  }
}

// Handle publish button - show confirmation modal
function handlePublish() {
  showPublishModal.value = true;
}

// Confirm publish from modal
async function confirmPublish() {
  showPublishModal.value = false;
  const success = await publish();
  if (success) {
    // Could show success toast
  }
}

// Add first section with default content
function addInitialSection() {
  addSection({
    section_id: 'section-' + Date.now(),
    title: 'New Section',
    icon: 'bi-info-circle',
    content: '# Welcome\n\nStart editing your content here...',
  });
}
</script>

<style scoped>
/* Minimal custom styling - rely on Bootstrap */
</style>
```
  </action>
  <verify>ManageAbout.vue renders without errors, shows SectionList component</verify>
  <done>ManageAbout.vue provides full CMS editing interface with draft/publish workflow</done>
</task>

<task type="auto">
  <name>Task 3: Update About.vue to load content from API</name>
  <files>app/src/views/help/About.vue</files>
  <action>
Update About.vue to dynamically load published content from API instead of hardcoded HTML.

The key changes:
1. Import useCmsContent and useMarkdownRenderer
2. Fetch published content on mount via loadPublished()
3. Render sections dynamically using v-for
4. Use v-dompurify-html for markdown content
5. Keep the accordion structure but with dynamic data
6. Fall back to loading/error states

```vue
<template>
  <div class="container-fluid bg-light">
    <BSpinner
      v-if="loading"
      label="Loading..."
      class="d-block mx-auto my-5"
    />
    <BContainer
      v-else
      fluid
    >
      <BRow class="justify-content-md-center py-4">
        <BCol
          col
          md="10"
          lg="8"
        >
          <!-- Page Header -->
          <div class="text-center mb-4">
            <h2 class="fw-bold text-primary">
              <i class="bi bi-info-circle me-2" />
              About SysNDD
            </h2>
            <p class="text-muted">
              Learn about the SysNDD database, its creators, and how to cite our work
            </p>
          </div>

          <!-- Error state -->
          <BAlert v-if="error" variant="warning" show class="text-center">
            <i class="bi bi-exclamation-triangle me-2" />
            Unable to load content. Please try again later.
          </BAlert>

          <!-- Dynamic Accordion from CMS -->
          <BAccordion v-else-if="sections.length > 0" id="about-accordion">
            <BAccordionItem
              v-for="(section, index) in sections"
              :key="section.section_id"
              :visible="index === 0"
            >
              <template #title>
                <span class="fw-semibold">
                  <i :class="section.icon + ' me-2'" />
                  {{ section.title }}
                </span>
              </template>
              <div class="py-2 about-content" v-dompurify-html="renderMarkdown(section.content)" />
            </BAccordionItem>
          </BAccordion>

          <!-- Empty state -->
          <BAlert v-else variant="info" show class="text-center">
            <i class="bi bi-info-circle me-2" />
            No content available yet.
          </BAlert>
        </BCol>
      </BRow>
    </BContainer>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { useHead } from '@unhead/vue';
import { useCmsContent, renderMarkdown } from '@/composables';
import type { AboutSection } from '@/types';

useHead({
  title: 'About',
  meta: [
    {
      name: 'description',
      content:
        'The About view contains information about the SysNDD curation effort and website.',
    },
  ],
});

const loading = ref(true);
const error = ref<string | null>(null);
const sections = ref<AboutSection[]>([]);

const { loadPublished } = useCmsContent();

onMounted(async () => {
  try {
    sections.value = await loadPublished();
  } catch (err) {
    error.value = err instanceof Error ? err.message : 'Failed to load content';
    console.error('Failed to load About content:', err);
  } finally {
    loading.value = false;
  }
});
</script>

<style scoped>
.bg-light {
  background-color: #f8f9fa !important;
}

/* Markdown content styling */
.about-content :deep(h1),
.about-content :deep(h2),
.about-content :deep(h3),
.about-content :deep(h4),
.about-content :deep(h5),
.about-content :deep(h6) {
  margin-top: 1rem;
  margin-bottom: 0.5rem;
  font-weight: 600;
}

.about-content :deep(p) {
  margin-bottom: 0.75rem;
}

.about-content :deep(ul),
.about-content :deep(ol) {
  padding-left: 1.5rem;
  margin-bottom: 0.75rem;
}

.about-content :deep(a) {
  color: var(--bs-primary);
}

.about-content :deep(blockquote) {
  border-left: 4px solid var(--bs-primary);
  padding-left: 1rem;
  margin-left: 0;
  color: var(--bs-secondary);
}

.about-content :deep(code) {
  background: #f4f4f4;
  padding: 0.125rem 0.25rem;
  border-radius: 0.25rem;
}

.about-content :deep(pre) {
  background: #f4f4f4;
  padding: 1rem;
  border-radius: 0.375rem;
  overflow-x: auto;
}

/* Preserve timeline styling for News section if markdown generates it */
.about-content :deep(.timeline .d-flex) {
  border-left: 2px solid #dee2e6;
  padding-left: 1rem;
  margin-left: 0.5rem;
}
</style>
```

Note: The old hardcoded content is now replaced with dynamic rendering. The initial seed data (from Plan 01) should contain markdown versions of the original 7 sections, so the About page will look similar but now editable.
  </action>
  <verify>About.vue loads content from API and renders markdown sections</verify>
  <done>About.vue dynamically loads published content from database</done>
</task>

</tasks>

<verification>
1. vue-dompurify-html is registered in main.ts
2. ManageAbout.vue has full editor with SectionList, save draft, and publish buttons
3. About.vue fetches from /api/about/published and renders dynamically
4. Draft/publish workflow works end-to-end (needs API running to fully test)
5. npm run type-check passes
6. npm run lint passes
</verification>

<success_criteria>
**CMS-01:** ManageAbout has markdown textarea for content editing (via MarkdownEditor in SectionEditor)
**CMS-02:** ManageAbout has preview pane showing rendered markdown (via MarkdownPreview in SectionEditor)
**CMS-03:** ManageAbout has draft/save workflow (Save Draft / Publish buttons)
**CMS-04:** About page content is stored in database (fetched via /api/about/published)
**CMS-05:** API endpoint for loading and saving About page content (useCmsContent composable)
</success_criteria>

<checkpoint type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete CMS editor for About page with draft/publish workflow</what-built>
  <how-to-verify>
    1. Start the development servers (npm run dev, R API)
    2. Navigate to admin panel -> ManageAbout
    3. Verify you see the section list editor
    4. Add a new section, edit content with markdown
    5. Check live preview updates as you type
    6. Click "Save Draft" - should show success
    7. Click "Publish" - confirm modal appears
    8. Navigate to public About page - should show published content
    9. Verify accordion sections render with icons and formatted content
  </how-to-verify>
  <resume-signal>Type "approved" if CMS works end-to-end, or describe any issues</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/31-content-management/31-04-SUMMARY.md`
</output>
