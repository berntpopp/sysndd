---
phase: 31-content-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/endpoints/about_endpoints.R
  - api/start_sysndd_api.R
autonomous: true

must_haves:
  truths:
    - "API can save draft content for current user"
    - "API can load user's draft or latest published content"
    - "API can publish content creating new version"
    - "API can load published content for public About page"
  artifacts:
    - path: "api/endpoints/about_endpoints.R"
      provides: "CMS CRUD endpoints"
      exports: ["GET draft", "PUT draft", "POST publish", "GET published"]
  key_links:
    - from: "api/endpoints/about_endpoints.R"
      to: "about_content table"
      via: "db_execute_query/db_execute_statement"
      pattern: "about_content"
    - from: "api/start_sysndd_api.R"
      to: "api/endpoints/about_endpoints.R"
      via: "pr_mount"
      pattern: 'pr_mount.*"/api/about"'
---

<objective>
Create backend API endpoints for About page content management with draft/publish workflow.

Purpose: Enable CMS functionality by providing database storage and API endpoints for draft/publish workflow. This is the foundation that all frontend CMS features depend on.
Output: Working API endpoints at `/api/about/` for draft management and content publishing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-content-management/31-CONTEXT.md
@.planning/phases/31-content-management/31-RESEARCH.md

# Relevant source patterns
@api/endpoints/ontology_endpoints.R (API CRUD pattern)
@api/start_sysndd_api.R (endpoint mounting)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create about_content database table</name>
  <files>api/scripts/create_about_content_table.sql</files>
  <action>
Create SQL script to add about_content table for draft/publish workflow:

```sql
CREATE TABLE IF NOT EXISTS `about_content` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `user_id` INT NOT NULL,
  `sections_json` JSON NOT NULL,
  `status` ENUM('draft', 'published') NOT NULL DEFAULT 'draft',
  `version` INT DEFAULT NULL,
  `published_at` TIMESTAMP NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_user_status (user_id, status),
  INDEX idx_status_version (status, version DESC),
  FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
);
```

The sections_json column stores array of section objects:
```json
[
  {
    "section_id": "creators",
    "title": "About SysNDD and its creators",
    "icon": "bi-people",
    "content": "The SysNDD database is based on...",
    "sort_order": 0
  }
]
```

Also seed initial published content by extracting the 7 sections from current About.vue:
- creators (bi-people)
- citation (bi-journal-text)
- funding (bi-cash-stack)
- news (bi-megaphone)
- credits (bi-award)
- disclaimer (bi-shield-exclamation)
- contact (bi-envelope)

Convert HTML content to markdown for seeding. Use user_id=1 (admin) for initial seed.
  </action>
  <verify>SQL script exists and is syntactically valid (can review manually)</verify>
  <done>about_content table schema defined with proper indexes and foreign key</done>
</task>

<task type="auto">
  <name>Task 2: Create about_endpoints.R with draft/publish API</name>
  <files>api/endpoints/about_endpoints.R</files>
  <action>
Create new endpoint file following ontology_endpoints.R patterns:

1. **GET /draft** - Load current user's draft or latest published:
   - Requires Administrator role (use require_role from core/security.R)
   - Query about_content WHERE user_id = req$user_id AND status = 'draft'
   - If no draft exists, return latest published version (status = 'published' ORDER BY version DESC LIMIT 1)
   - Return sections_json parsed as JSON array

2. **PUT /draft** - Save draft for current user:
   - Requires Administrator role
   - Accept JSON body with `sections` array
   - Validate sections array is not empty
   - Upsert pattern: DELETE existing draft for user, INSERT new draft
   - Use db_with_transaction for atomicity
   - Return { message: "Draft saved successfully" }

3. **POST /publish** - Publish content (creates new version):
   - Requires Administrator role
   - Accept JSON body with `sections` array
   - Get next version number: MAX(version) + 1 WHERE status = 'published'
   - INSERT new row with status='published', version=N, published_at=NOW()
   - DELETE user's draft after successful publish
   - Use db_with_transaction for atomicity
   - Return { message: "Content published successfully", version: N }

4. **GET /published** - Load latest published content (public):
   - No auth required (for About.vue public page)
   - Query about_content WHERE status = 'published' ORDER BY version DESC LIMIT 1
   - Return sections_json or empty array if none published

Follow existing patterns:
- Use `#* @tag about` for OpenAPI grouping
- Use `#* @serializer json list(na="string")` for consistent output
- Use parameterized queries with `?` placeholders (not string interpolation)
- Use `db_execute_query()` for SELECT, `db_execute_statement()` for INSERT/UPDATE/DELETE
  </action>
  <verify>File exists with all 4 endpoints documented with roxygen comments</verify>
  <done>about_endpoints.R provides GET draft, PUT draft, POST publish, GET published</done>
</task>

<task type="auto">
  <name>Task 3: Mount about endpoints in start_sysndd_api.R</name>
  <files>api/start_sysndd_api.R</files>
  <action>
Add the about_endpoints.R mount to the plumber router chain:

1. Find the endpoint mounting section (around line 468-497)
2. Add new mount after statistics_endpoints (alphabetical order):
   ```r
   pr_mount("/api/about", pr("endpoints/about_endpoints.R")) %>%
   ```

This mounts all about endpoints at `/api/about/`:
- GET /api/about/draft
- PUT /api/about/draft
- POST /api/about/publish
- GET /api/about/published
  </action>
  <verify>grep -n "about_endpoints" api/start_sysndd_api.R shows mount line</verify>
  <done>About endpoints accessible at /api/about/* paths</done>
</task>

</tasks>

<verification>
1. SQL script exists at api/scripts/create_about_content_table.sql
2. about_endpoints.R exists with 4 endpoints and roxygen documentation
3. start_sysndd_api.R mounts about_endpoints at /api/about
4. All endpoints follow existing security patterns (require_role for admin-only)
</verification>

<success_criteria>
- Database schema supports per-user drafts with version history
- API endpoints handle draft save/load and publish workflow
- Public endpoint serves published content without auth
- All endpoints follow existing codebase patterns
</success_criteria>

<output>
After completion, create `.planning/phases/31-content-management/31-01-SUMMARY.md`
</output>
