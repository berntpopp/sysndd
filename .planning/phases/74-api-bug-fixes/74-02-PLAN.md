---
phase: 74-api-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - api/functions/endpoint-functions.R
  - api/tests/testthat/test-unit-panels-endpoint.R
autonomous: true

must_haves:
  truths:
    - "The Panels browse endpoint loads successfully and returns all panel data"
    - "Column aliases in SQL match the column names referenced in R code"
    - "Filtering by max_category works correctly when max_category=TRUE"
  artifacts:
    - path: "api/functions/endpoint-functions.R"
      provides: "Fixed generate_panels_list with correct column alias handling"
      contains: "generate_panels_list"
    - path: "api/tests/testthat/test-unit-panels-endpoint.R"
      provides: "Unit tests for panels column alias and filtering logic"
  key_links:
    - from: "api/functions/endpoint-functions.R"
      to: "api/endpoints/panels_endpoints.R"
      via: "generate_panels_list called from browse endpoint"
      pattern: "generate_panels_list"
    - from: "api/functions/endpoint-functions.R"
      to: "ndd_entity_status_categories_list table"
      via: "left_join on category_id with max_category alias"
      pattern: "max_category.*category"
---

<objective>
Fix the Panels page 500 error caused by column alias mismatch (API-02, GitHub issue #161).

Purpose: The Panels browse endpoint crashes because the SQL query aliases `category` as `max_category` in the status categories join, but downstream R code references column names inconsistently. When `max_category=TRUE` (the default), the filter expression replaces "category" with "max_category" in the filter string, but the actual tibble column names after joins and selections may not match what the filter expressions expect.

Output: Fixed generate_panels_list function with correct column aliases, plus unit tests for the column naming and filtering logic. Also scan for similar column alias mismatches in related endpoints.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/74-api-bug-fixes/74-CONTEXT.md
@.planning/phases/74-api-bug-fixes/74-RESEARCH.md
@api/functions/endpoint-functions.R
@api/endpoints/panels_endpoints.R
@api/start_sysndd_api.R
@api/tests/testthat/test-unit-endpoint-functions.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix column alias mismatch in generate_panels_list</name>
  <files>api/functions/endpoint-functions.R</files>
  <action>
In `generate_panels_list()` (starting at line 358 of endpoint-functions.R), fix the column alias mismatch:

**Diagnose the bug:** Trace the data flow carefully:

1. Line 384-389: When `max_category=TRUE`, the filter string has "category" replaced with "max_category". So filter expressions will reference a column named `max_category`.

2. Line 449-452: `status_categories_list` is created with `select(category_id, max_category = category)`. This creates a tibble with columns `category_id` and `max_category`.

3. Line 455-471: `sysndd_db_ndd_entity_view` is built from `ndd_entity_view` with columns including `category` and `category_id`. Then `group_by(symbol) %>% mutate(category_id = min(category_id))` computes the max category's ID.

4. Line 470: `left_join(status_categories_list, by = c("category_id"))` adds the `max_category` column from the join.

5. Line 471: `select(-category_id)` removes category_id but both `category` AND `max_category` remain.

6. Line 478-479: `sysndd_db_disease_genes` is built by joining with non_alt_loci_set.

7. Line 481-491: `disease_genes_filter` applies `filter(!!!rlang::parse_exprs(filter_exprs))`. The filter expressions now reference `max_category` (from step 1). The tibble DOES have `max_category` (from step 4). But the issue is that the tibble also has `category` (the original per-entity category), AND the fields parameter includes "category" which gets selected later.

**The actual bug:** The `fields` parameter defaults to include "category" which refers to the per-entity category (e.g., "Definitive; Moderate"). But the column that actually maps the max category per gene is `max_category`. When `output_columns_allowed` in start_sysndd_api.R lists "category", frontend requests "category" in the fields list, but the `select_tibble_fields` function at line 495 selects the `category` column (which still has the per-entity original values, not the max).

**Fix approach:**
1. Read the endpoint carefully and trace what the frontend actually expects. The fields list includes "category" -- the frontend displays whatever column named "category" returns.
2. The fix should ensure that when `max_category=TRUE`, the `category` column in the final output contains the max category value (currently it contains per-entity values). Rename `max_category` to `category` after the join, or overwrite `category` with `max_category`.
3. After the `left_join` at line 470, replace the original `category` column with `max_category`: `select(-category_id, -category) %>% rename(category = max_category)` or equivalent.
4. This ensures `category` in the output contains the max category, and the `max_category` filter expression still works in the pipeline (since the column is named `max_category` until it gets renamed after filtering).

**Important order of operations:** The filter at line 482 uses `max_category` (from the str_replace at line 385-389). So the column MUST be named `max_category` DURING filtering. But after filtering, rename it to `category` for the output so `select_tibble_fields` with `fields="category"` works.

5. Specifically, at line 483-491, after the filter step, add a rename step: if `max_category=TRUE`, rename `max_category` to `category` (and remove the original `category` column if it still exists). The cleanest approach is to overwrite `category` with `max_category` right after the `left_join` and `select(-category_id)`, then adjust the filter replacement logic to still work.

6. **Scan for similar patterns**: Search `endpoint-functions.R` and other endpoint files for similar `left_join` + column alias patterns where the join adds an aliased column but downstream code expects the original name. Check `generate_disease_type_statistics` and any other functions that use `status_categories_list` with the `max_category` pattern.

Do NOT change the output_columns_allowed list or the frontend API contract.
Do NOT change the filter syntax or filter generation logic beyond what's needed for the fix.
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd && make lint-api` to verify no lintr issues.
Manually inspect that:
- The `category` column in the panels output contains the max category when max_category=TRUE
- Filter expressions using `max_category` still work during the filtering step
- The `fields` parameter "category" correctly selects the right column
  </verify>
  <done>
The Panels browse endpoint loads successfully. When max_category=TRUE, the output "category" column contains the maximum category per gene. Column aliases between SQL joins and R code are consistent.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for panels column alias and filtering logic</name>
  <files>api/tests/testthat/test-unit-panels-endpoint.R</files>
  <action>
Create a new test file `api/tests/testthat/test-unit-panels-endpoint.R` with unit tests for the panels logic. These tests exercise the column naming, filtering, and max_category behavior without requiring database access.

Follow the existing test patterns in test-unit-endpoint-functions.R and test-integration-entity.R.

Tests to write:

1. **Test max_category column replaces category correctly**: Create a tibble simulating the joined entity+categories data. Verify that after the max_category logic runs, the output has a `category` column containing the max category values (not the per-entity originals).

2. **Test filter expression with max_category**: Create a filter string with "category" in it, apply the str_replace to get "max_category", then verify the filter expression can be parsed and applied to a tibble that has a `max_category` column. Use `generate_filter_expressions()` from helper-functions.R.

3. **Test fields selection includes category**: Create a tibble with the expected output columns (category, inheritance, symbol, etc.). Verify `select_tibble_fields()` with `fields="category,symbol"` correctly selects these columns.

4. **Test output_columns_allowed match available columns**: Verify that all columns in `output_columns_allowed` (from start_sysndd_api.R: category, inheritance, symbol, hgnc_id, entrez_id, ensembl_gene_id, ucsc_id, bed_hg19, bed_hg38) can be found in a simulated panels result tibble.

5. **Test max_category=FALSE preserves original category**: When max_category=FALSE, the filter string is NOT modified. Verify the `category` column in the output preserves the original per-entity category.

Source helper functions:
```r
source_api_file("functions/helper-functions.R", local = FALSE, envir = globalenv())
```

Do NOT require database access or pool object.
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/api && Rscript -e "testthat::test_file('tests/testthat/test-unit-panels-endpoint.R')"` -- all tests pass.
Run `cd /home/bernt-popp/development/sysndd && make lint-api` -- no lintr issues.
  </verify>
  <done>
Unit tests for panels column alias logic pass, validating that max_category correctly populates the category column, filter expressions work with aliased columns, and field selection matches the API contract.
  </done>
</task>

</tasks>

<verification>
1. `make lint-api` passes with 0 issues
2. `make test-api` passes (all existing tests still pass + new tests pass)
3. The generate_panels_list function produces output where `category` column matches the requested fields
4. Column aliases are consistent between SQL joins and R code
</verification>

<success_criteria>
- Panels browse endpoint with default parameters returns data without 500 error
- The `category` column in panels output contains the max category when max_category=TRUE
- All columns in `output_columns_allowed` are present in the endpoint output
- New unit tests validate the column naming and filtering logic
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/74-api-bug-fixes/74-02-SUMMARY.md`
</output>
