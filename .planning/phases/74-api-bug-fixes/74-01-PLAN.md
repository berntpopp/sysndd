---
phase: 74-api-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/endpoints/entity_endpoints.R
  - api/tests/testthat/test-unit-entity-creation.R
autonomous: true

must_haves:
  truths:
    - "Creating a new entity with direct_approval=TRUE succeeds and returns the created entity without a 500 error"
    - "Creating a new entity with direct_approval=FALSE (normal path) still works correctly"
    - "If direct approval of review or status fails, the endpoint returns an appropriate error (not a misleading 200)"
  artifacts:
    - path: "api/endpoints/entity_endpoints.R"
      provides: "Fixed entity /create endpoint with proper direct approval handling"
      contains: "response_review_approve"
    - path: "api/tests/testthat/test-unit-entity-creation.R"
      provides: "Unit tests for entity creation direct approval logic"
  key_links:
    - from: "api/endpoints/entity_endpoints.R"
      to: "api/functions/legacy-wrappers.R"
      via: "put_db_review_approve and put_db_status_approve calls"
      pattern: "put_db_review_approve|put_db_status_approve"
---

<objective>
Fix the direct approval entity creation 500 error (API-01, GitHub issue #166).

Purpose: When a curator creates a new entity with direct_approval=TRUE (skipping separate review step), the endpoint currently crashes because the return values from put_db_review_approve() and put_db_status_approve() are not checked. If either approval step fails, the error propagates unhandled and produces a 500 response. The fix must ensure both approval paths are checked, errors are handled gracefully, and the endpoint returns 201 Created with the created entity on success.

Output: Fixed entity creation endpoint with proper direct approval error handling, plus unit tests covering both the direct and non-direct approval paths.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/74-api-bug-fixes/74-CONTEXT.md
@.planning/phases/74-api-bug-fixes/74-RESEARCH.md
@api/endpoints/entity_endpoints.R
@api/functions/legacy-wrappers.R
@api/tests/testthat/helper-db.R
@api/tests/testthat/test-integration-entity.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix direct approval error handling in entity creation endpoint</name>
  <files>api/endpoints/entity_endpoints.R</files>
  <action>
In the POST /create endpoint (line ~219), fix the direct_approval flow:

1. **Check review approval result** (around line 368-374): After calling `put_db_review_approve()`, check its return status. If status != 200, log the error and include it in the response aggregation. Currently the return value `response_review_approve` is assigned but never checked.

2. **Check status approval result** (around line 424-430): After calling `put_db_status_approve()`, check its return status. If status != 200, log the error and include it in the response aggregation. Currently the return value `response_status_approve` is assigned but never checked.

3. **Include approval results in response aggregation** (around line 376-384 and 451-460): When `direct_approval` is TRUE, the `response_review_approve` and `response_status_approve` results must be included in the `bind_rows` aggregation that computes the final status and message. This ensures any approval failure surfaces in the response.

4. **Set HTTP status 201 for successful creation**: When the endpoint succeeds (all steps including approval pass), set `res$status <- 201` instead of `res$status <- response_entity$status` (which is 200, an internal status). Per REST conventions, POST creation should return 201 Created.

5. **Review the normal (non-direct) approval path for consistency**: The non-direct path (when direct_approval=FALSE) currently returns `response_entity` on success (line 460). Verify this path is consistent with the direct approval path. Both should return the same response shape.

6. **Scan for similar patterns**: Check review_endpoints.R for similar direct approval flows that might have the same unchecked return value issue. Fix any found.

Do NOT change the function signatures of put_db_review_approve or put_db_status_approve -- they are correct.
Do NOT add new HTTP middleware or error handling framework -- keep the fix minimal and local.
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd && make lint-api` to verify no lintr issues introduced.
Manually inspect the diff to confirm:
- response_review_approve return value is checked when direct_approval=TRUE
- response_status_approve return value is checked when direct_approval=TRUE
- Both results are included in response aggregation
- HTTP 201 is set on successful creation
  </verify>
  <done>
The entity creation endpoint with direct_approval=TRUE properly checks approval return values, aggregates errors, and returns 201 Created on success. The non-direct path returns the same response shape.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for entity creation direct approval logic</name>
  <files>api/tests/testthat/test-unit-entity-creation.R</files>
  <action>
Create a new test file `api/tests/testthat/test-unit-entity-creation.R` with unit tests for the entity creation logic. These tests mock database functions to test the logic without requiring a database connection.

Follow the existing test patterns in test-integration-entity.R and test-unit-endpoint-functions.R.

Tests to write:

1. **Test response aggregation includes approval results**: Create mock response objects for entity creation, review creation, review approval, and status approval. Verify that when direct_approval=TRUE, the aggregation includes all four response statuses. Use the same bind_rows + select(status, message) pattern from the endpoint.

2. **Test approval failure surfaces in response**: Create mock responses where put_db_review_approve returns status 500. Verify the aggregated response has status 500 (via max(status)).

3. **Test status approval failure surfaces in response**: Create mock responses where put_db_status_approve returns status 500. Verify the aggregated response has status 500.

4. **Test successful direct approval flow**: Create mock responses where all steps succeed (status 200). Verify the aggregated response has status 200.

5. **Test non-direct approval flow skips approval steps**: Verify that when direct_approval=FALSE, response_review_approve and response_status_approve are not in the aggregation.

Use `mockery::mock()` if needed, or simply test the response aggregation logic directly by constructing tibbles that match what the endpoint produces.

Source helper files using the established pattern:
```r
source_api_file("functions/helper-functions.R", local = FALSE, envir = globalenv())
```

Do NOT require database access -- these are pure unit tests of the aggregation logic.
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/api && Rscript -e "testthat::test_file('tests/testthat/test-unit-entity-creation.R')"` -- all tests pass.
Run `cd /home/bernt-popp/development/sysndd && make lint-api` -- no lintr issues.
  </verify>
  <done>
Unit tests for entity creation direct approval logic pass, covering both success and failure scenarios for both direct and non-direct approval paths.
  </done>
</task>

</tasks>

<verification>
1. `make lint-api` passes with 0 issues
2. `make test-api` passes (all existing tests still pass + new tests pass)
3. The entity creation endpoint code has explicit checks on put_db_review_approve and put_db_status_approve return values
4. HTTP 201 Created is set on successful entity creation
</verification>

<success_criteria>
- Entity creation with direct_approval=TRUE no longer produces unhandled 500 errors
- Approval failures are properly detected and surfaced in the API response
- Both direct and non-direct approval paths return consistent response shapes
- New unit tests validate the aggregation logic for both paths
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/74-api-bug-fixes/74-01-SUMMARY.md`
</output>
