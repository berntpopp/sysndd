---
phase: 07-api-dockerfile-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/endpoints/health_endpoints.R
  - api/start_sysndd_api.R
autonomous: true
user_setup: []

must_haves:
  truths:
    - "GET /health returns 200 with JSON containing status, timestamp, and version"
    - "Health endpoint does NOT require authentication"
    - "Health endpoint is fast (no database queries)"
  artifacts:
    - path: "api/endpoints/health_endpoints.R"
      provides: "Health check endpoint for Docker HEALTHCHECK"
      exports: ["GET /"]
    - path: "api/start_sysndd_api.R"
      provides: "Mounts health endpoint at /health"
      contains: "pr_mount.*health"
  key_links:
    - from: "api/start_sysndd_api.R"
      to: "api/endpoints/health_endpoints.R"
      via: "pr_mount at /health"
      pattern: 'pr_mount\("/health"'
---

<objective>
Add a /health endpoint to the SysNDD API for Docker HEALTHCHECK compatibility.

Purpose: Docker HEALTHCHECK requires an HTTP endpoint to verify container health. This endpoint must be lightweight (no database queries) and bypass authentication.

Output: Health endpoint mounted at /health returning JSON with status, timestamp, and API version.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-api-dockerfile-optimization/07-RESEARCH.md

@api/start_sysndd_api.R
@api/endpoints/status_endpoints.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create health endpoint file</name>
  <files>api/endpoints/health_endpoints.R</files>
  <action>
Create a new endpoint file `api/endpoints/health_endpoints.R` with a simple health check endpoint:

```r
# api/endpoints/health_endpoints.R
#
# Health check endpoint for Docker HEALTHCHECK.
# This endpoint must be lightweight and NOT require authentication.

#* Health check endpoint for Docker HEALTHCHECK
#*
#* Returns API health status for container orchestration.
#* This endpoint is unauthenticated and does not query the database.
#*
#* @tag health
#* @serializer json
#*
#* @get /
function(req, res) {
  list(
    status = "healthy",
    timestamp = format(Sys.time(), "%Y-%m-%dT%H:%M:%SZ", tz = "UTC"),
    version = sysndd_api_version
  )
}
```

Key requirements:
- Uses `sysndd_api_version` which is defined in the global environment by start_sysndd_api.R
- Returns simple JSON (no database queries for fast response)
- Follows existing endpoint file conventions (roxygen comments, @tag, @serializer)
  </action>
  <verify>File exists at api/endpoints/health_endpoints.R with GET endpoint at /</verify>
  <done>health_endpoints.R file created with /health GET endpoint returning status, timestamp, version</done>
</task>

<task type="auto">
  <name>Task 2: Mount health endpoint in API router</name>
  <files>api/start_sysndd_api.R</files>
  <action>
Modify `api/start_sysndd_api.R` to mount the health endpoint at /health:

1. Find the section where endpoints are mounted (around line 333-351)
2. Add the health endpoint mount BEFORE the other /api/* mounts (line ~333)

Add this line:
```r
pr_mount("/health", pr("endpoints/health_endpoints.R")) %>%
```

Insert it right after `cleanupHook() %>%` and before the first `/api/entity` mount.

This ensures:
- Health endpoint is at /health (not /api/health) - standard convention
- Health endpoint is processed before other routes
- The health endpoint benefits from CORS filter but the check_signin filter will forward unauthenticated GET requests

The existing `checkSignInFilter` already handles unauthenticated GET requests by forwarding them, so /health will work without auth.
  </action>
  <verify>Run `grep -n "health" api/start_sysndd_api.R` to confirm mount is added</verify>
  <done>Health endpoint mounted at /health in start_sysndd_api.R</done>
</task>

<task type="auto">
  <name>Task 3: Test health endpoint syntax</name>
  <files></files>
  <action>
Validate R syntax in the new endpoint file:

```bash
cd /home/bernt-popp/development/sysndd/api
Rscript -e "parse('endpoints/health_endpoints.R')"
```

This ensures the R code parses without syntax errors. A successful parse returns NULL (no output).

If syntax errors exist, they will be printed and the command exits non-zero.

Note: We cannot fully test the endpoint without the Docker environment and database, but syntax validation confirms the code is valid R.
  </action>
  <verify>Rscript parse command exits with code 0 (no syntax errors)</verify>
  <done>health_endpoints.R passes R syntax validation</done>
</task>

</tasks>

<verification>
1. File api/endpoints/health_endpoints.R exists
2. File contains GET endpoint at root path (/)
3. start_sysndd_api.R mounts endpoint at /health
4. R syntax is valid (Rscript parse succeeds)
</verification>

<success_criteria>
1. api/endpoints/health_endpoints.R exists with properly formatted Plumber endpoint
2. start_sysndd_api.R includes `pr_mount("/health", ...)`
3. R syntax validation passes for health_endpoints.R
4. Health endpoint returns JSON with status, timestamp, and version fields
</success_criteria>

<output>
After completion, create `.planning/phases/07-api-dockerfile-optimization/07-01-SUMMARY.md`
</output>
