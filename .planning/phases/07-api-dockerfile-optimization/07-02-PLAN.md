---
phase: 07-api-dockerfile-optimization
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - api/Dockerfile
autonomous: true
user_setup: []

must_haves:
  truths:
    - "API container runs as non-root user (uid 1001)"
    - "Cold build completes in under 8 minutes (target: 5 minutes)"
    - "Warm build with BuildKit cache completes in under 2 minutes"
    - "docker history shows 6 or fewer RUN layers in final image"
    - "HEALTHCHECK at /health responds within 30 seconds of container start"
  artifacts:
    - path: "api/Dockerfile"
      provides: "Multi-stage optimized Dockerfile"
      contains: "FROM rocker/r-ver:4.1.2 AS base"
    - path: "api/Dockerfile"
      provides: "ccache configuration"
      contains: "ccache"
    - path: "api/Dockerfile"
      provides: "Debug symbol stripping"
      contains: "strip --strip-debug"
    - path: "api/Dockerfile"
      provides: "Non-root user"
      contains: "USER apiuser"
    - path: "api/Dockerfile"
      provides: "HEALTHCHECK instruction"
      contains: "HEALTHCHECK"
  key_links:
    - from: "api/Dockerfile HEALTHCHECK"
      to: "/health endpoint"
      via: "curl http://localhost:7777/health"
      pattern: "curl.*localhost:7777/health"
    - from: "production stage"
      to: "packages stage"
      via: "COPY --from=packages"
      pattern: "COPY --from=packages"
---

<objective>
Convert the API Dockerfile to a multi-stage build with ccache, debug symbol stripping, non-root user, and HEALTHCHECK.

Purpose: Optimize build times (45min -> 5min), improve security (non-root), and enable health monitoring via HEALTHCHECK instruction.

Output: Production-ready multi-stage Dockerfile satisfying BUILD-06, BUILD-08, BUILD-09, SEC-05, and COMP-10.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-api-dockerfile-optimization/07-RESEARCH.md
@.planning/phases/07-api-dockerfile-optimization/07-01-SUMMARY.md

@api/Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert Dockerfile to 3-stage multi-stage build</name>
  <files>api/Dockerfile</files>
  <action>
Rewrite api/Dockerfile as a 3-stage multi-stage build. The structure is:

**Stage 1: base** - System dependencies and R configuration
- Keep rocker/r-ver:4.1.2 as base image
- Keep all existing ENV variables (RENV_CONFIG_REPOS_OVERRIDE, RENV_PATHS_CACHE, etc.)
- Keep consolidated apt-get install of system dependencies
- ADD ccache to apt-get install list
- ADD ccache configuration for R (create ~/.R/Makevars and ~/.ccache/ccache.conf)
- Keep renv installation

**Stage 2: packages** - Install all R packages (build-time only)
- FROM base AS packages
- WORKDIR /app
- Copy renv infrastructure (renv.lock, renv/activate.R, renv/settings.json, .Rprofile)
- Keep all existing RUN commands for renv::restore() and additional packages
- ADD BuildKit cache mount for ccache: `--mount=type=cache,target=/root/.ccache,sharing=locked`
- ADD debug symbol stripping after all package installation:
  ```dockerfile
  RUN find /usr/local/lib/R/site-library -name "*.so" \
      -exec strip --strip-debug {} \; 2>/dev/null || true
  ```

**Stage 3: production** - Final slim image
- FROM base AS production
- Create non-root user: groupadd/useradd with uid/gid 1001
- WORKDIR /app
- COPY R libraries from packages stage: `COPY --from=packages /usr/local/lib/R/site-library /usr/local/lib/R/site-library`
- COPY application code with --chown=apiuser:api
- Create /app/logs directory with correct permissions
- ADD HEALTHCHECK instruction:
  ```dockerfile
  HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
      CMD curl -sf http://localhost:7777/health || exit 1
  ```
- ADD LABEL for metadata
- USER apiuser (switch to non-root)
- EXPOSE 7777
- CMD ["Rscript", "start_sysndd_api.R"]

Reference the complete example in 07-RESEARCH.md section "Complete Multi-Stage Dockerfile Pattern".

Key constraints:
- Keep R 4.1.2 (Matrix/FactoMineR compatibility)
- Keep all existing package installation logic (renv + P3M snapshots)
- Keep existing system dependencies list
- ADD syntax=docker/dockerfile:1.4 at top for BuildKit features
  </action>
  <verify>Dockerfile syntax valid: `docker build --check api/` or inspect file structure</verify>
  <done>Dockerfile converted to 3-stage multi-stage build with base, packages, and production stages</done>
</task>

<task type="auto">
  <name>Task 2: Validate Dockerfile structure</name>
  <files></files>
  <action>
Validate the rewritten Dockerfile:

1. Check for required elements:
```bash
cd /home/bernt-popp/development/sysndd

# Check multi-stage structure
grep -E "^FROM.*AS (base|packages|production)" api/Dockerfile

# Check ccache installation
grep "ccache" api/Dockerfile

# Check ccache configuration (Makevars)
grep -A5 "Makevars" api/Dockerfile

# Check debug symbol stripping
grep "strip --strip-debug" api/Dockerfile

# Check non-root user creation
grep -E "(groupadd|useradd|USER apiuser)" api/Dockerfile

# Check HEALTHCHECK
grep "HEALTHCHECK" api/Dockerfile

# Check COPY --from=packages
grep "COPY --from=packages" api/Dockerfile

# Count RUN layers in final stage (should be minimal)
grep -c "^RUN" api/Dockerfile
```

2. Validate Dockerfile syntax with Docker:
```bash
DOCKER_BUILDKIT=1 docker build --check -f api/Dockerfile api/ 2>&1 || echo "Note: --check may not be available, proceeding with manual validation"
```

Note: If `--check` is not available, rely on grep validation above.
  </action>
  <verify>All grep checks find expected patterns; Dockerfile has 3 FROM statements with AS clauses</verify>
  <done>Dockerfile structure validated with all required elements present</done>
</task>

<task type="auto">
  <name>Task 3: Test build (dry-run stage targeting)</name>
  <files></files>
  <action>
Perform a quick syntax and stage validation by targeting just the base stage:

```bash
cd /home/bernt-popp/development/sysndd

# Build only the base stage to validate syntax without full package installation
# This should complete in ~1-2 minutes
DOCKER_BUILDKIT=1 docker build \
  --target base \
  --progress=plain \
  -f api/Dockerfile \
  -t sysndd-api:base-test \
  api/ 2>&1 | head -100

echo "Base stage build exit code: $?"
```

This validates:
- Dockerfile syntax is valid
- Base stage builds successfully
- System dependencies install correctly
- ccache is installed and configured

Full build testing (all stages) should be done manually or in CI due to the 5-8 minute build time.

If the base stage fails, review the error output and fix the Dockerfile.
  </action>
  <verify>Base stage builds successfully (exit code 0)</verify>
  <done>Base stage builds successfully, validating Dockerfile syntax and system dependencies</done>
</task>

</tasks>

<verification>
1. Dockerfile has 3 stages: base, packages, production
2. ccache installed in base stage and configured in ~/.R/Makevars
3. Debug symbols stripped in packages stage
4. Non-root user (apiuser:api, uid 1001) created in production stage
5. HEALTHCHECK instruction present targeting /health endpoint
6. COPY --from=packages transfers R libraries to production stage
7. USER apiuser is last user directive before CMD
8. Base stage builds successfully
</verification>

<success_criteria>
1. Dockerfile contains 3 FROM statements with AS base, AS packages, AS production
2. ccache installed and configured (Makevars created)
3. strip --strip-debug command present after package installation
4. Non-root user created with uid 1001, USER directive before CMD
5. HEALTHCHECK instruction targeting localhost:7777/health
6. Base stage builds successfully (validates syntax and system deps)
7. Dockerfile has 6 or fewer total RUN layers across all stages
</success_criteria>

<output>
After completion, create `.planning/phases/07-api-dockerfile-optimization/07-02-SUMMARY.md`
</output>
