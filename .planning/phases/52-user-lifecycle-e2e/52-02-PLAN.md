---
phase: 52-user-lifecycle-e2e
plan: 02
type: execute
wave: 2
depends_on: ["52-01"]
files_modified:
  - api/tests/testthat/test-e2e-user-lifecycle.R
autonomous: true

must_haves:
  truths:
    - "Password reset request sends email with reset link"
    - "Password reset with valid token changes password successfully"
    - "Password reset with invalid/expired token is rejected"
    - "Invalid password reset requests don't send emails"
  artifacts:
    - path: "api/tests/testthat/test-e2e-user-lifecycle.R"
      provides: "Complete E2E tests for password reset flow"
      contains: ["password reset", "extract_token_from_email"]
  key_links:
    - from: "api/tests/testthat/test-e2e-user-lifecycle.R"
      to: "/api/user/password/reset/request"
      via: "httr2 HTTP request"
      pattern: "password/reset/request"
    - from: "api/tests/testthat/test-e2e-user-lifecycle.R"
      to: "/api/user/password/reset/change"
      via: "httr2 HTTP request with Bearer token"
      pattern: "password/reset/change"
    - from: "api/tests/testthat/test-e2e-user-lifecycle.R"
      to: "extract_token_from_email"
      via: "helper function call"
      pattern: "extract_token_from_email"
---

<objective>
Add password reset E2E tests to complete user lifecycle verification.

Purpose: Verify SMTP-05 (password reset flow works end-to-end) by testing the complete flow: request reset, capture email, extract token, change password, verify login.

Output:
- Updated test-e2e-user-lifecycle.R with password reset section
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-user-lifecycle-e2e/52-CONTEXT.md
@.planning/phases/52-user-lifecycle-e2e/52-RESEARCH.md
@.planning/phases/52-user-lifecycle-e2e/52-01-SUMMARY.md

# Test file to update
@api/tests/testthat/test-e2e-user-lifecycle.R

# Helper with token extraction
@api/tests/testthat/helper-mailpit.R

# API endpoints being tested
@api/endpoints/user_endpoints.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add password reset E2E tests</name>
  <files>api/tests/testthat/test-e2e-user-lifecycle.R</files>
  <action>
Append password reset test section to test-e2e-user-lifecycle.R after the curator approval tests.

Add the following section after the existing tests:

```r
# =============================================================================
# Password Reset Tests (SMTP-05)
# =============================================================================

test_that("password reset request sends email with reset link", {
  skip_if_no_mailpit()
  skip_if_no_api()
  skip_if_no_test_db()

  mailpit_delete_all()
  test_user <- generate_test_user("reset")
  withr::defer(cleanup_test_user(test_user$email))

  # Create and approve test user first
  signup_json <- jsonlite::toJSON(test_user, auto_unbox = TRUE)

  httr2::request(paste0(get_api_base_url(), "/api/authentication/signup")) |>
    httr2::req_url_query(signup_data = signup_json) |>
    httr2::req_perform()

  mailpit_wait_for_message(test_user$email, timeout_seconds = 5)

  user <- get_user_by_email(test_user$email)
  admin_token <- get_admin_token()

  httr2::request(paste0(get_api_base_url(), "/api/user/approval")) |>
    httr2::req_method("PUT") |>
    httr2::req_url_query(user_id = user$user_id, status_approval = "TRUE") |>
    httr2::req_headers(Authorization = paste("Bearer", admin_token)) |>
    httr2::req_perform()

  mailpit_wait_for_message(test_user$email, timeout_seconds = 5)

  # Clear inbox before password reset request
  mailpit_delete_all()

  # Request password reset
  resp <- httr2::request(paste0(get_api_base_url(), "/api/user/password/reset/request")) |>
    httr2::req_method("PUT") |>
    httr2::req_url_query(email_request = test_user$email) |>
    httr2::req_error(is_error = function(resp) FALSE) |>
    httr2::req_perform()

  # Should return 200 (always returns 200 for security - doesn't reveal if email exists)
  expect_equal(httr2::resp_status(resp), 200)

  # Wait for password reset email
  message <- mailpit_wait_for_message(test_user$email, timeout_seconds = 10)

  expect_true(!is.null(message))
  expect_match(message$Subject, "password reset", ignore.case = TRUE)

  # Verify email contains reset URL with token
  full_message <- mailpit_get_message(message$ID)
  expect_match(full_message$Text %||% full_message$HTML, "PasswordReset", ignore.case = FALSE)
})


test_that("password reset with valid token changes password", {
  skip_if_no_mailpit()
  skip_if_no_api()
  skip_if_no_test_db()

  mailpit_delete_all()
  test_user <- generate_test_user("pwchange")
  withr::defer(cleanup_test_user(test_user$email))

  # Create and approve test user
  signup_json <- jsonlite::toJSON(test_user, auto_unbox = TRUE)

  httr2::request(paste0(get_api_base_url(), "/api/authentication/signup")) |>
    httr2::req_url_query(signup_data = signup_json) |>
    httr2::req_perform()

  mailpit_wait_for_message(test_user$email, timeout_seconds = 5)

  user <- get_user_by_email(test_user$email)
  admin_token <- get_admin_token()

  httr2::request(paste0(get_api_base_url(), "/api/user/approval")) |>
    httr2::req_method("PUT") |>
    httr2::req_url_query(user_id = user$user_id, status_approval = "TRUE") |>
    httr2::req_headers(Authorization = paste("Bearer", admin_token)) |>
    httr2::req_perform()

  mailpit_wait_for_message(test_user$email, timeout_seconds = 5)
  mailpit_delete_all()

  # Request password reset
  httr2::request(paste0(get_api_base_url(), "/api/user/password/reset/request")) |>
    httr2::req_method("PUT") |>
    httr2::req_url_query(email_request = test_user$email) |>
    httr2::req_perform()

  # Wait for and extract token from reset email
  message <- mailpit_wait_for_message(test_user$email, timeout_seconds = 10)
  reset_token <- extract_token_from_email(message$ID)

  expect_true(nchar(reset_token) > 0)

  # Use token to change password
  # Password requirements: >7 chars, lowercase, uppercase, digit, special char
  new_password <- "NewTest1!"

  resp <- httr2::request(paste0(get_api_base_url(), "/api/user/password/reset/change")) |>
    httr2::req_headers(Authorization = paste("Bearer", reset_token)) |>
    httr2::req_url_query(new_pass_1 = new_password, new_pass_2 = new_password) |>
    httr2::req_error(is_error = function(resp) FALSE) |>
    httr2::req_perform()

  # Should return 201 on success
  expect_equal(httr2::resp_status(resp), 201)

  # Verify can authenticate with new password
  auth_resp <- httr2::request(paste0(get_api_base_url(), "/api/authentication/authenticate")) |>
    httr2::req_url_query(user_name = test_user$user_name, password = new_password) |>
    httr2::req_error(is_error = function(resp) FALSE) |>
    httr2::req_perform()

  expect_equal(httr2::resp_status(auth_resp), 200)
})


test_that("password reset with invalid token is rejected", {
  skip_if_no_api()

  # Use a made-up invalid JWT
  invalid_token <- "invalid.token.here"
  new_password <- "NewTest1!"

  resp <- httr2::request(paste0(get_api_base_url(), "/api/user/password/reset/change")) |>
    httr2::req_headers(Authorization = paste("Bearer", invalid_token)) |>
    httr2::req_url_query(new_pass_1 = new_password, new_pass_2 = new_password) |>
    httr2::req_error(is_error = function(resp) FALSE) |>
    httr2::req_perform()

  # Should return 401 (Unauthorized) or 409 (Conflict) per endpoint code
  expect_true(httr2::resp_status(resp) %in% c(401, 409))
})


test_that("password reset with weak password is rejected", {
  skip_if_no_mailpit()
  skip_if_no_api()
  skip_if_no_test_db()

  mailpit_delete_all()
  test_user <- generate_test_user("weakpw")
  withr::defer(cleanup_test_user(test_user$email))

  # Create and approve user, request reset
  signup_json <- jsonlite::toJSON(test_user, auto_unbox = TRUE)

  httr2::request(paste0(get_api_base_url(), "/api/authentication/signup")) |>
    httr2::req_url_query(signup_data = signup_json) |>
    httr2::req_perform()

  mailpit_wait_for_message(test_user$email, timeout_seconds = 5)

  user <- get_user_by_email(test_user$email)
  admin_token <- get_admin_token()

  httr2::request(paste0(get_api_base_url(), "/api/user/approval")) |>
    httr2::req_method("PUT") |>
    httr2::req_url_query(user_id = user$user_id, status_approval = "TRUE") |>
    httr2::req_headers(Authorization = paste("Bearer", admin_token)) |>
    httr2::req_perform()

  mailpit_wait_for_message(test_user$email, timeout_seconds = 5)
  mailpit_delete_all()

  httr2::request(paste0(get_api_base_url(), "/api/user/password/reset/request")) |>
    httr2::req_method("PUT") |>
    httr2::req_url_query(email_request = test_user$email) |>
    httr2::req_perform()

  message <- mailpit_wait_for_message(test_user$email, timeout_seconds = 10)
  reset_token <- extract_token_from_email(message$ID)

  # Try with weak password (missing special char)
  weak_password <- "Weak1234"

  resp <- httr2::request(paste0(get_api_base_url(), "/api/user/password/reset/change")) |>
    httr2::req_headers(Authorization = paste("Bearer", reset_token)) |>
    httr2::req_url_query(new_pass_1 = weak_password, new_pass_2 = weak_password) |>
    httr2::req_error(is_error = function(resp) FALSE) |>
    httr2::req_perform()

  # Should return 409 (password validation failed)
  expect_equal(httr2::resp_status(resp), 409)
})


test_that("password reset for non-existent email silently succeeds", {
  skip_if_no_mailpit()
  skip_if_no_api()

  mailpit_delete_all()

  # Request reset for non-existent email
  resp <- httr2::request(paste0(get_api_base_url(), "/api/user/password/reset/request")) |>
    httr2::req_method("PUT") |>
    httr2::req_url_query(email_request = "nonexistent-e2e-test@example.com") |>
    httr2::req_error(is_error = function(resp) FALSE) |>
    httr2::req_perform()

  # Should return 200 (security: don't reveal if email exists)
  expect_equal(httr2::resp_status(resp), 200)

  # No email should be sent
  Sys.sleep(2)
  count <- mailpit_message_count()
  expect_equal(count, 0)
})


test_that("password reset token cannot be reused", {
  skip_if_no_mailpit()
  skip_if_no_api()
  skip_if_no_test_db()

  mailpit_delete_all()
  test_user <- generate_test_user("reuse")
  withr::defer(cleanup_test_user(test_user$email))

  # Create and approve user
  signup_json <- jsonlite::toJSON(test_user, auto_unbox = TRUE)

  httr2::request(paste0(get_api_base_url(), "/api/authentication/signup")) |>
    httr2::req_url_query(signup_data = signup_json) |>
    httr2::req_perform()

  mailpit_wait_for_message(test_user$email, timeout_seconds = 5)

  user <- get_user_by_email(test_user$email)
  admin_token <- get_admin_token()

  httr2::request(paste0(get_api_base_url(), "/api/user/approval")) |>
    httr2::req_method("PUT") |>
    httr2::req_url_query(user_id = user$user_id, status_approval = "TRUE") |>
    httr2::req_headers(Authorization = paste("Bearer", admin_token)) |>
    httr2::req_perform()

  mailpit_wait_for_message(test_user$email, timeout_seconds = 5)
  mailpit_delete_all()

  # Request password reset
  httr2::request(paste0(get_api_base_url(), "/api/user/password/reset/request")) |>
    httr2::req_method("PUT") |>
    httr2::req_url_query(email_request = test_user$email) |>
    httr2::req_perform()

  message <- mailpit_wait_for_message(test_user$email, timeout_seconds = 10)
  reset_token <- extract_token_from_email(message$ID)

  # First use should succeed
  first_password <- "FirstPw1!"

  resp1 <- httr2::request(paste0(get_api_base_url(), "/api/user/password/reset/change")) |>
    httr2::req_headers(Authorization = paste("Bearer", reset_token)) |>
    httr2::req_url_query(new_pass_1 = first_password, new_pass_2 = first_password) |>
    httr2::req_error(is_error = function(resp) FALSE) |>
    httr2::req_perform()

  expect_equal(httr2::resp_status(resp1), 201)

  # Second use with same token should fail
  second_password <- "SecondPw2!"

  resp2 <- httr2::request(paste0(get_api_base_url(), "/api/user/password/reset/change")) |>
    httr2::req_headers(Authorization = paste("Bearer", reset_token)) |>
    httr2::req_url_query(new_pass_1 = second_password, new_pass_2 = second_password) |>
    httr2::req_error(is_error = function(resp) FALSE) |>
    httr2::req_perform()

  # Should fail - token invalidated after first use
  expect_true(httr2::resp_status(resp2) %in% c(401, 409))
})
```

Notes:
- Tests complete password reset flow: request -> email -> token extraction -> password change -> login
- Uses extract_token_from_email() helper from 52-01
- Tests failure scenarios: invalid token, weak password, non-existent email, token reuse
- Verifies security: non-existent email returns 200 (doesn't reveal existence)
- New password meets complexity requirements: >7 chars, lowercase, uppercase, digit, special char
  </action>
  <verify>Run `cd api && Rscript -e "testthat::test_file('tests/testthat/test-e2e-user-lifecycle.R')"` to verify all tests (will skip if prerequisites not running)</verify>
  <done>Password reset E2E tests added covering SMTP-05 with success and failure scenarios</done>
</task>

<task type="auto">
  <name>Task 2: Verify complete test coverage</name>
  <files>api/tests/testthat/test-e2e-user-lifecycle.R</files>
  <action>
Verify the test file has complete coverage by reviewing test count and structure.

Expected test coverage:
1. **Registration tests (SMTP-03):**
   - user registration sends confirmation email
   - duplicate registration is rejected
   - invalid registration data is rejected

2. **Approval tests (SMTP-04):**
   - curator approval sends password email
   - curator rejection deletes user without email

3. **Password reset tests (SMTP-05):**
   - password reset request sends email with reset link
   - password reset with valid token changes password
   - password reset with invalid token is rejected
   - password reset with weak password is rejected
   - password reset for non-existent email silently succeeds
   - password reset token cannot be reused

Run a quick line count and structure check:

```bash
cd /home/bernt-popp/development/sysndd/api
wc -l tests/testthat/test-e2e-user-lifecycle.R
grep -c "test_that" tests/testthat/test-e2e-user-lifecycle.R
```

Expected:
- File should be ~400-500 lines
- Should have 11 test_that() blocks total

If any tests are missing or structure issues found, address them.
  </action>
  <verify>Run `grep -c "test_that" api/tests/testthat/test-e2e-user-lifecycle.R` returns 11</verify>
  <done>Test file verified with complete coverage: 11 tests across registration, approval, and password reset flows</done>
</task>

</tasks>

<verification>
1. Test count verification:
   ```bash
   cd /home/bernt-popp/development/sysndd/api && grep -c "test_that" tests/testthat/test-e2e-user-lifecycle.R
   ```
   Expected: 11

2. Test file syntax check:
   ```bash
   cd /home/bernt-popp/development/sysndd/api && Rscript -e "testthat::test_file('tests/testthat/test-e2e-user-lifecycle.R')"
   ```
   Expected: Tests skip (prerequisites not running) or pass

3. lintr check:
   ```bash
   cd /home/bernt-popp/development/sysndd/api && Rscript -e "lintr::lint('tests/testthat/test-e2e-user-lifecycle.R')"
   ```
   Expected: No lint errors

4. Full test suite still passes:
   ```bash
   cd /home/bernt-popp/development/sysndd && make test-api
   ```
   Expected: All tests pass (E2E tests skip if prerequisites not running)

5. All requirements verified:
   - SMTP-03: Registration tests verify email capture
   - SMTP-04: Approval tests verify password email
   - SMTP-05: Password reset tests verify complete flow
</verification>

<success_criteria>
- SMTP-05 verified: Password reset E2E tests cover request, token extraction, password change, and login
- 6 password reset tests added (request, valid change, invalid token, weak password, non-existent email, token reuse)
- Total of 11 E2E tests in test-e2e-user-lifecycle.R
- Tests verify security: non-existent email returns 200, token invalidated after use
- No lint errors
- All Phase 52 requirements (SMTP-03, SMTP-04, SMTP-05) have E2E test coverage
</success_criteria>

<output>
After completion, create `.planning/phases/52-user-lifecycle-e2e/52-02-SUMMARY.md`
</output>
