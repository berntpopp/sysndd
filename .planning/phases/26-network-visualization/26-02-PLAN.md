---
phase: 26-network-visualization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/composables/useCytoscape.ts
  - app/src/composables/useNetworkData.ts
  - app/src/composables/index.ts
autonomous: true

must_haves:
  truths:
    - "useCytoscape composable initializes Cytoscape.js with fcose layout"
    - "useCytoscape cleans up cy.destroy() in onBeforeUnmount hook"
    - "useNetworkData fetches from /api/analysis/network_edges endpoint"
    - "useNetworkData transforms API response to Cytoscape.js ElementDefinition format"
  artifacts:
    - path: "app/src/composables/useCytoscape.ts"
      provides: "Cytoscape.js lifecycle management composable"
      exports: ["useCytoscape"]
      min_lines: 100
    - path: "app/src/composables/useNetworkData.ts"
      provides: "Network data fetching composable"
      exports: ["useNetworkData"]
      min_lines: 50
  key_links:
    - from: "app/src/composables/useCytoscape.ts"
      to: "cytoscape"
      via: "import and initialization"
      pattern: "import cytoscape"
    - from: "app/src/composables/useNetworkData.ts"
      to: "/api/analysis/network_edges"
      via: "axios.get call"
      pattern: "network_edges"
---

<objective>
Create Vue 3 composables for Cytoscape.js lifecycle management and network data fetching

Purpose: Isolate Cytoscape.js complexity into reusable composables that handle lifecycle management (preventing memory leaks) and data transformation (API to Cytoscape.js format)

Output: useCytoscape and useNetworkData composables following established SysNDD patterns
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/26-network-visualization/26-CONTEXT.md
@.planning/phases/26-network-visualization/26-RESEARCH.md
@app/src/composables/useTableData.ts
@app/src/composables/useColorAndSymbols.ts
@app/src/composables/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Cytoscape.js dependencies</name>
  <files>app/package.json</files>
  <action>
Install Cytoscape.js and extensions:

```bash
cd /home/bernt-popp/development/sysndd/app
npm install cytoscape@3.33.1 cytoscape-fcose@2.2.0 cytoscape-svg@latest
npm install --save-dev @types/cytoscape
```

These are required for:
- cytoscape: Core graph visualization library
- cytoscape-fcose: Fast force-directed layout (2x faster than cose-bilkent)
- cytoscape-svg: SVG export functionality
- @types/cytoscape: TypeScript definitions
  </action>
  <verify>
Verify packages installed:
```bash
cd /home/bernt-popp/development/sysndd/app && npm list cytoscape cytoscape-fcose cytoscape-svg
```
  </verify>
  <done>cytoscape, cytoscape-fcose, cytoscape-svg packages in package.json</done>
</task>

<task type="auto">
  <name>Task 2: Create useCytoscape composable</name>
  <files>app/src/composables/useCytoscape.ts</files>
  <action>
Create useCytoscape.ts composable for Cytoscape.js lifecycle management.

CRITICAL: Store Cytoscape instance in non-reactive variable (let cy) NOT ref() to avoid Vue reactivity triggering 100+ layout recalculations.

CRITICAL: Always call cy.destroy() in onBeforeUnmount to prevent 100-300MB memory leaks per navigation.

Implementation:
1. Import cytoscape, fcose extension, register fcose with cytoscape.use()
2. Accept options: container (Ref<HTMLElement | null>), elements (ElementDefinition[]), onNodeClick callback
3. State: isInitialized (ref), isLoading (ref), let cy: Core | null = null (non-reactive!)
4. initializeCytoscape(): Create cy instance with:
   - Performance optimizations: hideEdgesOnViewport: true, pixelRatio: 1
   - fcose layout with animate: true, animationDuration: 1500
   - Style for nodes (label, background-color from data, sized by degree)
   - Style for edges (width from confidence, bezier curves)
   - Event handlers: tap on node calls onNodeClick, mouseover/mouseout for highlighting
5. updateElements(elements): cy.elements().remove(), cy.add(elements), run layout
6. Export controls: fitToScreen (cy.fit()), resetLayout (re-run fcose), zoomIn/zoomOut
7. Export functions: exportPNG (cy.png()), exportSVG (cy.svg())
8. onBeforeUnmount: if (cy) { cy.destroy(); cy = null; }

Style configuration from user decisions (CONTEXT.md):
- Node sizing by degree: width/height = Math.max(30, Math.sqrt(degree) * 10)
- Cluster colors via data(color) property
- Edge width from confidence: Math.max(1, confidence * 5)
- Highlighted state: yellow border, dimmed neighbors

Return: { cy: () => cy, isInitialized, isLoading, initializeCytoscape, updateElements, fitToScreen, resetLayout, zoomIn, zoomOut, exportPNG, exportSVG }
  </action>
  <verify>
TypeScript compiles: `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit src/composables/useCytoscape.ts`
  </verify>
  <done>useCytoscape composable with lifecycle management and memory leak prevention</done>
</task>

<task type="auto">
  <name>Task 3: Create useNetworkData composable and update exports</name>
  <files>app/src/composables/useNetworkData.ts, app/src/composables/index.ts</files>
  <action>
Part A: Create useNetworkData.ts composable for data fetching and transformation.

Implementation:
1. Import types from @/types/network (NetworkNode, NetworkEdge, NetworkResponse)
2. Import useColorAndSymbols for cluster colors
3. State: networkData (ref), isLoading (ref), error (ref)
4. fetchNetworkData(clusterType: 'clusters' | 'subclusters'): async function that:
   - Sets isLoading = true
   - Calls axios.get('/api/analysis/network_edges', { params: { cluster_type: clusterType } })
   - Stores response in networkData
   - Handles errors with try/catch
   - Sets isLoading = false in finally
5. cytoscapeElements (computed): Transform networkData to Cytoscape.js ElementDefinition[]:
   - Map nodes: { data: { id: hgnc_id, symbol, cluster, degree, color: getClusterColor(cluster) } }
   - Map edges: { data: { id: `e${idx}`, source, target, confidence } }
   - Return [...nodes, ...edges]

Return: { networkData, isLoading, error, fetchNetworkData, cytoscapeElements }

Part B: Update app/src/composables/index.ts to export new composables:

Add exports:
```typescript
export { default as useCytoscape } from './useCytoscape';
export { default as useNetworkData } from './useNetworkData';
```

Or if using named exports:
```typescript
export { useCytoscape } from './useCytoscape';
export { useNetworkData } from './useNetworkData';
```
  </action>
  <verify>
TypeScript compiles:
```bash
cd /home/bernt-popp/development/sysndd/app
npx tsc --noEmit src/composables/useNetworkData.ts
npx tsc --noEmit src/composables/index.ts
```
  </verify>
  <done>useNetworkData composable with data fetching and Cytoscape.js transformation</done>
</task>

</tasks>

<verification>
1. Packages installed: `npm list cytoscape` shows version 3.33.1
2. TypeScript compiles: `npm run type-check` passes
3. Composables export correctly: Import test in node REPL
4. Non-reactive cy instance: Code review confirms `let cy: Core | null = null` (not ref)
5. Cleanup hook: Code review confirms onBeforeUnmount with cy.destroy()
</verification>

<success_criteria>
- cytoscape, cytoscape-fcose, cytoscape-svg installed
- useCytoscape manages Cytoscape.js lifecycle with non-reactive instance storage
- useCytoscape cleans up properly via cy.destroy() in onBeforeUnmount
- useNetworkData fetches from /api/analysis/network_edges
- useNetworkData transforms API response to Cytoscape.js ElementDefinition format
- Both composables exported from composables/index.ts
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/26-network-visualization/26-02-SUMMARY.md`
</output>
