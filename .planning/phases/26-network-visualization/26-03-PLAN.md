---
phase: 26-network-visualization
plan: 03
type: execute
wave: 2
depends_on: ["26-01", "26-02"]
files_modified:
  - app/src/components/analyses/NetworkVisualization.vue
  - app/src/components/analyses/AnalyseGeneClusters.vue
autonomous: false

must_haves:
  truths:
    - "Network displays actual PPI edges between genes (not just bubbles)"
    - "User can pan and zoom the network"
    - "Hovering over nodes highlights connections and shows tooltip"
    - "Clicking a node navigates to entity detail page"
    - "Network controls visible in card header (fit, reset, export)"
  artifacts:
    - path: "app/src/components/analyses/NetworkVisualization.vue"
      provides: "Cytoscape.js network component"
      min_lines: 150
    - path: "app/src/components/analyses/AnalyseGeneClusters.vue"
      provides: "Integration point for NetworkVisualization"
      contains: "NetworkVisualization"
  key_links:
    - from: "app/src/components/analyses/NetworkVisualization.vue"
      to: "app/src/composables/useCytoscape.ts"
      via: "composable import and usage"
      pattern: "useCytoscape"
    - from: "app/src/components/analyses/NetworkVisualization.vue"
      to: "app/src/composables/useNetworkData.ts"
      via: "composable import and usage"
      pattern: "useNetworkData"
    - from: "app/src/components/analyses/AnalyseGeneClusters.vue"
      to: "app/src/components/analyses/NetworkVisualization.vue"
      via: "component import and usage"
      pattern: "NetworkVisualization"

user_setup: []
---

<objective>
Create NetworkVisualization component and integrate with AnalyseGeneClusters

Purpose: Replace D3.js bubble chart with true protein-protein interaction network using Cytoscape.js, providing interactive exploration of gene relationships with professional controls and navigation

Output: Working network visualization with pan/zoom, hover highlighting, tooltips, node click navigation, and export functionality
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/26-network-visualization/26-CONTEXT.md
@.planning/phases/26-network-visualization/26-RESEARCH.md
@.planning/phases/26-network-visualization/26-01-SUMMARY.md
@.planning/phases/26-network-visualization/26-02-SUMMARY.md
@app/src/components/analyses/AnalyseGeneClusters.vue
@app/src/composables/useCytoscape.ts
@app/src/composables/useNetworkData.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NetworkVisualization component</name>
  <files>app/src/components/analyses/NetworkVisualization.vue</files>
  <action>
Create NetworkVisualization.vue component using script setup and Composition API.

Template structure (follow existing BCard pattern from AnalyseGeneClusters.vue):
1. BCard with header containing:
   - Title "Protein-Protein Interaction Network" with BBadge showing gene/interaction counts
   - Control buttons: Fit, Reset Layout, Zoom In, Zoom Out, PNG Export, SVG Export
   - Use Bootstrap Icons (bi-arrows-fullscreen, bi-arrow-clockwise, bi-zoom-in, bi-zoom-out, bi-image, bi-file-earmark-image)
2. Body containing:
   - Loading spinner (BSpinner) when isLoading
   - Cytoscape container div with ref="cytoscapeContainer"
   - Network legend showing cluster colors

Script setup implementation:
1. Import: ref, onMounted, watch, computed from vue
2. Import: useRouter from vue-router
3. Import: useCytoscape, useNetworkData from @/composables
4. Import: Bootstrap-Vue-Next components (BCard, BButton, BBadge, BSpinner, BPopover)
5. Props: clusterType ('clusters' | 'subclusters', default 'clusters')
6. Setup useNetworkData composable, destructure networkData, isLoading, fetchNetworkData, cytoscapeElements
7. Setup useCytoscape composable with:
   - container: cytoscapeContainer ref
   - elements: cytoscapeElements (initially empty)
   - onNodeClick: navigate to entity detail page via router.push({ name: 'Entity', params: { hgnc_id: nodeId } })
8. onMounted: await fetchNetworkData(props.clusterType), then initializeCytoscape()
9. watch(cytoscapeElements): if isInitialized, call updateElements(newElements)
10. Emit: 'cluster-selected' when user clicks on node (for potential table sync)

Tooltip implementation (NETV-07):
- Use BPopover positioned near cursor on node hover
- Show: Gene symbol, HGNC ID, Cluster number, Connection count (degree)
- Use cy.on('mouseover', 'node') to show, cy.on('mouseout', 'node') to hide

Style section:
- .network-container: position relative, width 100%, height 600px
- .cytoscape-canvas: width 100%, height 100%, background #fafafa, border 1px solid #ddd
- .spinner: absolute positioning centered
- .network-legend: small text below canvas showing cluster color mapping

Control button handlers:
- fitToScreen(): Call composable fitToScreen()
- resetLayout(): Call composable resetLayout()
- handleZoomIn(): cy.zoom(cy.zoom() * 1.2)
- handleZoomOut(): cy.zoom(cy.zoom() / 1.2)
- handleExportPNG(): Get PNG data URL, create download link, trigger click
- handleExportSVG(): Get SVG string, create blob, download

Disable controls when !isInitialized (prevent calling on null cy instance).
  </action>
  <verify>
Component renders: Start dev server, navigate to /Analyses/GeneClusters, verify no console errors
TypeScript: `npx vue-tsc --noEmit` passes
  </verify>
  <done>NetworkVisualization component with pan/zoom/hover/click functionality</done>
</task>

<task type="auto">
  <name>Task 2: Integrate NetworkVisualization into AnalyseGeneClusters</name>
  <files>app/src/components/analyses/AnalyseGeneClusters.vue</files>
  <action>
Integrate NetworkVisualization component into existing AnalyseGeneClusters.vue.

Changes to make:
1. Import NetworkVisualization component
2. Register in components (if using Options API) or just import for script setup
3. Replace the D3.js graph div (#gene_cluster_dataviz) with NetworkVisualization component
4. Pass clusterType prop: :cluster-type="selectType"
5. Wire up cluster-selected event to sync with table (optional enhancement)

Location in template (replace existing graph div):
```vue
<!-- LEFT COLUMN (Graph) - Currently line 51-149 -->
<BCol md="4">
  <BCard ...>
    <template #header>
      <!-- Keep existing header with cluster info and dropdown -->
    </template>

    <!-- REPLACE this div with NetworkVisualization -->
    <!-- OLD: <div id="gene_cluster_dataviz" class="svg-container"> ... D3 ... </div> -->
    <NetworkVisualization
      :cluster-type="selectType"
      @cluster-selected="handleClusterSelected"
    />

    <template #footer>
      <!-- Keep existing footer link -->
    </template>
  </BCard>
</BCol>
```

Remove D3.js-specific code:
- Remove import * as d3 from 'd3' (line 342)
- Remove D3 rendering methods (if any in methods section)
- Keep all table-related logic intact

Add handleClusterSelected method:
```javascript
handleClusterSelected(hgncId) {
  // Optional: Highlight row in table, or navigate
  console.log('Cluster selected:', hgncId);
}
```

Keep existing functionality:
- Algorithm selector (leiden/walktrap) - pass to NetworkVisualization or handle at page level
- Cluster/subcluster selector - already used as clusterType prop
- Table with term enrichment / identifiers
- Download buttons (these are for the old D3 SVG - may need adjustment)
  </action>
  <verify>
Navigate to /Analyses/GeneClusters page:
1. Network graph renders with actual edges (not D3 bubbles)
2. Hovering highlights connected nodes
3. Clicking node navigates to /Genes/{hgnc_id}
4. Table still works (filters, pagination, sorting)
5. No console errors
  </verify>
  <done>AnalyseGeneClusters displays NetworkVisualization instead of D3 bubbles</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify network visualization functionality</name>
  <what-built>
Complete network visualization replacing D3.js bubble chart:
- Cytoscape.js with fcose force-directed layout
- Actual protein-protein interaction edges
- Pan and zoom with mouse/trackpad
- Hover highlighting with tooltips
- Click-to-navigate to entity detail
- Export buttons (PNG, SVG)
- Memory leak prevention (cy.destroy on unmount)
  </what-built>
  <how-to-verify>
1. Navigate to http://localhost:5173/Analyses/GeneClusters
2. Wait for network to load (should see animated layout settling)
3. Verify network shows:
   - Nodes (genes) with different sizes based on connection count
   - Edges (interactions) connecting genes
   - Cluster colors distinguishing different clusters
4. Test interactions:
   - Pan: Click and drag background
   - Zoom: Mouse wheel or trackpad pinch
   - Hover node: Should highlight connections and show tooltip with gene info
   - Click node: Should navigate to entity detail page (/Genes/{hgnc_id})
5. Test controls:
   - Fit button: Centers and fits graph to view
   - Reset button: Re-runs layout animation
   - PNG export: Downloads network.png file
   - SVG export: Downloads network.svg file
6. Test memory (optional):
   - Navigate away from page and back 5 times
   - Check browser task manager - memory should not grow significantly
7. Verify table still works:
   - Change table type dropdown
   - Use search filter
   - Click pagination
  </how-to-verify>
  <resume-signal>Type "approved" if network visualization works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Network renders: Actual edges visible between genes (not isolated bubbles)
2. Force layout: Nodes arrange naturally with cluster grouping
3. Interactions: Pan, zoom, hover, click all functional
4. Tooltips: Show gene symbol, HGNC ID, cluster, connections
5. Navigation: Click node goes to /Genes/{hgnc_id}
6. Controls: Fit, Reset, Zoom, Export buttons work
7. Memory: No leaks (cy.destroy called on unmount)
8. Integration: Table functionality preserved
</verification>

<success_criteria>
- Network displays actual protein-protein interaction edges (NETV-03)
- Force-directed layout with fcose (NETV-02)
- Pan and zoom work smoothly with hideEdgesOnViewport optimization (NETV-05, NETV-10)
- Hover highlights connections with tooltips (NETV-04, NETV-07)
- Click navigates to entity detail (NETV-06)
- Controls in card header (fit, reset, export)
- Memory properly cleaned up on navigation (NETV-11)
- Existing table functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/26-network-visualization/26-03-SUMMARY.md`
</output>
