---
phase: 38-re-review-overhaul
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - api/endpoints/re_review_endpoints.R
autonomous: true

must_haves:
  truths:
    - "POST /api/re_review/batch/create endpoint creates dynamic batch with criteria"
    - "POST /api/re_review/batch/preview endpoint returns matching entities without creating"
    - "PUT /api/re_review/batch/reassign endpoint allows reassigning batch to different user"
    - "PUT /api/re_review/batch/archive endpoint soft deletes batch"
    - "GET /api/re_review/table endpoint no longer filters by hardcoded 2020-01-01 date"
  artifacts:
    - path: "api/endpoints/re_review_endpoints.R"
      provides: "Re-review batch management endpoints"
      exports: ["POST batch/create", "POST batch/preview", "PUT batch/reassign", "PUT batch/archive"]
  key_links:
    - from: "api/endpoints/re_review_endpoints.R"
      to: "api/services/re-review-service.R"
      via: "service function calls"
      pattern: "batch_create|batch_preview|batch_reassign|batch_archive"
---

<objective>
Add API endpoints for dynamic batch creation and management

Purpose: Expose the re-review-service.R functions as REST endpoints, enabling the frontend to create batches dynamically with custom criteria, preview matching entities, reassign batches, and archive batches. Also remove the hardcoded 2020-01-01 filter from the existing table endpoint (RRV-07).

Output: Updated api/endpoints/re_review_endpoints.R with new endpoints for batch lifecycle management.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-re-review-system-overhaul/38-CONTEXT.md
@.planning/phases/38-re-review-system-overhaul/38-RESEARCH.md
@api/endpoints/re_review_endpoints.R
@api/services/re-review-service.R (created in 38-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add batch creation and preview endpoints</name>
  <files>api/endpoints/re_review_endpoints.R</files>
  <action>
Add new endpoints to api/endpoints/re_review_endpoints.R for dynamic batch creation.

**Endpoint 1: POST /api/re_review/batch/create**
```r
#* Create a new Re-Review Batch dynamically
#*
#* Creates a batch based on provided criteria (date range, gene list, status, disease).
#* Optionally assigns to a user during creation.
#*
#* @tag re_review
#* @serializer json list(na="string")
#*
#* @post batch/create
function(req, res) {
  require_role(req, res, "Curator")

  # Parse request body
  body <- req$argsBody

  # Extract criteria
  criteria <- list(
    date_range = body$date_range,      # list(start="YYYY-MM-DD", end="YYYY-MM-DD")
    gene_list = body$gene_list,        # array of hgnc_id integers
    status_filter = body$status_filter, # category_id integer
    disease_id = body$disease_id,      # disease ontology id string
    batch_size = body$batch_size %||% 20L
  )

  assigned_user_id <- body$assigned_user_id  # optional
  batch_name <- body$batch_name              # optional

  result <- batch_create(criteria, assigned_user_id, batch_name, pool)

  if (result$status != 200) {
    res$status <- result$status
  }

  result
}
```

**Endpoint 2: POST /api/re_review/batch/preview**
```r
#* Preview matching entities for batch criteria
#*
#* Returns entities that would be included in a batch without creating it.
#* Useful for reviewing criteria before committing.
#*
#* @tag re_review
#* @serializer json list(na="string")
#*
#* @post batch/preview
function(req, res) {
  require_role(req, res, "Curator")

  body <- req$argsBody

  criteria <- list(
    date_range = body$date_range,
    gene_list = body$gene_list,
    status_filter = body$status_filter,
    disease_id = body$disease_id,
    batch_size = body$batch_size %||% 20L
  )

  result <- batch_preview(criteria, criteria$batch_size, pool)

  if (result$status != 200) {
    res$status <- result$status
  }

  result
}
```

Place these endpoints after the existing batch/assign endpoint (around line 420).
  </action>
  <verify>
```bash
grep -q "post batch/create" api/endpoints/re_review_endpoints.R && echo "Create endpoint: OK"
grep -q "post batch/preview" api/endpoints/re_review_endpoints.R && echo "Preview endpoint: OK"
grep -q "batch_create\|batch_preview" api/endpoints/re_review_endpoints.R && echo "Service calls: OK"
```
  </verify>
  <done>
- POST /api/re_review/batch/create endpoint exists and calls batch_create()
- POST /api/re_review/batch/preview endpoint exists and calls batch_preview()
- Both endpoints require Curator role
- Request body parsing handles criteria object correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Add batch reassign and archive endpoints</name>
  <files>api/endpoints/re_review_endpoints.R</files>
  <action>
Add endpoints for batch reassignment and archival.

**Endpoint 3: PUT /api/re_review/batch/reassign**
```r
#* Reassign Re-Review Batch to different user
#*
#* Changes the assigned user for an existing batch.
#* Can reassign at any time (per CONTEXT decision).
#*
#* @tag re_review
#* @serializer json list(na="string")
#*
#* @param re_review_batch The batch ID to reassign
#* @param user_id The new user ID to assign to
#*
#* @put batch/reassign
function(req, res, re_review_batch, user_id) {
  require_role(req, res, "Curator")

  batch_id <- as.integer(re_review_batch)
  new_user_id <- as.integer(user_id)

  result <- batch_reassign(batch_id, new_user_id, pool)

  if (result$status != 200) {
    res$status <- result$status
  }

  result
}
```

**Endpoint 4: PUT /api/re_review/batch/archive**
```r
#* Archive (soft delete) a Re-Review Batch
#*
#* Removes batch assignment, preserving entity connect records for audit.
#* Only allowed for batches not yet completed (per CONTEXT decision).
#*
#* @tag re_review
#* @serializer json list(na="string")
#*
#* @param re_review_batch The batch ID to archive
#*
#* @put batch/archive
function(req, res, re_review_batch) {
  require_role(req, res, "Curator")

  batch_id <- as.integer(re_review_batch)

  result <- batch_archive(batch_id, pool)

  if (result$status != 200) {
    res$status <- result$status
  }

  result
}
```

Place these after the batch/create and batch/preview endpoints.
  </action>
  <verify>
```bash
grep -q "put batch/reassign" api/endpoints/re_review_endpoints.R && echo "Reassign endpoint: OK"
grep -q "put batch/archive" api/endpoints/re_review_endpoints.R && echo "Archive endpoint: OK"
```
  </verify>
  <done>
- PUT /api/re_review/batch/reassign endpoint exists
- PUT /api/re_review/batch/archive endpoint exists
- Both call corresponding service functions
- Both require Curator role
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove hardcoded 2020-01-01 filter from table endpoint</name>
  <files>api/endpoints/re_review_endpoints.R</files>
  <action>
Modify the GET /api/re_review/table endpoint (around line 199) to remove the hardcoded 2020-01-01 date filter.

**Current code (line ~199):**
```r
filter = "or(lessOrEqual(review_date,2020-01-01),equals(re_review_review_saved,1)",
```

**Change to:**
```r
filter = "equals(re_review_approved,0)",
```

This new default filter shows all unapproved re-review entries, which is the correct behavior for the management view. The old filter artificially restricted to pre-2020 entries, which was a legacy workaround.

**Why this change:**
- RRV-07 requirement: Remove hardcoded batch filter date
- New dynamic batches can target any date range
- The filter should show all pending (unapproved) items regardless of date
- Curators can still pass custom filter parameter if needed
  </action>
  <verify>
```bash
# Verify hardcoded date is removed
! grep -q "2020-01-01" api/endpoints/re_review_endpoints.R && echo "Hardcoded date removed: OK"

# Verify new default filter
grep -q 'filter = "equals(re_review_approved,0)"' api/endpoints/re_review_endpoints.R && echo "New filter: OK"
```
  </verify>
  <done>
- Hardcoded 2020-01-01 date filter removed from GET /api/re_review/table
- New default filter shows all unapproved entries
- RRV-07 requirement satisfied
  </done>
</task>

</tasks>

<verification>
```bash
# Count new endpoints
grep -c "@post batch\|@put batch" api/endpoints/re_review_endpoints.R  # Should be 4

# Verify no hardcoded date
! grep -q "2020-01-01" api/endpoints/re_review_endpoints.R && echo "No hardcoded date: PASS"

# Verify service integration
grep -c "batch_create\|batch_preview\|batch_reassign\|batch_archive" api/endpoints/re_review_endpoints.R  # Should be 4
```
</verification>

<success_criteria>
1. POST /api/re_review/batch/create endpoint added
2. POST /api/re_review/batch/preview endpoint added
3. PUT /api/re_review/batch/reassign endpoint added
4. PUT /api/re_review/batch/archive endpoint added
5. All endpoints call corresponding service functions
6. All endpoints require Curator role
7. Hardcoded 2020-01-01 filter removed from GET /api/re_review/table (RRV-07)
</success_criteria>

<output>
After completion, create `.planning/phases/38-re-review-overhaul/38-02-SUMMARY.md`
</output>
