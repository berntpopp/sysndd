---
phase: 38-re-review-overhaul
plan: 04
type: execute
wave: 2
depends_on: ["38-01", "38-02", "38-03"]
files_modified:
  - app/src/views/curate/ManageReReview.vue
autonomous: true

must_haves:
  truths:
    - "ManageReReview includes BatchCriteriaForm for creating new batches"
    - "Admin can create batches with custom criteria via the form"
    - "Admin can reassign batches to different users via actions column"
    - "Batch table refreshes after batch creation"
    - "Form collapse/expand provides clean UX"
  artifacts:
    - path: "app/src/views/curate/ManageReReview.vue"
      provides: "Complete re-review management with batch creation UI"
      min_lines: 400
  key_links:
    - from: "app/src/views/curate/ManageReReview.vue"
      to: "app/src/components/forms/BatchCriteriaForm.vue"
      via: "component import"
      pattern: "BatchCriteriaForm"
---

<objective>
Integrate BatchCriteriaForm into ManageReReview.vue

Purpose: Complete the re-review system overhaul by integrating the batch creation form into the management view. Add reassignment capability to existing batches. The view becomes the central hub for all batch management operations.

Output: Updated app/src/views/curate/ManageReReview.vue with batch creation form and enhanced table actions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-re-review-system-overhaul/38-CONTEXT.md
@.planning/phases/38-re-review-system-overhaul/38-RESEARCH.md
@app/src/views/curate/ManageReReview.vue
@app/src/components/forms/BatchCriteriaForm.vue (created in 38-03)
@app/src/composables/useBatchForm.ts (created in 38-03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add BatchCriteriaForm to ManageReReview</name>
  <files>app/src/views/curate/ManageReReview.vue</files>
  <action>
Update ManageReReview.vue to include the BatchCriteriaForm component with a collapsible section.

**1. Add import for the component:**
```javascript
import BatchCriteriaForm from '@/components/forms/BatchCriteriaForm.vue';
```

**2. Add to template (before the existing BCard with the table):**
```vue
<!-- Batch Creation Section (Collapsible) -->
<BCard
  header-tag="header"
  body-class="p-0"
  header-class="p-1"
  border-variant="primary"
  class="mb-3"
>
  <template #header>
    <div class="d-flex justify-content-between align-items-center">
      <h6 class="mb-1 text-start font-weight-bold">
        <i class="bi bi-plus-square me-1" />
        Create New Batch
      </h6>
      <BButton
        v-b-toggle.batch-form-collapse
        variant="outline-primary"
        size="sm"
        aria-label="Toggle batch creation form"
      >
        <i class="bi bi-chevron-down" />
      </BButton>
    </div>
  </template>
  <BCollapse
    id="batch-form-collapse"
    visible
  >
    <div class="p-3">
      <BatchCriteriaForm @batch-created="onBatchCreated" />
    </div>
  </BCollapse>
</BCard>
```

**3. Add method to handle batch creation:**
```javascript
onBatchCreated() {
  // Refresh the assignment table after new batch is created
  this.loadReReviewTableData();
  this.makeToast('Batch created and table refreshed', 'Success', 'success');
},
```

**4. Register the component:**
Add `BatchCriteriaForm` to the components object (if using Options API) or ensure import is used in template.
  </action>
  <verify>
```bash
grep -q "BatchCriteriaForm" app/src/views/curate/ManageReReview.vue && echo "Component imported: OK"
grep -q "batch-created" app/src/views/curate/ManageReReview.vue && echo "Event handler: OK"
grep -q "onBatchCreated" app/src/views/curate/ManageReReview.vue && echo "Method exists: OK"
```
  </verify>
  <done>
- BatchCriteriaForm imported and used in template
- Collapsible card wraps the form
- onBatchCreated method refreshes table after creation
- Component properly registered
  </done>
</task>

<task type="auto">
  <name>Task 2: Add reassign action to batch table</name>
  <files>app/src/views/curate/ManageReReview.vue</files>
  <action>
Add reassign functionality to the actions column in the batch table.

**1. Add data property for reassignment modal:**
```javascript
data() {
  return {
    // ... existing properties
    reassignModalShow: false,
    reassignBatchId: null,
    reassignNewUserId: null,
  };
},
```

**2. Add reassign button to actions cell template:**
Update the `#cell(actions)` template slot to include a reassign button:
```vue
<template #cell(actions)="data">
  <!-- Reassign button -->
  <BButton
    v-b-tooltip.hover.top
    size="sm"
    class="me-1 btn-xs"
    title="Reassign this batch to a different user"
    :aria-label="`Reassign batch ${data.item.re_review_batch} currently assigned to ${data.item.user_name}`"
    variant="warning"
    @click="openReassignModal(data.item)"
  >
    <i class="bi bi-arrow-repeat" />
  </BButton>

  <!-- Existing unassign button -->
  <BButton
    v-b-tooltip.hover.top
    size="sm"
    class="me-1 btn-xs"
    title="Unassign this batch"
    :aria-label="`Unassign batch ${data.item.re_review_batch} from ${data.item.user_name}`"
    variant="danger"
    @click="handleBatchUnAssignment(data.item.re_review_batch)"
  >
    <i class="bi bi-file-earmark-minus" />
  </BButton>
</template>
```

**3. Add reassign modal to template (at end of template, before closing div):**
```vue
<!-- Reassign Modal -->
<BModal
  v-model="reassignModalShow"
  title="Reassign Batch"
  ok-title="Reassign"
  cancel-title="Cancel"
  @ok="handleBatchReassignment"
>
  <BFormGroup
    label="Select new user:"
    label-for="reassign-user-select"
  >
    <BFormSelect
      id="reassign-user-select"
      v-model="reassignNewUserId"
      :options="user_options"
      aria-label="Select user to reassign batch to"
    />
  </BFormGroup>
  <small class="text-muted">
    This will reassign batch {{ reassignBatchId }} to the selected user.
  </small>
</BModal>
```

**4. Add methods for reassignment:**
```javascript
openReassignModal(item) {
  this.reassignBatchId = item.re_review_batch;
  this.reassignNewUserId = item.user_id;  // Pre-select current user
  this.reassignModalShow = true;
},

async handleBatchReassignment() {
  if (!this.reassignNewUserId) {
    this.makeToast('Please select a user', 'Validation', 'warning');
    return;
  }

  const apiUrl = `${import.meta.env.VITE_API_URL}/api/re_review/batch/reassign?re_review_batch=${this.reassignBatchId}&user_id=${this.reassignNewUserId}`;

  try {
    await this.axios.put(apiUrl, {}, {
      headers: {
        Authorization: `Bearer ${localStorage.getItem('token')}`,
      },
    });
    this.makeToast('Batch reassigned successfully', 'Success', 'success');
    this.reassignModalShow = false;
    this.loadReReviewTableData();
  } catch (e) {
    this.makeToast(e, 'Error', 'danger');
  }
},
```
  </action>
  <verify>
```bash
grep -q "reassign" app/src/views/curate/ManageReReview.vue && echo "Reassign implemented: OK"
grep -q "bi-arrow-repeat" app/src/views/curate/ManageReReview.vue && echo "Reassign icon: OK"
grep -q "handleBatchReassignment" app/src/views/curate/ManageReReview.vue && echo "Reassign method: OK"
```
  </verify>
  <done>
- Reassign button added to actions column
- Reassign modal with user selection
- handleBatchReassignment method calls PUT /api/re_review/batch/reassign
- Table refreshes after reassignment
- Proper aria-labels for accessibility
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove old batch assignment UI (now replaced by form)</name>
  <files>app/src/views/curate/ManageReReview.vue</files>
  <action>
The old "Assign new batch" button and username select at the top of the page should be updated or removed since it only assigned the NEXT pre-computed batch, which is a legacy pattern.

**Option A (Recommended): Keep but clarify it's for legacy batches**
Update the label and help text:
```vue
<BCol class="my-1">
  <!-- Legacy batch assignment (for pre-computed batches) -->
  <BInputGroup
    prepend="Username"
    size="sm"
  >
    <BFormSelect
      v-model="user_id_assignment"
      :options="user_options"
      class="username-select"
    />
    <BButton
      block
      size="sm"
      variant="secondary"
      aria-label="Assign next available pre-computed batch to selected user"
      @click="handleNewBatchAssignment"
    >
      <i class="bi bi-plus-square mx-1" />
      Assign Legacy Batch
    </BButton>
  </BInputGroup>
  <small class="text-muted">
    Assign next available pre-computed batch. Use "Create New Batch" above for dynamic batches.
  </small>
</BCol>
```

**Option B: Remove entirely**
If legacy batches should no longer be assignable, remove the entire BCol containing the old assignment UI (lines ~44-68 approximately).

For this implementation, use **Option A** to maintain backward compatibility while making the new system prominent.

Additionally, ensure the new BatchCriteriaForm card appears ABOVE the table card for visual hierarchy.
  </action>
  <verify>
```bash
# Check the old assignment is labeled as legacy
grep -q "Legacy Batch\|pre-computed" app/src/views/curate/ManageReReview.vue && echo "Legacy label: OK"

# Check new form is present
grep -q "BatchCriteriaForm\|Create New Batch" app/src/views/curate/ManageReReview.vue && echo "New form: OK"
```
  </verify>
  <done>
- Old batch assignment UI labeled as "Legacy Batch" for clarity
- Help text updated to direct users to new form
- Visual hierarchy: new form above table
- Backward compatibility maintained
  </done>
</task>

</tasks>

<verification>
```bash
# Check file size increased
wc -l app/src/views/curate/ManageReReview.vue  # Should be 400+ lines

# Check all key features
grep -q "BatchCriteriaForm" app/src/views/curate/ManageReReview.vue && echo "Form component: PASS"
grep -q "batch-created" app/src/views/curate/ManageReReview.vue && echo "Create event: PASS"
grep -q "reassign" app/src/views/curate/ManageReReview.vue && echo "Reassign feature: PASS"
grep -q "batch/reassign" app/src/views/curate/ManageReReview.vue && echo "Reassign API: PASS"

# TypeScript check
cd /home/bernt-popp/development/sysndd/app && npx vue-tsc --noEmit 2>&1 | head -10
```
</verification>

<success_criteria>
1. BatchCriteriaForm integrated into ManageReReview.vue
2. Form is in collapsible card above the table
3. onBatchCreated handler refreshes table after batch creation
4. Reassign button added to each batch row
5. Reassign modal allows selecting new user
6. handleBatchReassignment calls PUT /api/re_review/batch/reassign
7. Old assignment UI labeled as "Legacy" for clarity
8. All actions have proper aria-labels
</success_criteria>

<output>
After completion, create `.planning/phases/38-re-review-overhaul/38-04-SUMMARY.md`
</output>
