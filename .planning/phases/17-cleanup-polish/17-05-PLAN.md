---
phase: 17-cleanup-polish
plan: 05
type: execute
wave: 4
depends_on: ["17-04"]
files_modified:
  - app/vite.config.ts
  - .planning/phases/17-cleanup-polish/BUNDLE-ANALYSIS.md
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Bundle size meets <2MB gzipped target (or documented exception per CONTEXT.md)"
    - "Code splitting working for heavy visualization libraries"
    - "Critical path (landing, gene, entity, disease pages) loads fast"
    - "Bundle visualization shows optimization results"
  artifacts:
    - path: "app/vite.config.ts"
      provides: "Optimized build configuration"
      contains: "manualChunks"
    - path: ".planning/phases/17-cleanup-polish/BUNDLE-ANALYSIS.md"
      provides: "Post-optimization measurements"
      contains: "After optimization"
  key_links:
    - from: "app/vite.config.ts"
      to: "rollup"
      via: "build.rollupOptions"
      pattern: "manualChunks"
---

<objective>
Optimize bundle size to meet <2MB gzipped target

Purpose: Ensure fast page loads and meet the hard limit defined in CONTEXT.md
Output: Optimized bundle configuration, updated BUNDLE-ANALYSIS.md with results
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-cleanup-polish/17-CONTEXT.md
@.planning/phases/17-cleanup-polish/17-RESEARCH.md
@.planning/phases/17-cleanup-polish/BUNDLE-ANALYSIS.md
@app/vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze current bundle and identify optimization opportunities</name>
  <files>.planning/phases/17-cleanup-polish/BUNDLE-ANALYSIS.md</files>
  <action>
Run production build with analysis:
```bash
cd app && ANALYZE=true npm run build:production
```

Open dist/stats.html and document in BUNDLE-ANALYSIS.md:
1. Current total bundle size (gzipped)
2. Largest chunks:
   - vendor (vue, vue-router, pinia)
   - bootstrap (bootstrap, bootstrap-vue-next)
   - viz (d3, @upsetjs/bundle, gsap)
3. Any unexpected large modules
4. CSS bundle size

Compare to 2MB target. Calculate how much reduction needed (if any).

Identify optimization opportunities:
- Large libraries that could be lazy-loaded
- Duplicate code between chunks
- CSS that could be optimized
- Modules included but not used
  </action>
  <verify>
```bash
cat .planning/phases/17-cleanup-polish/BUNDLE-ANALYSIS.md | grep -A5 "Current total"
```
Analysis section updated with current state.
  </verify>
  <done>Bundle analysis complete with optimization opportunities identified</done>
</task>

<task type="auto">
  <name>Task 2: Optimize bundle configuration</name>
  <files>app/vite.config.ts</files>
  <action>
Based on analysis, optimize vite.config.ts build configuration.

**Review and optimize manualChunks:**
Current configuration has:
- vendor: ['vue', 'vue-router', 'pinia'] - KEEP (critical path)
- bootstrap: ['bootstrap', 'bootstrap-vue-next'] - KEEP (used everywhere)
- viz: ['d3', '@upsetjs/bundle', 'gsap'] - Consider splitting further

If viz chunk is too large, split:
```typescript
manualChunks: {
  vendor: ['vue', 'vue-router', 'pinia'],
  bootstrap: ['bootstrap', 'bootstrap-vue-next'],
  d3: ['d3'],
  upset: ['@upsetjs/bundle'],
  gsap: ['gsap'],
}
```

**Add chunk size warning configuration:**
```typescript
build: {
  chunkSizeWarningLimit: 500, // Warn on chunks > 500KB
  // ... existing options
}
```

**Consider dynamic imports for heavy components:**
If analysis shows UpSet or D3 visualizations are on non-critical paths, ensure they use dynamic imports (should already be done via defineAsyncComponent from global-components.js pattern).

**CSS optimization (if needed based on analysis):**
If CSS is >30% of bundle, consider adding PurgeCSS with Bootstrap safelist:
```typescript
// Only add if CSS optimization needed
import { purgecss } from '@mojojoejo/vite-plugin-purgecss';
// See RESEARCH.md for safelist configuration
```

DO NOT add PurgeCSS unless CSS is clearly bloating bundle - it can break Bootstrap-Vue-Next.
  </action>
  <verify>
```bash
cd app && npm run build:production
# Check total size
du -sh app/dist/
find app/dist/assets -name "*.js" -exec gzip -c {} \; | wc -c | awk '{printf "%.2f MB\n", $1/1024/1024}'
```
Build succeeds with optimizations.
  </verify>
  <done>Bundle configuration optimized for size</done>
</task>

<task type="auto">
  <name>Task 3: Verify bundle meets target and update documentation</name>
  <files>.planning/phases/17-cleanup-polish/BUNDLE-ANALYSIS.md</files>
  <action>
Run final production build:
```bash
cd app && ANALYZE=true npm run build:production
```

Calculate final sizes:
```bash
# Total gzipped JS
find app/dist/assets -name "*.js" -exec gzip -c {} \; | wc -c

# Total gzipped CSS
find app/dist/assets -name "*.css" -exec gzip -c {} \; | wc -c

# Combined
echo "Total bundle (JS+CSS gzipped):"
(find app/dist/assets -name "*.js" -exec gzip -c {} \;; find app/dist/assets -name "*.css" -exec gzip -c {} \;) | wc -c | awk '{printf "%.2f MB\n", $1/1024/1024}'
```

Update BUNDLE-ANALYSIS.md with:
- "After optimization" section
- Before/after comparison table
- Final chunk breakdown
- Whether 2MB target is met
- If NOT met, document per CONTEXT.md: "If meeting limit requires cutting features, soften limit instead"

Verify app still works:
```bash
cd app && npm run dev &
sleep 3
curl -s http://localhost:5173 | head -10
pkill -f "vite"
cd app && npm run test:unit
```
  </action>
  <verify>
```bash
cat .planning/phases/17-cleanup-polish/BUNDLE-ANALYSIS.md | tail -30
cd app && npm run test:unit
```
BUNDLE-ANALYSIS.md updated with final results, tests pass.
  </verify>
  <done>Bundle optimization complete, results documented, target met or exception documented</done>
</task>

</tasks>

<verification>
- [ ] Production build generates optimized bundle
- [ ] Bundle size documented in BUNDLE-ANALYSIS.md
- [ ] Target of <2MB gzipped met OR exception documented per CONTEXT.md
- [ ] manualChunks configuration optimized
- [ ] No chunk size warnings (or acceptable ones)
- [ ] Application still works correctly
- [ ] Tests pass
</verification>

<success_criteria>
- Bundle meets <2MB gzipped target (or documented exception)
- Optimization results documented with before/after comparison
- Code splitting working effectively
- Application functionality preserved
- BUNDLE-ANALYSIS.md complete with optimization history
</success_criteria>

<output>
After completion, create `.planning/phases/17-cleanup-polish/17-05-SUMMARY.md`
</output>
