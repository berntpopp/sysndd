---
phase: 04-makefile-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Makefile
autonomous: true

must_haves:
  truths:
    - "Running `make` displays categorized help output"
    - "Running `make install-api` installs R dependencies with renv"
    - "Running `make install-app` installs frontend dependencies with npm"
    - "Running `make dev` starts development database containers"
    - "Running `make docker-build` builds API Docker image"
  artifacts:
    - path: "Makefile"
      provides: "Root-level automation for all development tasks"
      min_lines: 80
      contains: ".DEFAULT_GOAL := help"
  key_links:
    - from: "Makefile:install-api"
      to: "api/renv.lock"
      via: "renv::restore()"
      pattern: "renv::restore"
    - from: "Makefile:install-app"
      to: "app/package.json"
      via: "npm install"
      pattern: "npm install"
    - from: "Makefile:dev"
      to: "docker-compose.dev.yml"
      via: "docker compose"
      pattern: "docker-compose.dev.yml"
---

<objective>
Create the root Makefile with core development targets including help, install, dev, and Docker operations.

Purpose: Establish unified command interface for developer onboarding and daily workflow.
Output: Working Makefile with help, install-api, install-app, dev, docker-build, docker-up, docker-down targets.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-makefile-automation/04-CONTEXT.md
@.planning/phases/04-makefile-automation/04-RESEARCH.md
@docker-compose.dev.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Makefile with preamble and help target</name>
  <files>Makefile</files>
  <action>
Create root-level Makefile with:

1. Davis-Hansson preamble:
   - `SHELL := bash`
   - `.ONESHELL:`
   - `.SHELLFLAGS := -eu -o pipefail -c`
   - `.DELETE_ON_ERROR:`
   - `MAKEFLAGS += --warn-undefined-variables`
   - `MAKEFLAGS += --no-builtin-rules`

2. ANSI color codes as variables:
   - GREEN, RED, CYAN, YELLOW, RESET

3. Self-documenting help target using `##` comments:
   - Parse targets with awk
   - Group output by section (Development, Docker)
   - Use cyan for target names, descriptions in default color
   - `.DEFAULT_GOAL := help`

4. Check-prerequisite helper targets (not in help):
   - `check-r` - verify R is installed
   - `check-npm` - verify npm is installed
   - `check-docker` - verify Docker daemon is running

5. Declare all targets as .PHONY at the top

Use the exact patterns from 04-RESEARCH.md. Tabs REQUIRED for recipe indentation.
  </action>
  <verify>
Run `make` and `make help` - both should display formatted help output with colorized target names
  </verify>
  <done>
`make` and `make help` both produce categorized help output with ANSI colors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add install, dev, and Docker targets</name>
  <files>Makefile</files>
  <action>
Add the following targets to the Makefile:

**Install targets (Development section):**
- `install-api` - Run `renv::restore(prompt = FALSE)` in api/ directory
  - Check R prerequisite first
  - Colorized step announcements
  - Success/failure status at end
- `install-app` - Run `npm install` in app/ directory
  - Check npm prerequisite first
  - Colorized step announcements

**Dev target (Development section):**
- `dev` - Start development database containers
  - Depend on check-docker
  - Run `docker compose -f docker-compose.dev.yml up -d`
  - Print instructions for starting API and frontend after

**Docker targets (Docker section):**
- `docker-build` - Build API Docker image
  - Check docker prerequisite
  - Run `docker build -t sysndd-api ./api`
- `docker-up` - Start all production containers
  - Run `docker compose up -d`
- `docker-down` - Stop all containers
  - Run `docker compose down`

Follow patterns from 04-RESEARCH.md:
- Use `@` prefix to suppress command echo
- Use `&&` for chaining with success/failure messages
- Include actionable error messages for missing prerequisites
  </action>
  <verify>
1. `make install-api` runs renv::restore (or errors if R not installed)
2. `make install-app` runs npm install (or errors if npm not installed)
3. `make dev` starts docker containers (or errors if Docker not running)
4. `make docker-build` builds the API image
5. `make help` shows all new targets with descriptions
  </verify>
  <done>
All install, dev, and Docker targets work correctly with prerequisite checks and colorized output
  </done>
</task>

</tasks>

<verification>
- [ ] `make` displays help output
- [ ] `make help` displays same help output
- [ ] `make install-api` attempts renv::restore()
- [ ] `make install-app` attempts npm install
- [ ] `make dev` starts Docker containers
- [ ] `make docker-build` builds API image
- [ ] `make docker-up` starts containers
- [ ] `make docker-down` stops containers
- [ ] All targets have `##` description comments
- [ ] Colorized output (cyan targets, green success, red failure)
</verification>

<success_criteria>
Running `make help` displays all core targets with descriptions. Running `make dev` starts the development databases. Running `make install-api` and `make install-app` install dependencies for their respective components.
</success_criteria>

<output>
After completion, create `.planning/phases/04-makefile-automation/04-01-SUMMARY.md`
</output>
