---
phase: 41-gene-page-redesign
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - api/endpoints/gene_endpoints.R
  - api/tests/testthat/test-integration-gene-endpoints.R
autonomous: true

must_haves:
  truths:
    - "Gene API returns bed_hg38 chromosome coordinates for genes that have them"
    - "Gene API returns null for bed_hg38 when coordinates are not available"
    - "Existing gene API fields remain unchanged"
  artifacts:
    - path: "api/endpoints/gene_endpoints.R"
      provides: "Gene endpoint with bed_hg38 field added"
      contains: "bed_hg38"
    - path: "api/tests/testthat/test-integration-gene-endpoints.R"
      provides: "Integration test verifying bed_hg38 in response"
      contains: "bed_hg38"
  key_links:
    - from: "api/endpoints/gene_endpoints.R"
      to: "non_alt_loci_set table"
      via: "select() adding bed_hg38"
      pattern: "bed_hg38"
---

<objective>
Add chromosome coordinates (bed_hg38) to the gene API endpoint response so the frontend hero section can display chromosome location.

Purpose: The gene page hero section (REDESIGN-01) needs chromosome location. The `non_alt_loci_set` database table already contains `bed_hg38` (format: "chr17:12345-67890") but the gene endpoint's `select()` call doesn't include it. This is a one-line backend change plus a test.

Output: Updated gene endpoint returning `bed_hg38` field, integration test confirming the field is present.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key files:
@api/endpoints/gene_endpoints.R (gene endpoint - lines 218-232 select fields from non_alt_loci_set)
@api/start_sysndd_api.R (bed_hg38 already in output_columns_allowed at line 206)

The non_alt_loci_set table already has bed_hg38 column (populated by hgnc-functions.R during data import).
The gene endpoint at lines 218-232 selects specific columns but omits bed_hg38.
The fix is adding bed_hg38 to the select() call.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bed_hg38 to gene endpoint select</name>
  <files>api/endpoints/gene_endpoints.R</files>
  <action>
In `api/endpoints/gene_endpoints.R`, find the `select()` call inside the gene endpoint function (approximately lines 218-232). Add `bed_hg38` to the list of selected columns.

Current select:
```r
select(
  hgnc_id,
  symbol,
  name,
  entrez_id,
  ensembl_gene_id,
  ucsc_id,
  ccds_id,
  uniprot_ids,
  omim_id,
  mane_select,
  mgd_id,
  rgd_id,
  STRING_id
)
```

Change to:
```r
select(
  hgnc_id,
  symbol,
  name,
  entrez_id,
  ensembl_gene_id,
  ucsc_id,
  ccds_id,
  uniprot_ids,
  omim_id,
  mane_select,
  mgd_id,
  rgd_id,
  STRING_id,
  bed_hg38
)
```

This is a one-line addition. The `bed_hg38` column already exists in the `non_alt_loci_set` table (added during HGNC data import by `hgnc-functions.R` line 312). The column contains values like "chr17:12345-67890" or NA.

After the `mutate(across(everything(), ~ str_split(., pattern = "\\|")))` on line 236, `bed_hg38` will become a string array like all other fields. Genes without coordinates will have `[null]` due to the `@serializer json list(na="null")` annotation.

Do NOT modify anything else in this file.
  </action>
  <verify>Run `cd /home/bernt-popp/development/sysndd/api && Rscript -e "lintr::lint('endpoints/gene_endpoints.R')" 2>&1 | head -20` to confirm no lint issues.</verify>
  <done>Gene endpoint select() call includes bed_hg38, lint passes.</done>
</task>

<task type="auto">
  <name>Task 2: Add integration test for bed_hg38 field</name>
  <files>api/tests/testthat/test-integration-gene-endpoints.R</files>
  <action>
Check if `api/tests/testthat/test-integration-gene-endpoints.R` exists. If it does, add a test case. If not, check for any existing gene endpoint test file (grep for "gene" in test filenames).

Add an integration test that verifies:
1. The gene endpoint response includes `bed_hg38` in its field names
2. For a known gene with coordinates, `bed_hg38` is not null

Follow the existing integration test patterns in the project. Look at other `test-integration-*.R` files for the pattern (they typically use `httr2` or `testthat` with API calls).

If no integration test file exists for gene endpoints, create one following the pattern of existing integration test files. The test should:
```r
test_that("gene endpoint returns bed_hg38 field", {
  # This test verifies REDESIGN-01 requirement for chromosome location
  # The bed_hg38 field should be included in gene API response
  # Test can only run when API is available (integration test)
  skip_if_not(api_available(), "API not running")

  response <- # ... call gene endpoint for a known gene
  expect_true("bed_hg38" %in% names(response))
})
```

Adapt the pattern to match exactly how other integration tests in this project work (check imports, test helpers, API URL construction).
  </action>
  <verify>Run `cd /home/bernt-popp/development/sysndd/api && Rscript -e "lintr::lint('tests/testthat/test-integration-gene-endpoints.R')" 2>&1 | head -20` to confirm lint passes.</verify>
  <done>Integration test exists that verifies bed_hg38 is present in gene endpoint response. Lint passes.</done>
</task>

</tasks>

<verification>
1. `api/endpoints/gene_endpoints.R` select() includes `bed_hg38`
2. Integration test file exists with bed_hg38 verification
3. Lintr passes for both modified/created files
4. No other files modified (isolated change)
</verification>

<success_criteria>
- Gene endpoint returns bed_hg38 field (will be string[] after str_split, or [null] for genes without coordinates)
- Existing 13 fields unchanged in response
- Integration test covers the new field
- Zero lintr issues
</success_criteria>

<output>
After completion, create `.planning/phases/41-gene-page-redesign/41-02-SUMMARY.md`
</output>
