---
phase: 41-gene-page-redesign
plan: 04
type: execute
wave: 3
depends_on: ["41-02", "41-03"]
files_modified:
  - app/src/views/pages/GeneView.vue
autonomous: true

must_haves:
  truths:
    - "GeneView.vue uses Composition API with script setup"
    - "GeneView.vue renders GeneHero, IdentifierCard, and ClinicalResourcesCard sections"
    - "Simple centered spinner shows while gene data loads"
    - "Page content appears all at once when data is ready"
    - "Gene page uses responsive grid layout for desktop and tablet"
    - "TablesEntities section is preserved below the new layout"
    - "Page title updates to include gene symbol via useHead"
  artifacts:
    - path: "app/src/views/pages/GeneView.vue"
      provides: "Refactored gene page using Composition API and new components"
      min_lines: 80
  key_links:
    - from: "app/src/views/pages/GeneView.vue"
      to: "app/src/components/gene/GeneHero.vue"
      via: "component import"
      pattern: "GeneHero"
    - from: "app/src/views/pages/GeneView.vue"
      to: "app/src/components/gene/IdentifierCard.vue"
      via: "component import"
      pattern: "IdentifierCard"
    - from: "app/src/views/pages/GeneView.vue"
      to: "app/src/components/gene/ClinicalResourcesCard.vue"
      via: "component import"
      pattern: "ClinicalResourcesCard"
    - from: "app/src/views/pages/GeneView.vue"
      to: "/api/gene/"
      via: "axios fetch in loadGeneInfo"
      pattern: "api/gene/"
    - from: "app/src/views/pages/GeneView.vue"
      to: "app/src/types/gene.ts"
      via: "GeneApiData type import"
      pattern: "GeneApiData"
---

<objective>
Refactor GeneView.vue from Options API to Composition API (`<script setup>`) and replace the flat BTable layout with the new component-based layout: GeneHero + IdentifierCard + ClinicalResourcesCard in a responsive grid.

Purpose: This is the central deliverable of Phase 41 (REDESIGN-10). The 539-line Options API component with inline BTable templates becomes a clean orchestrator that composes section components. The refactored page loads gene data, distributes it to child components via props, and manages loading state.

Output: Fully refactored `GeneView.vue` using all new components from Plans 01-03.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-gene-page-redesign/41-CONTEXT.md
@.planning/phases/41-gene-page-redesign/41-RESEARCH.md
@.planning/phases/41-gene-page-redesign/41-01-SUMMARY.md
@.planning/phases/41-gene-page-redesign/41-02-SUMMARY.md
@.planning/phases/41-gene-page-redesign/41-03-SUMMARY.md

Current file to refactor:
@app/src/views/pages/GeneView.vue

Components available:
- app/src/components/gene/GeneHero.vue (props: symbol, name, chromosomeLocation)
- app/src/components/gene/IdentifierCard.vue (props: geneData — GeneApiData object)
- app/src/components/gene/ClinicalResourcesCard.vue (props: symbol, hgncId, omimId, mgdId, rgdId)
- app/src/components/gene/IdentifierRow.vue (used internally by IdentifierCard)
- app/src/components/gene/ResourceLink.vue (used internally by ClinicalResourcesCard)
- app/src/components/ui/GeneBadge.vue (used internally by GeneHero)

Types:
- app/src/types/gene.ts (GeneApiData interface)

Existing behavior to preserve:
1. Loads gene data via two API calls (hgnc input type, then symbol input type as fallback)
2. Redirects to /PageNotFound if neither returns data
3. Shows BSpinner while loading
4. Renders TablesEntities component below gene info (pass-through, unchanged)
5. Sets page title/meta via useHead
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor GeneView.vue to Composition API with new layout</name>
  <files>app/src/views/pages/GeneView.vue</files>
  <action>
Completely rewrite `app/src/views/pages/GeneView.vue` using Composition API with `<script setup lang="ts">`.

**Script Section:**

Replace the entire Options API (`export default { ... }`) with `<script setup lang="ts">`:

1. Imports:
   - `ref, computed, onMounted, watch` from 'vue'
   - `useRoute, useRouter` from 'vue-router'
   - `useHead` from '@unhead/vue'
   - `useToast` from '@/composables'
   - `axios` from 'axios' (check how current codebase imports axios — it may use `this.axios` which is a global plugin; if so, import axios directly or use the app's API utility)
   - `GeneHero` from '@/components/gene/GeneHero.vue'
   - `IdentifierCard` from '@/components/gene/IdentifierCard.vue'
   - `ClinicalResourcesCard` from '@/components/gene/ClinicalResourcesCard.vue'
   - `TablesEntities` from '@/components/tables/TablesEntities.vue'
   - `type GeneApiData` from '@/types/gene'

2. Reactive state:
   ```typescript
   const route = useRoute();
   const router = useRouter();
   const { makeToast } = useToast();

   const loading = ref(true);
   const geneData = ref<GeneApiData[]>([]);
   ```

3. Computed properties (use computed for all derived data — do NOT access nested arrays in template):
   ```typescript
   const gene = computed(() => geneData.value[0] || null);
   const geneSymbol = computed(() => gene.value?.symbol?.[0] || '');
   const geneName = computed(() => gene.value?.name?.[0] || '');
   const chromosomeLocation = computed(() => gene.value?.bed_hg38?.[0] || '');
   const hgncId = computed(() => gene.value?.hgnc_id?.[0] || '');
   const omimId = computed(() => gene.value?.omim_id?.[0] || '');
   const mgdId = computed(() => gene.value?.mgd_id?.[0] || '');
   const rgdId = computed(() => gene.value?.rgd_id?.[0] || '');
   const filterInput = computed(() =>
     geneData.value.length > 0
       ? `equals(symbol,${geneData.value[0].symbol})`
       : ''
   );
   ```

4. Data loading (preserve existing logic):
   ```typescript
   async function loadGeneInfo() {
     loading.value = true;
     const symbol = route.params.symbol as string;
     const apiBase = import.meta.env.VITE_API_URL;
     const apiGeneURL = `${apiBase}/api/gene/${symbol}?input_type=hgnc`;
     const apiGeneSymbolURL = `${apiBase}/api/gene/${symbol}?input_type=symbol`;

     try {
       const responseGene = await axios.get(apiGeneURL);
       const responseSymbol = await axios.get(apiGeneSymbolURL);

       if (responseGene.data.length === 0 && responseSymbol.data.length === 0) {
         router.push('/PageNotFound');
       } else if (responseGene.data.length === 0) {
         geneData.value = responseSymbol.data;
       } else {
         geneData.value = responseGene.data;
       }
     } catch (e) {
       makeToast(e as string, 'Error', 'danger');
     }
     loading.value = false;
   }
   ```

   IMPORTANT: Check how `this.axios` is provided in the current codebase. The current code uses `this.axios.get(...)` which means axios is likely a Vue plugin (vue-axios). In script setup, either:
   - Import axios directly: `import axios from 'axios'` (preferred, simpler)
   - Or use the app's injected instance if required

   Check `app/src/main.ts` or `app/src/plugins/` for how axios is configured. If it has interceptors/base URL configured via plugin, import axios directly and verify the base URL pattern works.

5. useHead (dynamic title):
   ```typescript
   useHead({
     title: computed(() => geneSymbol.value ? `Gene: ${geneSymbol.value}` : 'Gene'),
     meta: [
       {
         name: 'description',
         content: computed(() =>
           geneSymbol.value
             ? `Gene information for ${geneSymbol.value} (${geneName.value})`
             : 'Gene view shows specific information for a gene.'
         ),
       },
     ],
   });
   ```

6. Lifecycle:
   ```typescript
   onMounted(() => {
     loadGeneInfo();
   });
   ```

7. Route watcher (handle navigation between genes without full page reload):
   ```typescript
   watch(() => route.params.symbol, (newSymbol) => {
     if (newSymbol) {
       loadGeneInfo();
     }
   });
   ```

**Template Section:**

Replace the entire template with:

```html
<template>
  <div class="container-fluid bg-gradient">
    <!-- Loading State (REDESIGN-05): Simple centered spinner per CONTEXT.md -->
    <div v-if="loading" class="d-flex justify-content-center align-items-center py-5">
      <BSpinner label="Loading gene data..." />
    </div>

    <!-- Gene Content (appears all at once when ready) -->
    <BContainer v-else fluid>
      <!-- Hero Section (REDESIGN-01) -->
      <GeneHero
        :symbol="geneSymbol"
        :name="geneName"
        :chromosome-location="chromosomeLocation"
      />

      <!-- Cards Grid (REDESIGN-09: Responsive layout) -->
      <BRow class="g-3 py-3">
        <!-- Identifier Card (REDESIGN-02) -->
        <BCol cols="12" lg="6">
          <IdentifierCard
            v-if="gene"
            :gene-data="gene"
          />
        </BCol>

        <!-- Clinical Resources Card (REDESIGN-03, REDESIGN-04) -->
        <BCol cols="12" lg="6">
          <ClinicalResourcesCard
            :symbol="geneSymbol"
            :hgnc-id="hgncId"
            :omim-id="omimId"
            :mgd-id="mgdId"
            :rgd-id="rgdId"
          />
        </BCol>
      </BRow>

      <!-- Associated Entities Table (preserved from original) -->
      <TablesEntities
        v-if="geneData.length !== 0"
        :show-filter-controls="false"
        :show-pagination-controls="false"
        header-label="Associated "
        :filter-input="filterInput"
      />
    </BContainer>
  </div>
</template>
```

**Style Section:**

Remove the old `.btn-xs` styles (those are now in IdentifierRow.vue). Keep the minimal page-level styles:

```css
<style scoped>
/* Page-level styles only - component styles are in their respective files */
</style>
```

**Critical Implementation Notes:**

1. The responsive grid uses `cols="12" lg="6"` — full width on mobile/tablet, side-by-side on desktop (>=992px). This satisfies REDESIGN-09.
2. Loading state is a simple centered spinner, NOT skeleton/shimmer (per CONTEXT.md override of REDESIGN-05).
3. Content appears all at once when `loading` flips to false (per CONTEXT.md).
4. TablesEntities is preserved exactly as-is — it's the associated entities table that still uses the old pattern. Do NOT refactor it in this plan.
5. The `bg-gradient` class on the outer div is preserved from the original.
6. BSpinner, BContainer, BRow, BCol are auto-imported by bootstrap-vue-next plugin (check if the project uses auto-import or explicit imports — follow existing pattern).
  </action>
  <verify>
Run all of these checks:
1. `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty 2>&1 | head -30` — TypeScript compilation
2. `cd /home/bernt-popp/development/sysndd/app && npx eslint src/views/pages/GeneView.vue 2>&1 | head -20` — ESLint
3. `cd /home/bernt-popp/development/sysndd/app && npx vite build --mode development 2>&1 | tail -20` — Build succeeds
  </verify>
  <done>
GeneView.vue is refactored to Composition API with script setup. Template uses GeneHero + IdentifierCard + ClinicalResourcesCard in responsive grid. Simple spinner loading state. TablesEntities preserved. TypeScript compiles, ESLint passes, Vite build succeeds.
  </done>
</task>

</tasks>

<verification>
1. GeneView.vue uses `<script setup lang="ts">` (no more Options API)
2. Template renders: GeneHero, IdentifierCard, ClinicalResourcesCard in BRow/BCol grid
3. Loading state: BSpinner centered (not skeleton)
4. Content appears all at once when loading completes
5. Responsive: `cols="12" lg="6"` on cards
6. TablesEntities still renders below cards
7. useHead sets dynamic page title with gene symbol
8. Route watcher handles gene-to-gene navigation
9. All existing navigation behavior preserved (PageNotFound redirect, dual API call fallback)
10. TypeScript + ESLint + Vite build all pass
</verification>

<success_criteria>
- GeneView.vue line count reduced from 539 to ~80-120 lines (complexity moved to child components)
- No Options API syntax remains (no `data()`, `methods`, `mounted()`, `computed`)
- All 10 REDESIGN requirements addressed:
  - REDESIGN-01: Hero section (GeneHero)
  - REDESIGN-02: Identifier card (IdentifierCard)
  - REDESIGN-03: Clinical resources (ClinicalResourcesCard)
  - REDESIGN-04: Model organisms (in ClinicalResourcesCard)
  - REDESIGN-05: Loading spinner (BSpinner, not skeleton per CONTEXT.md)
  - REDESIGN-06: Empty states (handled by IdentifierRow/ResourceLink)
  - REDESIGN-07: IdentifierRow component (Plan 01)
  - REDESIGN-08: ResourceLink component (Plan 01)
  - REDESIGN-09: Responsive grid (BRow/BCol breakpoints)
  - REDESIGN-10: Composition API refactor (this plan)
- Build succeeds, no errors
</success_criteria>

<output>
After completion, create `.planning/phases/41-gene-page-redesign/41-04-SUMMARY.md`
</output>
