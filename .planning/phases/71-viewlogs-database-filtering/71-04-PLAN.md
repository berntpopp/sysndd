---
phase: 71-viewlogs-database-filtering
plan: 04
type: execute
wave: 2
depends_on: ["71-02", "71-03"]
files_modified:
  - api/endpoints/logging_endpoints.R
autonomous: true

must_haves:
  truths:
    - "GET /api/logs endpoint uses get_logs_filtered() from repository"
    - "Response uses existing cursor-based pagination format (links, meta, data)"
    - "Invalid filter columns return 400 with error_type: invalid_filter_error"
    - "Endpoint no longer calls collect() on logging table"
    - "Maintains backward compatibility with existing page_after/page_size params"
  artifacts:
    - path: "api/endpoints/logging_endpoints.R"
      provides: "Refactored logging endpoint"
      min_lines: 100
  key_links:
    - from: "api/endpoints/logging_endpoints.R"
      to: "api/functions/logging-repository.R"
      via: "source() and get_logs_filtered() call"
      pattern: "get_logs_filtered"
    - from: "api/endpoints/logging_endpoints.R"
      to: "api/functions/logging-repository.R"
      via: "parse_logging_filter for filter string parsing"
      pattern: "parse_logging_filter"
---

<objective>
Refactor the logging endpoint to use the new repository layer for database-side filtering while maintaining the existing cursor-based pagination API.

Purpose: Replace the current implementation that loads all rows with collect() before filtering, with the new get_logs_filtered() function that filters in the database using WHERE clauses. The existing cursor-based pagination (page_after/page_size) is preserved via generate_cursor_pag_inf().

Output: Refactored `api/endpoints/logging_endpoints.R` that uses database-side filtering.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/71-viewlogs-database-filtering/71-RESEARCH.md

# Current implementation to refactor:
@api/endpoints/logging_endpoints.R

# New repository functions to use:
@api/functions/logging-repository.R

# Existing pagination helper (cursor-based):
@api/functions/helper-functions.R (contains generate_cursor_pag_inf)

# Dependencies:
@.planning/phases/71-viewlogs-database-filtering/71-02-SUMMARY.md
@.planning/phases/71-viewlogs-database-filtering/71-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add logging-repository.R source to endpoint file</name>
  <files>api/endpoints/logging_endpoints.R</files>
  <action>
Add the source statement for the logging repository at the top of logging_endpoints.R, after the existing imports/header.

Add near the top of the file (after the header comments, before the endpoint functions):

```r
# Load logging repository for database-side filtering (fixes #152)
if (!exists("get_logs_filtered", mode = "function")) {
  if (file.exists("functions/logging-repository.R")) {
    source("functions/logging-repository.R", local = FALSE)
  }
}
```
  </action>
  <verify>
```bash
# Source statement exists
grep "logging-repository.R" api/endpoints/logging_endpoints.R
grep "get_logs_filtered" api/endpoints/logging_endpoints.R
```
  </verify>
  <done>
logging-repository.R is sourced at the top of logging_endpoints.R, making get_logs_filtered() available.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor GET / endpoint to use repository</name>
  <files>api/endpoints/logging_endpoints.R</files>
  <action>
Refactor the `GET /` endpoint function to use `get_logs_filtered()` instead of the current collect() pattern.

**Current problematic code to replace (lines 64-71):**
```r
# Get logs from database
logs_raw <- pool %>%
  tbl("logging") %>%
  collect()

# Sort & filter
logs_raw <- logs_raw %>%
  arrange(!!!rlang::parse_exprs(sort_exprs)) %>%
  filter(!!!rlang::parse_exprs(filter_exprs))
```

**New implementation:**

Keep the existing endpoint signature (maintain backward compatibility):
- sort, filter, fields, page_after, page_size, fspec, format

Replace the data fetching with:

```r
# Parse sort parameter to get column and direction
sort_parts <- parse_sort_param(sort)
sort_column <- sort_parts$column
sort_direction <- sort_parts$direction

# Parse filter string to filter list for repository
# Note: The existing filter param uses format like "status==200,path=^/api/"
# parse_logging_filter converts this to repository format
tryCatch(
  {
    filter_list <- parse_logging_filter(filter)

    # Use repository for database-side filtering (fixes #152 - no collect())
    logs_raw <- get_logs_filtered(
      filters = filter_list,
      sort_column = sort_column,
      sort_direction = sort_direction
    )

    # Rest of endpoint continues as before with generate_cursor_pag_inf()
    ...
  },
  invalid_filter_error = function(e) {
    res$status <- 400
    return(list(
      error = "INVALID_FILTER",
      error_type = "invalid_filter_error",
      message = e$message
    ))
  }
)
```

Also add a helper function at the top of the file to parse the sort param:

```r
#' Parse sort parameter into column and direction
#' @param sort Character, sort spec like "id" or "-timestamp" (prefix - means DESC)
#' @return List with column and direction
parse_sort_param <- function(sort) {
  if (startsWith(sort, "-")) {
    list(column = substring(sort, 2), direction = "DESC")
  } else {
    list(column = sort, direction = "ASC")
  }
}
```

Key changes:
- Removes `pool %>% tbl("logging") %>% collect()` pattern (the root cause of #152)
- Uses `get_logs_filtered()` for database-side filtering
- Keeps existing `generate_cursor_pag_inf()` for cursor pagination
- Maintains same API signature (sort, filter, page_after, page_size)
- Adds tryCatch for invalid_filter_error
  </action>
  <verify>
```bash
# No collect() in GET endpoint (the main fix)
# Note: DELETE endpoint still has collect() which is fine
grep -n "collect()" api/endpoints/logging_endpoints.R

# Uses get_logs_filtered
grep "get_logs_filtered" api/endpoints/logging_endpoints.R

# Uses parse_logging_filter
grep "parse_logging_filter" api/endpoints/logging_endpoints.R

# Has tryCatch with invalid_filter_error handler
grep "invalid_filter_error" api/endpoints/logging_endpoints.R
```
  </verify>
  <done>
GET / endpoint refactored to:
- Use get_logs_filtered() instead of collect() (fixes #152)
- Use parse_logging_filter() to convert filter string
- Maintain existing cursor-based pagination via generate_cursor_pag_inf()
- Return 400 with invalid_filter_error for bad columns (LOG-04)
- Maintain backward compatibility with existing API
  </done>
</task>

<task type="auto">
  <name>Task 3: Update endpoint documentation</name>
  <files>api/endpoints/logging_endpoints.R</files>
  <action>
Update the roxygen-style documentation for the GET endpoint to note the database-side filtering improvement:

```r
#* Get Paginated Log Files
#*
#* This endpoint returns paginated log files from the database.
#*
#* # `Details`
#* Reads log entries from the database with database-side filtering.
#* Applies filtering at the SQL level using WHERE clauses, then
#* paginates using cursor-based pagination.
#*
#* Supported filter formats:
#* - status==200 (exact match on HTTP status)
#* - request_method==GET (exact match on method)
#* - path=^/api/ (prefix match on path)
#* - timestamp>=2026-01-01 (minimum timestamp)
#* - timestamp<=2026-01-31 (maximum timestamp)
#* - address==127.0.0.1 (exact match on IP)
#*
#* # `Return`
#* A cursor pagination object with `links`, `meta`, and `data`.
#*
#* @response 400 Bad Request. Invalid filter or sort column.
```

Add the @response 400 line to document the new error case.
  </action>
  <verify>
```bash
# Updated documentation mentions database-side filtering
grep "database-side filtering" api/endpoints/logging_endpoints.R

# Documents filter formats
grep "status==" api/endpoints/logging_endpoints.R

# Documents 400 response
grep "@response 400" api/endpoints/logging_endpoints.R
```
  </verify>
  <done>
Endpoint documentation updated to reflect:
- Database-side filtering for performance
- Supported filter formats
- 400 response for invalid filters
  </done>
</task>

</tasks>

<verification>
1. Endpoint no longer uses `pool %>% tbl("logging") %>% collect()` pattern in GET
2. Endpoint calls `get_logs_filtered()` from repository
3. Uses existing `generate_cursor_pag_inf()` for cursor pagination (backward compatible)
4. Invalid columns return 400 with error_type: invalid_filter_error (LOG-04)
5. Existing API parameters preserved (sort, filter, page_after, page_size, etc.)
6. xlsx export still works
7. lintr passes on modified file
</verification>

<success_criteria>
- GET /api/logs uses database-side filtering via get_logs_filtered() (LOG-01)
- Cursor-based pagination preserved via generate_cursor_pag_inf()
- Invalid filter columns return 400 with invalid_filter_error (LOG-04)
- No collect() in GET endpoint
- All existing functionality (xlsx export, filter, sort) preserved
- API backward compatible (same params: sort, filter, page_after, page_size)
- `make lint-api` passes
</success_criteria>

<output>
After completion, create `.planning/phases/71-viewlogs-database-filtering/71-04-SUMMARY.md`
</output>
