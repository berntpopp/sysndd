---
phase: 85-ghost-entity-cleanup-prevention
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/tests/testthat/test-unit-entity-service.R
autonomous: true

must_haves:
  truths:
    - "GitHub issue in sysndd-administration contains complete remediation SQL for all three ghost entities"
    - "GitHub issue reflects that prevention (atomic creation) is already implemented"
    - "Transaction pattern static analysis tests pass"
    - "Entity service tests verify svc_entity_create_full error handling contracts"
  artifacts:
    - path: "api/tests/testthat/test-unit-entity-service.R"
      provides: "Enhanced entity service tests with rollback contract verification"
      contains: "svc_entity_create_full"
    - path: "api/tests/testthat/test-unit-transaction-patterns.R"
      provides: "Static analysis of transaction patterns (already exists)"
      contains: "db_with_transaction"
  key_links:
    - from: "api/endpoints/entity_endpoints.R"
      to: "api/services/entity-service.R"
      via: "svc_entity_create_full() call at line 351"
      pattern: "svc_entity_create_full"
    - from: "api/services/entity-service.R"
      to: "api/functions/db-helpers.R"
      via: "db_with_transaction(function(txn_conn))"
      pattern: "db_with_transaction"
---

<objective>
Close out ghost entity cleanup phase: update the existing GitHub issue to reflect that prevention is already in production, and enhance test coverage for the entity creation transaction rollback contract.

Purpose: Phase 85 originally scoped both cleanup (GitHub issue) and prevention (atomic creation wrapper). Research discovered that both are already done -- the GitHub issue exists (sysndd-administration#2) and the endpoint already uses svc_entity_create_full() (commit 831ac85a). This plan verifies the existing work, updates the issue to remove the misleading "being fixed" note, and adds functional tests for the rollback error-handling contract.

Output: Updated GitHub issue, enhanced entity service tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/85-ghost-entity-cleanup-prevention/85-CONTEXT.md
@.planning/phases/85-ghost-entity-cleanup-prevention/85-RESEARCH.md
@api/services/entity-service.R
@api/endpoints/entity_endpoints.R
@api/tests/testthat/test-unit-entity-service.R
@api/tests/testthat/test-unit-transaction-patterns.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update GitHub issue and verify prevention is in place</name>
  <files>No local files modified</files>
  <action>
1. Read the current GitHub issue #2 in berntpopp/sysndd-administration:
   `gh issue view 2 --repo berntpopp/sysndd-administration`

2. Update the issue body to fix the misleading note. The current body contains:
   "This is being fixed in the SysNDD codebase (Phase 85 - atomic creation wrapper)"

   Replace that sentence with:
   "**Prevention already implemented:** The entity creation endpoint was refactored to use `svc_entity_create_full()` in commit 831ac85a (2026-02-06), which wraps all creation steps (entity, review, publications, phenotypes, variation ontology, status) in a single database transaction via `db_with_transaction()`. New ghost entities cannot be created with the current code. This issue addresses only the cleanup of the three existing ghost entities."

   Use `gh issue edit 2 --repo berntpopp/sysndd-administration --body "..."` to update.

3. Add a comment to the issue documenting the verification:
   `gh issue comment 2 --repo berntpopp/sysndd-administration --body "..."`

   Comment content should state:
   - Prevention verified: POST /api/entity/create uses svc_entity_create_full() (entity_endpoints.R line 351)
   - Transaction wrapper: db_with_transaction(function(txn_conn)) pattern confirmed in entity-service.R line 586
   - Rollback logging: Error handler at entity-service.R lines 693-703 logs "Entity creation transaction failed - all changes rolled back" with hgnc_id
   - Static analysis guard: test-unit-transaction-patterns.R verifies all transaction calls use function-based pattern
   - Remaining action: Execute the SQL commands in this issue against the production database

4. Verify the endpoint code is correct by reading entity_endpoints.R lines 349-361 to confirm svc_entity_create_full is called.

5. Verify the transaction error handling by reading entity-service.R lines 584-717 to confirm:
   - db_with_transaction(function(txn_conn)) pattern used (line 586)
   - db_transaction_error handler logs and returns 500 (lines 693-703)
   - Generic error handler as fallback (lines 705-716)
  </action>
  <verify>
- `gh issue view 2 --repo berntpopp/sysndd-administration` shows updated body without "being fixed" phrasing
- `gh issue view 2 --repo berntpopp/sysndd-administration --json comments --jq '.comments | length'` returns at least 1 comment
- Reading entity_endpoints.R confirms svc_entity_create_full at line 351
  </verify>
  <done>GitHub issue #2 accurately reflects that prevention is already implemented; issue body no longer says "being fixed"; verification comment documents the code evidence</done>
</task>

<task type="auto">
  <name>Task 2: Enhance entity service tests with rollback contract verification</name>
  <files>api/tests/testthat/test-unit-entity-service.R</files>
  <action>
Read the existing test file `api/tests/testthat/test-unit-entity-service.R` to understand the current test structure and patterns.

Add a new test section after the existing `svc_entity_create_full Signature Tests` section (around line 207+). The new tests verify the ERROR-HANDLING CONTRACT of svc_entity_create_full without needing a real database. These are unit tests that mock dependencies.

Add the following tests:

**Test: "svc_entity_create_full returns 409 when duplicate detected"**
- Mock `svc_entity_validate` to succeed (do nothing)
- Mock `svc_entity_check_duplicate` to return a non-NULL value (e.g., `list(entity_id = 999)`)
- Call `svc_entity_create_full()` with minimal valid arguments and a fake pool
- Assert result$status == 409
- Assert result$message contains "Conflict" or "already exists"
- This verifies the duplicate-check short-circuit at lines 551-563

**Test: "svc_entity_create_full returns 400 on validation error"**
- Mock `svc_entity_validate` to signal an `entity_creation_validation_error` condition
- Mock `svc_entity_check_duplicate` to return NULL (no duplicate)
- Mock `publication_validate_ids` to signal an `publication_validation_error` condition
- Provide publications data with a dummy publication_id
- Call `svc_entity_create_full()` with minimal valid arguments
- Assert result$status == 400
- Assert result$message contains "Bad Request"
- This verifies the validation error handler at lines 685-691

**Test: "svc_entity_create_full returns 500 on transaction error"**
- Mock `svc_entity_validate` to succeed
- Mock `svc_entity_check_duplicate` to return NULL (no duplicate)
- Mock `db_with_transaction` to signal a `db_transaction_error` condition with message "Connection lost"
- Call `svc_entity_create_full()` with minimal valid arguments
- Assert result$status == 500
- Assert result$message contains "rolled back"
- This verifies the transaction error handler at lines 693-703

**Test: "svc_entity_create_full returns 500 on unexpected error"**
- Mock `svc_entity_validate` to succeed
- Mock `svc_entity_check_duplicate` to return NULL (no duplicate)
- Mock `db_with_transaction` to stop() with a generic error
- Call `svc_entity_create_full()` with minimal valid arguments
- Assert result$status == 500
- Assert result$message contains "Entity creation failed"
- This verifies the fallback error handler at lines 705-716

Use `mockery::stub()` or `local_mocked_bindings()` (testthat 3e) for mocking. Follow the pattern already used in the test file. Ensure each test is self-contained.

Minimal valid arguments for svc_entity_create_full:
```r
entity_data <- list(hgnc_id = 1, disease_ontology_id_version = "MONDO:0000001",
                    hpo_mode_of_inheritance_term = "HP:0000006",
                    ndd_phenotype = "Definitive")
review_data <- list(synopsis = "Test", review_user_id = 1)
status_data <- list(category_id = 1, problematic = 0, status_user_id = 1)
pool <- "fake_pool"  # Not used when mocked
```

Important: These tests do NOT require a database connection. They test the error-handling logic flow only.
  </action>
  <verify>
Run the tests:
```bash
cd /home/bernt-popp/development/sysndd && docker exec sysndd-api-1 Rscript -e "testthat::test_file('/app/tests/testthat/test-unit-entity-service.R')" 2>&1
```

If docker is not running, run locally:
```bash
cd /home/bernt-popp/development/sysndd/api && Rscript -e "testthat::test_file('tests/testthat/test-unit-entity-service.R')"
```

Also run the existing transaction pattern tests to confirm no regressions:
```bash
cd /home/bernt-popp/development/sysndd/api && Rscript -e "testthat::test_file('tests/testthat/test-unit-transaction-patterns.R')"
```

All tests should pass. The 4 new tests should appear in output.
  </verify>
  <done>
- 4 new tests added to test-unit-entity-service.R covering: duplicate detection (409), validation error (400), transaction error (500 + rollback message), unexpected error (500)
- All existing tests continue to pass
- Transaction pattern static analysis tests continue to pass
  </done>
</task>

</tasks>

<verification>
1. GitHub issue sysndd-administration#2 body updated -- no longer says "being fixed"
2. GitHub issue has verification comment documenting code evidence
3. Entity service tests pass with 4 new rollback-contract tests
4. Transaction pattern tests pass (no regressions)
5. Entity creation endpoint still references svc_entity_create_full (grep confirms)
</verification>

<success_criteria>
- GitHub issue #2 in sysndd-administration accurately reflects prevention is already implemented
- Entity service test file has 4 new error-handling contract tests (409, 400, 500 transaction, 500 unexpected)
- All R tests in test-unit-entity-service.R and test-unit-transaction-patterns.R pass
- No code changes to entity_endpoints.R or entity-service.R (prevention already complete)
</success_criteria>

<output>
After completion, create `.planning/phases/85-ghost-entity-cleanup-prevention/85-01-SUMMARY.md`
</output>
