---
phase: 43-protein-domain-lollipop-plot
plan: 02
type: execute
wave: 2
depends_on: ["43-01"]
files_modified:
  - app/src/components/gene/ProteinDomainLollipopPlot.vue
autonomous: true

must_haves:
  truths:
    - "D3 lollipop plot renders protein backbone as horizontal line with amino acid scale"
    - "UniProt protein domains render as colored rectangles on the backbone"
    - "ClinVar variants render as lollipop markers (stem + circle) at amino acid positions"
    - "Markers colored by pathogenicity using ACMG color spectrum (red/orange/yellow/green)"
    - "Multiple variants at same position stack vertically with individual markers visible"
    - "Splice variants render as triangles/diamonds distinct from coding variant circles"
    - "Hover tooltip shows protein HGVS, coding HGVS, classification, review stars"
    - "Brush selection zooms into region, double-click resets to full view"
    - "Clickable legend toggles pathogenicity category visibility"
  artifacts:
    - path: "app/src/components/gene/ProteinDomainLollipopPlot.vue"
      provides: "D3 lollipop plot visualization component"
      min_lines: 100
  key_links:
    - from: "app/src/components/gene/ProteinDomainLollipopPlot.vue"
      to: "app/src/composables/useD3Lollipop.ts"
      via: "import composable"
      pattern: "useD3Lollipop"
    - from: "app/src/components/gene/ProteinDomainLollipopPlot.vue"
      to: "app/src/types/protein.ts"
      via: "import types"
      pattern: "import.*ProteinPlotData|ProcessedVariant"
---

<objective>
Create the ProteinDomainLollipopPlot.vue component that uses the useD3Lollipop composable to render the interactive D3.js protein domain visualization.

Purpose: This is the core visualization component (PROTEIN-01 through PROTEIN-08, CLINVAR-04/05) - the D3 rendering engine wrapped in a Vue component that accepts data props and emits events. Separation from the card wrapper allows reuse and clean testing.

Output: `app/src/components/gene/ProteinDomainLollipopPlot.vue` - Vue SFC with D3 rendering.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-protein-domain-lollipop-plot/43-CONTEXT.md
@.planning/phases/43-protein-domain-lollipop-plot/43-RESEARCH.md
@.planning/phases/43-protein-domain-lollipop-plot/43-01-SUMMARY.md

Key references:
@app/src/composables/useD3Lollipop.ts (composable from Plan 01)
@app/src/types/protein.ts (types from Plan 01)
@app/src/components/analyses/AnalysesTimePlot.vue (existing D3 component pattern - SVG container, overlay spinner)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProteinDomainLollipopPlot Vue component</name>
  <files>app/src/components/gene/ProteinDomainLollipopPlot.vue</files>
  <action>
Create `app/src/components/gene/ProteinDomainLollipopPlot.vue` as a Vue 3 SFC with `<script setup lang="ts">`:

**Props:**
- data: ProteinPlotData (required) -- protein domains and variants to render
- geneSymbol: string (required) -- for ARIA labels and accessibility text

**Emits:**
- variant-click: (variant: ProcessedVariant) => void -- for future bidirectional linking (Phase 45)
- variant-hover: (variant: ProcessedVariant | null) => void -- for future bidirectional linking

**Template structure:**
```html
<div class="protein-lollipop-plot">
  <!-- SVG container (D3 owns this element exclusively) -->
  <div ref="plotContainer" class="plot-container" />

  <!-- Legend below plot (Vue owns this, not D3) -->
  <div class="plot-legend d-flex flex-wrap justify-content-center gap-3 mt-2">
    <button
      v-for="item in legendItems"
      :key="item.label"
      type="button"
      class="legend-item btn btn-sm"
      :class="{ 'legend-item--hidden': !item.visible }"
      :style="{ '--legend-color': item.color }"
      :aria-label="`Toggle ${item.label} variants`"
      :aria-pressed="item.visible"
      @click="toggleFilter(item.key)"
    >
      <span class="legend-dot" :style="{ backgroundColor: item.visible ? item.color : '#ccc' }" />
      <span class="legend-label">{{ item.label }}</span>
      <span v-if="item.count > 0" class="legend-count text-muted">({{ item.count }})</span>
    </button>
  </div>

  <!-- Domain legend below pathogenicity legend -->
  <div v-if="domainLegendItems.length > 0" class="domain-legend d-flex flex-wrap justify-content-center gap-2 mt-1">
    <span v-for="item in domainLegendItems" :key="item.type" class="domain-legend-item">
      <span class="domain-dot" :style="{ backgroundColor: item.color }" />
      <span class="domain-label text-muted small">{{ item.label }}</span>
    </span>
  </div>
</div>
```

**Script setup logic:**

1. **Refs:**
   - plotContainer: ref<HTMLElement | null>(null) -- template ref for D3 container
   - filterState: reactive<LollipopFilterState>({ pathogenic: true, likelyPathogenic: true, vus: true, likelyBenign: true, benign: true })

2. **useD3Lollipop composable:**
   ```typescript
   const { isInitialized, renderPlot, resetZoom } = useD3Lollipop({
     container: plotContainer,
     width: 800,
     height: 250,
     margin: { top: 60, right: 30, bottom: 60, left: 50 },
     onVariantClick: (variant) => emit('variant-click', variant),
     onVariantHover: (variant) => emit('variant-hover', variant),
   });
   ```

3. **Legend items** (computed from data and filterState):
   ```typescript
   const legendItems = computed(() => {
     const counts = countByClassification(props.data.variants);
     return [
       { key: 'pathogenic' as const, label: 'Pathogenic', color: PATHOGENICITY_COLORS['Pathogenic'], visible: filterState.pathogenic, count: counts['Pathogenic'] || 0 },
       { key: 'likelyPathogenic' as const, label: 'Likely pathogenic', color: PATHOGENICITY_COLORS['Likely pathogenic'], visible: filterState.likelyPathogenic, count: counts['Likely pathogenic'] || 0 },
       { key: 'vus' as const, label: 'VUS', color: PATHOGENICITY_COLORS['Uncertain significance'], visible: filterState.vus, count: counts['Uncertain significance'] || 0 },
       { key: 'likelyBenign' as const, label: 'Likely benign', color: PATHOGENICITY_COLORS['Likely benign'], visible: filterState.likelyBenign, count: counts['Likely benign'] || 0 },
       { key: 'benign' as const, label: 'Benign', color: PATHOGENICITY_COLORS['Benign'], visible: filterState.benign, count: counts['Benign'] || 0 },
     ];
   });
   ```
   Helper function `countByClassification` counts variants per pathogenicity class.

4. **Domain legend items** (computed from data):
   ```typescript
   const domainLegendItems = computed(() => {
     // Get unique domain types, map to color using d3.scaleOrdinal(d3.schemePaired)
     const uniqueTypes = [...new Set(props.data.domains.map(d => d.type))];
     const colorScale = d3.scaleOrdinal(d3.schemePaired);
     return uniqueTypes.map(type => ({
       type,
       label: formatDomainType(type), // 'DOMAIN' -> 'Domain', 'ZN_FING' -> 'Zinc finger'
       color: colorScale(type) as string,
     }));
   });
   ```
   Helper function `formatDomainType` converts type codes to human-readable labels.

5. **toggleFilter(key):** Toggles filterState[key], triggers re-render via watchEffect.

6. **watchEffect for reactive rendering:**
   ```typescript
   watchEffect(() => {
     if (isInitialized.value && props.data) {
       renderPlot(props.data, filterState);
     }
   });
   ```
   This re-renders whenever data changes OR filter state changes.

7. **watch for data prop changes:** Also watch props.data deeply and call renderPlot when it changes.

**Scoped styles:**
- .plot-container: width 100%, min-height 250px, position relative
- .plot-container :deep(svg): width 100%, height auto (responsive via viewBox)
- .legend-item: border 1px solid #dee2e6, border-radius 4px, padding 2px 8px, background white, cursor pointer, transition opacity
- .legend-item--hidden: opacity 0.4
- .legend-dot: display inline-block, width 10px, height 10px, border-radius 50%, margin-right 4px
- .domain-dot: display inline-block, width 12px, height 8px, border-radius 2px, margin-right 3px
- .lollipop-tooltip (deep): position absolute, background white, border 1px solid #ccc, border-radius 4px, padding 8px, pointer-events none, z-index 1000, font-size 12px, box-shadow 0 2px 4px rgba(0,0,0,0.1)

**Important implementation notes:**
- D3 owns the SVG element inside plotContainer exclusively (D3.js vs Vue DOM ownership -- CONTEXT pitfall #4)
- Vue owns the legend elements (rendered by Vue template)
- The tooltip is created by D3 (appended to plotContainer as a div) -- NOT a Vue component
- The color scale for domains (d3.schemePaired) must be consistent between the D3 rendering in useD3Lollipop and the Vue legend -- either pass the scale from composable or create it identically in both places. Preferred: create the color scale from domain types in this component and pass it to the composable's renderPlot function as additional parameter, OR have the composable accept a domainColorScale option.

**Adjusting composable API if needed:**
If the useD3Lollipop composable from Plan 01 needs a domainColorScale parameter to ensure consistency with the Vue legend, add it. The simplest approach: create the d3.scaleOrdinal(d3.schemePaired) scale in this component, pass it to renderPlot as an additional parameter, and use the same scale for the legend computed.
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors. Verify the component imports useD3Lollipop and ProteinPlotData correctly.
  </verify>
  <done>
ProteinDomainLollipopPlot.vue renders the D3 lollipop plot with protein backbone, domain rectangles, variant lollipops (colored by pathogenicity), stacking for overlapping variants, splice variant distinction, hover tooltips, brush-to-zoom, and clickable legend filter toggles. Vue owns legend, D3 owns SVG. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors
2. Component file exists at `app/src/components/gene/ProteinDomainLollipopPlot.vue`
3. Imports useD3Lollipop composable
4. Imports ProteinPlotData, PATHOGENICITY_COLORS from types
5. Has reactive filterState for pathogenicity toggles
6. Has watchEffect that calls renderPlot on data/filter changes
7. Emits variant-click and variant-hover events
8. Legend items are computed from data with counts per category
</verification>

<success_criteria>
- PROTEIN-01: D3 lollipop plot with protein backbone and amino acid scale renders correctly
- PROTEIN-02: UniProt domains rendered as colored rectangles on backbone
- PROTEIN-03: ClinVar variants rendered as lollipop markers at protein position
- PROTEIN-04: Markers colored by pathogenicity (ACMG colors)
- PROTEIN-05: Tooltip shows variant details on hover
- PROTEIN-06: Brush-to-zoom with double-click reset works
- PROTEIN-07: Domain legend shows color mapping
- PROTEIN-08: Stacked markers for overlapping variants at same position
- CLINVAR-04: Variants mapped onto plot at correct positions
- CLINVAR-05: Legend toggles filter variant visibility by classification
- Component type-checks cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/43-protein-domain-lollipop-plot/43-02-SUMMARY.md`
</output>
