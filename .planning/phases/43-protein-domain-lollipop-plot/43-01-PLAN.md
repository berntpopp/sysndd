---
phase: 43-protein-domain-lollipop-plot
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/types/protein.ts
  - app/src/types/index.ts
  - app/src/composables/useD3Lollipop.ts
  - app/src/composables/index.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript interfaces define protein domain data shape with start/end positions and type"
    - "TypeScript interfaces define processed ClinVar variant data with protein position and pathogenicity"
    - "useD3Lollipop composable initializes D3 SVG on mount and cleans up on unmount"
    - "D3 instance stored in non-reactive let variable to prevent Vue layout thrashing"
    - "Composable exposes updatePlot function for reactive data changes"
  artifacts:
    - path: "app/src/types/protein.ts"
      provides: "TypeScript interfaces for protein domain visualization data"
      exports: ["ProteinDomain", "ProcessedVariant", "ProteinPlotData", "PathogenicityClass"]
    - path: "app/src/composables/useD3Lollipop.ts"
      provides: "D3 lifecycle composable following useCytoscape pattern"
      exports: ["useD3Lollipop"]
  key_links:
    - from: "app/src/types/index.ts"
      to: "app/src/types/protein.ts"
      via: "barrel re-export"
      pattern: "export.*protein"
    - from: "app/src/composables/index.ts"
      to: "app/src/composables/useD3Lollipop.ts"
      via: "barrel re-export"
      pattern: "useD3Lollipop"
    - from: "app/src/composables/useD3Lollipop.ts"
      to: "app/src/types/protein.ts"
      via: "import type"
      pattern: "import.*from.*types/protein"
---

<objective>
Create the TypeScript type definitions for protein domain visualization and the useD3Lollipop composable that manages D3.js SVG lifecycle (initialization, updates, cleanup).

Purpose: Foundation layer (COMPOSE-04) that the visualization components will consume. Types define the data contract between backend API responses and frontend rendering. The composable follows the established useCytoscape pattern for safe D3/Vue integration.

Output: `app/src/types/protein.ts` (interfaces), `app/src/composables/useD3Lollipop.ts` (composable), updated barrel exports.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-protein-domain-lollipop-plot/43-CONTEXT.md
@.planning/phases/43-protein-domain-lollipop-plot/43-RESEARCH.md

Key references:
@app/src/composables/useCytoscape.ts (CRITICAL pattern -- non-reactive instance, onBeforeUnmount cleanup)
@app/src/types/gene.ts (existing type definition pattern)
@app/src/types/index.ts (barrel export pattern)
@app/src/composables/index.ts (barrel export pattern)
@api/functions/external-proxy-uniprot.R (backend UniProt domain response shape: type, description, begin, end)
@api/functions/external-proxy-gnomad.R (backend ClinVar variant shape: hgvsc, hgvsp, clinical_significance, gold_stars, pos, major_consequence, review_status, variant_id, clinvar_variation_id, in_gnomad)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypeScript interfaces for protein visualization data</name>
  <files>app/src/types/protein.ts, app/src/types/index.ts</files>
  <action>
Create `app/src/types/protein.ts` with these interfaces that bridge backend API responses to visualization rendering:

1. **PathogenicityClass** union type:
   ```typescript
   export type PathogenicityClass = 'Pathogenic' | 'Likely pathogenic' | 'Uncertain significance' | 'Likely benign' | 'Benign' | 'other';
   ```

2. **ProteinDomain** interface (maps from UniProt features API `external-proxy-uniprot.R` response):
   - type: string (e.g., 'DOMAIN', 'REGION', 'MOTIF', 'ZN_FING', 'DNA_BIND')
   - description: string (e.g., 'Protein kinase domain')
   - begin: number (start amino acid position)
   - end: number (end amino acid position)

3. **ProcessedVariant** interface (processed from gnomAD ClinVar variants for plot rendering):
   - proteinPosition: number (amino acid position derived from hgvsp or calculated from hgvsc)
   - proteinHGVS: string (p. notation, e.g., 'p.Arg123Trp')
   - codingHGVS: string (c. notation, e.g., 'c.367C>T')
   - classification: PathogenicityClass
   - goldStars: number (review status confidence 0-4)
   - reviewStatus: string
   - clinvarId: string (clinvar_variation_id)
   - variantId: string (gnomAD variant_id)
   - majorConsequence: string (missense_variant, frameshift, splice_donor, etc.)
   - isSpliceVariant: boolean (true if mapped to approximate position from intronic/splice variant)
   - inGnomad: boolean

4. **ProteinPlotData** interface (complete data for the lollipop plot):
   - proteinLength: number (total amino acids)
   - proteinName: string
   - accession: string (UniProt accession)
   - domains: ProteinDomain[]
   - variants: ProcessedVariant[]

5. **LollipopFilterState** interface:
   - pathogenic: boolean (default true)
   - likelyPathogenic: boolean (default true)
   - vus: boolean (default true)
   - likelyBenign: boolean (default true)
   - benign: boolean (default true)

6. **PATHOGENICITY_COLORS** const object (exported):
   ```typescript
   export const PATHOGENICITY_COLORS: Record<PathogenicityClass, string> = {
     'Pathogenic': '#d73027',
     'Likely pathogenic': '#fc8d59',
     'Uncertain significance': '#fee08b',
     'Likely benign': '#91cf60',
     'Benign': '#1a9850',
     'other': '#999999',
   } as const;
   ```

7. **normalizeClassification** helper function (exported):
   ```typescript
   export function normalizeClassification(raw: string): PathogenicityClass
   ```
   Map gnomAD clinical_significance strings to PathogenicityClass. The gnomAD API returns various strings like "Pathogenic", "Likely_pathogenic", "Uncertain_significance", "Benign/Likely_benign", "Pathogenic/Likely_pathogenic", etc. Normalize underscores to spaces, map combined classifications to the more severe one ("Pathogenic/Likely_pathogenic" -> "Pathogenic"), fall back to "other" for unrecognized values.

8. **parseProteinPosition** helper function (exported):
   ```typescript
   export function parseProteinPosition(hgvsp: string | null, hgvsc: string | null): { position: number; isSplice: boolean } | null
   ```
   Extract amino acid position from HGVS notation:
   - From hgvsp (preferred): parse position number from patterns like "p.Arg123Trp" -> 123, "p.Ter456Leu" -> 456
   - If hgvsp is null or unparseable, fall back to hgvsc: parse coding position from "c.367C>T" -> floor(367/3) = 122, mark as approximate
   - For splice variants like "c.123+2A>G": extract base coding position (123), floor(123/3) = 41, mark isSplice = true
   - Return null if neither notation provides a usable position

Update `app/src/types/index.ts` to add `export * from './protein';` after the existing exports.
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` and confirm no TypeScript errors. Verify barrel export: `grep "protein" app/src/types/index.ts`.
  </verify>
  <done>
TypeScript interfaces exist in `app/src/types/protein.ts` with ProteinDomain, ProcessedVariant, ProteinPlotData, LollipopFilterState types plus PATHOGENICITY_COLORS constant and helper functions. All exported via barrel. Type-check passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useD3Lollipop composable for D3 lifecycle management</name>
  <files>app/src/composables/useD3Lollipop.ts, app/src/composables/index.ts</files>
  <action>
Create `app/src/composables/useD3Lollipop.ts` following the useCytoscape.ts pattern (COMPOSE-04):

1. **Interface LollipopOptions:**
   - container: Ref<HTMLElement | null> (container element ref)
   - width: number (default 800, inner width excluding margins)
   - height: number (default 250, inner height excluding margins)
   - margin: { top: number; right: number; bottom: number; left: number } (default { top: 60, right: 30, bottom: 60, left: 50 })
   - onVariantClick?: (variant: ProcessedVariant) => void (for future bidirectional linking with 3D viewer, Phase 45)
   - onVariantHover?: (variant: ProcessedVariant | null) => void (for future bidirectional linking)

2. **CRITICAL: Non-reactive D3 state** (same as useCytoscape `let cy` pattern):
   ```typescript
   let svg: d3.Selection<SVGSVGElement, unknown, null, undefined> | null = null;
   let mainGroup: d3.Selection<SVGGElement, unknown, null, undefined> | null = null;
   let xScale: d3.ScaleLinear<number, number> | null = null;
   let xScaleOriginal: d3.ScaleLinear<number, number> | null = null;
   let brush: d3.BrushBehavior<unknown> | null = null;
   let tooltipDiv: d3.Selection<HTMLDivElement, unknown, null, undefined> | null = null;
   ```

3. **Reactive state** (for UI binding):
   - isInitialized: ref(false)
   - isLoading: ref(false)
   - currentZoomDomain: ref<[number, number] | null>(null) -- tracks zoom state for UI

4. **initializePlot():**
   - Guard: return early if container ref is null
   - Remove any existing SVG: `d3.select(container.value).select('svg').remove()`
   - Remove any existing tooltip div
   - Create responsive SVG with viewBox (full width + margins, height + margins)
   - Apply `preserveAspectRatio: 'xMinYMin meet'` for responsive scaling
   - Create main group with margin transform
   - Add SVG `<title>` and `<desc>` for accessibility (ARIA)
   - Set `role="img"` and `aria-labelledby` on SVG element
   - Create tooltip div (absolute positioned, initially hidden, pointer-events: none)
   - Set isInitialized to true

5. **renderPlot(data: ProteinPlotData, filterState: LollipopFilterState):**
   - Guard: return if svg/mainGroup is null
   - Set isLoading to true
   - Clear all existing rendered content in mainGroup (use `.selectAll('*').remove()`)
   - Create xScale: d3.scaleLinear() with domain [0, data.proteinLength], range [0, innerWidth]
   - Store original xScale for zoom reset
   - If currentZoomDomain.value is set, apply it to xScale (preserve zoom across filter changes)
   - Render in order (back to front):
     a. Protein backbone: horizontal line at yBase (middle of plot area)
     b. Domain rectangles: colored rectangles at domain positions on backbone
     c. X-axis: amino acid position axis with tick marks (axisBottom)
     d. Filter variants by filterState visibility, then render lollipops (stems + markers)
     e. Brush overlay: for zoom selection
   - Set isLoading to false

6. **Variant rendering details** (called by renderPlot):
   - Filter variants based on filterState (which pathogenicity classes are visible)
   - Group variants by proteinPosition using d3.group()
   - For each group, stack variants vertically: stackOffset = index * 14 (14px spacing)
   - Render stems: vertical lines from yBase upward, height = 40 + stackOffset
   - Render markers: circles for coding variants (r=5), triangles/diamonds (d3.symbol) for splice variants (isSplice=true)
   - Color markers by classification using PATHOGENICITY_COLORS
   - Add white stroke (1px) to markers for visual separation
   - Attach mouseover/mouseout handlers for tooltip
   - Attach click handler calling options.onVariantClick if defined
   - Add aria-label to each marker for accessibility

7. **Tooltip handling:**
   - showTooltip(event, variant): set innerHTML with proteinHGVS, codingHGVS, classification (colored), goldStars as star rating, reviewStatus. For splice variants add mapping note. Position with viewport edge detection (check right/bottom overflow, reposition to opposite side if needed).
   - hideTooltip(): set opacity to 0

8. **setupBrush():**
   - Create brushX with extent covering the plot area
   - On 'end' event: if selection exists, compute new xScale domain from brush selection, clear brush selection, update currentZoomDomain, re-render with new scale
   - Double-click handler on SVG: reset to original xScale domain, clear currentZoomDomain, re-render

9. **resetZoom():** Exposed function to reset zoom programmatically

10. **cleanup():**
    - Remove all D3 selections (svg.selectAll('*').remove(), svg.remove())
    - Remove tooltip div
    - Null all references (svg, mainGroup, xScale, xScaleOriginal, brush, tooltipDiv)
    - Set isInitialized to false

11. **Lifecycle hooks:**
    - onMounted: call initializePlot()
    - onBeforeUnmount: call cleanup() -- CRITICAL for memory leak prevention

12. **Return object:**
    ```typescript
    return {
      isInitialized,
      isLoading,
      currentZoomDomain,
      renderPlot,
      resetZoom,
      cleanup,
    };
    ```

CRITICAL PATTERNS (from RESEARCH.md anti-patterns):
- Do NOT store D3 selections in ref() -- use let variables
- Use .join() pattern for enter/update/exit (not .append() in update path)
- Always implement tooltip edge detection
- Group variants by position for stacking
- Remove all listeners and DOM nodes in cleanup

Import d3 as: `import * as d3 from 'd3';`
Import types from protein.ts.

Update `app/src/composables/index.ts` to add barrel export:
```typescript
// D3 lollipop plot composable
export { useD3Lollipop } from './useD3Lollipop';
```
  </action>
  <verify>
Run `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` and confirm no TypeScript errors. Verify barrel export: `grep "useD3Lollipop" app/src/composables/index.ts`.
  </verify>
  <done>
useD3Lollipop composable exists with D3 lifecycle management (init/render/cleanup), brush-to-zoom, tooltip with edge detection, variant stacking, and proper onBeforeUnmount cleanup. Non-reactive D3 state stored in let variables. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty` -- zero type errors
2. `grep -r "ProteinDomain" app/src/types/protein.ts` -- interface exists
3. `grep -r "ProcessedVariant" app/src/types/protein.ts` -- interface exists
4. `grep -r "PATHOGENICITY_COLORS" app/src/types/protein.ts` -- const exported
5. `grep -r "useD3Lollipop" app/src/composables/index.ts` -- barrel export exists
6. `grep "protein" app/src/types/index.ts` -- barrel re-export exists
7. Verify non-reactive pattern: `grep "let svg" app/src/composables/useD3Lollipop.ts` -- should find `let svg` not `ref`
8. Verify cleanup: `grep "onBeforeUnmount" app/src/composables/useD3Lollipop.ts` -- cleanup registered
</verification>

<success_criteria>
- TypeScript interfaces define complete data contract for protein domain visualization (domains + variants + filter state)
- Helper functions (normalizeClassification, parseProteinPosition) handle gnomAD data normalization
- PATHOGENICITY_COLORS constant provides consistent ACMG color coding
- useD3Lollipop composable manages D3 lifecycle with non-reactive instance storage (COMPOSE-04)
- Brush-to-zoom with double-click reset is implemented
- Tooltip with viewport edge detection is implemented
- Variant stacking by position is implemented
- Memory leak prevention via onBeforeUnmount cleanup
- All files type-check without errors
- Barrel exports updated
</success_criteria>

<output>
After completion, create `.planning/phases/43-protein-domain-lollipop-plot/43-01-SUMMARY.md`
</output>
