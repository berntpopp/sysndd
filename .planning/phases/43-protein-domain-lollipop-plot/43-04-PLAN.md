---
phase: 43-protein-domain-lollipop-plot
plan: 04
type: execute
wave: 4
depends_on: ["43-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Protein domain card renders on gene page with real data from backend"
    - "Domains appear as colored rectangles on the backbone"
    - "Variants appear as colored lollipop markers at amino acid positions"
    - "Hover tooltip shows variant details"
    - "Legend toggles filter variant visibility"
    - "Brush-to-zoom works for dense regions"
    - "Error and empty states display correctly"
  artifacts: []
  key_links: []
---

<objective>
Visual and functional verification of the protein domain lollipop plot on the gene page.

Purpose: Confirm the D3 visualization renders correctly with real backend data, interactions work (tooltip, zoom, filter), and edge states (loading, error, empty) are handled properly.

Output: Verified working visualization or list of issues for correction.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-protein-domain-lollipop-plot/43-CONTEXT.md
@.planning/phases/43-protein-domain-lollipop-plot/43-01-SUMMARY.md
@.planning/phases/43-protein-domain-lollipop-plot/43-02-SUMMARY.md
@.planning/phases/43-protein-domain-lollipop-plot/43-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Automated build and type verification</name>
  <files></files>
  <action>
Run automated checks to verify the implementation compiles and builds:

1. TypeScript type check: `cd /home/bernt-popp/development/sysndd/app && npx tsc --noEmit --pretty`
2. Vite build: `cd /home/bernt-popp/development/sysndd/app && npx vite build --mode development`
3. ESLint check: `cd /home/bernt-popp/development/sysndd/app && npx eslint src/components/gene/ProteinDomainLollipopPlot.vue src/components/gene/ProteinDomainLollipopCard.vue src/composables/useD3Lollipop.ts src/types/protein.ts --no-error-on-unmatched-pattern`
4. Verify all new files exist:
   - `ls -la app/src/types/protein.ts`
   - `ls -la app/src/composables/useD3Lollipop.ts`
   - `ls -la app/src/components/gene/ProteinDomainLollipopPlot.vue`
   - `ls -la app/src/components/gene/ProteinDomainLollipopCard.vue`
5. Verify barrel exports:
   - `grep "protein" app/src/types/index.ts`
   - `grep "useD3Lollipop" app/src/composables/index.ts`
6. Verify critical patterns:
   - `grep "let svg" app/src/composables/useD3Lollipop.ts` -- non-reactive D3 instance
   - `grep "onBeforeUnmount" app/src/composables/useD3Lollipop.ts` -- cleanup registered
   - `grep "PATHOGENICITY_COLORS" app/src/types/protein.ts` -- color const exported

Fix any issues found by automated checks before proceeding to visual verification.
  </action>
  <verify>All automated checks pass with zero errors.</verify>
  <done>TypeScript compiles, Vite builds, ESLint passes, all files exist with correct exports and critical patterns.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Interactive D3.js protein domain lollipop plot visualization on the gene page showing UniProt protein domains as colored rectangles and ClinVar variants as positioned lollipop markers with pathogenicity coloring, hover tooltips, brush-to-zoom, and legend-based filtering.
  </what-built>
  <how-to-verify>
1. Start the dev server: `cd /home/bernt-popp/development/sysndd && docker compose up -d` (or however the dev environment is started)
2. Navigate to a gene page with known ClinVar data (e.g., BRCA1, TP53, SCN1A, MECP2)
3. Verify the protein domain lollipop card appears below the gene info card
4. Check protein domains:
   - Colored rectangles appear on horizontal backbone
   - Domain legend below shows color mapping for domain types
5. Check ClinVar variants:
   - Lollipop markers (stems + circles) at amino acid positions
   - Colors match pathogenicity (red=Pathogenic, orange=LP, yellow=VUS, green=Benign)
   - Pathogenicity legend shows counts per category
6. Test hover tooltip:
   - Hover over a variant marker -- tooltip shows p.HGVS, c.HGVS, classification
   - Tooltip stays within viewport (doesn't overflow edges)
7. Test filtering:
   - Click "VUS" in the legend -- VUS markers disappear, others remain
   - Click "VUS" again -- VUS markers reappear
8. Test zoom:
   - Click and drag horizontally on the plot (brush selection)
   - Plot zooms into the selected region
   - Double-click the plot -- zoom resets to full view
9. Test edge states:
   - Navigate to a gene with no ClinVar data -- should show domains with "No ClinVar variants" message
   - Verify loading spinner appears briefly while data loads
10. Check responsive sizing:
    - Resize browser window -- plot should scale proportionally (viewBox)
  </how-to-verify>
  <resume-signal>Type "approved" if visualization works correctly, or describe specific issues to fix.</resume-signal>
</task>

</tasks>

<verification>
1. Automated checks pass (TypeScript, Vite build, ESLint)
2. Visual verification confirms rendering, interaction, and edge states
</verification>

<success_criteria>
- All automated checks pass
- Human verifies: domains render as colored rectangles
- Human verifies: variants render as colored lollipops at correct positions
- Human verifies: tooltip shows variant details on hover
- Human verifies: legend toggles filter correctly
- Human verifies: brush-to-zoom works with double-click reset
- Human verifies: loading and error states display appropriately
</success_criteria>

<output>
After completion, create `.planning/phases/43-protein-domain-lollipop-plot/43-04-SUMMARY.md`
</output>
