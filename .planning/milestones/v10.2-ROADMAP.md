# Milestone v10.2: Performance & Memory Optimization

**Status:** âœ… SHIPPED 2026-02-03
**Phases:** 69-72
**Total Plans:** 11

## Overview

SysNDD v10.2 optimized API memory usage for memory-constrained servers and fixed the ViewLogs performance bug that loads 1M+ rows into memory before filtering. The roadmap progressed from configurable workers (enabling deployment tuning), through analysis algorithm optimizations (STRING thresholds, adaptive layouts, GC calls), to database-side filtering for logs (indexes, parameterized queries, pagination), concluding with documentation and comprehensive testing.

## Phases

### Phase 69: Configurable Workers

**Goal**: Operators can tune mirai worker count for their server's memory constraints
**Depends on**: Nothing (first phase of v10.2)
**Plans**: 1 plan

Plans:
- [x] 69-01-PLAN.md - Implement MIRAI_WORKERS configuration with validation and health endpoint exposure

**Details:**
- Added MIRAI_WORKERS environment variable reading with validation
- Implemented bounds validation: 1-8 workers (min 1 for functionality, max 8 to prevent resource exhaustion)
- Exposed worker count in /api/health/performance endpoint response
- docker-compose.yml defaults to 2 workers (production)
- docker-compose.override.yml defaults to 1 worker (development)

### Phase 70: Analysis Optimization

**Goal**: Cluster analysis runs faster and uses less memory for large gene sets
**Depends on**: Phase 69
**Plans**: 3 plans + 1 debugging session

Plans:
- [x] 70-01-PLAN.md - Increase STRING score_threshold to 400 with configurable parameter
- [x] 70-02-PLAN.md - Implement adaptive layout algorithm selection based on graph size
- [x] 70-03-PLAN.md - Add periodic gc() calls to LLM batch executor
- [x] 70-04-DEBUGGING-SESSION.md - STRINGdb singleton cache, memory cleanup, performance validation

**Details:**
- STRING score_threshold increased from 200 to 400 (medium confidence) - ~50% fewer false positive edges
- Configurable score_threshold parameter with 400 default
- Adaptive layout: DrL for >1000 nodes, FR-grid for 500-1000 nodes, standard FR for <500 nodes
- gc() called every 10 clusters in LLM batch processing, final gc() after batch
- STRINGdb singleton cache to avoid repeated version API calls
- Memory cleanup in network edges and clustering functions

### Phase 71: ViewLogs Database Filtering

**Goal**: ViewLogs page loads quickly with filtering done in database, not R memory
**Depends on**: Phase 70
**Plans**: 4 plans + 1 post-fix

Plans:
- [x] 71-01-PLAN.md - Add database indexes for logging table (timestamp, status, path, composites)
- [x] 71-02-PLAN.md - Implement query builder with column whitelist and parameterized queries
- [x] 71-03-PLAN.md - Implement cursor-compatible filtering (adapted from offset-based)
- [x] 71-04-PLAN.md - Refactor logging endpoint to use database-side filtering
- [x] Post-fix: Support frontend filter format `contains(col,val)` and full-text search

**Details:**
- Added 5 indexes: timestamp, status, path prefix, timestamp+status composite, id DESC+status composite
- Query builder with 13-column whitelist preventing SQL injection
- Parameterized queries with ? placeholders
- get_logs_filtered() returns tibble with cursor pagination
- Removed collect() anti-pattern - filtering now done at database level
- 100k row safety limit
- Invalid filter columns return 400 with invalid_filter_error

### Phase 72: Documentation & Testing

**Goal**: Deployment guide exists and all new code has test coverage
**Depends on**: Phase 71
**Plans**: 3 plans

Plans:
- [x] 72-01-PLAN.md - Write unit tests for worker configuration and query builder
- [x] 72-02-PLAN.md - Write integration tests for database queries and pagination
- [x] 72-03-PLAN.md - Create deployment documentation with memory configuration profiles

**Details:**
- Unit tests for MIRAI_WORKERS parsing (bounds validation, NA handling)
- Unit tests for column whitelist, ORDER BY, WHERE parameterization
- SQL injection prevention tests (13+ attack patterns)
- Integration tests for logs endpoint pagination
- docs/DEPLOYMENT.md with server profiles (4-8GB, 16GB, 32GB+)
- CLAUDE.md memory configuration section

---

## Milestone Summary

**Key Decisions:**
- MIRAI_BOUNDS: Worker count bounds 1-8 (min 1 ensures at least one worker; max 8 prevents resource exhaustion)
- MIRAI_DEFAULT: Default 2 workers for production (right-sized for 4-core VPS with 8GB RAM)
- DEV_DEFAULT: Default 1 worker for development (memory-constrained local machines)
- LAYOUT_DRL: DrL for graphs >1000 nodes (designed for large-scale networks)
- NO_COLLECT: Never use collect() for logging queries (database-side filtering prevents memory explosion)
- FILTER_FORMAT: Use contains(col,val) format for filters (matches frontend conventions)

**Issues Resolved:**
- #150: Optimize mirai worker configuration for memory-constrained servers
- #152: ViewLogs endpoint loads entire table into memory before filtering

**Issues Deferred:**
None

**Technical Debt Incurred:**
None - clean implementation with full test coverage

---

_For current project status, see .planning/ROADMAP.md_

---
*Archived: 2026-02-03 as part of v10.2 milestone completion*
