# Milestone v10.5: Bug Fixes & Data Integrity

**Status:** SHIPPED 2026-02-09
**Phases:** 80-82
**Total Plans:** 6

## Overview

Fix 5 open bugs across CurationComparisons (#173), AdminStatistics (#172, #171), PubTator (#170), and Traefik (#169). Delivers correct data display, accurate admin statistics, working PubTator incremental updates, and clean infrastructure configuration.

## Phases

### Phase 80: Foundation Fixes

**Goal**: Administrators see correct per-source categories in CurationComparisons, accurate monotonic entity trend charts, and Traefik starts without TLS warnings

**Depends on**: Nothing (first phase in milestone)

**Plans**: 2 plans

Plans:
- [x] 80-01-PLAN.md -- CurationComparisons category normalization fix (#173)
- [x] 80-02-PLAN.md -- Entity trend time-series aggregation fix (#171) and Traefik TLS config (#169)

**Key files (new):**
- `api/functions/category-normalization.R`
- `app/src/utils/timeSeriesUtils.ts`

**Key files (modified):**
- `api/functions/endpoint-functions.R`
- `api/endpoints/comparisons_endpoints.R`
- `app/src/views/admin/AdminStatistics.vue`
- `docker-compose.yml`

**Requirements:** DISP-01, DISP-02, DISP-03, DISP-04, DISP-05, INFRA-01, INFRA-02

**Completed:** 2026-02-08

---

### Phase 81: AdminStatistics Sub-Bugs

**Goal**: Re-review leaderboard reflects all curator approvals regardless of UI path used, AdminStatistics KPIs are accurate, and granularity changes cancel stale requests

**Depends on**: Phase 80 (Bug #172-3 KPI race fix depends on #171 time-series utility)

**Plans**: 3 plans

Plans:
- [x] 81-01-PLAN.md -- Re-review approval sync and leaderboard chart fix (#172-1)
- [x] 81-02-PLAN.md -- Dynamic denominator, date utilities, defensive data handling, and request cancellation (#172-2, #172-3, #172-4, #172-5/6, #172-7)
- [x] 81-03-PLAN.md -- Entity trend chart filter controls: NDD/Non-NDD/All toggle, Combined/By Category display, per-category checkboxes (#172-8)

**Key files (new):**
- `api/functions/re-review-sync.R`
- `app/src/utils/dateUtils.ts`
- `app/src/utils/apiUtils.ts`

**Key files (modified):**
- `api/functions/review-repository.R`
- `api/functions/status-repository.R`
- `api/endpoints/re_review_endpoints.R`
- `api/endpoints/statistics_endpoints.R`
- `app/src/views/admin/AdminStatistics.vue`
- `app/src/views/admin/components/charts/ReReviewBarChart.vue`
- `app/src/views/admin/components/charts/EntityTrendChart.vue`
- `app/src/utils/timeSeriesUtils.ts`

**Requirements:** STAT-01, STAT-02, STAT-03, STAT-04, STAT-05, STAT-06, STAT-07, STAT-08, STAT-09, STAT-10, STAT-11, TEST-03

**Completed:** 2026-02-09

---

### Phase 82: PubTator Backend Fix

**Goal**: PubTator incremental annotation update fetches only PMIDs missing annotations and stores results without duplicate key errors

**Depends on**: Nothing (independent of Phases 80-81)

**Plans**: 1 plan

Plans:
- [x] 82-01-PLAN.md -- PubTator incremental query fix, INSERT IGNORE dedup, and rate limiting (#170)

**Post-plan fixes (discovered during E2E testing):**

1. **Migration 017: ensure `gene_symbols` column** -- `pubtator_search_cache.gene_symbols` column was missing; idempotent migration adds it via stored procedure guard
2. **Fix 18 broken `db_with_transaction` callers** -- Codebase audit found 18 of 21 callers using expression pattern instead of `function(txn_conn)` pattern, providing zero atomicity. All 18 fixed.
3. **BioCJSON parsing pipeline rewrite** -- Root cause of 72% annotation loss: three cascading bugs in old parsing pipeline. Replaced with clean `pubtator_parse_biocjson(url)` using `jsonlite::fromJSON()`. Annotation coverage improved from 110 to 491 PMIDs (out of 500).
4. **Static analysis tests for transaction patterns** -- Codebase-wide tests scanning all R files to ensure correct `db_with_transaction` usage.

**Key files (new):**
- `db/migrations/017_ensure_pubtator_gene_symbols.sql`
- `api/tests/testthat/test-unit-transaction-patterns.R`

**Key files (modified):**
- `api/functions/pubtator-functions.R` (incremental query + BioCJSON rewrite)
- `api/endpoints/publication_endpoints.R`
- 11 additional files (transaction pattern fixes)

**Requirements:** API-01, API-02, API-03

**Completed:** 2026-02-08

---

## Milestone Summary

**Key Decisions:**
- Use `fromJSON()` for BioCJSON parsing instead of custom line-splitting parsers
- `function(txn_conn)` pattern mandatory for all `db_with_transaction` callers
- Idempotent `gene_symbols` column addition via stored procedure guard in migration 017
- Running maximum for y-axis stability in entity trend chart
- Separate watchers for NDD vs category filter reset semantics
- AbortController for stale request cancellation on granularity change
- `safeArray()` and `clampPositive()` defensive utilities for API response handling
- LEFT JOIN filter for incremental PubTator annotation fetching (~90% fewer API calls)
- INSERT IGNORE for idempotent annotation cache inserts
- 350ms rate limiting for NCBI API compliance

**Issues Resolved:**
- #173: CurationComparisons cross-database max category aggregation
- #172: AdminStatistics re-review approval sync, KPI race condition, date calculation, request cancellation, entity trend filters
- #171: AdminStatistics entity trend chart aggregation
- #170: PubTator annotation storage failure for incremental updates
- #169: Traefik TLS cert selection and startup warnings
- 18 broken `db_with_transaction` callers (zero atomicity) discovered and fixed
- BioCJSON parsing pipeline (72% annotation loss) rewritten

**Issues Deferred:**
- #167: Entity data integrity audit (INTEG-01 through INTEG-06) â€” deferred to v10.6
- BACK-02: PubTator historical backfill for ~2,900 PMIDs

**Technical Debt Incurred:**
- Pre-existing: Stats API `type=all` returns 500 (non-default param, low severity)
- `clampPositive()` exported but not yet used (available for future use)
- Pre-existing: 70 TypeScript errors in unrelated .spec.ts files
- PubTator historical backfill ~2,900 PMIDs (deferred to BACK-02)

---

_For current project status, see .planning/ROADMAP.md_
