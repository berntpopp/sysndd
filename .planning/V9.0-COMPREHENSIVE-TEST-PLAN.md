# v9.0 Comprehensive Testing Plan

**Created:** 2026-01-31
**Updated:** 2026-01-31
**Status:** Completed
**Focus:** Registration Flow, Email Testing, Profile Editing, Full E2E Validation

---

## Overview

This plan covers comprehensive testing of all v9.0 features using Playwright MCP for browser-based E2E tests in the development environment with Mailpit for email capture.

---

## 1. Test Environment

### 1.1 Development Environment (docker-compose.dev.yml)
- **App:** Vite dev server on port 5173
- **API:** Plumber on port 7778 (direct) / port 80 (via Traefik)
- **Database:** MySQL dev on port 7654, test on port 7655
- **Email:** Mailpit on port 8025 (UI) / 1025 (SMTP)
- **Traefik:** Dashboard on port 8090

### 1.2 Playwright MCP Testing Approach
All E2E testing is performed using the **Playwright MCP server** which provides:
- `browser_navigate` - Navigate to URLs
- `browser_snapshot` - Capture accessibility snapshots for element references
- `browser_click` - Click elements using refs
- `browser_type` - Type into form fields
- `browser_fill_form` - Fill multiple form fields at once
- `browser_take_screenshot` - Visual verification
- `browser_console_messages` - Check for JavaScript errors

No traditional Playwright test files are used - all testing is interactive via MCP.

---

## 2. Test Categories & Results

### Category A: Infrastructure Tests ✅ PASSED
| Test | Description | Status | Notes |
|------|-------------|--------|-------|
| A1 | Health endpoint `/health/` returns 200 | ✅ | Verified via API |
| A2 | Ready endpoint `/health/ready` returns 200 | ✅ | Migration status shown |
| A3 | API responds through Traefik | ✅ | Port 80 working |
| A6 | Mailpit accessible on port 8025 | ✅ | Email capture working |

### Category B: Email Templates ✅ PASSED
| Test | Description | Status | Notes |
|------|-------------|--------|-------|
| B1 | Registration confirmation email | ✅ | Professional HTML template |
| B2 | User approval email with password | ✅ | Secure password delivery |
| B3 | Password reset email | ✅ | Token link included |
| B4 | Batch assignment email | ✅ | New feature - entity count, CTA button |
| B5 | Email HTML Check score | ✅ | 97-100% scores in Mailpit |

### Category C: Login Flow ✅ PASSED
| Test | Description | Status | Notes |
|------|-------------|--------|-------|
| C1 | Navigate to /Login page | ✅ | Page loads correctly |
| C2 | Form validation shows errors | ✅ | Invalid input feedback |
| C3 | Submit valid credentials | ✅ | Admin/password1salt1 |
| C4 | JWT stored and user redirected | ✅ | Authenticated session |
| C5 | User info displayed | ✅ | Username, email, ORCID shown |

### Category D: Self-Service Profile Editing ✅ PASSED
| Test | Description | Status | Notes |
|------|-------------|--------|-------|
| D1 | Navigate to /User page | ✅ | Profile details shown |
| D2 | Click Edit button | ✅ | Edit mode activated |
| D3 | Email validation (format) | ✅ | Client-side regex check |
| D4 | ORCID validation (format) | ✅ | Pattern: 0000-0000-0000-000X |
| D5 | Save profile changes | ✅ | API returns success |
| D6 | Cancel discards changes | ✅ | Original values restored |
| D7 | Database updated correctly | ✅ | Verified via SQL query |

### Category E: Batch Assignment Email ✅ PASSED
| Test | Description | Status | Notes |
|------|-------------|--------|-------|
| E1 | Assign batch to user | ✅ | PUT /api/batch/assign |
| E2 | Email sent to assignee | ✅ | Captured in Mailpit |
| E3 | Email contains batch number | ✅ | Batch details table |
| E4 | Email contains entity count | ✅ | "25 entities" shown |
| E5 | CTA button links to ReReview | ✅ | "Start Reviewing" button |
| E6 | BCC sent to curator | ✅ | curator@sysndd.org |

### Category F: Backup System ✅ PASSED (Prior Testing)
| Test | Description | Status | Notes |
|------|-------------|--------|-------|
| F1 | Admin navigate to /ManageBackups | ✅ | UI loads |
| F2 | List backups shown | ✅ | API returns backup list |
| F3 | Create backup works | ✅ | Async job handling |
| F4 | Download backup works | ✅ | File downloads |
| F5 | Delete backup works | ✅ | New UI feature |
| F6 | Restore requires confirmation | ✅ | "RESTORE" typed check |

### Category G: Migration System ✅ PASSED (Prior Testing)
| Test | Description | Status | Notes |
|------|-------------|--------|-------|
| G1 | Fresh DB auto-applies migrations | ✅ | Startup integration |
| G2 | `/health/ready` shows migration status | ✅ | pending_migrations: 0 |
| G3 | Migrations are idempotent | ✅ | Re-run safe |

---

## 3. Playwright MCP Test Workflow

### Step 1: Navigate and Snapshot
```
browser_navigate -> URL
browser_snapshot -> Get element refs
```

### Step 2: Interact with Elements
```
browser_click -> ref from snapshot
browser_type -> ref + text
browser_fill_form -> multiple fields
```

### Step 3: Verify Results
```
browser_snapshot -> Check new state
browser_take_screenshot -> Visual record
browser_console_messages -> Check for errors
```

### Example: Login Test Flow
1. `browser_navigate` to http://localhost:5173/Login
2. `browser_snapshot` to get form element refs
3. `browser_fill_form` with username and password
4. `browser_click` on Submit button
5. `browser_snapshot` to verify redirect/logged in state

### Example: Profile Edit Test Flow
1. `browser_navigate` to http://localhost:5173/User (authenticated)
2. `browser_snapshot` to get Edit button ref
3. `browser_click` on Edit button
4. `browser_snapshot` to get form field refs
5. `browser_type` new email value
6. `browser_type` new ORCID value
7. `browser_click` on Save button
8. `browser_snapshot` to verify success message

---

## 4. Email Testing with Mailpit

### Mailpit UI Access
- URL: http://localhost:8025
- Shows all captured emails
- HTML Check tab shows template quality score

### Mailpit API Endpoints
```
GET  /api/v1/messages          - List all messages
GET  /api/v1/message/{id}      - Get message details
DELETE /api/v1/messages        - Clear inbox
GET  /api/v1/search?query=...  - Search messages
```

### Verified Email Templates
| Template | Function | HTML Score |
|----------|----------|------------|
| Registration Request | `email_registration_request()` | 97% |
| User Approval | `email_user_approved()` | 97% |
| Password Reset | `email_password_reset()` | 97% |
| Batch Assigned | `email_batch_assigned()` | 100% |

---

## 5. Test Data Used

### Test User (Profile Editing)
- **Username:** Admin
- **Password:** password1salt1
- **Test Email:** admin-updated@test.example.com
- **Test ORCID:** 0000-0001-2345-6789

### Validation Patterns
- **Email:** `.+@.+\..+` (contains @ and domain)
- **ORCID:** `^[0-9]{4}-[0-9]{4}-[0-9]{4}-[0-9]{3}[0-9X]$`

---

## 6. Issues Found & Fixed

### Issue 1: ORCID Validation Regex in R
- **Problem:** `\d` pattern not matching digits
- **Solution:** Changed to `[0-9]` character class
- **File:** `api/endpoints/user_endpoints.R`

### Issue 2: Login Credentials
- **Problem:** Initial test credentials incorrect
- **Solution:** Used correct Admin/password1salt1
- **Verification:** JWT returned, user authenticated

### Issue 3: BSpinner Component Warning
- **Problem:** Vue warning about unresolved component
- **Impact:** Minor - functionality unaffected
- **Status:** Known issue, low priority

---

### Issue 4: Health Endpoint Path
- **Problem:** Health endpoint at `/health` conflicted with Traefik internal API
- **Solution:** Moved to `/api/health` for consistency with other endpoints
- **Files:** `api/start_sysndd_api.R`, `docker-compose.yml`, `Makefile`

---

## 7. Production Docker Testing ✅ PASSED

### 7.1 Production Environment (docker-compose.yml only)
- **App:** nginx-brotli serving static assets on port 8080
- **API:** Plumber with pool size 5, 2 mirai workers
- **Database:** MySQL 8.0.40
- **Email:** Real SMTP (smtp.strato.de:587)
- **Traefik:** Production mode on port 80

### 7.2 Production Test Results
| Requirement | Test | Status | Notes |
|-------------|------|--------|-------|
| PROD-01 | Production Docker build | ✅ | Builds and runs successfully |
| PROD-02 | Connection pool sizing | ✅ | maxSize=5, proper idle/active counts |
| PROD-03 | /api/health/ready | ✅ | DB connected, 0 pending migrations |
| PROD-04 | make preflight | ✅ | Full validation suite passes |

### 7.3 Real SMTP Testing
| Test | Status | Notes |
|------|--------|-------|
| SMTP Connection | ✅ | smtp.strato.de:587 with TLS |
| Password Reset Email | ✅ | Sent and received by user |
| Email Credentials | ✅ | Via SMTP_PASSWORD env var |

### 7.4 Auto-Migration Testing
| Test | Status | Notes |
|------|--------|-------|
| Reset DB to old backup | ✅ | SysNDD_local_2025-07-17.sql |
| API startup applies migrations | ✅ | 4 migrations in 0.48s |
| schema_version table created | ✅ | All migrations tracked |
| Idempotent re-run | ✅ | No errors on restart |

---

## 8. Success Summary

| Category | Tests | Passed | Status |
|----------|-------|--------|--------|
| Infrastructure (A) | 4 | 4 | ✅ 100% |
| Email Templates (B) | 5 | 5 | ✅ 100% |
| Login Flow (C) | 5 | 5 | ✅ 100% |
| Profile Editing (D) | 7 | 7 | ✅ 100% |
| Batch Email (E) | 6 | 6 | ✅ 100% |
| Backup System (F) | 6 | 6 | ✅ 100% |
| Migration System (G) | 3 | 3 | ✅ 100% |
| Production Docker (H) | 8 | 8 | ✅ 100% |
| **TOTAL** | **44** | **44** | **✅ 100%** |

---

## 8. Commands Reference

```bash
# Start dev environment
make docker-dev

# View container status
make docker-status

# View logs
make docker-logs

# Run API tests (R testthat)
make test-api

# Access Mailpit UI
open http://localhost:8025

# Access Application
open http://localhost:5173
```

---

## 9. Post-v9.0 Features Tested

### Batch Assignment Email (2026-01-31)
- **Trigger:** `PUT /api/batch/assign`
- **Template:** `email_batch_assigned()`
- **Verified:** Email sent to assignee with batch details

### Self-Service Profile Editing (2026-01-31)
- **Endpoint:** `PUT /api/profile`
- **UI:** UserView.vue Edit mode
- **Verified:** Email and ORCID updates persist to database

---

*Testing completed: 2026-01-31*
*All v9.0 features validated via Playwright MCP*
